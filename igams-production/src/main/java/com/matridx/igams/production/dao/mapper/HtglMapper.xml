<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.production.dao.post.IHtglDao" >
	<sql id="SEARCH_TERMS_OTHER">
		htgl.scbj!='1'
		<if test="entire != null and entire != ''">
			and (
			htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or htgl.htwbbh ILIKE '%'||#{entire}||'%'
			or gysxx.gysmc ILIKE '%'||#{entire}||'%'
			or xtyh.zsxm ILIKE '%'||#{entire}||'%'
			or jg_sqbm.jgmc ILIKE '%'||#{entire}||'%'
			or (htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  (wl.wlbm ILIKE '%'||#{entire}||'%'
			or wl.wlmc ILIKE '%'||#{entire}||'%')
			and htmx.scbj='0'
			group by htmx.htid
			)
			)
			)
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="htwbbh != null and htwbbh != ''">
			and htgl.htwbbh ILIKE '%'||#{htwbbh}||'%'
		</if>
		<if test="gysmc != null and gysmc != ''">
			and gysxx.gysmc ILIKE '%'||#{gysmc}||'%'
		</if>
		<if test="fzrmc != null and fzrmc != ''">
			and xtyh.zsxm ILIKE '%'||#{fzrmc}||'%'
		</if>
		<if test="sqbmmc != null and sqbmmc != ''">
			and jg_sqbm.jgmc ILIKE '%'||#{sqbmmc}||'%'
		</if>
		<if test="szbj != null and szbj != ''">
			and htgl.szbj = #{szbj}
		</if>
		<if test="htlx != null and htlx != ''">
			and htgl.htlx = #{htlx}
		</if>
		<if test="nhtlx != null and nhtlx != ''">
			and htgl.htlx != #{nhtlx}
		</if>
		<if test="wcbj != null and wcbj != ''">
			and htgl.wcbj = #{wcbj}
		</if>
		<if test="sfkj != null and sfkj != ''">
			and htgl.sfkj = #{sfkj}
		</if>
		<if test="zt != null and zt != ''">
			and htgl.zt = #{zt}
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-mm-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend != null and shsjend != ''">
			and to_char(htgl.cjrq,'yyyy-mm-dd') &lt;= #{shsjend}
		</if>
		<if test="wlmc != null and wlmc != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.wlmc ILIKE '%'||#{wlmc}||'%'
			and htmx.scbj='0'
			group by htmx.htid
			)
		</if>
		<if test="wlbm != null and wlbm != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.wlbm ILIKE '%'||#{wlbm}||'%'
			and htmx.scbj='0'
			group by htmx.htid
			)
		</if>
		<if test="gg != null and gg != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.gg ILIKE '%'||#{gg}||'%'
			and htmx.scbj='0'
			group by htmx.htid
			)
		</if>
	</sql>

	<sql id="SEARCH_TERMS">
		htgl.scbj!='1'
		<if test="entire != null and entire != ''">
			and (
			htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or htgl.htwbbh ILIKE '%'||#{entire}||'%'
			or kjhtgl.htnbbh ILIKE '%'||#{entire}||'%'
			or gysxx.gysmc ILIKE '%'||#{entire}||'%'
			or xtyh.zsxm ILIKE '%'||#{entire}||'%'
			or jg_sqbm.jgmc ILIKE '%'||#{entire}||'%'
			or (htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  (wl.wlbm ILIKE '%'||#{entire}||'%'
			or wl.wlmc ILIKE '%'||#{entire}||'%')
			and htmx.scbj='0'
			group by htmx.htid
			)
			)
			)
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="kjhtbh != null and kjhtbh != ''">
			and  kjhtgl.htnbbh ILIKE '%'||#{kjhtbh}||'%'
		</if>
		<if test="htwbbh != null and htwbbh != ''">
			and htgl.htwbbh ILIKE '%'||#{htwbbh}||'%'
		</if>
		<if test="gysmc != null and gysmc != ''">
			and gysxx.gysmc ILIKE '%'||#{gysmc}||'%'
		</if>
		<if test="fzrmc != null and fzrmc != ''">
			and xtyh.zsxm ILIKE '%'||#{fzrmc}||'%'
		</if>
		<if test="sqbmmc != null and sqbmmc != ''">
			and jg_sqbm.jgmc ILIKE '%'||#{sqbmmc}||'%'
		</if>
		<if test="szbj != null and szbj != ''">
			and htgl.szbj = #{szbj}
		</if>
		<if test="htlx != null and htlx != ''">
			and htgl.htlx = #{htlx}
		</if>
		<if test="nhtlx != null and nhtlx != ''">
			and htgl.htlx != #{nhtlx}
		</if>
		<if test="wcbj != null and wcbj != ''">
			and htgl.wcbj = #{wcbj}
		</if>
		<if test="sfkj != null and sfkj != ''">
			and htgl.sfkj = #{sfkj}
		</if>
		<if test="zt != null and zt != ''">
			and htgl.zt = #{zt}
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-mm-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend != null and shsjend != ''">
			and to_char(htgl.cjrq,'yyyy-mm-dd') &lt;= #{shsjend}
		</if>

		<if test="zjemin != null and zjemin != ''">
			and htgl.zje &gt;= #{zjemin}
		</if>
		<if test="zjemax != null and zjemax != ''">
			and htgl.zje &lt;= #{zjemax}
		</if>
		<if test="sfgq != null and sfgq != ''and sfgq=='0'.toString()">
			and htgl.dqrq+1 &gt; now()
		</if>
		<if test="sfgq != null and sfgq != '' and sfgq=='1'.toString()">
			and htgl.dqrq+1 &lt;= now()
		</if>
		<if test = "szbjs != null and szbjs.length > 0 "  >
			and htgl.szbj in
			<foreach collection="szbjs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "htfxcds != null and htfxcds.length > 0 "  >
			and htgl.htfxcd in
			<foreach collection="htfxcds" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "fkfss != null and fkfss.length > 0 "  >
			and htgl.fkfs in
			<foreach collection="fkfss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "scbjs != null and scbjs.length > 0 "  >
			and htgl.scbj in
			<foreach collection="scbjs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "fpfss != null and fpfss.length > 0 "  >
			and htgl.fpfs in
			<foreach collection="fpfss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "cglxs != null and cglxs.length > 0 "  >
			and htgl.cglx in
			<foreach collection="cglxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "wcbjs != null and wcbjs.length > 0 "  >
			and htgl.wcbj in
			<foreach collection="wcbjs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "zts != null and zts.length > 0 "  >
			and htgl.zt in
			<foreach collection="zts" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
	<if test = "htywlxs != null and htywlxs.length > 0 "  >
		and htgl.ywlx in
		<foreach collection="htywlxs" separator="," open="(" close=") "
				 item="item" index="index">
			#{item}
		</foreach>
	</if>
		<if test="wlmc != null and wlmc != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.wlmc ILIKE '%'||#{wlmc}||'%'
			and htmx.scbj='0'
			group by htmx.htid
	)
		</if>
		<if test="wlbm != null and wlbm != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.wlbm ILIKE '%'||#{wlbm}||'%'
			and htmx.scbj='0'
			group by htmx.htid
			)
		</if>
		<if test="gg != null and gg != ''">
			and htgl.htid in
			(select htmx.htid from igams_htmx htmx
			left join igams_wlgl wl on wl.wlid=htmx.wlid
			where  wl.gg ILIKE '%'||#{gg}||'%'
			and htmx.scbj='0'
			group by htmx.htid
			)
		</if>
	</sql>

	<!-- 查询所有消息 -->
	<select id="getPagedDtoList" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.wcbj,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,htgl.gys,jc_htfx.csmc htfxmc,
		htgl.htfxcd,
		jg_sqbm.jgmc as sqbmmc,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,htgl.scbj,jc_fk.csdm fkfsdm,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,gysxx.gysmc as gysmc,xtyh.zsxm as fzrmc,htgl.jhrq,
		(coalesce(htgl.zje,0)-coalesce(htgl.yfje,0)-coalesce(htgl.fkzje,0)) wfje,htgl.fkzje,htgl.htlx,htgl.fkbz,case when htgl.dqrq+1>now() then '未过期' when htgl.dqrq is null then '' else '已过期' end sfgq,htgl.ksrq,htgl.dqrq,htgl.kjlx,
		htgl.sfkj,kjhtgl.htnbbh kjhtbh,htgl.kjhtid,htgl.bchtid
		from igams_htgl htgl
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join matridx_jcsj jc_htfx on jc_htfx.csid=htgl.htfxcd
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
		left join igams_htmx htmx on htmx.htid=htgl.htid
		left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			<include refid="SEARCH_TERMS"></include>
		</where>
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			group by htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc,
			htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.wcbj,
			htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,htgl.gys,jc_htfx.csmc,
			htgl.htfxcd,jg_sqbm.jgmc,jc_fk.csmc,jc_fp.csmc,htgl.scbj,jc_fk.csdm,
			jc_biz.csmc,jc_ywlx.csmc,gysxx.gysmc,xtyh.zsxm,wfje,htgl.fkzje,htgl.htlx,htgl.fkbz,htgl.dqrq,htgl.ksrq,htgl.kjlx,htgl.sfkj,kjhtgl.htnbbh,htgl.kjhtid
		</if>
	</select>

	<select id="getDtoById" parameterType="String" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,htgl.csrs,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.jhrq,htgl.ddslid,htgl.gys,jc_htfx.csmc htfxmc,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,jg_sqbm.jgid sqbm,
		jg_sqbm.jgmc as sqbmmc,jg_sqbm.jgdm as jqdm,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,jc_ywlx.cskz1 nbbhqz,gysxx.gysmc as gysmc,gysxx.gysdm as gysdm,xtyh.zsxm as fzrmc,
		gysxx.lxr gysfzr,gysxx.dh gysfzrdh,htgl.wcbj,htgl.ddspid,htgl.fkzje,jc_fkfs.csdm fkfsdm,gysxx.khh zffkhh,gysxx.zh zffyhzh,
		(coalesce(htgl.zje,0)-coalesce(htgl.yfje,0)-coalesce(htgl.fkzje,0)) wfje,htgl.htlx,htgl.gys,jc_cglx.csdm cglxdm,
		case when htgl.zt ='00' then '未提交' when htgl.zt='10' then '审核中' when htgl.zt='15' then '审核不通过' when htgl.zt='80' then '审核通过' end ztmc,
		case when htgl.szbj='0' then '否' when htgl.szbj='1' then '是' end szbjmc,htgl.fkbz,case when htgl.dqrq+1>now() then '0' when htgl.dqrq is null then '' else '1' end sfgq,htgl.dqrq,htgl.ksrq,htgl.kjlx,
		bchtgl.htnbbh yyhtnbbh,htgl.sfkj,kjhtgl.htnbbh kjhtbh,kjhtgl.htid kjhtid,htgl.bchtid,bchtgl.ddslid yhtddslid,htgl.sfjgfw,htgl.xzje
		from igams_htgl htgl
		left join igams_htgl bchtgl on bchtgl.htid = htgl.bchtid
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		left outer join matridx_jcsj jc_fkfs on jc_fkfs.csid = htgl.fkfs
		left outer join matridx_jcsj jc_htfx on jc_htfx.csid=htgl.htfxcd
		left outer join matridx_jcsj jc_cglx on jc_cglx.csid=htgl.cglx
			<where>
				 htgl.htid=#{htid} and htgl.scbj!='1'
			</where>
	</select>
	<select id="getDtoListByGys" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,htgl.csrs,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.jhrq,htgl.ddslid,htgl.gys,jc_htfx.csmc htfxmc,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,jg_sqbm.jgid sqbm,
		jg_sqbm.jgmc as sqbmmc,jg_sqbm.jgdm as jqdm,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,jc_ywlx.cskz1 nbbhqz,gysxx.gysmc as gysmc,gysxx.gysdm as gysdm,xtyh.zsxm as fzrmc,
		gysxx.lxr gysfzr,gysxx.dh gysfzrdh,htgl.wcbj,htgl.ddspid,htgl.fkzje,jc_fkfs.csdm fkfsdm,gysxx.khh zffkhh,gysxx.zh zffyhzh,
		(coalesce(htgl.zje,0)-coalesce(htgl.yfje,0)-coalesce(htgl.fkzje,0)) wfje,htgl.htlx,htgl.gys,jc_cglx.csdm cglxdm,
		case when htgl.zt ='00' then '未提交' when htgl.zt='10' then '审核中' when htgl.zt='15' then '审核不通过' when htgl.zt='80' then '审核通过' end ztmc,
		case when htgl.szbj='0' then '否' when htgl.szbj='1' then '是' end szbjmc,htgl.fkbz
		from igams_htgl htgl
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		left outer join matridx_jcsj jc_fkfs on jc_fkfs.csid = htgl.fkfs
		left outer join matridx_jcsj jc_htfx on jc_htfx.csid=htgl.htfxcd
		left outer join matridx_jcsj jc_cglx on jc_cglx.csid=htgl.cglx
		<where>
			htgl.gys=#{gys} and htgl.scbj!='1'
		</where>
	</select>
	
	<select id="getDto" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.cjrq,htgl.tjrq,htgl.jhrq,htgl.ddslid,jc_htfx.csmc htfxmc,htgl.htfxcd,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,
		htgl.sqbm, jg_sqbm.jgmc as sqbmmc,jg_sqbm.jgdm as jqdm,
		htgl.fkfs, jc_fk.csmc as fkfsmc, htgl.fpfs, jc_fp.csmc as fpfsmc,
		htgl.biz, jc_biz.csmc as bizmc, htgl.ywlx, jc_ywlx.csmc as ywlxmc,
		htgl.gys, gysxx.gysmc as gysmc, htgl.fzr, xtyh.zsxm as fzrmc,
		gysxx.gysdm as gysdm,htgl.htlx,htgl.fkbz,htgl.ksrq,htgl.dqrq,htgl.kjlx,
		bchtgl.htnbbh yyhtnbbh,htgl.sfkj,kjhtgl.htnbbh kjhtbh,kjhtgl.htid kjhtid,htgl.bchtid,htgl.sfjgfw
		from igams_htgl htgl
		left join igams_htgl bchtgl on bchtgl.htid = htgl.bchtid
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left outer join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		left outer join matridx_jcsj jc_htfx on jc_htfx.csid=htgl.htfxcd
		<where>
			htgl.scbj != '1' and htgl.htid = #{htid}
		</where>
	</select>

	<!-- 导出 -->
	<select id="getCountForSearchExp" parameterType="HtglDto"
			resultType="java.lang.Integer">
		select count(htgl.htid) from igams_htgl htgl
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_fxcd on jc_fxcd.csid = htgl.htfxcd
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			<include refid="SEARCH_TERMS"></include>
		</where>
	</select>

	<select id="getListForSearchExp" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid ${sqlParam}
		from igams_htgl htgl
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		left outer join matridx_jcsj jc_fxcd on jc_fxcd.csid = htgl.htfxcd
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			<include refid="SEARCH_TERMS"></include>
		</where>
		order by
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
		LIMIT #{pageSize} OFFSET #{pageStart}
	</select>

	<select id="getListForSelectExp" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid ${sqlParam} from (
		<foreach item="item" index="index" collection="ids"
				 separator=" union all ">
			select #{item,jdbcType=VARCHAR} htid,#{index} ordernum
		</foreach>
		) tmp
		left outer join igams_htgl htgl on tmp.htid = htgl.htid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_fxcd on jc_fxcd.csid = htgl.htfxcd
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		order by tmp.ordernum
	</select>

	<!-- 新增合同信息 -->
	<insert id="insert" parameterType="HtglModel">
		insert into igams_htgl(htid
		<if test="qgid !=null and qgid != ''">
			,qgid
		</if>
		<if test="htnbbh !=null and htnbbh != ''">
			,htnbbh
		</if>
		<if test="htwbbh !=null and htwbbh != ''">
			,htwbbh
		</if>
		<if test="ywlx !=null and ywlx != ''">
			,ywlx
		</if>
		<if test="cglx !=null and cglx != ''">
			,cglx
		</if>
		<if test="ddrq !=null and ddrq != ''">
			,ddrq
		</if>
		<if test="zje !=null and zje != ''">
			,zje
		</if>
		<if test="yfje !=null and yfje != ''">
			,yfje
		</if>
		<if test="fpje !=null and fpje != ''">
			,fpje
		</if>
		<if test="gys !=null and gys != ''">
			,gys
		</if>
		<if test="fzr !=null and fzr != ''">
			,fzr
		</if>
		<if test="sqbm !=null and sqbm != ''">
			,sqbm
		</if>
		<if test="cjrq !=null and cjrq != ''">
			,cjrq
		</if>
		<if test="tjrq !=null and tjrq != ''">
			,tjrq
		</if>
		<if test="htwfrq !=null and htwfrq != ''">
			,htwfrq
		</if>
		<if test="sl !=null and sl != ''">
			,sl
		</if>
		<if test="biz !=null and biz != ''">
			,biz
		</if>
		<if test="hl !=null and hl != ''">
			,hl
		</if>
		<if test="szbj !=null and szbj != ''">
			,szbj
		</if>
		<if test="bz !=null and bz != ''">
			,bz
		</if>
		<if test="u8cgid !=null and u8cgid != ''">
			,u8cgid
		</if>
		<if test="u8poid !=null and u8poid != ''">
			,u8poid
		</if>
		<if test="fkfs !=null and fkfs != ''">
			,fkfs
		</if>
		<if test="fpfs !=null and fpfs != ''">
			,fpfs
		</if>
		<if test="zt !=null and zt != ''">
			,zt
		</if>
		<if test="jhrq !=null and jhrq != ''">
			,jhrq
		</if>
		<if test="fkf != null and fkf !=''">
			,fkf
		</if>
		<if test="sffpwh != null and sffpwh !=''">
			,sffpwh
		</if>
		<if test="htlx != null and htlx !=''">
			,htlx
		</if>
		<if test="htfxcd != null and htfxcd !=''">
			,htfxcd
		</if>
		<if test="fkbz != null and fkbz !=''">
			,fkbz
		</if>
		<if test="kjlx != null and kjlx !=''">
			,kjlx
		</if>
		<if test="ksrq != null and ksrq !=''">
			,ksrq
		</if>
		<if test="dqrq != null and dqrq !=''">
			,dqrq
		</if>
		<if test="bchtid != null and bchtid !=''">
			,bchtid
		</if>
		<if test="kjhtid != null and kjhtid !=''">
			,kjhtid
		</if>
		<if test="sfkj != null and sfkj !=''">
			,sfkj
		</if>
		<if test="sfjgfw != null and sfjgfw !=''">
			,sfjgfw
		</if>
		,lrry,lrsj,scbj,wcbj) values(#{htid}
		<if test="qgid !=null and qgid != ''">
			,#{qgid}
		</if>
		<if test="htnbbh !=null and htnbbh != ''">
			,#{htnbbh}
		</if>
		<if test="htwbbh !=null and htwbbh != ''">
			,#{htwbbh}
		</if>
		<if test="ywlx !=null and ywlx != ''">
			,#{ywlx}
		</if>
		<if test="cglx !=null and cglx != ''">
			,#{cglx}
		</if>
		<if test="ddrq !=null and ddrq != ''">
			,cast(#{ddrq} as timestamp)
		</if>
		<if test="zje !=null and zje != ''">
			,cast(#{zje} as decimal)
		</if>
		<if test="yfje !=null and yfje != ''">
			,cast(#{yfje} as decimal)
		</if>
		<if test="fpje !=null and fpje != ''">
			,cast(#{fpje} as decimal)
		</if>
		<if test="gys !=null and gys != ''">
			,#{gys}
		</if>
		<if test="fzr !=null and fzr != ''">
			,#{fzr}
		</if>
		<if test="sqbm !=null and sqbm != ''">
			,#{sqbm}
		</if>
		<if test="cjrq !=null and cjrq != ''">
			,cast(#{cjrq} as timestamp)
		</if>
		<if test="tjrq !=null and tjrq != ''">
			,cast(#{tjrq} as timestamp)
		</if>
		<if test="htwfrq !=null and htwfrq != ''">
			,cast(#{htwfrq} as timestamp)
		</if>
		<if test="sl !=null and sl != ''">
			,cast(#{sl} as numeric)
		</if>
		<if test="biz !=null and biz != ''">
			,#{biz}
		</if>
		<if test="hl !=null and hl != ''">
			,cast(#{hl} as numeric)
		</if>
		<if test="szbj !=null and szbj != ''">
			,#{szbj}
		</if>
		<if test="bz !=null and bz != ''">
			,#{bz}
		</if>
		<if test="u8cgid !=null and u8cgid != ''">
			,#{u8cgid}
		</if>
		<if test="u8poid !=null and u8poid != ''">
			,#{u8poid}
		</if>
		<if test="fkfs !=null and fkfs != ''">
			,#{fkfs}
		</if>
		<if test="fpfs !=null and fpfs != ''">
			,#{fpfs}
		</if>
		<if test="zt !=null and zt != ''">
			,#{zt}
		</if>
		<if test="jhrq !=null and jhrq != ''">
			,cast(#{jhrq} as timestamp)
		</if>
		<if test="fkf != null and fkf !=''">
			,#{fkf}
		</if>
		<if test="sffpwh != null and sffpwh !=''">
			,#{sffpwh}
		</if>
		<if test="htlx != null and htlx !=''">
			,#{htlx}
		</if>
		<if test="htfxcd != null and htfxcd !=''">
			,#{htfxcd}
		</if>
		<if test="fkbz != null and fkbz !=''">
			,#{fkbz}
		</if>
		<if test="kjlx != null and kjlx !=''">
			,#{kjlx}
		</if>
		<if test="ksrq != null and ksrq !=''">
			,cast(#{ksrq} as date )
		</if>
		<if test="dqrq != null and dqrq !=''">
			,cast(#{dqrq} as date )
		</if>
		<if test="bchtid != null and bchtid !=''">
			,#{bchtid}
		</if>
		<if test="kjhtid != null and kjhtid !=''">
			,#{kjhtid}
		</if>
		<if test="sfkj != null and sfkj !=''">
			,#{sfkj}
		</if>
		<if test="sfjgfw != null and sfjgfw !=''">
			,#{sfjgfw}
		</if>
		,#{lrry},LOCALTIMESTAMP,'0','0')
	</insert>

	<!-- 合同修改方法(修改页面) -->
	<update id="updateContract" parameterType="HtglDto">
		update igams_htgl set
		xgry=#{xgry}, xgsj=LOCALTIMESTAMP
		<if test="qgid !=null and qgid != ''">
			,qgid = #{qgid}
		</if>
		<if test="htnbbh !=null and htnbbh != ''">
			,htnbbh = #{htnbbh}
		</if>
		<if test="htwbbh !=null and htwbbh != ''">
			,htwbbh = #{htwbbh}
		</if>
		<if test="ywlx !=null and ywlx != ''">
			,ywlx = #{ywlx}
		</if>
		<if test="cglx !=null and cglx != ''">
			,cglx = #{cglx}
		</if>
		<if test="ddrq !=null and ddrq != ''">
			,ddrq = cast(#{ddrq} as timestamp)
		</if>
		<if test="zje !=null and zje != ''">
			,zje = cast(#{zje} as decimal)
		</if>
		<if test="yfje !=null and yfje != ''">
			,yfje = cast(#{yfje} as decimal)
		</if>
		<if test="fkzje !=null and fkzje != ''">
			,fkzje = cast(#{fkzje} as decimal)
		</if>
		<if test="fpje !=null and fpje != ''">
			,fpje = cast(#{fpje} as decimal)
		</if>
		<if test="gys !=null and gys != ''">
			,gys = #{gys}
		</if>
		<if test="fzr !=null and fzr != ''">
			,fzr = #{fzr}
		</if>
		<if test="sqbm !=null and sqbm != ''">
			,sqbm = #{sqbm}
		</if>
		<if test="cjrq !=null and cjrq != ''">
			,cjrq = cast(#{cjrq} as timestamp)
		</if>
		<if test="tjrq !=null and tjrq != ''">
			,tjrq = cast(#{tjrq} as timestamp)
		</if>
		<if test="htwfrq !=null and htwfrq != ''">
			,htwfrq = cast(#{htwfrq} as timestamp)
		</if>
		<if test="sl !=null and sl != ''">
			,sl = cast(#{sl} as numeric)
		</if>
		<if test="biz !=null and biz != ''">
			,biz = #{biz}
		</if>
		<if test="hl !=null and hl != ''">
			,hl = cast(#{hl} as numeric)
		</if>
		<if test="szbj !=null and szbj != ''">
			,szbj = #{szbj}
		</if>
		<if test="bz !=null and bz != ''">
			,bz = #{bz}
		</if>
		<if test="u8cgid !=null and u8cgid != ''">
			,u8cgid = #{u8cgid}
		</if>
		<if test="u8poid !=null and u8poid != ''">
			,u8poid = #{u8poid}
		</if>
		<if test="u8omid !=null and u8omid != ''">
			,u8omid = #{u8omid}
		</if>
		<if test="wcbj !=null and wcbj != ''">
			,wcbj = #{wcbj}
		</if>
		<if test="fkfs !=null and fkfs != ''">
			,fkfs = #{fkfs}
		</if>
		<if test="fpfs !=null and fpfs != ''">
			,fpfs = #{fpfs}
		</if>
		<if test="zt !=null and zt != ''">
			,zt = #{zt}
		</if>
		<if test="jhrq !=null and jhrq != ''">
			,jhrq = cast(#{jhrq} as timestamp)
		</if>
		<if test="fkf != null and fkf !=''">
			,fkf = #{fkf}
		</if>
		<if test="ddslid != null and ddslid !=''">
			,ddslid = #{ddslid}
		</if>
		<if test="csrs != null and csrs !=''">
			,csrs = #{csrs}
		</if>
		<if test="ddspid != null and ddspid !=''">
			,ddspid = #{ddspid}
		</if>
		<if test="shsj != null and shsj !=''">
			,shsj = cast(#{shsj} as timestamp)
		</if>
		<if test="htfxcd != null and htfxcd !=''">
			,htfxcd = #{htfxcd}
		</if>
		<if test="fkbz != null and fkbz !=''">
			,fkbz = #{fkbz}
		</if>
		<if test="kjlx != null and kjlx !=''">
			,kjlx = #{kjlx}
		</if>
		<if test="ksrq != null and ksrq !=''">
			,ksrq = cast(#{ksrq} as date )
		</if>
		<if test="dqrq != null and dqrq !=''">
			,dqrq = cast(#{dqrq} as date )
		</if>
		<if test="kjhtid != null and kjhtid !=''">
			,kjhtid = #{kjhtid}
		</if>
		<if test="kjhtidnull !=null and kjhtidnull != '' and kjhtidnull == '1'.toString">
			,kjhtid = null
		</if>
		<if test="sfkj != null and sfkj !=''">
			,sfkj = #{sfkj}
		</if>
		<if test="sfjgfw != null and sfjgfw !=''">
			,sfjgfw=#{sfjgfw}
		</if>
		<where>
			htid = #{htid}
		</where>
	</update>

	<update id="update" parameterType="HtglDto">
		update igams_htgl set
		xgry=#{xgry}, xgsj=LOCALTIMESTAMP
		<if test="qgid !=null and qgid != ''">
			,qgid = #{qgid}
		</if>
		<if test="htnbbh !=null and htnbbh != ''">
			,htnbbh = #{htnbbh}
		</if>
		<if test="htwbbh !=null and htwbbh != ''">
			,htwbbh = #{htwbbh}
		</if>
		<if test="ywlx !=null and ywlx != ''">
			,ywlx = #{ywlx}
		</if>
		<if test="cglx !=null and cglx != ''">
			,cglx = #{cglx}
		</if>
		<if test="ddrq !=null and ddrq != ''">
			,ddrq = cast(#{ddrq} as timestamp)
		</if>
		<if test="zje !=null and zje != ''">
			,zje = cast(#{zje} as decimal)
		</if>
		<if test="yfje !=null and yfje != ''">
			,yfje = cast(#{yfje} as decimal)
		</if>
		<if test="fpje !=null and fpje != ''">
			,fpje = cast(#{fpje} as decimal)
		</if>
		<if test="gys !=null and gys != ''">
			,gys = #{gys}
		</if>
		<if test="fzr !=null and fzr != ''">
			,fzr = #{fzr}
		</if>
		<if test="sqbm !=null and sqbm != ''">
			,sqbm = #{sqbm}
		</if>
		<if test="cjrq !=null and cjrq != ''">
			,cjrq = cast(#{cjrq} as timestamp)
		</if>
		<if test="tjrq !=null and tjrq != ''">
			,tjrq = cast(#{tjrq} as timestamp)
		</if>
		<if test="htwfrq !=null and htwfrq != ''">
			,htwfrq = cast(#{htwfrq} as timestamp)
		</if>
		<if test="sl !=null and sl != ''">
			,sl = cast(#{sl} as numeric)
		</if>
		<if test="biz !=null and biz != ''">
			,biz = #{biz}
		</if>
		<if test="hl !=null and hl != ''">
			,hl = cast(#{hl} as numeric)
		</if>
		<if test="szbj !=null and szbj != ''">
			,szbj = #{szbj}
		</if>
		<if test="bz !=null and bz != ''">
			,bz = #{bz}
		</if>
		<if test="u8cgid !=null and u8cgid != ''">
			,u8cgid = #{u8cgid}
		</if>
		<if test="u8poid !=null and u8poid != ''">
			,u8poid = #{u8poid}
		</if>
		<if test="wcbj !=null and wcbj != ''">
			,wcbj = #{wcbj}
		</if>
		<if test="fkfs !=null and fkfs != ''">
			,fkfs = #{fkfs}
		</if>
		<if test="fpfs !=null and fpfs != ''">
			,fpfs = #{fpfs}
		</if>
		<if test="zt !=null and zt != ''">
			,zt = #{zt}
		</if>
		<if test="jhrq !=null and jhrq != ''">
			,jhrq = cast(#{jhrq} as timestamp)
		</if>
		<if test="fkf != null and fkf !=''">
			,fkf = #{fkf}
		</if>
		<if test="ddslid != null and ddslid !=''">
			,ddslid = #{ddslid}
		</if>
		<if test="csrs != null and csrs !=''">
			,csrs = #{csrs}
		</if>
		<if test="ddspid != null and ddspid !=''">
			,ddspid = #{ddspid}
		</if>
		<if test="shsj != null and shsj !=''">
			,shsj = cast(#{shsj} as timestamp)
		</if>
		<if test="sffpwh != null and sffpwh !=''">
			,sffpwh = #{sffpwh}
		</if>
		<if test="htfxcd != null and htfxcd !=''">
			,htfxcd = #{htfxcd}
		</if>
		<if test="fkbz != null and fkbz !=''">
			,fkbz = #{fkbz}
		</if>
		<if test="xzje != null and xzje !=''">
			,xzje = cast(#{xzje} as numeric)
		</if>
		<where>
			htid = #{htid}
		</where>
	</update>

	<select id="getContractSerial" parameterType="String" resultType="String">
		SELECT lpad(cast((CAST(coalesce(MAX(substring(htnbbh,LENGTH(htnbbh)-strpos(reverse(htnbbh),'-')+2,cast(#{num} as integer ))),'0') AS numeric) + 1) as VARCHAR),cast(#{num} as integer ), '0') serial
		FROM igams_htgl
		<where>
			scbj != '1' AND htnbbh like #{prefix}||'%'
			<if test="num !=null and num != '' and num == '2'.toString">
				and bchtid is null
			</if>
		</where>
	</select>

	<!-- 查询所有消息 -->
	<select id="getPagedAuditHtgl" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.lrsj
		from igams_htgl htgl
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<where>
			htgl.scbj!='1'
			<if test="zt !=null and zt !=''">
				and htgl.zt = #{zt}
			</if>
			<if test="htnbbh !=null and htnbbh !=''">
				and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
			</if>
			<if test="htwbbh !=null and htwbbh !=''">
				and htgl.htwbbh ILIKE '%'||#{htwbbh}||'%'
			</if>
			<if test="gys !=null and gys !=''">
				and htgl.gys ILIKE '%'||#{gys}||'%'
			</if>
			<if test="sqbm !=null and sqbm !=''">
				and jg_sqbm.jgmc ILIKE '%'||#{sqbm}||'%'
			</if>
		</where>
	</select>

	<!-- 合同审核列表-->
	<select id="getAuditListHtgl" parameterType="List" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.jhrq,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,
		jg_sqbm.jgmc as sqbmmc,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,shxx_sqsj,shxx_gwmc,sqr,shxx_lrryxm,shxx_shsj,shxx_sftg,shxx_shxxid,gysxx.gysmc as gysmc,xtyh.zsxm as fzrmc,
		htgl.htlx,shxx_shyj
		from
		<foreach collection="list" separator="union" open="(" close=") "
				 item="item" index="index">
			select #{item.htid} htid,#{item.shxx_shxxid} shxx_shxxid,#{item.shxx_sqsj} shxx_sqsj,#{item.sqr} sqr,
			#{item.shxx_lrryxm} shxx_lrryxm,#{item.shxx_shsj} shxx_shsj,
			#{item.shxx_sftg} shxx_sftg,#{item.shxx_gwmc} shxx_gwmc,#{item.shxx_shyj} shxx_shyj,#{index} rownum
		</foreach>
		tmp
		left join igams_htgl htgl on htgl.htid = tmp.htid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		order by tmp.rownum
	</select>

	<!-- 获取合同数据 -->
	<select id="getDtoByDdslid" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.jhrq,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,jg_sqbm.jgid sqbm,
		jg_sqbm.jgmc as sqbmmc,jg_sqbm.jgdm as jqdm,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,gysxx.gysmc as gysmc,gysxx.gysdm as gysdm,xtyh.zsxm as fzrmc,
		gysxx.lxr gysfzr,gysxx.dh gysfzrdh
		from igams_htgl htgl
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<where>
			htgl.ddslid=#{ddslid} and htgl.scbj!='1'
		</where>
	</select>

	<!-- 获取审批人信息 -->
	<select id="getSprxxByDdid" parameterType="String" resultType="HtglDto">
		select yhid as sprid,zsxm as sprxm,ddid as sprddid,yhm as spryhm
		from matridx_xtyh
		<where>
			scbj!='1' and ddid=#{ddid}
		</where>
	</select>

	<!-- 获取审批人角色 -->
	<select id="getSprjsBySprid" parameterType="String" resultType="HtglDto">
		select yhjs.jsid as sprjsid,xtjs.jsmc as sprjsmc
		from matridx_yhjs yhjs
		left join matridx_xtjs xtjs on xtjs.jsid=yhjs.jsid
		<where>
			yhjs.yhid=#{sprid}
		</where>
	</select>

	<!-- 将钉钉实例ID设置为空 -->
	<update id="updateDdslidToNull" parameterType="HtglDto">
		update igams_htgl set ddslid = null
		<where>
			scbj !='1' and htid =#{htid}
		</where>
	</update>

	<select id="getContractMap" parameterType="HtglDto" resultType="Map">
		SELECT htgl.htid,gysxx.gysmc AS seller, htgl.htnbbh AS number, htgl.jhrq||'' AS deliveryTime, fkfs.csmc AS payment, fzr.zsxm AS buyerContacts
		, gysxx.gysmc AS sellerUnit, gysxx.dq AS sellerAddress, gysxx.lxr AS sellerContacts, gysxx.dh AS sellerPhone, gysxx.cz AS sellerFax
		, gysxx.khh AS sellerBank, gysxx.zh AS sellerAccount, gysxx.yx AS sellerEmail, fjcfb.wjlj,gysxx.sl||'' as zzs
		FROM igams_htgl htgl
		LEFT JOIN igams_gysxx gysxx ON gysxx.gysid = htgl.gys
		LEFT JOIN matridx_jcsj htmb
		ON htmb.csid = htgl.ywlx
		AND htmb.jclb = 'CONTRACT_TYPE'
		LEFT JOIN matridx_fjcfb fjcfb ON fjcfb.ywid = htmb.csid
		LEFT JOIN matridx_jcsj fkfs ON fkfs.csid = htgl.fkfs
		LEFT JOIN matridx_xtyh fzr ON fzr.yhid = htgl.fzr
		<where>
			htgl.htid=#{htid}
		</where>
	</select>

	<!-- 获取合同明细 -->
	<select id="getContractListMap"  parameterType="HtglDto" resultType="Map">
		SELECT  wlgl.wlmc, wlgl.wlbm,wlgl.ychh,
		case when qgmx.hwmc is not null and qgmx.hwmc != '' then qgmx.hwmc else wlgl.wlmc || wlgl.wlbm end wlmcbm,
		wlgl.scs, wlgl.bctj, wlgl.gg
		, cast(htmx.sl as text) as sl, wlgl.jldw, cast(htmx.hsdj as text) as hsdj,
		cast(cast(htmx.hsdj*htmx.sl as DECIMAL(18,2)) as text) as xj,jc_fp.csmc as fplx,qggl.djh,htmx.bz as htmxbz
		FROM igams_htmx htmx
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = htmx.wlid
		LEFT JOIN igams_htgl htgl ON htgl.htid= htmx.htid
		LEFT JOIN matridx_jcsj jc_fp ON jc_fp.csid =htgl.fpfs
		LEFT JOIN igams_qggl qggl ON qggl.qgid=htmx.qgid
		left join igams_qgmx qgmx on qgmx.qgmxid=htmx.qgmxid
		<where>
			htmx.htid = #{htid}
			AND htmx.scbj !='1'
		</where>
	</select>

	<select id="getDtoList" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.scbj,htgl.zt,
		zje,yfje,fkzje,(coalesce(zje,0)-coalesce(yfje,0)-coalesce(fkzje,0)) wfje,htgl.htlx,htgl.bchtid
		from igams_htgl htgl
		<where>
			htgl.scbj != '1'
			<if test="htnbbh != null and htnbbh != ''">
				and htgl.htnbbh = #{htnbbh}
			</if>
			<if test="gys != null and gys != ''">
				and htgl.gys = #{gys}
			</if>
			<if test="htlx !=null and htlx != ''">
				and htgl.htlx = #{htlx}
			</if>
			<if test="bchtid !=null and bchtid != ''">
				and htgl.bchtid = #{bchtid}
			</if>
			<if test="ids !=null and ids.size > 0">
				and htid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</select>

	<select id="getListByNbbh" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh
		from igams_htgl htgl
		<where>
			htgl.scbj ='0'
			<if test="htnbbh != null and htnbbh != ''">
				and htgl.htnbbh = #{htnbbh}
			</if>
			<if test="htid != null and htid != ''">
				and htgl.htid != #{htid}
			</if>
		</where>
	</select>

	<!-- 废弃 -->
	<update id="delete" parameterType="HtglDto">
		update igams_htgl set
		scry = #{scry},scsj = LOCALTIMESTAMP,scbj=#{scbj}
		<where>
			<if test="htid !=null and htid != ''">
				htid = #{htid}
			</if>
			<if test="ids !=null and ids.size > 0">
				or htid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>


	<!-- 获取请购完成ID -->
	<select id="isPurchaseComp" parameterType="String" resultType="String">
		select tmp.qgid ,qgmx.qgmxid,qgmx.sysl,qgmx.ydsl
			from (
				SELECT qgmx.qgid 
					FROM igams_htgl htgl
			    LEFT JOIN igams_htmx htmx ON htgl.htid = htmx.htid
			    LEFT JOIN igams_qgmx qgmx ON qgmx.qgmxid = htmx.qgmxid and qgmx.scbj='0' and qgmx.zt='80'
				where htgl.htid = #{htid} and qgmx.qgid is not null
				group by qgmx.qgid
			) tmp 
		left outer join igams_qgmx qgmx on tmp.qgid=qgmx.qgid and (qgmx.sysl != 0 or qgmx.ydsl != 0) and qgmx.scbj='0' and qgmx.zt='80' and qgmx.qxqg!='1'
		where qgmx.qgmxid is null
	</select>

	<!-- 合同外发盖章 -->
	<update id="outgrowthContract" parameterType="HtglDto">
		update igams_htgl set htwfrq = LOCALTIMESTAMP
		<where>
			<if test="htid !=null and htid != ''">
				htid = #{htid}
			</if>
			<if test="ids !=null and ids.size > 0">
				or htid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>

	<!-- 获取合同数量(月) -->
	<select id="getContractMapByMon" parameterType="HtglDto" resultType="Map">
		select to_char(ht.cjrq,'YYYY-MM') cjrq,count(ht.htid)
		from igams_htgl ht
		where ht.zt !='00' and ht.scbj ='0'
		and to_char(ht.cjrq,'YYYY-MM') >= #{shsjstart}
		and #{shsjend} >= to_char(ht.cjrq,'YYYY-MM')
		group by to_char(ht.cjrq,'YYYY-MM')
		order by to_char(ht.cjrq,'YYYY-MM') desc
	</select>

	<!-- 查询未完全到货的合同 -->
	<select id="getPagedDtoKdhList" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.wcbj,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,
		jg_sqbm.jgmc as sqbmmc,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,htgl.scbj,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,gysxx.gysmc as gysmc,xtyh.zsxm as fzrmc,htgl.jhrq
		from igams_htgl htgl
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			htgl.htid in (
			select htgl.htid
			from igams_htgl htgl
			left join igams_htmx htmx on htgl.htid=htmx.htid
			where htgl.zt='80'  and htmx.scbj!='1' and htgl.htlx!='3' and htgl.bchtid is null
			<if test="cghzbj == null or cghzbj == ''">
				and (htmx.sl>htmx.dhsl or htmx.dhsl is null)
			</if>
			<if test="cghzbj != null and cghzbj != '' and cghzbj=='1'.toString()">
				and coalesce(htmx.dhsl,0)>0
			</if>
			group by htgl.htid
			) and
			<include refid="SEARCH_TERMS_OTHER"></include>
		</where>
	</select>

	<select id="getPageListContract" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.gys,htgl.fzr,htgl.cjrq,htgl.tjrq,htgl.wcbj,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,
		jg_sqbm.jgmc as sqbmmc,jc_fk.csmc as fkfsmc,jc_fp.csmc as fpfsmc,htgl.scbj,
		jc_biz.csmc as bizmc,jc_ywlx.csmc as ywlxmc,gysxx.gysmc as gysmc,xtyh.zsxm as fzrmc,htgl.jhrq
		from igams_htgl htgl
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			(htgl.sffpwh='0' or htgl.sffpwh='2') and
			<include refid="SEARCH_TERMS_OTHER"></include>
		</where>
	</select>

	<update id="updateFkxxByList" parameterType="List">
		with recursive t (htid,yfje,wcbj) as (
		select tmp.htid,tmp.yfje,tmp.wcbj from
		<foreach collection="list" item="item" index="index" separator=" union all" open=" (" close=") tmp">
			select
			#{item.htid} htid,#{item.yfje} yfje,#{item.wcbj} wcbj
		</foreach>
		left join igams_htgl htgl on htgl.htid=tmp.htid and htgl.scbj='0'
		)
		update igams_htgl htgl set yfje=cast((select yfje from t where htid=htgl.htid) as numeric ),
		wcbj=(select wcbj from t where htid=htgl.htid),xgsj=LOCALTIMESTAMP
		where htgl.htid in (
		select htid from t
		)
	</update>

	<update id="updateHtglDtos" parameterType="List">
		<if test="list !=null and list.size > 0">
			<foreach collection="list" separator=";" item="item" index="index">
				update igams_htgl
				<set>
					xgsj=LOCALTIMESTAMP
					<if test="item.xgry != null and item.xgry != ''">
						,xgry=#{item.xgry}
					</if>
					<if test="item.fkzje != null and item.fkzje != ''">
						,fkzje=cast(#{item.fkzje} as numeric)
					</if>
					<if test="item.yfje != null and item.yfje != ''">
						,yfje=cast(#{item.yfje} as numeric)
					</if>
					<if test="item.updateFlg != null and item.updateFlg != ''">
						<if test="item.updateFlg =='1'.toString ">
							<if test="item.xzje != null and item.xzje != ''">
								,xzje=cast(#{item.xzje} as numeric)
							</if>
						</if>
						<if test="item.updateFlg =='0'.toString ">
							,xzje=null
						</if>
					</if>
				</set>
				<where>
					htid=#{item.htid}
				</where>
			</foreach>
		</if>
	</update>
	<!-- 审核导出 -->
	<select id="getCountForAuditingSearchExp" parameterType="HtglDto"
			resultType="java.lang.Integer">
		select count(htgl.htid) from igams_htgl htgl
		left join (
		select tmp.ywid,string_agg(tmp.gwmc||'!'||tmp.shsj,',' order by tmp.shsj) as temp
		from (select gw.gwmc,MAX(sh.shsj) as shsj,sh.ywid,Sum(sh.lcxh) as lcxh
		from matridx_shxx sh
		left join matridx_spgw gw on gw.gwid=sh.gwid
		where ((sh.sftg='1' and sh.gwid is not null) or (sh.sftg is null))
		group by sh.lcxh,gw.gwmc,sh.ywid) tmp
		group by tmp.ywid
		) tmp on tmp.ywid=htgl.htid
		left join (
		select ywid,max(shsj) tjsj
		from matridx_shxx
		where sftg is null
		group by ywid
		)tj on tj.ywid=htgl.htid
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_fxcd on jc_fxcd.csid = htgl.htfxcd
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			<include refid="SEARCH_TERMS"></include>
		</where>
	</select>

	<select id="getListForAuditingSearchExp" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid ${sqlParam}
		from igams_htgl htgl
		left join (
		select tmp.ywid,string_agg(tmp.gwmc||'!'||tmp.shsj,',' order by tmp.shsj) as temp
		from (select gw.gwmc,MAX(sh.shsj) as shsj,sh.ywid,Sum(sh.lcxh) as lcxh
		from matridx_shxx sh
		left join matridx_spgw gw on gw.gwid=sh.gwid
		where ((sh.sftg='1' and sh.gwid is not null) or (sh.sftg is null))
		group by sh.lcxh,gw.gwmc,sh.ywid) tmp
		group by tmp.ywid
		) tmp on tmp.ywid=htgl.htid
		left join (
		select ywid,max(shsj) tjsj
		from matridx_shxx
		where sftg is null
		group by ywid
		)tj on tj.ywid=htgl.htid
		left join igams_htgl kjhtgl on kjhtgl.htid = htgl.kjhtid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_fxcd on jc_fxcd.csid = htgl.htfxcd
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		<if test="(entire!=null and entire!='') or (wlbm!=null and wlbm!='') or (wlmc!=null and wlmc!='') or(gg!=null and gg!='')">
			left join igams_htmx htmx on htmx.htid=htgl.htid
			left join igams_wlgl wlgl on wlgl.wlid=htmx.wlid
		</if>
		<where>
			<include refid="SEARCH_TERMS"></include>
		</where>
		order by
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
		LIMIT #{pageSize} OFFSET #{pageStart}
	</select>

	<select id="getListForAuditingSelectExp" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid ${sqlParam} from (
		<foreach item="item" index="index" collection="ids"
				 separator=" union all ">
			select #{item,jdbcType=VARCHAR} htid,#{index} ordernum
		</foreach>
		) tmp1
		left outer join igams_htgl htgl on tmp1.htid = htgl.htid
		left join (
		select tmp.ywid,string_agg(tmp.gwmc||'!'||tmp.shsj,',' order by tmp.shsj) as temp
		from (select gw.gwmc,MAX(sh.shsj) as shsj,sh.ywid,Sum(sh.lcxh) as lcxh
		from matridx_shxx sh
		left join matridx_spgw gw on gw.gwid=sh.gwid
		where ((sh.sftg='1' and sh.gwid is not null) or (sh.sftg is null))
		group by sh.lcxh,gw.gwmc,sh.ywid) tmp
		group by tmp.ywid
		) tmp on tmp.ywid=tmp1.htid
		left join (
		select ywid,max(shsj) tjsj
		from matridx_shxx
		where lcxh is null    and sftg is null
		group by ywid
		)tj on tj.ywid=tmp1.htid
		order by tmp1.ordernum
	</select>
	<select id="getCountOrdersByRq" parameterType="HtglDto" resultType="Map">
		SELECT count(htgl.htid),jcsj.csmc ywlxmc from igams_htgl htgl
		left join matridx_jcsj jcsj on jcsj.csid = htgl.ywlx
		<where>
			htgl.scbj = '0'
			and htgl.zt = '80'
			<if test="tjsjstart != null and tjsjstart != ''">
				and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
			</if>
			<if test="tjsjend !=null and tjsjend !=''">
				and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
			</if>
			<if test="tjsjMstart != null and tjsjMstart != ''">
				and to_char(htgl.cjrq,'yyyy-MM') &gt;= #{tjsjMstart}
			</if>
			<if test="tjsjMend !=null and tjsjMend !=''">
				and to_char(htgl.cjrq,'yyyy-MM') &lt;= #{tjsjMend}
			</if>
			<if test="tjsjYstart != null and tjsjYstart != ''">
				and to_char(htgl.cjrq,'yyyy') &gt;= #{tjsjYstart}
			</if>
			<if test="tjsjYend !=null and tjsjYend !=''">
				and to_char(htgl.cjrq,'yyyy') &lt;= #{tjsjYend}
			</if>
		</where>
		GROUP BY jcsj.csmc
	</select>
	<select id="getPurchaseAuditTimeByRq" parameterType="HtglDto" resultType="Map">
		SELECT
		COALESCE(AVG (
		case when date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp)
		&lt; 0 then 0
		else date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp) end
		),0)AS bmjl,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS cggl,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0)AS cgjl,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS gsld
		FROM
		igams_qggl qg
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( sh.sftg = '1' OR sh.sftg IS NULL )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = qg.qgid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL GROUP BY ywid ) tj ON tj.ywid = qg.qgid
		LEFT JOIN matridx_jcsj jcsj on jcsj.csid = qg.qglb
		WHERE
		jcsj.csdm != 'ADMINISTRATION'
		AND qg.zt = '80'
		AND qg.scbj = '0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(qg.shsj,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(qg.shsj,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(qg.shsj,'yyyy-MM-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend !=null and shsjend !=''">
			and to_char(qg.shsj,'yyyy-MM-dd') &lt;= #{shsjend}
		</if>
	</select>
	<select id="getPurchaseAuditToContractSubmit" parameterType="HtglDto" resultType="Map">
		SELECT
		COALESCE(cast(AVG( date_part( 'day', htgl.tjrq - qggl.shsj ) ) as decimal(18,2)),0) pjys
		FROM
				( SELECT htid, qgid FROM igams_htmx WHERE scbj = '0' GROUP BY htid, qgid ) htmx
					LEFT JOIN igams_htgl htgl ON htgl.htid = htmx.htid
					LEFT JOIN igams_qggl qggl ON qggl.qgid = htmx.qgid
		WHERE
			qggl.zt = '80'
		  AND htgl.zt = '80'
		  AND htgl.scbj = '0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.tjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.tjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
	</select>
	<select id="getContractAuditTimeByRq" parameterType="HtglDto" resultType="Map">
		SELECT
		COALESCE(AVG (
		case when date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp)
		&lt; 0 then 0
		else date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp) end
		),0)AS cgjl,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS fwsp,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0)AS gsld,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS kj
		FROM
		igams_htgl htgl
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( sh.sftg = '1' OR sh.sftg IS NULL )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = htgl.htid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL GROUP BY ywid ) tj ON tj.ywid = htgl.htid
		WHERE
		htgl.zt = '80'
		AND htgl.scbj = '0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend !=null and shsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{shsjend}
		</if>
	</select>
	<select id="getContractPayAuditTimeByRq" parameterType="HtglDto" resultType="Map">
		SELECT
		COALESCE(AVG (
		case when date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp)
		&lt; 0 then 0
		else date_part('hour',to_char(to_timestamp(split_part(split_part(temp,',',1),'!',2), 'yyyy-MM-dd HH24:MI'), 'yyyy-MM-dd HH24:MI')::timestamp-tj.tjsj::timestamp) end
		),0)AS cgjl,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 1 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS cwqy,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 2 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0)AS cwqe,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 3 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS gsld,
		COALESCE(AVG (
		case when date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 5 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP)
		&lt; 0 then 0 else
		date_part('hour',to_char( to_timestamp( split_part( split_part( TEMP, ',', 5 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP - to_char( to_timestamp( split_part( split_part( TEMP, ',', 4 ), '!', 2 ), 'yyyy-MM-dd HH24:MI' ), 'yyyy-MM-dd HH24:MI' ) :: TIMESTAMP) end
		),0) AS cn
		FROM
		igams_htfkqk htfkqk
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( sh.sftg = '1' OR sh.sftg IS NULL )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = htfkqk.htfkid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL GROUP BY ywid ) tj ON tj.ywid = htfkqk.htfkid
		WHERE
		htfkqk.zt = '80'
		AND htfkqk.scbj = '0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htfkqk.shtgsj,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htfkqk.shtgsj,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(htfkqk.shtgsj,'yyyy-MM-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend !=null and shsjend !=''">
			and to_char(htfkqk.shtgsj,'yyyy-MM-dd') &lt;= #{shsjend}
		</if>
	</select>
	<select id="getContractAmountByRq" parameterType="HtglDto" resultType="Map">
		SELECT 	CAST(COALESCE(sum(htmx.hjje),0) AS DECIMAL(18,2)) hjzye,jgxx.jgmc sqbmmc
		FROM
		igams_htgl htgl
		LEFT JOIN igams_htmx htmx ON htgl.htid = htmx.htid and htmx.scbj = '0'
		LEFT JOIN matridx_jgxx jgxx on htgl.sqbm = jgxx.jgid
		where
		htgl.scbj = '0'
		AND htgl.zt = '80'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		<if test="tjsjMstart != null and tjsjMstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM') &gt;= #{tjsjMstart}
		</if>
		<if test="tjsjMend !=null and tjsjMend !=''">
			and to_char(htgl.cjrq,'yyyy-MM') &lt;= #{tjsjMend}
		</if>
		<if test="tjsjYstart != null and tjsjYstart != ''">
			and to_char(htgl.cjrq,'yyyy') &gt;= #{tjsjYstart}
		</if>
		<if test="tjsjYend !=null and tjsjYend !=''">
			and to_char(htgl.cjrq,'yyyy') &lt;= #{tjsjYend}
		</if>
		GROUP BY
		jgxx.jgmc
	</select>
	<select id="getCountStatistics" parameterType="String" resultType="HtglDto">
		SELECT count(htid) htds ,to_char(cjrq,'MM') cjrq,
		(select count(htid) from igams_htgl where scbj='0' and zt='80' and to_char(cjrq,'yyyy')=#{year} ) zs
		 FROM igams_htgl where scbj='0' and zt='80' and to_char(cjrq,'yyyy')=#{year}  GROUP BY to_char(cjrq,'MM')  ORDER BY cjrq asc
	</select>
<!--	根据物料分类查询到货及时率-->
	<select id="getMatterArrivePer" parameterType="String" resultType="HtglDto">
		select case when  wjsdh=0 then '100.00' else round((jsdh/(wjsdh+jsdh))*100,2) end jsdhl,
		case when  jsdh=0 then '100.00' else round((wjsdh/(wjsdh+jsdh))*100,2) end wjsdhl,wlflmc
		from (
		select COALESCE( sum(jsdh),0) jsdh,COALESCE( sum(wjsdh),0) wjsdh,wlflmc from (
		select
		case when htmx.jhdhrq &gt;=htmx.dhrq then count(htmx.htmxid) end jsdh,
		case when htmx.jhdhrq &lt; htmx.dhrq then count(htmx.htmxid) end wjsdh ,
		wlfl.csmc wlflmc
		from igams_htmx htmx
		left join matridx_jcsj wlfl on wlfl.csid=htmx.wlfl
		left join igams_htgl htgl on htgl.htid=htmx.htid
		where htmx.scbj='0' and htmx.dhsl is not null and htmx.dhsl!='0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		group by htmx.jhdhrq,htmx.dhrq,wlfl.csmc)
		tmp
		GROUP BY wlflmc
		)tab
		where wlflmc is not null
	</select>
	<!--	根据合同类型查询到货及时率-->
	<select id="getContractClassArrivePer" parameterType="String" resultType="HtglDto">
		select case when  wjsdh=0 then '100.00' else round((jsdh/(wjsdh+jsdh))*100,2) end jsdhl,
		case when  jsdh=0 then '100.00' else round((wjsdh/(wjsdh+jsdh))*100,2) end wjsdhl,htlxmc
		from (
		select COALESCE( sum(jsdh),0) jsdh,COALESCE( sum(wjsdh),0) wjsdh,htlxmc from (
		select
		case when htmx.jhdhrq &gt;=htmx.dhrq then count(htmx.htmxid) end jsdh,
		case when htmx.jhdhrq &lt; htmx.dhrq then count(htmx.htmxid) end wjsdh,
		htlx.csmc htlxmc
		from igams_htmx htmx
		left join igams_htgl htgl on htgl.htid=htmx.htid
		left join matridx_jcsj htlx on htlx.csid=htgl.ywlx
		where htmx.scbj='0' and htmx.dhsl is not null and htmx.dhsl!='0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		group by htmx.jhdhrq,htmx.dhrq,htlx.csmc)
		tmp
		GROUP BY htlxmc
		)tab
	</select>

	<!--	根据负责人查询到货及时率-->
	<select id="getChargePerArrivePer" parameterType="String" resultType="HtglDto">
		select case when  wjsdh=0 then '100.00' else round((jsdh/(wjsdh+jsdh))*100,2) end jsdhl,
		case when  jsdh=0 then '100.00' else round((wjsdh/(wjsdh+jsdh))*100,2) end wjsdhl,fzrmc
		from (
		select COALESCE( sum(jsdh),0) jsdh,COALESCE( sum(wjsdh),0) wjsdh,fzrmc from (
		select
		case when htmx.jhdhrq &gt;=htmx.dhrq then count(htmx.htmxid) end jsdh,
		case when htmx.jhdhrq &lt; htmx.dhrq then count(htmx.htmxid) end wjsdh,
		fzr.zsxm fzrmc
		from igams_htmx htmx
		left join igams_htgl htgl on htgl.htid=htmx.htid
		left join matridx_xtyh fzr on fzr.yhid=htgl.fzr
		where htmx.scbj='0' and htmx.dhsl is not null and htmx.dhsl!='0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		group by htmx.jhdhrq,htmx.dhrq,fzr.zsxm)
		tmp
		GROUP BY fzrmc
		)tab
	</select>
	<!--	根据供应商查询到货及时率-->
	<select id="getSupplierArrivePer" parameterType="String" resultType="HtglDto">
		select case when  wjsdh=0 then '100.00' else round((jsdh/(wjsdh+jsdh))*100,2) end jsdhl,
		case when  jsdh=0 then '100.00' else round((wjsdh/(wjsdh+jsdh))*100,2) end wjsdhl,gysmc
		from (
		select COALESCE( sum(jsdh),0) jsdh,COALESCE( sum(wjsdh),0) wjsdh,gysmc from (
		select
		case when htmx.jhdhrq &gt;=htmx.dhrq then count(htmx.htmxid) end jsdh,
		case when htmx.jhdhrq &lt; htmx.dhrq then count(htmx.htmxid) end wjsdh,
		gysxx.gysmc gysmc
		from igams_htmx htmx
		left join igams_htgl htgl on htgl.htid=htmx.htid
		left join igams_gysxx gysxx on gysxx.gysid=htgl.gys
		where htmx.scbj='0' and htmx.dhsl is not null and htmx.dhsl!='0'
		<if test="tjsjstart != null and tjsjstart != ''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &gt;= #{tjsjstart}
		</if>
		<if test="tjsjend !=null and tjsjend !=''">
			and to_char(htgl.cjrq,'yyyy-MM-dd') &lt;= #{tjsjend}
		</if>
		<if test = "gysids != null and gysids.length > 0 "  >
			and htgl.gys in
			<foreach collection="gysids" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by htmx.jhdhrq,htmx.dhrq,gysxx.gysmc)
		tmp
		GROUP BY gysmc
		)tab
	</select>
	<select id="getSupplierID" resultType="String">
     select gys from (
		select count(gys) sl,gys
		from igams_htgl
		where scbj='0'
		group by gys
		order by sl desc
		limit 1)tab
	</select>
	<select id="getContractByGysWithWgq" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.qgid,htgl.htnbbh,htgl.htwbbh,htgl.cglx,htgl.ddrq,htgl.fkf,jc_fkf.csmc fkfmc,
		htgl.zje,htgl.yfje,htgl.fpje,htgl.cjrq,htgl.tjrq,htgl.jhrq,htgl.ddslid,jc_htfx.csmc htfxmc,htgl.htfxcd,
		htgl.htwfrq,htgl.sl,htgl.hl,htgl.szbj,htgl.bz,htgl.zt,htgl.u8cgid,htgl.u8poid,
		htgl.sqbm, jg_sqbm.jgmc as sqbmmc,jg_sqbm.jgdm as jqdm,
		htgl.fkfs, jc_fk.csmc as fkfsmc, htgl.fpfs, jc_fp.csmc as fpfsmc,
		htgl.biz, jc_biz.csmc as bizmc, htgl.ywlx, jc_ywlx.csmc as ywlxmc,
		htgl.gys, gysxx.gysmc as gysmc, htgl.fzr, xtyh.zsxm as fzrmc,
		gysxx.gysdm as gysdm,htgl.htlx,htgl.fkbz,htgl.ksrq,htgl.dqrq,htgl.kjlx
		from igams_htgl htgl
		left outer join matridx_jgxx jg_sqbm on jg_sqbm.jgid = htgl.sqbm
		left outer join matridx_jcsj jc_fk on jc_fk.csid = htgl.fkfs
		left outer join matridx_jcsj jc_fp on jc_fp.csid = htgl.fpfs
		left outer join matridx_jcsj jc_biz on jc_biz.csid = htgl.biz
		left outer join matridx_jcsj jc_ywlx on jc_ywlx.csid = htgl.ywlx
		left outer join matridx_jcsj jc_fkf on jc_fkf.csid = htgl.fkf
		left outer join igams_gysxx gysxx on htgl.gys = gysxx.gysid
		left outer join matridx_xtyh xtyh on xtyh.yhid = htgl.fzr
		left outer join matridx_jcsj jc_htfx on jc_htfx.csid=htgl.htfxcd
		<where>
			htgl.scbj != '1' and htgl.zt ='80'
			<if test="sfgq != null and sfgq != ''and sfgq=='0'.toString()">
				and htgl.dqrq+1 &gt; now()
			</if>
			<if test="gys != null and gys != ''">
				and htgl.gys = #{gys}
			</if>
			<if test="htlx != null and htlx != ''">
				and htgl.htlx = #{htlx}
			</if>
			<if test="kjlx != null and kjlx != ''">
				and htgl.kjlx = #{kjlx}
			</if>
		</where>
		ORDER BY htgl.lrsj DESC
		Limit 1
	</select>
	<select id="getNotAllInvoice" parameterType="HtglDto" resultType="HtglDto">
		SELECT htnbbh from igams_htgl where scbj ='0' and coalesce(zje,0)>coalesce(fpje,0) and gys = #{gys} and htlx!='3'
	</select>
	<select id="getNotAllPay" parameterType="HtglDto" resultType="HtglDto">
		SELECT htnbbh from igams_htgl where scbj ='0' and coalesce(zje,0)>coalesce(yfje,0) and gys = #{gys} and htlx!='3'
	</select>
	<select id="getExistStock" parameterType="HtglDto" resultType="HtglDto">
		SELECT
			htgl.htnbbh||'('|| string_agg(distinct wlgl.wlbm, ',')||')' htnbbh
		FROM
			igams_htgl htgl
				LEFT JOIN igams_htmx htmx ON htgl.htid = htmx.htid and htmx.scbj ='0'
				LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid and hwxx.scbj ='0'
				LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = hwxx.wlid
		WHERE htgl.scbj ='0' and htgl.htlx!='3' and htgl.gys = #{gys}  and COALESCE(hwxx.kcl,0)>0
		GROUP BY htgl.htnbbh
	</select>

	<select id="queryByHtid" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.htnbbh
		from igams_htgl htgl
		where htgl.bchtid=#{htid} and htgl.scbj='0' and htgl.zt='80'
	</select>

	<select id="queryBchtglDto" parameterType="HtglDto" resultType="HtglDto">
		select  tmp.htnbbh,tmp.bchtnbbh,tmp.zje,string_agg(cast(tmp.bchjje as varchar),'→' order by tmp.cjrq asc) as bchtzje
		from (
		select htgl.htnbbh,ROUND(htgl.zje,2) as zje,bcht2.htnbbh as bchtnbbh,bcht.cjrq,ROUND(sum(htmx.hjje),2) as hjje,ROUND(sum(coalesce (bcmx.hjje,htmx.hjje)),2) as bchjje
		from igams_htgl htgl
		left join (select bchtid,htnbbh,htid
		from igams_htgl
		where bchtid=#{htid} and scbj='0' and zt='80'
		order by cjrq desc
		limit 1) bcht2 on bcht2.bchtid=htgl.htid
		left join igams_htgl bcht on bcht.bchtid=htgl.htid and bcht.scbj='0' and bcht.zt='80'
		left join igams_htmx htmx on htmx.htid=htgl.htid
		left join igams_htmx bcmx on bcmx.bchtmxid = htmx.htmxid and bcmx.htid=bcht.htid and bcmx.scbj='0'
		where htgl.htid=#{htid} and htmx.scbj='0' and htgl.scbj='0'
		group by bcht.htid,htgl.htid,bcht2.htnbbh,htgl.htnbbh,htgl.zje,bcht.cjrq
		)tmp group by tmp.htnbbh,tmp.zje,tmp.bchtnbbh
	</select>
	<select id="queryBchtZjeList" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.htnbbh,ROUND(htgl.zje,2) as zje,case when bcht2.htnbbh is not null then ROUND(sum(coalesce (bcmx.hjje,htmx.hjje)),2) else null end  as xzje,
		case when bcht2.htnbbh is not null then '1' else '0' end as updateFlg
		from igams_htgl htgl
		left join (select bchtid,htnbbh,htid
		from igams_htgl
		where scbj='0' and zt='80'
		<if test="htid != null and htid != ''">
			and bchtid=#{htid}
		</if>
		<if test="ids !=null and ids.size > 0">
			and bchtid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		</if>
		order by cjrq desc
		limit 1) bcht2 on bcht2.bchtid=htgl.htid
		left join igams_htmx htmx on htmx.htid=htgl.htid
		left join igams_htmx bcmx on bcmx.bchtmxid = htmx.htmxid and bcmx.htid=bcht2.htid and bcmx.scbj='0'
		where htmx.scbj='0' and htgl.scbj='0'
		<if test="htid != null and htid != ''">
			and htgl.htid=#{htid}
		</if>
		<if test="ids !=null and ids.size > 0">
			and htgl.htid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		</if>
		group by bcht2.htid,htgl.htid,bcht2.htnbbh
	</select>
	<select id="queryBchtZje" parameterType="HtglDto" resultType="HtglDto">
		select htgl.htid,htgl.htnbbh,ROUND(htgl.zje,2) as zje,ROUND(sum(coalesce (bcmx.hjje,htmx.hjje)),2) as xzje
		from igams_htgl htgl
		left join (select bchtid,htnbbh,htid
		from igams_htgl
		where scbj='0' and ((zt='80' and bchtid=#{bchtid}) or htid=#{htid})
		order by cjrq desc
		limit 1) bcht2 on bcht2.bchtid=htgl.htid
		left join igams_htmx htmx on htmx.htid=htgl.htid
		left join igams_htmx bcmx on bcmx.bchtmxid = htmx.htmxid and bcmx.htid=bcht2.htid and bcmx.scbj='0'
		where htmx.scbj='0' and htgl.scbj='0'
		and htgl.htid=#{bchtid}
		group by bcht2.htid,htgl.htid,bcht2.htnbbh
	</select>

	<select id="queryOrderByQgAndHt" parameterType="HtglDto" resultType="HtglDto">
		select case when qg.shsj is not null then qg.shsj else ht.cjrq end as postStart,qg.qgid,ht.htid,tmp.shsj as postEnd,
		ROUND(cast((EXTRACT(EPOCH FROM tmp.shsj-coalesce(qg.shsj,ht.cjrq) ) / 3600) as decimal),2) AS timeLag
		from igams_htgl ht
		left join igams_htmx mx on mx.htid=ht.htid
		left join igams_qggl qg on qg.qgid=mx.qgid
		left join(
		select gw.gwmc,MAX(sh.shsj) as shsj,sh.ywid
		from matridx_shxx sh
		left join matridx_spgw gw on gw.gwid=sh.gwid
		where gw.gwmc=#{shxx_gwmc} and sh.ywid=#{htid}
		group by sh.ywid,gw.gwmc
		)tmp on tmp.ywid=ht.htid
		where ht.htid=#{htid}
		group by qg.shsj,qg.qgid,ht.htid,tmp.shsj,ht.cjrq
	</select>

	<select id="queryOverTime" parameterType="HtglDto" resultType="HtglDto">
		select tmp.qgid,tmp.djh,tmp.sqrmc,tmp.sqbmmc,tmp.sqly,to_char(tmp.qgshsj,'yyyy-MM-dd HH24:MI:SS') as qgshsj,
		tmp.htnbbh,tmp.fzrmc,tmp.gysmc,tmp.zt,tmp.htid,tmp.timeLag,xtyh.ddid,xtyh.zsxm as qgfzrmc
		from (
		select qggl.qgid,qggl.djh,xtyh.zsxm AS sqrmc,jgxx.jgmc AS sqbmmc,qggl.sqly,qggl.shsj as qgshsj,
		ht.htnbbh,fzr.zsxm as fzrmc,gysxx.gysmc,ht.zt,ht.htid,
		ROUND(CAST ((EXTRACT(EPOCH FROM CAST (NOW() AS TIMESTAMP) - CAST (qggl.shsj AS TIMESTAMP)) / 3600) AS DECIMAL),2) AS timeLag
		from igams_htgl ht
		left join igams_htmx htmx on htmx.htid=ht.htid
		left join igams_qggl qggl on qggl.qgid=htmx.qgid
		LEFT JOIN matridx_xtyh fzr on fzr.yhid=ht.fzr
		LEFT JOIN igams_gysxx gysxx on gysxx.gysid=ht.gys
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_xtyh xtyh ON xtyh.yhid = qggl.sqr
		LEFT JOIN matridx_jgxx jgxx ON jgxx.jgid = qggl.sqbm
		<if test="sftx != null and sftx != ''">
			LEFT JOIN igams_dbxx dbxx on dbxx.id=ht.htid and dbxx.autoid=qggl.qgid
		</if>
		where ht.htid not in (
		select ht.htid
		from igams_htgl ht
		left join matridx_shxx shxx on shxx.ywid=ht.htid
		left join matridx_spgw spgw on spgw.gwid=shxx.gwid
		where spgw.gwmc=#{shxx_gwmc} and ht.scbj='0' and ht.zt!='80')
		and ht.zt!='80' and ht.scbj='0' and ht.htlx!='3'
		and jcsj.csdm != 'ADMINISTRATION' AND qggl.scbj = '0' AND qggl.zt = '80' AND htmx.scbj='0' AND qggl.shsj is not null
		<if test="sftx != null and sftx != ''">
			and dbxx.id is null
		</if>
		group by qggl.qgid,qggl.djh,xtyh.zsxm,jgxx.jgmc,qggl.sqly,qggl.shsj,
		ht.htnbbh,fzr.zsxm,gysxx.gysmc,ht.zt,ht.htid
		union ALL
		select qggl.qgid,qggl.djh,xtyh.zsxm AS sqrmc,jgxx.jgmc AS sqbmmc,qggl.sqly,qggl.shsj as qgshsj,
		'' as htnbbh,'' as fzrmc,'' as gysmc,'' as zt,'' as htid,
		ROUND(CAST ((EXTRACT(EPOCH FROM CAST (NOW() AS TIMESTAMP) - CAST (qggl.shsj AS TIMESTAMP)) / 3600) AS DECIMAL),2) AS timeLag
		from igams_qggl qggl
		left join igams_qgmx qgmx on qgmx.qgid=qggl.qgid
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_xtyh xtyh ON xtyh.yhid = qggl.sqr
		LEFT JOIN matridx_jgxx jgxx ON jgxx.jgid = qggl.sqbm
		<if test="sftx != null and sftx != ''">
			LEFT JOIN igams_dbxx dbxx on dbxx.id='1' and dbxx.autoid=qggl.qgid
		</if>
		where qggl.scbj='0' and qggl.zt='80' and qgmx.zt='80' and qgmx.sysl!=0 and qgmx.sysl is not null and jcsj.csdm != 'ADMINISTRATION' AND qgmx.scbj='0' AND qggl.shsj is not null
		<if test="sftx != null and sftx != ''">
			and dbxx.id is null
		</if>
		group by qggl.qgid,qggl.djh,xtyh.zsxm,jgxx.jgmc,qggl.sqly,qggl.shsj
		)tmp
		left join matridx_shxx shxx on shxx.ywid=tmp.qgid
		left join matridx_spgw spgw on spgw.gwid=shxx.gwid
		left join matridx_xtyh xtyh on xtyh.yhid=shxx.lrry
		where spgw.gwmc=#{postCg} and shxx.sftg='1' and shxx.lrry is not null and shxx.lrry!=''
		group by tmp.qgid,tmp.djh,tmp.sqrmc,tmp.sqbmmc,tmp.sqly,tmp.qgshsj,
		tmp.htnbbh,tmp.fzrmc,tmp.gysmc,tmp.zt,tmp.htid,tmp.timeLag,xtyh.ddid,xtyh.zsxm
	</select>
	<select id="getPagedOverTimeList" parameterType="HtglDto" resultType="HtglDto">
		select tmp.djh,tmp.sqrq,tmp.sqrmc,tmp.sqbmmc,tmp.qgfzrmc,tmp.qgzt,tmp.htnbbh,tmp.gys,tmp.htlx,tmp.gysmc,
		tmp.fzrmc,tmp.cjrq,tmp.zt,tmp.qglx,tmp.qglbdm,COALESCE(tmp.qgid,'') as qgid,tmp.htid ,tmp.cszt,tmp.shys,tmp.csbz
		from (
		select qggl.djh,qggl.sqrq,xtyh.zsxm as sqrmc,jgxx.jgmc as sqbmmc,qgfzr.zsxm as qgfzrmc,qggl.zt as qgzt,htgl.htnbbh,htgl.gys,htgl.htlx,
		gysxx.gysmc,htfzr.zsxm as fzrmc,to_char(htgl.cjrq,'YYYY-MM-dd') as cjrq,htgl.zt,qggl.qglx,jcsj.csdm qglbdm,qggl.qgid,htgl.htid,shys.csbz
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				,case when (shys.cszt is null or shys.cszt='1') then '1' else '0' end as cszt,shys.shys::json#>>'{hour,0}' as shys
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				,case when (shys.cszt is null or shys.cszt='1') then '1' else '0' end as cszt,shys.shys::json#>>'{hour,1}' as shys
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				,case when (shys.cszt is null or shys.cszt='1') then '1' else '0' end as cszt,shys.shys::json#>>'{day,0}' as shys
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				,case when (shys.cszt is null or shys.cszt='1') then '1' else '0' end as cszt,shys.shys::json#>>'{day,1}' as shys
			</if>
		</if>
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		left join igams_qggl qggl on qggl.qgid=shys.autoid
		left join igams_gysxx gysxx on gysxx.gysid=htgl.gys
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid=qggl.qglb
		left join matridx_xtyh xtyh ON xtyh.yhid=qggl.sqr
		left join matridx_jgxx jgxx ON jgxx.jgid=qggl.sqbm
		left join matridx_xtyh htfzr on htfzr.yhid=htgl.fzr
		LEFT JOIN matridx_shxx shxx ON shxx.ywid=qggl.qgid
		LEFT JOIN matridx_spgw spgw ON spgw.gwid=shxx.gwid
		LEFT JOIN matridx_xtyh qgfzr ON qgfzr.yhid=shxx.lrry
		where htgl.scbj='0' and (spgw.gwmc=#{postCg} or spgw.gwmc is null)
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{hour,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{hour,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{day,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{day,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		<if test="djh != null and djh != ''">
			and qggl.djh ILIKE '%'||#{djh}||'%'
		</if>
		<if test="sqrmc != null and sqrmc  != ''">
			and xtyh.zsxm ILIKE '%'||#{sqrmc}||'%'
		</if>
		<if test="sqbmmc != null and sqbmmc != ''">
			and jgxx.jgmc ILIKE '%'||#{sqbmmc}||'%'
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="qgfzrmc != null and qgfzrmc != ''">
			and qgfzr.zsxm ILIKE '%'||#{qgfzrmc}||'%'
		</if>
		<if test="fzrmc != null and fzrmc != ''">
			and htfzr.zsxm ILIKE '%'||#{fzrmc}||'%'
		</if>
		<if test="gysmc != null and gysmc != ''">
			and gysxx.gysmc ILIKE '%'||#{gysmc}||'%'
		</if>
		<if test="entire != null and entire != ''">
			and (
			qggl.djh ILIKE '%'||#{entire}||'%'
			or xtyh.zsxm ILIKE '%'||#{entire}||'%'
			or jgxx.jgmc ILIKE '%'||#{entire}||'%'
			or htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or qgfzr.zsxm ILIKE '%'||#{entire}||'%'
			or htfzr.zsxm ILIKE '%'||#{entire}||'%'
			or gysxx.gysmc ILIKE '%'||#{entire}||'%'
			)
		</if>
		<if test="shsjstart != null and shsjstart != ''">
			and to_char(htgl.cjrq,'YYYY-MM-dd') &gt;= #{shsjstart}
		</if>
		<if test="shsjend != null and shsjend != ''">
			and to_char(htgl.cjrq,'YYYY-MM-dd') &lt;= #{shsjend}
		</if>
		<if test="cszt != null and cszt == '1'.toString()">
			and (shys.cszt=#{cszt} or shys.cszt is null)
		</if>
		<if test="cszt != null and cszt == '0'.toString()">
			and shys.cszt=#{cszt}
		</if>
		)tmp
		group by tmp.djh,tmp.sqrq,tmp.sqrmc,tmp.sqbmmc,tmp.qgfzrmc,tmp.qgzt,tmp.htnbbh,tmp.gys,tmp.htlx,tmp.gysmc,tmp.fzrmc,tmp.cjrq,tmp.zt,tmp.qglx,tmp.qglbdm,tmp.qgid,tmp.htid ,tmp.cszt,tmp.shys,tmp.csbz
	</select>
	<select id="getOverTimeTableMap" resultType="Map" parameterType="HtglDto">
		select tmp.cszt,count(tmp.cszt) as count
		from (
		select
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				case when shys.cszt is not null and shys.cszt='0' then '处理正常'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)>cast(#{overTime} as decimal) and (shys.cszt is null or shys.cszt='1') then '超时'
				when cast(#{overTime} as decimal)>=cast(shys.shys::json#>>'{hour,0}' as decimal) then '正常' end as cszt
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				case when shys.cszt is not null and shys.cszt='0' then '处理正常'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)>cast(#{overTime} as decimal) and (shys.cszt is null or shys.cszt='1') then '超时'
				when cast(#{overTime} as decimal)>=cast(shys.shys::json#>>'{hour,1}' as decimal) then '正常' end as cszt
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				case when shys.cszt is not null and shys.cszt='0' then '处理正常'
				when cast(shys.shys::json#>>'{day,0}' as decimal)>cast(#{overTime} as decimal) and (shys.cszt is null or shys.cszt='1') then '超时'
				when cast(#{overTime} as decimal)>=cast(shys.shys::json#>>'{day,0}' as decimal) then '正常' end as cszt
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				case when shys.cszt is not null and shys.cszt='0' then '处理正常'
				when cast(shys.shys::json#>>'{day,1}' as decimal)>cast(#{overTime} as decimal) and (shys.cszt is null or shys.cszt='1') then '超时'
				when cast(#{overTime} as decimal)>=cast(shys.shys::json#>>'{day,1}' as decimal) then '正常' end as cszt
			</if>
		</if>
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0'
		and to_char(htgl.cjrq,'YYYY-MM-dd') &gt;= #{shsjstart}
		and to_char(htgl.cjrq,'YYYY-MM-dd') &lt;= #{shsjend}
		)tmp
		group by tmp.cszt
	</select>
	<select id="getTimeliness" resultType="String" parameterType="HtglDto">
		select ROUND(cast(sum(cast(tmp.shys as decimal)) as decimal)/cast(count(tmp.shys) as decimal),2) as timeliness
		from (
		select
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				shys.shys::json#>>'{hour,0}' as shys
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				shys.shys::json#>>'{hour,1}' as shys
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				shys.shys::json#>>'{day,0}' as shys
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				shys.shys::json#>>'{day,1}' as shys
			</if>
		</if>
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0'
		and to_char(htgl.cjrq,'YYYY-MM-dd') &gt;= #{shsjstart}
		and to_char(htgl.cjrq,'YYYY-MM-dd') &lt;= #{shsjend}
		)tmp
	</select>
	<select id="getMonthTj" resultType="HtglDto" parameterType="HtglDto">
		select COALESCE(count(htgl.htid),0) as count,to_char(htgl.cjrq,'MM') cjrq
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0'
		and (shys.cszt is null or shys.cszt='1') and to_char(htgl.cjrq, 'yyyy' )=#{cjrq}
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{hour,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{hour,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{day,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{day,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		group by to_char(htgl.cjrq,'MM')
		order by to_char(htgl.cjrq,'MM') asc
	</select>
	<select id="getTimeTj" resultType="HtglDto" parameterType="HtglDto">
		select tmp.cjrq,COALESCE(count(tmp.cjrq),0) as count
		from (
		select
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				case when 1>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时小于1小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=1 and 2>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时1-2小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=2 and 3>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时2-3小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=3 and 4>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时3-4小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=4 and 5>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时4-5小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=5 and 6>cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal) then '超时5-6小时'
				when cast(shys.shys::json#>>'{hour,0}' as decimal)-cast(#{overTime} as decimal)>=6 then '超时大于6小时' end as cjrq
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				case when 1>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时小于1小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=1 and 2>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时1-2小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=2 and 3>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时2-3小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=3 and 4>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时3-4小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=4 and 5>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时4-5小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=5 and 6>cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal) then '超时5-6小时'
				when cast(shys.shys::json#>>'{hour,1}' as decimal)-cast(#{overTime} as decimal)>=6 then '超时大于6小时' end as cjrq
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				case when 1>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时小于1天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=1 and 2>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时1-2天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=2 and 3>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时2-3天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=3 and 4>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时3-4天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=4 and 5>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时4-5天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=5 and 6>cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal) then '超时5-6天'
				when cast(shys.shys::json#>>'{day,0}' as decimal)-cast(#{overTime} as decimal)>=6 then '超时大于6天' end as cjrq
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				case when 1>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时小于1天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=1 and 2>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时1-2天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=2 and 3>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时2-3天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=3 and 4>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时3-4天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=4 and 5>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时4-5天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=5 and 6>cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal) then '超时5-6天'
				when cast(shys.shys::json#>>'{day,1}' as decimal)-cast(#{overTime} as decimal)>=6 then '超时大于6天' end as cjrq
			</if>
		</if>
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0' and (shys.cszt is null or shys.cszt='1')
		and to_char(htgl.cjrq,'YYYY-MM-dd') &gt;= #{shsjstart}
		and to_char(htgl.cjrq,'YYYY-MM-dd') &lt;= #{shsjend}
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{hour,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{hour,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{day,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{day,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		)tmp
		group by tmp.cjrq
	</select>
	<select id="getPercentageTj" resultType="HtglDto" parameterType="HtglDto">
		select ROUND(sum(cast(tmpAll.cssl as decimal))/sum(cast(tmpAll.zsl as decimal))*100,2) as count,tmpAll.cjrq
		from (
		select COALESCE(count(tmp.id),0) as cssl,'0' as zsl,tmp.cjrq
		from (
		select shys.id||shys.autoid as id,to_char(htgl.cjrq,'MM') cjrq
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0' and (shys.cszt is null or shys.cszt='1') and to_char(htgl.cjrq, 'yyyy' )=#{cjrq}
		<if test="unit != null and unit != '' and unit=='hour'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{hour,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{hour,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		<if test="unit != null and unit != '' and unit=='day'.toString()">
			<if test="rule != null and rule != '' and rule=='0'.toString()">
				and cast(shys.shys::json#>>'{day,0}' as decimal)>cast(#{overTime} as decimal)
			</if>
			<if test="rule != null and rule != '' and rule=='1'.toString()">
				and cast(shys.shys::json#>>'{day,1}' as decimal)>cast(#{overTime} as decimal)
			</if>
		</if>
		)tmp
		group by tmp.cjrq
		union all
		select '0' as cssl,COALESCE(count(tmp2.id),0) as zsl,tmp2.cjrq
		from (
		select  shys.id||shys.autoid as id, to_char(htgl.cjrq,'MM') cjrq
		from igams_shys shys
		left join igams_htgl htgl on htgl.htid=shys.id
		where htgl.scbj='0' and to_char(htgl.cjrq, 'yyyy' )=#{cjrq}
		)tmp2
		group by tmp2.cjrq
		)tmpAll
		group by tmpAll.cjrq
		order by tmpAll.cjrq asc
	</select>
	<select id="getGrOverTimeTableMap" resultType="HtglDto" parameterType="HtglDto">
		select tmp.shsj as postEnd,to_char(sh.shsj, 'yyyy-MM-dd HH24:MI:SS') as postStart,
		ROUND(CAST ((EXTRACT(EPOCH FROM CAST (tmp.shsj AS TIMESTAMP) - CAST (sh.shsj AS TIMESTAMP)) / 3600) AS DECIMAL),2) AS timeLag
		from (
			select cast(shxx.xh as decimal)-1 as xh,shxx.ywid,to_char(shxx.shsj, 'yyyy-MM-dd HH24:MI:SS') as shsj,shxx.gcid
			from matridx_shxx shxx
			left join matridx_xtsh xtsh on xtsh.shid=shxx.shid
			left join matridx_xtyh xtyh on xtyh.yhid=shxx.lrry
			where cast(shxx.xh as decimal)!=1 and xtsh.shlb=#{auditType}
			and to_char(shxx.shsj, 'yyyy' )=#{shsjstart}
			<if test="yhm != null and yhm != ''">
				and xtyh.yhm ILIKE '%'||#{yhm}||'%'
			</if>
			<if test="zsxm != null and zsxm != ''">
				and xtyh.zsxm ILIKE '%'||#{zsxm}||'%'
			</if>
		)tmp
		left join matridx_shxx sh on sh.ywid=tmp.ywid and sh.xh=tmp.xh and tmp.gcid=sh.gcid

	</select>
</mapper>
