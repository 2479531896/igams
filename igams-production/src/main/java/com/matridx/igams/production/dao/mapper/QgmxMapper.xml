<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.production.dao.post.IQgmxDao" >
	<sql id="SEARCH_TERMS">
		qgmx.scbj!='1'
			<if test="entire != null and entire != ''">
				and (
				 wlgl.wlmc ILIKE '%'||#{entire}||'%'
				or jc_wllb.csmc ILIKE '%'||#{entire}||'%'
				or jc_wlzlb.csmc ILIKE '%'||#{entire}||'%'
				or jg_sqbm.jgmc ILIKE '%'||#{entire}||'%'
				or qggl.djh ILIKE '%'||#{entire}||'%'
				or wlgl.wlbm ILIKE '%'||#{entire}||'%'
				)
			</if>
			<if test="sqbmmc != null and sqbmmc != ''">
				and jg_sqbm.jgmc ILIKE '%'||#{sqbmmc}||'%'
			</if>
			<if test="djh != null and djh != ''">
				and qggl.djh ILIKE '%'||#{djh}||'%'
			</if>
			<if test="wlbm != null and wlbm != ''">
				and wlgl.wlbm ILIKE '%'||#{wlbm}||'%'
			</if>
			<if test="qgid != null and qgid != ''">
				and qgmx.qgid=#{qgid}
			</if>
			<if test="zt != null and zt != ''">
				and qgmx.zt=#{zt}
			</if>
			<if test="wlbm != null and wlbm != ''">
				and wlgl.wlbm like '%'||#{wlbm}||'%'
			</if>
			<if test="wlmc != null and wlmc != ''">
				and wlgl.wlmc like '%'||#{wlmc}||'%'
			</if>
			<if test="wllbmc != null and wllbmc != ''">
				and jc_wllb.csmc like '%'||#{wllbmc}||'%'
			</if>
			<if test="wlzlbmc != null and wlzlbmc != ''">
				and jc_wlzlb.csmc like '%'||#{wlzlbmc}||'%'
			</if>
			<if test = "wlzlbtcs != null and wlzlbtcs.length > 0 "  >
				and wlgl.wlzlbtc in 
				<foreach collection="wlzlbtcs" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test="qxqg != null and qxqg !=''">
				and qgmx.qxqg=#{qxqg}
			</if>
			<if test="zt != null and zt !=''">
				and qgmx.zt=#{zt}
			</if>
	</sql>
	
	<sql id="SEARCH_TMPS">
			tmp.scbj!='1' and qgmx.scbj!='1'
			<if test="entire != null and entire != ''">
				and (
				 tmp.wlmc ILIKE '%'||#{entire}||'%'
				or tmp.djh ILIKE '%'||#{entire}||'%'
				or tmp.wlbm ILIKE '%'||#{entire}||'%'
				or tmp.hwrkdh ILIKE '%'||#{entire}||'%'
				or tmp.htnbbh ILIKE '%'||#{entire}||'%'
				)
			</if>
			<if test="djh != null and djh != ''">
				and tmp.djh ILIKE '%'||#{djh}||'%'
			</if>
			<if test="hwrkdh != null and hwrkdh != ''">
				and tmp.hwrkdh ILIKE '%'||#{hwrkdh}||'%'
			</if>
			<if test="htnbbh != null and htnbbh != ''">
				and tmp.htnbbh ILIKE '%'||#{htnbbh}||'%'
			</if>
			<if test="wlbm != null and wlbm != ''">
				and tmp.wlbm ILIKE '%'||#{wlbm}||'%'
			</if>
			<if test="wlmc != null and wlmc != ''">
				and tmp.wlmc ILIKE '%'||#{wlmc}||'%'
			</if>
			<if test=' htbj != null and htbj == "0" '>
				and tmp.htnbbh is null or trim(tmp.htnbbh)=''
			</if>
			<if test=' hwbj != null and hwbj == "0" '>
				and tmp.hwrkdh is null or trim(tmp.hwrkdh)=''
			</if>
			<if test=' htbj != null and htbj == "1" '>
				and trim(tmp.htnbbh)!=''
			</if>
			<if test=' hwbj != null and hwbj == "1" '>
				and trim(tmp.hwrkdh)!=''
			</if>
			<if test = "qxqgs != null and qxqgs.length > 0 "  >
				and qgmx.qxqg in 
			<foreach collection="qxqgs" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
			</if>
			<if test="sqsjstart != null and sqsjstart != ''">
				and to_char(tmp.sqrq,'yyyy-mm-dd') &gt;= #{sqsjstart}
			</if>
			<if test="sqsjend != null and sqsjend != ''">
				and to_char(tmp.sqrq,'yyyy-mm-dd') &lt;= #{sqsjend}
			</if>
			
			<if test="qwdhsjstart != null and qwdhsjstart != ''">
				and to_char(tmp.qwrq,'yyyy-mm-dd') &gt;= #{qwdhsjstart}
			</if>
			<if test="qwdhsjend != null and qwdhsjend != ''">
				and to_char(tmp.qwrq,'yyyy-mm-dd') &lt;= #{qwdhsjend}
			</if>
			
			<if test="jhdhsjstart != null and jhdhsjstart != ''">
				and to_char(tmp.jhdhrq,'yyyy-mm-dd') &gt;= #{jhdhsjstart}
			</if>
			<if test="jhdhsjend != null and jhdhsjend != ''">
				and to_char(tmp.jhdhrq,'yyyy-mm-dd') &lt;= #{jhdhsjend}
			</if>
			
			<if test="dhsjstart != null and dhsjstart != ''">
				and to_char(dhxx.dhrq,'yyyy-mm-dd') &gt;= #{dhsjstart}
			</if>
			<if test="dhsjend != null and dhsjend != ''">
				and to_char(dhxx.dhrq,'yyyy-mm-dd') &lt;= #{dhsjend}
			</if>
			<if test = "qgshzts != null and qgshzts.length > 0 "  >
				and tmp.qgshzt in 
			<foreach collection="qgshzts" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
			</if>
	</sql>
	
	<insert id="insert" parameterType="QgmxDto">
		insert into igams_qgmx(qgmxid,qgid,xh,wlid,sl,yssl,qxqg
			<if test="sysl != null and sysl!=''">
				,sysl
			</if>
			<if test="jg != null and jg != ''">
				,jg
			</if>
			<if test="qwrq != null and qwrq != ''">
				,qwrq
			</if>
			<if test="bz != null and bz != ''">
				,bz
			</if>
			<if test="hwmc != null and hwmc != ''">
				,hwmc
			</if>
			<if test="hwjldw != null and hwjldw != ''">
				,hwjldw
			</if>
			<if test="hwbz != null and hwbz != ''">
				,hwbz
			</if>
			<if test="cpzch != null and cpzch != ''">
				,cpzch
			</if>
		,zt,lrry,lrsj,scbj)
		values(#{qgmxid},#{qgid}
			<if test="xh != null and xh != ''">
				,cast(#{xh} as numeric)
			</if>
			<if test="xh == null or xh == ''">
				,(select (select coalesce(max(xh),0)+1 from igams_qgmx where qgid=#{qgid}))
			</if>
				,#{wlid},cast(#{sl} as numeric),cast(#{yssl} as numeric),'0'
			<if test="sysl != null and sysl!=''">
				,cast(#{sysl} as numeric)
			</if>
			<if test="jg != null and jg != ''">
				,cast(#{jg} as numeric)
			</if>
			<if test="qwrq != null and qwrq != ''">
				,cast(#{qwrq} as date)
			</if>
			<if test="bz != null and bz != ''">
				,#{bz}
			</if>
			<if test="hwmc != null and hwmc != ''">
				,#{hwmc}
			</if>
			<if test="hwjldw != null and hwjldw != ''">
				,#{hwjldw}
			</if>
			<if test="hwbz != null and hwbz != ''">
				,#{hwbz}
			</if>
			<if test="cpzch != null and cpzch != ''">
				,#{cpzch}
			</if>
			,#{zt},#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	
	<insert id="insertQgmx" parameterType="List">
		insert into igams_qgmx(qgmxid,qgid,xh,wlid,sl,sysl,yssl,jg,sfrk,qwrq,bz,qxqg,zt,lrry,lrsj,scbj,hwmc,hwjldw,hwbz,hwyt,yq,gys,wbyq,pzyq,sjjl,cpzch,xqjhmxid)
		values
		<foreach collection="list" separator="," open="" close="" item="item" index="index">
			(#{item.qgmxid},#{item.qgid},(select (select coalesce(max(xh),0)+1+#{index} from igams_qgmx where qgid=#{item.qgid})),#{item.wlid}
			<if test="item.sl != null and item.sl != ''">
				,cast(#{item.sl} as numeric)
			</if>
			<if test="item.sl == null or item.sl == ''">
				,null
			</if>
			<if test="item.sysl != null and item.sysl != ''">
				,cast(#{item.sysl} as numeric)
			</if>
			<if test="item.sysl == null or item.sysl == ''">
				,null
			</if>
			<if test="item.yssl != null and item.yssl != ''">
				,cast(#{item.yssl} as numeric)
			</if>
			<if test="item.yssl == null or item.yssl == ''">
				,null
			</if>
			<if test="item.jg != null and item.jg != ''">
				,cast(#{item.jg} as numeric)
			</if>
			<if test="item.jg == null or item.jg == ''">
				,null
			</if>
			<if test="item.sfrk != null and item.sfrk != ''">
				,#{item.sfrk}
			</if>
			<if test="item.sfrk == null or item.sfrk == ''">
				,null
			</if>
			<if test="item.qwrq != null and item.qwrq != ''">
				,cast(#{item.qwrq} as date)
			</if>
			<if test="item.qwrq == null or item.qwrq == ''">
				,null
			</if>
				,#{item.bz}
				,'0'
			,#{item.zt},#{item.lrry},LOCALTIMESTAMP,'0',#{item.hwmc},#{item.hwjldw},#{item.hwbz}
			,#{item.hwyt},#{item.yq},#{item.gys},#{item.wbyq},#{item.pzyq},#{item.sjjl},#{item.cpzch},#{item.xqjhmxid})
		</foreach>
	</insert>
	
	<select id="getPagedDtoList" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,
		qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw,wlgl.ychh,qgmx.lrsj,qggl.djh as djh,jg_sqbm.jgmc as sqbmmc,qgmx.sysl,qgmx.ydsl,qgmx.yt,
		qgmx.sjjl,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.yq,qgmx.hwyt,qgmx.gys,qgmx.pzyq,qgmx.wbyq,jc_zlyq.csmc zlyqmc,qgmx.sjjl,qgmx.rksl
		,case when wlgl.wlmc is not null and wlgl.wlmc!='' then wlgl.wlmc else qgmx.hwmc end wlmc_t,case when  wlgl.gg is not null and wlgl.gg!='' then wlgl.gg else qgmx.hwbz end gg_t,
		case when wlgl.jldw is not null and wlgl.jldw!='' then wlgl.jldw else qgmx.hwjldw end jldw_t,qgmx.cpzch,gysxx.gysmc gysmc
  			from igams_qgmx qgmx
	  		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
	  		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
	  		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
	  		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
	  		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
	  		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = qggl.sqbm
	  		left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
	  		left join igams_gysxx gysxx on gysxx.gysid=qgmx.gys
	  		left join matridx_jcsj qglx on qglx.csid=qggl.qglx
		<where>
			<include refid="SEARCH_TERMS"></include>
	  	</where>
	</select>
	<select id="getPagedDetails" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,
		qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw,wlgl.ychh,qgmx.lrsj,qggl.djh as djh,jg_sqbm.jgmc as sqbmmc,qgmx.sysl,qgmx.ydsl,qgmx.yt,
		qgmx.sjjl,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.yq,qgmx.hwyt,qgmx.gys
		,case when wlgl.wlmc is not null and wlgl.wlmc!='' then wlgl.wlmc else qgmx.hwmc end wlmc_t,case when  wlgl.gg is not null and wlgl.gg!='' then wlgl.gg else qgmx.hwbz end gg_t,
		case when wlgl.jldw is not null and wlgl.jldw!='' then wlgl.jldw else qgmx.hwjldw end jldw_t,gysxx.gysmc gysmc
		from igams_qgmx qgmx
		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = qggl.sqbm
		left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
		left join igams_gysxx gysxx on gysxx.gysid=qgmx.gys
		left join matridx_jcsj qglx on qglx.csid=qggl.qglx
		<where>
			qgmx.scbj!='1'
			<if test="sbmc != null and sbmc != ''">
				and (case when wlgl.wlmc is not null and wlgl.wlmc!='' then wlgl.wlmc else qgmx.hwmc end) like '%'||#{sbmc}||'%'
			</if>
			<if test="gdzcflag!=null and gdzcflag!='' and gdzcflag=='1'.toString()">
				and qglx.csdm!='SERVICE'
			</if>
			<if test="djh != null and djh != ''">
				and qggl.djh ILIKE '%'||#{djh}||'%'
			</if>
			<if test = "qglbs != null and qglbs.length > 0 "  >
				and qggl.qglb in
				<foreach collection="qglbs" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!-- 请购明细列表(不分页) -->
	<select id="getQgmxList" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,wlgl.ychh,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,jc_wlzlb.cskz1,jc_wlzlb.cskz2,
		qgmx.glid,wlgl.scs,qgmx.ydsl,qgmx.yssl,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.yq,qgmx.hwyt,qgmx.gys,qgmx.wbyq,qgmx.pzyq
		,jc_zlyq.csmc zlyqmc,qgmx.sjjl,jc_qglb.csdm qglbdm,	qgmx.sfrk,qgmx.hwmc,qgmx.hwgg,ROUND((COALESCE(qgmx.sl,0)-COALESCE(qgmx.rksl,0)), 2) krksl,qggl.djh,COALESCE(qgmx.rksl,0) yrksl,
		wlgl.ychh,case when wlgl.wlmc is not null and wlgl.wlmc!='' then wlgl.wlmc else qgmx.hwmc end wlmc,case when  wlgl.gg is not null and wlgl.gg!='' then wlgl.gg else qgmx.hwbz end gg,
		case when wlgl.jldw is not null and wlgl.jldw!='' then wlgl.jldw else qgmx.hwjldw end jldw,qgmx.cpzch,coalesce(tmp.kcl,0) wlkcl
		<if test="requestName ==null or requestName != 'copy'.toString()">
		,case when fj.zywid is null then 1 else 0 end as fjbj
		</if>
		<if test="lllb !=null and lllb == '1'.toString()">
			,(ckhwxx.kcl-COALESCE(ckhwxx.yds,0)) as klsl,ckhwxx.kcl
		</if>

  			from igams_qgmx qgmx  
	  		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
			left outer join ( SELECT wlid, SUM ( kcl ) kcl FROM
			igams_hwxx hwxx
			LEFT JOIN igams_dhxx dhxx on dhxx.dhid = hwxx.dhid
			LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = dhxx.rklb
			WHERE hwxx.scbj = '0'  AND hwxx.zt = '99' AND hwxx.kcl != 0 AND jcsj.csdm!='cghz'
			GROUP BY
			hwxx.wlid
			) tmp ON tmp.wlid = wlgl.wlid
	  		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
	  		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
			<if test="lllb !=null and lllb == '1'.toString()">
				left join igams_ckhwxx ckhwxx on wlgl.wlid = ckhwxx.wlid
			</if>
	  		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
	  		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
	  		left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
	  		left join matridx_jcsj jc_qglb on jc_qglb.csid=qggl.qglb
	  		<if test="requestName ==null or requestName != 'copy'.toString()">
	  		left join 
				(select zywid from matridx_fjcfb 
					where scbj='0'
					group by zywid) fj on fj.zywid=qgmx.qgmxid
			</if>
		<where>
			qgmx.scbj != '1'
			<if test="qgid != null and qgid != ''">
				and qgmx.qgid = #{qgid}
			</if>
			<if test="zt != null and zt != ''">
				and qgmx.zt=#{zt}
			</if>
			<if test="ids !=null and ids.size > 0">
				and qgmx.qgid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="wlbm != null and wlbm != ''">
				and wlgl.wlbm like '%'||#{wlbm}||'%'
			</if>
			<if test="wlmc != null and wlmc != ''">
				and wlgl.wlmc like '%'||#{wlmc}||'%'
			</if>
			<if test="wllbmc != null and wllbmc != ''">
				and jc_wllb.csmc like '%'||#{wllbmc}||'%'
			</if>
			<if test="wlzlbmc != null and wlzlbmc != ''">
				and jc_wlzlb.csmc like '%'||#{wlzlbmc}||'%'
			</if>
			<if test = "wlzlbtcs != null and wlzlbtcs.length > 0 "  >
				and wlgl.wlzlbtc in 
				<foreach collection="wlzlbtcs" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
			order by qgmx.xh asc
	  	</where>
	</select>
	<update id="updateQxqg" parameterType="String">
		update igams_qgmx set qxqg ='1',zt='30'
		where qgmxid=#{qgmxid}
	</update>
	
	
	<delete id="delete" parameterType="QgmxDto">
		update igams_qgmx set scry = #{scry},scsj = LOCALTIMESTAMP,scbj='1' 
		<where>
			<if test="qgid !=null and qgid != ''">
				or qgid = #{qgid}
			</if>
			<if test="ids !=null and ids.size > 0">
				or qgid in
					<foreach collection="ids" open="(" close=")" separator="," item="item">
						#{item}
					</foreach>
			</if>
		</where>
	</delete>
	
	<update id="updateForList" parameterType="list">
		<if test="list != null and list.size()>0">
			insert into igams_qgmx(qgmxid,qgid,xh,wlid,sl,sysl,jg,qwrq,bz,qxqg,zt,lrry,lrsj,scbj)
			values
			<foreach collection="list" separator="," open="" close="" item="item" index="index">
				(#{item.qgmxid},#{item.qgid},#{index}+1,#{item.wlid},cast(#{item.sl} as numeric),cast(#{item.sysl} as numeric),#{item.jg}
				<if test="item.qwrq != null and item.qwrq != ''">
					,cast(#{item.qwrq} as date)
				</if>
				<if test="item.qwrq == null or item.qwrq == ''">
						,null
				</if>
				,#{item.bz},#{item.qxqg},#{item.zt},#{item.lrry},LOCALTIMESTAMP,'0')
			</foreach>
		</if>
	</update>
	
	<update id="updateQgmx" parameterType="List">
		<foreach collection="list" separator=";" open="" close="" item="item" index="index">
            update igams_qgmx set 
            xgry=#{item.xgry},xgsj=LOCALTIMESTAMP
			<if test="item.sl != null and item.sl != ''">
				,sl=cast(#{item.sl} as numeric)
			</if>
            <if test="item.sysl != null and item.sysl != ''">
            	,sysl=cast(#{item.sysl} as numeric)
            </if>
            <if test="item.xh!=null and item.xh!=''">
            	,xh=cast(#{item.xh} as numeric)
            </if>
			<if test="item.jg!=null and item.jg!=''">
				,jg=cast(#{item.jg} as numeric)
			</if>
			<if test="item.qwrq==null or item.qwrq==''">
				,qwrq=null
			</if>
			<if test="item.qwrq!=null and item.qwrq!=''">
				,qwrq=cast(#{item.qwrq} as date)
			</if>
			<if test="item.bz!=null and item.bz!=''">
				,bz=#{item.bz}
			</if>
			<if test="item.qxqg!=null and item.qxqg!=''">
				,qxqg=#{item.qxqg}
			</if>
			<if test="item.zt!=null and item.zt!=''">
				,zt=#{item.zt}
			</if>
			<if test="item.yssl!=null and item.yssl!=''">
				,yssl=cast(#{item.yssl} as numeric)
			</if>
			<if test="item.dhsl!=null and item.dhsl!=''">
				,dhsl=cast(#{item.dhsl} as numeric)
			</if>
			<if test="item.rksl!=null and item.rksl!=''">
				,rksl=cast(#{item.rksl} as numeric)
			</if>
			<if test="item.hwmc!=null and item.hwmc!=''">
				,hwmc=#{item.hwmc}
			</if>
			<if test="item.hwyt!=null and item.hwyt!=''">
				,hwyt=#{item.hwyt}
			</if>
			<if test="item.hwbz!=null and item.hwbz!=''">
				,hwbz=#{item.hwbz}
			</if>
			<if test="item.gys!=null and item.gys!=''">
				,gys=#{item.gys}
			</if>
			<if test="item.yq!=null and item.yq!=''">
				,yq=#{item.yq}
			</if>
			<if test="item.wbyq!=null and item.wbyq!=''">
				,wbyq=#{item.wbyq}
			</if>
			<if test="item.pzyq!=null and item.pzyq!=''">
				,pzyq=#{item.pzyq}
			</if>
			<if test="item.sjjl!=null and item.sjjl!=''">
				,sjjl=#{item.sjjl}
			</if>
			<if test="item.hwjldw!=null and item.hwjldw!=''">
				,hwjldw=#{item.hwjldw}
			</if>
			<if test="item.sfrk!=null and item.sfrk!=''">
				,sfrk=#{item.sfrk}
			</if>
			<if test="item.xzkcid!=null and item.xzkcid!=''">
				,xzkcid=#{item.xzkcid}
			</if>
			<if test="item.cpzch!=null and item.cpzch!=''">
				,cpzch=#{item.cpzch}
			</if>
			<where>
				qgmxid=#{item.qgmxid}
			</where> 
		</foreach>
	</update>
	<update id="updateCpzch" parameterType="List">
		<foreach collection="list" separator=";" open="" close="" item="item" index="index">
            update igams_qgmx set
            xgry=#{item.xgry},xgsj=LOCALTIMESTAMP
			<if test="item.cpzch!=null and item.cpzch!=''">
				,cpzch=#{item.cpzch}
			</if>
			<where>
				qgmxid=#{item.qgmxid}
			</where>
		</foreach>
	</update>
	
	<update id="updateDto" parameterType="QgmxDto">
		update igams_qgmx set sl=cast(#{sl} as numeric),
			sysl=cast(#{sysl} as numeric)
			<if test="ydsl!=null and ydsl!=''">
			,ydsl=cast(#{ydsl} as numeric)
			</if>
			<if test="jg!=null and jg!=''">
			,jg=cast(#{jg} as numeric)
			</if>
			<if test="qwrq==null or qwrq==''">
			,qwrq=null
			</if>
			<if test="qwrq!=null and qwrq!=''">
			,qwrq=cast(#{qwrq} as date)
			</if>
			<if test="qxqg!=null and qxqg!=''">
			,qxqg=#{qxqg}
			</if>
			<if test="zt!=null and zt!=''">
			,zt=#{zt}
			</if>
			<if test="glid!=null and glid!=''">
			,glid=#{glid}
			</if>
			where qgmxid=#{qgmxid}
	</update>
	
	<select id="getMxfjByWlzlbtc" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,
		qgmx.bz,qgmx.qxqg,qgmx.zt
		from igams_qgmx qgmx
		left join igams_wlgl wl on wl.wlid=qgmx.wlid
		<where>
			qgmx.scbj!='1' and qgmx.zt='80' and qgmx.qxqg='0'
			and qgmx.qgid=#{qgid}
			<if test="wlzlbtcs != null and wlzlbtcs.length>0">
			and wl.wlzlbtc in
				<foreach collection="wlzlbtcs" item="item" index="index" separator="," open="(" close=")">
					#{item}
				</foreach>
			</if>
			<if test="ids != null and ids.size()>0">
			and qgmx.qgmxid in
				<foreach collection="ids" separator="," close=")" open="(" item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	
	<select id="getFileByYwidAndZywid" parameterType="QgmxDto" resultType="QgmxDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid
			from matridx_fjcfb fjcfb
			<where>
				fjcfb.scbj!='1' and ywlx=#{ywlx}
				and ywid=#{qgid} and zywid in
				<foreach collection="ids" separator="," item="item" index="index" open="(" close=")">
					#{item}
				</foreach>
			</where>
	</select>

    <!-- 根据请购明细ID清空关联ID -->
    <update id="clearGlid" parameterType="String">
        update igams_qgmx
        <set>
            glid=null
        </set>
        <where>
            qgmxid=#{qgmxid}
        </where>
    </update>
    
    <!-- 根据请购明细ID获取明细信息 -->
    <select id="getDtoById" parameterType="String" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,
		qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw,wlgl.ychh,qgmx.lrsj,qggl.djh as djh,jg_sqbm.jgmc as sqbmmc,qgmx.sysl,qgmx.ydsl,qgmx.yt,
		qgmx.sjjl,qgmx.dhsl,qgmx.dhrq,qgmx.dhdhgl,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.gys,qgmx.yq,qgmx.hwyt,qgmx.wbyq,qgmx.pzyq,jc_zlyq.csmc zlyqmc,qgmx.sjjl,
		qglb.csdm qglbdm,wlgl.bz as wlbz,sqr.zsxm sqr,qgmx.rksl,case when wlgl.wlmc is not null and wlgl.wlmc!='' then wlgl.wlmc else qgmx.hwmc end wlmc_t,
		case when  wlgl.gg is not null and wlgl.gg!='' then wlgl.gg else qgmx.hwbz end gg_t,
		case when wlgl.jldw is not null and wlgl.jldw!='' then wlgl.jldw else qgmx.hwjldw end jldw_t,qgmx.cpzch,jc_lb.cskz1 as lbcskz1
		from igams_qgmx qgmx
		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = qggl.sqbm
		left join matridx_jcsj qglb on qglb.csid=qggl.qglb and qglb.scbj='0'
		left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
		left join matridx_xtyh sqr on sqr.yhid=qggl.sqr
		left join matridx_jcsj jc_lb on jc_lb.csid = wlgl.lb
    	<where>
    		qgmx.scbj!='1'
    		and qgmx.qgmxid=#{qgmxid}
    	</where>
    </select>
    
    <!-- 根据请购明细ID更新取消请购信息 -->
    <update id="updateQxqgxx" parameterType="QgmxDto">
    	update igams_qgmx set 
    	xgry = #{xgry},xgsj = LOCALTIMESTAMP,qxqg='0'
   		<if test="sl!=null and sl!=''">
		  ,sl=cast(#{sl} as numeric)
		</if>
		<if test="sysl!=null and sysl!=''">
		  ,sysl=cast(#{sysl} as numeric)
		</if>
		<if test="dhsl!=null and dhsl!=''">
			,dhsl=cast(#{dhsl} as numeric)
		</if>
    	<where>
    		scbj!='1'
    		and qgmxid=#{qgmxid}
    	</where>
    </update>
    
        <!-- 根据请购明细ID更新拒绝审批信息 -->
    <update id="updateJjspxx" parameterType="QgmxDto">
    	update igams_qgmx
    	<set>
    		jjspry=#{jjspry}
    		<if test="jjspsj != null and jjspsj != ''">
    		,jjspsj=cast(#{jjspsj} as timestamp)
    		</if>
    		<if test="jjspsj == null or jjspsj == ''">
    		,jjspsj=null
    		</if>
    	</set>
    	<where>
    		scbj!='1'
    		and qgmxid=#{qgmxid}
    	</where>
    </update>
    <select id="getDtoList" parameterType="QgmxDto" resultType="QgmxDto">
	    select qgmx.qgmxid,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.jg,qgmx.qwrq,qgmx.bz,qgmx.qxqg,qgmx.zt,qgmx.lrry,qgmx.lrsj,qgmx.scbj,qgmx.glid,qgmx.hwmc,qgmx.sl,qgmx.hwgg,qgmx.hwjldw,qgmx.hwbz,qgmx.cpzch
	    	from igams_qgmx qgmx
	    	<where>
				qgmx.scbj != '1' and qgmx.sfrk = '1' and qgmx.qxqg != '1' and qgmx.zt = '80'
	    		<if test="qgmxid !=null and qgmxid !=''">
	    			and qgmx.qgmxid=#{qgmxid}
	    		</if>
	    		<if test="qgid !=null and qgid !=''">
	    			and qgmx.qgid=#{qgid}
	    		</if>
	    		<if test="qgids !=null and qgids.size >0">
	    			and qgmx.qgid in
	    			<foreach collection="qgids" open="(" close=")" separator="," item="item">
						#{item}
					</foreach>
	    		</if>
	    		<if test="ids !=null and ids.size >0">
	    			and qgmx.qgmxid in
	    			<foreach collection="ids" open="(" close=")" separator="," item="item">
						#{item}
					</foreach>
	    		</if>
	    	</where>
    </select>
	<!-- 根据请购ID查询未填写统称物料 -->
    <select id="selectByQgid" parameterType="String" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw
  			from igams_qgmx qgmx  
	  		left join igams_wlgl wlgl on wlgl.wlid = qgmx.wlid
	  		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid = wlgl.wlzlb
		<where>
			qgmx.scbj != '1' and jc_wlzlb.cskz2 = '1' and (wlgl.wlzlbtc is null or wlgl.wlzlbtc = '')
			and qgmx.qgid = #{qgid}
	  	</where>
	</select>
	<select id="getListByQgmxids" parameterType="QgmxDto" resultType="HtmxDto">
	    select qgmx.qgmxid,qgmx.qgid,qgmx.wlid,qgmx.sysl,qgmx.sl qgsl,qgmx.ydsl,qgmx.glid,
	    		qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.hwyt,qgmx.hwyt,COALESCE(qgmx.rksl,0) yrksl,
	    		wlgl.wlmc,wlgl.wlbm,wlgl.gg,wlgl.jldw,qgmx.bz qgbz,
	    		qggl.djh,qggl.sqbm,jg_sqbm.jgmc as sqbmmc,qggl.qglb,qglb.csmc qglbmc,qglb.csdm qglbdm,
	    		xtyh.yhid fzr,xtyh.zsxm fzrmc,(COALESCE(qgmx.sl,0)-COALESCE(qgmx.rksl,0)) krksl,wlgl.scs,
				jc_dl.csid AS xmdl,jc_bm.csid AS xmbm,qgmx.cpzch,zllb.cskz1 lbcskz1
				<if test="htid !=null and htid !=''">
		    		,htmx.sl, htmx.sl presl
		    	</if>
				<if test="lllb !=null and lllb == '1'.toString()">
					,(ckhwxx.kcl-COALESCE(ckhwxx.yds,0)) as klsl,ckhwxx.kcl,ckhwxx.ckhwid,ckhwxx.ckid,ckxx.ckmc
				</if>
	    	from igams_qgmx qgmx
	    	left join igams_wlgl wlgl on wlgl.wlid = qgmx.wlid
	    	left join igams_qggl qggl on qggl.qgid = qgmx.qgid
	    	left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = qggl.sqbm
	    	left join matridx_xtyh xtyh on qggl.sqr = xtyh.yhid
	    	left join matridx_jcsj qglb on qglb.csid=qggl.qglb
			LEFT JOIN matridx_jcsj zllb ON zllb.csid = wlgl.lb
			<if test="lllb !=null and lllb == '1'.toString()">
				left join igams_ckhwxx ckhwxx on wlgl.wlid = ckhwxx.wlid
				left join igams_ckxx ckxx on ckxx.ckid = ckhwxx.ckid
			</if>
			LEFT JOIN matridx_jcsj jc_dl ON jc_dl.csid = qggl.xmdl
			LEFT JOIN matridx_jcsj jc_bm ON jc_bm.csid = qggl.xmbm

			<if test="htid !=null and htid !=''">
	    		left join igams_htmx htmx on htmx.qgmxid = qgmx.qgmxid and htid = #{htid} and htmx.scbj!='1'
	    	</if>
	    	<where>
	    		qgmx.scbj != '1'
	    		<if test="qgid !=null and qgid !=''">
	    			and qgmx.qgid = #{qgid}
	    		</if>
				<if test="(lllb !=null and lllb == '1'.toString()) and (xzbj != null and xzbj != '' and xzbj == '1'.toString()) and (jsid != null and jsid != '') ">
					and ckhwxx.ckid in (select ckjgxx.ckid from matridx_jsdwqx jsdwqx
					left join igams_ckjgxx ckjgxx on ckjgxx.jgid = jsdwqx.jgid
					where jsdwqx.jsid =#{jsid} and ckjgxx.ckid is not null)
				</if>
	    		<if test="ids !=null and ids.size >0">
	    			and qgmx.qgmxid in
	    			<foreach collection="ids" open="(" close=")" separator="," item="item">
						#{item}
					</foreach>
	    		</if>
	    	</where>
    </select>
    <!-- 获取请购明细信息列表 -->
	<select id="getListByQgid" parameterType="String" resultType="QgmxDto">
		select qgmx.qgmxid,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.ydsl,qgmx.jg,qgmx.qwrq,
			qgmx.bz,qgmx.qxqg,qgmx.zt,qgmx.glid,wlgl.wlbm,qgmx.hwmc,qgmx.hwbz, qgmx.yt, qgmx.yq,qgmx.sjjl, qgmx.gys,
			qgmx.hwjldw, qgmx.hwyt, qgmx.wbyq, qgmx.pzyq,wlgl.wlmc,wlgl.gg,wlgl.ychh,wlgl.jldw,qgmx.jhdhrq,wlgl.scs,
			jc_zlyq.csmc zlyqmc,qgmx.wbyq,wlgl.bctj,qgmx.cpzch,jc_lb.cskz1 as lbcskz1
			from igams_qgmx qgmx
			left join igams_wlgl wlgl on wlgl.wlid = qgmx.wlid
			left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
			left join matridx_jcsj jc_lb on jc_lb.csid=wlgl.lb
			<where>
				qgmx.scbj !='1' and qgmx.qgid = #{qgid}
			</where>
	</select>
	
	<!--批量删除请购明细信息-->
	<update  id="deleteQgmxDtos" parameterType="QgmxDto">
		update igams_qgmx set scry = #{scry}, scsj = LOCALTIMESTAMP, scbj = #{scbj}
		<where>
			1=2
			<if test="ids !=null and ids.size > 0">
				or qgmxid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>
	
	
	<!-- 导出 -->
	<select id="getCountForSearchExp" parameterType="QgmxDto"
		resultType="java.lang.Integer">
		select count(qgmx.qgmxid)
		FROM
		igams_qgmx qgmx
		LEFT OUTER JOIN igams_qggl qggl ON qgmx.qgid = qggl.qgid
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = qgmx.qgmxid
		LEFT JOIN igams_htmx htmx on htmx.qgmxid = qgmx.qgmxid and htmx.scbj ='0'
		LEFT JOIN igams_htfkmx htfkmx on htmx.htid = htfkmx.htid and htfkmx.scbj ='0'
		LEFT JOIN igams_htfkqk htfkqk on htfkqk.htfkid = htfkmx.htfkid
		LEFT JOIN matridx_jcsj fkfs on fkfs.csid = htfkqk.fkfs
		LEFT JOIN (
		SELECT MAX
		( to_char( shxx.shsj, 'yyyy-mm-dd hh24:mi:ss' ) ) qgshtgsj,
		qggl.qgid
		FROM
		igams_qggl qggl
		LEFT JOIN matridx_shxx shxx ON shxx.ywid = qggl.qgid
		AND qggl.zt = '80'
		GROUP BY
		qggl.qgid
		) qgsh ON qgsh.qgid = qggl.qgid
		AND qggl.scbj = '0'
		LEFT OUTER JOIN (
		SELECT SUM
		( COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) - COALESCE ( hwxx.zjthsl, 0 ) ) rkzsl,
		SUM ( COALESCE ( hwxx.cythsl, 0 ) + COALESCE ( hwxx.zjthsl, 0 ) ) bhgsl,
		htmxid
		FROM
		igams_hwxx hwxx
		WHERE
		hwxx.scbj != '1'
		GROUP BY
		hwxx.htmxid
		) tmp ON tmp.htmxid = htmx.htmxid
		LEFT OUTER JOIN (
		SELECT
		htmx.htmxid,
		string_agg ( DISTINCT fpgl.fph , ',' ) fph,
		SUM ( fpmx.fpje ) fpzje,
		SUM ( fpmx.fpsl ) fpzsl,
		string_agg ( DISTINCT to_char( fpgl.lrsj, 'yyyy-mm-dd' ), ',' ) fplrsj
		FROM
		igams_htmx htmx
		LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
		AND fpmx.scbj = '0'
		LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
		AND fpgl.scbj = '0'
		AND fpgl.zt = '80'
		WHERE
		htmx.scbj = '0'
		GROUP BY
		htmx.htmxid
		) fp ON fp.htmxid = htmx.htmxid
		LEFT JOIN (
		SELECT
		htmx.htmxid,
		string_agg (
		DISTINCT hwxx.u8rkdh|| '(' || COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) || ')' ,
		','
		) u8rkdh,
		string_agg ( DISTINCT rkgl.rkdh, ',' ) hwrkdh
		FROM
		igams_htmx htmx
		LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
		AND hwxx.scbj = '0'
		LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
		AND dhxx.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj jcsj ON dhxx.rklb = jcsj.csid
		LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
		AND rkgl.scbj = '0'
		WHERE
		htmx.scbj != '1'
		GROUP BY
		htmx.htmxid
		) tab ON tab.htmxid = htmx.htmxid
		LEFT OUTER JOIN igams_htgl htgl ON htgl.htid = htmx.htid
		LEFT JOIN matridx_jcsj htfkfs on htfkfs.csid = htgl.fkfs
		LEFT JOIN igams_gysxx gys ON gys.gysid = htgl.gys
		AND gys.scbj != '1'
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = qgmx.wlid
		AND wlgl.scbj != '1'
		LEFT JOIN matridx_jcsj zllb ON zllb.csid = wlgl.lb
		LEFT JOIN matridx_xtyh qggl_sqr ON qggl.sqr = qggl_sqr.yhid
		AND qggl_sqr.scbj = '0'
		LEFT JOIN matridx_xtyh fzr ON htgl.fzr = fzr.yhid
		AND fzr.scbj = '0'
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		WHERE
		qgmx.scbj != '1'
		<if test="entire != null and entire != ''">
			and (
			wlgl.wlmc ILIKE '%'||#{entire}||'%'
			or qggl.djh ILIKE '%'||#{entire}||'%'
			or wlgl.wlbm ILIKE '%'||#{entire}||'%'
			or htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or tab.hwrkdh ILIKE '%'||#{entire}||'%'
			)
		</if>
		<if test = "wlfls != null and wlfls.length > 0 "  >
			and htmx.wlfl in
			<foreach collection="wlfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="qglx != null and qglx != ''">
			and qggl.qglx=#{qglx}
		</if>
		<if test="ccdg != null and ccdg != ''">
			and htmx.ccdg=#{ccdg}
		</if>
		<if test="wlmc != null and wlmc != ''">
			and wlgl.wlmc ILIKE '%'||#{wlmc}||'%'
		</if>
		<if test="wlbm != null and wlbm != ''">
			and wlgl.wlbm ILIKE '%'||#{wlbm}||'%'
		</if>
		<if test="djh != null and djh != ''">
			and qggl.djh ILIKE '%'||#{djh}||'%'
		</if>
		<if test = "qgshzts != null and qgshzts.length > 0 "  >
			and qggl.zt in
			<foreach collection="qgshzts" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "qglbs != null and qglbs.length > 0 "  >
			and qggl.qglb in
			<foreach collection="qglbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="hwrkdh != null and hwrkdh != ''">
			and tab.hwrkdh ILIKE '%'||#{hwrkdh}||'%'
		</if>
		<if test="qxqg != null and qxqg == '0'.toString">
			and qxtmp.qgmxid IS NULL
		</if>
		<if test="qxqg != null and qxqg == '1'.toString">
			and qqxtmp.qgmxid IS NOT NULL
		</if>
		<if test="sqsjstart != null and sqsjstart != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &gt;= #{sqsjstart}
		</if>
		<if test="sqsjend != null and sqsjend != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &lt;= #{sqsjend}
		</if>
		<if test="jhdhsjstart != null and jhdhsjstart != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &gt;= #{jhdhsjstart}
		</if>
		<if test="jhdhsjend != null and jhdhsjend != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &lt;= #{jhdhsjend}
		</if>
		<if test="dhsjstart != null and dhsjstart != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &gt;= #{dhsjstart}
		</if>
		<if test="dhsjend != null and dhsjend != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &lt;= #{dhsjend}
		</if>
		<if test="htbj != null and htbj == '0'.toString">
			and htgl.htnbbh is null or trim(htgl.htnbbh)=''
		</if>
		<if test="hwbj != null and hwbj == '0'.toString">
			and htmx.dhsl is null or htmx.dhsl=0
		</if>
		<if test="htbj != null and htbj == '1'.toString">
			and trim(htgl.htnbbh)!=''
		</if>
		<if test="hwbj != null and hwbj == '1'.toString">
			and htmx.dhsl =htmx.sl
		</if>
		<if test="hwbj != null and hwbj == '2'.toString">
			and htmx.dhsl is not null and htmx.dhsl!=0 and htmx.sl!=htmx.dhsl
		</if>
		<if test="qgshtgsjstart != null and qgshtgsjstart != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi')&gt;= #{qgshtgsjstart}
		</if>
		<if test="qgshtgsjend != null and qgshtgsjend != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi') &lt;= #{qgshtgsjend}
		</if>
		<if test="fpwh != null and fpwh == '0'.toString">
			and fp.fpzsl is null
		</if>
		<if test="fpwh != null and fpwh == '1'.toString">
			and fp.fpzsl &lt; htmx.sl and fp.fpzsl &gt; 0
		</if>
		<if test="fpwh != null and fpwh == '2'.toString">
			and fp.fpzsl = htmx.sl
		</if>
		<if test="sfqdht != null and sfqdht == '0'.toString">
			and htmx.htmxid is null
		</if>
		<if test="sfqdht != null and sfqdht == '1'.toString">
			and htmx.htmxid is not null
		</if>
		<if test="sfjsdh != null and sfjsdh == '0'.toString">
			and htmx.jhdhrq &lt; htmx.dhrq
		</if>
		<if test="sfjsdh != null and sfjsdh == '1'.toString">
			and htmx.jhdhrq &gt;= htmx.dhrq
		</if>
	</select>

	<select id="getListForSearchExp" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid ${sqlParam}
		FROM
		igams_qgmx qgmx
		LEFT OUTER JOIN igams_qggl qggl ON qgmx.qgid = qggl.qgid
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = qgmx.qgmxid
		LEFT JOIN igams_htmx htmx on htmx.qgmxid = qgmx.qgmxid and htmx.scbj ='0'
		LEFT JOIN igams_htfkmx htfkmx on htmx.htid = htfkmx.htid and htfkmx.scbj ='0'
		LEFT JOIN igams_htfkqk htfkqk on htfkqk.htfkid = htfkmx.htfkid
		LEFT JOIN matridx_jcsj fkfs on fkfs.csid = htfkqk.fkfs
		LEFT JOIN (
		SELECT MAX
		( to_char( shxx.shsj, 'yyyy-mm-dd hh24:mi:ss' ) ) qgshtgsj,
		qggl.qgid
		FROM
		igams_qggl qggl
		LEFT JOIN matridx_shxx shxx ON shxx.ywid = qggl.qgid
		AND qggl.zt = '80'
		GROUP BY
		qggl.qgid
		) qgsh ON qgsh.qgid = qggl.qgid
		AND qggl.scbj = '0'
		LEFT OUTER JOIN (
		SELECT SUM
		( COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) - COALESCE ( hwxx.zjthsl, 0 ) ) rkzsl,
		SUM ( COALESCE ( hwxx.cythsl, 0 ) + COALESCE ( hwxx.zjthsl, 0 ) ) bhgsl,
		htmxid
		FROM
		igams_hwxx hwxx
		WHERE
		hwxx.scbj != '1'
		GROUP BY
		hwxx.htmxid
		) tmp ON tmp.htmxid = htmx.htmxid
		LEFT OUTER JOIN (
		SELECT
		htmx.htmxid,
		string_agg ( DISTINCT fpgl.fph , ',' ) fph,
		SUM ( fpmx.fpje ) fpzje,
		SUM ( fpmx.fpsl ) fpzsl,
		string_agg ( DISTINCT to_char( fpgl.lrsj, 'yyyy-mm-dd' ), ',' ) fplrsj
		FROM
		igams_htmx htmx
		LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
		AND fpmx.scbj = '0'
		LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
		AND fpgl.scbj = '0'
		AND fpgl.zt = '80'
		WHERE
		htmx.scbj = '0'
		GROUP BY
		htmx.htmxid
		) fp ON fp.htmxid = htmx.htmxid
		LEFT JOIN (
		SELECT
		htmx.htmxid,
		string_agg (
		DISTINCT hwxx.u8rkdh|| '(' || COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) || ')' ,
		','
		) u8rkdh,
		string_agg ( DISTINCT rkgl.rkdh, ',' ) hwrkdh
		FROM
		igams_htmx htmx
		LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
		AND hwxx.scbj = '0'
		LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
		AND dhxx.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj jcsj ON dhxx.rklb = jcsj.csid
		LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
		AND rkgl.scbj = '0'
		WHERE
		htmx.scbj != '1'
		GROUP BY
		htmx.htmxid
		) tab ON tab.htmxid = htmx.htmxid
		LEFT OUTER JOIN igams_htgl htgl ON htgl.htid = htmx.htid
		LEFT JOIN matridx_jcsj htfkfs on htfkfs.csid = htgl.fkfs
		LEFT JOIN igams_gysxx gys ON gys.gysid = htgl.gys
		AND gys.scbj != '1'
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = qgmx.wlid
		AND wlgl.scbj != '1'
		LEFT JOIN matridx_jcsj zllb ON zllb.csid = wlgl.lb
		LEFT JOIN matridx_xtyh qggl_sqr ON qggl.sqr = qggl_sqr.yhid
		AND qggl_sqr.scbj = '0'
		LEFT JOIN matridx_xtyh fzr ON htgl.fzr = fzr.yhid
		AND fzr.scbj = '0'
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		left outer join matridx_jcsj wllbjc on wlgl.wllb = wllbjc.csid
		left outer join matridx_jcsj zlbjc on wlgl.wlzlb = zlbjc.csid
		left outer join matridx_jcsj zlbtc on wlgl.wlzlbtc=zlbtc.csid
		WHERE
		qgmx.scbj != '1'
		<if test="entire != null and entire != ''">
			and (
			wlgl.wlmc ILIKE '%'||#{entire}||'%'
			or qggl.djh ILIKE '%'||#{entire}||'%'
			or wlgl.wlbm ILIKE '%'||#{entire}||'%'
			or htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or tab.hwrkdh ILIKE '%'||#{entire}||'%'
			)
		</if>
		<if test="qglx != null and qglx != ''">
			and qggl.qglx=#{qglx}
		</if>
		<if test="ccdg != null and ccdg != ''">
			and htmx.ccdg=#{ccdg}
		</if>
		<if test="wlmc != null and wlmc != ''">
			and wlgl.wlmc ILIKE '%'||#{wlmc}||'%'
		</if>
		<if test="wlbm != null and wlbm != ''">
			and wlgl.wlbm ILIKE '%'||#{wlbm}||'%'
		</if>
		<if test="djh != null and djh != ''">
			and qggl.djh ILIKE '%'||#{djh}||'%'
		</if>
		<if test = "qgshzts != null and qgshzts.length > 0 "  >
			and qggl.zt in
			<foreach collection="qgshzts" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "qglbs != null and qglbs.length > 0 "  >
			and qggl.qglb in
			<foreach collection="qglbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "wlfls != null and wlfls.length > 0 "  >
			and htmx.wlfl in
			<foreach collection="wlfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="hwrkdh != null and hwrkdh != ''">
			and tab.hwrkdh ILIKE '%'||#{hwrkdh}||'%'
		</if>
		<if test="qxqg != null and qxqg == '0'.toString">
			and qxtmp.qgmxid IS NULL
		</if>
		<if test="qxqg != null and qxqg == '1'.toString">
			and qqxtmp.qgmxid IS NOT NULL
		</if>
		<if test="sqsjstart != null and sqsjstart != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &gt;= #{sqsjstart}
		</if>
		<if test="sqsjend != null and sqsjend != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &lt;= #{sqsjend}
		</if>
		<if test="jhdhsjstart != null and jhdhsjstart != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &gt;= #{jhdhsjstart}
		</if>
		<if test="jhdhsjend != null and jhdhsjend != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &lt;= #{jhdhsjend}
		</if>
		<if test="dhsjstart != null and dhsjstart != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &gt;= #{dhsjstart}
		</if>
		<if test="dhsjend != null and dhsjend != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &lt;= #{dhsjend}
		</if>
		<if test="htbj != null and htbj == '0'.toString">
			and htgl.htnbbh is null or trim(htgl.htnbbh)=''
		</if>
		<if test="hwbj != null and hwbj == '0'.toString">
			and htmx.dhsl is null or htmx.dhsl=0
		</if>
		<if test="htbj != null and htbj == '1'.toString">
			and trim(htgl.htnbbh)!=''
		</if>
		<if test="hwbj != null and hwbj == '1'.toString">
			and htmx.dhsl =htmx.sl
		</if>
		<if test="hwbj != null and hwbj == '2'.toString">
			and htmx.dhsl is not null and htmx.dhsl!=0 and htmx.sl!=htmx.dhsl
		</if>
		<if test="qgshtgsjstart != null and qgshtgsjstart != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi')&gt;= #{qgshtgsjstart}
		</if>
		<if test="qgshtgsjend != null and qgshtgsjend != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi') &lt;= #{qgshtgsjend}
		</if>
		<if test="fpwh != null and fpwh == '0'.toString">
			and fp.fpzsl is null
		</if>
		<if test="fpwh != null and fpwh == '1'.toString">
			and fp.fpzsl &lt; htmx.sl and fp.fpzsl &gt; 0
		</if>
		<if test="fpwh != null and fpwh == '2'.toString">
			and fp.fpzsl = htmx.sl
		</if>
		<if test="sfqdht != null and sfqdht == '0'.toString">
			and htmx.htmxid is null
		</if>
		<if test="sfqdht != null and sfqdht == '1'.toString">
			and htmx.htmxid is not null
		</if>
		<if test="sfjsdh != null and sfjsdh == '0'.toString">
			and htmx.jhdhrq &lt; htmx.dhrq
		</if>
		<if test="sfjsdh != null and sfjsdh == '1'.toString">
			and htmx.jhdhrq &gt;= htmx.dhrq
		</if>
		order by
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
		LIMIT #{pageSize} OFFSET #{pageStart}
	</select>


	<select id="getListForSelectExp" parameterType="QgmxDto" resultType="QgmxDto">
		select alltmp.qghtmxid ${sqlParam} from (
		<foreach item="item" index="index" collection="ids"
			separator=" union all ">
			select #{item,jdbcType=VARCHAR} htmxid,#{index} ordernum
		</foreach>
		) tmps
		LEFT JOIN (SELECT
		qgmx.qgmxid || COALESCE(htmx.htmxid,'admin') AS qghtmxid,htmx.htmxid,fzr.zsxm fzrmc,qggl_sqr.zsxm qgsqrmc,qggl.jlbh jlbh,htgl.htnbbh htnbbh,gys.gysmc gysmc,wlgl.wlbm wlbm,coalesce(wlgl.wlmc,qgmx.hwmc) wlmc,coalesce(wlgl.gg,qgmx.hwbz) gg,coalesce(wlgl.scs,qgmx.gys) scs,
		CASE

		WHEN htmx.ccdg = '1' THEN
		'是'
		WHEN htmx.ccdg = '0' THEN
		'否'
		END ccdgmc,wlfl.csmc wlflmc,wlgl.ychh ychh,COALESCE ( wlgl.jldw, qgmx.hwjldw ) jldw,qgmx.sl sl,htmx.sl htsl,htmx.hsdj hsdj,htmx.hjje hjje,htmx.jhdhrq jhdhrq,htmx.dhrq dhrq,
		htmx.dhsl dhsl,tab.u8rkdh u8rkdh,tmp.rkzsl rkzsl,tmp.bhgsl bhgsl,fp.fph fph,fp.fpzje fpzje,fp.fplrsj fplrsj,htfkqk.fkrq fkrq,fkfs.csmc fkfsmc,htfkmx.fkje fkje,
		( COALESCE ( htgl.zje, 0 ) - COALESCE ( htgl.yfje, 0 ) ) wfkje,htmx.bz bz,
		CASE

		WHEN qxtmp.qgmxid IS NULL THEN
		'正常'
		WHEN qxtmp.qgmxid IS NOT NULL THEN
		'取消'
		WHEN qgmx.zt = '15' THEN
		'拒绝'
		END qxqg,
		CASE

		WHEN qggl.zt = '00' THEN
		'未提交'
		WHEN qggl.zt = '80' THEN
		'审核通过'
		WHEN qggl.zt = '15' THEN
		'审核未通过' ELSE'审核中'
		END zt,wllbjc.csmc wllbmc,zlbjc.csmc wlzlbmc,zlbtc.csmc wlzlbtcmc,htfkfs.csmc||CASE WHEN htgl.fkbz is null then '' else ','||htgl.fkbz end htfkfsmc,qgmx.cpzch
		FROM
		igams_qgmx qgmx
		LEFT JOIN igams_htmx htmx ON htmx.qgmxid = qgmx.qgmxid
		AND htmx.scbj = '0'
		LEFT OUTER JOIN igams_qggl qggl ON qgmx.qgid = qggl.qgid
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = qgmx.qgmxid
		LEFT JOIN igams_htfkmx htfkmx on htmx.htid = htfkmx.htid and htfkmx.scbj ='0'
		LEFT JOIN igams_htfkqk htfkqk on htfkqk.htfkid = htfkmx.htfkid
		LEFT JOIN matridx_jcsj fkfs on fkfs.csid = htfkqk.fkfs
		LEFT JOIN (
		SELECT MAX
		( to_char( shxx.shsj, 'yyyy-mm-dd hh24:mi:ss' ) ) qgshtgsj,
		qggl.qgid
		FROM
		igams_qggl qggl
		LEFT JOIN matridx_shxx shxx ON shxx.ywid = qggl.qgid
		AND qggl.zt = '80'
		GROUP BY
		qggl.qgid
		) qgsh ON qgsh.qgid = qggl.qgid
		AND qggl.scbj = '0'
		LEFT OUTER JOIN (
		SELECT SUM
		( COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) - COALESCE ( hwxx.zjthsl, 0 ) ) rkzsl,
		SUM ( COALESCE ( hwxx.cythsl, 0 ) + COALESCE ( hwxx.zjthsl, 0 ) ) bhgsl,
		htmxid
		FROM
		igams_hwxx hwxx
		WHERE
		hwxx.scbj != '1'
		GROUP BY
		hwxx.htmxid
		) tmp ON tmp.htmxid = htmx.htmxid
		LEFT OUTER JOIN (
		SELECT
		htmx.htmxid,
		string_agg ( DISTINCT fpgl.fph , ',' ) fph,
		SUM ( fpmx.fpje ) fpzje,
		SUM ( fpmx.fpsl ) fpzsl,
		string_agg ( DISTINCT to_char( fpgl.lrsj, 'yyyy-mm-dd' ), ',' ) fplrsj
		FROM
		igams_htmx htmx
		LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
		AND fpmx.scbj = '0'
		LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
		AND fpgl.scbj = '0'
		AND fpgl.zt = '80'
		WHERE
		htmx.scbj = '0'
		GROUP BY
		htmx.htmxid
		) fp ON fp.htmxid = htmx.htmxid
		LEFT JOIN (
		SELECT
		htmx.htmxid,
		string_agg (
		DISTINCT hwxx.u8rkdh|| '(' || COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) || ')' ,
		','
		) u8rkdh
		FROM
		igams_htmx htmx
		LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
		AND hwxx.scbj = '0'
		LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
		AND dhxx.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj jcsj ON dhxx.rklb = jcsj.csid
		LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
		AND rkgl.scbj = '0'
		WHERE
		htmx.scbj != '1'
		GROUP BY
		htmx.htmxid
		) tab ON tab.htmxid = htmx.htmxid
		LEFT OUTER JOIN igams_htgl htgl ON htgl.htid = htmx.htid
		LEFT JOIN matridx_jcsj htfkfs on htfkfs.csid = htgl.fkfs
		LEFT JOIN igams_gysxx gys ON gys.gysid = htgl.gys
		AND gys.scbj != '1'
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = qgmx.wlid
		AND wlgl.scbj != '1'
		LEFT JOIN matridx_jcsj zllb ON zllb.csid = wlgl.lb
		left outer join matridx_jcsj wllbjc on wlgl.wllb = wllbjc.csid
		left outer join matridx_jcsj zlbjc on wlgl.wlzlb = zlbjc.csid
		left outer join matridx_jcsj zlbtc on wlgl.wlzlbtc=zlbtc.csid
		LEFT JOIN matridx_xtyh qggl_sqr ON qggl.sqr = qggl_sqr.yhid
		AND qggl_sqr.scbj = '0'
		LEFT JOIN matridx_xtyh fzr ON htgl.fzr = fzr.yhid
		AND fzr.scbj = '0'
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		WHERE
		qgmx.scbj != '1')alltmp on alltmp.qghtmxid = tmps.htmxid
	</select>

	<!-- 请购执行列表 -->
	<select id="getPagedQgmxDtos" parameterType="QgmxDto" resultType="QgmxDto">
		SELECT
		qggl.jlbh,
		qggl.djh,
		qggl.qgid,
		wlgl.wlbm,
		wlgl.wlid,
		wlgl.wlmc,
		qgmx.qgmxid,
		qgmx.sl,
		qggl.scbj,
		qggl.sqrq,
		jcsj.csdm,
		qgmx.hwmc,
		CASE
		WHEN qxtmp.qgmxid IS NULL THEN
		'0'
		WHEN qxtmp.qgmxid IS NOT NULL THEN
		'1'
		END qxqg,
		qgmx.hwbz,
		qgmx.qwrq,
		qgmx.zt,
		qggl.zt qgshzt,
		qggl_sqr.zsxm qgsqrmc,
		wlgl.gg,
		wlgl.ychh,
		qgmx.sysl,
		qgmx.ydsl,
		jcsj.csdm qglbdm,
		jcsj.csmc qglbmc,
		wlgl.jldw,
		zllb.cskz1 lbcskz1,
		tmp.rkzsl,
		tmp.bhgsl,
		fp.fph,
		fp.fpzsl,
		tab.u8rkdh,
		tab.dhdh,
		htmx.dhrq,
		htmx.dhsl,
		tab.hwrkdh,
		tab.rkrq,
		tab.hwid,
		fp.fpzje,
		fp.fplrsj,
		htmx.bz,
		fkfs.csmc fkfsmc,
		htfkqk.fkrq,
		htfkmx.fkje,
		fzr.zsxm fzrmc,
		htmx.htmxid,
		htgl.htnbbh,
		htgl.cjrq,
		htmx.sl htsl,
		gys.gysmc,
		htmx.hsdj,
		htmx.hjje,
		htmx.jhdhrq,
		htgl.htid,
		wlfl.csmc wlflmc,
		(COALESCE(htgl.zje,0)-COALESCE(htgl.yfje,0)) wfkje,
		case when htmx.ccdg='1' then '是' when htmx.ccdg='0' then '否' END ccdgmc,
		qggl.qglx,wllbjc.csmc wllbmc,zlbjc.csmc wlzlbmc,zlbtc.csmc wlzlbtcmc,htfkfs.csmc htfkfsmc,htgl.fkbz,qgmx.cpzch
		FROM
		igams_qgmx qgmx
		LEFT OUTER JOIN igams_qggl qggl ON qgmx.qgid = qggl.qgid
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = qgmx.qgmxid
		LEFT JOIN igams_htmx htmx on htmx.qgmxid = qgmx.qgmxid and htmx.scbj ='0'
		LEFT JOIN igams_htfkmx htfkmx on htmx.htid = htfkmx.htid and htfkmx.scbj ='0'
		LEFT JOIN igams_htfkqk htfkqk on htfkqk.htfkid = htfkmx.htfkid
		LEFT JOIN matridx_jcsj fkfs on fkfs.csid = htfkqk.fkfs
		LEFT OUTER JOIN (
		SELECT SUM
		( COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) - COALESCE ( hwxx.zjthsl, 0 ) ) rkzsl,
		SUM ( COALESCE ( hwxx.cythsl, 0 ) + COALESCE ( hwxx.zjthsl, 0 ) ) bhgsl,
		htmxid
		FROM
		igams_hwxx hwxx
		WHERE
		hwxx.scbj != '1'
		GROUP BY
		hwxx.htmxid
		) tmp ON tmp.htmxid = htmx.htmxid
		LEFT OUTER JOIN (
		SELECT
		htmx.htmxid,
		string_agg ( DISTINCT fpgl.fph || '-' || fpgl.fpid, ',' ) fph,
		SUM ( fpmx.fpje ) fpzje,
		SUM ( fpmx.fpsl ) fpzsl,
		string_agg ( DISTINCT to_char( fpgl.lrsj, 'yyyy-mm-dd' ), ',' ) fplrsj
		FROM
		igams_htmx htmx
		LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
		AND fpmx.scbj = '0'
		LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
		AND fpgl.scbj = '0'
		AND fpgl.zt = '80'
		WHERE
		htmx.scbj = '0'
		GROUP BY
		htmx.htmxid
		) fp ON fp.htmxid = htmx.htmxid
		LEFT JOIN (
		SELECT
		htmx.htmxid,
		string_agg (
		DISTINCT hwxx.u8rkdh|| '(' || COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) || ')'||'!'||COALESCE(hwxx.lbcskz,'admin')||'!'||jcsj.csdm ||'!' || '*' || COALESCE(rkgl.rkid,'admin') || '*' || dhxx.dhid,
		','
		) u8rkdh,
		string_agg ( DISTINCT dhxx.dhdh || '+' || dhxx.dhid, ',' ) dhdh,
		string_agg ( DISTINCT rkgl.rkdh || '+' || rkgl.rkid, ',' ) hwrkdh,
		string_agg ( DISTINCT to_char( rkgl.rkrq, 'yyyy-mm-dd' ), ',' ) rkrq,
		string_agg ( DISTINCT hwxx.hwid, ',' ) hwid
		FROM
		igams_htmx htmx
		LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
		AND hwxx.scbj = '0'
		LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
		AND dhxx.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj jcsj ON dhxx.rklb = jcsj.csid
		LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
		AND rkgl.scbj = '0'
		WHERE
		htmx.scbj != '1'
		GROUP BY
		htmx.htmxid
		) tab ON tab.htmxid = htmx.htmxid
		LEFT OUTER JOIN igams_htgl htgl ON htgl.htid = htmx.htid
		LEFT JOIN matridx_jcsj htfkfs on htfkfs.csid = htgl.fkfs
		LEFT JOIN igams_gysxx gys ON gys.gysid = htgl.gys
		AND gys.scbj != '1'
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = qgmx.wlid
		AND wlgl.scbj != '1'
		LEFT JOIN matridx_jcsj zllb ON zllb.csid = wlgl.lb
		left outer join matridx_jcsj wllbjc on wlgl.wllb = wllbjc.csid
		left outer join matridx_jcsj zlbjc on wlgl.wlzlb = zlbjc.csid
		left outer join matridx_jcsj zlbtc on wlgl.wlzlbtc=zlbtc.csid
		LEFT JOIN matridx_xtyh qggl_sqr ON qggl.sqr = qggl_sqr.yhid
		AND qggl_sqr.scbj = '0'
		LEFT JOIN matridx_xtyh fzr ON htgl.fzr = fzr.yhid
		AND fzr.scbj = '0'
		LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = qggl.qglb
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		WHERE
		qgmx.scbj != '1'
		<if test="entire != null and entire != ''">
			and (
			wlgl.wlmc ILIKE '%'||#{entire}||'%'
			or qggl.djh ILIKE '%'||#{entire}||'%'
			or wlgl.wlbm ILIKE '%'||#{entire}||'%'
			or htgl.htnbbh ILIKE '%'||#{entire}||'%'
			or tab.hwrkdh ILIKE '%'||#{entire}||'%'
			)
		</if>
		<if test="qglx != null and qglx != ''">
			and qggl.qglx=#{qglx}
		</if>
		<if test="ccdg != null and ccdg != ''">
			and htmx.ccdg=#{ccdg}
		</if>
		<if test="wlmc != null and wlmc != ''">
			and wlgl.wlmc ILIKE '%'||#{wlmc}||'%'
		</if>
		<if test="wlbm != null and wlbm != ''">
			and wlgl.wlbm ILIKE '%'||#{wlbm}||'%'
		</if>
		<if test="djh != null and djh != ''">
			and qggl.djh ILIKE '%'||#{djh}||'%'
		</if>
		<if test = "wlfls != null and wlfls.length > 0 "  >
			and htmx.wlfl in
			<foreach collection="wlfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "qgshzts != null and qgshzts.length > 0 "  >
			and qggl.zt in
			<foreach collection="qgshzts" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "qglbs != null and qglbs.length > 0 "  >
			and qggl.qglb in
			<foreach collection="qglbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and htgl.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="hwrkdh != null and hwrkdh != ''">
			and tab.hwrkdh ILIKE '%'||#{hwrkdh}||'%'
		</if>
		<if test="qxqg != null and qxqg == '0'.toString">
			and qxtmp.qgmxid IS NULL
		</if>
		<if test="qxqg != null and qxqg == '1'.toString">
			and qqxtmp.qgmxid IS NOT NULL
		</if>
		<if test="sqsjstart != null and sqsjstart != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &gt;= #{sqsjstart}
		</if>
		<if test="sqsjend != null and sqsjend != ''">
			and to_char(qggl.sqrq,'yyyy-mm-dd') &lt;= #{sqsjend}
		</if>
		<if test="jhdhsjstart != null and jhdhsjstart != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &gt;= #{jhdhsjstart}
		</if>
		<if test="jhdhsjend != null and jhdhsjend != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &lt;= #{jhdhsjend}
		</if>
		<if test="dhsjstart != null and dhsjstart != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &gt;= #{dhsjstart}
		</if>
		<if test="dhsjend != null and dhsjend != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &lt;= #{dhsjend}
		</if>
		<if test="htbj != null and htbj == '0'.toString">
			and htgl.htnbbh is null or trim(htgl.htnbbh)=''
		</if>
		<if test="hwbj != null and hwbj == '0'.toString">
			and htmx.dhsl is null or htmx.dhsl=0
		</if>
		<if test="htbj != null and htbj == '1'.toString">
			and trim(htgl.htnbbh)!=''
		</if>
		<if test="hwbj != null and hwbj == '1'.toString">
			and htmx.dhsl =htmx.sl
		</if>
		<if test="hwbj != null and hwbj == '2'.toString">
			and htmx.dhsl is not null and htmx.dhsl!=0 and htmx.sl!=htmx.dhsl
		</if>
		<if test="qgshtgsjstart != null and qgshtgsjstart != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi')&gt;= #{qgshtgsjstart}
		</if>
		<if test="qgshtgsjend != null and qgshtgsjend != ''">
			and to_char(qggl.shsj,'yyyy-MM-dd HH24:mi') &lt;= #{qgshtgsjend}
		</if>
		<if test="fpwh != null and fpwh == '0'.toString">
			and fp.fpzsl is null
		</if>
		<if test="fpwh != null and fpwh == '1'.toString">
			and fp.fpzsl &lt; htmx.sl and fp.fpzsl &gt; 0
		</if>
		<if test="fpwh != null and fpwh == '2'.toString">
			and fp.fpzsl = htmx.sl
		</if>
		<if test="sfqdht != null and sfqdht == '0'.toString">
			and htmx.htmxid is null
		</if>
		<if test="sfqdht != null and sfqdht == '1'.toString">
			and htmx.htmxid is not null
		</if>
		<if test="sfjsdh != null and sfjsdh == '0'.toString">
			and htmx.jhdhrq &lt; htmx.dhrq
		</if>
		<if test="sfjsdh != null and sfjsdh == '1'.toString">
			and htmx.jhdhrq &gt;= htmx.dhrq
		</if>
	</select>
	
	<!-- 价格统计 -->
	<select id="statisticPrice" parameterType="QgmxDto" resultType="Map">
		select row_number() over(order by qggl.lrsj desc ) tjmc, qgmx.jg tjsl, to_char(qggl.lrsj,'YYYY-mm-dd')||' 价格' xname
			from igams_qgmx qgmx
			left join igams_qggl qggl on qgmx.qgid = qggl.qgid
			where
				qgmx.scbj != '1'  and qgmx.wlid=#{wlid} and qggl.zt = '80'
			order by qggl.lrsj desc
			limit 5
	</select>
	
	<!-- 请购物料周期统计(当前使用的创建日期，功能完整后可以改为订单日期) -->
	<select id="statisticQgmxCycle" parameterType="QgmxDto" resultType="Map">
		select row_number() over(order by qggl.lrsj desc ) tjmc, date_part('day',dhxx.dhrq::timestamp-qggl.lrsj::timestamp) tjsl, to_char(qggl.lrsj,'YYYY-mm-dd')||' 周期(天)' xname
			from igams_qgmx qgmx
			left join igams_qggl qggl on qgmx.qgid = qggl.qgid 
			left join igams_hwxx hwxx on hwxx.rkid = qggl.djh
			left join igams_dhxx dhxx on dhxx.dhid = hwxx.dhid
			where
				qgmx.wlid=#{wlid} and dhxx.dhrq is not null
			order by qggl.lrsj desc
			limit 5
	</select>
	
	<!-- 取消请购页面明细列表 -->
	<select id="getQxqgmxList" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,
		qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw,qgmx.ydsl,qgmx.sysl,qgmx.yssl,qgmx.hwmc,jc_qglb.csmc qglbmc,
		qgmx.hwbz, qgmx.yt, qgmx.yq,qgmx.sjjl, qgmx.hwjldw, qgmx.hwyt, qgmx.wbyq, qgmx.pzyq,
		coalesce(tmp.qxsl,0) zqxsl,(qgmx.sysl - coalesce(tmp.qxsl,0) - coalesce(qgmx.ydsl,0)) kqxsl,qgmx.cpzch
  			from igams_qgmx qgmx  
  			left outer join  (
				select qgqxmx.qgmxid,sum(qxsl) qxsl from igams_qgqxmx qgqxmx
				left join igams_qgqxgl qgqxgl on qgqxgl.qgqxid=qgqxmx.qgqxid
				where  qgqxgl.zt ='10' and qgqxgl.scbj!='1' and qgqxmx.qgid=#{qgid} 
				group by qgqxmx.qgmxid 
			) tmp on tmp.qgmxid = qgmx.qgmxid
	  		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
	  		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
	  		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
	  		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
	  		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
	  		left join matridx_jcsj jc_qglb on jc_qglb.csid=qggl.qglb
		<where>
			qgmx.scbj != '1' and qgmx.qgid = #{qgid} and qgmx.qxqg!='1' and qgmx.zt='80' order by qgmx.xh asc
	  	</where>
	</select>
	<!-- 更新请购明细的到货数量 -->
	<update id="updateQgmxDhsl" parameterType="QgmxDto">
		UPDATE igams_qgmx qgmx 
		SET dhsl = (
			SELECT 
				SUM( COALESCE ( hwxx.dhsl, 0 ) - COALESCE ( hwxx.cythsl, 0 ) - COALESCE ( hwxx.zjthsl, 0 ) ) 
			FROM
				igams_hwxx hwxx 
			WHERE
				hwxx.qgmxid = qgmx.qgmxid 
				AND hwxx.scbj != '1' 
				AND hwxx.zt IN ( '03', '80' ) 
			) 
		WHERE
			qgmxid in
	    		<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
	</update>
	
	<update id="qgmxDtoModDhxx" parameterType="List">
		<if test="list !=null and list.size > 0">
			<foreach collection="list" separator=";" item="item" index="index">
				update igams_qgmx
			<set>
			<trim prefixOverrides=",">
			<if test="item.dhrq != null and item.dhrq != ''">
					,dhrq=cast(#{item.dhrq} as timestamp)
			</if>
			<if test="item.xgry != null and item.xgry != ''">
					,xgry=#{item.xgry},xgsj=LOCALTIMESTAMP
			</if>
			<if test="item.dhsl != null and item.dhsl != ''">
					,dhsl=cast(#{item.dhsl} as numeric)
			</if>
			<if test="item.dhdhgl != null and item.dhdhgl != ''">
					,dhdhgl=#{item.dhdhgl}
			</if>
			<if test="item.rksladd != null and item.rksladd != ''">
					,rksl=COALESCE(rksl,0) + cast(#{item.rksl} as numeric)
			</if>
			<if test="item.rksldel != null and item.rksldel != ''">
					,rksl=COALESCE(rksl,0) - cast(#{item.rksl} as numeric)
			</if>
			</trim>
			</set>
			<where>
				qgmxid=#{item.qgmxid}
			</where>
			</foreach>
		</if>
	</update>
	
	
	<!-- 根据请购ids获取请购信息（共通页面） -->
	<select id="getCommonDtoListByQgids" parameterType="QgmxDto" resultType="QgmxDto">
		SELECT
			qgmx.qgmxid, qgmx.qgid, qgmx.xh, qgmx.wlid, qgmx.sl, qgmx.jg, qgmx.qwrq, qgmx.bz, qgmx.qxqg, qgmx.zt, qgmx.lrry, qgmx.lrsj, qgmx.ydsl, qgmx.sysl, qgmx.hwmc, qgmx.yssl, qgmx.htbhgl, qgmx.jhdhrq, qgmx.htrq, qgmx.dhrq, qgmx.dhsl, qgmx.rksl, qgmx.dhdhgl, qgmx.glid, qgmx.hwbz, qgmx.yt, qgmx.yq, qgmx.sjjl, qgmx.hwjldw, qgmx.hwyt, qgmx.wbyq, qgmx.pzyq,
			wllb.csmc wllbmc,wlzlb.csmc wlzlbmc,wlzlbtc.csmc wlzlbtcmc,
			wlgl.wlbm,wlgl.wlmc,wlgl.gg,wlgl.ychh,wlgl.jldw,
			gysxx.gysmc gys,qgmx.cpzch,
			hwxx.hwid,hwxx.htmxid,hwxx.zsh,hwxx.scrq,hwxx.yxq,hwxx.dhid,hwxx.cythsl,hwxx.dhbz,hwxx.zjthsl,hwxx.qyl,hwxx.qyrq,hwxx.bgdh,hwxx.zjrq,hwxx.zjry,hwxx.jybz,hwxx.dhjyid,hwxx.rkid,hwxx.ckid,hwxx.kwbh,hwxx.rkry,hwxx.rkrq,hwxx.rkbz,hwxx.kcl,hwxx.yds,hwxx.kcglid,hwxx.scph
		FROM
			igams_qgmx qgmx
			LEFT JOIN igams_hwxx hwxx on hwxx.qgmxid = qgmx.qgmxid and hwxx.scbj != '1'
			LEFT JOIN igams_qggl qggl on qggl.qgid=qgmx.qgid
			LEFT JOIN igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
			LEFT JOIN matridx_jcsj wllb on wllb.csid = wlgl.wllb
			LEFT JOIN matridx_jcsj wlzlb on wlzlb.csid = wlgl.wlzlb
			LEFT JOIN matridx_jcsj wlzlbtc on wlzlbtc.csid=wlgl.wlzlbtc
			LEFT JOIN igams_gysxx gysxx on gysxx.gysid = qgmx.gys
	    	<where>
	    		qgmx.scbj!='1'
	    		<if test="ids !=null and ids.size >0">
	    			and qgmx.qgmxid in
	    			<foreach collection="ids" open="(" close=")" separator="," item="item">
						#{item}
					</foreach>
	    		</if>
	    	</where>
    </select>
	<!--删除行政入库明细 删除入库数量-->
	<update id="delRkslByQgmxid">
		update igams_qgmx qgmx
		set rksl =  0,xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<where>
			qgmx.scbj!='1'
			<if test="ids !=null and ids.size >0">
				and qgmx.qgmxid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>
	<!--根据请购明细id获取请购id-->
	<select id="getQgidsByQgmxids" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgid from igams_qgmx qgmx
		<where>
			qgmx.scbj!='1'
			<if test="ids !=null and ids.size >0">
				and qgmx.qgmxid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!--获取行政请购未确认列表-->
	<select id="getPageListUnconfirmPurchaseAdministration" parameterType="QgmxDto" resultType="QgmxDto">
		SELECT qgmx.qgid,qgmx.qgmxid,qgmx.wlid,qgmx.sl,qgmx.jg,qgmx.qwrq,qgmx.bz,qgmx.qxqg,qgmx.zt,qgmx.ydsl,qgmx.sysl,qgmx.hwmc,
		qgmx.yssl,qgmx.htbhgl,qgmx.jhdhrq,qgmx.htrq,qgmx.dhrq,qgmx.dhsl,qgmx.rksl,qgmx.dhdhgl,qgmx.glid,qgmx.hwbz,qgmx.yt,
		qgmx.yq,qgmx.sjjl,qgmx.hwbz hwgg,qgmx.hwjldw,qgmx.hwyt,qgmx.gys,qgmx.wbyq,qgmx.pzyq,qgmx.sfrk,jg_sqbm.jgmc as sqbmmc,
		qggl.sfqr,qggl.sqrq,qggl.djh qgdh,yh_sqr.zsxm qgsqrmc
		FROM igams_qgmx qgmx
		LEFT JOIN igams_qggl qggl ON qggl.qgid = qgmx.qgid
		LEFT JOIN matridx_jgxx jg_sqbm ON jg_sqbm.jgid=qggl.sqbm
		LEFT JOIN matridx_xtyh yh_sqr ON yh_sqr.yhid=qggl.sqr
		LEFT JOIN matridx_jcsj jc_qglb ON qggl.qglb = jc_qglb.csid
		LEFT JOIN igams_xzqgfkmx xzqgfkmx ON xzqgfkmx.qgmxid = qgmx.qgmxid and xzqgfkmx.scbj='0'
		LEFT JOIN igams_xzqgqrmx xzqgqrmx ON xzqgqrmx.qgmxid = qgmx.qgmxid and xzqgqrmx.scbj='0'
		<where>
			xzqgfkmx.fkmxid is null
			and xzqgqrmx.qrmxid is null
			and qggl.scbj !='1'
			and jc_qglb.csdm = 'ADMINISTRATION'
			AND qgmx.scbj='0'
			AND qgmx.zt = '80'
			AND qggl.zt = '80'
			AND (qgmx.sfqr != '1' or qgmx.sfqr is null)
			<if test="entire != null and entire != ''">
				and (qggl.djh like '%'||#{entire}||'%'
				or jg_sqbm.jgmc like '%'||#{entire}||'%'
				or qgmx.hwmc like '%'||#{entire}||'%' )
			</if>
			<if test="djh != null and djh != ''">
				and qggl.djh ILIKE '%'||#{djh}||'%'
			</if>
			<if test="sqbmmc != null and sqbmmc != ''">
				and jg_sqbm.jgmc ILIKE '%'||#{sqbmmc}||'%'
			</if>
			<if test="hwmc != null and hwmc != ''">
				and qgmx.hwmc ILIKE '%'||#{hwmc}||'%'
			</if>
			<if test="sqrqstart != null and sqrqstart != ''">
				and to_char(qggl.sqrq,'YYYY-MM-dd') &gt;= #{sqrqstart}
			</if>
			<if test="sqrqend != null and sqrqend != ''">
				and to_char(qggl.sqrq,'YYYY-MM-dd') &lt;= #{sqrqend}
			</if>
			<if test="qrc_flag != null and qrc_flag != ''">
				and qgmx.qgmxid not in (select qgmxid from igams_xzqgqrcgl where ryid=#{ryid})
			</if>
		</where>
	</select>

	<select id="getWqrQgmxByQgmxid" parameterType="QgmxDto" resultType="QgmxDto">
		SELECT qgmx.qgid,qgmx.qgmxid,qgmx.wlid,qgmx.sl,qgmx.jg,qgmx.qwrq,qgmx.bz,qgmx.qxqg,qgmx.zt,qgmx.ydsl,qgmx.sysl,qgmx.hwmc,
		qgmx.yssl,qgmx.htbhgl,qgmx.jhdhrq,qgmx.htrq,qgmx.dhrq,qgmx.dhsl,qgmx.rksl,qgmx.dhdhgl,qgmx.glid,qgmx.hwbz,qgmx.yt,
		qgmx.yq,qgmx.sjjl,qgmx.hwbz hwgg,qgmx.hwjldw,qgmx.hwyt,qgmx.gys,qgmx.wbyq,qgmx.pzyq,qgmx.sfrk,jg_sqbm.jgmc as sqbmmc,
		qggl.sfqr,qggl.sqrq,qggl.djh
		FROM igams_qgmx qgmx
		LEFT JOIN igams_qggl qggl ON qggl.qgid = qgmx.qgid
		LEFT JOIN matridx_jgxx jg_sqbm ON jg_sqbm.jgid=qggl.sqbm
		LEFT JOIN matridx_jcsj jc_qglb ON qggl.qglb = jc_qglb.csid
		LEFT JOIN igams_xzqgfkmx xzqgfkmx ON xzqgfkmx.qgmxid = qgmx.qgmxid
		LEFT JOIN igams_xzqgqrmx xzqgqrmx ON xzqgqrmx.qgmxid = qgmx.qgmxid
		<where>
			qgmx.qgmxid = #{qgmxid}
		</where>
	</select>

	<!--批量更新请购明细关联ID-->
	<update id="updateGlidDtos" parameterType="List">
		<foreach collection="list" item="item" separator=";">
			update igams_qgmx set sl=cast(#{item.sl} as numeric),
			sysl=cast(#{item.sysl} as numeric)
			<if test="item.ydsl!=null and item.ydsl!=''">
				,ydsl=cast(#{item.ydsl} as numeric)
			</if>
			<if test="item.jg!=null and item.jg!=''">
				,jg=cast(#{item.jg} as numeric)
			</if>
			<if test="item.qwrq==null or item.qwrq==''">
				,qwrq=null
			</if>
			<if test="item.qwrq!=null and item.qwrq!=''">
				,qwrq=cast(#{item.qwrq} as date)
			</if>			
			<if test="item.bz!=null and item.bz!=''">
				,bz=#{item.bz}
			</if>
			<if test="item.qxqg!=null and item.qxqg!=''">
				,qxqg=#{item.qxqg}
			</if>
			<if test="item.zt!=null and item.zt!=''">
				,zt=#{item.zt}
			</if>
			<if test="item.glid!=null and item.glid!=''">
				,glid=#{item.glid}
			</if>
			where qgmxid=#{item.qgmxid}
		</foreach>
	</update>

	<update id="updateQrbj" parameterType="QgmxDto">
		update igams_qgmx set
		sfqr=#{sfqr}
		where scbj='0' and qgmxid in
		<foreach collection="ids" item="item" close=")" open="(" separator=",">
			#{item}
		</foreach>
	</update>

	<!-- 请购明细列表(不分页) -->
	<select id="getXzkcList" parameterType="QgmxDto" resultType="QgmxDto">
		select kcxx.hwmc,kcxx.hwbz,(coalesce(kcxx.kcl,0) - coalesce(kcxx.yds,0)) klsl,kcxx.xzkcid,coalesce(kcxx.kcl,0) kcl,coalesce(kcxx.yds,0) yds,kw.csmc kwmc
		from igams_xzkcxx kcxx
		left join matridx_jcsj kw on kw.csid=kcxx.kwid
		<where>
			<if test="kcids !=null and kcids.size >0">
				kcxx.xzkcid in
				<foreach collection="kcids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		kcxx.xzkcid,
		kw.csmc
	</select>
	<!-- 请购明细列表(不分页) -->
	<select id="getQgmxListByQgidAndQgmxid" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,qgmx.qgid,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,(coalesce(kcxx.kcl,0) - coalesce(kcxx.yds,0)) klsl,kcxx.xzkcid,qggl.djh,coalesce(kcxx.kcl,0) kcl,coalesce(kcxx.yds,0) yds,kw.csmc kwmc
		from igams_xzkcxx kcxx
		left join igams_xzrkmx xzrkmx on xzrkmx.xzkcid=kcxx.xzkcid
		left join igams_qgmx qgmx on qgmx.qgmxid = xzrkmx.qgmxid
		LEFT JOIN igams_qggl qggl ON qggl.qgid = qgmx.qgid
		left join matridx_jcsj kw on kw.csid=kcxx.kwid
		<where>
			qgmx.scbj != '1'
			<if test="qgid != null and qgid != ''">
				and qgmx.qgid = #{qgid}
			</if>
			<if test="kcids !=null and kcids.size >0">
				and kcxx.xzkcid in
				<foreach collection="kcids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		qgmx.qgmxid,
		qggl.djh,
		kcxx.xzkcid,
		kw.csmc,qgmx.qgid,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,kcxx.kcl,kcxx.yds
	</select>
	<select id="getQgmxDtos" parameterType="QgmxDto" resultType="QgmxDto">
		select qgmx.qgmxid,wlgl.wlbm,qgmx.qgid,qgmx.xh,qgmx.wlid,qgmx.sl,qgmx.sysl,qgmx.jg,qgmx.qwrq,wlgl.wlzlbtc,jc_wlzlbtc.csmc wlzlbtcmc,
		qgmx.bz,qgmx.qxqg,qgmx.zt,wlgl.wlmc,wlgl.wllb,wlgl.wlzlb,jc_wllb.csmc as wllbmc,jc_wlzlb.csmc as wlzlbmc,
		qgmx.glid,wlgl.scs,wlgl.gg,wlgl.jldw,wlgl.ychh,qgmx.lrsj,qggl.djh as djh,jg_sqbm.jgmc as sqbmmc,qgmx.sysl,qgmx.ydsl,qgmx.yt,
		qgmx.sjjl,qgmx.hwmc,qgmx.hwbz,qgmx.hwjldw,qgmx.yq,qgmx.hwyt,qgmx.gys,qgmx.pzyq,qgmx.wbyq,jc_zlyq.csmc zlyqmc,qgmx.sjjl,qgmx.rksl,ckhwxx.ckhwid as ckhwid,qgmx.cpzch
		,wlgl.wlid
		from igams_qgmx qgmx
		left join igams_qggl qggl on qggl.qgid=qgmx.qgid
		left join igams_wlgl wlgl on wlgl.wlid=qgmx.wlid
		left join matridx_jcsj jc_wllb on jc_wllb.csid=wlgl.wllb
		left join matridx_jcsj jc_wlzlb on jc_wlzlb.csid=wlgl.wlzlb
		left join matridx_jcsj jc_wlzlbtc on jc_wlzlbtc.csid=wlgl.wlzlbtc
		left join matridx_jgxx jg_sqbm on jg_sqbm.jgid = qggl.sqbm
		left join matridx_jcsj jc_zlyq on jc_zlyq.csid=qgmx.yq
		
		left join igams_hwxx hwxx on qgmx.qgmxid=hwxx.qgmxid
		left join igams_ckhwxx ckhwxx on qgmx.wlid=ckhwxx.wlid
		where qgmx.qgid=#{qgid}
	</select>
	
	
	<update id="updateRksl" parameterType="List">

	<if test="list !=null and list.size > 0">
	<foreach collection="list" separator=";" item="item" index="index">
	update igams_qgmx
	<set>
		xgsj=LOCALTIMESTAMP
		<if test="item.addsl !=null and  item.addsl !=''">
			,rksl=COALESCE(rksl,0) + cast(#{item.addsl} as numeric)
		</if>
	</set>
		<where>
			qgmxid=#{item.qgmxid}
		</where>
	</foreach>
	</if>
	</update>
	<update id="updateRkslByIds" parameterType="List">
		<if test="list !=null and list.size > 0">
			<foreach collection="list" separator=";" item="item" index="index">
				update igams_qgmx
				<set>
					<trim prefixOverrides=",">
						<if test="item.rksladd != null and item.rksladd != ''">
							,rksl=COALESCE(rksl,0) + cast(#{item.rksl} as numeric)
						</if>
						<if test="item.rksldel != null and item.rksldel != ''">
							,rksl=COALESCE(rksl,0) - cast(#{item.rksl} as numeric)
						</if>
					</trim>
				</set>
				<where>
					qgmxid=#{item.qgmxid}
				</where>
			</foreach>
		</if>
	</update>
	<!-- 审核导出 -->
	<select id="getCountForAuditSearchExp" parameterType="QgmxDto"
			resultType="java.lang.Integer">
		SELECT COUNT(*) from  (SELECT COUNT(htmx.htmxid)
		FROM
		igams_qgmx mx
		LEFT JOIN  igams_htmx htmx ON htmx.qgmxid = mx.qgmxid AND htmx.scbj != '1'
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = mx.qgmxid
		LEFT JOIN igams_qggl qg ON mx.qgid = qg.qgid
		LEFT JOIN igams_htgl ht ON ht.htid = htmx.htid
		AND ht.zt = '80'
		AND ht.scbj = '0'
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = qg.qgid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj ON tj.ywid = qg.qgid
		LEFT JOIN (
		SELECT
		tmp1.ywid,
		string_agg ( tmp1.gwmc || '!' || tmp1.shsj, ',' ORDER BY tmp1.shsj ) AS temp1
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp1
		GROUP BY
		tmp1.ywid
		) tmp1 ON tmp1.ywid = ht.htid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj1 ON tj1.ywid = ht.htid
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = mx.wlid
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		LEFT JOIN matridx_xtyh fzr ON fzr.yhid = ht.fzr
		LEFT JOIN igams_gysxx gysxx ON gysxx.gysid = ht.gys
		left join matridx_jcsj jcsj on jcsj.csid = qg.qglb
		left join matridx_xtyh sqr on sqr.yhid = qg.sqr
		left join matridx_jgxx jgxx on jgxx.jgid = qg.sqbm
		left join matridx_jcsj jc_xmbm on jc_xmbm.csid=qg.xmbm
		left join matridx_jcsj jc_xmdl on jc_xmdl.csid=qg.xmdl
		<if test="(hwrkdh != null and hwrkdh != '') or (entire != null and entire != '')">
			LEFT JOIN (
			SELECT
			htmx.htmxid,
			string_agg ( DISTINCT rkgl.rkdh, ',' ) hwrkdh
			FROM
			igams_htmx htmx
			LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
			AND hwxx.scbj = '0'
			LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
			AND dhxx.scbj = '0'
			LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
			AND rkgl.scbj = '0'
			WHERE
			htmx.scbj != '1'
			GROUP BY
			htmx.htmxid
			) tab ON tab.htmxid = htmx.htmxid
		</if>
		<if test="fpwh != null and fpwh != ''">
			LEFT OUTER JOIN (
			SELECT
			htmx.htmxid,
			SUM ( fpmx.fpsl ) fpzsl
			FROM
			igams_htmx htmx
			LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
			AND fpmx.scbj = '0'
			LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
			AND fpgl.scbj = '0'
			AND fpgl.zt = '80'
			WHERE
			htmx.scbj = '0'
			GROUP BY
			htmx.htmxid
			) fp ON fp.htmxid = htmx.htmxid
		</if>
		WHERE
		jcsj.csdm != 'ADMINISTRATION'
		AND mx.scbj = '0'
		<include refid="AUDITEXP_SQL"></include>
		GROUP BY
		mx.qgmxid,
		htmx.htmxid,
		qg.djh,
		ht.htnbbh,
		qg.lrsj,
		tj.tjsj,
		ht.lrsj,
		tj1.tjsj,
		temp1,
		TEMP,
		wlgl.wlbm,
		wlgl.wlmc,
		htmx.ccdg,
		wlfl.csmc,
		fzr.zsxm,
		gysxx.gysmc,mx.hwmc)tpp
	</select>

	<select id="getListForAuditSearchExp" parameterType="QgmxDto" resultType="QgmxDto">
		SELECT
		htmx.htmxid  ${sqlParam}
		FROM
		igams_qgmx mx
		LEFT JOIN  igams_htmx htmx ON htmx.qgmxid = mx.qgmxid AND htmx.scbj != '1'
		LEFT JOIN ( SELECT qgmxid FROM igams_qgqxmx WHERE scbj = '0' AND qxsl IS NOT NULL GROUP BY qgmxid ) qxtmp ON qxtmp.qgmxid = mx.qgmxid
		LEFT JOIN igams_qggl qg ON mx.qgid = qg.qgid
		LEFT JOIN igams_htgl ht ON ht.htid = htmx.htid
		AND ht.zt = '80'
		AND ht.scbj = '0'
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = qg.qgid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj ON tj.ywid = qg.qgid
		LEFT JOIN (
		SELECT
		tmp1.ywid,
		string_agg ( tmp1.gwmc || '!' || tmp1.shsj, ',' ORDER BY tmp1.shsj ) AS temp1
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp1
		GROUP BY
		tmp1.ywid
		) tmp1 ON tmp1.ywid = ht.htid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj1 ON tj1.ywid = ht.htid
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = mx.wlid
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		LEFT JOIN matridx_xtyh fzr ON fzr.yhid = ht.fzr
		LEFT JOIN igams_gysxx gysxx ON gysxx.gysid = ht.gys
		left join matridx_jcsj jcsj on jcsj.csid = qg.qglb
		left join matridx_xtyh sqr on sqr.yhid = qg.sqr
		left join matridx_jgxx jgxx on jgxx.jgid = qg.sqbm
		left join matridx_jcsj jc_xmbm on jc_xmbm.csid=qg.xmbm
		left join matridx_jcsj jc_xmdl on jc_xmdl.csid=qg.xmdl
		<if test="(hwrkdh != null and hwrkdh != '')||(entire != null and entire != '')">
		LEFT JOIN (
		SELECT
		htmx.htmxid,
		string_agg ( DISTINCT rkgl.rkdh, ',' ) hwrkdh
		FROM
		igams_htmx htmx
		LEFT JOIN igams_hwxx hwxx ON hwxx.htmxid = htmx.htmxid
		AND hwxx.scbj = '0'
		LEFT OUTER JOIN igams_dhxx dhxx ON dhxx.dhid = hwxx.dhid
		AND dhxx.scbj = '0'
		LEFT OUTER JOIN igams_rkgl rkgl ON rkgl.rkid = hwxx.rkid
		AND rkgl.scbj = '0'
		WHERE
		htmx.scbj != '1'
		GROUP BY
		htmx.htmxid
		) tab ON tab.htmxid = htmx.htmxid
		</if>
		<if test="fpwh != null and fpwh != ''">
		LEFT OUTER JOIN (
		SELECT
		htmx.htmxid,
		SUM ( fpmx.fpsl ) fpzsl
		FROM
		igams_htmx htmx
		LEFT JOIN igams_fpmx fpmx ON fpmx.htmxid = htmx.htmxid
		AND fpmx.scbj = '0'
		LEFT JOIN igams_fpgl fpgl ON fpgl.fpid = fpmx.fpid
		AND fpgl.scbj = '0'
		AND fpgl.zt = '80'
		WHERE
		htmx.scbj = '0'
		GROUP BY
		htmx.htmxid
		) fp ON fp.htmxid = htmx.htmxid
		</if>
		WHERE
		jcsj.csdm != 'ADMINISTRATION'
		AND mx.scbj = '0'
		<include refid="AUDITEXP_SQL"></include>
		GROUP BY
		htmx.htmxid,
		qg.djh,
		ht.htnbbh,
		qg.lrsj,
		tj.tjsj,
		ht.lrsj,
		tj1.tjsj,
		temp1,
		TEMP,
		wlgl.wlbm,
		wlgl.wlmc,
		htmx.ccdg,
		wlfl.csmc,
		fzr.zsxm,
		gysxx.gysmc,
		qg.jlbh,
		mx.hwmc
		order by
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
		LIMIT #{pageSize} OFFSET #{pageStart}
	</select>

	<select id="getListForAuditSelectExp" parameterType="QgmxDto" resultType="QgmxDto">
		select htmx.htmxid ${sqlParam} from (
		<foreach item="item" index="index" collection="ids"
				 separator=" union all ">
			select #{item,jdbcType=VARCHAR} htmxid,#{index} ordernum
		</foreach>
		) tpp
		LEFT JOIN igams_htmx htmx ON htmx.htmxid = tpp.htmxid and htmx.scbj ='0'
		LEFT JOIN igams_htgl ht ON ht.htid = htmx.htid and ht.scbj ='0'
		LEFT JOIN igams_qgmx mx ON mx.qgmxid = htmx.qgmxid and mx.scbj ='0'
		left join igams_qggl qg on qg.qgid = mx.qgid and qg.scbj ='0'
		AND ht.zt = '80'
		AND ht.scbj = '0'
		LEFT JOIN (
		SELECT
		tmp.ywid,
		string_agg ( tmp.gwmc || '!' || tmp.shsj, ',' ORDER BY tmp.shsj ) AS TEMP
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp
		GROUP BY
		tmp.ywid
		) tmp ON tmp.ywid = qg.qgid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj ON tj.ywid = qg.qgid
		LEFT JOIN (
		SELECT
		tmp1.ywid,
		string_agg ( tmp1.gwmc || '!' || tmp1.shsj, ',' ORDER BY tmp1.shsj ) AS temp1
		FROM
		(
		SELECT
		gw.gwmc,
		MAX ( sh.shsj ) AS shsj,
		sh.ywid,
		SUM ( sh.lcxh ) AS lcxh
		FROM
		matridx_shxx sh
		LEFT JOIN matridx_spgw gw ON gw.gwid = sh.gwid
		WHERE
		( ( sh.sftg = '1' AND sh.gwid IS NOT NULL ) OR ( sh.sftg IS NULL ) )
		GROUP BY
		sh.lcxh,
		gw.gwmc,
		sh.ywid
		) tmp1
		GROUP BY
		tmp1.ywid
		) tmp1 ON tmp1.ywid = ht.htid
		LEFT JOIN ( SELECT ywid, MAX ( shsj ) tjsj FROM matridx_shxx WHERE lcxh IS NULL AND sftg IS NULL GROUP BY ywid ) tj1 ON tj1.ywid = ht.htid
		LEFT JOIN igams_wlgl wlgl ON wlgl.wlid = mx.wlid
		LEFT JOIN matridx_jcsj wlfl ON wlfl.csid = htmx.wlfl
		LEFT JOIN matridx_xtyh fzr ON fzr.yhid = ht.fzr
		LEFT JOIN igams_gysxx gysxx ON gysxx.gysid = ht.gys
		left join matridx_jcsj jcsj on jcsj.csid = qg.qglb
		left join matridx_xtyh sqr on sqr.yhid = qg.sqr
		left join matridx_jgxx jgxx on jgxx.jgid = qg.sqbm
		left join matridx_jcsj jc_xmbm on jc_xmbm.csid=qg.xmbm
		left join matridx_jcsj jc_xmdl on jc_xmdl.csid=qg.xmdl
		WHERE
		jcsj.csdm != 'ADMINISTRATION'
		AND qg.scbj = '0'
		GROUP BY
		htmx.htmxid,
		qg.djh,
		ht.htnbbh,
		qg.lrsj,
		tj.tjsj,
		ht.lrsj,
		tj1.tjsj,
		temp1,
		TEMP,
		tpp.ordernum,
		wlgl.wlbm,
		wlgl.wlmc,
		htmx.ccdg,
		wlfl.csmc,
		fzr.zsxm,
		gysxx.gysmc,
		mx.hwmc
		ORDER BY
		tpp.ordernum
	</select>
	<sql id="AUDITEXP_SQL">
		<if test="entire != null and entire != ''">
			and (
			wlgl.wlmc ILIKE '%'||#{entire}||'%'
			or qg.djh ILIKE '%'||#{entire}||'%'
			or wlgl.wlbm ILIKE '%'||#{entire}||'%'
			or ht.htnbbh ILIKE '%'||#{entire}||'%'
			or tab.hwrkdh ILIKE '%'||#{entire}||'%'
			)
		</if>
		<if test="qglx != null and qglx != ''">
			and qg.qglx=#{qglx}
		</if>
		<if test="ccdg != null and ccdg != ''">
			and htmx.ccdg=#{ccdg}
		</if>
		<if test="wlmc != null and wlmc != ''">
			and wlgl.wlmc ILIKE '%'||#{wlmc}||'%'
		</if>
		<if test="wlbm != null and wlbm != ''">
			and wlgl.wlbm ILIKE '%'||#{wlbm}||'%'
		</if>
		<if test="djh != null and djh != ''">
			and qg.djh ILIKE '%'||#{djh}||'%'
		</if>
		<if test = "qgshzts != null and qgshzts.length > 0 "  >
			and qg.zt in
			<foreach collection="qgshzts" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "qglbs != null and qglbs.length > 0 "  >
			and qg.qglb in
			<foreach collection="qglbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "wlfls != null and wlfls.length > 0 "  >
			and htmx.wlfl in
			<foreach collection="wlfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="htnbbh != null and htnbbh != ''">
			and ht.htnbbh ILIKE '%'||#{htnbbh}||'%'
		</if>
		<if test="hwrkdh != null and hwrkdh != ''">
			and tab.hwrkdh ILIKE '%'||#{hwrkdh}||'%'
		</if>
		<if test="qxqg != null and qxqg == '0'.toString">
			and qxtmp.qgmxid IS NULL
		</if>
		<if test="qxqg != null and qxqg == '1'.toString">
			and qqxtmp.qgmxid IS NOT NULL
		</if>
		<if test="sqsjstart != null and sqsjstart != ''">
			and to_char(qg.sqrq,'yyyy-mm-dd') &gt;= #{sqsjstart}
		</if>
		<if test="sqsjend != null and sqsjend != ''">
			and to_char(qg.sqrq,'yyyy-mm-dd') &lt;= #{sqsjend}
		</if>
		<if test="jhdhsjstart != null and jhdhsjstart != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &gt;= #{jhdhsjstart}
		</if>
		<if test="jhdhsjend != null and jhdhsjend != ''">
			and to_char(htmx.jhdhrq,'yyyy-mm-dd') &lt;= #{jhdhsjend}
		</if>
		<if test="dhsjstart != null and dhsjstart != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &gt;= #{dhsjstart}
		</if>
		<if test="dhsjend != null and dhsjend != ''">
			and to_char(htmx.dhrq,'yyyy-mm-dd') &lt;= #{dhsjend}
		</if>
		<if test="htbj != null and htbj == '0'.toString">
			and ht.htnbbh is null or trim(ht.htnbbh)=''
		</if>
		<if test="hwbj != null and hwbj == '0'.toString">
			and htmx.dhsl is null or htmx.dhsl=0
		</if>
		<if test="htbj != null and htbj == '1'.toString">
			and trim(ht.htnbbh)!=''
		</if>
		<if test="hwbj != null and hwbj == '1'.toString">
			and htmx.dhsl =htmx.sl
		</if>
		<if test="hwbj != null and hwbj == '2'.toString">
			and htmx.dhsl is not null and htmx.dhsl!=0 and htmx.sl!=htmx.dhsl
		</if>
		<if test="qgshtgsjstart != null and qgshtgsjstart != ''">
			and to_char(qg.shsj,'yyyy-MM-dd HH24:mi')&gt;= #{qgshtgsjstart}
		</if>
		<if test="qgshtgsjend != null and qgshtgsjend != ''">
			and to_char(qg.shsj,'yyyy-MM-dd HH24:mi') &lt;= #{qgshtgsjend}
		</if>
		<if test="fpwh != null and fpwh == '0'.toString">
			and fp.fpzsl is null
		</if>
		<if test="fpwh != null and fpwh == '1'.toString">
			and fp.fpzsl &lt; htmx.sl and fp.fpzsl &gt; 0
		</if>
		<if test="fpwh != null and fpwh == '2'.toString">
			and fp.fpzsl = htmx.sl
		</if>
		<if test="sfqdht != null and sfqdht == '0'.toString">
			and htmx.htmxid is null
		</if>
		<if test="sfqdht != null and sfqdht == '1'.toString">
			and htmx.htmxid is not null
		</if>
		<if test="sfjsdh != null and sfjsdh == '0'.toString">
			and htmx.jhdhrq &lt; htmx.dhrq
		</if>
		<if test="sfjsdh != null and sfjsdh == '1'.toString">
			and htmx.jhdhrq &gt;= htmx.dhrq
		</if>
	</sql>

	<select id="queryByKcxx" parameterType="QgmxDto" resultType="QgmxDto">
		select wl.wlbm,wl.wlmc,wl.gg,mx.qgmxid,ckhw.ckhwid,mx.sl,coalesce(ckhw.kcl,0) as kcl,coalesce (ckhw.kcl,0)-coalesce (ckhw.yds,0) as klsl,mx.bz,mx.xh,ckxx.ckmc
		from igams_qgmx mx
		left join igams_hwxx hw on hw.qgmxid=mx.qgmxid and hw.zt='99' and hw.scbj='0'
		left join igams_wlgl wl on wl.wlid=mx.wlid
		left join igams_ckhwxx ckhw on ckhw.wlid = hw.wlid and ckhw.ckid=hw.ckid
		left join igams_ckxx ckxx on ckxx.ckid=ckhw.ckid
		where  mx.scbj='0' and mx.qgid=#{qgid}
		group by wl.wlbm,wl.wlmc,wl.gg,mx.qgmxid,ckhw.ckhwid,mx.sl,ckhw.kcl,ckhw.yds,mx.bz,mx.xh,ckxx.ckmc
		order by mx.xh
	</select>
</mapper>
