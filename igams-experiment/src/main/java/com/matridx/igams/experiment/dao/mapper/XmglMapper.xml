<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.experiment.dao.post.IXmglDao" >

	<!-- 增加项目 -->
	<insert id="insert" parameterType="XmglModel">
		insert into igams_xmgl(xmid
		<if test="fxmid !=null and fxmid != ''">
			,fxmid
		</if>
		<if test="dcmc !=null and dcmc != ''">
			,dcmc
		</if>
		<if test="xmdm !=null and xmdm != ''">
			,xmdm
		</if>
		<if test="mbid !=null and mbid != ''">
			,mbid
		</if>
		<if test="xmtb !=null and xmtb != ''">
			,xmtb
		</if>
		<if test="xmmc !=null and xmmc != ''">
			,xmmc
		</if>
		<if test="xmlb !=null and xmlb != ''">
			,xmlb
		</if>
		<if test="xmlx !=null and xmlx != ''">
			,xmlx
		</if>
		<if test="kssj !=null and kssj != ''">
			,kssj
		</if>
		<if test="dqjd !=null and dqjd != ''">
			,dqjd
		</if>
		<if test="xmfz !=null and xmfz != ''">
			,xmfz
		</if>
		<if test="xmgkx !=null and xmgkx != ''">
			,xmgkx
		</if>
		<if test="cjms !=null and cjms != ''">
			,cjms
		</if>
		<if test="qwwcsj !=null and qwwcsj != ''">
			,qwwcsj
		</if>
		<if test="sjwcsj !=null and sjwcsj != ''">
			,sjwcsj
		</if>
		<if test="zt !=null and zt != ''">
			,zt
		</if>
		<if test="bz !=null and bz != ''">
			,bz
		</if>
		<if test="xmys !=null and xmys != ''">
			,xmys
		</if>
		,lrry,lrsj,scbj) values(#{xmid}
		<if test="fxmid !=null and fxmid != ''">
			,#{fxmid}
		</if>
		<if test="dcmc !=null and dcmc != ''">
			,#{dcmc}
		</if>
		<if test="xmdm !=null and xmdm != ''">
			,#{xmdm}
		</if>
		<if test="mbid !=null and mbid !=''">
			,#{mbid}		
		</if>
		<if test="xmtb !=null and xmtb != ''">
			,#{xmtb}
		</if>
		<if test="xmmc !=null and xmmc != ''">
			,#{xmmc}
		</if>
		<if test="xmlb !=null and xmlb != ''">
			,#{xmlb}
		</if>
		<if test="xmlx !=null and xmlx != ''">
			,#{xmlx}
		</if>
		<if test="kssj !=null and kssj != ''">
			,cast(#{kssj} as timestamp)
		</if>
		<if test="dqjd !=null and dqjd != ''">
			,#{dqjd}
		</if>
		<if test="xmfz !=null and xmfz != ''">
			,#{xmfz}
		</if>
		<if test="xmgkx !=null and xmgkx != ''">
			,#{xmgkx}
		</if>
		<if test="qwwcsj !=null and qwwcsj != ''">
			,cast(#{qwwcsj} as timestamp)
		</if>
		<if test="sjwcsj !=null and sjwcsj != ''">
			,cast(#{sjwcsj} as timestamp)
		</if>
		<if test="zt !=null and zt != ''">
			,#{zt}
		</if>
		<if test="bz !=null and bz != ''">
			,#{bz}
		</if>
		<if test="xmys !=null and xmys != ''">
			,#{xmys}
		</if>
		,#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	<!--更新项目信息-->
	<update  id="update" parameterType="XmglModel">
		update igams_xmgl 
		<set>
		<if test="fxmid !=null and fxmid != ''">
			fxmid = #{fxmid},
		</if>
		<if test="dcmc !=null and dcmc != ''">
			dcmc = #{dcmc},
		</if>
		<if test="xmdm !=null and xmdm != ''">
			xmdm = #{xmdm},
		</if>
		<if test="mbid !=null and mbid !=''">
			mbid = #{mbid},		
		</if>
		<if test="xmtb !=null and xmtb != ''">
			xmtb = #{xmtb},
		</if>
		<if test="xmmc !=null and xmmc != ''">
			xmmc = #{xmmc},
		</if>
		<if test="xmlb !=null and xmlb != ''">
			xmlb = #{xmlb},
		</if>
		<if test="xmlx !=null and xmlx != ''">
			xmlx = #{xmlx},
		</if>
		<if test="kssj !=null and kssj != ''">
			kssj = cast(#{kssj} as timestamp),
		</if>
		<if test="dqjd !=null and dqjd != ''">
			dqsj = #{dqjd},
		</if>
		<if test="xmfz !=null and xmfz != ''">
			xmfz = #{xmfz},
		</if>
		<if test="xmgkx !=null and xmgkx != ''">
			xmgkx = #{xmgkx},
		</if>
		<if test="qwwcsj !=null and qwwcsj != ''">
			qwwcsj = cast(#{qwwcsj} as timestamp),
		</if>
		<if test="sjwcsj !=null and sjwcsj != ''">
			sjwcsj = cast(#{sjwcsj} as timestamp),
		</if>
		<if test="zt !=null and zt != ''">
			zt = #{zt},
		</if>
		<if test="bz !=null and bz != ''">
			bz = #{bz},
		</if>
		<if test="xmys !=null and xmys != ''">
			xmys = #{xmys},
		</if>
			xgsj = LOCALTIMESTAMP,
			xgry = #{xgry}
		</set>
		<where>
			xmid = #{xmid}
		</where>
	</update>
	
	<!-- 查询个人项目列表 -->
	<select id="getPersionDtoList" parameterType="XmglDto" resultType="XmglDto">
		select  xm.xmid,xm.fxmid,xm.xmmc,xm.xmlb,xm.xmtb,xm.xmys
		from igams_xmgl xm
		<where>
			scbj = '0'
			<if test="fxmid !=null and fxmid != ''">
				and xm.fxmid = #{fxmid}
			</if>
			<if test="fxmid == null or fxmid == ''">
				and xm.fxmid is null
			</if>
			<if test="yhid != null and yhid != ''">
				and ((exists (select xmcy.yhid from igams_xmcy xmcy where xmcy.yhid = #{yhid} and xm.xmid = xmcy.xmid))
						<if test = "xmgkxs != null and xmgkxs.size > 0">
							or xm.xmgkx in 
							<foreach collection="xmgkxs" separator="," open="(" close=")" item="item" index="index">
								#{item}
							</foreach>
						</if>)
			</if>
		</where>
	</select>
	<!-- 删除项目信息 -->
	<update  id="deleteByXmid" parameterType="XmglDto">
		with recursive t(xmid) as (
		select firstxm.xmid
			from igams_xmgl firstxm where firstxm.xmid=#{xmid} and firstxm.scbj = '0' 
		  union all
			select xmgl.xmid
			from igams_xmgl xmgl
			inner join t on xmgl.fxmid = t.xmid
			 where xmgl.scbj = '0'
			)
		update igams_xmgl set
			scbj = '2'
			where xmid in (select xmid from t)
	</update>
	<!-- 根据项目ID获取文件信息 -->
	<select id="getDto" parameterType="XmglDto" resultType="XmglDto">
		select xm.xmid,xm.fxmid,xm.dcmc,xm.xmdm,xm.mbid,xm.xmtb,xm.xmmc,xm.xmlb,xm.xmlx,xm.kssj,xm.dqjd,xm.xmfz,xm.xmgkx,
		xm.cjms,xm.qwwcsj,xm.sjwcsj,xm.zt,xm.bz,xm.lrry,xm.lrsj,xm.xgry,xm.xgsj,xm.scry,xm.scsj,xm.scbj,xm.xmys
			from igams_xmgl xm
			<where>
				<if test="xmid != null and xmid != ''">
					and xm.xmid = #{xmid}
				</if>
				<if test="fxmid != null and fxmid != ''">
					and xm.fxmid = #{fxmid}
				</if>
			</where>
	</select>
	<!-- 根据项目ID获取文件信息 -->
	<select id="getDtoById" parameterType="String" resultType="XmglDto">
		select xm.xmid,xm.fxmid,xm.dcmc,xm.xmdm,xm.mbid,xm.xmtb,xm.xmmc,xm.xmlb,xm.xmlx,xm.kssj,xm.dqjd,xm.xmfz,xm.xmgkx,
		xm.cjms,xm.qwwcsj,xm.sjwcsj,xm.zt,xm.bz,xm.lrry,xm.lrsj,xm.xgry,xm.xgsj,xm.scry,xm.scsj,xm.scbj,xm.xmys
			from igams_xmgl xm
			<where>
				xm.scbj = '0'
				and xm.xmid = #{xmid}
			</where>
	</select>
	<!--根据项目ID修改父项目ID-->
	<update  id="updateFxmid" parameterType="XmglDto">
		update igams_xmgl 
		<set>
			fxmid = #{fxmid},
			xgsj = LOCALTIMESTAMP,
			xgry = #{xgry}
		</set>
		where xmid = #{xmid}
	</update>
	<!-- 查询全部项目列表 -->
	<select id="getPublicDtoList" parameterType="XmglDto" resultType="XmglDto">
		select  xm.xmid,xm.fxmid,xm.xmmc,xm.xmlb,xm.xmtb,xm.xmys
		from igams_xmgl xm
		<where>
			scbj = '0'
			<if test="fxmid !=null and fxmid != ''">
				and xm.fxmid = #{fxmid} 
			 </if>
				<if test="fxmid == null or fxmid == ''">
					and xm.fxmid is null
				</if>
				and ((exists (select xmcy.yhid from igams_xmcy xmcy where xmcy.yhid = #{yhid} and xm.xmid = xmcy.xmid))
						<if test = "xmgkxs != null and xmgkxs.size > 0">
							or xm.xmgkx in 
							<foreach collection="xmgkxs" separator="," open="(" close=")" item="item" index="index">
								#{item}
							</foreach>
						</if>)
						
		</where>
	</select>
	<!-- 根据输入内容查询系统用户信息 -->
	<select id="selectXtyh" parameterType="XmglDto" resultType="XmglDto">
	select yhid,yhm,zsxm from matridx_xtyh
	<where>
		scbj!='1' 
		<if test="zsxm !=null and zsxm != ''">
		 and zsxm like '%'||#{zsxm}||'%'
		 </if>
	</where>
	</select>
	<!-- 删除项目信息 -->
	<update  id="completeDelProject" parameterType="XmglDto">
		with recursive t(xmid) as (
		select firstxm.xmid
			from igams_xmgl firstxm where firstxm.xmid=#{xmid} and firstxm.scbj = '2'
		  union all
			select xmgl.xmid
			from igams_xmgl xmgl
			inner join t on xmgl.fxmid = t.xmid
			 where xmgl.scbj = '2'
			)
		update igams_xmgl set
			scbj = '1'
			where xmid in (select xmid from t)
	</update>
	<!-- 还原项目信息 -->
	<update  id="recoverProject" parameterType="XmglDto">
		with recursive t(xmid) as (
		select firstxm.xmid
			from igams_xmgl firstxm where firstxm.xmid=#{xmid} and firstxm.scbj = '2' 
		  union all
			select xmgl.xmid
			from igams_xmgl xmgl
			inner join t on xmgl.fxmid = t.xmid
			 where xmgl.scbj = '2'
			)
		update igams_xmgl set
			scbj = '0'
			where xmid in (select xmid from t)
	</update>
	<!-- 还原项目信息到根目录 -->
	<update  id="recoverProjecPath" parameterType="XmglDto">
		update igams_xmgl set
			fxmid = null
			where xmid = #{xmid}
	</update>
	<!-- 根据项目ID查询父项目信息 -->
	<select id="selectProjectStatus" parameterType="XmglDto" resultType="XmglDto">
		WITH RECURSIVE r(xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,depth) AS (
			SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,1 as depth FROM igams_xmgl WHERE xmid= #{xmid} and scbj = '0'
				union   ALL
			SELECT t.xmid,t.fxmid,t.dcmc,t.xmdm,t.mbid,t.xmtb,t.xmmc,t.xmlb,t.xmlx,t.kssj,t.dqjd,t.xmfz,t.xmgkx,
			t.cjms,t.qwwcsj,t.sjwcsj,t.zt,t.bz,t.lrry,t.lrsj,t.xgry,t.xgsj,t.scry,t.scsj,t.scbj,t.xmys,r.depth + 1 as depth FROM igams_xmgl t, r WHERE t.xmid = r.fxmid and t.scbj = '0' and r.scbj = '0'
			)
		SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,depth FROM r where scbj = '0' ORDER BY depth
	</select>
	<!-- 修改父项目为公开状态 -->
	<update  id="updateFxmOpenness" parameterType="XmglDto">
		WITH RECURSIVE r(xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys) AS (
			SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys FROM igams_xmgl WHERE xmid= #{xmid} and scbj = '0'
				union   ALL
			SELECT t.xmid,t.fxmid,t.dcmc,t.xmdm,t.mbid,t.xmtb,t.xmmc,t.xmlb,t.xmlx,t.kssj,t.dqjd,t.xmfz,t.xmgkx,
			t.cjms,t.qwwcsj,t.sjwcsj,t.zt,t.bz,t.lrry,t.lrsj,t.xgry,t.xgsj,t.scry,t.scsj,t.scbj,t.xmys FROM igams_xmgl t, r WHERE t.xmid = r.fxmid and t.scbj = '0' and r.scbj = '0'
			)
		update igams_xmgl set xmgkx = #{xmgkx} 
		where xmid in (select xmid from r) and scbj = '0'
	</update>
	<!-- 通过项目ID查询子项目列表 -->
	<select id="selectByFxmid" parameterType="XmglDto" resultType="XmglDto">
		select xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,cjms,qwwcsj,sjwcsj,zt,bz,
				lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys 
			from igams_xmgl
		<where>
			scbj ='0' and fxmid = #{xmid}
		</where>
	</select>
	<!-- 查询未彻底删除子项目信息 -->
	<select id="selectAllZxm" parameterType="XmglDto" resultType="XmglDto">
		select xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,cjms,qwwcsj,sjwcsj,zt,bz,
				lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys 
			from igams_xmgl
		<where>
			scbj != '1' and fxmid = #{xmid}
		</where>
	</select>
	<!-- 修改项目为私有状态 -->
	<update  id="updateToPrivate" parameterType="XmglDto">
		update igams_xmgl set
			xmgkx = #{xmgkx}
		where xmid = #{xmid}
	</update>
	<!-- 根据项目ID查询父项目目录 -->
	<select id="selectcatalogue" parameterType="XmglDto" resultType="XmglDto">
		WITH RECURSIVE r(xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,depth) AS (
			SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,1 as depth FROM igams_xmgl WHERE xmid= #{xmid} and scbj = '0'
				union   ALL
			SELECT t.xmid,t.fxmid,t.dcmc,t.xmdm,t.mbid,t.xmtb,t.xmmc,t.xmlb,t.xmlx,t.kssj,t.dqjd,t.xmfz,t.xmgkx,
			t.cjms,t.qwwcsj,t.sjwcsj,t.zt,t.bz,t.lrry,t.lrsj,t.xgry,t.xgsj,t.scry,t.scsj,t.scbj,t.xmys,r.depth + 1 as depth FROM igams_xmgl t, r WHERE t.xmid = r.fxmid and t.scbj = '0' and r.scbj = '0'
			)
		SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,depth FROM r where scbj = '0' ORDER BY depth  desc
	</select>
	<!-- 判断当前用户能否删除文件 -->
	<select id="delPermission" parameterType="XmglDto" resultType="XmglDto">
		WITH RECURSIVE r(xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,depth) AS (
			SELECT xmid,fxmid,dcmc,xmdm,mbid,xmtb,xmmc,xmlb,xmlx,kssj,dqjd,xmfz,xmgkx,
			cjms,qwwcsj,sjwcsj,zt,bz,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,xmys,1 as depth FROM igams_xmgl WHERE xmid= #{xmid} and scbj = '0'
				union   ALL
			SELECT t.xmid,t.fxmid,t.dcmc,t.xmdm,t.mbid,t.xmtb,t.xmmc,t.xmlb,t.xmlx,t.kssj,t.dqjd,t.xmfz,t.xmgkx,
			t.cjms,t.qwwcsj,t.sjwcsj,t.zt,t.bz,t.lrry,t.lrsj,t.xgry,t.xgsj,t.scry,t.scsj,t.scbj,t.xmys,r.depth + 1 as depth FROM igams_xmgl t, r WHERE t.fxmid = r.xmid and t.scbj = '0' and r.scbj = '0'
			)
		SELECT xm.xmid FROM r xm
			left join igams_xmcy cy on xm.xmid = cy.xmid  and cy.yhid=#{scry}
			where xm.scbj = '0' and cy.xmid is null
	</select>
	<!-- 查询是否存在相同名称的项目 -->
	<select id="selectXmByXmmc" parameterType="XmglDto" resultType="XmglDto">
	select  xm.xmid,xm.fxmid,xm.xmmc,xm.xmlb,xm.xmtb,xm.xmys
		from igams_xmgl xm
		<where>
		xm.scbj!='1'
		and xm.xmmc=#{xmmc}
		</where>
	</select>
</mapper>
