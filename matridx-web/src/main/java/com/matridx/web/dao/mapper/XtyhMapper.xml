<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.web.dao.post.IXtyhDao" >
	<!-- 根据用户id查询用户信息 -->
	<select id="getDtoById" parameterType="java.lang.String" resultType="XtyhDto">
		select yh.yhid,yh.yhm,yh.zsxm,yh.mm,yh.sfsd,yh.dqjs,yh.dlip,yh.dlsj,yh.lrry,yh.lrsj,yh.xgry,yh.xgsj,yh.scry,yh.scsj,yh.scbj,yh.ddid,yh.wechatid,yh.gwmc,
		js.jsmc dqjsmc,js.jsdm dqjsdm,ssjg.jgid
		from matridx_xtyh yh
		left outer join matridx_xtjs js on yh.dqjs = js.jsid
		left outer join matridx_yhssjg ssjg on yh.yhid = ssjg.yhid
		 where yh.yhid =#{yhid}
	</select>

	<!-- 根据用户id查询用户信息包含部门信息 -->
	<select id="getPersonalData" parameterType="XtyhDto" resultType="XtyhDto">
		select yh.yhid,yh.yhm,yh.zsxm,yh.mm,yh.sfsd,yh.dqjs,yh.dlip,yh.dlsj,yh.lrry,yh.lrsj,yh.xgry,yh.xgsj,yh.scry,yh.scsj,yh.scbj,yh.ddid,yh.wechatid,yh.gwmc,yhssjg.jgid,jgxx.jgmc
		from matridx_xtyh yh
		left outer join matridx_yhssjg yhssjg
		on yh.yhid = yhssjg.yhid
		left outer join matridx_jgxx jgxx
		on yhssjg.jgid=jgxx.jgid
	    where yh.yhid =#{yhid}
	</select>
	<!-- 根据用户名查询用户信息 -->
	<select id="getDtoByYhm" parameterType="XtyhDto" resultType="XtyhDto">
		select yhid,yhm,zsxm,mm,sfsd,dqjs,dlip,dlsj,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,ddid,wechatid,gwmc
		from matridx_xtyh
		<where>
			scbj!='1'
			<if test="yhm != null and yhm != ''">
				and yhm =#{yhm}
			</if>
			<if test="yhid != null and yhid != ''">
				and yhid!=#{yhid}
			</if>
		</where>
	</select>
	<!-- 查询所有的机构名称 -->
	<select id="getJgmc"  resultType="XtyhDto">
		select jgid,jgmc from matridx_jgxx
	</select>

	<!-- 更新用户的部门信息 -->
	<update  id="updateJg" parameterType="XtyhDto">
		update matridx_yhssjg set jgid = (select jgid from matridx_jgxx where jgmc=#{jgmc}) where yhid=#{yhid}
	</update>
	
	<!-- 根据用户id查询用户信息 -->
	<select id="getDto" parameterType="XtyhDto" resultType="XtyhDto">
		select yhid,yhm,zsxm,mm,sfsd,dqjs,dlip,dlsj,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,ddid,wechatid,gwmc from matridx_xtyh where yhid =#{yhid} and scbj = '0'
	</select>
	
	<!-- 根据用户名查询用户信息 -->
	<select id="getDtoByName" parameterType="java.lang.String" resultType="XtyhDto">
		select yhid,yhm,zsxm,mm,sfsd,dqjs,dlip,dlsj,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,ddid,wechatid,gwmc,cwcs from matridx_xtyh where yhm =#{yhm} and scbj = '0'
	</select>
	
	<!-- 根据token查询用户信息 -->
	<select id="getDtoByToken" parameterType="java.lang.String" resultType="XtyhDto">
		select yh.yhid,yh.yhm,yh.zsxm,mm,yh.sfsd,yh.dqjs,yh.dlip,yh.dlsj,yh.lrry,yh.lrsj,yh.xgry,yh.xgsj,yh.scry,yh.scsj,yh.scbj,yh.ddid,yh.wechatid,yh.gwmc 
		from matridx_xtyh yh
		left outer join oauth_access_token token on yh.yhm = token.user_name
		where token_id =#{token_id}
	</select>
	
	<!-- 查询用户列表 -->
	<select id="getPagedDtoList" parameterType="XtyhDto" resultType="XtyhDto">
		select yh.yhid,yh.yhm,yh.zsxm,yh.mm,yh.sfsd,yh.dqjs,yh.dlip,to_char(yh.dlsj,'yyyy-MM-dd HH24:mi') dlsj ,yh.lrry,to_char(yh.lrsj,'yyyy-MM-dd HH24:mi') lrsj ,yh.xgry,yh.xgsj,yh.scry,yh.scsj,yh.scbj,yh.ddid,yh.wechatid,yh.gwmc,js.jsmc dqjsmc
		from matridx_xtyh yh
		left outer join matridx_xtjs js on yh.dqjs = js.jsid
		<where>
			yh.scbj='0'
			<if test="yhid != null and yhid != ''">
				and yh.yhid = #{yhid}
			</if>
			<if test="yhm != null and yhm != ''">
				and yh.yhm like '%'||#{yhm}||'%'
			</if>
			<if test="zsxm != null and zsxm != ''">
				and yh.zsxm like '%'||#{zsxm}||'%'
			</if>
			<if test="entire != null and entire != ''">
				and ( yh.yhm like '%'||#{entire}||'%'
				or yh.zsxm like '%'||#{entire}||'%')
			</if>
		</where>
	</select>

	<!-- 根据用户名查询用户信息 -->
	<select id="getUserByName" parameterType="java.lang.String" resultType="User">
		select yhid,yhm,zsxm,mm,sfsd,cwcs,dqjs,dlip,dlsj,lrry,lrsj,xgry,xgsj,scry,scsj,scbj,
		ddid,wechatid,gwmc,coalesce(cwcs,0) cwcs,sdtime,jstime,mmxgsj
		from matridx_xtyh
		where yhm =#{yhm}
		and scbj!='1'
	</select>
	<!-- 更新系统用户登录时间 -->
	<update id="updateLastLogin" parameterType="XtyhModel">
		update matridx_xtyh set dlsj = LOCALTIMESTAMP,dlip =#{dlip} where yhid =#{yhid}
	</update>
	
	<!-- 更新用户密码和初始化用户密码 -->
	<update id="updatePass" parameterType="XtyhDto">
		update matridx_xtyh set mm = #{mm},xgsj=LOCALTIMESTAMP,mmxgsj=LOCALTIMESTAMP,xgry = #{xgry} where yhid =#{yhid}
	</update>
	
	<!-- 更新用户密码 -->
	<update id="updateOauthClinetId" parameterType="XtyhDto">
		update oauth_client_details set client_id = #{yhm} where client_id =#{yyhm}
	</update>
	
	<!-- 更新用户ID -->
	<update id="updateOauthPass" parameterType="XtyhDto">
		update oauth_client_details set client_secret = #{mm} where client_id =#{yhm}
	</update>
	
	<!-- 插入系统用户信息 -->
	<insert id="insert" parameterType="XtyhModel">
		insert into matridx_xtyh(yhid,yhm,zsxm,mm,sfsd
		,lrry,lrsj,scbj) values(#{yhid},#{yhm},#{zsxm},#{mm},#{sfsd}
		,#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	<!-- 更新系统用户信息 --> 
	<update  id="update" parameterType="XtyhModel">
		update matridx_xtyh set 
		xgry = #{xgry},xgsj = LOCALTIMESTAMP
		<if test="yhm !=null and yhm != ''">
			,yhm = #{yhm}
		</if>
		<if test="zsxm !=null and zsxm != ''">
			,zsxm = #{zsxm}
		</if>
		<if test="sfsd !=null and sfsd != ''">
			,sfsd = #{sfsd}
		</if>
		<if test="dqjs !=null and dqjs != ''">
			,dqjs = #{dqjs}
		</if>
		<if test="dlip !=null and dlip != ''">
			,dlip = #{dlip}
		</if>
		<if test="dlsj !=null and dlsj != ''">
			,dlsj = #{dlsj}
		</if>
		<if test="cwcs !=null and cwcs != ''">
			,cwcs = cast(#{cwcs} as numeric)
		</if>
		<where>
			yhid = #{yhid}
		</where>
	</update>
	
	<!-- 删除系统用户信息 -->
	<update  id="delete" parameterType="XtyhModel">
		update matridx_xtyh set scbj ='1',
		scry = #{scry},scsj = LOCALTIMESTAMP
		<where>
			<if test="ids !=null and ids.size > 0">
	        	or yhid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="yhid !=null and yhid != ''">
	        	or yhid = #{yhid}
			</if>
		</where>
	</update>
	
	<!-- 增加用户信息 -->
	<insert  id="addClientDetails" parameterType="XtyhDto">
		insert into oauth_client_details (
		client_secret, scope, authorized_grant_types,  client_id) 
		values (#{mm},'all','client_credentials,refresh_token,password,matridx',#{yhm})
	</insert>
	
	<!-- 通过ID删除oauth_access_token中用户 -->
	<delete id="deleteOauthAccessById" parameterType="java.lang.String">
		delete from oauth_access_token where client_id =#{yhm}
	</delete>
	
	<!-- 查询用户列表 -->
	<select id="getUserList"  resultType="XtyhDto">
		select yh.yhid,yh.yhm,yh.zsxm,yh.mm,yh.sfsd,yh.dqjs,yh.dlip,yh.dlsj,yh.lrry,yh.lrsj,yh.xgry,yh.xgsj,yh.scry,yh.scsj,yh.scbj,yh.ddid,yh.wechatid,yh.gwmc,yhjs.jsid
		from matridx_xtyh yh
		left outer join matridx_yhjs yhjs on yh.yhid = yhjs.yhid
		<where>
			yh.scbj='0'
		</where>
	</select>
	
	<!-- 更新用户钉钉信息 -->
	<update id="updateDingDing" parameterType="XtyhDto">
		update matridx_xtyh set xgsj=LOCALTIMESTAMP,
		<if test="ddid !=null and ddid != ''">
			ddid = #{ddid},
		</if>
		<if test="gwmc !=null and gwmc != ''">
			gwmc = #{gwmc},
		</if>
		xgry = #{xgry} where yhid =#{yhid}
	</update>
	
	<!-- 更新系统用户登录信息 --> 
	<update  id="updateLoginInfo" parameterType="XtyhModel">
		update matridx_xtyh set cwcs = cast(#{cwcs} as numeric)
		<if test="sfsd !=null and sfsd != ''">
            ,sfsd = #{sfsd}
        </if>
		,xgry = #{xgry},xgsj = LOCALTIMESTAMP
		<where>
			yhm = #{yhm}
		</where>
	</update>
	
	<!--查询所有用户信息-->
	<select id="getUsersList" resultType="User">
		select yh.yhid,yh.yhm,yh.zsxm,yh.mm,yh.sfsd,yh.sdtime,yh.jstime,yh.ddid,yh.gwmc,yh.scbj,yh.mmxgsj,yh.dqjs,yh.ddtxlj,yh.email,yh.unionid
		from matridx_xtyh yh
		where yh.scbj !='1'
	</select>


	<select id="getWbaqUsersList" resultType="User">
		select deta.client_id,deta.client_id yhm,deta.client_secret mm,wbaqyz.mc zsxm  FROM
			oauth_client_details deta
		left join matridx_wbaqyz wbaqyz on wbaqyz.code=deta.client_id
		where deta.client_id not in (select yhm from matridx_xtyh where scbj ='0' and sfsd ='0')
		  and deta.client_id  not in (select wxyh.wechatid from matridx_xtyh wxyh where  wechatid is not null)
		  and SPLIT_PART(deta.client_id, '@', 1) not in (select ddid from matridx_xtyh dyh  WHERE ddid is not null  )
		  and wbaqyz.code is not null
	</select>
</mapper>
