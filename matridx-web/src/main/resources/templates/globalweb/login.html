<!DOCTYPE html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	    <title th:text="${title}"></title>
	    <link rel="stylesheet" href="/css/element-ui.css">
	    <link rel="stylesheet" href="/css/loginbase.css">
	    <link rel="stylesheet" href="/css/home.css">
	    <link rel="stylesheet" href="/css/animate.css">
	    <link rel="stylesheet" href="/css/bootstrap.min.css">
	    <link rel="icon" th:href="${icourl}" type="image/x-icon" />
	    <script src="/js/jquery-3.6.1.min.js"></script>
	    <script src="/js/globalweb/login.js"></script>
		<script type="text/javascript" src="/js/jquery.utils.contact-min.js" charset="utf-8"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js" charset="utf-8"></script>
		<!--Bootbox弹窗插件-->
		<link rel="stylesheet" type="text/css" href="/js/plugins/bootbox/css/bootbox-min.css" />
		<script src="/js/plugins/bootbox/bootbox.concat-min.js?v=20220905v1" type="text/javascript" charset="utf-8"></script>
		<script src="/js/plugins/bootbox/lang/zh_CN-min.js" type="text/javascript" charset="utf-8"></script>
	    <style>
			.popover {
				max-width:500px;
			}
			.gm-version {
				height: 40px;
				line-height: 40px;
				width: 40px;
			}
			/*版本信息 */
			.gm-version-panel{
				width:100%;
			}
			/* 行间距 */
			.gm-version-panel .item{
				line-height: 30px;
			}
			/* 段落设置*/
			.gm-version-panel .item p{
				padding-left: 10px;
				padding-right: 10px;
				color:#666;
				display:block;
			}
			/* 选中时段落设置 */
			.gm-version-panel .item p:hover {
				color: #fff;
				background-color: #3E9EE1 !important;
			}

			body, dd, div, dl, dt, form, h1, h2, h3, h4, h5, h6, input, li, ol, p, pre, td, textarea, th, ul { margin: 0; padding: 0 }

			h1, h2, h3, h4, h5, h6 { font-size: 100%; font-weight: 400 }

			body { font-family: PingFang SC,Helvetica,Arial,Verdana,Microsoft YaHei !important; font: 12px/1.6 Tahoma,Arial,Hiragino Sans GB,\5b8b\4f53; color: #373D41; -webkit-text-size-adjust: none }

			a:link { color: #9B9EA0; text-decoration: none }

			a:visited { color: #9B9EA0; text-decoration: none }

			a:active, a:hover { color: #08c; text-decoration: underline }

			input { outline: 0 }

			a img { vertical-align: text-bottom; }

			:-moz-placeholder, :-ms-input-placeholder, ::-moz-placeholder, ::-webkit-input-placeholder { font-size: 14px; color: #9B9EA0 }

			#login-wrap .hd h2 { display: block; cursor: pointer; width: 48px; height: 48px; position: absolute; top: 0; right: 0 }

			#login-wrap #InputLogin { display: none; }

			.poptip-arrow em, .poptip-arrow span { position: absolute; *zoom: 1; width: 0; height: 0; border-color: rgba(255,255,255,0); border-color: transparent \0; *border-color: transparent; _border-color: tomato; _filter: chroma(color=tomato); border-style: solid; overflow: hidden; top: 0; left: 0 }

			.poptip-arrow em { top: 0; left: 1px; border-left-color: #478bde; border-width: 6px 0 6px 6px }

			.poptip-arrow span { border-left-color: #E6F9FC; border-width: 6px 0 6px 6px }

			.quick-description a, a:active, a:hover { color: #478bde; text-decoration: none }

			.quick-msg h6 { font-size: 18px; color: #5F6367; margin-top: 10px; font-weight: 400; text-align: center; line-height: 24px; }

			.quick-msg p { margin-top: 10px; text-align: center; font-size: 14px; color: #5F6367; }

			#quick-other .register a:link, #quick-other .register a:visited { color: #9B9EA0 }

			#quick-other .register a:hover { color: #478bde }

			.msg-err i, .msg-ok i { display: inline-block; _display: inline; font-size: 32px; line-height: 32px; margin: 0 auto; text-align: center }

			.msg-ok i { color: #b5e163 }

			.msg-err i { color: #f37c75 }


			/*用户登录*/

			.clr:after { content: "."; display: block; height: 0; clear: both; overflow: hidden }

			.clr { *zoom: 1 }

			.form { width: 100% }

			#login-form { position: static; margin-top: 70px; }

			#login-form a, #login-form a:hover, #login-form a:visited { text-decoration: none }

			#login-form .notice-descript a, #login-form .notice-descript a:hover, #login-form .notice-descript a:visited { text-decoration: underline }

			#InputLogin { margin: 0 auto }
			#input-content .input-field-wrap:after { content: "\0020"; display: block; height: 0; clear: both; overflow: hidden }

			#input-content .input-field-wrap { *zoom: 1 }

			#input-content .input-field { padding: 0; margin-bottom: 20px }

			#input-content .fm-text { float: left; padding: 0 10px; height: 40px; border: 1px solid #D7D8D9; line-height: 40px; font-size: 12px; color: #595959; background: #fff; vertical-align: middle; -webkit-box-shadow: 0 1px 0 #ececec inset; -moz-box-shadow: 0 1px 0 #ececec inset; -ms-box-shadow: 0 1px 0 #ececec inset; -o-box-shadow: 0 1px 0 #ececec inset; box-shadow: 0 1px 0 #ececec inset; _padding: 5px 6px; box-sizing: border-box; outline: 0; box-shadow: none; }

			/*#input-content .fm-text:hover { border: 1px solid #478bde }*/

			#input-content .fm-text:focus { border-color: #478bde; -webkit-box-shadow: 0 0 2px #a6cfff; -moz-box-shadow: 0 0 2px #a6cfff; -ms-box-shadow: 0 0 2px #a6cfff; -o-box-shadow: 0 0 2px #a6cfff; box-shadow: 0 0 2px #a6cfff }

			#input-content label { font-weight: 700 }

			#input-content .fm-text { width: 100% }

			#input-content .fm-text::selection { background: #1996e6; color: #fff }

			#input-content .fm-text::-moz-selection { background: #1996e6; color: #fff }

			#input-content .fm-text::-webkit-input-placeholder { color: #aaa }

			#input-content .fm-text:-moz-placeholder { color: #aaa }

			#input-content .fm-text:-ms-input-placeholder { color: #aaa }

			a.input-login-submit-button { display: inline-block !important; height: 28px; line-height: 28px; text-align: center; text-decoration: none !important; color: #fff !important }

			input.input-login-submit-button { _border: 1px solid #fff; _line-height: 28px; _overflow-y: hidden; _background-color: #e87b0e }

			input.input-login-submit-button:active, input.input-login-submit-button:hover { _background-color: #e87b0e }

			#InputLogin #input-login-other { overflow: hidden; zoom: 1; margin-top: 10px }

			#InputLogin #input-login-other .register a { color: #9B9EA0 }

			#InputLogin #input-login-other .register a:hover { color: #478bde }

			#InputLogin #input-login-other .forgetpassword { float: right; }

			.intit {
				font-size: 32px;
				color: #1c2228;
				text-align: center;
				letter-spacing: 12px;
				margin-bottom: 20px;
			}

			.input-field-wrap #username{
				display: block;
				height: 52px;
				font-size: 16px;
				color: #1c2228;
				border: none;
				outline: none;
				border-bottom: 1px solid #ccc;
				box-sizing: border-box;
			}

			.input-field-wrap #password {
				display: block;
				height: 52px;
				font-size: 16px;
				color: #1c2228;
				border: none;
				outline: none;
				border-bottom: 1px solid #ccc;
				box-sizing: border-box;
			}


			#input-login-submit #logindl {
				width: 100%;
				height: 36px;
				background-color: #478bde;
				font-size: 20px;
				color: #fff;
				border-radius: 26px;
				border: none;
				outline: none;
				cursor: pointer;
				margin: auto;
				display: block;
				letter-spacing: 4px;
				transition: all 0.3s;
			}
			iframe{
				margin: 0 auto;
			}
			.el-input {
			}

		</style>
	</head>
	<body>
		<div id="app" class="wrapper">
			<div class="loginWrap row" style="height: 900px;">
				<div class="boxL fadeInDown wow animated hidden-sm hidden-xs col-md-6" style="visibility: visible; animation-name: fadeInDown;">

				</div>
				<div data-wow-delay="0.2s" class="boxR fadeInDown wow animated col-md-6 col-sm-12 col-xs-12" style="visibility: visible; animation-delay: 0.2s; animation-name: fadeInDown;">
					<div class="center">
						<div class="intit">欢迎登录</div>
						<p class="bg-warning sl_warning" id="tiplogin">
							<span class="glyphicon glyphicon-minus-sign" th:if="${param.error}">用户名或者密码错误。</span>
							<span class="glyphicon glyphicon-minus-sign" th:if="${param.logout}">You have been logged out.</span>
						</p>
						<p class="bg-warning sl_warning" style="display:none;" id="tips"><span class="glyphicon glyphicon-minus-sign"></span></p>
						<div class="inbod">
							<form action="/index" method="POST">
								<!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
								<input type="hidden" name="access_token" id ="access_token" />
								<input type="hidden" name="ref" id ="ref" />
								<input type="hidden" name="key" th:value="${key}" />
								<input type="hidden" name="mm_flg" id="mm_flg"/>
								<input type="hidden" name="key" th:value="${key}" />
								<input type="hidden" name="applicationurl" id="applicationurl" th:value="${applicationurl}" />
								<input type="hidden" name="domain" id="domain" th:value="${domain}"/>
								<input type="hidden" name="cookiekey" id="cookiekey" th:value="${cookiekey}"/>
								<input type="hidden" id="redirectUrl" name="redirectUrl" th:value="${redirectUrl}"/>
								<label class="lab1">
									<span></span>
									<input type="text" name="username" id="username" placeholder="请输入用户名">
								</label> 
								<label class="lab2">
									<span></span>
									<input type="password" name="password" id="password" placeholder="请输入密码" autocomplete="off">
								</label>
								<div id="input-login-submit">
									<input value="登录" id="logindl" class="input-login-submit-button" type="submit" tabindex="4" name="submit-btn" />
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			$(function () {
				var screenH = $(window).height();
				$(".loginWrap").height(screenH);
				$(window).resize(function(event) {
					var screenH = $(window).height();
					$(".loginWrap").height(screenH);
				});
				//判断cookie里是否存在token,并校验token是否过期
				checkToken();
				$("#logindl").unbind("click").click(function(){
					var ts = '<span class="glyphicon glyphicon-minus-sign"></span>';
					if(!$("#username").val() || $("#username").val()==""){
						$("#tips").empty().append(ts + "用户名不能为空！");
						$("#tiplogin").empty();
						$("#tips").show();
						return false;
					}
					if(!$("#password").val() || $("#password").val()==""){
						$("#tips").empty().append(ts + "密码不能为空！");
						$("#tiplogin").empty();
						$("#tips").show();
						return false;
					}
					/*if($("#yzmDiv") && $("#yzmDiv:visible").length>0){
                        if(!$("#yzm").val()|| $("#yzm").val()==""){
                            $("#tips").empty().append(ts + "验证码不能为空！");
                            $("#tiplogin").empty();
                            $("#tips").show();
                            return false;
                        }
                    }*/
					var base = new Base64();
					var hash = base.encode($("#password").val());
					$.ajax({
						type:"post",
						url:"/oauth/token",
						cache: false,
						data: {"grant_type":"matridx","client_id":$("#username").val(),"client_secret":hash,"systemcode":"matridx-springboot"},
						dataType:"json",
						success:function(data){
							$("#access_token").val(data.access_token);
							//过期时间设置为12个小时 ，如果为天数，则直接设置为 expires:天数
							var expires = new Date();
							expires.setTime(expires.getTime() + 60 * 1000 * 60 * 12);
							//token存到cookie中
							var cookieStr = 'TOKEN.' + $('#cookiekey').val() +'='+data.access_token+';domain='+$('#domain').val()+';path=/'+';expires:'+expires.toGMTString();
							document.cookie = cookieStr;

							$("#ref").val(data.refresh_token);
							//alert("access_token:"+data.access_token + "  token_type:" +  data.token_type + "  refresh_token:" +  data.refresh_token + "  expires_in:" +  data.expires_in + "  scope:" +  data.scope);
							if(/^[0-9]*$/.test($("#password").val())|| /^[A-Z]+$ /.test($("#password").val())||/^[a-z]+$/.test($("#password").val())){
								$("#mm_flg").val("1");
							}
							//document.forms[0].submit();
							submitForm();
						},
						error:function(event, XMLHttpRequest, ajaxOptions, thrownError){
							if(event.responseJSON.status == 452){
								$.alert("用户已经被锁定，请先联系管理员进行解锁！");
							}else if(event.responseJSON.error_description!=null){
								$.alert(event.responseJSON.error_description);
							}else{
								$.alert("用户名或者密码不正确！");
							}
						}
					});
					return false;
				});
			})

			//根据参数决定是直接提交菜单还是 重定向到登录验证传入的地址
			function submitForm(){

				var redirectUrl = $('#redirectUrl').val();
				if(!redirectUrl || redirectUrl ==""){
					document.forms[0].submit();
					return
				}
				redirectUrl = decodeURIComponent(redirectUrl);//token存到cookie中
				//重定向

				window.location.href=redirectUrl+"?access_token="+$("#access_token").val()+"&ref="+$("#ref").val()+"&mm_flg="+$("#mm_flg").val()+"&cookiekey="+$("#cookiekey").val();
			}
			//钉钉登录
			function checkDingDingLogin(){

				var access_token = $('#access_token').val();
				var ref = $('#ref').val();
				if(access_token&&ref){
					//过期时间设置为12个小时 ，如果为天数，则直接设置为 expires:天数
					var expires = new Date();
					expires.setTime(expires.getTime() + 60 * 1000 * 60 * 12);
					//token存到cookie中

					var cookieStr = 'TOKEN.' + $('#cookiekey').val() +'='+access_token+';domain='+$('#domain').val()+';path=/'+';expires:'+expires.toGMTString();
					document.cookie = cookieStr;

					//document.forms[0].submit();
					submitForm()
					return true;
				}else{
					return false;
				}
			}
			//校验token是否有效
			function checkToken(){
				var token = getCookie('TOKEN.'+ $('#cookiekey').val());
				if(!token){
					return;
				}else{
					//校验token是否有效
					$.ajax({
						type:"post",
						url:"/ws/checkToken",
						data: {
							access_token:token
						},
						dataType:"json",
						success:function(data){
							if(data.status == 'true'){ //验证通过
								$("#access_token").val(token);
								$("#ref").val(token);
								//document.forms[0].submit();
								submitForm();
							}else{
								//不做处理
							}
						},
						error:function(event){

						}
					});
				}
			}
			//获取cookie
			function getCookie(name){
				var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
				if(arr=document.cookie.match(reg))
				return unescape(arr[2]);
				else
				return null;
			}
		</script>

	</body>
</html>