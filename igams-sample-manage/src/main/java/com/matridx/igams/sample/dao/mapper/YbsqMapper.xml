<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.sample.dao.post.IYbsqDao" >
	<!-- 根据申请ID获取申请信息 -->
	<select id="getDto" parameterType="YbsqDto" resultType="YbsqDto">
		select sq.sqid,sq.ybid,sq.sqs,sq.yt,sq.sqry,to_char(sq.sqsj,'yyyy-mm-dd hh24:mi:ss') sqsj,sq.zt,to_char(sq.shsj,'yyyy-mm-dd hh24:mi:ss') shsj
				,yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz,ybjg.jgid
			    ,yb.jswz ybjswz,yb.dw,yb.nd
				,sq.lrry,sq.lrsj,sq.xgry,sq.xgsj,sq.qswz,sq.jswz,sq.bz
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,jc.csmc yblxmc,yh.zsxm sqrxm,jcyt.csmc ytmc
			from igams_ybsq sq
			left outer join igams_ybsqssdw ybjg on ybjg.sqid = sq.sqid
			left outer join igams_ybgl yb on yb.ybid = sq.ybid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			left outer join matridx_jcsj jcyt on sq.yt = jcyt.csid
			left outer join matridx_xtyh yh on yh.yhid = sq.sqry
			<where>
				sq.scbj ='0' 
				<if test="ybid != null and ybid != ''">
					and sq.ybid = #{ybid}
				</if>
				<if test="sqid != null and sqid != ''">
					and sq.sqid = #{sqid}
				</if>
			</where>
	</select>

	<select id="getDtoList" parameterType="YbsqDto" resultType="YbsqDto">
		select sq.sqid,sq.ybid,sq.sqs,sq.yt,sq.sqry,to_char(sq.sqsj,'yyyy-mm-dd hh24:mi:ss') sqsj,sq.zt,to_char(sq.shsj,'yyyy-mm-dd hh24:mi:ss') shsj
		,yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz,ybjg.jgid
		,yb.jswz ybjswz,yb.dw,yb.nd
		,sq.lrry,sq.lrsj,sq.xgry,sq.xgsj,sq.qswz,sq.jswz,sq.bz
		,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
		,jc.csmc yblxmc,yh.zsxm sqrxm,jcyt.csmc ytmc
		from igams_ybsq sq
		left outer join igams_ybsqssdw ybjg on ybjg.sqid = sq.sqid
		left outer join igams_ybgl yb on yb.ybid = sq.ybid
		left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
		left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
		left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
		left outer join matridx_jcsj jc on yb.yblx = jc.csid
		left outer join matridx_jcsj jcyt on sq.yt = jcyt.csid
		left outer join matridx_xtyh yh on yh.yhid = sq.sqry
		<where>
			sq.scbj ='0'
			<if test="ids !=null and ids.size > 0">
				and sq.sqid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	
	<!-- 根据申请ID获取申请信息 -->
	<select id="getDtoById" parameterType="String" resultType="YbsqDto">
		select sq.sqid,sq.ybid,sq.sqs,sq.yt,sq.sqry,to_char(sq.sqsj,'yyyy-mm-dd hh24:mi:ss') sqsj,sq.zt,to_char(sq.shsj,'yyyy-mm-dd hh24:mi:ss') shsj,sq.bz
				,yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz
			    ,yb.jswz ybjswz,yb.dw,yb.nd
				,sq.lrry,sq.lrsj,sq.xgry,sq.xgsj,sq.qswz,sq.jswz
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,jc.csmc yblxmc,yh.zsxm sqrxm,jcyt.csmc ytmc
			from igams_ybsq sq
			left outer join igams_ybgl yb on yb.ybid = sq.ybid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			left outer join matridx_jcsj jcyt on sq.yt = jcyt.csid
			left outer join matridx_xtyh yh on yh.yhid = sq.sqry
			<where>
				sq.scbj ='0'
					and sq.sqid = #{sqid}
			</where>
	</select>
	
	<!-- 根据申请ID获取申请信息 -->
	<select id="getYbDto" parameterType="YbsqDto" resultType="YbsqDto">
		select yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz
			    ,yb.jswz ybjswz,yb.dw,yb.nd
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,jc.csmc yblxmc
			from igams_ybgl yb 
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			<where>
				yb.scbj ='0' 
				<if test="ybid != null and ybid != ''">
					and yb.ybid = #{ybid}
				</if>
			</where>
	</select>
	
	<!-- 根据申请ID获取申请信息 -->
	<select id="getPagedDtoList" parameterType="YbsqDto" resultType="YbsqDto">
		select sq.sqid,sq.ybid,sq.sqs,sq.yt,sq.sqry,to_char(sq.sqsj,'yyyy-mm-dd hh24:mi:ss') sqsj,sq.zt,to_char(sq.shsj,'yyyy-mm-dd hh24:mi:ss') shsj,sq.bz
				,yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz
			    ,yb.jswz ybjswz,yb.dw,yb.nd,sq.qswz,sq.jswz
				,sq.lrry,sq.lrsj,sq.xgry,sq.xgsj
				,bxsb.sbh bxh,chtsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,yh.zsxm sqrxm
			from igams_ybsq sq
			left outer join igams_ybgl yb on yb.ybid = sq.ybid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl chtsb on yb.chtid = chtsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_xtyh yh on yh.yhid = sq.sqry
			<where>
				sq.scbj ='0' 
				<if test="sqs != null and sqs != ''">
					and sq.sqs = cast(#{sqs} as numeric)
				</if>
				<if test="ybbh != null and ybbh != ''">
					and yb.ybbh = #{ybbh}
				</if>
				<if test="bxh != null and bxh != ''">
					and bxsb.sbh = #{bxh}
				</if>
				<if test="chth != null and chth != ''">
					and chtsb.sbh = #{chth}
				</if>
				<if test="hzh != null and hzh != ''">
					and hzsb.sbh = #{hzh}
				</if>
				<if test="bz != null and bz != ''">
					and sq.bz = #{bz}
				</if>
				<if test = "yblxs != null and yblxs.length > 0 "  >
					and yb.yblx in 
					<foreach collection="yblxs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test = "yts != null and yts.length > 0 "  >
					and sq.yt in 
					<foreach collection="yts" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test="sqrqstart != null and sqrqstart != ''">
					and to_char(sq.sqsj,'YYYY-MM-dd') &gt;= #{sqrqstart}
				</if>
				<if test="sqrqend != null and sqrqend != ''">
					and to_char(sq.sqsj,'YYYY-MM-dd') &lt;= #{sqrqend}
				</if>
			</where>
	</select>
	
	<!-- 插入标本申请信息 -->
	<insert id="insert" parameterType="YbsqModel">
		insert into igams_ybsq(sqid,ybid,sqs,yt,sqry,sqsj
		<if test="hzid !=null and hzid != ''">
			,hzid
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz
		</if>
		<if test="bz !=null and bz != ''">
			,bz
		</if>
		<if test="zt !=null and zt != ''">
			,zt
		</if>
		,lrry,lrsj,scbj) values(#{sqid},#{ybid},cast(#{sqs} as numeric),#{yt},#{sqry},LOCALTIMESTAMP
		<if test="hzid !=null and hzid != ''">
			,#{hzid}
		</if>
		<if test="qswz !=null and qswz != ''">
			,#{qswz}
		</if>
		<if test="jswz !=null and jswz != ''">
			,#{jswz}
		</if>
		<if test="bz !=null and bz != ''">
			,#{bz}
		</if>
		<if test="zt !=null and zt !=''">
			,#{zt}
		</if>
		,#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	<!--更新标本申请信息-->
	<update  id="update" parameterType="YbsqModel">
		update igams_ybsq set xgry = #{xgry},xgsj = LOCALTIMESTAMP
		<if test="sqs !=null and sqs != ''">
			,sqs = cast(#{sqs} as numeric)
		</if>
		<if test="yt !=null and yt != ''">
			,yt = #{yt}
		</if>
		<if test="sqry !=null and sqry != ''">
			,sqry = #{sqry}
		</if>
		<if test="hzid !=null and hzid != ''">
			,hzid = #{hzid}
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz = #{qswz}
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz = #{jswz}
		</if>
		<if test="shsj !=null and shsj != ''">
			,shsj = LOCALTIMESTAMP
		</if>
		<if test="sqsj !=null and sqsj != ''">
			,sqsj = LOCALTIMESTAMP
		</if>
		<if test="bz !=null and bz != ''">
			,bz = #{bz}
		</if>
		<if test="zt !=null and zt != ''">
			,zt = #{zt}
		</if>
		<where>
			ybid = #{ybid}
		</where>
	</update>
	
	<!--更新标本申请的删除状态-->
	<update  id="delete" parameterType="YbsqModel">
		update igams_ybsq set scry = #{scry},scsj = LOCALTIMESTAMP,scbj='1' 
		<where>
			<if test="sqid !=null and sqid != ''">
				or sqid = #{sqid}
			</if>
			<if test="ybid !=null and ybid != ''">
				or ybid = #{ybid}
			</if>
			<if test="ids !=null and ids.size > 0">
			or sqid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>
	
	<!--更新标本申请的状态信息-->
	<update id="updateZt" parameterType="YbsqModel">
		update igams_ybsq set zt = #{zt,jdbcType=VARCHAR},xgry = #{xgry},xgsj = LOCALTIMESTAMP
		<if test="sqry !=null and sqry != ''">
			,sqry = #{sqry}
		</if>
		<if test="hzid !=null and hzid != ''">
			,hzid = #{hzid}
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz = #{qswz}
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz = #{jswz}
		</if>
		<if test="shsj !=null and shsj != ''">
			,shsj = LOCALTIMESTAMP
		</if>
		<if test="sqsj !=null and sqsj != ''">
			,sqsj = LOCALTIMESTAMP
		</if>
		where sqid = #{sqid}
	</update>
	
	<!-- 获取标本申请审核的ID列表 -->
	<select id="getPagedAuditIdList" parameterType="YbsqDto" resultType="YbsqDto">
		select sq.sqid,sq.lrsj
			from igams_ybsq sq
			left outer join igams_ybgl yb on yb.ybid = sq.ybid
			<where>
				sq.scbj ='0' 
				<if test="sqs != null and sqs != ''">
					and sq.sqs = cast(#{sqs} as numeric)
				</if>
				<if test="ybbh != null and ybbh != ''">
					and yb.ybbh = #{ybbh}
				</if>
				<if test="bz != null and bz != ''">
					and sq.bz = #{bz}
				</if>
				<if test="zt != null and zt != ''">
					and sq.zt = #{zt}
				</if>
				<if test = "yblxs != null and yblxs.length > 0 "  >
					and yb.yblx in 
					<foreach collection="yblxs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test = "yts != null and yts.length > 0 "  >
					and sq.yt in 
					<foreach collection="yts" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
			</where>
	</select>
	
	<!-- 临时表分页查询-审核列表-->
	<select id="getAuditListByIds" parameterType="List"
		resultType="YbsqDto">
		select sq.sqid,sq.ybid,sq.sqs,sq.yt,sq.sqry,to_char(sq.sqsj,'yyyy-mm-dd hh24:mi:ss') sqsj,sq.zt,to_char(sq.shsj,'yyyy-mm-dd hh24:mi:ss') shsj,sq.bz
				,yb.ybid,yb.yblx,yb.yblylx,yb.ybbh,yb.bxid,yb.chtid,yb.hzid,yb.sl,yb.yds,yb.qswz ybqswz
			    ,yb.jswz ybjswz,yb.dw,yb.nd,sq.lrry,sq.lrsj,sq.xgry,sq.xgsj,shxx_sqsj,shxx_gwmc,sqr,shxx_lrryxm,shxx_shsj,shxx_sftg
				,bxsb.sbh bxh,chtsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,yh.zsxm sqrxm
			from igams_ybsq sq
			join 
				<foreach collection="list" separator="union" open="(" close=") "
						item="item" index="index">
					select #{item.sqid} sqid,#{item.shxx_sqsj} shxx_sqsj,#{item.sqr} sqr,#{item.shxx_lrryxm} shxx_lrryxm,#{item.shxx_shsj} shxx_shsj,#{item.shxx_sftg} shxx_sftg,#{item.shxx_gwmc} shxx_gwmc,#{index} rownum
				</foreach>
			tmp on tmp.sqid = sq.sqid
			left outer join igams_ybgl yb on yb.ybid = sq.ybid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl chtsb on yb.chtid = chtsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_xtyh yh on yh.yhid = sq.sqry
		<where>
			sq.sqid in 
			<foreach collection="list" separator="," open="(" close=") "
					item="item" index="index">
				#{item.sqid}
			</foreach>
		</where>
		order by tmp.rownum
	</select>
</mapper>
