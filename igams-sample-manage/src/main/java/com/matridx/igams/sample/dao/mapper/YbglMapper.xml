<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.sample.dao.post.IYbglDao" >
	<!-- 插入标本信息 -->
	<insert id="insert" parameterType="YbglModel">
		insert into igams_ybgl(ybid,lyid,yblx,yblylx
		<if test="ybbh !=null and ybbh != ''">
			,ybbh
		</if>
		<if test="ybgg !=null and ybgg != ''">
			,ybgg
		</if>
		<if test="cpbh !=null and cpbh != ''">
			,cpbh
		</if>
		<if test="ybph !=null and ybph != ''">
			,ybph
		</if>
		<if test="bxid !=null and bxid != ''">
			,bxid
		</if>
		<if test="chtid !=null and chtid != ''">
			,chtid
		</if>
		<if test="hzid !=null and hzid != ''">
			,hzid
		</if>
		<if test="hqsj !=null and hqsj != ''">
			,hqsj
		</if>
		<if test="ysl !=null and ysl != ''">
			,ysl
		</if>
		<if test="sl !=null and sl != ''">
			,sl
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz
		</if>
		<if test="dw !=null and dw != ''">
			,dw
		</if>
		<if test="nd !=null and nd != ''">
			,nd
		</if>
		<if test="zt !=null and zt != ''">
			,zt
		</if>
		,lrry,lrsj,scbj) values(#{ybid},#{lyid},#{yblx},#{yblylx}
		<if test="ybbh !=null and ybbh != ''">
			,#{ybbh}
		</if>
		<if test="ybgg !=null and ybgg != ''">
			,#{ybgg}
		</if>
		<if test="cpbh !=null and cpbh != ''">
			,#{cpbh}
		</if>
		<if test="ybph !=null and ybph != ''">
			,#{ybph}
		</if>
		<if test="bxid !=null and bxid != ''">
			,#{bxid}
		</if>
		<if test="chtid !=null and chtid != ''">
			,#{chtid}
		</if>
		<if test="hzid !=null and hzid != ''">
			,#{hzid}
		</if>
		<if test="hqsj !=null and hqsj != ''">
			,to_date(#{hqsj},'YYYY-MM-DD')
		</if>
		<if test="ysl !=null and ysl != ''">
			,cast(#{ysl} as numeric)
		</if>
		<if test="sl !=null and sl != ''">
			,cast(#{sl} as numeric)
		</if>
		<if test="qswz !=null and qswz != ''">
			,cast(#{qswz} as numeric)
		</if>
		<if test="jswz !=null and jswz != ''">
			,cast(#{jswz} as numeric)
		</if>
		<if test="dw !=null and dw != ''">
			,#{dw}
		</if>
		<if test="nd !=null and nd != ''">
			,cast(#{nd} as numeric)
		</if>
		<if test="zt !=null and zt !=''">
			,#{zt}
		</if>
		,#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	<update  id="update" parameterType="YbglModel">
		update igams_ybgl set yblx = #{yblx},yblylx = #{yblylx}
		<if test="ybbh !=null and ybbh != ''">
			,ybbh = #{ybbh}
		</if>
		<if test="bxid !=null and bxid != ''">
			,bxid = #{bxid}
		</if>
		<if test="chtid !=null and chtid != ''">
			,chtid = #{chtid}
		</if>
		<if test="hzid !=null and hzid != ''">
			,hzid = #{hzid}
		</if>
		<if test="hqsj !=null and hqsj != ''">
			,hqsj = to_date(#{hqsj},'YYYY-MM-DD')
		</if>
		<if test="ysl !=null and ysl != ''">
			,ysl = cast(#{ysl} as numeric)
		</if>
		<if test="sl !=null and sl != ''">
			,sl = cast(#{sl} as numeric)
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz = cast(#{qswz} as numeric)
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz = cast(#{jswz} as numeric)
		</if>
		<if test="dw !=null and dw != ''">
			,dw = #{dw}
		</if>
		<if test="nd !=null and nd != ''">
			,nd = cast(#{nd} as numeric)
		</if>
		<if test="zt !=null and zt != ''">
			,zt = #{zt}
		</if>
		<if test="ybgg !=null and ybgg != ''">
			,ybgg = #{ybgg}
		</if>
		<if test="cpbh  !=null and cpbh  != ''">
			,cpbh  = #{cpbh}
		</if>
		<if test="ybph  !=null and ybph  != ''">
			,ybph  = #{ybph}
		</if>
		,xgry = #{xgry},xgsj = LOCALTIMESTAMP
		<where>
			ybid = #{ybid}
		</where>
	</update>
	
	<update  id="delete" parameterType="YbglModel">
		update igams_ybgl set scry = #{scry},scsj = LOCALTIMESTAMP,scbj='1' 
		<where>
			<if test="lyid !=null and lyid != ''">
				or lyid = #{lyid}
			</if>
			<if test="ybid !=null and ybid != ''">
				or ybid = #{ybid}
			</if>
			<if test="ids !=null and ids.size > 0">
			or lyid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="ybids !=null and ybids.size > 0">
			or ybid in
				<foreach collection="ybids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>
	
	<!-- 获取标本信息列表 -->
	<select id="getDtoList" parameterType="YbglDto" resultType="YbglDto">
		select yb.ybid,yb.lyid,yb.yblx,yb.yblylx,ybbh,bxid,chtid,hzid,ysl,sl,yds,qswz,jswz,dw,nd,yb.zt
				,yb.lrry,yb.lrsj,yb.xgry,yb.xgsj,to_char(yb.hqsj,'YYYY-MM-dd') hqsj
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs,jc.csmc yblxmc 
			from igams_ybgl yb
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			<where>
				yb.scbj ='0' 
				<if test="lyid !=null and lyid !=''">
					and lyid = #{lyid}
				</if>
				<if test="hzid !=null and hzid !=''">
					and hzid = #{hzid}
				</if>
			</where>
			<if test="sortName !=null and sortName != ''">
                 order by ${sortName} ${sortOrder},ybid asc
             </if>
             <if test="sortName ==null or sortName == ''">
                 order by qswz asc
             </if>
			
	</select>
	
	<!-- 根据标本ID获取标本信息 -->
	<select id="getDtoById" parameterType="String" resultType="YbglDto">
		select yb.ybid,yb.lyid,yb.yblx,yb.yblylx,ybbh,bxid,chtid,hzid,ysl,sl,yds,qswz,jswz,dw,nd,yb.zt
				,yb.lrry,yb.lrsj,yb.xgry,yb.xgsj,to_char(yb.hqsj,'YYYY-MM-dd') hqsj
				,bxsb.sbh bxh,bxsb.sbid bxid,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,ly.lybh,jc.csmc yblxmc
			from igams_ybgl yb
			left outer join igams_ybly ly on yb.lyid = ly.lyid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			<where>
				yb.scbj ='0' and ybid = #{ybid}
			</where>
	</select>
	
	<!-- 根据标本ID获取标本信息 -->
	<select id="getDto" parameterType="YbglDto" resultType="YbglDto">
		select yb.ybid,yb.lyid,yb.yblx,yb.yblylx,ybbh,bxid,chtid,hzid,ysl,sl,yds,qswz,jswz,dw,nd,yb.zt
				,yb.lrry,yb.lrsj,yb.xgry,yb.xgsj,to_char(yb.hqsj,'YYYY-MM-dd') hqsj
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,ly.lybh,jc.csmc yblxmc,yb.ybgg,yb.cpbh,yb.ybph 
			from igams_ybgl yb
			left outer join igams_ybly ly on yb.lyid = ly.lyid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			<where>
				yb.scbj ='0' 
				<if test="ybid != null and ybid != ''">
					and ybid = #{ybid}
				</if>
			</where>
	</select>
	
	<!-- 插入标本信息 -->
	<select id="getPagedDtoList" parameterType="YbglDto" resultType="YbglDto">
		select yb.ybid,yb.lyid,yb.yblx,yb.yblylx,ybbh,bxid,chtid,hzid,ysl,sl,yds,qswz,jswz,dw,nd,yb.zt
				,yb.lrry,yb.lrsj,yb.xgry,yb.xgsj,to_char(yb.hqsj,'YYYY-MM-dd') hqsj
				,bxsb.sbh bxh,ctsb.sbh chth,hzsb.sbh hzh,hzsb.cfs
				,ly.lybh
			from igams_ybgl yb
			left outer join igams_ybly ly on yb.lyid = ly.lyid
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			left outer join igams_sbgl ctsb on yb.chtid = ctsb.sbid
			left outer join igams_sbgl hzsb on yb.hzid = hzsb.sbid
			<where>
				yb.scbj ='0' 
				<if test="lybh != null and lybh != ''">
					and ly.lybh like '%'||#{lybh}||'%'
				</if>
				<if test="ybbh != null and ybbh != ''">
					and yb.ybbh like '%'||#{ybbh}||'%'
				</if>
				<if test="bxh != null and bxh != ''">
					and bxsb.sbh  = #{bxh}
				</if>
				<if test="chth != null and chth != ''">
					and ctsb.sbh  = #{chth}
				</if>
				<if test="hzh != null and hzh != ''">
					and hzsb.sbh  = #{hzh}
				</if>
				<if test = "yblxs != null and yblxs.length > 0 "  >
					and yb.yblx in 
					<foreach collection="yblxs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test = "lyfs != null and lyfs.length > 0 "  >
					and yb.yblylx in 
					<foreach collection="lyfs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
			</where>
	</select>
	
	<update id="updateYdsBySq" parameterType="YbglDto" >
		update igams_ybgl set yds = 
		(case when (coalesce(yds,0) + cast(#{yds} as numeric)) &lt; 0 then 0 else (coalesce(yds,0) + cast(#{yds} as numeric)) end)
		<if test="sl != null and sl != ''">
			, sl = (case when (coalesce(sl,0) - cast(#{sl} as numeric)) &lt; 0 then 0 else (coalesce(sl,0) - cast(#{sl} as numeric)) end)
		</if>
		<if test="scbj != null and scbj != ''">
			,scry = #{scry},scsj = LOCALTIMESTAMP,scbj='2' 
		</if>
		where ybid = #{ybid}
	</update>
	
	<!-- 获取标本总体信息 -->
	<select id="getYblxCount" parameterType="YbglDto" resultType="hashmap">
		select yb.yblx "id",jc.csmc "name",count(sl) "value"
			from igams_ybgl yb
			left outer join matridx_jcsj jc on yb.yblx = jc.csid
			where yb.zt ='80' and yb.scbj ='0'
			group by yb.yblx,jc.csmc
	</select>
	
	<!-- 获取冰箱空闲信息 -->
	<select id="getBxkxCount" parameterType="YbglDto" resultType="hashmap">
		select * from (
		select bxsb.sbh "id",'zy' "lx",sum(sl) "value"
			from igams_ybgl yb
			left outer join igams_sbgl bxsb on yb.bxid = bxsb.sbid
			where yb.zt ='80' and yb.scbj ='0'
			group by bxsb.sbh
		union all
		select bxsb.sbh "id",'zt' "lx",sum(hzsb.cfs) "value"
			from igams_sbgl bxsb 
			left outer join igams_sbgl ctsb on bxsb.sbid = ctsb.fsbid
			left outer join igams_sbgl hzsb on ctsb.sbid = hzsb.fsbid
			where bxsb.scbj ='0' and ctsb.scbj ='0' and hzsb.scbj ='0'
			group by bxsb.sbh
		) t order by "id","lx"
	</select>
	
	<!-- 获取标本使用情况信息 -->
	<select id="getYbsyqkCount" parameterType="YbglDto" resultType="hashmap">
		WITH tb_rq AS (
	     	<foreach collection="ids" separator=" union all " item="item">
				select #{item} rq
			</foreach>
		)
		select lx,"value",sj from (
		select 'ybxz' lx,coalesce(sum(yb.ysl),0) "value",tr.rq sj
			from tb_rq tr
			left outer join igams_ybgl yb on 1 = 1
			<if test="tj == 'yf'">
				and tr.rq = to_char(yb.hqsj,'yyyy-mm')
			</if>
			<if test="tj == 'nd'">
				and tr.rq = to_char(yb.hqsj,'yyyy')
			</if>
			<if test="yblx != null and yblx != ''">
				and yb.yblx = #{yblx}
			</if>
			group by tr.rq
			<if test="tj == 'yf'">
				,to_char(yb.hqsj,'yyyy-mm')
			</if>
			<if test="tj == 'nd'">
				,to_char(yb.hqsj,'yyyy')
			</if>
		union all
		select 'ybsy' lx,coalesce(sum(case when yb.ybid is not null then sq.sqs else 0 end),0) "value",tr.rq sj
			from tb_rq tr 
			left outer join igams_ybsq sq 
			on 1 = 1
			<if test="tj == 'yf'">
				and tr.rq = to_char(sq.shsj,'yyyy-mm')
			</if>
			<if test="tj == 'nd'">
				and tr.rq = to_char(sq.shsj,'yyyy')
			</if>
			left outer join igams_ybgl yb on sq.ybid = yb.ybid
			<if test="yblx != null and yblx != ''">
				and yb.yblx = #{yblx}
			</if>
			group by tr.rq
			<if test="tj == 'yf'">
				,to_char(sq.shsj,'yyyy-mm')
			</if>
			<if test="tj == 'nd'">
				,to_char(sq.shsj,'yyyy')
			</if>
		) tmp order by lx,sj
	</select>
	<!-- 新增导入标本信息 -->
	<insert id="insertImpYbglDto" parameterType="YbglDto">
		insert into igams_ybgl(ybid
		<if test="yblylx !=null and yblylx != ''">
			,yblylx
		</if>
		<if test="yblx !=null and yblx != ''">
			,yblx
		</if>
		<if test="lyid !=null and lyid != ''">
			,lyid
		</if>
		<if test="ybbh !=null and ybbh != ''">
			,ybbh
		</if>
		<if test="bxid !=null and bxid != ''">
			,bxid
		</if>
		<if test="chtid !=null and chtid != ''">
			,chtid
		</if>
		<if test="hzid !=null and hzid != ''">
			,hzid
		</if>
		<if test="hqsj !=null and hqsj != ''">
			,hqsj
		</if>
		<if test="ysl !=null and ysl != ''">
			,ysl
		</if>
		<if test="sl !=null and sl != ''">
			,sl
		</if>
		<if test="qswz !=null and qswz != ''">
			,qswz
		</if>
		<if test="jswz !=null and jswz != ''">
			,jswz
		</if>
		<if test="dw !=null and dw != ''">
			,dw
		</if>
		<if test="nd !=null and nd != ''">
			,nd
		</if>
		<if test="zt !=null and zt != ''">
			,zt
		</if>
		,lrry,lrsj,scbj) values(#{ybid}
		<if test="yblylx !=null and yblylx != ''">
			,#{yblylx}
		</if>
		<if test="yblx !=null and yblx != ''">
			,#{yblx}
		</if>
		<if test="lyid !=null and lyid != ''">
			,#{lyid}
		</if>
		<if test="ybbh !=null and ybbh != ''">
			,#{ybbh}
		</if>
		<if test="bxid !=null and bxid != ''">
			,#{bxid}
		</if>
		<if test="chtid !=null and chtid != ''">
			,#{chtid}
		</if>
		<if test="hzid !=null and hzid != ''">
			,#{hzid}
		</if>
		<if test="hqsj !=null and hqsj != ''">
			,to_date(#{hqsj},'YYYY-MM-DD')
		</if>
		<if test="ysl !=null and ysl != ''">
			,cast(#{ysl} as numeric)
		</if>
		<if test="sl !=null and sl != ''">
			,cast(#{sl} as numeric)
		</if>
		<if test="qswz !=null and qswz != ''">
			,cast(#{qswz} as numeric)
		</if>
		<if test="jswz !=null and jswz != ''">
			,cast(#{jswz} as numeric)
		</if>
		<if test="dw !=null and dw != ''">
			,#{dw}
		</if>
		<if test="nd !=null and nd != ''">
			,cast(#{nd} as numeric)
		</if>
		<if test="zt !=null and zt !=''">
			,#{zt}
		</if>
		,#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	<!-- 新增导入标本来源信息 -->
	<insert id="insertYblyByYbglDto" parameterType="YbglDto">
		insert into igams_ybly(lyid,yblx,lrry,lrsj,scbj
		<if test="rklx != null and rklx != ''">
			,rklx
        </if>
		<if test="wbbh != null and wbbh != ''">
			,wbbh
        </if>
		<if test="jyjg != null and jyjg != ''">
			,jyjg
        </if>
		<if test="lyd != null and lyd != ''">
			,lyd
        </if>
        <if test="cysj != null and cysj != ''">
			,cysj
        </if>
        <if test="xb != null and xb != ''">
			,xb
        </if>
        <if test="yz != null and yz != ''">
			,yz
        </if>
        <if test="tz != null and tz != ''">
			,tz
        </if>
        <if test="xm != null and xm != ''">
			,xm
        </if>
         <if test="lybh != null and lybh != ''">
			,lybh
        </if>
		<if test="bz != null and bz != ''">
			,bz
        </if>
        <if test="zt != null and zt != ''">
			,zt
        </if>
        )values(#{lyid},#{yblx},#{lrry},LOCALTIMESTAMP,'0'
	        <if test="rklx != null and rklx != ''">
				,#{rklx}
	        </if>
	        <if test="wbbh != null and wbbh != ''">
				,#{wbbh}
	        </if>
			<if test="jyjg != null and jyjg != ''">
				,#{jyjg}
	        </if>
			<if test="lyd != null and lyd != ''">
				,#{lyd}
	        </if>
	        <if test="cysj != null and cysj != ''">
				,to_date(#{cysj},'YYYY-MM-DD')
	        </if>
	        <if test="xb != null and xb != ''">
				,#{xb}
	        </if>
	        <if test="yz != null and yz != ''">
				,cast(#{yz} as numeric)
	        </if>
	        <if test="tz != null and tz != ''">
				,cast(#{tz} as numeric)
	        </if>
	        <if test="xm != null and xm != ''">
				,#{xm}
	        </if>
	         <if test="lybh != null and lybh != ''">
				,#{lybh}
	        </if>
			<if test="bz != null and bz != ''">
				,#{bz}
	        </if>
	        <if test="zt != null and zt != ''">
				,#{zt}
	        </if>
        )
	</insert>
</mapper>