<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.detection.molecule.dao.post.IKzbglDao" >

    <select id="getPagedDtoList" parameterType="KzbglDto" resultType="KzbglDto">
        select kzbgl.kzbid, kzbgl.kzbh, kzbgl.syrq, kzbgl.kzsjph, kzbgl.tqsjph, kzbgl.jcdw, kzbgl.zt,
               jcsj_jcdw.csmc jcdwmc,lrry.zsxm lrrymc,to_char(kzbgl.lrsj,'yyyy-mm-dd hh24:mi:ss') lrsj
        from igams_kzbgl kzbgl
        left join matridx_jcsj jcsj_jcdw on jcsj_jcdw.csid = kzbgl.jcdw
        left join matridx_xtyh lrry on lrry.yhid = kzbgl.lrry
        <where>
            kzbgl.scbj = '0'
            <if test="kzbh != null and kzbh != ''">
                and kzbgl.kzbh ILIKE '%'|| #{kzbh} ||'%'
            </if>
            <if test="jcdwmc != null and jcdwmc != ''">
                and jcsj_jcdw.csmc ILIKE '%'|| #{jcdwmc} ||'%'
            </if>
            <if test="kzsjph != null and kzsjph != ''">
                and kzbgl.kzsjph ILIKE '%'|| #{kzsjph} ||'%'
            </if>
            <if test="tqsjph != null and tqsjph != ''">
                and kzbgl.tqsjph ILIKE '%'|| #{tqsjph} ||'%'
            </if>
            <if test="ybbh != null and ybbh != ''">
                and kzbgl.kzbid in (select kzbid from igams_kzbmx where scbj='0' and ybbh  ILIKE '%'|| #{ybbh} ||'%' )
            </if>
            <if test="jcdwxz !=null and jcdwxz.size()>0">
                and kzbgl.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getDtoList" parameterType="KzbglDto" resultType="KzbglDto">
        select kzbgl.kzbid, kzbgl.kzbh, kzbgl.syrq, kzbgl.kzsjph, kzbgl.tqsjph, kzbgl.jcdw, kzbgl.zt,
        jcsj_jcdw.csmc jcdwmc
        from igams_kzbgl kzbgl
        left join matridx_jcsj jcsj_jcdw on jcsj_jcdw.csid = kzbgl.jcdw
        <where>
            kzbgl.scbj = '0' and kzbgl.lrsj>=current_date
        </where>
    </select>

    <select id="getJsjcdwByjsid" parameterType="String" resultType="Map">
        select xtjs.dwxdbj, jsjcdw.jcdw from matridx_xtjs  xtjs
        left join matridx_jsjcdw  jsjcdw on jsjcdw.jsid= xtjs.jsid
        <where>
            xtjs.jsid=#{jsid}
        </where>
    </select>

    <select id="getKzbhSerial" parameterType="String" resultType="String">
        SELECT  lpad(cast((CAST(coalesce(MAX(substring(kzbh,LENGTH(kzbh)-strpos(reverse(kzbh),'-')+2,LENGTH(kzbh))),'0') AS numeric) + 1) as VARCHAR), 3, '0') serial
        FROM igams_kzbgl
        <where>
            scbj = '0' AND kzbh like #{prefix}||'%'
        </where>
    </select>

    <insert id="insertDto" parameterType="KzbglDto">
        insert into igams_kzbgl
        ( lrry, lrsj, scbj, zt
        <if test="kzbid !=null and kzbid !=''">
            ,kzbid
        </if>
        <if test="kzbh !=null and kzbh !=''">
            ,kzbh
        </if>
        <if test="syrq !=null and syrq !=''">
            ,syrq
        </if>
        <if test="kzsjph !=null and kzsjph !=''">
            ,kzsjph
        </if>
        <if test="tqsjph !=null and tqsjph !=''">
            ,tqsjph
        </if>
        <if test="jcdw !=null and jcdw !=''">
            ,jcdw
        </if> )
        values(  #{lrry} , localtimestamp, '0' ,'00'
        <if test="kzbid !=null and kzbid !=''">
            ,#{kzbid}
        </if>
        <if test="kzbh !=null and kzbh !=''">
            ,#{kzbh}
        </if>
        <if test="syrq !=null and syrq !=''">
            ,cast(#{syrq} as timestamp)
        </if>
        <if test="kzsjph !=null and kzsjph !=''">
            ,#{kzsjph}
        </if>
        <if test="tqsjph !=null and tqsjph !=''">
            ,#{tqsjph}
        </if>
        <if test="jcdw !=null and jcdw !=''">
            ,#{jcdw}
        </if>)
    </insert>

    <select id="getDto" parameterType="KzbglDto" resultType="KzbglDto">
        select kzbgl.kzbid, kzbgl.kzbh, kzbgl.syrq, kzbgl.kzsjph, kzbgl.tqsjph, kzbgl.jcdw, kzbgl.zt, jcsj_jcdw.csmc jcdwmc
        from igams_kzbgl kzbgl
        left join matridx_jcsj jcsj_jcdw on jcsj_jcdw.csid = kzbgl.jcdw
        <where>
            kzbgl.scbj='0'
            <if test="kzbid != null and kzbid != ''">
                and kzbgl.kzbid = #{kzbid}
            </if>
            <if test="kzbh != null and kzbh != ''">
                and kzbgl.kzbh=#{kzbh}
            </if>
        </where>
    </select>

    <update id="updateDto" parameterType="KzbglDto">
        update igams_kzbgl
        set xgry=#{xgry} ,xgsj = localtimestamp
        <if test="kzbh != null and kzbh != ''">
            ,kzbh=#{kzbh}
        </if>
        <if test="syrq != null and syrq != ''">
            ,syrq=cast(#{syrq} as timestamp)
        </if>
        <if test="kzsjph != null and kzsjph != ''">
            ,kzsjph=#{kzsjph}
        </if>
        <if test="tqsjph != null and tqsjph != ''">
            ,tqsjph=#{tqsjph}
        </if>
        <if test="jcdw != null and jcdw != ''">
            ,jcdw=#{jcdw}
        </if>
        <if test="zt != null and zt != ''">
            ,zt=#{zt}
        </if>
        <where>
            kzbid=#{kzbid}
        </where>
    </update>

    <update id="delete" parameterType="KzbglDto">
        update igams_kzbgl set scbj = '1', scry =#{scry}, scsj=localtimestamp
        <where>
            <choose>
                <when test="ids !=null and ids.size>0">
                    or kzbid in
                    <foreach collection="ids" open="(" close=")" separator="," item="item">
                        #{item}
                    </foreach>
                </when>
                <otherwise>
                    or kzbid = #{kzbid}
                </otherwise>
            </choose>
        </where>
    </update>

</mapper>
