<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.wechat.dao.post.ISjxxDao" >
   	<!-- 用include方法 把需要查询都字段取出来 -->
	<sql id="SelectAll">
		sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,
        sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
		sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,i_d.xh,i_d.fdwid,i_d.dwdm,sj.fkbj,sj.fkje,sj.nbbm,sj.sfje,sj.sfvip,
		xtyh.zsxm,sj.fkrq,sj.jcbj,case when jcsj.cskz1 = '1' then COALESCE(sj.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sj.syrq,sj.djcbj,sj.dsyrq,sj.qtjcbj,sj.qtsyrq,
		case when sj.qtks is null then i_d.dwmc else sj.qtks end qtks,sj.sfjs,sj.sftj,sj.sfsf,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,jcxmlx.cskz1 as jcxmkzcs,sj.sfsc
        ,sfbz.sfbz,sj.sfzq,sj.lcfk,sj.yxbfk,sj.kdlx,sj.kdh,sj.kdfy,sj.qyrq,sj.ydrq,sj.yjydrq,jc_kd.csmc kdlxmc,jc_jcdw.csmc jcdwmc,sj.jcdw,COALESCE(sj.jcxmmc,jcxmlx.csmc) as jcxmmc,xt_xtyh.zsxm as jsrymc,
		sj.sjdwmc,jc_fl.csmc as flmc,yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as hospitalname,yyxx.cskz1 as yyxxCskz1,
			yyxx.dwjc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as dwjc,jc_sjqf.csmc as sjqfmc,jc_kpsq.csmc as kpsqmc
	</sql>

	<sql id="SelectSJCSS">
		sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,
        sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
		sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,i_d.xh,i_d.fdwid,i_d.dwdm,sj.fkbj,sj.fkje,sj.nbbm,sj.sfje,sj.sfvip,
		xtyh.zsxm,sj.fkrq,sj.jcbj,case when jcsj.cskz1 = '1' then COALESCE(sj.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sj.syrq,sj.djcbj,sj.dsyrq,sj.qtjcbj,sj.qtsyrq,
		case when sj.qtks is null then i_d.dwmc else sj.qtks end qtks,sj.sfjs,sj.sftj,sj.sfsf,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,jcxmlx.cskz1 as jcxmkzcs,sj.sfsc
        ,sfbz.sfbz,sj.sfzq,sj.lcfk,sj.yxbfk,sj.kdlx,sj.kdh,sj.kdfy,sj.qyrq,sj.ydrq,sj.yjydrq,jc_kd.csmc kdlxmc,jc_jcdw.csmc jcdwmc,sj.jcdw,jcxmlx.csmc as jcxmmc,xt_xtyh.zsxm as jsrymc,
		sj.sjdwmc,jc_fl.csmc as flmc,yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as hospitalname,yyxx.cskz1 as yyxxCskz1,
			yyxx.dwjc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as dwjc,jc_sjqf.csmc as sjqfmc,jc_kpsq.csmc as kpsqmc
	</sql>

	<!-- 时效性统计 -->
	<select id="getSxx" parameterType="SjxxDto" resultType="SjxxDto">
		select
		count(bgrq) sxxsj,
			round( round( COUNT ( bgrq ) * 10000 / (select case when count(bgrq) =0 then 1 else count(*) end from igams_sjxx where to_char( bgrq, 'YYYY-MM-DD' ) = #{jsrq} and scbj='0' ), 2 ) / 100, 2 ) sxx
		from
		igams_sjxx
		where  to_char( bgrq, 'YYYY-MM-DD' ) =#{jsrq} and scbj='0' and to_char( bgrq, 'HH24' ) &lt; '12'
	</select>

	<!-- 复测率统计 -->
	<select id="getFcl" parameterType="SjxxDto" resultType="SjxxDto">
		select
		count(lrsj) fclsj,
		round( round( COUNT ( lrsj ) * 10000 / (select case when count(*) =0 then 1 else count(*) end from igams_sjxx where to_char( COALESCE ( dsyrq, syrq,qtsyrq ) + '1 D', 'yyyy-MM-dd' ) =#{jsrq} and scbj='0' ), 2 ) / 100, 2 ) fcl
		from
		igams_fjsq
		where  to_char( lrsj, 'YYYY-MM-DD' ) = #{jsrq}and scbj='0'
	</select>


	<!-- 用include方法 把需要查询都字段取出来 -->
	<sql id="SelectWhere">
		<if test="jcjg !=null and jcjg !='' ">
			and exists
			(	select distinct(bgsm.sjid) from igams_sjbgsm bgsm
	             	where (ggzdzb ILIKE '%'||#{jcjg}||'%' or yszb ILIKE '%'||#{jcjg}||'%') and bgsm.sjid = sj.sjid
	             )
		</if>
		<if test="jcxms !=null and jcxms.length > 0">
			and exists
			(select jcxm.sjid from igams_sjjcxm  jcxm where jcxm.scbj='0' and jcxm.jcxmid in
			<foreach separator="," collection="jcxms" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
			 and jcxm.sjid=sj.sjid) 
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and exists
			(select jcxm.sjid from igams_sjjcxm  jcxm where jcxm.scbj='0' and jcxm.jcxmid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
			and jcxm.sjid=sj.sjid)
		</if>
		<if test="jczxms !=null and jczxms.length > 0">
			and exists
			(select jczxm.sjid from igams_sjjcxm  jczxm where jczxm.scbj='0' and jczxm.jczxmid in
			<foreach separator="," collection="jczxms" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
			and jczxm.sjid=sj.sjid)
		</if>
		<if test="jczxmids !=null and jczxmids.size > 0">
			and exists
			(select jczxm.sjid from igams_sjjcxm  jczxm where jczxm.scbj='0' and jczxm.jczxmid in
			<foreach separator="," collection="jczxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
			and jczxm.sjid=sj.sjid)
		</if>
		<if test="hzxm != null and hzxm != ''">
			and sj.hzxm ILIKE '%'||#{hzxm}||'%'
		</if>
		<if test="nl != null and nl != ''">
			and sj.nl ILIKE '%'||#{nl}||'%'
		</if>
		<if test="xb != null and xb != ''">
			and sj.xb ILIKE '%'||#{xb}||'%'
		</if>
		<if test="hospitalname != null and hospitalname != ''">
			and (yyxx.dwmc ILIKE '%'||#{hospitalname}||'%' or yyxx.dwjc ILIKE '%'||#{hospitalname}||'%' or yyxx.dwqtmc ILIKE '%'||#{hospitalname}||'%' or sj.sjdwmc ILIKE '%'||#{hospitalname}||'%')
		</if>
		<if test="db!=null and db !=''">
		 	and sj.db ILIKE '%'||#{db}||'%'
		</if>
		<if test="yblx != null and yblx != ''">
			and sj.yblx ILIKE '%'||#{yblx}||'%'
		</if>
		<if test="yblxmc != null and yblxmc != ''">
			and sj.yblxmc ILIKE '%'||#{yblxmc}||'%'
		</if>
		<if test="zyh != null and zyh != ''">
			and sj.zyh like '%'||#{zyh}||'%'
		</if>
		<if test="ybbh != null and ybbh != ''">
			and ((sj.ybbh ILIKE '%'||#{ybbh}||'%' or replace(sj.ybbh,
			'0',
			'O') ILIKE '%'||REPLACE(#{ybbh},'0','O')||'%' )
			or (sj.wbbm ILIKE '%'||#{ybbh}||'%' or replace(sj.wbbm,
			'0',
			'O') ILIKE '%'||REPLACE(#{wbbm},'0','O')||'%' ))
		</if>
		<if test="kdh != null and kdh != ''">
			and sj.kdh ILIKE '%'||#{kdh}||'%'
		</if>

		<if test="nbbm != null and nbbm != ''">
			and (sj.nbbm ILIKE '%'||#{nbbm}||'%' or replace(sj.nbbm,
			'0',
			'O') ILIKE '%'||REPLACE(#{nbbm},'0','O')||'%' )
		</if>
		<if test="cskz5 != null and cskz5 != ''">
			and sj.cskz5 ILIKE '%'||#{cskz5}||'%'
		</if>
		<if test="ydrqstart != null and ydrqstart != ''">
			and to_char(sj.ydrq,'yyyy-mm-dd') &gt;= #{ydrqstart}
		</if>
		<if test="ydrqend != null and ydrqend != ''">
			and to_char(sj.ydrq,'yyyy-mm-dd') &lt;= #{ydrqend}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sj.jsrq,'yyyy-mm-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend != null and jsrqend != ''">
			and to_char(sj.jsrq,'yyyy-mm-dd') &lt;= #{jsrqend}
		</if>
		<if test="bgrqstart != null and bgrqstart != ''">
			and to_char(sj.bgrq,'yyyy-mm-dd') &gt;= #{bgrqstart}
		</if>
		<if test="bgrqend != null and bgrqend != ''">
			and to_char(sj.bgrq,'yyyy-mm-dd') &lt;= #{bgrqend}
		</if>
		<if test="fkrqstart != null and fkrqstart != ''">
			and to_char(sj.fkrq,'yyyy-mm-dd') &gt;= #{fkrqstart}
		</if>
		<if test="fkrqend != null and fkrqend != ''">
			and to_char(sj.fkrq,'yyyy-mm-dd') &lt;= #{fkrqend}
		</if>
		<if test="zsxm !=null and zsxm !=''">
			and xtyh.zsxm ILIKE '%'||#{zsxm}||'%'
		</if>
		<if test="lcfk !=null and lcfk !=''">
			and sj.lcfk ILIKE '%'||#{lcfk}||'%'
		</if>
		<if test="sfzq=='0'.toString() or sfzq =='1'.toString()">
			and sj.sfzq=#{sfzq}
		</if>
		<if test="sfzq=='3'.toString()">
			and sj.sfzq is null
		</if>
		<if test = "dwids != null and dwids.length > 0 "  >
			and sj.ks in 
			<foreach collection="dwids" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "kdlxs != null and kdlxs.length > 0 "  >
			and sj.kdlx in 
			<foreach collection="kdlxs" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "gzlxs != null and gzlxs.length > 0 "  >
			and hbxx.gzlx in 
			<foreach collection="gzlxs" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs1 != null and sjkzcs1.length > 0 "  >
			and sj.cskz1 in 
			<foreach collection="sjkzcs1" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs2 != null and sjkzcs2.length > 0 "  >
			and sj.cskz2 in 
			<foreach collection="sjkzcs2" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs3 != null and sjkzcs3.length > 0 "  >
			and sj.cskz3 in 
			<foreach collection="sjkzcs3" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs4 != null and sjkzcs4.length > 0 "  >
			and sj.cskz4 in 
			<foreach collection="sjkzcs4" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "jyjgs != null and jyjgs.length > 0 "  >
			and sj.jyjg in 
			<foreach collection="jyjgs" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="fkbj!=null and fkbj!=''">
			and sj.fkbj=#{fkbj}
		</if>
		<if test="sfjs!=null and sfjs!=''">
			and sj.sfjs=#{sfjs}
		</if>
		<if test="sftj!=null and sftj!=''">
			and sj.sftj=#{sftj}
		</if>
		<if test = "sfsfs != null and sfsfs.length > 0 "  >
			and sj.sfsf in
			<foreach collection="sfsfs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "yblxs != null and yblxs.length > 0 "  >
			and sj.yblx in 
			<foreach collection="yblxs" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "jcdws != null and jcdws.length > 0 "  >
			and sj.jcdw in 
			<foreach collection="jcdws" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "kyxms != null and kyxms.length > 0 "  >
			and sj.kyxm in
			<foreach collection="kyxms" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "kyxm != null and kyxm.length > 0 "  >
			and jc_kyxm.csmc ILIKE '%'||#{kyxm}||'%'
		</if>
		<if test = "kylxs != null and kylxs.length > 0 ">
			and jc_kyxm.cskz1 in
			<foreach collection="kylxs" separator="," open="(" close=") " item="item" index="index">
				<if test = "item == '其它' ">
				null,''
				</if>
				<if test = "item != '其它' ">
					#{item}
				</if>
			</foreach>
		</if>
		<if test="sjqfs != null and sjqfs.length>0">
			and sj.sjqf in
			<foreach collection="sjqfs" separator="," open="(" close=") " item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yyzddjs != null and yyzddjs.length>0">
			and yyxx.cskz2 in
			<foreach collection="yyzddjs" separator="," open="(" close=") " item="item" index="index">
				#{item}
			</foreach>
		</if>
		<!-- 查询是合作关系的合作伙伴 -->
		<if test="dbm =='0'.toString()">
			and hbxx.hbmc is not null
		</if>
		<!-- 查询是不是合作关系的合作伙伴 -->
		<if test="dbm =='1'.toString()">
			and hbxx.hbmc is  null
		</if>
		<if test="syrqflg =='1'.toString()">
			and (
				( sj.syrq is null and sj.dsyrq is null and sj.qtsyrq is null)
				or ( 1=1
						<if test="(syrqstart != null and syrqstart != '') and (syrqend == null or syrqend == '')">
							and (
									to_char(sj.syrq,'yyyy-mm-dd') &gt;= #{syrqstart}
									or to_char(sj.dsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}
									or to_char(sj.qtsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}
							)
						</if>
						<if test="(syrqstart == null or syrqstart == '') and (syrqend != null and syrqend != '')">
							and (
									to_char(sj.syrq,'yyyy-mm-dd') &lt;= #{syrqend}
									or to_char(sj.dsyrq,'yyyy-mm-dd') &lt;= #{syrqend}
									or to_char(sj.qtsyrq,'yyyy-mm-dd') &lt;= #{syrqend}
							)
						</if>
						<if test="syrqstart != null and syrqstart != '' and syrqend != null and syrqend != ''">
							and (
									(to_char(sj.syrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.syrq,'yyyy-mm-dd') &lt;= #{syrqend})
									or (to_char(sj.dsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.dsyrq,'yyyy-mm-dd') &lt;= #{syrqend})
									or (to_char(sj.qtsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.qtsyrq,'yyyy-mm-dd') &lt;= #{syrqend})
							)
						</if>
				)
			)
		</if>
		<if test="syrqflg ==null or syrqflg ==''">
			<if test="(syrqstart != null and syrqstart != '') and (syrqend == null or syrqend == '')">
				and (
						to_char(sj.syrq,'yyyy-mm-dd') &gt;= #{syrqstart}
						or to_char(sj.dsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}
						or to_char(sj.qtsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}
				)
			</if>
			<if test="(syrqstart == null or syrqstart == '') and (syrqend != null and syrqend != '')">
				and (
						to_char(sj.syrq,'yyyy-mm-dd') &lt;= #{syrqend}
						or to_char(sj.dsyrq,'yyyy-mm-dd') &lt;= #{syrqend}
						or to_char(sj.qtsyrq,'yyyy-mm-dd') &lt;= #{syrqend}
				)
			</if>
			<if test="syrqstart != null and syrqstart != '' and syrqend != null and syrqend != ''">
				and (
						(to_char(sj.syrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.syrq,'yyyy-mm-dd') &lt;= #{syrqend})
						or (to_char(sj.dsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.dsyrq,'yyyy-mm-dd') &lt;= #{syrqend})
						or (to_char(sj.qtsyrq,'yyyy-mm-dd') &gt;= #{syrqstart}  and to_char(sj.qtsyrq,'yyyy-mm-dd') &lt;= #{syrqend})
				)
			</if>
		</if>
		<if test="sfsc!=null and sfsc!=''">
			and sj.sfsc=#{sfsc}
			<if test="sfsc =='0'.toString()">
				or sj.sfsc is null
			</if>
		</if>
		<if test="sfzmjc!=null and sfzmjc!=''">
			and sj.sfzmjc=#{sfzmjc}
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			and hbxx.yptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "xsbms != null and xsbms.length > 0"  >
			and hbxx.ptgs in
			<foreach collection="xsbms" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
	</sql>

	<select id="getBbsList"  parameterType="SjxxDto"  resultType="SjxxDto" >
	select sjxx.ybbh,sjxx.hzxm,sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,jc_jcdw.cskz2 jcdwjc,jc_xm.cskz1 jcxmkzcs,
	case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sjxx.db,
	case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否' when sjxx.sfsf='2' then '免D' when sjxx.sfsf='3' then '免R' end sfsf ,
	jc_xm.csmc jcxmmc,yyxx.cskz1 sjdwbj,yyxx.dwmc yymc
	,case when sjsygl.sfjs = '1' then '是' else '否' end sfjs
	from igams_sjxx sjxx
	left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
	left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
	left join igams_xmsygl xmsygl on xmsygl.ywid = sjxx.sjid and xmsygl.scbj ='0'
	left join igams_sjsygl sjsygl on xmsygl.syglid = sjsygl.syglid and sjsygl.scbj ='0'
	left outer join matridx_jcsj jc_xm on jc_xm.csid = xmsygl.jcxmid
	left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
	left outer join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
	<where>
		 (
		to_char( COALESCE ( sjxx.dsyrq, sjxx.syrq, sjxx.qtsyrq ), 'yyyy-MM-dd' ) = #{jsrq}
		OR ( to_char( sjxx.jsrq, 'yyyy-MM-dd' ) = #{jsrq} AND sjsygl.sfjs = '0' )
		)
		<if test="sfjs !=null and sfjs !='' and sfjs !='2'.toString">
		AND sjsygl.sfjs = #{sfjs}
		</if>
		<if test="sfjs !=null and sfjs !='' and sfjs =='2'.toString">
			AND ((jc_xm.cskz3 !='IMP_REPORT_C_TEMEPLATE' and jc_xm.cskz3 !='IMP_REPORT_QINDEX_TEMEPLATE' and jc_xm.cskz3 !='IMP_REPORT_TNGS_TEMEPLATE'
			and jc_xm.cskz3 !='IMP_REPORT_QINDEX_TEMEPLATE_REM' and jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
			and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE') or  sjsygl.sfjs = '2')
			and (sjsygl.sfjs != '1' or (sjsygl.sfjs = '1' and sjxx.sfsf = '0' ))
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			AND jc_xm.cskz3 = #{cskz3}
		</if>
		<if test="sfsf !=null and sfsf !=''and sfjs=='1'.tostring and sfsf=='0'.tostring">
			and sjxx.sfsf=#{sfsf}
		</if>
		<if test="sfsf !=null and sfsf !=''and sfjs=='1'.tostring and  sfsf=='1'.tostring">
			and sjxx.sfsf!='0'
		</if>
		and sjxx.scbj='0'
	</where>
	</select>

	<select id="getBbsListByJsrq"  parameterType="SjxxDto"  resultType="SjxxDto" >
	select sjxx.ybbh,sjxx.hzxm,sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,jc_jcdw.cskz2 jcdwjc,jc_xm.cskz1 jcxmkzcs,
	case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sjxx.db,
	case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否' when sjxx.sfsf='2' then '免D' when sjxx.sfsf='3' then '免R' end sfsf ,
	jc_xm.csmc jcxmmc,yyxx.cskz1 sjdwbj,yyxx.dwmc yymc
	from igams_sjxx sjxx
	left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
	left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
	left join igams_xmsygl xmsygl on xmsygl.ywid = sjxx.sjid and xmsygl.scbj ='0'
	left join igams_sjsygl sjsygl on sjxx.sjid = sjsygl.sjid and sjsygl.scbj ='0'
	left outer join matridx_jcsj jc_xm on jc_xm.csid = xmsygl.jcxmid
	left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
	left outer join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
	<where>
		to_char( sjxx.jsrq, 'yyyy-MM-dd' ) =#{jsrq}
		<if test="sfjs !=null and sfjs !=''">
		AND sjsygl.sfjs = #{sfjs}
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			AND jc_xm.cskz3 = #{cskz3}
		</if>
		<if test="sfsf !=null and sfsf !=''and sfjs=='1'.tostring and sfsf=='0'.tostring">
			and sjxx.sfsf=#{sfsf}
		</if>
		<if test="sfsf !=null and sfsf !=''and sfjs=='1'.tostring and  sfsf=='1'.tostring">
			and sjxx.sfsf!='0'
		</if>
		and sjxx.scbj='0'
	</where>
	</select>

	<!--   获取送检信息 -->
	<select id="getPagedDtoList"  parameterType="SjxxDto"  resultType="SjxxDto" >
		select sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,
        sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
		sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,sj.fkbj,sj.fkje,sj.nbbm,sj.sfje,
		sj.fkrq,sj.jcbj,case when sj.yblxmc is null then jcsj.csmc else sj.yblxmc end as yblxmc,sj.syrq,sj.djcbj,sj.dsyrq,sj.qtjcbj,sj.qtsyrq,
		sj.sfjs,sj.sftj,sj.sfsf,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,sj.sfsc,
        sj.sjqf,sj.kpsq,sj.sfzq,sj.lcfk,sj.yxbfk,sj.kdlx,sj.kdh,sj.kdfy,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,
		sj.sjdwmc,yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as hospitalname,yyxx.cskz1 as yyxxCskz1,
		yyxx.dwjc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as dwjc,
		hbxx.hbid, hbxx.fl hb_fl, hbxx.yhid hb_yhid,sj.qtks
		from igams_sjxx sj 
		left join matridx_jcsj jcsj on sj.yblx = jcsj.csid 
		left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
		left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid 
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
		    <include refid="SelectWhere"></include>
			and sj.scbj='0'
			<if test="userids != null and userids.size()>0">
				and (sj.lrry in
				<foreach collection="userids" open="(" close=")" index="index" item="item" separator=","> 
					#{item}
				</foreach>
				<if test="sjhbs != null and sjhbs.size()>0">
					or sj.db in
					<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=","> 
						#{item}
					</foreach>
				</if>
				)
			</if>
			<if test="all_param !=null and all_param !=''">
				and (
					sj.ybbh = #{all_param}
					or sj.hzxm like '%'||#{all_param}||'%'
					or jcsj.csmc like '%'||#{all_param}||'%'
					or yyxx.dwjc like '%'||#{all_param}||'%'
					or to_char(sj.jsrq,'yyyy-mm-dd') like '%'||#{all_param}||'%'
				)
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
				and sj.jcdw in
				<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in 
				<foreach collection="sjhbfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in 
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>  
	
	<select id="getCountOptimize" parameterType="Map" resultType="int">
		select count(sj.sjid)
			from igams_sjxx sj 
			left join matridx_jcsj jcsj on sj.yblx = jcsj.csid 
			left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
			<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
				left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
			</if>
			<where>
			    <include refid="SelectWhere"></include>
				and sj.scbj='0'
				<if test="userids != null and userids.size()>0">
					and (sj.lrry in
					<foreach collection="userids" open="(" close=")" index="index" item="item" separator=","> 
						#{item}
					</foreach>
					<if test="sjhbs != null and sjhbs.size()>0">
						or sj.db in
						<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=","> 
							#{item}
						</foreach>
					</if>
					)
				</if>
				<if test="all_param !=null and all_param !=''">
					and (
						sj.ybbh = #{all_param}
						or sj.hzxm like '%'||#{all_param}||'%'
						or jcsj.csmc like '%'||#{all_param}||'%'
						or yyxx.dwjc like '%'||#{all_param}||'%'
						or to_char(sj.jsrq,'yyyy-mm-dd') like '%'||#{all_param}||'%'
					)
				</if>
				<if test="jcdwxz !=null and jcdwxz.size()>0">
					and sj.jcdw in
					<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
						#{item}
					</foreach>
				</if>
				<if test = "sjhbfls != null and sjhbfls.length > 0"  >
					and hbxx.fl in 
					<foreach collection="sjhbfls" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
					and hbxx.zfl in 
					<foreach collection="sjhbzfls" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test="sfjc != null and sfjc != ''">
					and sj.bgrq is not null
				</if>
			</where>
	</select>

	<select id="getDtoListOptimize" parameterType="Map" resultType="SjxxDto">
		select sj.sjid ,sj.mxid,sj.hzxm,sj.wbbm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,sj.fkbj,sj.fkje,sj.nbbm,sj.sfje,
		sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.sjrq ,sj.jsrq jsrq,sj.fjsrq fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.bz,sj.lrry,
		sj.fkrq,sj.jcbj,sj.syrq,sj.djcbj,sj.dsyrq,sj.qtjcbj,sj.qtsyrq,sj.sfjs,sj.sftj,sj.sfsf,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,sj.sfsc,
		sj.sjqf,sj.kpsq,sj.sfzq,sj.lcfk,sj.yxbfk,sj.kdlx,sj.kyxm,sj.kdh,sj.kdfy,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,sj.sjdwmc,sj.tkje,sj.sfvip,sj.sqlxmc,
		sj.yblxmc, sj.yyxxCskz1, sj.dwjc, sj.hbid, sj.hb_fl, sj.hb_yhid, sj.zt,
		i_d.xh,i_d.fdwid,i_d.dwdm,i_d.dwmc,case when sj.qtks is null then i_d.dwmc else sj.qtks end qtks,
		xtyh.zsxm,xt_xtyh.zsxm as jsrymc,jcxmlx.cskz1 as jcxmkzcs,COALESCE(sj.jcxmmc,jcxmlx.csmc) jcxmmc,jczxmlx.csmc as jczxmmc,jc_sjqf.csmc as sjqfmc,
		sfbz.sfbz,jc_kd.csmc kdlxmc,jc_ky.csmc kyxmmc,jc_ky.cskz1 kylx,jc_jcdw.csmc jcdwmc,jc_fl.csmc as flmc,jc_kpsq.csmc as kpsqmc,sj.hospitalname,sj.yymc,case when sj.yytjmc is not null then sj.yytjmc else sj.yymc end yytjmc,sj.yyzddj,sj.sfkp,sj.sf,
		CASE WHEN ( sj.sfjs = '0' OR sj.sfjs IS NULL ) THEN '-'
		WHEN sj.sfsf = '0' THEN '0'
		WHEN jcxmlx.cskz3 = 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' THEN
			CASE WHEN jcxmlx.cskz1 = 'D' AND sj.sfsf = '1' THEN '1'
			WHEN jcxmlx.cskz1 = 'R' AND sj.sfsf = '1' THEN '1'
			WHEN jcxmlx.cskz1 = 'C' AND sj.sfsf = '1' THEN '2'
			WHEN jcxmlx.cskz1 = 'C' AND sj.sfsf = '2' THEN '1'
			WHEN jcxmlx.cskz1 = 'C' AND sj.sfsf = '3' THEN '1'
			END
		WHEN jcxmlx.cskz3 = 'IMP_REPORT_SEQ_TNGS_G' AND jcxmlx.cskz1 = 'C' THEN '2'
		WHEN jcxmlx.cskz3 = 'IMP_REPORT_SEQ_XINDEX_TEMEPLATE' THEN '2'
		ELSE '1'
		END sfcss
		,sj.sfws,sj.ptgsmc,sj.xsbmmc,sj.yjddsj
		from (
		select sj.sjid ,sj.mxid,sj.hzxm,sj.wbbm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,sj.fkbj,sj.fkje,sj.nbbm,sj.sfje,
		sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.bz,sj.lrry,
		sj.fkrq,sj.jcbj,sj.syrq,sj.djcbj,sj.dsyrq,sj.qtjcbj,sj.qtsyrq,sj.sfjs,sj.sftj,sj.sfsf,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,sj.sfsc,
		sj.sjqf,sj.kpsq,sj.sfzq,sj.lcfk,sj.yxbfk,sj.kdlx,sj.kyxm,sj.kdh,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,sj.sjdwmc,sj.qtks qtks,sj.sfvip,sj.kdfy,
		sj.sjrq,
		sj.tkje,
		sj.sfws,
		case when sj.yblxmc is null then jcsj.csmc else sj.yblxmc end AS yblxmc,cskz1.csmc sfkp, sj.zt,
		yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as hospitalname,yyxx.cskz1 as yyxxCskz1,
		yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as dwjc,
		yyxx.dwmc yymc,yyxx.tjmc yytjmc,yyxx.cskz2 yyzddj,
		hbxx.hbid, hbxx.fl hb_fl, hbxx.yhid hb_yhid,jcxm.jcxmid,COALESCE(sj.jcxmmc,jc_xm.csmc) jcxmmc,jcxm.jczxmid,sqlx.csmc sqlxmc,yptgs.csmc ptgsmc,ptgs.csmc xsbmmc,
		jc_sf.csmc sf,to_char(sjpdgl.yjddsj,'yyyy-mm-dd hh24:mi:ss') AS yjddsj
		<if test="jclxs != null and jclxs.size()>0">
			,sjbgsm.bgrq
			,row_number() over(partition by sj.sjid order by sjbgsm.bgrq desc) indx
		</if>
		<if test="jclxs == null or jclxs.size()==0">
			,sj.bgrq
		</if>
		from igams_sjxx sj
		left join matridx_jcsj jcsj on sj.yblx = jcsj.csid
		left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join matridx_jcsj jc_sf on jc_sf.csid = hbxx.sf
		left join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
		left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.xh = '1' and jcxm.scbj = '0'
		left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
		left join matridx_jcsj cskz1 on cskz1.csid=sj.cskz1
		left join matridx_jcsj sqlx on sj.sqlx = sqlx.csid
		left join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
		left join matridx_jcsj ptgs on ptgs.csid=hbxx.ptgs
		left join matridx_jcsj yptgs on yptgs.csid=hbxx.yptgs
		left join igams_sjpdgl sjpdgl on sjpdgl.sjid=sj.sjid and sjpdgl.scbj='0'
		<if test="jclxs != null and jclxs.size()>0">
		left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx in
			<foreach collection="jclxs" separator="," open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
			<if test="jczlxs != null and jczlxs.size()>0">
				and sjbgsm.jczlx in
				<foreach collection="jczlxs" separator="," open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
		</if>
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<include refid="SelectWhere"></include>
			and sj.scbj='0'
			<if test="userids != null and userids.size()>0">
				and (sj.lrry in
				<foreach collection="userids" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
				<if test="sjhbs != null and sjhbs.size()>0">
					or sj.db in
					<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
						#{item}
					</foreach>
				</if>
				)
			</if>
			<if test="all_param !=null and all_param !=''">
				and (
				sj.ybbh = #{all_param}
				or sj.hzxm like '%'||#{all_param}||'%'
				or jcsj.csmc like '%'||#{all_param}||'%'
				or yyxx.dwjc like '%'||#{all_param}||'%'
				or yyxx.dwmc like '%'||#{all_param}||'%'
				or yyxx.tjmc like '%'||#{all_param}||'%'
				or to_char(sj.jsrq,'yyyy-mm-dd') like '%'||#{all_param}||'%'
				)
			</if>
			<if test="sjys !=null and sjys !=''">
				and sj.sjys like '%'||#{sjys}||'%'
			</if>
			<if test="bgrqbj !=null and bgrqbj !='' and bgrqbj=='1'.toString">
				and sj.bgrq is null
			</if>
			<if test="dwjc !=null and dwjc !=''">
				and yyxx.dwjc like '%'||#{dwjc}||'%'
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
				and sj.jcdw in
				<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in
				<foreach collection="sjhbfls" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test="jcbj != null and jcbj!=''">
				and sj.jcbj=#{jcbj} and ((jc_xm.cskz1!='D' and jc_xm.cskz1!='Z' and jc_xm.cskz1!='F') OR jc_xm.cskz1 is null)
			</if>
			<if test="djcbj != null and djcbj!=''">
				and sj.djcbj=#{djcbj} and ((jc_xm.cskz1 !='R' and jc_xm.cskz1 !='Z' and jc_xm.cskz1 !='F')OR jc_xm.cskz1 is null)
			</if>
			<if test="qtjcbj != null and qtjcbj!=''">
				and sj.qtjcbj=#{qtjcbj} and (jc_xm.cskz1 ='Z'or jc_xm.cskz1 ='F' or jc_xm.cskz1 ='D' or jc_xm.cskz1 ='R' or jc_xm.cskz1 ='C' jc_xm.cskz1 is null)
			</if>
			<if test="jcxmdms !=null and jcxmdms.size()>0">
				and jc_xm.csdm in
				<foreach collection="jcxmdms" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test="sfjc != null and sfjc != ''">
				and sj.bgrq is not null
			</if>
		</where>
		<if test="(sortName != null and sortName != '') or (sortLastName != null and sortLastName != '')">
			ORDER BY
		</if>
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>

		LIMIT #{pageSize} OFFSET #{pageStart}
		) sj
		left join igams_sjdwxx i_d  on sj.ks=i_d.dwid
		left join matridx_xtyh xtyh on hb_yhid = xtyh.yhid
		left join matridx_jcsj jcxmlx on jcxmlx.csid = sj.jcxmid
		left join matridx_jcsj jczxmlx on jczxmlx.csid = sj.jczxmid
		left join igams_hbsfbz sfbz on sj.hbid = sfbz.hbid and sj.jcxmid = sfbz.xm and case when sj.jczxmid is not null and sj.jczxmid != '' and sfbz.zxm is not null and sfbz.zxm != '' then  sj.jczxmid = sfbz.zxm else 1=1 end
		left join matridx_xtyh xt_xtyh on xt_xtyh.yhid=sj.jsry
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sj.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
		left outer join matridx_jcsj jc_ky on jc_ky.csid =sj.kyxm
		left join matridx_jcsj jc_fl on jc_fl.csid=hb_fl
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sj.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sj.kpsq
		<if test="jclxs != null and jclxs.size()>0">
			where indx=1
		</if>
		<if test="(sortName != null and sortName != '') or (sortLastName != null and sortLastName != '')">
			ORDER BY
		</if>
		<if test="sortName != null and sortName != ''">
			${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
	</select>
	
	
	<!--   查看单个送检信息(送检表) -->
	<select id="getDtoById"  parameterType="String"  resultType="SjxxDto" >
		select
		sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,COALESCE(sj.yblxmc,jcsj.csmc) AS yblxmc ,sj.ybtj,sj.nldw,sj.sfws,to_char(sj.syrq,'yyyy-MM-dd hh24:mi') syrq ,
		sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.sjrq,sj.jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
		to_char(sj.lrsj,'yyyy-MM-dd hh24:mi') lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,i_d.xh,i_d.fdwid,i_d.dwdm,i_d.dwmc,i_d.dh,jcsj.csmc,sj.fkbj,sj.fkje,sj.nbbm,sj.fkrq,sj.qtks,sj.kyxm,kyxm.csmc as kyxmmc,sj.sfjs,sj.sftj,sj.sfsf,sj.sfje,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,jc_jcdw.csmc jcdwmc,jc_jcdw.csdm jcdwdm,sj.sfzmjc,sj.zmxm,sj.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		sj.sjqf,sj.kpsq,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sj.sjdwmc,i_d.dwmc as ksmc,sj.jcxmmc,sj.tksj,sj.tkje,sj.tkfs,jc_tk.csmc as tkfsmc,sj.sfvip,sj.dsyrq,sj.qtsyrq,sj.wbbm,hb.hbid
		from igams_sjxx  sj
		left join igams_sjdwxx i_d on sj.ks=i_d.dwid
		left join matridx_jcsj jcsj on sj.yblx=jcsj.csid
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sj.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sj.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sj.sjdw
		left join matridx_jcsj jc_tk on jc_tk.csid=sj.tkfs
		left join matridx_jcsj kyxm on kyxm.csid=sj.kyxm
		left join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj = '0'
		<where>
 			sj.scbj!='1' and sj.sjid=#{sjid}
  		</where>
	</select>  
	
	<!--   查看单个送检信息(复检表) -->
	<select id="getDtoByFjid"  parameterType="String"  resultType="SjxxDto" >
		select   
	 		sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.yblxmc,sj.ybtj,sj.nldw,
            sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.jsrq,to_char(sj.jsrq,'yyyy-MM-dd'),sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
			sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,i_d.xh,i_d.fdwid,i_d.dwdm,i_d.dwmc,i_d.dh,jcsj.csmc,sj.fkbj,sj.fkje,sj.nbbm,sj.fkrq,sj.qtks
			,sj.sfjs,sj.sftj,sj.sfsf,sj.sfje,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,jc_jcdw.csmc jcdwmc,sj.sfzmjc,sj.zmxm,sj.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
			sj.sjqf,sj.kpsq,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sj.sjdwmc,i_d.dwmc as ksmc,jc.csmc jcxmmc
 		from igams_fjsq fjsq  
 		    left outer join igams_sjxx sj on sj.sjid = fjsq.sjid
 			left join igams_sjdwxx i_d on sj.ks=i_d.dwid
 			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid
 			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
 			left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sj.zmxm
			left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sj.zmmdd
			left join igams_yyxx yyxx on yyxx.dwid =sj.sjdw
			left join igams_sjjcxm jcxm on jcxm.sjid = sj.sjid and jcxm.scbj='0'
			left join matridx_jcsj jc on jc.csid = jcxm.jcxmid
		<where>
 			sj.scbj='0' and fjsq.fjid=#{sjid}
  		</where>
	</select>  
	
	<!-- 修改检测标记（送检表） -->
	<update id="updateJcbjByid" parameterType="SjxxDto">
		update igams_sjxx set xgry=#{xgry},xgsj=LOCALTIMESTAMP,syrq=cast(#{syrq} as TIMESTAMP),dsyrq=cast(#{dsyrq} as TIMESTAMP),qtsyrq=cast(#{qtsyrq} as TIMESTAMP)
		<if test="jcbj !=null and  jcbj !=''">
			,jcbj=#{jcbj}
		</if>
		<if test="djcbj !=null and  djcbj !=''">
			,djcbj=#{djcbj}
		</if>
		<if test="qtjcbj !=null and  qtjcbj !=''">
			,qtjcbj=#{qtjcbj}
		</if>
		<where>
			<if test="ids!=null and ids.size>0">
				and sjid in
				<foreach collection="ids"  open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="sjid != null and  sjid != ''">
				and sjid=#{sjid}
			</if>
		</where>
	</update>
	<update id="updateByid" parameterType="SjxxModel">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="lrry !=null and  lrry !=''">
			,lrry=#{lrry}
		</if>
		<if test="wbbm !=null and  wbbm !=''">
			,wbbm=#{wbbm}
		</if>
		<if test="hzxm !=null and  hzxm !=''">
			,hzxm=#{hzxm}
		</if>
		<if test="xb !=null and  xb !=''">
			,xb=#{xb}
		</if>
		<if test="nl !=null and  nl !=''">
			,nl=#{nl}
		</if>
		<if test="nldw !=null and  nldw !=''">
			,nldw=#{nldw}
		</if>
		<if test="sjdw !=null and  sjdw !=''">
			,sjdw=#{sjdw}
		</if>
		<if test="sjdwmc !=null and  sjdwmc !=''">
			,sjdwmc=#{sjdwmc}
		</if>
		<if test="yblx !=null and  yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="yblxmc !=null and  yblxmc !=''">
			,yblxmc=#{yblxmc}
		</if>
		<if test="ks !=null and  ks !=''">
			,ks=#{ks}
		</if>
		<if test="qtks !=null and  qtks !=''">
			,qtks=#{qtks}
		</if>
		<if test="lczz !=null and  lczz !=''">
			,lczz=#{lczz}
		</if>
		<where>
			sjid=#{sjid}
		</where>
	</update>
	<!-- 修改送检信息 -->
	<update id="update" parameterType="SjxxModel">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="lrry !=null and  lrry !=''">
			,lrry=#{lrry}
		</if>
		<if test="wbbm !=null and  wbbm !=''">
			,wbbm=#{wbbm}
		</if>
		<if test="wbbm ==null or  wbbm ==''">
			,wbbm=null
		</if>
		<if test="yblxmc !=null and  yblxmc !=''">
			,yblxmc=#{yblxmc}
		</if>
		<if test="hzxm !=null and  hzxm !=''">
			,hzxm=#{hzxm}
		</if>
		<if test="xb !=null and  xb !=''">
			,xb=#{xb}
		</if>
		<if test="nl !=null and  nl !=''">
			,nl=#{nl}
		</if>
		<if test="nldw !=null and  nldw !=''">
			,nldw=#{nldw}
		</if>
		<if test="dh !=null">
			,dh=#{dh}
		</if>
		<if test="sjdw !=null and  sjdw !=''">
			,sjdw=#{sjdw}
		</if>
		<if test="sjdwmc !=null and  sjdwmc !=''">
			,sjdwmc=#{sjdwmc}
		</if>
		<if test="sfjs !=null and  sfjs !=''">
			,sfjs=#{sfjs}
		</if>
		<if test="sftj !=null and  sftj !=''">
			,sftj=#{sftj}
		</if>
		<if test="ks !=null and  ks !=''">
			,ks=#{ks}
		</if>
		<if test="sjys !=null and  sjys !=''">
			,sjys=#{sjys}
		</if>
		<if test="ysdh !=null">
			,ysdh=#{ysdh}
		</if>
		<if test="yblx !=null and  yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="db!=null and db !=''">
			,db=#{db}
		</if>
		<if test="ybtj !=null and  ybtj !=''">
			,ybtj=#{ybtj}
		</if>
		<if test="zyh !=null">
			,zyh=#{zyh}
		</if>
		<if test="cwh != null and cwh !=''">
			,cwh=#{cwh}
		</if>
		<if test="ybbh !=null and  ybbh !=''">
			,ybbh=#{ybbh}
		</if>
		<if test="cyrq !=null and  cyrq !=''">
			,cyrq=cast(#{cyrq} as date)
		</if>
		<if test="jsrq !=null and jsrq !=''">
			,jsrq=cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsry !=null and  jsry !=''">
			,jsry=#{jsry} 
		</if>
		<if test="bgrq !=null and bgrq!=''">
			,bgrq=cast(#{bgrq} as timestamp)
		</if>
		<if test="fkrq !=null and fkrq !=''">
			,fkrq=cast(#{fkrq} as timestamp)
		</if>
		<if test="lczz !=null and  lczz !=''">
			,lczz=#{lczz}
		</if>
		<if test="qqzd !=null and  qqzd !=''">
			,qqzd=#{qqzd}
		</if>
		<if test="jqyy !=null">
			,jqyy=#{jqyy}
		</if>
		<if test="qqjc !=null">
			,qqjc=#{qqjc}
		</if>
		<if test="jyjg !=null and  jyjg !=''">
			,jyjg=#{jyjg}
		</if>
		<if test="kdlx !=null and  kdlx !=''">
			,kdlx=#{kdlx}
		</if>
		<if test="kdh !=null and  kdh !=''">
			,kdh=#{kdh}
		</if>
		<if test="kdh ==null or  kdh ==''">
			,kdh=null
		</if>
		<if test="kdfy !=null and  kdfy !=''">
            <!-- ,kdfy=cast(#{kdfy} as numeric) -->
            ,kdfy = #{kdfy}
        </if>
		<if test="bz !=null">
			,bz=#{bz}
		</if>
		<if test="fkbj !=null and  fkbj !=''">
			,fkbj=#{fkbj}
		</if>
		<if test="fkje !=null and fkje !=''">
			,fkje=cast(#{fkje} as numeric)
		</if>
		<if test="fkje ==null or fkje ==''">
			,fkje=null
		</if>
		<if test="nbbm !=null">
			,nbbm=#{nbbm}
		</if>
		<if test="ddh !=null and  ddh !=''">
			,ddh=#{ddh}
		</if>
		<if test="sfsf !=null and  sfsf !=''">
			,sfsf=#{sfsf}
		</if>
		<if test="zt !=null and  zt !=''">
			,zt=#{zt}
		</if>
		<if test="sfzq !=null and sfzq !=''">
			,sfzq=#{sfzq}
		</if>
		<if test="lcfk !=null and lcfk !=''">
			,lcfk=#{lcfk}
		</if>
		<if test="qyrq !=null and qyrq !=''">
			,qyrq=cast(#{qyrq} as timestamp)
		</if>
		<if test="ydrq !=null and ydrq !=''">
			,ydrq=cast(#{ydrq} as timestamp)
		</if>
		<if test="yjydrq !=null and yjydrq !=''">
			,yjydrq=cast(#{yjydrq} as timestamp)
		</if>
		<if test="qyrq ==null or qyrq ==''">
			,qyrq=null
		</if>
		<if test="ydrq ==null or ydrq ==''">
			,ydrq = null
		</if>
		<if test="yjydrq ==null or yjydrq ==''">
			,yjydrq = null
		</if>
		<if test="jcdw !=null and jcdw!=''">
			,jcdw=#{jcdw}
		</if>
		<if test="jcxmmc !=null and jcxmmc!=''">
			,jcxmmc=#{jcxmmc}
		</if>
		<if test="q20 !=null and q20 !=''">
			,q20=#{q20}
		</if>
		<if test="q30 !=null and q30 !=''">
			,q30=#{q30}
		</if>
		<if test="jcjg !=null and  jcjg !=''">
			,jcjg=#{jcjg}
		</if>
		<if test="ysjg !=null and  ysjg !=''">
			,ysjg=#{ysjg}
		</if>
		<if test="dzjg !=null and  dzjg !=''">
			,dzjg=#{dzjg}
		</if>
		<if test="cskz6 !=null and  cskz6 !=''">
			,cskz6=#{cskz6}
		</if>
		<if test="sfzmjc !=null and sfzmjc !=''">
			<if test="sfzmjc== '0'.toString() ">
				,zmmdd=null
			</if>
			<if test="sfzmjc== '1'.toString() ">
				,zmmdd=#{zmmdd}
			</if>
		</if>
			,qtks=#{qtks}
			,px=#{px}
		<if test="mxid !=null and  mxid !=''">
			,mxid=#{mxid}
		</if>
		<if test="sfsc != null and sfsc != ''">
			, sfsc = #{sfsc}
		</if>
		<if test="sjqf != null and sjqf != ''">
			, sjqf = #{sjqf}
		</if>
		<if test="scbj !=null and scbj !=''">
			,scbj = #{scbj}
		</if>
		<if test="scbj == null or scbj == ''">
			,scbj = '0'
		</if>
		<where>
			sjid=#{sjid}
		</where>
		</update>



	<!-- 修改送检信息 -->
	<update id="updateModel" parameterType="SjxxDto">
			update igams_sjxx set
			xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="hzxm !=null and  hzxm !=''">
			,hzxm=#{hzxm}
		</if>
		<if test="xb !=null and  xb !=''">
			,xb=#{xb}
		</if>
		<if test="nl !=null and  nl !=''">
			,nl=#{nl}
		</if>
		<if test="nldw !=null and  nldw !=''">
			,nldw=#{nldw}
		</if>
		<if test="dh !=null">
			,dh=#{dh}
		</if>
		<if test="sjdw !=null and  sjdw !=''">
			,sjdw=#{sjdw}
		</if>
		<if test="ks !=null and  ks !=''">
			,ks=#{ks}
		</if>
		<if test="sjys !=null and  sjys !=''">
			,sjys=#{sjys}
		</if>
		<if test="ysdh !=null">
			,ysdh=#{ysdh}
		</if>
		<if test="yblx !=null and  yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="db!=null and db !=''">
			,db=#{db}
		</if>
		<if test="yblxmc !=null and  yblxmc!=''">
			,yblxmc=#{yblxmc}
		</if>
		<if test="ybtj !=null and  ybtj !=''">
			,ybtj=#{ybtj}
		</if>
		<if test="zyh !=null">
			,zyh=#{zyh}
		</if>
		<if test="cwh !=null and cwh!=''">
			,cwh=#{cwh}
		</if>
		<if test="ybbh !=null and  ybbh !=''">
			,ybbh=#{ybbh}
		</if>
		<if test="cyrq !=null and  cyrq !=''">
			,cyrq=cast(#{cyrq} as date)
		</if>
		<if test="jsrq !=null and jsrq !=''">
			,jsrq=cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsry !=null and  jsry !=''">
			,jsry=#{jsry} 
		</if>
		<if test="bgrq !=null and bgrq!=''">
			,bgrq=cast(#{bgrq} as timestamp)
		</if>
		<if test="fkrq !=null and fkrq !=''">
			,fkrq=cast(#{fkrq} as timestamp)
		</if>
		<if test="lczz !=null and  lczz !=''">
			,lczz=#{lczz}
		</if>
		<if test="qqzd !=null and  qqzd !=''">
			,qqzd=#{qqzd}
		</if>
		<if test="jqyy !=null">
			,jqyy=#{jqyy}
		</if>
		<if test="qqjc !=null">
			,qqjc=#{qqjc}
		</if>
		<if test="jyjg !=null and  jyjg !=''">
			,jyjg=#{jyjg}
		</if>
		<if test="kdlx !=null and  kdlx !=''">
			,kdlx=#{kdlx}
		</if>
		<if test="kdh !=null and  kdh !=''">
			,kdh=#{kdh}
		</if>
        <if test="kdfy !=null and  kdfy !=''">
            <!-- ,kdfy=cast(#{kdfy} as numeric) -->
            ,kdfy=#{kdfy}
        </if>
		<if test="bz !=null and  bz !=''">
			,bz=#{bz}
		</if>
		<if test="fkbj !=null and  fkbj !=''">
			,fkbj=#{fkbj}
		</if>
		<if test="fkje !=null">
			,fkje=cast(#{fkje} as numeric)
		</if>
		<if test="nbbm !=null">
			,nbbm=#{nbbm}
		</if>
		<if test="ddh !=null and  ddh !=''">
			,ddh=#{ddh}
		</if>
		<if test="q20 !=null and  q20 !=''">
			,q20=#{q20}
		</if>
		<if test="q30 !=null and  q30 !=''">
			,q30=#{q30}
		</if>
		<if test="sfzmjc !=null and sfzmjc !=''">
			<if test="sfzmjc== '0'.toString() ">
				,zmmdd=null
			</if>
			<if test="sfzmjc== '1'.toString() ">
				,zmmdd=#{zmmdd}
			</if>
		</if>
		<if test="jcjg !=null and jcjg !=''">
			,jcjg=#{jcjg}
		</if>
		<if test="sfsf !=null and sfsf !=''">
			,sfsf=#{sfsf}
		</if>
		<if test="sfvip !=null and  sfvip !=''">
			,sfvip=#{sfvip}
		</if>
		<if test="cskz1 !=null and cskz1 !=''">
			,cskz1=#{cskz1}
		</if>
		<if test="sqlx !=null and sqlx !=''">
			,sqlx=#{sqlx}
		</if>
			,qtks=#{qtks}
		<where>
			sjid=#{sjid}
		</where>
	</update>

<!--	修改送检信息-->
	<update id="updateDto" parameterType="SjxxDto">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="jcsj !=null and  jcsj !=''">
			,jcsj=cast(#{jcsj} as timestamp )
		</if>
		<if test="clbj !=null and  clbj !=''">
			,clbj=#{clbj}
		</if>
		<where>
			sjid=#{sjid}
		</where>
	</update>
		<select id="getSjdw" resultType="SjdwxxDto">
		select 
			i.dwid,i.xh,i.fdwid,i.dwdm,i.dwmc,i.dh,i.lrry,i.lrsj,i.xgry,i.xgsj,i.scry,i.scsj,i.scbj,i.kzcs,i.kzcs2,i.kzcs3
		from
			igams_sjdwxx i
		where 
			i.scbj !='1'
		</select>
        
        
	<!-- 根据送检ID获取送检信息 -->
	<select id="getInfListCount" parameterType="SjxxDto" resultType="int">
		select count(sjxx.sjid) 
			from igams_sjxx sjxx
			<where>
				sjxx.scbj = '0'
				<if test="applydatestart != null and applydatestart != ''">
					and to_char(sjxx.cyrq,'yyyy-mm-dd') &gt;= #{applydatestart}
				</if>
				<if test="applydateend != null and applydateend != ''">
					and to_char(sjxx.cyrq,'yyyy-mm-dd') &lt;= #{applydateend}
				</if>
				<if test="samplecode != null and samplecode != ''">
					and ybbh = #{samplecode}
				</if>
			</where>
	</select>
	
	<!-- 根据送检ID获取送检信息 -->
	<select id="getInfList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,
		sjxx.yblxmc,sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,sjxx.fkbj,sjxx.fkje,
		sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,dw.dwmc ksmc,dw.dwdm ksdm,
		case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'  when sjxx.xb='3' then'未知' end xbmc
			from igams_sjxx sjxx
			left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
			<where>
				sjxx.scbj = '0'
				<if test="applydatestart != null and applydatestart != ''">
					and to_char(sjxx.cyrq,'yyyy-mm-dd') &gt;= #{applydatestart}
				</if>
				<if test="applydateend != null and applydateend != ''">
					and to_char(sjxx.cyrq,'yyyy-mm-dd') &lt;= #{applydateend}
				</if>
				<if test="samplecode != null and samplecode != ''">
					and ybbh = #{samplecode}
				</if>
				
			</where>
			order by cyrq asc
			LIMIT #{pageSize} OFFSET #{pageSize}*${startpage}
	</select>
	
<!-- 增加送检信息 -->
	<insert id="insert" parameterType="SjxxModel">
		insert into igams_sjxx(sjid
		<if test="hzxm !=null and hzxm != ''">
			,hzxm
		</if>
		<if test="xb !=null and xb != ''">
			,xb
		</if>
		<if test="jcbj !=null and jcbj !=''">
			,jcbj
		</if>
		<if test="nl !=null and nl != ''">
			,nl
		</if>
		<if test="nldw !=null and nldw != ''">
			,nldw
		</if>
		<if test="dh !=null and dh != ''">
			,dh
		</if>
		<if test="sjdw !=null and sjdw != ''">
			,sjdw
		</if>
		<if test="ks !=null and ks != ''">
			,ks
		</if>
		<if test="sjys !=null and sjys != ''">
			,sjys
		</if>
		<if test="ysdh !=null and ysdh != ''">
			,ysdh
		</if>
		<if test="db !=null and db != ''">
			,db
		</if>
		<if test="yblx !=null and yblx != ''">
			,yblx
		</if>
		<if test="yblxmc !=null and yblxmc != ''">
			,yblxmc
		</if>
		<if test="ybtj !=null and ybtj != ''">
			,ybtj
		</if>
		<if test="zyh !=null and zyh != ''">
			,zyh
		</if>
		<if test="cwh !=null and cwh != ''">
			,cwh
		</if>
		<if test="ybbh !=null and ybbh != ''">
			,ybbh
		</if>
		<if test="cyrq !=null and cyrq != ''">
			,cyrq
		</if>
		<if test="sjrq !=null and sjrq != ''">
			,sjrq
		</if>
		<if test="jsrq !=null and jsrq != ''">
			,jsrq
		</if>
		<if test="jsry !=null and jsry != ''">
			,jsry
		</if>
		<if test="bgrq !=null and bgrq != ''">
			,bgrq
		</if>
		<if test="lczz !=null and lczz != ''">
			,lczz
		</if>
		<if test="qqzd !=null and qqzd != ''">
			,qqzd
		</if>
		<if test="jqyy !=null and jqyy != ''">
			,jqyy
		</if>
		<if test="qqjc !=null and qqjc != ''">
			,qqjc
		</if>
		<if test="jyjg !=null and jyjg != ''">
			,jyjg
		</if>
		<if test="kdlx !=null and kdlx != ''">
			,kdlx
		</if>
		<if test="kdh !=null and kdh != ''">
			,kdh
		</if>
        <if test="kdfy !=null and kdfy != ''">
            ,kdfy
        </if>
		<if test="bz !=null and bz != ''">
			,bz
		</if>
		<if test="fkbj !=null and fkbj != ''">
			,fkbj
		</if>
		<if test="fkje !=null and fkje != ''">
			,fkje
		</if>
		<if test="sfje !=null and sfje != ''">
			,sfje
		</if>
		<if test="ddh !=null and ddh != ''">
			,ddh
		</if>
		<if test="nbbm !=null and nbbm != ''">
			,nbbm
		</if>
		<if test="fkrq !=null and fkrq !=''">
			,fkrq
		</if>
		<if test="qtks !=null and qtks !=''">
			,qtks
		</if>
		<if test="sfjs !=null and sfjs !=''">
			,sfjs
		</if>
		<if test="sftj !=null and sftj !=''">
			,sftj
		</if>
		<if test="zt !=null and zt !=''">
			,zt
		</if>
		<if test="sfzq !=null and sfzq !=''">
			,sfzq
		</if>
		<if test="lcfk !=null and lcfk !=''">
			,lcfk
		</if>
		<if test="cskz1 !=null and cskz1 !=''">
			,cskz1
		</if>
		<if test="cskz2 !=null and cskz2 !=''">
			,cskz2
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			,cskz3
		</if>
		<if test="cskz4 !=null and cskz4 !=''">
			,cskz4
		</if>
		<if test="cskz5 !=null and cskz5 !=''">
			,cskz5
		</if>
		<if test="cskz6 !=null and cskz6 !=''">
			,cskz6
		</if>
		<if test="qyrq !=null and qyrq !=''">
			,qyrq
		</if>
		<if test="ydrq !=null and ydrq !=''">
			,ydrq
		</if>
		<if test="yjydrq !=null and yjydrq !=''">
			,yjydrq
		</if>
		<if test="jcdw !=null and jcdw !=''">
			,jcdw
		</if>
		<if test="wbbm !=null and wbbm !=''">
			,wbbm
		</if>
		<if test="zmmdd !=null and zmmdd !=''">
			,zmmdd
		</if>
		<if test="sjqf !=null and sjqf !='' ">
			,sjqf
		</if>
		<if test="kpsq !=null and kpsq !='' ">
			,kpsq
		</if>
		<if test="sjdwmc !=null and sjdwmc !='' ">
			,sjdwmc
		</if>
		<if test="mxid !=null and  mxid !=''">
			,mxid
		</if>
		<if test="kyxm !=null and  kyxm !=''">
			,kyxm
		</if>
			,lrry,lrsj,clbj,scbj,sfsf
		<if test="sfvip !=null and  sfvip !=''">
		,sfvip
		</if>
		<if test="sfws != null and sfws !=''">
			,sfws
		</if>
		<if test="jcxmmc != null and jcxmmc != ''">
			,jcxmmc
		</if>
			) values(#{sjid}
		<if test="hzxm !=null and hzxm != ''">
			,#{hzxm}
		</if>
		<if test="xb !=null and xb != ''">
			,#{xb}
		</if>
		<if test="jcbj !=null and jcbj !=''">
			,#{jcbj}
		</if>
		<if test="nl !=null and nl != ''">
			,#{nl}
		</if>
		<if test="nldw !=null and nldw != ''">
			,#{nldw}
		</if>
		<if test="dh !=null and dh != ''">
			,#{dh}
		</if>
		<if test="sjdw !=null and sjdw != ''">
			,#{sjdw}
		</if>
		<if test="ks !=null and ks != ''">
			,#{ks}
		</if>
		<if test="sjys !=null and sjys != ''">
			,#{sjys}
		</if>
		<if test="ysdh !=null and ysdh != ''">
			,#{ysdh}
		</if>
		<if test="db !=null and db != ''">
			,#{db}
		</if>
		<if test="yblx !=null and yblx != ''">
			,#{yblx}
		</if>
		<if test="yblxmc !=null and yblxmc != ''">
			,#{yblxmc}
		</if>
		<if test="ybtj !=null and ybtj != ''">
			,#{ybtj}
		</if>
		<if test="zyh !=null and zyh != ''">
			,#{zyh}
		</if>
		<if test="cwh !=null and cwh != ''">
			,#{cwh}
		</if>
		<if test="ybbh !=null and ybbh != ''">
			,#{ybbh}
		</if>
		<if test="cyrq !=null and cyrq != ''">
			,cast(#{cyrq} as date)
		</if>
		<if test="sjrq !=null and sjrq != ''">
			,cast(#{sjrq} as date)
		</if>
		<if test="jsrq !=null and jsrq != ''">
			,cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsry !=null and jsry != ''">
			,#{jsry}
		</if>
		<if test="bgrq !=null and bgrq != ''">
			,cast(#{bgrq} as timestamp)
		</if>
		<if test="lczz !=null and lczz != ''">
			,#{lczz}
		</if>
		<if test="qqzd !=null and qqzd != ''">
			,#{qqzd}
		</if>
		<if test="jqyy !=null and jqyy != ''">
			,#{jqyy}
		</if>
		<if test="qqjc !=null and qqjc != ''">
			,#{qqjc}
		</if>
		<if test="jyjg !=null and jyjg != ''">
			,#{jyjg}
		</if>
		<if test="kdlx !=null and kdlx != ''">
			,#{kdlx}
		</if>
		<if test="kdh !=null and kdh != ''">
			,#{kdh}
		</if>
        <if test="kdfy !=null and kdfy != ''">
            ,#{kdfy}
        </if>
		<if test="bz !=null and bz != ''">
			,#{bz}
		</if>
		<if test="fkbj !=null and fkbj != ''">
			,#{fkbj}
		</if>
		<if test="fkje !=null and fkje != ''">
			,cast(#{fkje} as numeric)
		</if>
		<if test="sfje !=null and sfje != ''">
			,cast(#{sfje} as numeric)
		</if>
		<if test="ddh !=null and ddh != ''">
			,#{ddh}
		</if>
		<if test="nbbm !=null and nbbm != ''">
			,#{nbbm}
		</if>
		<if test="fkrq !=null and fkrq !=''">
			,cast(#{fkrq} as TIMESTAMP)
		</if>
		<if test="qtks !=null and qtks !=''">
			,#{qtks}
		</if>
		<if test="sfjs !=null and sfjs !=''">
			,#{sfjs}
		</if>
		<if test="sftj !=null and sftj !=''">
			,#{sftj}
		</if>
		<if test="zt !=null and zt !=''">
			,#{zt}
		</if>
		<if test="sfzq !=null and sfzq !=''">
			,#{sfzq}
		</if>
		<if test="lcfk !=null and lcfk !=''">
			,#{lcfk}
		</if>
		<if test="cskz1 !=null and cskz1 !=''">
			,#{cskz1}
		</if>
		<if test="cskz2 !=null and cskz2 !=''">
			,#{cskz2}
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			,#{cskz3}
		</if>
		<if test="cskz4 !=null and cskz4 !=''">
			,#{cskz4}
		</if>
		<if test="cskz5 !=null and cskz5 !=''">
			,#{cskz5}
		</if>
		<if test="cskz6 !=null and cskz6 !=''">
			,#{cskz6}
		</if>
		<if test="qyrq !=null and qyrq !=''">
			,cast(#{qyrq} as TIMESTAMP)
		</if>
		<if test="ydrq !=null and ydrq !=''">
			,cast(#{ydrq} as TIMESTAMP)
		</if>
		<if test="yjydrq !=null and yjydrq !=''">
			,cast(#{yjydrq} as TIMESTAMP)
		</if>
		<if test="jcdw !=null and jcdw !=''">
			,#{jcdw}
		</if>
		<if test="wbbm !=null and wbbm !=''">
			,#{wbbm}
		</if>
		<if test="zmmdd !=null and zmmdd !=''">
			,#{zmmdd}
		</if>
		<if test="sjqf !=null and sjqf !='' ">
			,#{sjqf}
		</if>
		<if test="kpsq !=null and kpsq !='' ">
			,#{kpsq}
		</if>
		<if test="sjdwmc !=null and sjdwmc !='' ">
			,#{sjdwmc}
		</if>
		<if test="mxid !=null and  mxid !=''">
			,#{mxid}
		</if>
		<if test="kyxm !=null and  kyxm !=''">
			,#{kyxm}
		</if>
			,#{lrry},LOCALTIMESTAMP,'1'
		<if test="scbj !=null and scbj !=''">
			,#{scbj}
		</if>
		<if test="scbj == null or scbj == ''">
			,'0'
		</if>
		<if test="sfsf == null or sfsf == ''.toString()">
			,'1'
		</if>
		<if test="sfsf != null and sfsf != ''.toString()">
			,#{sfsf}
		</if>
		<if test="sfvip != null and sfvip !=''">
			,#{sfvip}
		</if>
		<if test="sfws != null and sfws !=''">
			,#{sfws}
		</if>
		<if test="jcxmmc != null and jcxmmc != ''">
			,#{jcxmmc}
		</if>
			)
	</insert>
			<!-- 删除送检信息 -->
			
	<update id="delete" parameterType="SjxxModel">
		update igams_sjxx set scry=#{scry},scsj=LOCALTIMESTAMP,scbj='1'
		<where>
			<if test="sjid !=null and sjid !=''">
	 			or sjid = #{sjid}
	 		</if>
	 	  	<if test="ids !=null and ids.size>0">
	 	  	  	or sjid in
	 	  	  		<foreach collection="ids" open="(" close=")" separator="," item="item">
	 	  	  			 #{item}
	 	  	  		</foreach>
	 	  	</if>
		</where>
	</update>

	<select id="getJsrqIsNull" parameterType="SjxxDto" resultType="String">
		select sjxx.sjid
		from igams_sjxx sjxx
		<where>
            sjxx.jsrq is null and (sjxx.sfjs is null or sjxx.sfjs ='0') and sjxx.scbj ='0' and sjid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		</where>
	</select>
	
	<!-- 根据送检ID获取送检信息 -->
	<select id="getDto" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.bgrq,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,sjxx.cskz1,sjxx.jcxmmc,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.sjrq,sjxx.jsrq,sjxx.jsry,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,
        sjxx.bz,sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,jc_ky.csmc kyxmmc,jc_ky.cskz1 kylx,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		case when jc.cskz1 = '1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,COALESCE(sjxx.yblxmc,jc.csmc) as csmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvipmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvip,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,hb.wjmgz,hb.cskz3 hbcskz3,
        sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,jc_jcdw.csdm jcdwdm,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,dw.kzcs2 kskzcs2,hb.hbid,sjxx.cskz6,sjxx.wbbm,yyxx.cskz3 yyxxCskz3
		,to_char(sjxx.dsyrq,'YYYY-MM-DD hh24:mi') dsyrq,to_char(sjxx.syrq,'YYYY-MM-DD hh24:mi') syrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj,to_char(sjxx.qtsyrq,'YYYY-MM-DD hh24:mi') qtsyrq,sjxx.sjqf,
		ptgs.csmc ptgsmc, to_char(sjxx.bgrq, 'yyyy-MM-dd') AS report_date,to_char(coalesce(sjxx.syrq,sjxx.dsyrq,sjxx.dsyrq,sjxx.qtsyrq),'YYYY-MM-DD hh24:mi:ss') as syrqend,jc_jcdw.cskz5 as jcdwcskz5
			from igams_sjxx sjxx
			left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
			left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
			left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
			left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
			left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
			left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
			left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
			left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
			left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
			left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
			left outer join matridx_jcsj jc_ky on jc_ky.csid =sjxx.kyxm
			left join matridx_jcsj ptgs on ptgs.csid=hb.ptgs

		<if test="yzid != null and yzid !=''">
				left join igams_sjyz sjyz on sjyz.sjid = sjxx.sjid
			</if>
			<where>
				sjxx.scbj = '0'
				<if test="sjid != null and sjid != ''">
					and sjxx.sjid = #{sjid}
				</if>
				<if test="ybbh != null and ybbh != ''">
					and (sjxx.ybbh = #{ybbh} or sjxx.wbbm = #{ybbh})
				</if>
				<if test="nbbm != null and nbbm != ''">
					and sjxx.nbbm = #{nbbm}
				</if>
				<if test="wxid != null and wxid != ''">
					and sjxx.lrry = #{wxid}
				</if>
				<if test="yzid != null and yzid !=''">
					and sjyz.yzid = #{yzid}
				</if>
				<if test="jcdwxz !=null and jcdwxz.size()>0">
					and sjxx.jcdw in
					<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
						#{item}
					</foreach>
				</if>
			</where>
	</select>
	<select id="getDtoMap" parameterType="SjxxDto" resultType="Map">
		select sjxx.sjid,sjxx.bgrq,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,sjxx.cskz1,sjxx.jcxmmc,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.sjrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,
		sjxx.bz,sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,jc_ky.csmc kyxmmc,jc_ky.cskz1 kylx,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		case when jc.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvipmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvip,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,hb.wjmgz,hb.cskz3 hbcskz3,
		sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,dw.kzcs2 kskzcs2,hb.hbid,sjxx.cskz6,sjxx.wbbm,yyxx.cskz3 yyxxCskz3
		,to_char(sjxx.dsyrq,'YYYY-MM-DD hh24:mi') dsyrq,to_char(sjxx.syrq,'YYYY-MM-DD hh24:mi') syrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj,to_char(sjxx.qtsyrq,'YYYY-MM-DD hh24:mi') qtsyrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj,sjxx.sjqf,
		to_char(sjxx.jsrq,'YYYY-MM-DD hh24:mi:ss') mjsrq,to_char(sjxx.bgrq,'YYYY-MM-DD hh24:mi:ss') mbgrq,to_char(coalesce(sjxx.syrq,sjxx.dsyrq,sjxx.dsyrq,sjxx.qtsyrq),'YYYY-MM-DD hh24:mi:ss') msyrq
		,to_char(sjxx.bgrq, 'yyyy-MM-dd') AS report_date,
		ptgs.csmc ptgsmc,hb.bz as hbbz,hbjb.csmc hbjbmc,hb.kzsz,
		(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_qq.csmc||':'||qqjcmc.jcz||jc_qq.cskz1))), ',') from igams_sjqqjc qqjcmc
		left outer join matridx_jcsj jc_qq on qqjcmc.yjxm = jc_qq.csid where sjxx.sjid = qqjcmc.sjid )|| '  ' || sjxx.qqjc qqjc
		from igams_sjxx sjxx
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
		left outer join matridx_jcsj jc_ky on jc_ky.csid =sjxx.kyxm
		left join matridx_jcsj ptgs on ptgs.csid=hb.ptgs
		left join matridx_jcsj hbjb on hbjb.csid=hb.hbjb

		<if test="yzid != null and yzid !=''">
			left join igams_sjyz sjyz on sjyz.sjid = sjxx.sjid
		</if>
		<where>
			sjxx.scbj = '0'
			<if test="sjid != null and sjid != ''">
				and sjxx.sjid = #{sjid}
			</if>
			<if test="ybbh != null and ybbh != ''">
				and (sjxx.ybbh = #{ybbh} or sjxx.wbbm = #{ybbh})
			</if>
			<if test="nbbm != null and nbbm != ''">
				and sjxx.nbbm = #{nbbm}
			</if>
			<if test="wxid != null and wxid != ''">
				and sjxx.lrry = #{wxid}
			</if>
			<if test="yzid != null and yzid !=''">
				and sjyz.yzid = #{yzid}
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
				and sjxx.jcdw in
				<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!-- 根据送检ID获取送检信息 -->
	<select id="getSjxxDtosByYbbh" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.bgrq,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,sjxx.cskz1,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.sjrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,
		sjxx.bz,sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,jc_ky.csmc kyxmmc,jc_ky.cskz1 kylx,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		COALESCE(sjxx.yblxmc,jc.csmc) AS yblxmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,jcsj.csdm as mbdm,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvipmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvip,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,hb.wjmgz,hb.cskz3 hbcskz3,sjxx.jcxmid,
		case when jc_jczxm.cskz3 is not null and jc_jczxm.cskz3 !='' then jc_jczxm.cskz3 else jc_jcxm.cskz3 end jc_cskz3,
		case when jc_jczxm.cskz1 is not null and jc_jczxm.cskz1 !='' then jc_jczxm.cskz1 else jc_jcxm.cskz1 end jc_cskz1,jc_jcxm.csdm jcxmdm,jc_jcxm.csmc jcxmmc,sjxx.jczxmid jczxm,jc_jczxm.csmc jczxmmc,
		sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,dw.kzcs2 kskzcs2,hb.hbid,sjxx.cskz6,sjxx.wbbm,yyxx.cskz3 yyxxCskz3
		,to_char(sjxx.dsyrq,'YYYY-MM-DD hh24:mi') dsyrq,to_char(sjxx.syrq,'YYYY-MM-DD hh24:mi') syrq,to_char(sjxx.qtsyrq,'YYYY-MM-DD hh24:mi') qtsyrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj
		
		from
		(
			select sjxx.*,'0' as sjlx,sjxx.lrsj as pxlrsj,sjjcxm.jcxmid,sjjcxm.jczxmid
			from igams_sjxx sjxx
			left join igams_sjjcxm sjjcxm on sjjcxm.sjid = sjxx.sjid and sjjcxm.scbj='0'
			<where>
				sjxx.scbj = '0'
				<if test="sjid != null and sjid != ''">
					and sjxx.sjid = #{sjid}
				</if>
				<if test="ybbh != null and ybbh != ''">
					and sjxx.ybbh = #{ybbh}
				</if>
				<if test="nbbm != null and nbbm != ''">
					and sjxx.nbbm = #{nbbm}
				</if>
				<if test="wxid != null and wxid != ''">
					and sjxx.lrry = #{wxid}
				</if>
				<if test="jcdwxz !=null and jcdwxz.size()>0">
					and sjxx.jcdw in
					<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
						#{item}
					</foreach>
				</if>
			</where>
			union all
			select sj.* ,'1' as sjlx,fjsq.lrsj as pxlrsj,fjsq.jcxm jcxmid,fjsq.jczxm as jczxmid
			from igams_fjsq fjsq
			left outer join igams_sjxx sj on sj.sjid = fjsq.sjid
			where
				fjsq.scbj ='0' and fjsq.zt !='00' and fjsq.zt !='15'
				and sj.scbj = '0'
				<if test="sjid != null and sjid != ''">
					and sj.sjid = #{sjid}
				</if>
				<if test="ybbh != null and ybbh != ''">
					and sj.ybbh = #{ybbh}
				</if>
		) sjxx
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left join igams_hbbgmbgl hbbgmbgl on hbbgmbgl.hbid = hb.hbid and sjxx.jcxmid = hbbgmbgl.jcxmid
		left outer join matridx_jcsj jcsj on hbbgmbgl.bgmbid = jcsj.csid
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
		left join matridx_jcsj jc_jczxm on sjxx.jczxmid = jc_jczxm.csid
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid = sjxx.jcxmid
		left outer join matridx_jcsj jc_ky on jc_ky.csid =sjxx.kyxm
		order by sjlx desc,pxlrsj desc
	</select>


	<select id="getCountForSearchExp"  parameterType="SjxxDto" resultType="java.lang.Integer">
		select count(sj.sjid) from igams_sjxx sj
		left join igams_yyxx yyxx on yyxx.dwid=sj.sjdw
		left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.scbj='0' and jcxm.xh = '1'
		left join igams_sjbgsm sjbgsm on sjbgsm.sjid = sj.sjid and sjbgsm.jclx=jcxm.jcxmid and sjbgsm.jczlx=jcxm.jczxmid
		left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join matridx_jcsj jc_sf on jc_sf.csid = hbxx.sf
		left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
		left join matridx_jcsj cskz1 on cskz1.csid=sj.cskz1
		left join matridx_jcsj sqlx on sj.sqlx = sqlx.csid
		left join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
		left join matridx_jcsj ptgs on ptgs.csid=hbxx.ptgs
		left join matridx_jcsj yptgs on yptgs.csid=hbxx.yptgs
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
		    <include refid="SelectWhere"></include>
			<if test="sjhbs != null and sjhbs.size()>0">
				and sj.db in
				<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
				and sj.scbj = '0'
			<if test="yhid!=null and yhid !=''">
				and sj.db in ( select sjhb.hbmc from igams_sjhbxx sjhb where sjhb.hbid in (select hbqx.hbid from igams_hbqx hbqx where hbqx.yhid=#{yhid}))
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
                and sj.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
			<if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in
				<foreach collection="sjhbfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	
	<sql id="OUT_SEARCH_JOINS">
		<if test="yblx_flg != null">
			left join matridx_jcsj yblx on yblx.csid= sj.yblx
		</if>
		<if test="jcxmmc_flg != null">
			left join matridx_jcsj jc_xm on sjjcxm.jcxmid= jc_xm.csid and jc_xm.jclb='DETECT_TYPE'
		</if>
		<if test="jczxmmc_flg != null">
			left join matridx_jcsj jc_zxm on sjjcxm.jczxmid= jc_zxm.csid and jc_zxm.jclb='DETECT_SUBTYPE'
		</if>
		<if test="sjdwxx_flg !=null">
			left join igams_sjdwxx sjdwxx on sjdwxx.dwid= sj.ks
		</if>
		<if test="cskz1_flg !=null">
			left join matridx_jcsj cskz1 on cskz1.csid=sj.cskz1
		</if>
		<if test="cskz2_flg !=null">
			left join matridx_jcsj cskz2 on cskz2.csid=sj.cskz2
		</if>
		<if test="cskz3_flg !=null">
			left join matridx_jcsj cskz3 on cskz3.csid=sj.cskz3
		</if>
		<if test="cskz4_flg !=null">
			left join matridx_jcsj cskz4 on cskz4.csid=sj.cskz4
		</if>
		<if test="zmxm_flg !=null">
			left join matridx_jcsj jc_zmxm on jc_zmxm.csid=sj.zmxm
		</if>
		<if test="zmmdd_flg !=null">
			left join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sj.zmmdd
		</if>
		<if test="hospitalName_flg !=null">
			left join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
		</if>
		<if test="jcdwmc_flg !=null">
			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
		</if>
		
	</sql>
	
	<select id="getListForSearchExp" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid ,sj.scbj ${sqlParam} from (
		select sj.* ,
			   hbxx.fl fl,
			   hbxx.zfl zfl,
			   hbxx.dqxx dqxx,
			   jc_sf.csmc sf,
			   yptgs.csmc ptgsmc,
		       ptgs.csmc xsbmmc
			from igams_sjxx sj
		<if test="(hospitalname != null and hospitalname != '') or (yyzddjs != null and yyzddjs.length>0)">
			left join igams_yyxx yyxx on yyxx.dwid=sj.sjdw
		</if>
			left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_jcsj jc_sf on jc_sf.csid = hbxx.sf
		<if test="zsxm !=null and zsxm !=''">
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
		</if>
			left join matridx_jcsj ptgs on ptgs.csid=hbxx.ptgs
		    left join matridx_jcsj yptgs on yptgs.csid=hbxx.yptgs
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<include refid="SelectWhere"></include>
			<if test="sjhbs != null and sjhbs.size()>0">
				and sj.db in
				<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
					and sj.scbj='0'
			<if test="yhid!=null and yhid !=''">
				and sj.db in ( select sjhb.hbmc from igams_sjhbxx sjhb where sjhb.hbid in (select hbqx.hbid from igams_hbqx hbqx where hbqx.yhid=#{yhid}))
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
                and sj.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
			<if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in
				<foreach collection="sjhbfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
		ORDER BY sj.lrsj ASC, sj.sjid ASC
		LIMIT #{pageSize} OFFSET #{pageStart}
		) sj
		left outer join igams_sjjcxm sjjcxm on sjjcxm.sjid = sj.sjid and sjjcxm.scbj='0'
		left outer join igams_sjbgsm sjbgsm on sjbgsm.sjid = sj.sjid and sjbgsm.jclx=sjjcxm.jcxmid and sjbgsm.jczlx=sjjcxm.jczxmid
		left join matridx_jcsj jcsj on  sj.fl = jcsj.csid
		left join matridx_jcsj zjcsj on  sj.zfl = zjcsj.csid
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sj.sjqf
		left join matridx_jcsj ky on ky.csid= sj.kyxm
		left join matridx_xtyh dqyh on dqyh.yhid=sj.dqxx
		<include refid="OUT_SEARCH_JOINS"></include>
		order by 
		<if test="sortName != null and sortName != ''">
		${sortName} ${sortOrder}
		</if>
		<if test="sortLastName != null and sortLastName != ''">
			,${sortLastName} ${sortLastOrder}
		</if>
	</select>
	<!--  修改合作伙伴 -->
	<update id="updateDB" parameterType="SjxxModel">
		update igams_sjxx set 
		<if test="db!=null and db !=''">
			db=#{db}
		</if>
		<where>
	 	  	<if test="ids !=null and ids.size>0">
	 	  		sjid in
 	  	  		<foreach collection="ids" open="(" close=")" separator="," item="item">
 	  	  			 #{item}
 	  	  		</foreach>
	 	  	</if>
		</where>
	</update>
	 <!-- 选中导出 -->
	<select id="getListForSelectExp" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid,sj.scbj ${sqlParam} from (
			<foreach item="item" index="index" collection="ids" separator=" union all ">  
			   select #{item,jdbcType=VARCHAR} sjid,#{index} ordernum
			</foreach>
			) tmp
			left outer join igams_sjxx sj on tmp.sjid = sj.sjid
			left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_jcsj jc_sf on jc_sf.csid = hbxx.sf
			left outer join igams_sjjcxm sjjcxm on sjjcxm.sjid = sj.sjid and sjjcxm.scbj='0'
			left outer join igams_sjbgsm sjbgsm on sjbgsm.sjid = sj.sjid and sjbgsm.jclx=sjjcxm.jcxmid and sjbgsm.jczlx=sjjcxm.jczxmid
			left join matridx_xtyh dqyh on  dqyh.yhid = hbxx.dqxx
			left join matridx_jcsj ptgs on ptgs.csid=hbxx.ptgs
			left join matridx_jcsj yptgs on yptgs.csid=hbxx.yptgs
			<!-- 添加合作伙伴分类 -->
			<if test="(fl!=null and fl != '' ) or (zfl!=null and zfl != '' ) ">
				LEFT JOIN igams_sjhbxx sjhb ON sj.db = sjhb.hbmc and sjhb.scbj = '0'
				<if test="fl!=null and fl != ''  ">
					left join matridx_jcsj jcsj on  sjhb.fl = jcsj.csid
				</if>
				<if test="zfl!=null and zfl != ''  ">
				    left join matridx_jcsj zjcsj on  sjhb.zfl = zjcsj.csid
				</if>
			</if>
			<include refid="OUT_SEARCH_JOINS"></include>
			left join matridx_jcsj ky on ky.csid= sj.kyxm
		order by tmp.ordernum
	</select>
	
	<!--  更新收样确认信息 -->
	<update id="updateConfirmInfo" parameterType="SjxxDto">
		update igams_sjxx set
			px=#{px}
			,xgsj = LOCALTIMESTAMP
			,xgry = #{xgry}
			,kdfy = #{kdfy}
			,kdh = #{kdh}
			<if test="nbbm!=null and nbbm !=''">
				,nbbm = #{nbbm}
			</if>
			<if test="jstj=='1'.toString()">
				,jsrq =cast(to_char(LOCALTIMESTAMP,'yyyy-MM-DD  HH24:MI:SS') as TIMESTAMP)
			</if>
			
			<if test="jstj=='1'.toString()">
			     ,jsry = #{xgry}
			</if>
			
			<if test="bz != null and bz != ''">
				,bz = #{bz}
			</if>
			<if test="sfjs!=null and sfjs !=''">
				,sfjs=#{sfjs}
			</if>
			<if test="sftj!=null and sftj !=''">
				,sftj=#{sftj}
			</if>
		where 
			sjid = #{sjid}
	</update>	
		<!-- 根据送检id查看文件信息 -->
	<select id="selectFjByWjid" parameterType="String" resultType="FjcfbDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid
			from igams_sjxx sjxx
			left outer join matridx_fjcfb fjcfb on sjxx.sjid = fjcfb.ywid and fjcfb.ywlx='IMP_INSPECTION'
			<where>
				fjcfb.scbj !='1' and fjcfb.ywid= #{sjid}
			</where>
	</select>
	<!-- 根据送检id查询送检物种信息 -->
	<select id="selectWzxxBySjid" parameterType="SjxxDto" resultType="SjwzxxDto">
		select sjwzxx.sjwzid,sjwzxx.sjid,sjwzxx.wzid,sjwzxx.wzywm,case when sjwzxx.wzzwm is null then json ->> 'annot' else sjwzxx.wzzwm end wzzwm,sjwzxx.wzfl,sjwzxx.jglx,sjwzxx.dqs,
		sjwzxx.jyzfgd,sjwzxx.xpxx,sjwzxx.xdfd,sjwzxx.lrry,sjwzxx.lrsj,sjwzxx.xgry,sjwzxx.xgsj,sjwzxx.scry,sjwzxx.scsj,sjwzxx.scbj,jclx.cskz1 jclx,sjwzxx.wzfllx,sjwzxx.xh,sjwzxx.sid,
		sjwzxx.sm,sjwzxx.szwm,sjwzxx.sdds,sjwzxx.sfd, wzgl.wzlx,jclx.csid jcxmid,sjwzxx.jczlx jczxmid,sjwzxx.rpm
		,json ->> 'MappingReads' AS MappingReads,json ->> 'reads' AS reads,json ->> 'refANI' AS refANI,json ->> 'target' AS target,sjwzxx.json
		,json ->> 'CleanQ30' AS CleanQ30,json ->> 'RawReads' AS RawReads,json ->> 'CleanReads' AS CleanReads,json ->> 'spike' AS spike
		from igams_sjwzxx sjwzxx
		left outer join igams_sjxx sjxx on sjxx.sjid = sjwzxx.sjid
		left outer join igams_wzgl wzgl on wzgl.wzid = coalesce(sjwzxx.wzid,sjwzxx.sid)
		left outer join matridx_jcsj jclx on jclx.csid = sjwzxx.jclx
		<where>
			sjwzxx.scbj !='1' 
			and sjwzxx.sjid=#{sjid}
			<if test="wzfl != null and wzfl !=''">
				and sjwzxx.wzfl=#{wzfl}
			</if>
			<if test="wzfllx != null and wzfllx !=''">
				and sjwzxx.wzfllx=#{wzfllx}
			</if>
		</where>
		order by jglx,wzfl,(case when regexp_replace(dqs, '[^0-9]', '', 'g') = '' then '0' else regexp_replace(dqs, '[^0-9]', '', 'g') end)::int desc
	</select>

	<!-- 根据送检id查询送检物种信息 -->
	<select id="selectWzxxBySjidAndJclx" parameterType="SjxxDto" resultType="SjwzxxDto">
		select sjwzxx.sjwzid,sjwzxx.sjid,sjwzxx.wzid,sjwzxx.wzywm,case when sjwzxx.wzzwm is null then json ->> 'annot' else sjwzxx.wzzwm end wzzwm,sjwzxx.wzfl,sjwzxx.jglx,sjwzxx.dqs,
		sjwzxx.jyzfgd,sjwzxx.xpxx,sjwzxx.xdfd,sjwzxx.lrry,sjwzxx.lrsj,sjwzxx.xgry,sjwzxx.xgsj,sjwzxx.scry,sjwzxx.scsj,sjwzxx.scbj,jclx.cskz1 jclx,sjwzxx.wzfllx,sjwzxx.xh,sjwzxx.sid,
		sjwzxx.sm,sjwzxx.szwm,sjwzxx.sdds,sjwzxx.sfd, wzgl.wzlx,jclx.csid jcxmid,sjwzxx.jczlx jczxmid,sjwzxx.rpm,wzgl.sfgl,wzgl.wzzs,sjwzxx.zcd,wzgl.fldj,sjwzxx.hslx,sjwzxx.fgcd
		,json ->> 'MappingReads' AS MappingReads,json ->> 'reads' AS reads,ROUND(CAST(NULLIF(json ->> 'refANI', '') AS numeric), 2) refANI,json ->> 'target' AS target,sjwzxx.json
		,json ->> 'CleanQ30' AS CleanQ30,json ->> 'RawReads' AS RawReads,json ->> 'CleanReads' AS CleanReads,json ->> 'spike' AS spike,json ->> 'NTM' AS ntm,json ->> 'TB' AS tb,sjwzxx.sfhb
		from igams_sjwzxx sjwzxx
		left outer join igams_sjxx sjxx on sjxx.sjid = sjwzxx.sjid
		left join igams_wzgl wzgl on coalesce(sjwzxx.wzid,sjwzxx.sid)=wzgl.wzid
		left outer join matridx_jcsj jclx on jclx.csid = sjwzxx.jclx
		<where>
			sjwzxx.scbj !='1' and sjwzxx.jclx=#{jclx}
			and sjwzxx.sjid=#{sjid}
			<if test="jczlx != null and jczlx !=''">
				and sjwzxx.jczlx=#{jczlx}
			</if>
			<if test="wzfl != null and wzfl !=''">
				and sjwzxx.wzfl=#{wzfl}
			</if>
			<if test="wzfllx != null and wzfllx !=''">
				and sjwzxx.wzfllx=#{wzfllx}
			</if>
		</where>
		order by jglx,wzfl
	</select>

	<!--  更新报告日期 -->
	<update id="updateReport" parameterType="SjxxDto">
		update igams_sjxx set 
		xgsj=LOCALTIMESTAMP
		<if test="xgry != null and xgry != ''">
			, xgry = #{xgry}
		</if>
		<if test="sfsc != null and sfsc != ''">
			, sfsc = #{sfsc}
		</if>
		<if test="bgrq != null and bgrq != ''">
			, bgrq = cast(#{bgrq} as timestamp)
		</if>
		<if test="jyjg !=null and  jyjg !=''">
			,jyjg=#{jyjg}
		</if>
		where sjid = #{sjid}
	</update>
	<select id="preview" parameterType="SjxxDto" resultType="FjcfbDto">
		select  
			fj.fjid,fj.wjm
		from igams_sjxx sjxx 
		left join matridx_fjcfb fj on sjxx.sjid=fj.ywid and (fj.ywlx='IMP_INSPECTION' or fj.ywlx='IMP_INSPECTION_CONFIRM')
		<where>
			fj.scbj !='1' and sjxx.ybbh=#{ybbh} and sjxx.scbj = '0'
			order by fj.xh
		</where>
	</select>
	
	<!--  根据代表名查询接收报告结果人员列表 -->
	<select id="getReceiveUserByDb" parameterType="SjxxDto" resultType="SjxxDto">
		select  sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nbbm,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,
		sjxx.bz,sjxx.kdh,sjxx.kdfy,sjxx.kdlx,sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,
		yh.ddid,fjcfb.ywlx,fjcfb.fjid,fjcfb.wjlj,fjcfb.wjm,case when jc.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,yh.yhid,yh.yhm,
		yh.wechatid,sjhb.hblx,sjhb.wxid,sjhb.fsfs,sjhb.yx,sjhb.yx2,sjhb.cskz1 as hbcskz1,sjhb.cskz2 as hbcskz2,wordfjcfb.fjid wordfjid,wordfjcfb.wjlj wordwjlj,wordfjcfb.wjm wordwjm
		,jcxm.jcxmid, COALESCE(sjxx.jcxmmc,jcjcxm.csmc)  jcxmmc,yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sjxx.sjdwmc else '' end as hospitalname
		from igams_sjxx sjxx 
		left outer join matridx_fjcfb fjcfb on sjxx.sjid = fjcfb.ywid and fjcfb.ywlx=#{pdflx} and fjcfb.scbj != '1'
		left outer join matridx_fjcfb wordfjcfb on sjxx.sjid = wordfjcfb.ywid and wordfjcfb.ywlx=#{wordlx} and wordfjcfb.scbj != '1'
		left join igams_sjhbxx sjhb on sjhb.hbmc = sjxx.db and sjhb.scbj = '0'
		left join matridx_xtyh yh on yh.yhid = sjhb.yhid and yh.scbj !='1'
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left join igams_sjjcxm jcxm on jcxm.sjid = sjxx.sjid and jcxm.xh = '1' and jcxm.scbj='0'
		left join matridx_jcsj jcjcxm on jcjcxm.csid = jcxm.jcxmid
		left join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
		<where>
			sjxx.scbj = '0'
			and sjxx.sjid=#{sjid} 
		</where>
	</select>
	
	<update id="updateforbioinformation" parameterType="SjxxDto">
			update igams_sjxx set ybbh=#{ybbh}
		<if test="hzxm !=null and  hzxm !=''">
			,hzxm=#{hzxm}
		</if>
		<if test="xb !=null and  xb !=''">
			,xb=#{xb}
		</if>
		<if test="nl !=null and  nl !=''">
			,nl=#{nl}
		</if>
		<if test="sjdw !=null and  sjdw !=''">
			,sjdw=#{sjdw}
		</if>
		<if test="ks !=null and  ks !=''">
			,ks=#{ks}
		</if>
		<if test="sjys !=null and  sjys !=''">
			,sjys=#{sjys}
		</if>
		<if test="yblx !=null and  yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="ybtj !=null and  ybtj !=''">
			,ybtj=#{ybtj}
		</if>
		<if test="jsrq !=null and jsrq !=''">
			,jsrq=cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="bgrq !=null and bgrq!=''">
			,bgrq=cast(#{bgrq} as timestamp)
		</if>
		<if test="lczz !=null and  lczz !=''">
			,lczz=#{lczz}
		</if>
		<if test="qqzd !=null and  qqzd !=''">
			,qqzd=#{qqzd}
		</if>
		<if test="jqyy !=null">
			,jqyy=#{jqyy}
		</if>
		where
			ybbh=#{ybbh}
	</update>

	<!-- 根据日期查询实验的记录数据 -->
	<select id="selectInspSize" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid,sj.yblx,sj.nbbm,sj.ybbh,jc.cskz1 jcxmcskz,syrq,to_char(sj.syrq,'YYYY-MM-DD') trsyrq,to_char(sj.dsyrq,'YYYY-MM-DD') tdsyrq,to_char(sj.qtsyrq,'YYYY-MM-DD') tqtsyrq,sj.jsrq,sj.db,sj.hzxm,jcyblx.csmc yblxmc,jc.csmc jcxmmc
			from igams_sjxx sj
			left join igams_sjjcxm jcxm on jcxm.sjid = sj.sjid and jcxm.scbj='0'
			left join matridx_jcsj jc on jc.csid = jcxm.jcxmid
			left join matridx_jcsj jcyblx on jcyblx.csid=sj.yblx 
			<where>
				(to_char(sj.syrq,'YYYY-MM-DD') = #{syrq} or to_char(sj.dsyrq,'YYYY-MM-DD') = #{syrq} or to_char(sj.qtsyrq,'YYYY-MM-DD') = #{syrq})
				and sj.scbj ='0' 
				<if test="jcdw != null and jcdw != ''">
					and sj.jcdw = #{jcdw}
				</if>
			</where>
			order by nbbm
	</select>
	
	<select id="selectjcbjByid" parameterType="SjxxDto" resultType="SjxxDto">
		select jcbj,sjid from igams_sjxx
		where sjid=#{sjid} and scbj = '0'
	</select>
	<!-- 标本统计信息图 -->
	
	<!-- 根据标本类型统计个数 -->
	<select id="getStatisByYblx" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as cn,jcsj.csmc
			from igams_sjxx sjxx 
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
			</if>
			group by sjxx.yblx,jcsj.csmc
			order by cn desc
	</select>
	<!-- 根据标本类型统计个数 (接收日期)-->
	<select id="getStatisByYblxAndJsrq" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as cn,jcsj.csmc
		from igams_sjxx sjxx
		left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
		where sjxx.scbj = '0' and (sjxx.bgrq is not null) and sjxx.sfjs = '1'
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		group by sjxx.yblx,jcsj.csmc
		order by cn desc
	</select>

	<!-- 按照日期统计标本个数，可按照日，月，年，显示指定前几个 -->
	<select id="getStatisYblxByJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>
	<!-- 按照日期统计标本个数，可按照日，月，年，显示指定前几个 (接收日期)-->
	<select id="getStatisYblxByJsrqAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx
				where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>

	<!-- 按照周统计标本个数 -->
	<select id="getStatisWeekYbsByJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				case when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) + '-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx 
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs ='1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and  to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd')
				</if>
				group by rqz
				) tmp on tjrq.rq = tmp.rqz
				order by tjrq.rq
	</select>
	<!-- 按照周统计标本个数 (接收日期)-->
	<select id="getStatisWeekYbsByJsrqAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				case when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(sjxx.jsrq + '-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx
				where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs ='1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and  to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd')
				</if>
				group by rqz
				) tmp on tjrq.rq = tmp.rqz
				order by tjrq.rq
	</select>

	<!-- 按照合作伙伴进行统计 -->
	<select id="getStatisBysjhb" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc,sjxx.db) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx 
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
						where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend != null and jsrqYend != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc,sjxx.db)
						<if test="jsrqstart != null and jsrqstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy')
						</if>
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	<!-- 按照合作伙伴进行统计(接收日期) -->
	<select id="getStatisBysjhbAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc,sjxx.db) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
						where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend != null and jsrqYend != ''">
							and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc,sjxx.db)
						<if test="jsrqstart != null and jsrqstart != ''">
							,to_char(sjxx.jsrq,'yyyy-MM-dd')
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							,to_char(sjxx.jsrq,'yyyy-MM')
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							,to_char(sjxx.jsrq,'yyyy')
						</if>
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	<select id="getStatisWzSf" parameterType="SjxxDto" resultType="Map">
		select
		sum(wznum) wznum,
		wzfl,
		wzywm,
		wzzwm
		from
		(
		select
		wznum,
		wzfl,
		wzywm,
		wzzwm
		from
		(
		select
		count(sjwzxx.wzid) as wznum,
		sjwzxx.wzfl ,
		wzywm,
		wzzwm,
		row_number() over(partition by sjwzxx.wzfl
		order by
		count(sjwzxx.wzid) desc) ind
		from
		igams_sjxx sjxx
		left outer join igams_sjwzxx sjwzxx on
		sjwzxx.sjid = sjxx.sjid
		left join igams_sjhbxx sjhbxx on sjhbxx.hbmc=sjxx.db and sjhbxx.scbj !='-1'
		left join matridx_jcsj jcsj on jcsj.csid = sjhbxx.sf
		where
		sjwzxx.scbj != '1'
		and jglx = 'pathogen'
		and sjxx.scbj = '0'
		and sjxx.sfjs = '1'
		and to_char(coalesce(sjxx.dsyrq,
		sjxx.syrq,
		sjxx.qtsyrq),
		'yyyy') &gt;= '2022'
		and to_char(coalesce(sjxx.dsyrq,
		sjxx.syrq,
		sjxx.qtsyrq),
		'yyyy') &lt;= '2022'
		and jcsj.csmc= #{sfmc}
		group by
		sjwzxx.wzfl ,
		sjwzxx.wzid,
		wzywm,
		wzzwm ,
		to_char(coalesce(sjxx.dsyrq,
		sjxx.syrq,
		sjxx.qtsyrq),
		'yyyy-MM') ) tmp ) tp
		group by
		wzfl,
		wzywm,
		wzzwm
		order by
		wznum desc
		limit 10
	</select>
	<!-- 按照周对合作伙伴进行统计 -->
	<select id="getStatisWeekBysjhb" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx 
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
						where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
							and hbxx.scbj !='1'
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc)
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	<!-- 按照周对合作伙伴进行统计(接收日期)-->
	<select id="getStatisWeekBysjhbAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
						where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
							and hbxx.scbj !='1'
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc)
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>

	<!-- 按照合作伙伴，查找所属的送检单位的送检信息 -->
	<select id="getSjdwBydb" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.sjdw) as num,sjxx.sjdw as mc,row_number() over(order by count(sjxx.sjdw) desc) indx
						from igams_sjxx sjxx 
						where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.db = #{db} and sjxx.sfjs = '1'
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend != null and jsrqYend != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
						</if>
						group by sjxx.sjdw 
						<if test="jsrqstart != null and jsrqstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy')
						</if>
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	
	<!-- 按照高关注度-->
	<select id="getWzxxByGgzd"  parameterType="SjxxDto"  resultType="Map">
		select sum(wznum) wznum,wzfl,wzywm,wzzwm from (
			select wznum,wzfl,case when ind &lt;=3 then wzywm else 'other' end wzywm,case when ind &lt;=3 then wzzwm else 'other' end wzzwm from (
				select count(sjwzxx.wzid) as wznum,sjwzxx.wzfl ,wzywm,wzzwm,row_number() over(partition by sjwzxx.wzfl order by count(sjwzxx.wzid) desc) ind
				from igams_sjxx sjxx 
				left outer join igams_sjwzxx sjwzxx on sjwzxx.sjid = sjxx.sjid
					where sjwzxx.scbj!='1' and jglx ='possible' and sjxx.scbj ='0' and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend != null and jsrqYend != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				group by sjwzxx.wzfl ,sjwzxx.wzid,wzywm,wzzwm
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy')
				</if>
			) tmp
		) tp
		group by wzfl,wzywm,wzzwm
		order by wzfl,wznum
	</select>
	<!-- 根据送检医生统计标本数量 -->
	<select id="getYblxBySjys" parameterType="SjxxDto"  resultType="Map">
		select count(sjxx.sjid) as num,sjxx.sjys as mc
		from igams_sjxx sjxx
		<where>
			sjxx.scbj = '0'
			group by sjxx.sjys order by num desc limit 5
		</where>
	</select>
	<!-- 统计结果类型为高关，疑似以及无的标本数量 -->
	<select id="getYbnumByJglx" parameterType="SjxxDto"  resultType="Map">
		select lx,count(sjid) num ,jyjg from (
			select sjxx.sjid,case when sjxx.jyjg ='1' then '阳性'  when sjxx.jyjg ='2' then '疑似' when sjxx.jyjg ='0' then '阴性' else '未知' end lx,
			case when sjxx.jyjg ='1' then '1' when sjxx.jyjg ='2' then '2' else '3' end indd,sjxx.jyjg
			 from igams_sjxx sjxx
			<if test="jcxm != null and jcxm != ''">
				left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0' and jcxm.jcxmid!=#{jcxm}
			</if>
			where sjxx.bgrq is not null and sjxx.scbj = '0' and sjxx.sfsc ='1'
			<if test="jcxm != null and jcxm != ''">
				AND jcxm.jcxmid is not null
			</if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(sjxx.bgrq,'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend != null and jsrqYend != ''">
				and to_char(sjxx.bgrq,'yyyy') &lt;= #{jsrqYend}
			</if>
			<if test="bgrq != null and bgrq != ''">
			and to_char(sjxx.bgrq,'yyyy-MM-dd') = #{bgrq}
			</if>
		) tmp 
		group by tmp.lx,indd,jyjg
		order by indd
	</select>
	<!-- 查询当天标本数量,报告数量 -->
	<select id="getYbslByday" parameterType="SjxxDto"  resultType="Map">
		select count(sjxx.sjid) as num
		from igams_sjxx sjxx
		<if test="jcxm != null and jcxm != ''">
			left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0' and jcxm.jcxmid!=#{jcxm}
		</if>
		<where>
			sjxx.scbj = '0'
			and sjxx.sfjs='1'
			<if test="jsrq != null and jsrq != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') = #{jsrq}
			</if>
			<if test="syrq != null and syrq != ''">
			and (to_char(sjxx.syrq,'yyyy-MM-dd') = #{syrq} or to_char(sjxx.dsyrq,'yyyy-MM-dd') = #{syrq} or to_char(sjxx.qtsyrq,'yyyy-MM-dd') = #{syrq})
			</if>
			<if test="bgrq != null and bgrq != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') = #{bgrq} and sjxx.sfsc ='1'
			</if>
			<if test="bgrqbj != null and bgrqbj != '' and bgrqbj=='1'.toString()">
				and sjxx.bgrq is not null and sjxx.sfsc ='1'
			</if>
			<if test="jcxm != null and jcxm != ''">
				AND jcxm.jcxmid is not null
			</if>
		</where>
	</select>
	<!--查询当天录入的标本数量 -->
	<select id="getLrYbslByday" parameterType="SjxxDto"  resultType="Map">
		select count(sjxx.sjid) as num 
		from igams_sjxx sjxx
		<if test="jcxm != null and jcxm != ''">
			left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.jcxmid!=#{jcxm}  and jcxm.scbj='0'
		</if>
		<where>
			sjxx.scbj = '0'
			<if test="jcxm != null and jcxm != ''">
				AND jcxm.jcxmid is not null
			</if>
			and to_char(sjxx.lrsj,'yyyy-MM-dd') = #{lrsj}
		</where>
	</select>
	<select id="getJcbjBySyrq" parameterType="SjxxDto" resultType="int"> 
		select count(sjxx.sjid) from igams_sjxx sjxx
			<if test="jcxm != null and jcxm != ''">
				left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.jcxmid!=#{jcxm} and jcxm.scbj='0'
			</if>
			where sjxx.scbj  = '0'
			<if test="jsrq!=null and jsrq !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')=#{jsrq}
			</if>
			<if test="jcxm != null and jcxm != ''">
				AND jcxm.jcxmid is not null
			</if>
	</select>
	<!-- 按照日期统计报告数量，可按照日，月，年，显示指定前几个 -->
	<select id="getStatisSjbgByBgrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="bgrqstart != null and bgrqstart != ''">
					,to_char(sjxx.bgrq,'yyyy-MM-dd') rq
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					,to_char(sjxx.bgrq,'yyyy-MM') rq
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					,to_char(sjxx.bgrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				where sjxx.scbj = '0'  and sjxx.bgrq is not null and sjxx.sfsc ='1'
				<if test="bgrqstart != null and bgrqstart != ''">
					and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend !=null and bgrqend !=''">
					and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{bgrqMstart}
				</if>
				<if test="bgrqMend !=null and bgrqMend !=''">
					and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{bgrqMend}
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					and to_char(sjxx.bgrq,'yyyy') &gt;= #{bgrqYstart}
				</if>
				<if test="bgrqYend !=null and bgrqYend !=''">
					and to_char(sjxx.bgrq,'yyyy') &lt;= #{bgrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by 
				<if test="bgrqstart != null and bgrqstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM-dd')
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM')
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					to_char(sjxx.bgrq,'yyyy')
				</if>
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>
	<select id="getStatisYxlBybgrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
			<if test = "rqs != null and rqs.size > 0 "  >
			  <foreach collection="rqs" separator=" union all " open="(" close=") "
			  item="item" index="index">
			    select #{item} rq
			  </foreach>
			</if> tjrq
			left outer join (
			   select 
			   bgrq,
				sum(lx),count(sjid),round(cast (sum(lx) as numeric )/cast (count(sjid) as numeric ),2) num from (
			    select sjxx.sjid,
				<if test="bgrqstart != null and bgrqstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM-dd') bgrq,
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM') bgrq,
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					to_char(sjxx.bgrq,'yyyy') bgrq,
				</if>
				case when bgsm.jyjg = '1' then 1 else 0 end lx
			    from igams_sjxx sjxx 
			    left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN igams_sjbgsm bgsm on sjxx.sjid = bgsm.sjid and bgsm.jclx = xm.jcxmid and bgsm.jczlx = xm.jczxmid
			    where sjxx.bgrq is not null and sjxx.scbj = '0'
			    <if test="jsrqstart != null and jsrqstart != ''">
			      and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			    </if>
			    <if test="jsrqend !=null and jsrqend !=''">
			      and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			    </if>
			    <if test="jsrqMstart != null and jsrqMstart != ''">
			      and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{jsrqMstart}
			    </if>
			    <if test="jsrqMend !=null and jsrqMend !=''">
			      and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{jsrqMend}
			    </if>
			    <if test="jsrqYstart != null and jsrqYstart != ''">
			      and to_char(sjxx.bgrq,'yyyy') &gt;= #{jsrqYstart}
			    </if>
			    <if test="jsrqYend != null and jsrqYend != ''">
			      and to_char(sjxx.bgrq,'yyyy') &lt;= #{jsrqYend}
			    </if>
			  ) tt 
			  group by tt.bgrq
			)   tmp on tjrq.rq = tmp.bgrq
			        order by tjrq.rq
	</select>
	<!-- 查询前一天进行实验标本数量 -->
	<select id="getybwcd" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as num from igams_sjxx sjxx 
		<where>
			sjxx.scbj = '0'
			and sjxx.sfjs='1'
			and (to_char(sjxx.syrq,'yyyy-MM-dd') = #{syrq} or to_char(sjxx.dsyrq,'yyyy-MM-dd')= #{dsyrq} or to_char(sjxx.qtsyrq,'yyyy-MM-dd')= #{qtsyrq})
			and sjxx.nbbm not like 'MDX%' and sjxx.nbbm not like 'X___-%'
		</where> 
	</select>
	<!-- 查询最近一周内送至杭州的标本的线路信息(默认认为送检合作伙伴不存在重复) -->
	<select id="getSjxlxx" parameterType="SjxxDto" resultType="Map">
		SELECT count(sjxx.sjid) num, jcsj.csmc,sjxx.db,jc_jcdw.cskz3 jcdwdz
		FROM igams_sjxx sjxx
			LEFT JOIN igams_sjhbxx sjhb ON sjxx.db = sjhb.hbmc and sjhb.scbj != '1'
			LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = sjhb.cs
			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid = sjxx.jcdw
		<where>
			sjxx.scbj = '0'
			and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
			and sjxx.db=sjhb.hbmc
			group by jcsj.csmc,sjxx.db,jc_jcdw.cskz3
			order by jc_jcdw.cskz3,jcsj.csmc, sjxx.db
		</where>
	</select>
	
	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个 -->
	<select id="getSjxxBySy" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq
		<if test="tj != null and tj != '' and tj != 'week'">
			,COALESCE(tmp.num, '0') num
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			, cast(COALESCE(SUM(cast(tmp.num as numeric)),'0') as varchar) num
		</if>
		from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all 
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq),'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
					left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
					left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
				</if>
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
					and jc_xm.cskz1 = #{jcxmdm}
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and sf=#{sf}
                </if>
				
				group by rq,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				<if test="tj != null and tj != '' and tj != 'week'">
					and  tjrq.rq = tmp.rq
				</if>
				<if test="tj != null and tj != '' and tj == 'week'">
					and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
					GROUP BY tjrq.rq, tjrq.sfjs, tjrq.sfsf
				</if>
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个(接收日期) -->
	<select id="getSjxxBySyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sfjs,sfsf,rq,cast(COALESCE(SUM(cast(num as numeric)),'0') as varchar) num from (
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num
		from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(xxdy_xmfl.dyid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
				left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
				left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = jcxm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
				<if test = "yxxs != null and yxxs.length > 0"  >
					AND xxdy_xmfl.yxx in
					<foreach collection="yxxs" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				where sjxx.scbj = '0' and sjxx.jsrq is not null
				<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
					and jc_xm.cskz1 = #{jcxmdm}
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and sf=#{sf}
                </if>

				group by rq,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				<if test="tj != null and tj != '' and tj != 'week'">
					and  tjrq.rq = tmp.rq
				</if>
				<if test="tj != null and tj != '' and tj == 'week'">
					and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
				</if>
		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num
		from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select count(xxdy_xmfl.dyid)||'' as num,case when fjsq.sfff = '1' then  '1' else '0' end sfsf,case when fjsq.scbj = '2' then  '0' else '1' end sfjs
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM') rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy') rq
		</if>
		from igams_fjsq fjsq
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		where  fjsq.scbj != '1' and fjsq.bgbj = '1' and fjsq.zt = '80' and fjlx.csid is not null
		<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
			and jc_xm.cskz1 = #{jcxmdm}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="yblx!=null and yblx!=''">
			and sjxx.yblx=#{yblx}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and sf=#{sf}
		</if>

		group by rq,fjsq.scbj,sfff
		) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>

		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num
		from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select SUM(cast(wbtj.css as numeric))||'' as num,case when wbtj.sfsf = '1' then  '1' else '0' end sfsf,'1' sfjs
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(wbtj.jsrq,'yyyy-MM-dd') rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(wbtj.jsrq,'yyyy-MM') rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(wbtj.jsrq,'yyyy') rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		where  wbtj.scbj = '0'
		<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
			and jc_xm.cskz1 = #{jcxmdm}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and sf=#{sf}
		</if>

		group by rq,wbtj.sfsf
		) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>

		) tab

		GROUP BY rq, sfjs, sfsf
		order by rq,sfjs,sfsf

	</select>

	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个，考虑D+R要算两个 -->
	<select id="getSjxxDRBySy" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(sum(tmp.sfnum), '0') sfnum,COALESCE(sum(tmp.bsfnum), '0') bsfnum,COALESCE(sum(tmp.fqnum), '0') fqnum from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select CASE 
				WHEN sjxx.sfjs = '1' THEN 
					case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end
				END AS sfnum
				,  CASE WHEN sjxx.sfjs = '1' THEN 
					case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				ELSE 0 end
				END AS bsfnum,
				CASE WHEN sjxx.sfjs = '0' THEN 
					COUNT(sjxx.sjid)
				END  AS fqnum,xm.jcxmid,jc_xm.cskz1
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when xmjclx ='D' then case when sfjs ='1' then sjxx.dsyrq else sjxx.jsrq end
					when xmjclx ='R' then case when sfjs ='1' then sjxx.syrq else sjxx.jsrq end else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.jsrq end
					 end, 'yyyy-MM-dd') AS rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when xmjclx ='D' then case when sfjs ='1' then sjxx.dsyrq else sjxx.jsrq end
					when xmjclx ='R' then case when sfjs ='1' then sjxx.syrq else sjxx.jsrq end else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.jsrq end
					 end, 'yyyy-MM') AS rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when xmjclx ='D' then case when sfjs ='1' then sjxx.dsyrq else sjxx.jsrq end
					when xmjclx ='R' then case when sfjs ='1' then sjxx.syrq else sjxx.jsrq end else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.jsrq end
					 end, 'yyyy') AS rq
				</if>
				from igams_sjxx sjxx 
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join (
					select 'D' xmjclx 
					union all 
					select 'R' xmjclx
				) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jcdw != null and  jcdw != ''">
					and jcdw=#{jcdw}
				</if>
				<if test="sf != null and sf != ''.toString()">
					and sf=#{sf}
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq,sjxx.sfjs,sjxx.sfsf,jc_xm.cskz1,xm.jcxmid,tt.xmjclx
				) tmp on tjrq.rq = tmp.rq 
				group by tjrq.rq
				order by tjrq.rq
	</select>
	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个，考虑D+R要算两个(接收日期) -->
	<select id="getSjxxDRBySyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select rq,COALESCE(sum(sfnum), '0') sfnum,COALESCE(sum(bsfnum), '0') bsfnum,COALESCE(sum(fqnum), '0') fqnum from(
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
		select CASE
		WHEN sjxx.sfjs = '1' THEN
		case when sjxx.sfsf = '1' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end
		END AS sfnum
		,  CASE WHEN sjxx.sfjs = '1' THEN
		case when sjxx.sfsf = '0' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end
		END AS bsfnum,
		CASE WHEN sjxx.sfjs = '0' THEN
		COUNT(xxdy_xmfl.dyid)
		END  AS fqnum,xm.jcxmid,jc_xm.cskz1
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		from igams_sjxx sjxx
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (
		select 'D' xmjclx
		union all
		select 'R' xmjclx
		) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj = '0' and sjxx.jsrq is not null
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="jcdw != null and  jcdw != ''">
			and jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="yblx!=null and yblx!=''">
			and sjxx.yblx=#{yblx}
		</if>
		group by rq,sjxx.sfjs,sjxx.sfsf,jc_xm.cskz1,xm.jcxmid,tt.xmjclx
		) tmp on tjrq.rq = tmp.rq

		union all
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
		select CASE
		when fjsq.sfff = '1' and fjsq.scbj = '0' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end sfnum
		,  CASE WHEN  fjsq.sfff = '0' and fjsq.scbj = '0' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end bsfnum,
		CASE WHEN fjsq.scbj = '2' THEN COUNT(xxdy_xmfl.dyid)
		END  AS fqnum,fjsq.jcxm,jc_xm.cskz1
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (
		select 'D' xmjclx
		union all
		select 'R' xmjclx
		) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  fjsq.scbj != '1' and fjsq.bgbj = '1' and fjsq.zt = '80' and fjlx.csid is not null
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="jcdw != null and  jcdw != ''">
			and jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="yblx!=null and yblx!=''">
			and sjxx.yblx=#{yblx}
		</if>
		group by rq,fjsq.scbj,fjsq.sfff,jc_xm.cskz1,fjsq.jcxm,tt.xmjclx
		) tmp on tjrq.rq = tmp.rq


		union all
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
		select CASE
		when wbtj.sfsf = '1' and wbtj.scbj = '0' then SUM(cast(wbtj.css as numeric))
		ELSE 0 end sfnum
		,  CASE WHEN  wbtj.sfsf = '0' and wbtj.scbj = '0' then SUM(cast(wbtj.css as numeric))
		ELSE 0 end bsfnum,
		0 AS fqnum,wbtj.jcxm,jc_xm.cskz1
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(wbtj.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(wbtj.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(wbtj.jsrq, 'yyyy') AS rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		where  wbtj.scbj = '0'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="jcdw != null and  jcdw != ''">
			and wbtj.jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		group by rq,wbtj.sfsf,wbtj.scbj,jc_xm.cskz1,wbtj.jcxm
		) tmp on tjrq.rq = tmp.rq
		) tab
		group by rq
		order by rq
	</select>

	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个 -->
	<select id="getSjxxWeekBySy" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'1' sfjs
				union all 
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'0' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs,
				case when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq),'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.jsrq) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx 
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
				</if>
				
				group by rqz,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个(接收日期) -->
	<select id="getSjxxWeekBySyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sfjs,sfsf,rq,cast(COALESCE(SUM(cast(num as numeric)),'0') as varchar) num from (
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'1' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'0' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select count(xxdy_xmfl.dyid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs,
		case when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(sjxx.jsrq +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
		end rqz
		from igams_sjxx sjxx
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
		left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = jcxm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		where sjxx.scbj = '0' and sjxx.jsrq is not null
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
		</if>

		group by rqz,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
		) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rqz
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rqz as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rqz as TIMESTAMP)
		</if>
		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'1' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'0' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select count(xxdy_xmfl.dyid)||'' as num,case when fjsq.sfff = '1' then  '1' else '0' end sfsf,case when fjsq.scbj = '2' then  '0' else '1' end sfjs,
		case when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(sjxx.jsrq +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
		when to_char(sjxx.jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
		end rqz
		from igams_fjsq fjsq
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		where  fjsq.scbj != '1' and fjsq.bgbj = '1' and fjsq.zt = '80' and fjlx.csid is not null
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
		</if>

		group by rqz,fjsq.scbj,sfff
		) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rqz
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rqz as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rqz as TIMESTAMP)
		</if>

		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'1' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'0' sfsf,'0' sfjs
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select SUM(cast(wbtj.css as numeric))||'' as num,case when wbtj.sfsf = '1' then  '1' else '0' end sfsf, '1' sfjs,
		case when to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(wbtj.jsrq +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
		when to_char(wbtj.jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(wbtj.jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
		when to_char(wbtj.jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(wbtj.jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
		when to_char(wbtj.jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(wbtj.jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
		when to_char(wbtj.jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(wbtj.jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
		end rqz
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		where  wbtj.scbj = '0'
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd')
		</if>

		group by rqz,wbtj.sfsf
		) tmp on tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rqz
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rqz as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rqz as TIMESTAMP)
		</if>
		) tab
		GROUP BY rq, sfjs, sfsf
		order by rq,sfjs,sfsf
	</select>

	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个 -->
	<select id="getSjxxWeekDRBySy" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(sum(tmp.sfnum), '0') sfnum,COALESCE(sum(tmp.bsfnum), '0') bsfnum,COALESCE(sum(tmp.fqnum), '0') fqnum from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
			select case WHEN sjxx.sfjs = '1' THEN 
					case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end
				END AS sfnum
				,  CASE WHEN sjxx.sfjs = '1' THEN 
					case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				ELSE 0 end
				END AS bsfnum,
				CASE WHEN sjxx.sfjs = '0' THEN 
					COUNT(sjxx.sjid)
				END  AS fqnum,
				xm.jcxmid,jc_xm.cskz1,
				case when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end),'yyyy-MM-dd') &gt;= #{jsrqstart}  
                     and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
                     else sjxx.jsrq end) +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
				 when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
				 when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
				 when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
				 else null
				end rqz
				from igams_sjxx sjxx 
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
                left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
				</if>
				<if test="jcdw != null and jcdw != ''">
					and jcdw=#{jcdw}
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				
				group by rqz,sfjs,sjxx.sfsf,xm.jcxmid,jc_xm.cskz1,tt.xmjclx
				) tmp on tjrq.rq = tmp.rqz
				group by tjrq.rq
				order by tjrq.rq
	</select>
	<!-- 按照日期统计收费标本，不收费标本，可按照日，月，年，显示指定前几个(接收日期) -->
	<select id="getSjxxWeekDRBySyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select rq,COALESCE(sum(sfnum), '0') sfnum,COALESCE(sum(bsfnum), '0') bsfnum,COALESCE(sum(fqnum), '0') fqnum from(
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
		select case WHEN sjxx.sfjs = '1' THEN
		case when sjxx.sfsf = '1' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end
		END AS sfnum
		,  CASE WHEN sjxx.sfjs = '1' THEN
		case when sjxx.sfsf = '0' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end
		END AS bsfnum,
		CASE WHEN sjxx.sfjs = '0' THEN
		COUNT(xxdy_xmfl.dyid)
		END  AS fqnum,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rqz,
		</if>
		xm.jcxmid,jc_xm.cskz1
		from igams_sjxx sjxx
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj = '0' and sjxx.jsrq is not null
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jcdw != null and jcdw != ''">
			and jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>

		group by rqz,sfjs,sjxx.sfsf,xm.jcxmid,jc_xm.cskz1,tt.xmjclx
		) tmp on tjrq.rq = tmp.rqz
		union all
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
		select CASE
		when fjsq.sfff = '1' and fjsq.scbj = '0' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end sfnum
		,  CASE WHEN  fjsq.sfff = '0' and fjsq.scbj = '0' then COUNT(xxdy_xmfl.dyid)
		ELSE 0 end bsfnum,
		CASE WHEN fjsq.scbj = '2' THEN COUNT(xxdy_xmfl.dyid)
		END  AS fqnum,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rqz,
		</if>
		fjsq.jcxm,jc_xm.cskz1

		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  fjsq.scbj != '1' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jcdw != null and jcdw != ''">
			and jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		group by rqz,fjsq.scbj,fjsq.sfff,jc_xm.cskz1,fjsq.jcxm,tt.xmjclx
		) tmp on tjrq.rq = tmp.rqz

		union all
		select tjrq.rq,tmp.sfnum ,tmp.bsfnum,tmp.fqnum  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') rq
			</foreach>
		</if> tjrq
		left outer join (
		select CASE
		when wbtj.sfsf = '1' and wbtj.scbj = '0' then SUM(cast(wbtj.css as numeric))
		ELSE 0 end sfnum
		,  CASE WHEN  wbtj.sfsf = '0' and wbtj.scbj = '0' then SUM(cast(wbtj.css as numeric))
		ELSE 0 end bsfnum,
		0  AS fqnum,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rqz,
		</if>
		wbtj.jcxm,jc_xm.cskz1
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on wbtj.hbid=hb.hbid and hb.scbj != '1'
		where  wbtj.scbj = '0'
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jcdw != null and jcdw != ''">
			and jcdw=#{jcdw}
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		group by rqz,wbtj.scbj,wbtj.sfsf,jc_xm.cskz1,wbtj.jcxm
		) tmp on tjrq.rq = tmp.rqz
		) tab
		group by rq
		order by rq
	</select>

	<!-- 周报统计收费标本下边的检测项目总条数 -->
	<select id="getYbxxTypeBYWeek" parameterType="SjxxDto"  resultType="Map">
		select tjrq.jcxm,tjrq.rq,COALESCE(sum(tmp.num), '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all 
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT 
			CASE 
				WHEN sjxx.sfsf = '3' THEN 'DNA'
				WHEN sjxx.sfsf = '2' THEN 'RNA'
				WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
				WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
				WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		 end jcxmdm,COUNT(sjxx.sjid) AS num
			<if test="jsrqstart != null and jsrqstart != ''">
				,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy-mm-dd') AS rq
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy-mm') AS rq
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy') AS rq
			</if>
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
            left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
            left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			WHERE sjxx.scbj = '0' and sjxx.sfsf != '0' AND sjxx.sfjs ='1'
				AND (sjxx.dsyrq IS NOT NULL OR sjxx.syrq IS NOT NULL OR sjxx.qtsyrq IS NOT NULL)
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
            <if test="sf != null and sf != ''.toString()">
                and hb.sf=#{sf}
            </if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart})
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend})
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &gt;= #{jsrqMstart})
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &lt;= #{jsrqMend})
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &gt;= #{jsrqYstart})
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &lt;= #{jsrqYend})
			</if>
			and CASE WHEN sjxx.sfsf = '3' THEN  xmjclx ='D' when sjxx.sfsf = '2' then xmjclx ='R' else 1=1 end
			GROUP BY sjxx.sfsf,jc_xm.cskz1,rq
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmdm
			group by tjrq.rq,tjrq.jcxm
			order by tjrq.rq,tjrq.jcxm
	</select>
	<!-- 周报统计收费标本下边的检测项目总条数(接收日期) -->
	<select id="getYbxxTypeBYWeekAndJsrq" parameterType="SjxxDto"  resultType="Map" >
		select jcxm,rq,COALESCE(sum(num), '0') num from(
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test="rqs != null and rqs.size > 0 ">
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN sjxx.sfsf = '3' THEN 'DNA'
		WHEN sjxx.sfsf = '2' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,COUNT(xxdy_xmfl.dyid) AS num
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq, 'yyyy-mm') AS rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		FROM igams_sjxx sjxx
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid =#{yhid}
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE sjxx.scbj = '0' and sjxx.sfsf != '0' AND sjxx.sfjs ='1'
		AND sjxx.jsrq IS NOT NULL
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart})
		</if>
		<if test="jsrqend != null and jsrqend != '' and (tj == 'day' or tj == 'week')">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend})
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart})
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend})
		</if>
		and CASE WHEN sjxx.sfsf = '3' THEN  xmjclx ='D' when sjxx.sfsf = '2' then xmjclx ='R' else 1=1 end
		GROUP BY sjxx.sfsf,jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,COUNT(xxdy_xmfl.dyid) AS num
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq, 'yyyy-mm') AS rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		FROM igams_fjsq fjsq
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid =#{yhid}
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  fjsq.scbj = '0' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart})
		</if>
		<if test="jsrqend != null and jsrqend != '' and (tj == 'day' or tj == 'week')">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend})
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart})
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend})
		</if>

		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,SUM(cast(wbtj.css as numeric)) AS num
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(wbtj.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(wbtj.jsrq, 'yyyy-mm') AS rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(wbtj.jsrq, 'yyyy') AS rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid =#{yhid}
		</if>
		where  wbtj.scbj = '0' and wbtj.sfsf = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and (to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart})
		</if>
		<if test="jsrqend != null and jsrqend != '' and (tj == 'day' or tj == 'week')">
			and (to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend})
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart})
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend})
		</if>

		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>
		) tab
		group by tab.rq,tab.jcxm
		order by tab.rq,tab.jcxm
	</select>

	<!-- 周报统计收费标本下边的检测项目总条数(通过周) -->
	<select id="getWeekYbxxType" parameterType="SjxxDto"  resultType="Map">
		select tjrq.jcxm,tjrq.rq,COALESCE(sum(tmp.num), '0') num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'D+R' jcxm
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'RNA' jcxm
				union all
				select to_char(to_date(#{item},'yyyy-MM-dd') + 6,'yyyy-MM-dd') rq,'DNA' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN sjxx.sfsf = '3' THEN 'DNA'
		WHEN sjxx.sfsf = '2' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		end jcxmmc,
		COUNT(sjxx.sjid)  AS num,
		case when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end),'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
		when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
		when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
		when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
		when to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char((case when sfjs ='1' then case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else sjxx.jsrq end 
					else sjxx.jsrq end) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
		end rq
		FROM igams_sjxx sjxx
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE sjxx.scbj = '0' and sjxx.sfsf != '0'
		AND (sjxx.dsyrq IS NOT NULL OR sjxx.syrq IS NOT NULL OR sjxx.qtsyrq IS NOT NULL)
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="jsrqstart != null and jsrqstart != ''">
			and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd'))
			and (to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd'))
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		and CASE WHEN sjxx.sfsf = '3' THEN  xmjclx ='D' when sjxx.sfsf = '2' then xmjclx ='R' else 1=1 end
		GROUP BY sjxx.sfsf,jc_xm.cskz1,rq,sjxx.sfsf
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmmc
		group by tjrq.rq,tjrq.jcxm
		order by tjrq.rq,tjrq.jcxm
	</select>

	<!-- 周报统计收费标本下边的检测项目总条数(通过周) (接收日期)-->
	<select id="getWeekYbxxTypeByJsrq" parameterType="SjxxDto"  resultType="Map">
		select jcxm,rq,COALESCE(sum(num), '0') num from (
		select tjrq.jcxm,tjrq.rq,tmp.num  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN sjxx.sfsf = '3' THEN 'DNA'
		WHEN sjxx.sfsf = '2' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,COUNT(xxdy_xmfl.dyid) AS num
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				,to_char(sjxx.jsrq, 'yyyy-mm') AS rq
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq, 'yyyy') AS rq
				</if>
			</if>
		</if>
		FROM igams_sjxx sjxx
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE sjxx.scbj = '0' and sjxx.sfsf != '0' AND sjxx.sfjs ='1'
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
			</if>
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqend == null or jsrqend == ''">
			<if test="jsrqMend != null and jsrqMend != ''">
				and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMend}
			</if>
			<if test="jsrqMend == null or jsrqMend == ''">
				<if test="jsrqYend != null and jsrqYend != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYend}
				</if>
			</if>
		</if>
		and CASE WHEN sjxx.sfsf = '3' THEN  xmjclx ='D' when sjxx.sfsf = '2' then xmjclx ='R' else 1=1 end
		GROUP BY sjxx.sfsf,jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on  tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,COUNT(xxdy_xmfl.dyid) AS num
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				,to_char(sjxx.jsrq, 'yyyy-mm') AS rq
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq, 'yyyy') AS rq
				</if>
			</if>
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  fjsq.scbj = '0' and fjsq.sfff='1' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
			</if>
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqend == null or jsrqend == ''">
			<if test="jsrqMend != null and jsrqMend != ''">
				and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMend}
			</if>
			<if test="jsrqMend == null or jsrqMend == ''">
				<if test="jsrqYend != null and jsrqYend != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYend}
				</if>
			</if>
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on  tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num  from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		CASE
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		WHEN jc_xm.cskz1 = 'C' THEN 'D+R'
		WHEN jc_xm.cskz1 = 'D' THEN 'DNA'
		WHEN jc_xm.cskz1 = 'R' THEN 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,SUM(cast(wbtj.css as numeric)) AS num
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(wbtj.jsrq, 'yyyy-mm-dd') AS rq
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				,to_char(wbtj.jsrq, 'yyyy-mm') AS rq
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(wbtj.jsrq, 'yyyy') AS rq
				</if>
			</if>
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		where  wbtj.scbj = '0' and wbtj.sfsf = '1'
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqstart == null or jsrqstart == ''">
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMstart == null or jsrqMstart == ''">
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
			</if>
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqend == null or jsrqend == ''">
			<if test="jsrqMend != null and jsrqMend != ''">
				and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMend}
			</if>
			<if test="jsrqMend == null or jsrqMend == ''">
				<if test="jsrqYend != null and jsrqYend != ''">
					and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYend}
				</if>
			</if>
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on  tjrq.jcxm=tmp.jcxmdm
		<if test="tj != null and tj != '' and tj != 'week'">
			and  tjrq.rq = tmp.rq
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rq as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rq as TIMESTAMP)
		</if>

		) tab
		group by rq,jcxm
		order by rq,jcxm
	</select>

	<!-- 统计日报 (饼状图) 按照标本个数进行统计-->
	<select id="getYbxxByDay" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(tmp.num, '0') AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '2' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) || '' AS num
						, CASE 
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf = '0' then '0' else '1' end
							ELSE '0'
						END AS sfsf, case
							when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
							and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' and jc_xm.cskz3 !='IMP_REPORT_TNGS_TEMEPLATE'
							then
							'2'
						else
							sjxx.sfjs
							end sfjs
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					WHERE sjxx.scbj = '0'
						AND (to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq), 'yyyy-MM-dd') =#{jsrq}
							OR (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
								AND sfjs = '0'))
					GROUP BY sfjs, CASE 
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf = '0' then '0' else '1' end
							ELSE '0'
						END,case
						when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
							and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' and jc_xm.cskz3 !='IMP_REPORT_TNGS_TEMEPLATE'
							then
						'2'
					else
						sjxx.sfjs
						end
				) tmp
				ON (sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs) or (sjxx.sfjs ='2' AND sjxx.sfjs = tmp.sfjs)
			ORDER BY sjxx.sfsf, sjxx.sfjs
	</select>

	<!-- 统计日报 (饼状图) 按照标本个数进行统计(接收日期)-->
	<select id="getYbxxByDayAndJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(tmp.num, '0') AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '2' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) || '' AS num
						, CASE
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf = '0' then '0' else '1' end
							ELSE '0'
						END AS sfsf, case
							when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
							and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
							'2'
						else
							sjxx.sfjs
							end sfjs
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					WHERE sjxx.scbj = '0'
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
						AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					GROUP BY sfjs, CASE
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf = '0' then '0' else '1' end
							ELSE '0'
						END,case
						when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
						and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
						'2'
					else
						sjxx.sfjs
						end
				) tmp
				ON (sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs) or (sjxx.sfjs ='2' AND sjxx.sfjs = tmp.sfjs)
			ORDER BY sjxx.sfsf, sjxx.sfjs
	</select>

	<!-- 统计日报 (饼状图)  按照标本个数进行统计 D+R的算两份测试数 -->
	<select id="getYbxxDRByDay" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '2' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) as num
						, CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
					      when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
					      when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
					      when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
					      else sjxx.sfsf end AS sfsf, 
						case
							when jc_xm.cskz3 !='IMP_REPORT_QINDEX_TEMEPLATE_REM' and jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
							and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
							'2'
						else
							sjxx.sfjs
							end sfjs
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					WHERE sjxx.scbj = '0'
						AND (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
						case when sjxx.qtsyrq is not null then sjxx.qtsyrq when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') =#{jsrq}
							OR (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
								AND sfjs = '0'))
						<if test="jcdw != null and jcdw != ''">
							and jcdw=#{jcdw}
						</if>
						AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					GROUP BY sjxx.sfjs, sjxx.sfsf,jc_xm.cskz1,tt.xmjclx, jc_xm.cskz3
				) tmp
				ON (sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs) or (sjxx.sfjs ='2' AND sjxx.sfjs = tmp.sfjs)
			group by sjxx.sfsf, sjxx.sfjs
			ORDER BY sjxx.sfsf, sjxx.sfjs
	</select>
	<!-- 统计日报 (饼状图)  按照标本个数进行统计 D+R的算两份测试数(接收日期) -->
	<select id="getYbxxDRByDayAndJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '2' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) as num
						, CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
					      when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
					      when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
					      when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
					      else sjxx.sfsf end AS sfsf,
						case
							when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
							and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
							'2'
						else
							sjxx.sfjs
							end sfjs
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					WHERE sjxx.scbj = '0'
						AND  to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
						<if test="jcdw != null and jcdw != ''">
							and jcdw=#{jcdw}
						</if>
					GROUP BY sjxx.sfjs, sjxx.sfsf,jc_xm.cskz1,tt.xmjclx, jc_xm.cskz3
				) tmp
				ON (sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs) or (sjxx.sfjs ='2' AND sjxx.sfjs = tmp.sfjs)
			group by sjxx.sfsf, sjxx.sfjs
			ORDER BY sjxx.sfsf, sjxx.sfjs
	</select>
	
	<!-- 统计日报 (饼状图) 按照检测单位对标本个数进行统计 D+R的算两份测试数 -->
	<select id="getYbxxDRByDayAndJcdw" parameterType="SjxxDto" resultType="Map">
		SELECT jcdw,jcdwmc,sfsf, sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT COUNT(sjxx.sjid) as num
					, CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
				      when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
				      when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
				      when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
				      else sjxx.sfsf end AS sfsf, 
					case
						when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
						and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
						'2'
					else
						sjxx.sfjs
						end sfjs,sjxx.jcdw,jc_jcdw.csmc jcdwmc
				FROM igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
				WHERE sjxx.scbj = '0'
					AND (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy-MM-dd') =#{jsrq}
						OR (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
							AND sfjs = '0'))
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				GROUP BY sjxx.sfjs, sjxx.sfsf,jc_xm.cskz1,tt.xmjclx, jc_xm.cskz3,sjxx.jcdw,jc_jcdw.csmc
				) tmp
			group by jcdw,jcdwmc,sfsf, sfjs
			ORDER BY jcdw,jcdwmc,sfsf, sfjs
	</select>
	<!-- 统计日报 (饼状图) 按照检测单位对标本个数进行统计 D+R的算两份测试数(接收日期) -->
	<select id="getYbxxDRByDayAndJcdwAndJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT jcdw,jcdwmc,sfsf, sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT COUNT(sjxx.sjid) as num
					, CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
				      when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
				      when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
				      when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
				      else sjxx.sfsf end AS sfsf,
					case
						when jc_xm.cskz3 !='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' and jc_xm.cskz3 not like 'IMP_REPORT_SEQ_%'
						and jc_xm.cskz3 !='IMP_REPORT_RFS_TEMEPLATE' then
						'2'
					else
						sjxx.sfjs
						end sfjs,sjxx.jcdw,jc_jcdw.csmc jcdwmc
				FROM igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
				WHERE sjxx.scbj = '0'
					AND to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				GROUP BY sjxx.sfjs, sjxx.sfsf,jc_xm.cskz1,tt.xmjclx, jc_xm.cskz3,sjxx.jcdw,jc_jcdw.csmc
				) tmp
			group by jcdw,jcdwmc,sfsf, sfjs
			ORDER BY jcdw,jcdwmc,sfsf, sfjs
	</select>
	
	<!-- 统计日报 (统计收费标本里，D，R，D+R的标本个数，其中 D+R的算两份测试数）-->
	<select id="getYbxxTypeByDay" parameterType="SjxxDto" resultType="Map">
		SELECT jcxmmc,sum(num) num from (
			SELECT jc_xm.csmc jcxmmc,
				case when sjxx.sfsf ='2' and tt.xmjclx = 'D' then 0
                when sjxx.sfsf ='3'  and  tt.xmjclx = 'R' then 0
                else COUNT(sjxx.sjid)
                end as num
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			WHERE sjxx.scbj = '0' and sjxx.sfsf != '0'
				AND sfjs ='1' and jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq
					else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy-MM-dd') = #{jsrq}
			GROUP BY jc_xm.csmc,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
		) tmp
		GROUP BY tmp.jcxmmc
	</select>
	<!-- 统计日报 (统计收费标本里，D，R，D+R的标本个数，其中 D+R的算两份测试数）(接收日期)-->
	<select id="getYbxxTypeByDayAndJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT jcxmmc,sum(num) num from (
			SELECT jc_xm.csmc jcxmmc,
				case when sjxx.sfsf ='2' and tt.xmjclx = 'D' then 0
                when sjxx.sfsf ='3'  and  tt.xmjclx = 'R' then 0
                else COUNT(sjxx.sjid)
                end as num
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			WHERE sjxx.scbj = '0' and sjxx.sfsf != '0'
				AND sfjs ='1'and jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				AND to_char(sjxx.jsrq, 'yyyy-MM-dd') = #{jsrq}
			GROUP BY jc_xm.csmc,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
		) tmp
		GROUP BY tmp.jcxmmc
	</select>
	
	<!-- 统计上上周的临床反馈结果 -->
	<select id="getLcfkByBefore" parameterType="SjxxDto" resultType="Map">
		select tjnr.sfzq,COALESCE(sum(tmp.num), '0') as num from
			(select '错误' sfzq
				union all 
   			select '正确' sfzq
				union all
			select '未反馈' sfzq
			) tjnr
		 left join (
		 select count(sjxx.sjid) as num ,case when sjxx.sfzq='0' then '错误' when sjxx.sfzq='1' then '正确' when  sjxx.sfzq is null then '未反馈' end sfzq from igams_sjxx sjxx 
			where sjxx.scbj = '0' and sjxx.sfjs='1' and sjxx.db in(select sjhb.hbmc from igams_sjhbxx sjhb left join matridx_jcsj jc_hb on jc_hb.csid=sjhb.fl where jc_hb.cskz1 is not null and sjhb.scbj !='1')
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			group by  sjxx.sfzq
			order by sjxx.sfzq
		 )tmp 
		 on tmp.sfzq=tjnr.sfzq
		 group by tjnr.sfzq
	</select>
	
	<!-- 根据样类型统计前三的阳性率 -->
	<select id="getJyjgByYblx" parameterType="SjxxDto" resultType="Map">
		select tmp_yb.csmc as yblx,tmp_yb.jyjg,case when sum is null then '0' when sum is not null then sum end sum ,case when num is null then '0' when num is not null then num end num from (
  			select jc.csid,jc.csmc,tmp.jyjg from matridx_jcsj jc 
  			left outer join  (select '阴性' jyjg union all select '阳性' jyjg union all select '疑似' jyjg) tmp on 1 =1
  					where jc.jclb ='WECGATSAMPLE_TYPE' and jc.scbj ='0' and cskz1 !='1'
  				) tmp_yb left outer join (
			SELECT  COUNT(sjxx.sjid) AS num, SUM(COUNT(sjxx.sjid)) OVER (PARTITION BY case when jc_yb.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc_yb.csmc) else jc_yb.csmc end),
				case when jc_yb.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc_yb.csmc) else jc_yb.csmc end AS yblxmc,sjxx.yblx,
				CASE WHEN sjxx.jyjg = '0' THEN '阴性' WHEN sjxx.jyjg = '1' THEN '阳性'WHEN sjxx.jyjg = '2' THEN '疑似' END AS jyjg
					FROM  igams_sjxx sjxx 
  				LEFT JOIN matridx_jcsj jc_yb ON jc_yb.csid = sjxx.yblx
			<where> sjxx.scbj = '0' and jc_yb.cskz1 !='1'
  				<if test="bgrqstart!=null and bgrqstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&gt;=#{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&lt;=#{bgrqend}
				</if>
				<if test="bgrqMstart!=null and bgrqMstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&gt;=#{bgrqMstart}
				</if>
				<if test="bgrqMend!=null and bgrqMend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&lt;=#{bgrqMend}
				</if>
				<if test="bgrqYstart!=null and bgrqYstart!=''">
                    and to_char(sjxx.bgrq,'yyyy')&gt;=#{bgrqYstart}
				</if>
				<if test="bgrqYend!=null and bgrqYend!=''">
                    and to_char(sjxx.bgrq,'yyyy')&lt;=#{bgrqYend}
				</if>
			GROUP BY case when jc_yb.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc_yb.csmc) else jc_yb.csmc end, sjxx.jyjg,sjxx.yblx ) sj
      		on tmp_yb.csid = sj.yblx and tmp_yb.jyjg = sj.jyjg
      		ORDER BY yblx desc,jyjg,sum desc
      </where>
	</select>
	
	<!-- 周报增加科室的圆饼统计图 -->
	<select id="getKsByweek" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as num,sjdw.dwmc from igams_sjxx sjxx
			left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
			<where>
				sjxx.scbj = '0' and sjxx.sfjs ='1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				group by sjdw.dwmc
				order by sjdw.dwmc
			</where>
	</select>
	<!-- 周报增加科室的圆饼统计图 (接收日期)-->
	<select id="getKsByweekAndJsrq" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as num,sjdw.dwmc from igams_sjxx sjxx
			left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
			<where>
				sjxx.scbj = '0' and sjxx.sfjs ='1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				group by sjdw.dwmc
				order by sjdw.dwmc
			</where>
	</select>

	<!-- 增加合作医院数，科室数，医生数的统计表 -->
	<select id="getSjdwSjysKs" parameterType="SjxxDto" resultType="Map">
			select count(tmp.sjdw) as num from 
				(select sjxx.sjdw  from igams_sjxx sjxx where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				 group by sjxx.sjdw) tmp
					union all
			select count(tmp.sjys) as num from 
				(select sjxx.sjys from igams_sjxx sjxx where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				  group by sjxx.sjys ) tmp
					union all
			select count(tmp.qtks) as num from
			 	(select CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END AS qtks from igams_sjxx sjxx
					left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
					where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
					</if>
			 	group by CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END
				 ) tmp
	</select>
	<!-- 增加合作医院数，科室数，医生数的统计表 (接收日期)-->
	<select id="getSjdwSjysKsByJsrq" parameterType="SjxxDto" resultType="Map">
			select count(tmp.sjdw) as num from
				(select sjxx.sjdw  from igams_sjxx sjxx where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
				 group by sjxx.sjdw) tmp
					union all
			select count(tmp.sjys) as num from
				(select sjxx.sjys from igams_sjxx sjxx where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
				  group by sjxx.sjys ) tmp
					union all
			select count(tmp.qtks) as num from
			 	(select CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END AS qtks from igams_sjxx sjxx
					left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
					where sjxx.scbj = '0'
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
			 	group by CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END
				 ) tmp
	</select>

	<!-- 查询到所有的合作伙伴 -->
	<select id="getDb" parameterType="String"  resultType="String">
		select sjxx.db
			from igams_sjxx sjxx 
			where sjxx.scbj = '0' and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')=#{jsrq}
			group  by sjxx.db
	</select>
	
	<!-- 查询到所有的统计名称 -->
	<select id="getTjmc" parameterType="SjxxDto"  resultType="String">
		select coalesce(hb.tjmc, hb.hbmc) db
			from igams_sjxx sjxx 
			left outer join igams_sjhbxx hb ON hb.hbmc = sjxx.db and hb.scbj != '1'
			<where>
				sjxx.scbj = '0'
				<if test="jsrq != null and jsrq !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')=#{jsrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')&gt;=#{jsrqstart}
				</if>
				<if test="jsrqend!=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')&lt;=#{jsrqend}
				</if>
				<if test="jsrqMstart!=null and jsrqMstart !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')&gt;=#{jsrqMstart}
				</if>
				<if test="jsrqMend!=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')&lt;=#{jsrqMend}
				</if>
				<if test="jsrqYstart!=null and jsrqYstart !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy')&gt;=#{jsrqYstart}
				</if>
				<if test="jsrqYend!=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq),'yyyy')&lt;=#{jsrqYend}
				</if>
				group by coalesce(hb.tjmc, hb.hbmc)
			</where>
	</select>
	<!-- 查询到所有的统计名称(接收日期) -->
	<select id="getTjmcByJsrq" parameterType="SjxxDto"  resultType="String">
		select coalesce(hb.tjmc, hb.hbmc) db
			from igams_sjxx sjxx
			left outer join igams_sjhbxx hb ON hb.hbmc = sjxx.db and hb.scbj != '1'
			<where>
				sjxx.scbj = '0'
				<if test="jsrq != null and jsrq !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')=#{jsrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
				</if>
				<if test="jsrqend!=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
				</if>
				<if test="jsrqMstart!=null and jsrqMstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
				</if>
				<if test="jsrqMend!=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&lt;=#{jsrqMend}
				</if>
				<if test="jsrqYstart!=null and jsrqYstart !=''">
					and to_char(sjxx.jsrq,'yyyy')&gt;=#{jsrqYstart}
				</if>
				<if test="jsrqYend!=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy')&lt;=#{jsrqYend}
				</if>
				group by coalesce(hb.tjmc, hb.hbmc)
			</where>
	</select>
	
	<!-- 统计日报 (柱状图)-->
	<select id="getYbxxByDb" parameterType="SjxxDto" resultType="Map">
		select sjhb.sfsf,sjhb.sjhb,sjhb.sfjs,COALESCE(tmp.num, '0') num from (
			<if test = "sjhbs != null and sjhbs.size > 0 "  >
				<foreach collection="sjhbs" separator=" union all " open="(" close=") " item="item" index="index">
					select #{item} sjhb,'0' sfsf,'1' sfjs
						union all 
					select #{item} sjhb,'0' sfsf,'0' sfjs
						union all 
					select #{item} sjhb,'1' sfsf,'1' sfjs
				</foreach>
			</if>
		) sjhb
		left outer join (
			select count(sjxx.sjid)||'' as num,sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then sjxx.sfsf else '1' end else '0' end sfsf,sjxx.sfjs
			from igams_sjxx sjxx where sjxx.scbj = '0'
			and (to_char(coalesce(sjxx.dsyrq, sjxx.syrq,sjxx.qtsyrq), 'yyyy-MM-dd') =#{jsrq}
				or (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
					and sfjs = '0'))				
			group by sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then sjxx.sfsf else '1' end else '0' end ,sjxx.sfjs
			)tmp on sjhb.sjhb=tmp.db and sjhb.sfsf=tmp.sfsf and sjhb.sfjs=tmp.sfjs
				order by sjhb.sjhb,sjhb.sfsf,sjhb.sfjs
	</select>
	
	<!-- 统计日报 (柱状图) 再次关联是为了获取总数-->
	<select id="getYbxxByTjmc" parameterType="SjxxDto" resultType="Map">
		with recursive t (sjhb, sfsf,sfjs,num) as (
			select sjhb.sjhb,sjhb.sfsf,sjhb.sfjs,sum(COALESCE(tmp.num, 0)) num from (
				<if test = "sjhbs != null and sjhbs.size > 0 "  >
					<foreach collection="sjhbs" separator=" union all " open="(" close=") " item="item" index="index">
						select #{item} sjhb,'0' sfsf,'1' sfjs
							union all 
						select #{item} sjhb,'0' sfsf,'0' sfjs
							union all 
						select #{item} sjhb,'1' sfsf,'1' sfjs
					</foreach>
				</if>
			) sjhb
			left outer join (
				select db,sfsf,sfjs,sum(num) num from (
			        SELECT count(sjxx.sjid) as num,
					coalesce(hb.tjmc, hb.hbmc) db,
					    CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
					from igams_sjxx sjxx 
					left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		  			left outer join igams_sjjcxm xm on xm.sjid = sjxx.sjid and xm.scbj='0'
		  			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		  			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj = '0' and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_SEQ_INDEX_TEMEPLATE')
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end, 'yyyy-MM-dd') =#{jsrq}
						or (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
							and sfjs = '0'))				
					group by jc_xm.cskz1,coalesce(hb.tjmc, hb.hbmc),sjxx.sfsf,sjxx.sfjs,tt.xmjclx
				) t_p
				group by db,sfsf,sfjs
			)tmp on sjhb.sjhb=tmp.db and sjhb.sfsf=tmp.sfsf and sjhb.sfjs=tmp.sfjs
			group by sjhb.sjhb,sjhb.sfsf,sjhb.sfjs
		)
		select t.sjhb,t.sfsf,t.sfjs,t.num||'' num,sum(t2.num) sa from t left outer join t as t2 on t.sjhb = t2.sjhb
        group by t.sjhb,t.sfsf,t.sfjs,t.num
		order by sa desc,t.sjhb,t.sfsf,t.sfjs 
	</select>
	<!-- 统计日报 (柱状图) 再次关联是为了获取总数(接收日期)-->
	<select id="getYbxxByTjmcAndJsrq" parameterType="SjxxDto" resultType="Map">
		with recursive t (sjhb, sfsf,sfjs,num) as (
			select sjhb.sjhb,sjhb.sfsf,sjhb.sfjs,sum(COALESCE(tmp.num, 0)) num from (
				<if test = "sjhbs != null and sjhbs.size > 0 "  >
					<foreach collection="sjhbs" separator=" union all " open="(" close=") " item="item" index="index">
						select #{item} sjhb,'0' sfsf,'1' sfjs
							union all
						select #{item} sjhb,'0' sfsf,'0' sfjs
							union all
						select #{item} sjhb,'1' sfsf,'1' sfjs
					</foreach>
				</if>
			) sjhb
			left outer join (
				select db,sfsf,sfjs,sum(num) num from (
			        SELECT count(sjxx.sjid) as num,
					coalesce(hb.tjmc, hb.hbmc) db,
					    CASE WHEN sfjs='0' then '0' when tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
					from igams_sjxx sjxx
					left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		  			left outer join igams_sjjcxm xm on xm.sjid = sjxx.sjid and xm.scbj='0'
		  			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		  			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj = '0' AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					and to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
					group by jc_xm.cskz1,coalesce(hb.tjmc, hb.hbmc),sjxx.sfsf,sjxx.sfjs,tt.xmjclx
				) t_p
				group by db,sfsf,sfjs
			)tmp on sjhb.sjhb=tmp.db and sjhb.sfsf=tmp.sfsf and sjhb.sfjs=tmp.sfjs
			group by sjhb.sjhb,sjhb.sfsf,sjhb.sfjs
		)
		select t.sjhb,t.sfsf,t.sfjs,t.num||'' num,sum(t2.num) sa from t left outer join t as t2 on t.sjhb = t2.sjhb
        group by t.sjhb,t.sfsf,t.sfjs,t.num
		order by sa desc,t.sjhb,t.sfsf,t.sfjs
	</select>
	
	<!-- 统计日报 (复检)-->
	<select id="getFjsqByDay" parameterType="FjsqDto" resultType="Map">
		select lx,lxmc,fjlxdm,xh,count(sjid) from (
			select sjid,lx,lxmc,fjlxdm,max(xh) xh
			from (
				select fjsq.sjid,fjsq.lx,fjsq.lrsj,fjlx.csmc as lxmc,fjlx.csdm as fjlxdm,row_number() over(partition by sjid,lx order by fjsq.lrsj asc  ) xh from igams_fjsq fjsq
				left join matridx_jcsj fjlx on fjlx.csid =fjsq.lx
				where fjsq.zt !='00' and fjsq.zt !='15' and fjsq.scbj ='0' 
			   	<if test="lrsj!=null and lrsj !=''">
			   		and to_char(fjsq.lrsj,'yyyy-MM-dd')=#{lrsj}
			   	</if>
				<if test="lrsjstart!=null and lrsjstart !=''">
			   		and to_char(fjsq.lrsj,'yyyy-MM-dd')&gt;=#{lrsjstart}
			   	</if>
			   	<if test="lrsjend!=null and lrsjend !=''">
			   		and to_char(fjsq.lrsj,'yyyy-MM-dd')&lt;=#{lrsjend}
			   	</if>
			   	<if test="lrsjMstart!=null and lrsjMstart !=''">
			   		and to_char(fjsq.lrsj,'yyyy-MM')&gt;=#{lrsjMstart}
			   	</if>
			   	<if test="lrsjMend!=null and lrsjMend !=''">
			   		and to_char(fjsq.lrsj,'yyyy-MM')&lt;=#{lrsjMend}
			   	</if>
			   		<if test="lrsjYstart!=null and lrsjYstart !=''">
			   		and to_char(fjsq.lrsj,'yyyy')&gt;=#{lrsjYstart}
			   	</if>
			   	<if test="lrsjYend!=null and lrsjYend !=''">
			   		and to_char(fjsq.lrsj,'yyyy')&lt;=#{lrsjYend}
			   	</if>
			) tmp 
			group by sjid,lxmc,fjlxdm,lx
			) tp
			group by lxmc,xh,fjlxdm,lx
	</select>
	<!-- 送检报告列表查看 -->
	<select id="getListPositive" parameterType="SjwzxxDto" resultType="SjxxDto">
		SELECT
		case when yblx.cskz1 ='1' then COALESCE(sjxx.yblxmc,yblx.csmc) else yblx.csmc end AS yblxmc, sjxx.db, jcxmmc.csmc AS jcxm,sjxx.sjid
		FROM igams_sjxx sjxx
			LEFT JOIN matridx_jcsj yblx ON sjxx.yblx = yblx.csid
			LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
			LEFT JOIN matridx_jcsj jcxmmc ON jcxmmc.csid = jcxm.jcxmid
		<where>
			sjxx.scbj = '0' and sjxx.sfsc='1'
				<if test="sjhbs !=null and sjhbs.size() >0">
					AND sjxx.db in
					<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jyjg != null and jyjg != ''">
					and sjxx.jyjg = #{jyjg}
				</if>
			    <if test="bgrq!=null and bgrq!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')=#{bgrq}
				</if>
				<if test="bgrqstart!=null and bgrqstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&gt;=#{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&lt;=#{bgrqend}
				</if>
				<if test="bgrqMstart!=null and bgrqMstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&gt;=#{bgrqMstart}
				</if>
				<if test="bgrqMend!=null and bgrqMend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&lt;=#{bgrqMend}
				</if>
				<if test="bgrqYstart!=null and bgrqYstart!=''">
                    and to_char(sjxx.bgrq,'yyyy')&gt;=#{bgrqYstart}
				</if>
				<if test="bgrqYend!=null and bgrqYend!=''">
                    and to_char(sjxx.bgrq,'yyyy')&lt;=#{bgrqYend}
				</if>
		</where>
	</select>
	<!--统计日报（废弃标本） -->
	<select id="getFqybByYbzt" parameterType="SjxxDto" resultType="Map">
		select case when ybzt.zt is null then '0' when ybzt.zt is not null then ybzt.zt end zt,case when jcsj.csmc is null then '其他'  when jcsj.csmc is not null then jcsj.csmc end ybzt, count(sjxx.sjid) 
		from igams_sjxx sjxx 
			LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			left join igams_sjybzt ybzt on ybzt.sjid = sjxx.sjid
			left join matridx_jcsj jcsj on ybzt.zt=jcsj.csid
		<where>
			sjxx.scbj = '0' and sjxx.sfjs='0' and (jc_xm.cskz3 ='IMP_REPORT_C_TEMEPLATE' or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE'
			or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE_REM' or jc_xm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE'  or jc_xm.cskz3 like 'IMP_REPORT_SEQ_%' or jc_xm.cskz3 ='IMP_REPORT_RFS_TEMEPLATE')
			<if test="jsrq!=null and jsrq!=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')=#{jsrq}
			</if>
			<if test="jsrqstart!=null and jsrqstart !=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
			</if>
			<if test="jsrqend!=null and jsrqend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
			</if>
			<if test="jsrqMstart!=null and jsrqMstart !=''">
				and to_char(sjxx.jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
			</if>
			<if test="jsrqMend!=null and jsrqMend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM')&lt;=#{jsrqMend}
			</if>
			<if test="jsrqYstart!=null and jsrqYstart !=''">
				and to_char(sjxx.jsrq,'yyyy')&gt;=#{jsrqYstart}
			</if>
			<if test="jsrqYend!=null and jsrqYend !=''">
				and to_char(sjxx.jsrq,'yyyy')&lt;=#{jsrqYend}
			</if>
			group by ybzt,ybzt.zt
		</where>
	</select>  
	<select id="getPageFqybList" parameterType="SjybztDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.ybbh,sjxx.db,case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,to_char(sjxx.jsrq,'yyyy-MM-dd HH24:mi:ss') as jsrq,sjxx.nbbm,
			sjxx.hzxm,sjxx.nl,sjxx.xb,case when sjxx.qtks is null then sjdw.dwmc else sjxx.qtks end qtks,sjxx.sjdw,sjxx.bz
			from igams_sjxx sjxx
			left join igams_sjybzt ybzt on ybzt.sjid=sjxx.sjid
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			<where>
					sjxx.scbj = '0' and sjxx.sfjs='0' and (jc_xm.cskz3 ='IMP_REPORT_C_TEMEPLATE' or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE'
					or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE_REM' or jc_xm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE'  or jc_xm.cskz3 like 'IMP_REPORT_SEQ_%' or jc_xm.cskz3 ='IMP_REPORT_RFS_TEMEPLATE')
				<if test="sjhbs !=null and sjhbs.size() >0">
					AND sjxx.db in
					<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="zt!=null and zt !=''">
					<if test="zt == '0'.toString()">
						and ybzt.zt is null
					</if>
					<if test="zt != '0'.toString()">
						and ybzt.zt=#{zt}
					</if>
				</if>
				<if test="jsrq !=null and jsrq !=''">
   					and to_char(sjxx.jsrq,'yyyy-MM-dd')=#{jsrq}				
   				</if>
   				<if test="jsrqstart!=null and jsrqstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
				</if>
				<if test="jsrqend!=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
				</if>
				<if test="jsrqMstart!=null and jsrqMstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
				</if>
				<if test="jsrqMend!=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&lt;=#{jsrqMend}
				</if>
				<if test="jsrqYstart!=null and jsrqYstart !=''">
					and to_char(sjxx.jsrq,'yyyy')&gt;=#{jsrqYstart}
				</if>
				<if test="jsrqYend!=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy')&lt;=#{jsrqYend}
				</if>
			</where>
	</select>
	
	<!-- 修改扩展参数 -->
	<select id="getSjxxCskz" parameterType="SjxxDto" resultType="SjxxDto">
		select cskz1,cskz2,cskz3,cskz4,cskz5,ks,qtks
		from igams_sjxx
		where 
		<if test="ids !=null and ids.size>0">
			sjid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		</if>
	</select>
	<!-- 修改扩展参数 -->
	<update id="updateCskz" parameterType="SjxxDto">
		update igams_sjxx set xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="cskz1 !=null and cskz1 !=''">
			,cskz1=#{cskz1}
		</if>
		<if test="cskz2 !=null and cskz2 !=''">
			,cskz2=#{cskz2}
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			,cskz3=#{cskz3}
		</if>
		<if test="cskz4 !=null and cskz4 !=''">
			,cskz4=#{cskz4}
		</if>
		<if test="cskz5 !=null and cskz5 !=''">
			,cskz5=#{cskz5}
		</if>
		<if test="sfsf !=null and sfsf !=''">
			,sfsf=#{sfsf}
		</if>
		<if test="ks !=null and ks !=''">
			,ks=#{ks}
		</if>
		<if test="qtks !=null and qtks !=''">
			,qtks=#{qtks}
		</if>
		<where>
			<if test="ids !=null and ids.size>0">
			  	sjid in
			  	<foreach collection="ids" open="(" close=")" separator="," item="item" >
			  		#{item}
			  	</foreach>
			</if>
		</where>
	</update>
	
	<!-- 根据 患者姓名，合作伙伴的信息，去查找非本标本编号的其他同类信息 (分页)-->
	<select id="getPagedTlxxList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.nldw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.ybtj,
		sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,sjxx.jsry,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,sjxx.jyjg,sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.fkbj
		,dw.dwmc ksmc,case when jc.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc
		from igams_sjxx sjxx
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj jcsj on hb.bgmb = jcsj.csid
		left outer join igams_fjsq fjsq on fjsq.sjid=sjxx.sjid
		<where>
			sjxx.scbj = '0'
			<if test="fjid == null or fjid == ''">
				and sjxx.ybbh!=#{ybbh}
			</if>
			and sjxx.hzxm=#{hzxm}
			and sjxx.db=#{db}
			and sjxx.bgrq is not null
			<if test="sjdw !=null and sjdw !=''">
				and sjxx.sjdw like '%'||#{sjdw}||'%'
			</if>
			<if test="sjys !=null and sjys !=''">
				and sjxx.sjys like '%'||#{sjys}||'%'
			</if>
			<if test="yblxmc !=null and yblxmc !=''">
				and sjxx.yblxmc like '%'||#{yblxmc}||'%'
			</if>
		</where>
	</select>
	
	<!-- 根据 患者姓名，合作伙伴的信息，去查找非本标本编号的其他同类信息 (不分页)-->
	<select id="getTlxxList" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid,sj.hzxm,sj.xb,sj.nl,sj.dh,sj.sjdw,sj.nldw,sj.ks,sj.sjys,sj.ysdh,sj.db,
		sj.yblx,sj.yblxmc,sj.ybtj,sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.jsrq,sj.jsry,sj.bgrq,sj.lczz,sj.qqzd,
		sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.fkbj
		from igams_sjxx sj
		<where>
			sj.scbj = '0'
			<if test="fjid == null or fjid == ''">
				and sj.ybbh!=#{ybbh}
			</if>
			and sj.hzxm=#{hzxm}
			and sj.db=#{db}
			and sj.bgrq is not null
		</where>
	</select>
	
	<!-- 根据送检ids查询送检物种信息 -->
	<select id="selectWzxxBySjids" parameterType="SjxxDto" resultType="SjwzxxDto">
	
		select sjwzxx.sjwzid,sjwzxx.sjid,sjwzxx.wzid,sjwzxx.wzywm,sjwzxx.wzzwm,sjwzxx.wzfl,sjwzxx.jglx,sjwzxx.dqs,
		sjwzxx.jyzfgd,sjwzxx.xpxx,sjwzxx.xdfd,sjwzxx.lrry,sjwzxx.lrsj,sjwzxx.xgry,sjwzxx.xgsj,sjwzxx.scry,sjwzxx.scsj,sjwzxx.scbj
		from igams_sjwzxx sjwzxx
		left outer join igams_sjxx sjxx on sjxx.sjid=sjwzxx.sjid
		<where>
			sjwzxx.scbj !='1' and sjwzxx.sjid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
			#{item}
			</foreach>
		</where>
	</select>
	
	<!-- 根据ids查询送检信息 -->
	<select id="selectSjxxBySjids" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.nldw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,yblx.csmc yblxmc,sjxx.ybtj,sjxx.syrq,sjxx.dsyrq,sjxx.qtsyrq,
		sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,sjxx.jsry,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,sjxx.jyjg,sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.fkbj,sjxx.jcbj,sjxx.djcbj,sjxx.qtjcbj,sjxx.jcdw,jcxmlx.cskz1,jcxm.jcxmid,jcxmlx.csmc jcxmmc
		from igams_sjxx sjxx
		left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
		left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
		left join matridx_jcsj yblx on yblx.csid=sjxx.yblx
		<where>
			sjxx.scbj = '0'
			and sjxx.sjid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
			#{item}
			</foreach>
		</where>
	</select>

	<select id="getDtoList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.bgrq,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.nldw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.cskz1,sjxx.syrq,sjxx.dsyrq,sjxx.qtsyrq,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.sjrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,sjxx.jcbj,sjxx.djcbj,sjxx.qtjcbj,
		sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,jc_ky.csmc kyxmmc,jc_ky.cskz1 kylx,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		case when jc.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvipmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvip,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,hb.wjmgz,hb.cskz3 hbcskz3,
		sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,dw.kzcs2 kskzcs2,hb.hbid,sjxx.cskz6,sjxx.wbbm,yyxx.cskz3 yyxxCskz3
		,to_char(sjxx.dsyrq,'YYYY-MM-DD hh24:mi') dsyrq,to_char(sjxx.syrq,'YYYY-MM-DD hh24:mi') syrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj,to_char(sjxx.qtsyrq,'YYYY-MM-DD hh24:mi') qtsyrq,to_char(sjxx.qysj,'YYYY-MM-DD hh24:mi') qysj,sjxx.sjqf,
		ptgs.csmc ptgsmc
		from igams_sjxx sjxx
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
		left outer join matridx_jcsj jc_ky on jc_ky.csid =sjxx.kyxm
		left join matridx_jcsj ptgs on ptgs.csid=hb.ptgs
		<where>
			sjxx.scbj = '0'
			<if test="ids !=null and ids.size > 0">
				and sjxx.sjid in
				<foreach collection="ids" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="ybbhs !=null and ybbhs.size > 0">
				and sjxx.ybbh in
				<foreach collection="ybbhs" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="nbbms !=null and nbbms.size > 0">
				and sjxx.nbbm in
				<foreach collection="nbbms" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="sjhbs !=null and sjhbs.size() >0">
				and( sjxx.db in
				<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
				<if test="lrrys !=null and lrrys.size() >0">
					or sjxx.lrry in
					<foreach collection="lrrys" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				)
			</if>

		</where>
	</select>
	

	<!--  验证内部编码是不是已经存在 -->
	<select id="getCountBynbbm" parameterType="SjxxDto" resultType="int">
		select count(sjid) from igams_sjxx
			where 
			scbj!='1' 
			<if test="nbbm !=null and nbbm !=''">
				and nbbm=#{nbbm} 
			</if>
			<if test="sjid !=null and sjid !=''">
				and sjid !=#{sjid}
			</if>
	</select>
	<!--  验证标本编号是不是已经存在 -->
	<select id="getCountByybbh" parameterType="SjxxDto" resultType="int">
		select count(sjid) from igams_sjxx
			where 
			scbj!='1' 
			<if test="ybbh !=null and ybbh !=''">
				and ybbh=#{ybbh} 
			</if>
			<if test="sjid !=null and sjid !=''">
				and sjid !=#{sjid}
			</if>
	</select>
	<!--  验证标本编号以及外部编码是不是已经存在 -->
	<select id="getCountByWbbmAndYbbh" parameterType="SjxxDto" resultType="int">
		select count(sjid) from igams_sjxx
			where
			scbj!='1'
			<if test="wbbm !=null and wbbm !=''">
				and wbbm=#{wbbm}
			</if>
			<if test="ybbh !=null and ybbh !=''">
				and ybbh=#{ybbh}
			</if>
	</select>
	
	<!-- 按照日期和代表名统计报告数量，可按照日，月，年，显示指定前几个 -->
	<select id="getStatisByFl" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			select hbid,db,rq,hb.fl,sfsf,sfjs from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') rq
				</if>,sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf = '0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				where sjxx.scbj = '0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy')
				</if>,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf = '0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>
	
	<!-- 按照日期和代表名统计报告数量，可按照周显示 -->
	<select id="getStatisByWeekFl" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
		    select hbid,db,rq,hb.fl,sfsf,sfjs from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
				item="item1" index="index1">
					<if test="sfflg == null or sfflg == ''">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
						 union all 
						 select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '0'.toString()">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
					</if>
				</foreach>
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) + '7 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'D')||' D' as interval),'yyyy-MM-dd') rq
				    ,sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf = '0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				where sjxx.scbj = '0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq) + '7 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'D')||' D' as interval),'yyyy-MM-dd'),
				sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf = '0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>
	
	<!-- 按照日期和统计名称统计报告数量，可按照日，月，年，显示指定前几个 -->
	<select id="getStatisByTjFl" parameterType="SjxxDto" resultType="Map">
		select tjrq.db, tjrq.rq, sum(COALESCE(tmp.sfnum, 0)) AS sfnum, sum(COALESCE(tmp.bsfnum, 0)) AS bsfnum from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						select  #{item} db,#{itemrq} rq
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end AS sfnum
				, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				ELSE 0 end AS bsfnum
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db
				from igams_sjxx sjxx 
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
				LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj = '0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and coalesce(hbxx.tjmc, hbxx.hbmc) in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc),case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db
			group by tjrq.db, tjrq.rq
			order by db,rq
	</select>

	<!-- 按照日期和统计名称统计报告数量，可按照日，月，年，显示指定前几个(接收日期) -->
	<select id="getStatisByTjFlAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db, tjrq.rq, sum(COALESCE(tmp.sfnum, 0)) AS sfnum, sum(COALESCE(tmp.bsfnum, 0)) AS bsfnum from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
					 item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
							 item="itemrq" index="indexrq">
						select  #{item} db,#{itemrq} rq
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum
		, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM') rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy') rq
		</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db
		from igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
		LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
		LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="db !=null and db !=''">
			and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and coalesce(hbxx.tjmc, hbxx.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hbxx.tjmc, hbxx.hbmc),sjxx.jsrq,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
		) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db
		group by tjrq.db, tjrq.rq
		order by db,rq
	</select>

	<!-- 按照日期和统计名称统计报告数量，可按照周显示 -->
	<select id="getStatisByWeekTjFl" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,sum(COALESCE(tmp.sfnum, 0)) AS sfnum, sum(COALESCE(tmp.bsfnum, 0)) AS bsfnum from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
				item="item1" index="index1">
					select #{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
				</foreach>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end AS sfnum
				, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				ELSE 0 end AS bsfnum,
				to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end + '7 D'+  cast ('-'||
				to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'D')||' D' as interval),'yyyy-MM-dd') rq
				    ,coalesce(hbxx.tjmc, hbxx.hbmc) db
				from igams_sjxx sjxx
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
				LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and coalesce(hbxx.tjmc, hbxx.hbmc) in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc),case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else 
					case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db 
			group by tjrq.db, tjrq.rq
			order by db,rq
	</select>

	<!-- 按照日期和统计名称统计报告数量，可按照周显示(接收日期) -->
	<select id="getStatisByWeekTjFlAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,sum(COALESCE(tmp.sfnum, 0)) AS sfnum, sum(COALESCE(tmp.bsfnum, 0)) AS bsfnum from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
					 item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
						 item="item1" index="index1">
					select #{item} db,to_char(to_date(#{7* ${index1} ,'yyyy-MM-dd') rq
				</foreach>jsrqend},'yyyy-MM-dd') -
			</foreach>
		</if>
		) tjrq
		left outer join (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum
		, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum,
		to_char(sjxx.jsrq + '7 D'+  cast ('-'||
		to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq
		,coalesce(hbxx.tjmc, hbxx.hbmc) db
		from igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
		LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
		LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj = '0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="db !=null and db !=''">
			and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and coalesce(hbxx.tjmc, hbxx.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hbxx.tjmc, hbxx.hbmc),sjxx.jsrq,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
		) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db
		group by tjrq.db, tjrq.rq
		order by db,rq
	</select>

	<!--生信部修改接口-->
	<select id="getDtoForbiont" parameterType="SjxxDto" resultType="SjxxDto">
		select   
	 		sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.yblxmc,sj.ybtj,sj.nldw,
			sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.sjrq,sj.jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,sj.lrry,
			sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,i_d.xh,i_d.fdwid,i_d.dwdm,i_d.dwmc,i_d.dh,jcsj.csmc,sj.fkbj,sj.fkje,sj.nbbm,sj.fkrq,sj.qtks
			,sj.sfjs,sj.sftj,sj.sfsf,sj.sfje,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,jc_jcdw.csmc jcdwmc,sj.sfzmjc,sj.zmxm,sj.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
			sj.sjqf,sj.kpsq,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sj.sjdwmc
 		from igams_sjxx  sj  
 			left join igams_sjdwxx i_d on sj.ks=i_d.dwid
 			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid
 			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
 			left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sj.zmxm
			left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sj.zmmdd
			left join igams_yyxx yyxx on yyxx.dwid =sj.sjdw
		<where>
 			sj.scbj = '0'
 			<if test="ybbh !=null and ybbh !=''">
 				and sj.ybbh=#{ybbh}
 			</if>
  		</where>
	</select>
	
	<update id="updateForbiont" parameterType="SjxxDto">
		update igams_sjxx set
			xgry=#{xgry},
			xgsj=LOCALTIMESTAMP,
			yblxmc=#{yblxmc},
			hzxm=#{hzxm},
			xb=#{xb},
			nl=#{nl},
			nldw=#{nldw},
			dh=#{dh},
			sjdw=#{sjdw},
			ks=#{ks},
			sjys=#{sjys},
			ysdh=#{ysdh},
			db=#{db},
			yblx=#{yblx},
			ybtj=#{ybtj},
			zyh=#{zyh},
			cwh=#{cwh},
			ybbh=#{ybbh},
			lczz=#{lczz},
			qqzd=#{qqzd},
			jqyy=#{jqyy},
			qqjc=#{qqjc},
			kdlx=#{kdlx},
			kdh=#{kdh},
			bz=#{bz},
			nbbm=#{nbbm},
			jcdw=#{jcdw},
			sjqf=#{sjqf},
			sjdwmc=#{sjdwmc},
			qtks=#{qtks},
			px=#{px},
            kdfy = #{kdfy},
		sfvip=#{sfvip},
		wbbm=#{wbbm}
        <if test="xg_flg == null or xg_flg == ''">
	            ,tkfs = #{tkfs}
	        <if test="tkje !=null and tkje !=''.toString()">
				,tkje = cast(#{tkje} as numeric)
			</if>
			<if test="tkje ==null or tkje ==''.toString()">
				,tkje=null
			</if>
	        <if test="tksj !=null and tksj !=''.toString()">
				,tksj=cast(#{tksj} as TIMESTAMP)
			</if>
			<if test="tksj ==null or tksj ==''.toString()">
				,tksj=null
			</if>
		</if>
		<if test="sfjs !=null and  sfjs !=''">
			,sfjs=#{sfjs}
		</if>
		<if test="sftj !=null and  sftj !=''">
			,sftj=#{sftj}
		</if>
		<if test="cyrq !=null and cyrq !=''.toString()">
			,cyrq=cast(#{cyrq} as date)
		</if>
		<if test="sjrq !=null and sjrq !=''.toString()">
			,sjrq=cast(#{sjrq} as date)
		</if>
		<if test="jsrq !=null and jsrq !=''.toString()">
			,jsrq=cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsrq ==null or jsrq ==''.toString()">
			,jsrq=null
		</if>
		<if test="jsry !=null and  jsry !=''">
			,jsry=#{jsry} 
		</if>
		<if test="bgrq !=null and bgrq !=''.toString()">
			,bgrq=cast(#{bgrq} as timestamp)
		</if>
		<if test="bgrq ==null or bgrq ==''.toString()">
			,bgrq=null
		</if>
		<if test="fkrq !=null and fkrq !='' and fkrq !='1'.toString()">
			,fkrq=cast(#{fkrq} as timestamp)
		</if>
		<if  test="fkrq == '1'.toString()">
			,fkrq=null
		</if>
		<if test="jyjg !=null and  jyjg !=''">
			,jyjg=#{jyjg}
		</if>
		<if test="fkbj !=null and  fkbj !=''">
			,fkbj=#{fkbj}
		</if>
		<if test="fkje !=null and  fkje !=''">
			,fkje=cast(#{fkje} as numeric)
		</if>
		<if test="xg_flg == null or xg_flg == ''">
			<if test="fkje ==null or fkje ==''">
				,fkje=null
			</if>
		</if>
		<if test="sfje !=null">
			,sfje=cast(#{sfje} as numeric)
		</if>
		<if test="ddh !=null and  ddh !=''">
			,ddh=#{ddh}
		</if>
		<if test="sfsf !=null and  sfsf !=''">
			,sfsf=#{sfsf}
		</if>
		<if test="zt !=null and  zt !=''">
			,zt=#{zt}
		</if>
		<if test="qyrq !=null and qyrq !=''">
			,qyrq=cast(#{qyrq} as timestamp)
		</if>
		<if test="qyrq ==null or qyrq ==''">
			,qyrq=null
		</if>
		<if test="ydrq !=null and ydrq !=''">
			,ydrq=cast(#{ydrq} as timestamp)
		</if>
		<if test="ydrq ==null or ydrq ==''">
			,ydrq = null
		</if>
		<if test="yjydrq !=null and yjydrq !=''">
			,yjydrq=cast(#{yjydrq} as timestamp)
		</if>
		<if test="yjydrq ==null or yjydrq ==''">
			,yjydrq = null
		</if>
		<if test="sfzmjc !=null and sfzmjc !=''">
			<if test="sfzmjc== '0'.toString() ">
				,zmmdd=null
			</if>
			<if test="sfzmjc== '1'.toString() ">
				,zmmdd=#{zmmdd}
			</if>
		</if>
		<if test=" kpsq !=null and kpsq !='' ">
			,kpsq=#{kpsq}
		</if>
		<if test="kyxm ==null or kyxm ==''">
			,kyxm = null
		</if>
		<if test=" kyxm !=null and kyxm !='' ">
			,kyxm=#{kyxm}
		</if>
		<if test=" sfws !=null and sfws !='' ">
			,sfws=#{sfws}
		</if>
		<if test=" jcxmmc !=null and jcxmmc !='' ">
			,jcxmmc=#{jcxmmc}
		</if>
		<if test="clbj !=null and clbj !='' ">
			,clbj=#{clbj}
		</if>
		<where>
			sjid=#{sjid}
		</where>
	</update>
	<!-- 按照日期和代表名统计报告数量，可按照周显示 -->
	<select id="getStatisByDb" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,COALESCE(tmp.num,0) num,fl from (
		<if test = "dbs != null and dbs.size() > 0 "  >
		    select hbid,db,hb.fl from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} db
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num,db
				from igams_sjxx sjxx 
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy')
				</if>
			) tmp on tjrq.db = tmp.db
			order by db desc
	</select>
	<!-- 按照日期和统计名统计报告数量，可按照周显示 --> <!-- 改成按照日期和合作伙伴进行统计测试数所使用，应该是在点击相应的伙伴分类里进行显示 -->
	<select id="getStatisByTj" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,sum(COALESCE(tmp.sfnum,0)) sfnum,sum(COALESCE(tmp.bsfnum,0)) bsfnum,sum(COALESCE(tmp.fqnum,0)) fqnum,fl from (
		<if test = "dbs != null and dbs.size() > 0 "  >
		    select db,hb.fl from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} db
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = coalesce(hb.tjmc,hb.hbmc) and hb.scbj != '1'
			group by db, hb.fl
		</if>
		) tjrq
		left outer join (
			select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end AS sfnum
				, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				 ELSE 0 end AS bsfnum,
				0 AS fqnum,coalesce(hb.tjmc,hb.hbmc) db
				from igams_sjxx sjxx 
				left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
				LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON jcxm.jcxmid=jc_xm.csid AND jc_xm.jclb ='DETECT_TYPE'
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj = '0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or sjxx.qtsyrq is not null) and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and  coalesce(hb.tjmc,hb.hbmc) in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hb.tjmc,hb.hbmc)
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy')
				</if>,sjxx.sfsf,tt.xmjclx
			) tmp on tjrq.db = tmp.db
			group by tjrq.db,fl
			order by db desc
	</select>
	<!-- 按照日期和统计名统计报告数量，可按照周显示(接收日期) --> <!-- 改成按照日期和合作伙伴进行统计测试数所使用，应该是在点击相应的伙伴分类里进行显示 -->
	<select id="getStatisByTjAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,sum(COALESCE(tmp.sfnum,0)) sfnum,sum(COALESCE(tmp.bsfnum,0)) bsfnum,sum(COALESCE(tmp.fqnum,0)) fqnum,fl from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			select db,hb.fl from
			<foreach collection="dbs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} db
			</foreach>
			te
			LEFT JOIN igams_sjhbxx hb ON te.db = coalesce(hb.tjmc,hb.hbmc) and hb.scbj != '1'
			group by db, hb.fl
		</if>
		) tjrq
		left outer join (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum
		, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum,
		0 AS fqnum,coalesce(hb.tjmc,hb.hbmc) db
		from igams_sjxx sjxx
		left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
		LEFT JOIN matridx_jcsj jc_xm ON jcxm.jcxmid=jc_xm.csid AND jc_xm.jclb ='DETECT_TYPE'
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj = '0' and sjxx.jsrq IS NOT NULL and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="db !=null and db !=''">
			and sjxx.db = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and  coalesce(hb.tjmc,hb.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hb.tjmc,hb.hbmc)
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM-dd')
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM')
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy')
		</if>,sjxx.sfsf,tt.xmjclx
		) tmp on tjrq.db = tmp.db
		group by tjrq.db,fl
		order by db desc
	</select>
	<!-- 统计所有的溶血标本（nbbm为B开头的） -->
	<select id="getCountAllSjxx" parameterType="SjybztDto" resultType="int">
		select count(sjid) from igams_sjxx 
		<where>
			scbj = '0'
			and (nbbm like 'B%' or nbbm like 'b%' )
			<if test="sjhbs !=null and sjhbs.size() >0">
				AND db in
					<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
			</if>
			<if test="jsrq!=null and jsrq !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy-MM-dd')=#{jsrq} or (sfjs='0' and to_char(jsrq,'yyyy-MM-dd')=#{jsrq})) 
			</if>
			<if test="jsrqstart!=null and jsrqstart !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy-MM-dd')&gt;=#{jsrqstart} or(sfjs='0' and to_char(jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart})) 
			</if>
			<if test="jsrqend!=null and jsrqend !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy-MM-dd')&lt;=#{jsrqend} or(sfjs='0' and to_char(jsrq,'yyyy-MM-dd')&lt;=#{jsrqend})) 
			</if>
			<if test="jsrqMstart!=null and jsrqMstart !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy-MM')&gt;=#{jsrqMstart} or(sfjs='0' and to_char(jsrq,'yyyy-MM')&gt;=#{jsrqMstart})) 
			</if>
			<if test="jsrqMend!=null and jsrqMend !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy-MM')&lt;=#{jsrqMend} or(sfjs='0' and to_char(jsrq,'yyyy-MM')&lt;=#{jsrqMend})) 
			</if>
			<if test="jsrqYstart!=null and jsrqYstart !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy')&gt;=#{jsrqYstart} or(sfjs='0' and to_char(jsrq,'yyyy')&gt;=#{jsrqYstart})) 
			</if>
			<if test="jsrqYend!=null and jsrqYend !=''">
				and(to_char(coalesce(dsyrq,syrq,qtsyrq),'yyyy')&lt;=#{jsrqYend} or(sfjs='0' and to_char(jsrq,'yyyy')&lt;=#{jsrqYend})) 
			</if>
		</where>
	</select>
	<!-- 统计所有的溶血标本（nbbm为B开头的）(接收日期) -->
	<select id="getCountAllSjxxByJsrq" parameterType="SjybztDto" resultType="int">
		select count(sjid) from igams_sjxx
		<where>
			scbj = '0'
			and (nbbm like 'B%' or nbbm like 'b%' )
			<if test="sjhbs !=null and sjhbs.size() >0">
				AND db in
					<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
			</if>
			<if test="jsrq!=null and jsrq !=''">
				and to_char(jsrq,'yyyy-MM-dd')=#{jsrq}
			</if>
			<if test="jsrqstart!=null and jsrqstart !=''">
				and to_char(jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
			</if>
			<if test="jsrqend!=null and jsrqend !=''">
				and to_char(jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
			</if>
			<if test="jsrqMstart!=null and jsrqMstart !=''">
				and to_char(jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
			</if>
			<if test="jsrqMend!=null and jsrqMend !=''">
				and to_char(jsrq,'yyyy-MM')&lt;=#{jsrqMend}
			</if>
			<if test="jsrqYstart!=null and jsrqYstart !=''">
				and to_char(jsrq,'yyyy')&gt;=#{jsrqYstart}
			</if>
			<if test="jsrqYend!=null and jsrqYend !=''">
				and to_char(jsrq,'yyyy')&lt;=#{jsrqYend}
			</if>
		</where>
	</select>
	<!-- 统计所有的废弃标本 -->
	<select id="getAllFqyb" parameterType="SjybztDto" resultType="int">
		select count(sjxx.sjid) from igams_sjxx sjxx
		left join igams_sjybzt ybzt on ybzt.sjid=sjxx.sjid
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			<where>
				sjxx.scbj = '0' and sjxx.sfjs='0' and (jc_xm.cskz3 ='IMP_REPORT_C_TEMEPLATE' or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE'
				or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE_REM' or jc_xm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE'  or jc_xm.cskz3 like 'IMP_REPORT_SEQ_%' or jc_xm.cskz3 ='IMP_REPORT_RFS_TEMEPLATE')
				<if test="sjhbs !=null and sjhbs.size() >0">
					AND db in
						<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
				</if>
				<if test="jsrq!=null and jsrq !=''">
					and to_char(jsrq,'yyyy-MM-dd')=#{jsrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart !=''">
					and to_char(jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
				</if>
				<if test="jsrqend!=null and jsrqend !=''">
					and to_char(jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
				</if>
				<if test="jsrqMstart!=null and jsrqMstart !=''">
					and to_char(jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
				</if>
				<if test="jsrqMend!=null and jsrqMend !=''">
					and to_char(jsrq,'yyyy-MM')&lt;=#{jsrqMend}
				</if>
				<if test="jsrqYstart!=null and jsrqYstart !=''">
					and to_char(jsrq,'yyyy')&gt;=#{jsrqYstart}
				</if>
				<if test="jsrqYend!=null and jsrqYend !=''">
					and to_char(jsrq,'yyyy')&lt;=#{jsrqYend}
				</if>
			</where>
	</select>
	<!-- 统计所有状态为溶血的标本数量 -->
	<select id="getCountByzt" parameterType="SjybztDto" resultType="int">
		select count(sjxx.sjid) from igams_sjxx sjxx
			left join igams_sjybzt ybzt on ybzt.sjid=sjxx.sjid
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			<where>
				sjxx.scbj = '0' and sjxx.sfjs='0' and (jc_xm.cskz3 ='IMP_REPORT_C_TEMEPLATE' or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE'
				or jc_xm.cskz3 ='IMP_REPORT_QINDEX_TEMEPLATE_REM' or jc_xm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' or jc_xm.cskz3 like 'IMP_REPORT_SEQ_%'  or jc_xm.cskz3 ='IMP_REPORT_RFS_TEMEPLATE')
				<if test="sjhbs !=null and sjhbs.size() >0">
					AND sjxx.db in
						<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
				</if>
				<if test="zt!=null and zt !=''">
					and ybzt.zt=#{zt}
				</if>
				<if test="ztflg=='1'.toString()"> 
					and ybzt.zt is null
				</if>
				<if test="jsrq !=null and jsrq!=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') =#{jsrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
				</if>
				<if test="jsrqend!=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
				</if>
				<if test="jsrqMstart!=null and jsrqMstart !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
				</if>
				<if test="jsrqMend!=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM')&lt;=#{jsrqMend}
				</if>
				<if test="jsrqYstart!=null and jsrqYstart !=''">
					and to_char(sjxx.jsrq,'yyyy')&gt;=#{jsrqYstart}
				</if>
				<if test="jsrqYend!=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy')&lt;=#{jsrqYend}
				</if>
			</where> 
	</select>
	<!-- 根据送检ids判断所选数据检测项目是否相同 -->
	<select id="checkJcxm" parameterType="SjxxDto" resultType="SjxxDto">
		select jc.cskz1
		from igams_sjxx sj 
		left join igams_sjjcxm jcxm on sj.sjid=jcxm.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc on jc.csid=jcxm.jcxmid
		<where>
			sj.scbj = '0'
			and sj.sjid in 
			<foreach collection="ids" item="item" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</where>
		group by jc.cskz1
	</select>
	
	<!-- 判断前一天实验的标本实验报告是否全部完成 -->
	<select id="checkSybgSfwc" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid
		from igams_sjxx sj
		LEFT OUTER JOIN igams_sjhbxx hb ON hb.hbmc = sj.db
		<where>
			sj.scbj = '0'
			and sj.sfjs='1'
			<if test="dbs !=null and dbs.size>0">
				and sj.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			and ((to_char(sj.syrq,'yyyy-mm-dd hh24')&gt;=#{syrqstart} and to_char(sj.syrq,'yyyy-mm-dd hh24')&lt;=#{syrqend} )
				or (to_char(sj.dsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.dsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend})
				or (to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend}))
			and (sj.bgrq is null  or sj.sfsc is null
			or sj.sfsc !='1') and sj.nbbm not like 'MDX%' and sj.nbbm not like 'X___-%'
			and not exists (select 1 from igams_fjsq sq where sj.sjid = sq.sjid 
			and sq.scbj='0' and sq.bgbj ='1' and sq.zt='10'
			and sq.lx in
			<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
			)
		</where>
	</select>
	<select id="getTimeByTime" parameterType="SjxxDto" resultType="String">
		SELECT   generate_series(cast(#{xjsj}  as TIMESTAMP) - INTERVAL '2 hours', cast(#{xjsj}  as TIMESTAMP), '10 minutes') AS time order by time desc;
	</select>
	<select id="getFsbgs" parameterType="SjxxDto" resultType="Map">
		select
		csmc,''||sum(tmp.num)as num,
		case when  min(to_char(tmp.xjsj, 'yyyy-mm-dd hh24:mi:ss'))  is null then '暂无' else  min(to_char(tmp.xjsj, 'yyyy-mm-dd hh24:mi:ss')) end as xjsj,
		case when min(to_char(tmp.scbgrq, 'yyyy-mm-dd hh24:mi:ss'))  is null then '暂无' else min(to_char(tmp.scbgrq, 'yyyy-mm-dd hh24:mi:ss')) end as scbgrq,
		''||sum(tmp.tenlast) as tenlast,
		''||sum(tmp.fivelast) as fivelast,
		''||sum(tmp.thirtylast) as thirtylast,
		max(fivelast1) fivelast1,
		max(fivelast2) fivelast2,
		max(fivelast3) fivelast3,
		max(fivelast4) fivelast4,
		max(fivelast5) fivelast5,
		max(fivelast6) fivelast6,
		max(fivelast7) fivelast7,
		max(fivelast8) fivelast8,
		max(fivelast9) fivelast9,
		max(fivelast10) fivelast10,
		max(fivelast11) fivelast11,
		max(fivelast12) fivelast12
		from (
		select tmp.csmc,
		sum(distinct tmp.num)as num,
		min(tmp.xjsj) as xjsj,
		min(tmp.scbgrq) as scbgrq,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq  and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '10 minutes' then 1 else 0 end ) as tenlast,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq   and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '20 minutes' then 1 else 0 end )as fivelast,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq   and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '30 minutes' then 1 else 0 end )as thirtylast,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP) and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '10 minutes' then 1 else 0 end )as fivelast1,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '10 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '20 minutes' then 1 else 0 end )as fivelast2,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '20 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '30 minutes' then 1 else 0 end )as fivelast3,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '30 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '40 minutes' then 1 else 0 end )as fivelast4,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '40 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '50 minutes' then 1 else 0 end )as fivelast5,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '50 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '60 minutes' then 1 else 0 end )as fivelast6,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '60 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '70 minutes' then 1 else 0 end )as fivelast7,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '70 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '80 minutes' then 1 else 0 end )as fivelast8,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '80 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '90 minutes' then 1 else 0 end )as fivelast9,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '90 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '100 minutes' then 1 else 0 end )as fivelast10,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '100 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '110 minutes' then 1 else 0 end )as fivelast11,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '110 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '120 minutes' then 1 else 0 end )as fivelast12
		from(
			select jcsj.csmc,
			jcsj.csid,
			count(distinct sjxx.sjid)as num,
			min(wksjgl.xjsj) as xjsj,
			min(sjbgsm.scbgrq) as scbgrq
			
			from igams_wksjgl wksjgl
			left join igams_wksjmx wksjmx on wksjmx.wksjid =wksjgl.wksjid
			left join igams_sjsygl sjsygl ON sjsygl.syglid = wksjmx.syglid
			left join igams_sjxx sjxx on sjxx.ybbh=wksjmx.ybbh or sjsygl.sjid = sjxx.sjid
			left join matridx_jcsj jcsj on sjxx.jcdw = jcsj.csid
			left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sjxx.sjid
			left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db
			left join igams_fjsq fj on fj.sjid=sjxx.sjid
			left join matridx_jcsj qf on qf.csid=sjxx.sjqf
			left join matridx_jcsj jcxm on
			jcxm.csid = fj.jcxm
			where to_char(wksjgl.xjsj,'yyyy-MM-dd hh24') &gt;= #{syrqstart} and wksjgl.xjsj is not null
			and (
			(to_char(sjxx.syrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.syrq,'yyyy-MM-dd hh24') &lt;=#{syrqend}) 
			or (to_char(sjxx.dsyrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.dsyrq,'yyyy-MM-dd hh24') &lt;=#{syrqend})
			or (to_char(sjxx.qtsyrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.qtsyrq,'yyyy-MM-dd hh24') &lt;=#{syrqend}) 
			)
			<if test="dbs !=null and dbs.size>0">
				and sjxx.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			and sjxx.nbbm not like 'MDX%'
			and sjxx.nbbm not like 'X___-%'
			and sjxx.sfjs = '1'
			and jcsj.csmc is not null
			AND qf.csdm not in ('VERIFICATION','ENV_MONITOR')
			and (sjxx.bgrq is null or to_char(sjxx.bgrq,'yyyy-MM-dd') = #{bgrq})
			group  by jcsj.csmc,jcsj.csid
		)as tmp
		left join igams_sjxx sjxx on sjxx.jcdw = tmp.csid and
			(
			(to_char(sjxx.syrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.syrq,'yyyy-MM-dd hh24') &lt;=#{syrqend}) 
			or (to_char(sjxx.dsyrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.dsyrq,'yyyy-MM-dd hh24') &lt;=#{syrqend})
			or (to_char(sjxx.qtsyrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sjxx.qtsyrq,'yyyy-MM-dd hh24') &lt;=#{syrqend}) 
			)
			<if test="dbs !=null and dbs.size>0">
				and sjxx.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			and sjxx.nbbm not like 'MDX%'
			and sjxx.nbbm not like 'X___-%'
			and sjxx.sfjs = '1'
		left outer join igams_sjhbxx hb on
		hb.hbmc = sjxx.db
		left join igams_sjbgsm sjbgsm on
		sjbgsm.sjid = sjxx.sjid
		where sjxx.sjid is not null
		group by tmp.csmc

		union all
		select tmp.csmc,
		sum(distinct tmp.num)as num,
		min(tmp.xjsj) as xjsj,
		min(tmp.scbgrq) as scbgrq,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq  and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '10 minutes' then 1 else 0 end ) as tenlast,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq   and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '20 minutes' then 1 else 0 end )as fivelast,
		sum(case when sjbgsm.scbgrq &gt;= tmp.scbgrq   and sjbgsm.scbgrq &lt;= cast(tmp.scbgrq  as TIMESTAMP) + interval '30 minutes' then 1 else 0 end )as thirtylast,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP) and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '10 minutes' then 1 else 0 end )as fivelast1,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '10 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '20 minutes' then 1 else 0 end )as fivelast2,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '20 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '30 minutes' then 1 else 0 end )as fivelast3,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '30 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '40 minutes' then 1 else 0 end )as fivelast4,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '40 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '50 minutes' then 1 else 0 end )as fivelast5,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '50 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '60 minutes' then 1 else 0 end )as fivelast6,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '60 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '70 minutes' then 1 else 0 end )as fivelast7,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '70 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '80 minutes' then 1 else 0 end )as fivelast8,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '80 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '90 minutes' then 1 else 0 end )as fivelast9,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '90 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '100 minutes' then 1 else 0 end )as fivelast10,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '100 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '110 minutes' then 1 else 0 end )as fivelast11,
		sum(case when sjbgsm.scbgrq &lt;= cast(#{xjsj}  as TIMESTAMP)- interval '110 minutes' and sjbgsm.scbgrq &gt;= cast(#{xjsj}  as TIMESTAMP) - interval '120 minutes' then 1 else 0 end )as fivelast12
			from(
				select jcsj.csmc,
				jcsj.csid,
				count(distinct sjxx.sjid)as num,
				min(wksjgl.xjsj) as xjsj,
				min(sjbgsm.scbgrq) as scbgrq

				from igams_wksjgl wksjgl
				left join igams_wksjmx wksjmx on wksjmx.wksjid =wksjgl.wksjid
				left join igams_sjsygl sjsygl ON sjsygl.syglid = wksjmx.syglid
				left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid
				left join matridx_jcsj jcsj on sjxx.jcdw = jcsj.csid
				left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sjxx.sjid
				left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db
				left join igams_fjsq fj on fj.sjid=sjxx.sjid
				left join matridx_jcsj jcxm on
				jcxm.csid = fj.jcxm
				where to_char(wksjgl.xjsj,'yyyy-MM-dd hh24') &gt;= #{syrqstart} and fj.scbj != '1'
				and jcxm.cskz1 != 'F'
				and fj.lx in
				<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
					#{item}
				</foreach>
				and ((to_char(fj.rsyrq,'yyyy-mm-dd hh24') &gt;=  #{syrqstart} and to_char(fj.rsyrq,'yyyy-mm-dd hh24') &lt;= #{syrqend} )or (to_char(fj.dsyrq,
				'yyyy-MM-dd hh24') &gt;= #{syrqstart}
				and to_char(fj.dsyrq,
				'yyyy-MM-dd hh24') &lt;= #{syrqend})
				or (to_char(fj.qtsyrq,
				'yyyy-MM-dd hh24') &gt;= #{syrqstart}
				and to_char(fj.qtsyrq,
				'yyyy-MM-dd hh24') &lt;= #{syrqend}))

				and (fj.zt = '80'
				or fj.zt = '10')
				and fj.bgbj = '1'
				and sjxx.scbj = '0'
				and hb.scbj != '1'
				<if test="dbs !=null and dbs.size>0">
					and sjxx.db not in
					<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
						#{item}
					</foreach>
				</if>
				and jcsj.csmc is not null

				group  by jcsj.csmc,jcsj.csid
			)as tmp
			left join igams_sjxx sjxx on
			sjxx.jcdw = tmp.csid and sjxx.scbj = '0'
			and sjxx.nbbm not like 'MDX%'
			and sjxx.nbbm not like 'X___-%'
			and sjxx.sfjs = '1'
			left outer join igams_sjhbxx hb on
			hb.hbmc = sjxx.db
			left join igams_fjsq fj on
			fj.sjid = sjxx.sjid
			left join igams_sjbgsm sjbgsm on
			sjbgsm.sjid = sjxx.sjid
			where
			fj.scbj != '1'
			and fj.lx in
			<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
			and hb.hbid is not null
			and ((to_char(fj.rsyrq,'yyyy-mm-dd hh24') &gt;=  #{syrqstart} and to_char(fj.rsyrq,'yyyy-mm-dd hh24') &lt;= #{syrqend} )or (to_char(fj.dsyrq,
			'yyyy-MM-dd hh24') &gt;= #{syrqstart}
			and to_char(fj.dsyrq,
			'yyyy-MM-dd hh24') &lt;= #{syrqend})
			or (to_char(fj.qtsyrq,
			'yyyy-MM-dd hh24') &gt;= #{syrqstart}
			and to_char(fj.qtsyrq,
			'yyyy-MM-dd hh24') &lt;= #{syrqend}))

			and (fj.zt = '80'
			or fj.zt = '10')
			and fj.bgbj = '1'
			and sjxx.scbj = '0'
			and hb.scbj != '1'
			<if test="dbs !=null and dbs.size>0">
				and sjxx.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			group by tmp.csmc
		)tmp
		group  by tmp.csmc
	</select>
	<!-- 获取前一天实验的标本已出报告的数量 -->
	<select id="getYwcbgs" parameterType="SjxxDto" resultType="Map">
		select sum(num) num ,sum(bgs) bgs,sum(fcs) fcs,sum(jrfcs) jrfcs,sum(wfbgs) wfbgs,
		round(sum(wfbgs)*100/ case when (SUM(FCS) + SUM(BGS) + SUM(WFBGS) )=0 then 1 else (SUM(FCS) + SUM(BGS) + SUM(WFBGS) ) end,2) bfb
		from (
		select count(sj.sjid) num ,sum(case when sj.sfsc = '1' and sj.bgrq is not null then 1 else 0 end ) bgs,0 fcs,
		sum(case when (sj.bgrq is null or sj.sfsc is null)
		and not exists (select 1 from igams_fjsq sq
			where sj.sjid = sq.sjid and sq.scbj='0' and sq.bgbj ='1' and (sq.zt='10' or sq.zt='80')
			and to_char(sq.lrsj, 'YYYY-MM-DD') = #{bgrq}
			and sq.lx in
			<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		) then 1 else 0 end ) wfbgs,0 jrfcs
		from igams_sjxx sj
		left outer join igams_sjhbxx hb on hb.hbmc = sj.db
		left join matridx_jcsj jcdw on jcdw.csid=sj.jcdw
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		where
		sj.scbj = '0'
		and sj.sfjs='1'
		<if test="wbhsjdw!=null and wbhsjdw.size()>0">
			and  jcdw.csmc not in
			<foreach collection="wbhsjdw" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="wbhsjhb!=null and wbhsjhb.size()>0">
			and  sj.db   not in
			<foreach collection="wbhsjhb" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
		
		and sj.nbbm not like 'MDX%' and sj.nbbm not like 'X___-%'
		and (
			(to_char(sj.syrq,'yyyy-MM-dd hh24') &gt;=#{syrqstart} and to_char(sj.syrq,'yyyy-MM-dd hh24') &lt;=#{syrqend}) 
			or (to_char(sj.dsyrq,'yyyy-MM-dd hh24') &gt;= #{syrqstart} and to_char(sj.dsyrq,'yyyy-MM-dd hh24') &lt;= #{syrqend}) 
			or (to_char(sj.qtsyrq,'yyyy-MM-dd hh24') &gt;= #{syrqstart} and to_char(sj.qtsyrq,'yyyy-MM-dd hh24') &lt;= #{syrqend}))
		and qf.csdm not in('VERIFICATION','ENV_MONITOR') and (sj.bgrq is null or to_char(sj.bgrq, 'YYYY-MM-DD') &gt;= #{bgrq})
		union all
		SELECT count(sj.sjid) num ,0 bgs,sum(case when sj.sfsc = '1' and to_char(sj.bgrq, 'YYYY-MM-DD') = #{bgrq} then 1 else 0 end ) fcs
		     ,sum(case when to_char(sj.bgrq, 'YYYY-MM-DD') != #{bgrq} then 1 else 0 end ) wfbgs
		     ,0 jrfcs
		FROM igams_fjsq fj
		left join matridx_jcsj jcxm on jcxm.csid =fj.jcxm
		LEFT JOIN igams_sjxx sj ON fj.sjid = sj.sjid
		left join matridx_jcsj jcdw on jcdw.csid=sj.jcdw
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		LEFT JOIN igams_sjhbxx hb ON hb.hbmc = sj.db AND hb.scbj != '1'
		<if test="wbhsjdw!=null and wbhsjdw.size()>0">
			and  jcdw.csmc   not in
			<foreach collection="wbhsjdw" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="wbhsjhb!=null and wbhsjhb.size()>0">
			and  sj.db   not in
			<foreach collection="wbhsjhb" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
		left join igams_fjsq jr_fj on to_char(jr_fj.lrsj,'YYYY-MM-DD') =  #{bgrq} and sj.sjid = jr_fj.sjid
		   and jr_fj.scbj ='0' and jr_fj.zt in ('10','80') AND jr_fj.LX in 
		   <foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
			#{item}
		  </foreach>
		WHERE fj.scbj != '1'
		and jcxm.cskz1 !='F'
		and fj.lx in
		<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
			#{item}
		</foreach>
		AND ((to_char(fj.rsyrq, 'yyyy-mm-dd hh24') &gt;= #{syrqstart}
		AND to_char(fj.rsyrq, 'yyyy-mm-dd hh24') &lt;= #{syrqend})
		OR (to_char(fj.dsyrq, 'yyyy-MM-dd hh24') &gt;= #{syrqstart}
		AND to_char(fj.dsyrq, 'yyyy-MM-dd hh24') &lt;= #{syrqend})
		OR (to_char(fj.qtsyrq, 'yyyy-MM-dd hh24') &gt;= #{syrqstart}
		AND to_char(fj.qtsyrq, 'yyyy-MM-dd hh24') &lt;= #{syrqend}))
		AND (fj.zt = '80' or fj.zt = '10')
		AND fj.bgbj = '1'
		and qf.csdm not in('VERIFICATION','ENV_MONITOR')
		union all
		SELECT 0 num ,0 bgs,0 fcs,0 wfbgs,count(fj.fjid) jrfcs 
		FROM igams_fjsq fj
		LEFT JOIN igams_sjxx sj ON fj.sjid = sj.sjid
		left join matridx_jcsj jcdw on jcdw.csid=sj.jcdw
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		LEFT JOIN igams_sjhbxx hb
		ON hb.hbmc = sj.db
		AND hb.scbj != '1'
		<if test="wbhsjdw!=null and wbhsjdw.size()>0">
			and  jcdw.csmc   not in
			<foreach collection="wbhsjdw" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="wbhsjhb!=null and wbhsjhb.size()>0">
			and  sj.db   not in
			<foreach collection="wbhsjhb" open="(" close=")" item="item" index="index" separator=",">
				#{item}
			</foreach>
		</if>
        WHERE fj.scbj != '1'
		and fj.lx in
		<foreach collection="fjlxs" open="(" close=")" item="item" index="index" separator=",">
			#{item}
		</foreach>
		AND (fj.zt = '80' or fj.zt = '10')
		AND fj.bgbj = '1'
		AND to_char(fj.lrsj, 'YYYY-MM-DD')  =  #{bgrq}
		and sj.bgrq is null
		) tmp
	</select>
	
	<!-- 页面滚动刷新 -->
	<select id="getListSjxx" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi') AS lrsj, sjxx.hzxm, COALESCE(sjxx.jcxmmc,jcsj.csmc) AS jcxm
				, sjxx.db
			FROM igams_sjxx sjxx
				LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.xh = '1' and jcxm.scbj='0'
				LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = jcxm.jcxmid
			WHERE sjxx.scbj = '0'
			<if test="lrsjStart!=null and lrsjStart!=''">
				and to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi:ss')&gt;#{lrsjStart}
			</if>
			<if test="lrsjEnd!=null and lrsjEnd!=''">
				and to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi:ss')&lt;=#{lrsjEnd}
			</if>
			ORDER BY lrsj
			LIMIT 6 OFFSET (
				SELECT COUNT(sjid)
				FROM igams_sjxx
				WHERE scbj = '0'
			) - 6
	</select>
	
	<!-- 查询两个时间段新增的送检信息 -->
	<select id="getListSjxxBylrsj" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi') AS lrsj, sjxx.hzxm, COALESCE(sjxx.jcxmmc,jcsj.csmc) AS jcxm
				, sjxx.db
			FROM igams_sjxx sjxx
				LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.xh = '1' and jcxm.scbj='0'
				LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = jcxm.jcxmid
			WHERE sjxx.scbj = '0'
			<if test="lrsjStart!=null and lrsjStart!=''">
				and to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi:ss')&gt;#{lrsjStart}
			</if>
			<if test="lrsjEnd!=null and lrsjEnd!=''">
				and to_char(sjxx.lrsj, 'yyyy-MM-dd HH24:mi:ss')&lt;=#{lrsjEnd}
			</if>
			ORDER BY lrsj
	</select>
	<!-- 合作伙伴查看的送检列表 -->
	<select id="getPageDtoBySjhb" parameterType="SjxxDto" resultType="SjxxDto"> 
			select yyxx.dwmc as  hospitalname,
		<include refid="SelectAll"></include>
			from igams_sjxx  sj  
			left join igams_sjdwxx i_d  on sj.ks=i_d.dwid
			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid 
			left join igams_sjhbxx hbxx on sj.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid 
			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.xh = '1' and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			left join igams_hbsfbz sfbz on hbxx.hbid=sfbz.hbid and jcxm.jcxmid=sfbz.xm and case when jcxm.jczxmid is not null and jcxm.jczxmid != '' and sfbz.zxm is not null and sfbz.zxm != '' then  jcxm.jczxmid = sfbz.zxm else 1=1 end
			left join matridx_xtyh xt_xtyh on xt_xtyh.yhid=sj.jsry
			left outer join matridx_jcsj jc_kd on jc_kd.csid =sj.kdlx
			left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
			left join matridx_jcsj jc_fl on jc_fl.csid=hbxx.fl
			left join igams_yyxx yyxx on yyxx.dwid=sj.sjdw
			left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sj.sjqf
			left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sj.kpsq
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
		    <include refid="SelectWhere"></include>
				and sj.scbj='0'  and sj.db in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
                and sj.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
            <if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in 
				<foreach collection="sjhbfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in 
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
				item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!-- 查询统计报高物种信息 -->
	<select id="getWzxxBySjid" parameterType="SjxxDto" resultType="Map">
				SELECT COUNT(sjjg.wzzwm) AS num, sjjg.wzzwm, jcsj.csmc
		FROM igams_sjxx sjxx
			LEFT JOIN igams_sjxxjg sjjg ON sjjg.sjid = sjxx.sjid
			LEFT JOIN matridx_jcsj jcsj ON jcsj.csid = sjxx.yblx
		WHERE sjxx.scbj = '0'
		<if test="sjid!=null and sjid !=''">
			AND sjxx.sjid = #{sjid}
		</if>
			AND sjxx.sjid = #{sjid}
		GROUP BY sjjg.wzzwm, jcsj.csmc
	</select>
	
	<!--添加反馈消息-->
	<update id="updateFeedBack" parameterType="SjxxDto">
		update igams_sjxx set sfzq=#{sfzq},lcfk=#{lcfk},
		<if test="yxbfk !=null and yxbfk !=''">
			yxbfk=#{yxbfk},
		</if>
		xgsj = LOCALTIMESTAMP
		where sjid=#{sjid}
	</update>
	
	<!-- 获取自定义统计的数据 -->
	<select id="getCustomStatis" parameterType="SjxxDto" resultType="Map">
		SELECT <foreach collection="selectzds" open="" close="" separator="," index="index" item="item" >
						${item}
					</foreach>,COUNT(sj.sjid) || '' AS num
			from igams_sjxx sj
			LEFT JOIN igams_sjhbxx hb ON sj.db = hb.hbmc and hb.scbj = '0'
			LEFT JOIN matridx_jcsj jc_mb ON hb.bgmb = jc_mb.csid AND jc_mb.jclb='REPORT_TEMEPLATE'
			LEFT JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid AND jc_fl.jclb = 'CLASSIFY'
			lEFT JOIN matridx_jcsj jc_zfl ON hb.zfl = jc_zfl.csid AND jc_zfl.jclb='SUBCLASSIFICATION'
			LEFT JOIN matridx_jcsj jc_bg ON hb.bgmb = jc_bg.csid AND jc_bg.jclb = 'REPORT_TEMEPLATE'
			LEFT JOIN matridx_jcsj jc_yb ON sj.yblx = jc_yb.csid AND jc_yb.jclb = 'WECGATSAMPLE_TYPE'
			LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
			LEFT JOIN matridx_jcsj jc_xm ON jcxm.jcxmid=jc_xm.csid AND jc_xm.jclb ='DETECT_TYPE'
			lEFT JOIN igams_sjdwxx  sjdwxx ON sjdwxx.dwid= sj.ks
			<where> sj.scbj = '0'${whereParam}
				<if test="dwmc !=null and dwmc !=''">
					AND sj.sjdw like '%'||#{dwmc}||'%'
				</if>
				<if test="ksmc !=null and ksmc !=''">
					AND sjdwxx.dwmc like '%'||#{ksmc}||'%'
				</if>
				<if test="yblxmc !=null and yblxmc !=''">
					AND jc_yb.csmc like '%'||#{yblxmc}||'%'
				</if>
				<if test="fl !=null and fl !=''">
					AND jc_fl.csmc like '%'||#{fl}||'%'
				</if>
				<if test="zfl !=null and zfl !=''">
					AND jc_zfl.csmc like '%'||#{zfl}||'%'
				</if>
				<if test="bgmb !=null and bgmb !=''">
					AND jc_bg.csmc like '%'||#{bgmb}||'%'
				</if>
				<if test="db !=null and db !=''">
					AND sj.db like '%'||#{db}||'%'
				</if>
				<if test="jcxmmc !=null and jcxmmc !=''">
					AND jc_xm.csmc '%'||#{jcxmmc}||'%'
				</if>
				<if test="jsrq !=null and jsrq !=''">
					AND to_char(sj.jsrq,'yyyy-MM-dd')=#{jsrq}
				</if>
				<if test="bgrq !=null and bgrq !=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd')=#{bgrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &gt;=#{jsrqstart}
							AND sfjs = '0'))
				</if>
				<if test="jsrqend!=null and jsrqend!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &lt;= #{jsrqend}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
							AND sfjs = '0'))
				</if>
				<if test="bgrqstart!=null and bgrqstart!=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
					AND to_char(sj.bgrq, 'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
			</where>
			GROUP BY <foreach collection="groupzds" open="" close="" separator="," index="index" item="item" >
						${item}
					</foreach>
			order by <foreach collection="groupzds" open="" close="" separator="," index="index" item="item" >
						${item}
					</foreach>
	</select>
	<!-- 列表显示 -->
	<select id="getCustomStatisList" parameterType="SjxxDto" resultType="Map">
		SELECT 
			<foreach collection="selectzds" open="" close="" separator="," index="index" item="item" >
				${item}
			</foreach>,count(sj.sjid) cn
			from igams_sjxx sj
			LEFT JOIN igams_sjhbxx hb ON sj.db = hb.hbmc and hb.scbj = '0'
			LEFT JOIN matridx_jcsj jc_mb ON hb.bgmb = jc_mb.csid AND jc_mb.jclb='REPORT_TEMEPLATE'
			LEFT JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid AND jc_fl.jclb = 'CLASSIFY'
			lEFT JOIN matridx_jcsj jc_zfl ON hb.zfl = jc_zfl.csid AND jc_zfl.jclb='SUBCLASSIFICATION'
			LEFT JOIN matridx_jcsj jc_bg ON hb.bgmb = jc_bg.csid AND jc_bg.jclb = 'REPORT_TEMEPLATE'
			LEFT JOIN matridx_jcsj jc_yb ON sj.yblx = jc_yb.csid AND jc_yb.jclb = 'WECGATSAMPLE_TYPE'
			LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
			LEFT JOIN matridx_jcsj jc_xm ON jcxm.jcxmid=jc_xm.csid AND jc_xm.jclb ='DETECT_TYPE'
			lEFT JOIN igams_sjdwxx  sjdwxx ON sjdwxx.dwid= sj.ks
			<where> 
				sj.scbj = '0' AND sj.sfjs = '1'
				<if test="dwmc !=null and dwmc !=''">
					AND sj.sjdw like '%'||#{dwmc}||'%'
				</if>
				<if test="ksmc !=null and ksmc !=''">
					AND sjdwxx.dwmc like '%'||#{ksmc}||'%'
				</if>
				<if test="yblxmc !=null and yblxmc !=''">
					AND jc_yb.csmc like '%'||#{yblxmc}||'%'
				</if>
				<if test="fl !=null and fl !=''">
					AND jc_fl.csmc like '%'||#{fl}||'%'
				</if>
				<if test="zfl !=null and zfl !=''">
					AND jc_zfl.csmc like '%'||#{zfl}||'%'
				</if>
				<if test="bgmb !=null and bgmb !=''">
					AND jc_bg.csmc like '%'||#{bgmb}||'%'
				</if>
				<if test="db !=null and db !=''">
					AND sj.db like '%'||#{db}||'%'
				</if>
				<if test="jcxmmc !=null and jcxmmc !=''">
					AND jc_xm.csmc like '%'||#{jcxmmc}||'%'
				</if>
				<if test="jsrq !=null and jsrq !=''">
					AND to_char(sj.jsrq,'yyyy-MM-dd')=#{jsrq}
				</if>
				<if test="bgrq !=null and bgrq !=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd')=#{bgrq}
				</if>
				<if test="jsrqstart!=null and jsrqstart!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &gt;=#{jsrqstart}
							AND sfjs = '0'))
				</if>
				<if test="jsrqend!=null and jsrqend!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &lt;= #{jsrqend}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
							AND sfjs = '0'))
				</if>
				<if test="bgrqstart!=null and bgrqstart!=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
					AND to_char(sj.bgrq, 'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
			</where>
			GROUP BY 
				<foreach collection="groupzds" open="" close="" separator="," index="index" item="item" >
						${item}
				</foreach>
			order by 
				<foreach collection="groupzds" open="" close="" separator="," index="index" item="item" >
					${item}
				</foreach>
	</select>
	
	<!-- 获取统计字段的所有信息，统一统计标题 -->
	<select id="getCustomStatisHead" parameterType="SjxxDto" resultType="SjxxDto">
	select * from (
		SELECT <foreach collection="mainSelects" open="" close="" separator="," index="index" item="item" >
						<if test="index ==0">
						${item}
						</if>
					</foreach>
			from igams_sjxx sj
			LEFT JOIN igams_sjhbxx hb ON sj.db = hb.hbmc and hb.scbj = '0'
			LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
			lEFT JOIN igams_sjdwxx  sjdwxx ON sjdwxx.dwid= sj.ks
			<if test="yblxmc !=null and yblxmc !=''">
				LEFT JOIN matridx_jcsj jc_yb ON jc_yb.csid=sj.yblx		
			</if>
			<if test="fl !=null and fl !=''">
				LEFT JOIN matridx_jcsj jc_fl ON jc_fl.csid=hb.fl			
			</if>
			<if test="zfl !=null and zfl !=''">
				LEFT JOIN matridx_jcsj jc_zfl ON jc_zfl.csid=hb.zfl	
			</if>
			<if test="bgmb !=null and bgmb !=''">
				LEFT JOIN matridx_jcsj jc_bg ON jc_bg.csid=hb.bgmb
			</if>
			<where> 
				sj.scbj = '0' and sj.sfjs ='1'
				<if test="dwmc !=null and dwmc !=''">
					AND sj.sjdw=#{dwmc}
				</if>
				<if test="ksmc !=null and ksmc !=''">
					AND sjdwxx.dwmc=#{ksmc}
				</if>
				<if test="yblxmc !=null and yblxmc !=''">
					AND jc_yb.csmc=#{yblxmc}
				</if>
				<if test="fl !=null and fl !=''">
					AND jc_fl.csmc=#{fl}
				</if>
				<if test="zfl !=null and zfl !=''">
					AND jc_zfl.csmc=#{zfl}
				</if>
				<if test="bgmb !=null and bgmb !=''">
					AND jc_bg.csmc=#{bgmb}
				</if>
				<if test="db !=null and db !=''">
					AND sj.db=#{db}
				</if>
				<if test="jcxmmc !=null and jcxmmc !=''">
					AND jc_xm.csmc=#{jcxmmc}
				</if>
				<if test="jsrqstart!=null and jsrqstart!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &gt;=#{jsrqstart}
							AND sfjs = '0'))
				</if>
				<if test="jsrqend!=null and jsrqend!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &lt;= #{jsrqend}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
							AND sfjs = '0'))
				</if>
				<if test="bgrqstart!=null and bgrqstart!=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
					AND to_char(sj.bgrq, 'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
			</where>
			GROUP BY <foreach collection="mainGroups" open="" close="" separator="," index="index" item="item" >
						<if test="index ==0">
						${item}
						</if>
					</foreach>
			order by <foreach collection="mainGroups" open="" close="" separator="," index="index" item="item" >
						<if test="index ==0">
						${item}
						</if>
					</foreach>
			) left_tab
			left outer join 
			(
		SELECT <foreach collection="mainSelects" open="" close="" separator="," index="index" item="item" >
						<if test="index ==1">
						${item}
						</if>
					</foreach>
			from igams_sjxx sj
			LEFT JOIN igams_sjhbxx hb ON sj.db = hb.hbmc and hb.scbj = '0'
			LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
			lEFT JOIN igams_sjdwxx  sjdwxx ON sjdwxx.dwid= sj.ks
			<if test="yblxmc !=null and yblxmc !=''">
				LEFT JOIN matridx_jcsj jc_yb ON jc_yb.csid=sj.yblx		
			</if>
			<if test="fl !=null and fl !=''">
				LEFT JOIN matridx_jcsj jc_fl ON jc_fl.csid=hb.fl			
			</if>
			<if test="zfl !=null and zfl !=''">
				LEFT JOIN matridx_jcsj jc_zfl ON jc_zfl.csid=hb.zfl	
			</if>
			<if test="bgmb !=null and bgmb !=''">
				LEFT JOIN matridx_jcsj jc_bg ON jc_bg.csid=hb.bgmb
			</if>
			<where> 
				sj.scbj = '0' and sj.sfjs ='1'
				<if test="dwmc !=null and dwmc !=''">
					AND sj.sjdw=#{dwmc}
				</if>
				<if test="ksmc !=null and ksmc !=''">
					AND sjdwxx.dwmc=#{ksmc}
				</if>
				<if test="yblxmc !=null and yblxmc !=''">
					AND jc_yb.csmc=#{yblxmc}
				</if>
				<if test="fl !=null and fl !=''">
					AND jc_fl.csmc=#{fl}
				</if>
				<if test="zfl !=null and zfl !=''">
					AND jc_zfl.csmc=#{zfl}
				</if>
				<if test="bgmb !=null and bgmb !=''">
					AND jc_bg.csmc=#{bgmb}
				</if>
				<if test="db !=null and db !=''">
					AND sj.db=#{db}
				</if>
				<if test="jcxmmc !=null and jcxmmc !=''">
					AND jc_xm.csmc=#{jcxmmc}
				</if>
				<if test="jsrqstart!=null and jsrqstart!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &gt;=#{jsrqstart}
							AND sfjs = '0'))
				</if>
				<if test="jsrqend!=null and jsrqend!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &lt;= #{jsrqend}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
							AND sfjs = '0'))
				</if>
				<if test="bgrqstart!=null and bgrqstart!=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
					AND to_char(sj.bgrq, 'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
			</where>
				GROUP BY <foreach collection="mainGroups" open="" close="" separator="," index="index" item="item" >
						<if test="index ==1">
						${item}
						</if>
					</foreach>
				order BY <foreach collection="mainGroups" open="" close="" separator="," index="index" item="item" >
						<if test="index ==1">
						${item}
						</if>
					</foreach>
			) right_tab on 1=1
	</select>
	
	<!-- 获取统计字段的所有信息，统一统计标题 -->
	<select id="getCustomStatisByHead" parameterType="Map" resultType="Map">
		SELECT 
				<foreach collection="selzdList" open="" close="" separator="," index="index" item="item" >
					${item}
				</foreach>,count(sj.sjid) cn
			from 
			(
				<foreach collection="heads" open="" close="" separator=" union " index="index2" item="item2" >
					select 
					<foreach collection="tjzdList" open="" close="" separator="," index="index3" item="item3" >
						#{item2.${item3}} as ${item3}
					</foreach>
				</foreach>
			) tmp
			left outer join igams_sjxx sj on 1=1
				<foreach collection="tjzdList" open="" close=""  index="index4" item="item4" >
					<if test="item4=='jsrq' or item4=='syrq' or item4 =='bgrq'">
						<if test="sjxxDto.tjzq =='day'">
					 		and	 to_char(sj.${item4},'YYYY-MM-DD') = tmp.${item4} 
						</if>
						<if test="sjxxDto.tjzq =='month'">
					 		and	 to_char(sj.${item4},'YYYY-MM') = tmp.${item4} 
						</if>
						<if test="sjxxDto.tjzq =='year'">
					 		and	 to_char(sj.${item4},'YYYY') = tmp.${item4} 
						</if>
					</if>
					<if test="item4!='jsrq' and item4!='syrq' and item4 !='bgrq' and  item4 !='fl' and item4 !='zfl' and item4 !='bgmb' and item4 !='jcxmid' ">
					  and	 sj.${item4} = tmp.${item4} 
					</if>
				</foreach>
				and sj.scbj = '0'and sj.sfjs ='1'
			LEFT JOIN igams_sjhbxx hb ON sj.db = hb.hbmc and hb.scbj = '0'
			<foreach collection="tjzdList" open="" close=""  index="index4" item="item4" >
			     <if test="item4 =='fl' or item4 =='zfl' or item4 =='bgmb'">
					 and hb.${item4}  = tmp.${item4} 
				 </if> 
			</foreach>
			LEFT JOIN matridx_jcsj jc_fl ON jc_fl.csid=hb.fl
			LEFT JOIN matridx_jcsj jc_zfl ON jc_zfl.csid=hb.zfl
			LEFT JOIN matridx_jcsj jc_bg ON jc_bg.csid=hb.bgmb
			LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
			<foreach collection="tjzdList" open="" close=""  index="index4" item="item4" >
			     <if test="item4 =='jcxmid'">
					 and jcxm.${item4}  = tmp.${item4} 
				 </if> 
			</foreach> 
			LEFT JOIN matridx_jcsj jc_xm ON jcxm.jcxmid= jc_xm.csid
			lEFT JOIN igams_sjdwxx  sjdwxx ON sjdwxx.dwid= sj.ks
			LEFT JOIN matridx_jcsj jc_yb on jc_yb.csid=sj.yblx 
			<where> 
				<if test="sjxxDto.dwmc !=null and sjxxDto.dwmc !=''">
					AND sj.sjdw=#{sjxxDto.dwmc}
				</if>
				<if test="sjxxDto.ksmc !=null and sjxxDto.ksmc !=''">
					AND sjdwxx.dwmc=#{sjxxDto.ksmc}
				</if>
				<if test="sjxxDto.yblxmc !=null and sjxxDto.yblxmc !=''">
					AND jc_yb.csmc=#{sjxxDto.yblxmc}
				</if>
				<if test="sjxxDto.fl !=null and sjxxDto.fl !=''">
					AND jc_fl.csmc=#{sjxxDto.fl}
				</if>
				<if test="sjxxDto.zfl !=null and sjxxDto.zfl !=''">
					AND jc_zfl.csmc=#{sjxxDto.zfl}
				</if>
				<if test="sjxxDto.bgmb !=null and sjxxDto.bgmb !=''">
					AND jc_bg.csmc=#{sjxxDto.bgmb}
				</if>
				<if test="sjxxDto.db !=null and sjxxDto.db !=''">
					AND sj.db=#{sjxxDto.db}
				</if>
				<if test="sjxxDto.jcxmmc !=null and sjxxDto.jcxmmc !=''">
					AND jc_xm.csmc=#{sjxxDto.jcxmmc}
				</if>
				<if test="sjxxDto.jsrqstart!=null and sjxxDto.jsrqstart!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &gt;= #{sjxxDto.jsrqstart}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &gt;=#{sjxxDto.jsrqstart}
							AND sfjs = '0'))
				</if>
				<if test="sjxxDto.jsrqend!=null and sjxxDto.jsrqend!=''">
					AND (to_char(coalesce(sj.dsyrq, sj.syrq, sj.qtsyrq), 'yyyy-MM-dd') &lt;= #{sjxxDto.jsrqend}
						OR (to_char(sj.jsrq, 'yyyy-MM-dd') &lt;= #{sjxxDto.jsrqend}
							AND sfjs = '0'))
				</if>
				<if test="sjxxDto.bgrqstart!=null and sjxxDto.bgrqstart!=''">
					AND to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{sjxxDto.bgrqstart}
				</if>
				<if test="sjxxDto.bgrqend!=null and sjxxDto.bgrqend!=''">
					AND to_char(sj.bgrq, 'yyyy-MM-dd') &lt;= #{sjxxDto.bgrqend}
				</if>
			</where>
			GROUP BY
					<foreach collection="groupzdList" open="" close="" separator="," index="index5" item="item5" >
						${item5}
					</foreach>
			order by 
					<foreach collection="groupzdList" open="" close="" separator="," index="index6" item="item6" >
						${item6}
					</foreach>
	</select>
	<!-- 根据送检ID查询伙伴信息 -->
	<select id="selectBgmbBySjid" parameterType="String"  resultType="SjxxDto">
		select jcsj.csmc bgmbmc,sjxx.cskz3,sjxx.mxid
			from igams_sjxx sjxx 
			left outer join igams_sjhbxx hb ON hb.hbmc = sjxx.db and hb.scbj = '0'
			left join matridx_jcsj jcsj on hb.bgmb=jcsj.csid
			where sjxx.scbj = '0' and sjxx.sjid = #{sjid}
	</select>
	<!-- 日报送检清单 -->
	<select id="getListBydaily" parameterType="SjxxDto" resultType="SjxxDto"> 
		select sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,jc_jcdw.cskz2 jcdwjc,jc_xm.cskz1 jcxmkzcs,
		case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sjxx.db,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否' when sjxx.sfsf='2' then '免D' when sjxx.sfsf='3' then '免R' end sfsf ,
		jc_xm.csmc jcxmmc,yyxx.cskz1 sjdwbj,yyxx.dwmc yymc
		from igams_sjxx sjxx
		left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
		left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
		left outer join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
		left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj = '0'
		left outer join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
		<where>
			sjxx.scbj = '0'
			<if test="jsrq !=null and jsrq !=''">
				and to_char(coalesce(sjxx.dsyrq, sjxx.syrq, sjxx.qtsyrq), 'yyyy-MM-dd') = #{jsrq}
			</if>
			order by jc_jcdw.cspx,jc_jcdw.cskz2,hb.tjmc,sjxx.db,jc_xm.cskz1,sjxx.hzxm
		</where>
	</select>
	<!-- 日报送检清单(接收日期) -->
	<select id="getListBydailyAndJsrq" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,jc_jcdw.cskz2 jcdwjc,jc_xm.cskz1 jcxmkzcs,
		case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sjxx.db,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否' when sjxx.sfsf='2' then '免D' when sjxx.sfsf='3' then '免R' end sfsf ,
		jc_xm.csmc jcxmmc,yyxx.cskz1 sjdwbj,yyxx.dwmc yymc
		from igams_sjxx sjxx
		left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
		left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
		left outer join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
		left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		left outer join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
		<where>
			sjxx.scbj = '0'
			<if test="jsrq !=null and jsrq !=''">
				and to_char(sjxx.jsrq, 'yyyy-MM-dd') = #{jsrq}
			</if>
			order by jc_jcdw.cspx,jc_jcdw.cskz2,hb.tjmc,sjxx.db,jc_xm.cskz1,sjxx.hzxm
		</where>
	</select>
	<!-- 查询组装内部编码所需要的的数据 -->
	<select id="getconfirmDm" parameterType="String" resultType="SjxxDto">
		select jc_jcxm.cskz1 as jcdm,sjxx.hzxm,jc_yblx.csdm as lxdm,jc_jcdw.csdm as jcdwdm,jc_jcxm.cskz4 as jcxm ,
		jc_jcxm.cskz3 as jcxmcskz3,jc_sjqf.csmc sjqfmc, sjxx.yblx, sjxx.yblxmc,hbxx.cskz4
		from igams_sjxx sjxx
		left join igams_sjjcxm sjjcxm on sjjcxm.sjid =sjxx.sjid and sjjcxm.xh = '1'and sjjcxm.scbj = '0'
		left join igams_sjhbxx hbxx on sjxx.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join matridx_jcsj jc_jcxm on sjjcxm.jcxmid=jc_jcxm.csid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid=sjxx.sjqf
		<where>
			sjxx.scbj !='1' and sjxx.ybbh=#{ybbh}
		</where>
	</select>
	<!-- 查询流水号 -->
	<select id="getSerial" parameterType="SjxxDto" resultType="String">
		SELECT lpad(CAST(CAST(coalesce(MAX(substring(substring(nbbm,strpos(nbbm,'-')+1,LENGTH(nbbm)), 10, 3)), '000') AS numeric) + 1 as VARCHAR), 3, '0')
		FROM igams_sjxx sjxx
		left join igams_sjjcxm sjjcxm on sjjcxm.sjid =sjxx.sjid and sjjcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on sjjcxm.jcxmid=jc_jcxm.csid
		<where>
			nbbm IS NOT NULL
			AND (LENGTH(substring(nbbm,strpos(nbbm,'-')+1,LENGTH(nbbm))) = '13' or substring(nbbm,LENGTH(nbbm)-2,LENGTH(nbbm)) = 'XXX')
			AND substring(substring(nbbm,strpos(nbbm,'-')+1,LENGTH(nbbm)), 5, 5) = #{serial}
			AND substring(substring(nbbm,strpos(nbbm,'-')+1,LENGTH(nbbm)), 2, 2) = #{jcdwdm}
			<if test="jcdm=='F'.toString()">
				AND jc_jcxm.cskz1 = 'F'
			</if>
			<if test="jcdm !='F'.toString()">
				AND jc_jcxm.cskz1 != 'F'
			</if>
			AND sjxx.scbj = '0'
		</where>
	</select>

	<!-- 查询组装内部编码所需要的的数据 -->
	<select id="getconfirmDmInfo" parameterType="String" resultType="Map">
		select jc_jcxm.cskz1 as jcdm,sjxx.hzxm,jc_yblx.csdm as lxdm,jc_yblx.cskz1 as lxcskz1,jc_jcdw.csdm as jcdwdm,jc_jcxm.cskz4 as jcxm ,
		jc_jcxm.cskz3 as jcxmcskz3,jc_sjqf.csmc sjqfmc,jc_sjqf.csdm sjqfdm,cast(coalesce( jc_sjqf.cspx,0) as VARCHAR) as sjqfxh, sjxx.yblx, sjxx.yblxmc,
		hbxx.cskz4 hbbmgz,jc_jcdw.cskz4 jcdwbmgz,jc_sjqf.cskz1 sjqfbmgz,jc_kyxm.csdm kydm,jc_kyxm.csmc kybm,sjxx.kyxm
		from igams_sjxx sjxx
		left join igams_sjjcxm sjjcxm on sjjcxm.sjid =sjxx.sjid and sjjcxm.scbj = '0'
		left join igams_sjhbxx hbxx on sjxx.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join matridx_jcsj jc_jcxm on sjjcxm.jcxmid=jc_jcxm.csid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid=sjxx.sjqf
		left join matridx_jcsj jc_kyxm on jc_kyxm.csid=sjxx.kyxm
		<where>
			sjxx.scbj !='1' and sjxx.ybbh=#{ybbh}
		</where>
		order by sjjcxm.xh asc
	</select>

	<!-- 获取自定义流水号 -->
	<select id="getCustomSerial" parameterType="Map" resultType="String">
		SELECT lpad(CAST(CAST(coalesce(MAX(substring(nbbm, #{startindex}, #{seriallength})), '0') AS numeric) + 1 as VARCHAR), #{seriallength}, '0')
		FROM igams_sjxx sjxx
		left join igams_sjjcxm sjjcxm on sjjcxm.sjid =sjxx.sjid and sjjcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on sjjcxm.jcxmid=jc_jcxm.csid
		<where>
			nbbm IS NOT NULL
			<if test="conditionList !=null and  conditionList.size() > 0">
				<foreach collection="conditionList" item="item" index="index">
					AND substring(nbbm,#{item.conditionIndex}, #{item.conditionLength}) = #{item.conditionKey}
				</foreach>
			</if>
			<if test="jcdm=='F'.toString()">
				AND jc_jcxm.cskz1 = 'F'
			</if>
			<if test="jcdm !='F'.toString()">
				AND jc_jcxm.cskz1 != 'F'
			</if>
			AND sjxx.scbj = '0'
		</where>
	</select>

	<!-- 根据条件查询下载报告 -->	
	<select id="selectDownloadReport" parameterType="Map" resultType="SjxxDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid,sj.sjid
			from igams_sjxx sj
			left outer join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
			left join igams_sjdwxx i_d  on sj.ks=i_d.dwid
			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid 
			left join igams_sjhbxx hbxx on sj.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid 
			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			left join igams_hbsfbz sfbz on hbxx.hbid=sfbz.hbid and jcxm.jcxmid=sfbz.xm and case when jcxm.jczxmid is not null and jcxm.jczxmid != '' and sfbz.zxm is not null and sfbz.zxm != '' then  jcxm.jczxmid = sfbz.zxm else 1=1 end
			left outer join matridx_fjcfb fjcfb on sj.sjid = fjcfb.ywid and ( 1=2
			<if test="bglxbj !=null and  bglxbj =='pdf'">
				or fjcfb.ywlx in
				<foreach collection="pdfywlxs" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="bglxbj !=null and  bglxbj =='word'">
				or fjcfb.ywlx in
				<foreach collection="wordywlxs" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="bglxbj !=null and  bglxbj =='Q-mNGS'">
				or fjcfb.ywlx in (
				'IMP_WORD_DETECTION_HBMC_NO_D', 'IMP_WORD_DETECTION_HBMC_NO_R', 'IMP_WORD_DETECTION_HBMC_NO_C',
				'IMP_WORD_DETECTION_HBMC_NO_D_REM','IMP_WORD_DETECTION_HBMC_NO_R_REM','IMP_WORD_DETECTION_HBMC_NO_C_REM')
			</if>)
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<include refid="SelectWhere"></include>
			and sj.scbj = '0' and fjcfb.fjid is not null
		</where> 
	</select>
	
	<select id="getAllSjxxOther" parameterType="String" resultType="Map">
		select sj.sjid,case when jc_jczxm.cskz1 is not null and jc_jczxm.cskz1 !='' then jc_jczxm.cskz1 else jc_jcxm.cskz1 end cskz1,
			case when jc_jczxm.cskz2 is not null and jc_jczxm.cskz2 !='' then jc_jczxm.cskz2 else jc_jcxm.cskz2 end cskz2,
			case when jc_jczxm.cskz3 is not null and jc_jczxm.cskz3 !='' then jc_jczxm.cskz3 else jc_jcxm.cskz3 end cskz3,
			sjjcxm.jcxmid jcxm,sjjcxm.jczxmid jczxm,sj.kdh,sj.kdfy,
			(select
				array_to_string(ARRAY(SELECT unnest(array_agg(
						case when jc_zxm.csmc is not null then jc_xm.csmc||'-'||jc_zxm.csmc else jc_xm.csmc end
					))), ',') from igams_sjjcxm jcxmmc
	      		left outer join matridx_jcsj jc_xm on jcxmmc.jcxmid = jc_xm.csid
				left outer join matridx_jcsj jc_zxm on jcxmmc.jczxmid = jc_zxm.csid
		where sj.sjid = jcxmmc.sjid  and jcxmmc.scbj='0') jcxmmc,
			(select array_to_string(ARRAY(SELECT unnest(array_agg(
						case when jc_zxm.cskz3 is not null then jc_zxm.cskz3 else jc_xm.cskz3 end
					))), ',') from igams_sjjcxm jcxmmc
				left outer join matridx_jcsj jc_xm on jcxmmc.jcxmid = jc_xm.csid
				left outer join matridx_jcsj jc_zxm on jcxmmc.jczxmid = jc_zxm.csid
			where sj.sjid = jcxmmc.sjid  and jcxmmc.scbj='0') cskz3s,
			(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_lc.csmc))), ',') from igams_Sjlczz lczz
				left outer join matridx_jcsj jc_lc on lczz.zz = jc_lc.csid where sj.sjid = lczz.sjid ) lczz ,
	      	(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_qq.csmc||':'||qqjcmc.jcz||jc_qq.cskz1))), ',') from igams_sjqqjc qqjcmc 
	      		left outer join matridx_jcsj jc_qq on qqjcmc.yjxm = jc_qq.csid where sj.sjid = qqjcmc.sjid ) qqjcmc,
		 	(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_by.csmc))), ',') from igams_sjgzby gzbymc
	      		left outer join matridx_jcsj jc_by on gzbymc.by = jc_by.csid where sj.sjid = gzbymc.sjid ) gzbymc,
			(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_by.csid))), ',') from igams_sjgzby gzbyid
				left outer join matridx_jcsj jc_by on gzbyid.by = jc_by.csid where sj.sjid = gzbyid.sjid ) gzbyid,
		  	(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_zt.csmc))), ',') from igams_sjybzt ybztmc 
	      		left outer join matridx_jcsj jc_zt on ybztmc.zt = jc_zt.csid where sj.sjid = ybztmc.sjid ) ybztmc 
		from igams_sjxx sj 
			left join igams_sjjcxm sjjcxm on sjjcxm.sjid=sj.sjid and sjjcxm.xh = '1' and sjjcxm.scbj = '0'
			left join matridx_jcsj jc_jcxm on sjjcxm.jcxmid=jc_jcxm.csid
			left join matridx_jcsj jc_jczxm on sjjcxm.jczxmid=jc_jczxm.csid
   		<where>
   			sj.sjid=#{sjid}
		</where>
	</select>
	<!-- 同步修改送检信息 -->
	<update id="weChatUpdate" parameterType="SjxxModel">
			update igams_sjxx set
			xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="yblxmc !=null and yblxmc != ''.toString()">
			,yblxmc = #{yblxmc}
		</if>
		<if test="yblxmc ==null || yblxmc == ''.toString()">
			,yblxmc = null
		</if>
		<if test="hzxm !=null and  hzxm !=''">
			,hzxm=#{hzxm}
		</if>
		<if test="xb !=null and  xb !=''">
			,xb=#{xb}
		</if>
		<if test="nl !=null and  nl !=''">
			,nl=#{nl}
		</if>
		<if test="nldw !=null and  nldw !=''">
			,nldw=#{nldw}
		</if>
		<if test="dh !=null">
			,dh=#{dh}
		</if>
		<if test="sjdw !=null and  sjdw !=''">
			,sjdw=#{sjdw}
		</if>
		<if test="sjdwmc !=null and sjdwmc !=''">
			,sjdwmc=#{sjdwmc}
		</if>
		<if test="sfjs !=null and  sfjs !=''">
			,sfjs=#{sfjs}
		</if>
		<if test="sftj !=null and  sftj !=''">
			,sftj=#{sftj}
		</if>
		<if test="ks !=null and  ks !=''">
			,ks=#{ks}
		</if>
		<if test="sjys !=null and  sjys !=''">
			,sjys=#{sjys}
		</if>
		<if test="ysdh !=null">
			,ysdh=#{ysdh}
		</if>
		<if test="yblx !=null and  yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="db!=null and db !=''">
			,db=#{db}
		</if>
		<if test="ybtj !=null and  ybtj !=''">
			,ybtj=#{ybtj}
		</if>
		<if test="zyh !=null">
			,zyh=#{zyh}
		</if>
		<if test="cwh !=null and cwh !=''">
			,cwh=#{cwh}
		</if>
		<if test="ybbh !=null and  ybbh !=''">
			,ybbh=#{ybbh}
		</if>
		<if test="cyrq !=null and  cyrq !=''">
			,cyrq=cast(#{cyrq} as date)
		</if>
		<if test="sjrq !=null and  sjrq !=''">
			,sjrq=cast(#{sjrq} as date)
		</if>
		<if test="jsrq !=null and jsrq !=''">
			,jsrq=cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsry !=null and  jsry !=''">
			,jsry=#{jsry} 
		</if>
		<if test="bgrq !=null and bgrq!=''">
			,bgrq=cast(#{bgrq} as timestamp)
		</if>
		<if test="fkrq !=null and fkrq !=''">
			,fkrq=cast(#{fkrq} as timestamp)
		</if>
		<if test="lczz !=null and  lczz !=''">
			,lczz=#{lczz}
		</if>
		<if test="qqzd !=null and  qqzd !=''">
			,qqzd=#{qqzd}
		</if>
		<if test="jqyy !=null">
			,jqyy=#{jqyy}
		</if>
		<if test="qqjc !=null">
			,qqjc=#{qqjc}
		</if>
		<if test="jyjg !=null and  jyjg !=''">
			,jyjg=#{jyjg}
		</if>
		<if test="kdlx !=null and  kdlx !=''">
			,kdlx=#{kdlx}
		</if>
		<if test="kdh !=null and  kdh !=''">
			,kdh=#{kdh}
		</if>
		<if test="cskz3 !=null and  cskz3 !=''">
			,cskz3=#{cskz3}
		</if>
		<if test="kdh ==null or  kdh ==''">
			,kdh=null
		</if>
        <if test="kdfy !=null and  kdfy !=''">
            <!-- ,kdfy=cast(#{kdfy} as numeric) -->
            ,kdfy = #{kdfy}
        </if>
		<if test="bz !=null">
			,bz=#{bz}
		</if>
		<if test="fkbj !=null and  fkbj !=''">
			,fkbj=#{fkbj}
		</if>
		<if test="nbbm !=null">
			,nbbm=#{nbbm}
		</if>
		<if test="ddh !=null and  ddh !=''">
			,ddh=#{ddh}
		</if>
		<if test="sfsf !=null and  sfsf !=''">
			,sfsf=#{sfsf}
			<if test="sfsf == '0'.toString()">
				,fkje = null
			</if>
		</if>
		<if test="zt !=null and  zt !=''">
			,zt=#{zt}
		</if>
		<if test="sfzq !=null and sfzq !=''">
			,sfzq=#{sfzq}
		</if>
		<if test="lcfk !=null and lcfk !=''">
			,lcfk=#{lcfk}
		</if>
		<if test="qyrq !=null and qyrq !=''">
			,qyrq=cast(#{qyrq} as timestamp)
		</if>
		<if test="ydrq !=null and ydrq !=''">
			,ydrq=cast(#{ydrq} as timestamp)
		</if>
		<if test="yjydrq !=null and yjydrq !=''">
			,yjydrq=cast(#{yjydrq} as timestamp)
		</if>
		<if test="qyrq ==null or qyrq ==''">
			,qyrq=null
		</if>
		<if test="ydrq ==null or ydrq ==''">
			,ydrq = null
		</if>
		<if test="yjydrq ==null or yjydrq ==''">
			,yjydrq = null
		</if>
		<if test="jcdw !=null and jcdw !=''">
			,jcdw=#{jcdw}
		</if>
		<if test="sfzmjc !=null and sfzmjc !=''">
			<if test="sfzmjc== '0'.toString() ">
				,zmmdd=null
			</if>
			<if test="sfzmjc== '1'.toString() ">
				,zmmdd=#{zmmdd}
			</if>
		</if>
		<if test="sjqf !=null and sjqf !=''">
			,sjqf=#{sjqf}
		</if>
		<if test="kyxm !=null and kyxm !=''">
			,kyxm=#{kyxm}
		</if>
		<if test="kyxm == null or kyxm ==''">
			,kyxm=null
		</if>
		<if test="scbj == null or scbj == ''">
			,scbj = '0'
		</if>
		<if test="scbj != null and scbj != ''">
			,scbj = #{scbj}
		</if>
		<if test="sfvip !=null and sfvip != ''">
			,sfvip = #{sfvip}
		</if>
		<if test="sfws != null and sfws != ''">
			,sfws = #{sfws}
		</if>
		<if test="jcxmmc != null and jcxmmc != ''">
			,jcxmmc = #{jcxmmc}
		</if>
		<if test="clbj != null and clbj != ''">
			,clbj = #{clbj}
		</if>
		<if test="fkje !=null and fkje !='' and sfsf != '0'.toString()">
			,fkje=cast(#{fkje} as numeric)
		</if>
		,kpsq=#{kpsq}
			,qtks=#{qtks}
			,px=#{px}
		<where>
			sjid=#{sjid}
		</where>
	</update>
	
	<!-- 根据选择查询下载报告 -->	
	<select id="selectDownloadReportByIds" parameterType="Map" resultType="SjxxDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid,sj.sjid
			from igams_sjxx sj
			left join igams_sjdwxx i_d  on sj.ks=i_d.dwid
			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid 
			left join igams_sjhbxx hbxx on sj.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid 
			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			left join igams_hbsfbz sfbz on hbxx.hbid=sfbz.hbid and jcxm.jcxmid=sfbz.xm and case when jcxm.jczxmid is not null and jcxm.jczxmid != '' and sfbz.zxm is not null and sfbz.zxm != '' then  jcxm.jczxmid = sfbz.zxm else 1=1 end
			left outer join matridx_fjcfb fjcfb on sj.sjid = fjcfb.ywid and ( 1=2
			<if test="bglxbj !=null and  (bglxbj =='pdf' or bglxbj == 'allpdf')">
				or fjcfb.ywlx in
				<foreach collection="pdfywlxs" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="bglxbj !=null and bglxbj =='word'">
				or fjcfb.ywlx in
				<foreach collection="wordywlxs" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="bglxbj !=null and  bglxbj =='Q-mNGS'">
				or fjcfb.ywlx in ( 'IMP_WORD_DETECTION_HBMC_NO_D', 'IMP_WORD_DETECTION_HBMC_NO_R', 'IMP_WORD_DETECTION_HBMC_NO_C',
				'IMP_WORD_DETECTION_HBMC_NO_D_REM','IMP_WORD_DETECTION_HBMC_NO_R_REM','IMP_WORD_DETECTION_HBMC_NO_C_REM')
			</if>
			)
		<where>
			sj.scbj = '0' and fjcfb.fjid is not null
			and sj.sjid in
			<foreach collection="ids" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		</where> 
	</select>
	
	<select id="getMapBySjid" parameterType="Map" resultType="Map">
		SELECT sjxx.ybbh,sjxx.sjid,sjxx.zyh,to_char(sjxx.cyrq,'yyyy-MM-dd') as cyrq,sjxx.cwh,sjxx.dh,to_char(sjxx.sjrq,'yyyy-MM-dd') as sjrq,
			sjxx.qqjc as qqjcmc,sjxx.jqyy, sjxx.hzxm AS hzxm, sjxx.nl,sjxx.nldw,CASE WHEN yyxx.cskz1 = '1' THEN sjxx.sjdwmc ELSE yyxx.dwmc END AS sjdw
			 , sjxx.sjys, sjxx.ybtj, sjxx.ybbh,sjxx.ysdh,sjxx.dh,sjxx.wbbm
			 , to_char(sjxx.jsrq, 'yyyy-MM-dd') AS fjsrq
			 , to_char(sjxx.bgrq, 'yyyy-MM-dd') AS report_date
			 , to_char(sjxx.bgrq, 'yyyy-MM-dd HH24:mi') AS report_time
			 , to_char(bgsm.scbgrq, 'yyyy-MM-dd HH24:mi:ss') AS first_report_accurate_time
			 , to_char(sjxx.bgrq, 'yyyy-MM-dd HH24:mi:ss') AS report_accurate_time
			 , CASE
				   WHEN dw.kzcs = '1' and sjxx.qtks is not null and sjxx.qtks !='' THEN sjxx.qtks
				   ELSE dw.dwmc
			END AS ksmc, sjxx.q20||'%' as q20, sjxx.q30||'%' as q30
			 , CASE
				   WHEN sjxx.xb = '1' THEN '男'
				   WHEN sjxx.xb = '2' THEN '女'
				   WHEN sjxx.xb = '3' THEN '未知'
			END AS xbmc
			 , case when sjxx.yblxmc is null then jc_yb.csmc
				   else sjxx.yblxmc end AS yblxmc, bgsm.ggzdsm AS pathogen_comment,
			substring(sjxx.nbbm,length(sjxx.nbbm),1)  AS yblxdm
			 , bgsm.yxxls, bgsm.ryzs,case when bgsm.ryzsbfb ='0.00' then '0.01' when bgsm.ryzsbfb='100.00' then'99.99'else bgsm.ryzsbfb end ryzsbfb, bgsm.ryzswz, fjcfb.wjlj
			 ,hb.hbid,hb.hbmc,hb.hblx, hbjcsj.cskz1 gzlxmc, gz_fj.wjlj gzlxdz,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,
			(select array_to_string(ARRAY(SELECT unnest(array_agg(jc_by.csmc))), ',') from igams_sjgzby gzbymc
																							   left outer join matridx_jcsj jc_by on gzbymc.by = jc_by.csid where sjxx.sjid = gzbymc.sjid ) gzbymc
			 ,bgsm.zxls,bgsm.gc||'%' as gc,bgsm.szxlbfb||'%' as szxlbfb,bgsm.wswjcxls,case when bgsm.spikerpm >'0' then  '是' else  '否' end ncjc,sjxx.sfsf
			 ,jc_yb.csdm as yblxcsdm,jcdw.csdm as jcdwcsdm,jcdw.cskz5 as jcdwcskz5
		FROM igams_sjxx sjxx
				 LEFT JOIN igams_sjdwxx dw ON sjxx.ks = dw.dwid
				 LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sjxx.sjdw
				 LEFT JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc and hb.scbj = '0'
				 LEFT JOIN matridx_jcsj jc_yb ON sjxx.yblx = jc_yb.csid
				 LEFT JOIN matridx_jcsj jc_yblxdm ON jc_yblxdm.jclb = 'WECGATSAMPLE_TYPE' and jc_yblxdm.csdm = substring(sjxx.nbbm,length(sjxx.nbbm),1) and jc_yblxdm.scbj='0'
				 LEFT JOIN matridx_fjcfb fjcfb ON fjcfb.ywid = jc_yblxdm.csid
				 LEFT JOIN igams_sjbgsm bgsm ON bgsm.sjid = sjxx.sjid AND bgsm.jclx = #{jclx}
					<if test="jczlx != null and jczlx != ''">
						and bgsm.jczlx = #{jczlx}
					</if>
				 LEFT JOIN matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
				 LEFT JOIN matridx_fjcfb gz_fj on gz_fj.ywid = hbjcsj.csid and gz_fj.ywlx = 'STAMP_PIC'
				 LEFT JOIN matridx_jcsj jcdw on sjxx.jcdw = jcdw.csid
		<where>
			sjxx.scbj = '0'
		  AND sjxx.sjid = #{sjid}
		</where>
	</select>
	<select id="getQqjcForReport" parameterType="String" resultType="map">
		SELECT 'jc' || jc_qqjc.csdm AS csdm
				, CASE 
				WHEN sjqqjc.jcz IS NULL THEN ''
			ELSE sjqqjc.jcz || CASE 
				WHEN jc_qqjc.cskz1 IS NULL
				OR jc_qqjc.cskz1 = '' THEN ''
				ELSE jc_qqjc.cskz1
			END
		END AS jcz
	FROM matridx_jcsj jc_qqjc
		LEFT JOIN igams_sjqqjc sjqqjc
	ON sjqqjc.yjxm = jc_qqjc.csid
		AND sjqqjc.sjid = #{sjid}
	<where> 
		jc_qqjc.jclb = 'DETECTION_TYPE'
	</where>
	</select>
	<!-- 根据录入人员获取伙伴信息 -->
	<select id="getDbsByLrrys" parameterType="SjxxDto" resultType="String">
		select db
			from igams_sjxx
		<where>
			scbj = '0'
			and lrry in 
			<foreach collection="lrrys" separator="," open="(" close=") "
			item="item" index="index">
				#{item}
			</foreach>
		</where>
		group by db
	</select>
	
	<select id="getJsjcdwByjsid" parameterType="String" resultType="Map">
		select xtjs.dwxdbj,jsjcdw.jcdw,jcdw.csmc jcdwmc from matridx_xtjs  xtjs
		left join matridx_jsjcdw  jsjcdw on jsjcdw.jsid= xtjs.jsid
		left join matridx_jcsj jcdw on jcdw.csid = jsjcdw.jcdw and jcdw.scbj!='1'
		<where>
		 	xtjs.jsid=#{jsid} order by jcdw.cspx asc
		</where> 
	</select>
	
	<!-- 根据标本编号获取送检信息 -->
	<select id="getListByYbbhs" parameterType="list" resultType="Map">
		select sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,
			sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,
			sjdw.xh,sjdw.fdwid,sjdw.dwdm,sjdw.dwmc,sjdw.dh,sj.fkbj,sj.fkje,sj.nbbm,sj.fkrq,sj.qtks,
			sj.sfjs,sj.sftj,sj.sfsf,sj.sfje,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,jc_jcdw.csmc jcdwmc,COALESCE(sj.jcxmmc,jcxmlx.csmc) jcxmmc,case when jcsj.cskz1 ='1' then COALESCE(sj.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc
 		from igams_sjxx  sj
 			left join igams_sjdwxx sjdw on sj.ks=sjdw.dwid
 			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid
 			left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
 			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.xh = '1' and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
		<where>
			sj.scbj = '0'
			<if test="list !=null and  list.size() > 0">
				and sj.ybbh in
				<foreach collection="list" separator="," open="(" close=")" item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!-- 根据标本编号获取送检信息  -->
	<select id="getDtoByYbbh"  parameterType="String"  resultType="SjxxDto" >
		select sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.ybtj,sj.nldw,
			sj.zyh,sj.cwh,sj.ybbh,sj.cyrq,sj.jsrq,to_char(sj.jsrq,'yyyy-MM-dd') fjsrq,sj.bgrq,sj.jsry,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,sj.kdfy,sj.bz,
			sjdw.xh,sjdw.fdwid,sjdw.dwdm,sjdw.dwmc,sjdw.dh,sj.fkbj,sj.fkje,sj.nbbm,sj.fkrq,sj.qtks,
			sj.sfjs,sj.sftj,sj.sfsf,sj.sfje,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,jc_jcdw.csmc jcdwmc,COALESCE(sj.jcxmmc,jcxmlx.csmc) jcxmmc,case when jcsj.cskz1 ='1' then COALESCE(sj.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,
			jcxmlx.cskz1 jclx,jcxmlx.cskz3 cskz3,yyxx.dwmc as hospitalname
 		from igams_sjxx sj
 			left join igams_sjdwxx sjdw on sj.ks=sjdw.dwid
 			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid
 			left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
 			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.xh ='1' and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			left join igams_yyxx yyxx on yyxx.dwid =sj.sjdw
		<where>
 			sj.scbj = '0' and sj.ybbh = #{ybbh}
  		</where>
	</select>
	<!-- 送检结果分析列表 -->
	<select id="getAnalysisList" parameterType="SjxxDto" resultType="SjxxDto">
        select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.qtks,sjxx.fkrq,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,
        sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,sjxx.bz,sjxx.kdh,sjxx.kdfy,sjxx.kdlx,sjxx.fkje,sjxx.fkbj,sjxx.nbbm,
        sjxx.jyjg,sjxx.lrry,to_char(sjxx.lrsj,'yyyy-MM-dd') lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女' when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.lcfk,sjxx.sfzq,
		case when yblx.cskz1 ='1' then COALESCE(sjxx.yblxmc,yblx.csmc) else yblx.csmc end AS yblxmc,COALESCE(sjxx.jcxmmc, jcxmlx.csmc) jcxmmc,sjxx.sjdwmc
			from igams_sjxx sjxx
			left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
            left outer join matridx_jcsj yblx on sjxx.yblx = yblx.csid
            left join igams_sjhbxx sjhb on sjhb.hbmc = sjxx.db and sjhb.scbj = '0'
            left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.xh = '1' and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			<where>
				sjxx.scbj = '0'
				and sjxx.bgrq is not null
				and (
					1=2
				<if test="ysdh != null and ysdh != ''">
					or sjxx.ysdh = #{ysdh}
				</if>
				<if test="lrrys !=null and lrrys.size>0">
		 	  	  	or sjxx.lrry in
		 	  	  		<foreach collection="lrrys" open="(" close=")" separator="," item="item">
		 	  	  			 #{item}
		 	  	  		</foreach>
		 	  	</if>)
				<if test="cxnr !=null and cxnr != ''">
		            and (
			            sjxx.ybbh like '%'||#{cxnr}||'%' or
			            sjxx.ysdh like '%'||#{cxnr}||'%' or
						sjxx.hzxm like '%'||#{cxnr}||'%' or
						yblx.csmc like '%'||#{cxnr}||'%' or
						to_char(sjxx.jsrq,'yyyy-MM-dd') like '%'||#{cxnr}||'%' or
						sjxx.nl like '%'||#{cxnr}||'%' or
						sjxx.xb like '%'||#{cxnr}||'%' or
						sjxx.sjdw like '%'||#{cxnr}||'%' or
						sjxx.db like '%'||#{cxnr}||'%' or
						sjxx.yblxmc like '%'||#{cxnr}||'%' or
						sjxx.zyh like '%'||#{cxnr}||'%' or
						sjxx.nbbm like '%'||#{cxnr}||'%' or
						to_char(sjxx.bgrq,'yyyy-MM-dd') like '%'||#{cxnr}||'%' or
						sjxx.lcfk like '%'||#{cxnr}||'%' or
						jcxmlx.csmc like '%'||#{cxnr}||'%'
		            )
	            </if>
			</where>
			order by sjxx.bgrq DESC 
			limit cast(#{count} as numeric) offset cast(#{start} as numeric)
	</select>
	<!-- 根据送检ID获取送检信息 -->
	<select id="getListByWbbm" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.wbbm,jcxmlx.cskz1 jclx,jcxmlx.cskz3,sjxx.nbbm
			from igams_sjxx sjxx
			left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			<where>
				sjxx.scbj = '0'
				<if test="wbbm != null and wbbm != ''">
					and sjxx.wbbm = #{wbbm}
				</if>
				<if test="dbs !=null and dbs.size>0">
		 	  	  	and sjxx.db in
		 	  	  		<foreach collection="dbs" open="(" close=")" separator="," item="item">
		 	  	  			 #{item}
		 	  	  		</foreach>
		 	  	</if>
		 	  	<if test="dbs ==null or dbs.size==0">
		 	  		and 1=2
		 	  	</if>
			</where>
			order by sjxx.lrsj limit 50
	</select>
	<!-- 根据送检ID获取送检信息 -->
	<select id="getDtosByWbbm" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.wbbm,sjxx.lrry,sjxx.ybbh
		from igams_sjxx sjxx
		<where>
			sjxx.scbj = '0'
			<if test="wbbm != null and wbbm != ''">
				and sjxx.wbbm = #{wbbm}
			</if>
			<if test="ybbh != null and ybbh != ''">
				and sjxx.ybbh != #{wbbm}
			</if>
			<if test="sjid != null and sjid != ''">
				and sjxx.sjid != #{sjid}
			</if>
		</where>
	</select>
	<!-- 获取报告模板 -->
	<select id="getBgmb" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT fjcf.fwjlj,fjcf.fwjm
	    FROM igams_sjxx sjxx
	      LEFT JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc and hb.scbj = '0'
	      LEFT JOIN matridx_fjcfb fjcf ON fjcf.ywid= hb.bgmb
	    WHERE sjxx.scbj = '0'
	    	and ywlx=#{ywlx}
	    <if test="ybbh != null and ybbh != ''">
	    	and ybbh=#{ybbh}
	    </if>
	    <if test="sjid != null and sjid!= ''">
	    	and sjid=#{sjid}
	    </if>
	</select>
	<!-- 根据送检ID获取送检信息 -->
	<select id="getListByLastWbbm" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.wbbm,jcxmlx.cskz1 jclx,jcxmlx.cskz3
			from igams_sjxx sjxx
			left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			<where>
				sjxx.scbj = '0'
				<if test="lastwbbm != null and lastwbbm != ''">
					and to_char(sjxx.lrsj, 'yyyy-mm-dd') &gt; to_char(
						COALESCE((select lrsj from igams_sjxx where wbbm = #{lastwbbm} limit 1), LOCALTIMESTAMP)
						,'yyyy-mm-dd hh24:mi:ss')
				</if>
				<if test="dbs !=null and dbs.size>0">
		 	  	  	and sjxx.db in
		 	  	  		<foreach collection="dbs" open="(" close=")" separator="," item="item">
		 	  	  			 #{item}
		 	  	  		</foreach>
		 	  	</if>
		 	  	<if test="dbs ==null or dbs.size==0">
		 	  		and 1=2
		 	  	</if>
			</where>
			order by sjxx.lrsj limit 50
	</select>
	
	<!-- 根据类型和业务ID查询下载报告 -->	
	<select id="selectDownloadReportBySjxxDtos" parameterType="list" resultType="SjxxDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid
			from igams_sjxx sj
			left outer join matridx_fjcfb fjcfb on sj.sjid = fjcfb.ywid
		<where>
			sj.scbj = '0' and fjcfb.fjid is not null
			and 
			<foreach collection="list" open="(" close=")" separator="or" item="item">
				(sj.sjid = #{item.sjid} and fjcfb.ywlx = #{item.ywlx}
		 	  	  	and sj.db in
	 	  	  		<foreach collection="item.dbs" open="(" close=")" separator="," item="itemt">
	 	  	  			 #{itemt}
	 	  	  		</foreach>
				)
			</foreach>
		</where> 
	</select>
	
	<!-- 查询送检信息 -->
	<select id="getSJxxForSend" parameterType="String" resultType="SjxxDto"> 
		select  sjxx.sjdw ,sjxx.hzxm,case when jc_yb.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc_yb.csmc) else jc_yb.csmc end AS yblx from igams_sjxx sjxx
		left join  igams_sjdwxx sjdw  on sjxx.ks=sjdw.dwid
		left join  matridx_jcsj jc_yb on jc_yb.csid=sjxx.yblx
		<where>
			sjxx.scbj = '0'
			and sjxx.ybbh=#{ybbh}
		</where>
	</select>
	
	<select id="getWjljBySjid" parameterType="String" resultType="Map">
		SELECT sjxx.sjid, fjcf.wjlj, sjxx.hzxm
			, CASE 
				WHEN sjxx.xb = '1' THEN '男'
				WHEN sjxx.xb = '2' THEN '女'
				WHEN sjxx.xb = '3' THEN '未知'
			END AS xbmc, sjxx.nl || sjxx.nldw AS nl, sjdw.dwmc AS ksmc
			, sjxx.sjys
			, case when jc_yb.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc_yb.csmc) else jc_yb.csmc end AS yblxmc
		    , (select array_to_string(ARRAY(SELECT unnest(array_agg(jc_ybzt.csmc))), ',') from igams_sjybzt sjybzt
	      		left outer join matridx_jcsj jc_ybzt on sjybzt.zt = jc_ybzt.csid where sjxx.sjid = sjybzt.sjid ) as ybzt, sjxx.ybbh
			, to_char(sjxx.cyrq, 'yyyy-MM-dd') AS cyrq
			, to_char(sjxx.jsrq, 'yyyy-MM-dd') AS fjsrq
			, to_char(sjxx.bgrq, 'yyyy-MM-dd') AS bgrq, jc_xm.csmc AS jcxm
			, CASE WHEN yyxx.cskz1='1' THEN sjxx.sjdwmc ELSE yyxx.dwjc END sjdw,sjxx.cwh,sjxx.bz
		FROM igams_sjxx sjxx
			LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
			LEFT JOIN matridx_jcsj jc_xm
			ON jcxm.jcxmid = jc_xm.csid
				AND jc_xm.jclb = 'DETECT_TYPE'
			LEFT JOIN matridx_fjcfb fjcf
			ON fjcf.ywid = jc_xm.csid
				AND fjcf.ywlx = 'IMP_REPORT_SELF_TEMEPLATE'
			LEFT JOIN igams_sjdwxx sjdw ON sjxx.ks = sjdw.dwid
			LEFT JOIN matridx_jcsj jc_yb ON jc_yb.csid = sjxx.yblx
			LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sjxx.sjdw
		<where>
			sjxx.sjid=#{sjid}
		</where>
	</select>
	
	<select id="getSjxxcssByJcdw" parameterType="SjxxDto" resultType="Map">
	select  CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end, jcdw.jcdwmc, jcdw.jcdw
		from
		(select 0 as num,csid as jcdw,csmc as jcdwmc from matridx_jcsj where jclb='DETECTION_UNIT') jcdw
		left join 
		(select COUNT(sjxx.sjid) AS num,jc_jcdw.csmc jcdwmc,sjxx.jcdw
			from igams_sjxx sjxx
			 	LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			 	LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			 	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			 	left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			 	where  sjxx.scbj = '0' and (sjxx.dsyrq IS NOT NULL
				OR sjxx.syrq IS NOT NULL OR sjxx.qtsyrq IS NOT NULL
				OR (sjxx.jsrq IS NOT NULL
					AND sfjs = '0'))
			 	and sjxx.jcdw is not null 
			 	AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		 	<if test="jsrqstart != null and jsrqstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq when sjxx.syrq is not null then sjxx.syrq else sjxx.qtsyrq end end,'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
			</if>
		 group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1) tmp on tmp.jcdw=jcdw.jcdw
		 group by jcdw.jcdwmc, jcdw.jcdw
	</select>
	<select id="getSjxxcssByJcdwAndJsrq" parameterType="SjxxDto" resultType="Map">
		select  CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end, jcdw.jcdwmc, jcdw.jcdw
		from
		(select 0 as num,csid as jcdw,csmc as jcdwmc from matridx_jcsj where jclb='DETECTION_UNIT') jcdw
		left join
		(select COUNT(sjxx.sjid) AS num,jc_jcdw.csmc jcdwmc,sjxx.jcdw
		from igams_sjxx sjxx
		LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
		LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  sjxx.scbj = '0' and sjxx.jsrq IS NOT NULL
		AND sfjs = '0'
		and sjxx.jcdw is not null
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="jsrqstart != null and jsrqstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
		</if>
		group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1) tmp on tmp.jcdw=jcdw.jcdw
		group by jcdw.jcdwmc, jcdw.jcdw
	</select>
	
	<!-- 统计日报：按检测单位进行总览统计 -->
	<select id="getSjxxcssByDayAndJcdw" parameterType="SjxxDto" resultType="Map">
		select CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end,jcdw, jcdwmc
		from
		(select 
			CASE WHEN to_char(dsyrq, 'yyyy-MM-dd') = #{jsrq} and to_char(syrq, 'yyyy-MM-dd') = #{jsrq} THEN  COUNT(sjxx.sjid) * 2 
			when to_char(dsyrq, 'yyyy-MM-dd') = #{jsrq} or to_char(syrq,'yyyy-MM-dd') = #{jsrq} or to_char(qtsyrq,'yyyy-MM-dd') = #{jsrq} THEN COUNT(sjxx.sjid) end as num,
			jc_jcdw.csmc jcdwmc,sjxx.jcdw
			from igams_sjxx sjxx
			 	LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			 	LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			 	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			 	where  sjxx.scbj = '0' and sjxx.sfjs ='1' and
			 	sjxx.jcdw is not null and 
			 	(to_char(dsyrq, 'yyyy-MM-dd') = #{jsrq} or to_char(syrq, 'yyyy-MM-dd') = #{jsrq} or to_char(qtsyrq, 'yyyy-MM-dd') = #{jsrq})
		 group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1,dsyrq,syrq,qtsyrq) tmp
		 group by jcdw,jcdwmc
		 order by SUM(tmp.num) desc
	</select>
	<!-- 统计日报：按检测单位进行总览统计(接收日期) -->
	<select id="getSjxxcssByDayAndJcdwAndJsrq" parameterType="SjxxDto" resultType="Map">
		select CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end,jcdw, jcdwmc
		from
		(select
			CASE WHEN to_char(dsyrq, 'yyyy-MM-dd') = #{jsrq} and to_char(syrq, 'yyyy-MM-dd') = #{jsrq} THEN  COUNT(sjxx.sjid) * 2
			when to_char(dsyrq, 'yyyy-MM-dd') = #{jsrq} or to_char(syrq,'yyyy-MM-dd') = #{jsrq} or to_char(qtsyrq,'yyyy-MM-dd') = #{jsrq} THEN COUNT(sjxx.sjid) end as num,
			jc_jcdw.csmc jcdwmc,sjxx.jcdw
			from igams_sjxx sjxx
			 	LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			 	LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			 	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			 	where  sjxx.scbj = '0' and sjxx.sfjs ='1' and
			 	sjxx.jcdw is not null and
			 	to_char(jsrq, 'yyyy-MM-dd') = #{jsrq}
		 group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1,dsyrq,syrq,qtsyrq) tmp
		 group by jcdw,jcdwmc
		 order by SUM(tmp.num) desc
	</select>
	
	<!-- 统计日报：按检测单位进行总览统计 -->
	<select id="getSjxxcssBySomeTimeAndJcdw" parameterType="SjxxDto" resultType="Map">
		select CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end,jcdw, jcdwmc
		from
		(select 
			CASE WHEN to_char(dsyrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(dsyrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
			 and to_char(syrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(syrq, 'yyyy-MM-dd') &lt;= #{jsrqend} THEN  COUNT(sjxx.sjid) * 2 
			when to_char(dsyrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(dsyrq, 'yyyy-MM-dd') &lt;= #{jsrqend} THEN COUNT(sjxx.sjid) 
			when to_char(syrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(syrq, 'yyyy-MM-dd') &lt;= #{jsrqend} THEN COUNT(sjxx.sjid) 
			when to_char(qtsyrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(qtsyrq, 'yyyy-MM-dd') &lt;= #{jsrqend} THEN COUNT(sjxx.sjid) 
			end as num,
			jc_jcdw.csmc jcdwmc,sjxx.jcdw
			from igams_sjxx sjxx
			 	LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			 	LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			 	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			 	where  sjxx.scbj = '0' and sjxx.sfjs ='1' and
			 	sjxx.jcdw is not null and 
			 	(( to_char(dsyrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(dsyrq, 'yyyy-MM-dd') &lt;= #{jsrqend}) or 
			 (to_char(syrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(syrq, 'yyyy-MM-dd') &lt;= #{jsrqend} ) or 
			 (to_char(qtsyrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(qtsyrq, 'yyyy-MM-dd') &lt;= #{jsrqend} )) 
		 group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1,dsyrq,syrq,qtsyrq) tmp
		 group by jcdw,jcdwmc
		 order by SUM(tmp.num) desc
	</select>
	<!-- 统计日报：按检测单位进行总览统计(接收日期) -->
	<select id="getSjxxcssBySomeTimeAndJcdwAndJsrq" parameterType="SjxxDto" resultType="Map">
		select CASE when SUM(tmp.num) is null then 0 else SUM(tmp.num) end,jcdw, jcdwmc
		from
		(select
			case when to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend} then COUNT(sjxx.sjid) end as num,
			jc_jcdw.csmc jcdwmc,sjxx.jcdw
			from igams_sjxx sjxx
			 	LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
			 	LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
			 	left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
			 	where  sjxx.scbj = '0' and sjxx.sfjs ='1' and
			 	sjxx.jcdw is not null and
			 	( to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend})
		 group by jc_jcdw.csmc,sjxx.jcdw,jc_xm.cskz1,jsrq) tmp
		 group by jcdw,jcdwmc
		 order by SUM(tmp.num) desc
	</select>
	
	<!--统计日报： 查询接收后但未实验的标本信息列表 -->
	<select id="getNotSyList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.yblx,sjxx.db,to_char(sjxx.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq ,jc_jcxm.csmc jcxmmc,jc_yblx.csmc yblxmc
		,sjxx.lrsj,sjxx.hzxm,sjxx.nbbm,jc_jcxm.cskz1 jcxmkzcs,jc_jcdw.cskz2 jcdwjc
		from igams_sjxx sjxx
		left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid=jcxm.jcxmid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		where sjxx.jsrq is not null and sjxx.sfjs ='1' and ((sjxx.dsyrq is  null and sjxx.syrq is null and sjxx.qtsyrq is null) or to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq),'yyyy-MM-dd')!=#{jsrq})
		and to_char(sjxx.jsrq,'yyyy-mm-dd')=#{jsrq} and sjxx.scbj ='0'
		order by sjxx.jsrq asc
	</select>
	<!--统计日报： 查询接收后但未实验的标本信息列表(接收日期) -->
	<select id="getNotSyListByJsrq" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.yblx,sjxx.db,to_char(sjxx.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq ,jc_jcxm.csmc jcxmmc,jc_yblx.csmc yblxmc
		,sjxx.lrsj,sjxx.hzxm,sjxx.nbbm,jc_jcxm.cskz1 jcxmkzcs,jc_jcdw.cskz2 jcdwjc
		from igams_sjxx sjxx
		left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid=jcxm.jcxmid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		where sjxx.jsrq is not null and sjxx.sfjs ='1'
		and to_char(sjxx.jsrq,'yyyy-mm-dd')=#{jsrq} and sjxx.scbj ='0'
		order by sjxx.jsrq asc
	</select>
	
	<!-- 首页统计:统计当天实验的数据量(根据检测单位区分) -->
	<select id="getSjlStatisticsByJcdw" parameterType="SjxxDto" resultType="Map">
		select jcdw,sum(sj) sj,sum(sj)*9 sjl,jcdwmc  from ( 
		select jcdw,jcdwmc,case when yblx ='B' then case when jcxm = 'C' then 3 when jcxm ='D' then 2 else 1 end when jcxm = 'C' then 2 else 1 end  sj
		from (
		select sjxx.jcdw,jc_jcdw.csmc jcdwmc,left(substring(sjxx.nbbm,POSITION('-' in sjxx.nbbm)+3),1) jcxm,right(substring(sjxx.nbbm,POSITION('-' in sjxx.nbbm)+3),1) yblx from igams_sjxx sjxx
			left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		where to_char(coalesce(dsyrq,syrq,qtsyrq), 'yyyy-MM-dd') = #{jsrq} and sfjs ='1' and sjxx.scbj ='0'
		  ) tmp
		) tt
		group by jcdw,jcdwmc
		order by sjl desc 
	</select>
	
	<!-- 根据条件查询下载报告 -->	
	<select id="selectDownloadReportSjhb" parameterType="Map" resultType="SjxxDto">
		select fjcfb.ywlx,fjcfb.wjm,fjcfb.wjlj,fjcfb.fjid,sj.sjid
			from igams_sjxx sj
			left join igams_sjdwxx i_d  on sj.ks=i_d.dwid
			left join matridx_jcsj jcsj on sj.yblx=jcsj.csid 
			left join igams_sjhbxx hbxx on sj.db= hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
			left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid 
			left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.scbj='0'
			left join matridx_jcsj jcxmlx on jcxmlx.csid= jcxm.jcxmid
			left join igams_hbsfbz sfbz on hbxx.hbid=sfbz.hbid and jcxm.jcxmid=sfbz.xm and case when jcxm.jczxmid is not null and jcxm.jczxmid != '' and sfbz.zxm is not null and sfbz.zxm != '' then  jcxm.jczxmid = sfbz.zxm else 1=1 end
			left outer join matridx_fjcfb fjcfb on sj.sjid = fjcfb.ywid and ( 1=2
			<if test="bglxbj !=null and  bglxbj =='pdf'">
				or fjcfb.ywlx in
				<foreach collection="pdfywlxs" item="item" separator="," open="(" close=")">
					#{item}
				</foreach>
			</if>
			<if test="bglxbj !=null and  bglxbj =='word'">
				or fjcfb.ywlx in
				<foreach collection="wordywlxs" item="item" separator="," open="(" close=")">
					#{item}
				</foreach>
			</if>)
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<include refid="SelectWhere"></include>
			and sj.scbj = '0' and fjcfb.fjid is not null
			<if test="dbs !=null and dbs.size>0">
				and sj.db in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			<if test="jcdwxz != null and jcdwxz.size()>0">
                and sj.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
		</where> 
	</select>
	<!--  查询有word报告的送检信息 -->
	<select id="selectWordInfo"  parameterType="SjxxDto"  resultType="SjxxDto" >
		select  sjxx.sjid,jcxmlx.cskz3,jcxmlx.cskz1,hbjcsj.cskz1 gzlxmc,fjcfb.fwjm,fjcfb.fwjlj,fjcfb.fjid,fjcfb.wjlj
 		from igams_sjxx sjxx
 		left outer join igams_sjjcxm jcxm on jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
 		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj jcxmlx on jcxmlx.csid = jcxm.jcxmid
		left outer join matridx_fjcfb fjcfb on sjxx.sjid = fjcfb.ywid and fjcfb.ywlx = jcxmlx.cskz3 || '_' || jcxmlx.cskz1 || '_WORD' and fjcfb.scbj != '1'
		<where>
 			sjxx.scbj = '0' and fjcfb.fjid is not null
 			and(1=2
				<if test="ids != null and ids.size()>0">
					or sjxx.sjid in 
					<foreach collection="ids" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>)
  		</where>
	</select>  
	<!--  查询未发送报告的送检信息 -->
	<select id="querySjxx" parameterType="SjxxDto" resultType="SjxxDto">
		select * from (
		select sj.sjid,sj.bgrq,sj.ybbh,sj.hzxm,sj.nbbm,'' as lxdm,'新检' as lxmc,sj.lrsj,
		case when sjyz.zt='80' then '审核通过' when sjyz.zt is null then '/' else spgw.gwmc || '审核中' end shxx_dqgwmc
		from igams_sjxx sj
		left join
		igams_sjhbxx hb
		on hb.hbmc = sj.db and hb.scbj != '1'
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		<if test="jclx != null and jclx != ''">
			left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx=#{jclx}
		</if>
		left join (
		select
		DISTINCT wksjmx.ybbh
		from
		igams_wksjmx wksjmx
		left join
		igams_wksjgl wksjgl
		on wksjmx.wksjid = wksjgl.wksjid
		and wksjgl.scbj='0'
		where
		wksjmx.ybbh is not null and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&gt;=#{lrsjStart}and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&lt;=#{lrsjEnd})	tab
		on tab.ybbh=sj.ybbh
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		left join igams_sjyz sjyz on sjyz.sjid=sj.sjid and sjyz.scbj='0'
		and sjyz.zt not in  ('15','00') and sjyz.lrsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp + INTERVAL '18 hours')
		left join matridx_shgc shgc on shgc.ywid=sjyz.yzid
		left join matridx_spgw spgw on spgw.gwid=shgc.shgwid
		<where>
			sj.scbj = '0'
			and sj.sfjs='1'
			<if test="dbs !=null and dbs.size>0">
				and sj.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			and tab.ybbh is not null
			and ((to_char(sj.syrq,'yyyy-mm-dd hh24')&gt;=#{syrqstart} and to_char(sj.syrq,'yyyy-mm-dd hh24')&lt;=#{syrqend} )
				or (to_char(sj.dsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.dsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend})
				or (to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend}))
			and (
			<if test="jclx!=null and jclx!=''">
				sjbgsm.bgrq is null
			</if>
			<if test="jclx==null or jclx==''">
				sj.bgrq is null
			</if>
			or sj.sfsc is null or sj.sfsc !='1') and sj.nbbm not like 'MDX%' and sj.nbbm not like 'X___-%'
			and not exists (select 1 from igams_fjsq sq where sj.sjid = sq.sjid 
			and sq.scbj='0' and sq.bgbj ='1' and (sq.zt='10' or sq.zt='80')
			)
			and qf.csdm not in('VERIFICATION','ENV_MONITOR','PERFORMANCE_QUALIFICATION')
			<if test="jcxmids !=null and jcxmids.size > 0">
				and jcxm.jcxmid in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
		</where>
		union all
		select sj.sjid,sj.bgrq,sj.ybbh,sj.hzxm,sj.nbbm,jc.csdm as lxdm,jc.csmc as lxmc,fj.lrsj,case
		when sjyz.zt = '80' then '审核通过'
		when sjyz.zt is null then '/'
		else spgw.gwmc || '审核中'
		end shxx_dqgwmc
		from igams_fjsq fj
		left join igams_sjxx sj on fj.sjid=sj.sjid
		left join matridx_jcsj jc on jc.csid = fj.lx
		left join igams_sjhbxx hb on hb.hbmc = sj.db and hb.scbj != '1'
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		<if test="jclx != null and jclx != ''">
			left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx=#{jclx}
		</if>
		left join igams_sjyz sjyz on
		sjyz.sjid = fj.sjid
		and sjyz.scbj = '0'
		and sjyz.zt not in ('15', '00')
		and sjyz.lrsj >=((CURRENT_DATE - interval '1 day')::timestamp + interval '18 hours')
		and to_char(sjyz.lrsj,'yyyy-mm-dd') >=to_char(fj.lrsj,'yyyy-mm-dd')
		left join matridx_shgc shgc on
		shgc.ywid = sjyz.yzid
		left join matridx_spgw spgw on
		spgw.gwid = shgc.shgwid
		left join (
		select
		DISTINCT wksjmx.ybbh
		from
		igams_wksjmx wksjmx
		left join igams_wksjgl wksjgl on wksjmx.wksjid = wksjgl.wksjid and wksjgl.scbj='0'
		where
		wksjmx.ybbh is not null and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&gt;=#{lrsjStart}and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&lt;=#{lrsjEnd})	tab	on tab.ybbh=sj.ybbh
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		<where>
			fj.scbj!='1' and hb.hbid is not null
			<if test="dbs !=null and dbs.size>0">
				and sj.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			and tab.ybbh is not null
			and ((to_char(fj.rsyrq,'yyyy-mm-dd hh24')&gt;=#{syrqstart} and to_char(fj.rsyrq,'yyyy-mm-dd hh24')&lt;=#{syrqend} )
				or (to_char(fj.dsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(fj.dsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend})
				or (to_char(fj.qtsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(fj.qtsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend}))
			and fj.zt ='80' and fj.bgbj = '1'
			<if test="jclx!=null and jclx!=''">
				and (to_char(sjbgsm.bgrq,'YYYY-MM-DD') != #{bgrq} or sjbgsm.bgrq is null)
			</if>
			<if test="jclx==null or jclx==''">
				and (to_char(sj.bgrq,'YYYY-MM-DD') != #{bgrq} or sj.bgrq is null)
			</if>

			and not exists (select 1 from igams_fjsq sq where sj.sjid = sq.sjid
			and sq.scbj='0' and sq.bgbj ='1' and (sq.zt='10' or sq.zt='80') and to_char(sq.lrsj,'yyyy-mm-dd') = #{bgrq})
			and qf.csdm not in('VERIFICATION','ENV_MONITOR','PERFORMANCE_QUALIFICATION')
			<if test="jcxmids !=null and jcxmids.size > 0">
				and jcxm.jcxmid in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
		</where>
		) tmp
		order by lrsj desc limit 5
	</select>
	
	<!--  查询未报告的送检总数 -->
	<select id="querysjxxnum" parameterType="SjxxDto" resultType="java.lang.Integer">
		select count(sjid) from 
		(
		select sj.sjid
		from igams_sjxx sj
		<if test="jcxm != null and jcxm != ''">
			left outer join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.jcxmid!=#{jcxm} and jcxm.scbj='0'
		</if>
		left join
		igams_sjhbxx hb
		on hb.hbmc = sj.db and hb.scbj != '1'
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
        <if test="jclx != null and jclx != ''">
            left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx =#{jclx}
        </if>
		left join (
		select
		DISTINCT wksjmx.ybbh
		from
		igams_wksjmx wksjmx
		left join
		igams_wksjgl wksjgl
		on wksjmx.wksjid = wksjgl.wksjid
		and wksjgl.scbj='0'
		where
		wksjmx.ybbh is not null and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&gt;=#{lrsjStart}and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&lt;=#{lrsjEnd})	tab	on tab.ybbh=sj.ybbh
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		<where>
			sj.scbj = '0'
			<if test="jcxm != null and jcxm != ''">
				AND jcxm.jcxmid is not null
			</if>
			and sj.sfjs='1' 
			<if test="dbs !=null and dbs.size>0">
				and sj.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			 and tab.ybbh is not null
			and ((to_char(sj.syrq,'yyyy-mm-dd hh24')&gt;=#{syrqstart} and to_char(sj.syrq,'yyyy-mm-dd hh24')&lt;=#{syrqend} )
				or (to_char(sj.dsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.dsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend})
				or (to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(sj.qtsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend}))
			and (
			<if test="jclx != null and jclx != ''">
				sjbgsm.bgrq is null
			</if>
			<if test="jclx == null or jclx == ''">
				sj.bgrq is null
			</if>
			or sj.sfsc is null
			or sj.sfsc !='1') and sj.nbbm not like 'MDX%' and sj.nbbm not like 'X___-%'
			and not exists (select 1 from igams_fjsq sq where sj.sjid = sq.sjid 
			and sq.scbj='0' and sq.bgbj ='1' and (sq.zt='10' or sq.zt='80'))
			and qf.csdm not in('VERIFICATION','ENV_MONITOR','PERFORMANCE_QUALIFICATION')
			<if test="jcxmids !=null and jcxmids.size > 0">
				and jcxm.jcxmid in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
			</where>
			union all
		select sj.sjid
		from igams_fjsq fj
		left join igams_sjxx sj on fj.sjid=sj.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		<if test="jclx != null and jclx != ''">
			left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx =#{jclx}
		</if>
		left join
		igams_sjhbxx hb
		on hb.hbmc = sj.db and hb.scbj != '1'
		left join (
		select
		DISTINCT wksjmx.ybbh
		from
		igams_wksjmx wksjmx
		left join
		igams_wksjgl wksjgl
		on wksjmx.wksjid = wksjgl.wksjid
		and wksjgl.scbj='0'
		where
		wksjmx.ybbh is not null and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&gt;=#{lrsjStart}and to_char(wksjgl.sjsj,'yyyy-MM-dd hh24')&lt;=#{lrsjEnd})	tab	on tab.ybbh=sj.ybbh
		left join  matridx_jcsj qf on qf.csid=sj.sjqf
		<where>
			fj.scbj!='1' and hb.hbid is not null 
			<if test="dbs !=null and dbs.size>0">
				and sj.db not in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
			 and tab.ybbh is not null
			and ((to_char(fj.rsyrq,'yyyy-mm-dd hh24')&gt;=#{syrqstart} and to_char(fj.rsyrq,'yyyy-mm-dd hh24')&lt;=#{syrqend} )
				or (to_char(fj.dsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(fj.dsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend})
				or (to_char(fj.qtsyrq,'yyyy-MM-dd hh24')&gt;=#{syrqstart} and to_char(fj.qtsyrq,'yyyy-MM-dd hh24')&lt;=#{syrqend}))
			and fj.zt ='80' and fj.bgbj = '1'
			<if test="jclx != null and jclx != ''">
				and (to_char(sjbgsm.bgrq,'YYYY-MM-DD') != #{bgrq} or sjbgsm.bgrq is null)
			</if>
			<if test="jclx == null or jclx == ''">
				and (to_char(sj.bgrq,'YYYY-MM-DD') != #{bgrq} or sj.bgrq is null)
			</if>
			and not exists (select 1 from igams_fjsq sq where sj.sjid = sq.sjid
			and sq.scbj='0' and sq.bgbj ='1' and (sq.zt='10' or sq.zt='80') and to_char(sq.lrsj,'yyyy-mm-dd') = #{bgrq})
			<if test="jcxm != null and jcxm != ''">
				and fj.jcxm!=#{jcxm}
			</if>
			and qf.csdm not in('VERIFICATION','ENV_MONITOR')
			<if test="jcxmids !=null and jcxmids.size > 0">
				and fj.jcxm in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
		</where>
		) tmp
	</select>
	
	<!--  查询有word未发送报告的送检总数 -->
	<select id="queryWordNum" parameterType="SjxxDto" resultType="java.lang.Integer">
		 select count(sj.sjid)
		    from igams_sjxx sj
			<if test="jcxmids != null and jcxmids != ''">
				left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
			</if>
			left join matridx_fjcfb fj on fj.ywid=sj.sjid and fj.ywlx in
		  <foreach collection="fjlxs" item="item" open="(" close=")" separator="," index="index">
			#{item}
		  </foreach>
			and fj.lrsj &lt; NOW() - INTERVAL '5 minutes'
			left join matridx_fjcfb fj1 on fj1.ywid=sj.sjid and fj1.ywlx in
			<foreach collection="fjlxs1" item="item" open="(" close=")" separator="," index="index">
				#{item}
			</foreach>
			and fj1.ywlx=replace(fj.ywlx,'_WORD','')

		    <where>
		      sj.scbj = '0'
		      and sj.sfsc is null
              and to_char(sj.bgrq,'YYYY-MM-DD') = #{bgrq}
              and sj.sfjs='1'
			  and fj1.fjid is NULL
			<if test="jcxmids !=null and jcxmids.size > 0">
				and jcxm.jcxmid in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
		    </where>
    </select>
    
    <!--  查询有word未发送报告的送检信息 -->
    <select id="queryWord" parameterType="SjxxDto" resultType="SjxxDto">
		 select distinct sj.sjid,sj.bgrq,sj.ybbh,sj.hzxm,sj.nbbm,jc.csdm as lxdm,
		case when sjyz.zt='80' then '审核通过' when sjyz.zt is null then '/' else spgw.gwmc || '审核中' end shxx_dqgwmc
		    from igams_sjxx sj
		    left join matridx_fjcfb fj on fj.ywid=sj.sjid
			left join igams_fjsq fjsq on fjsq.sjid=sj.sjid
			left join matridx_jcsj jc on jc.csid = fjsq.lx and fj.ywlx in 
		<foreach collection="fjlxs" item="item" open="(" close=")" separator="," index="index">
      		#{item}
      	</foreach>
			left join igams_sjyz sjyz on sjyz.sjid=sj.sjid and sjyz.scbj='0'
			and sjyz.zt not in  ('15','00') and sjyz.lrsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp + INTERVAL '18 hours')
			left join matridx_shgc shgc on shgc.ywid=sjyz.yzid
			left join matridx_spgw spgw on spgw.gwid=shgc.shgwid
			left join matridx_fjcfb fj1 on fj1.ywid=sj.sjid and fj1.ywlx in
			<foreach collection="fjlxs1" item="item" open="(" close=")" separator="," index="index">
				#{item}
			</foreach>
			and fj1.ywlx=replace(fj.ywlx,'_WORD','')
		<where>
	      sj.scbj = '0'
	      and sj.sfsc is null
             and to_char(sj.bgrq,'YYYY-MM-DD') = #{bgrq}
             and sj.sfjs='1'
			and fj1.fjid is NULL
          limit 5
	    </where>
    </select>

	<select id="queryFjAndYzBefore" parameterType="SjxxDto" resultType="SjxxDto">
		select * from (
		select sj.ybbh,sj.nbbm,'复测' lxmc,to_char(shgc.sqsj,'yyyy-mm-dd hh24:mi:ss') shxx_sqsj,spgw.gwmc||'审核中' shxx_dqgwmc from igams_fjsq fj
		left join igams_sjxx sj on sj.sjid=fj.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =fj.fjid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and fj.zt in ('10') and shgc.sqsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp) and shgc.sqsj &lt; (CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and fj.jcxm in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		union all
		select sj.ybbh,sj.nbbm,'验证' lxmc,to_char(shgc.sqsj,'yyyy-mm-dd hh24:mi:ss') shxx_sqsj,spgw.gwmc||'审核中' shxx_dqgwmc from igams_sjyz yz
		left join igams_sjxx sj on sj.sjid=yz.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =yz.yzid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and yz.zt in ('10') and shgc.sqsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp) and shgc.sqsj&lt;(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and jcxm.jcxmid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		)tmp order by tmp.shxx_sqsj limit 10
	</select>

	<select id="queryFjAndYzBeforeNum" parameterType="SjxxDto" resultType="java.lang.Integer">
		select count(sjid) from (
		select sj.sjid from igams_fjsq fj
		left join igams_sjxx sj on sj.sjid=fj.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		<if test="jclx != null and jclx != ''">
			left join igams_sjbgsm sjbgsm on sjbgsm.sjid=sj.sjid and sjbgsm.jclx =#{jclx}
		</if>

		left join matridx_shgc shgc on shgc.ywid =fj.fjid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and fj.zt in ('10') and shgc.sqsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp) and shgc.sqsj&lt;(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and fj.jcxm in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		union all
		select sj.sjid from igams_sjyz yz
		left join igams_sjxx sj on sj.sjid=yz.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =yz.yzid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and yz.zt in ('10') and shgc.sqsj>=((CURRENT_DATE - INTERVAL '1 day')::timestamp) and shgc.sqsj&lt;(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and jcxm.jcxmid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		)tmp
	</select>

	<select id="queryFjAndYzAfter" parameterType="SjxxDto" resultType="SjxxDto">
		select * from (
		select sj.ybbh,sj.nbbm,'复测' lxmc,to_char(shgc.sqsj,'yyyy-mm-dd hh24:mi:ss') shxx_sqsj,spgw.gwmc||'审核中' shxx_dqgwmc from igams_fjsq fj
		left join igams_sjxx sj on sj.sjid=fj.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =fj.fjid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and fj.zt in ('10') and  shgc.sqsj>(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and fj.jcxm in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		union all
		select sj.ybbh,sj.nbbm,'验证' lxmc,to_char(shgc.sqsj,'yyyy-mm-dd hh24:mi:ss') shxx_sqsj,spgw.gwmc||'审核中' shxx_dqgwmc from igams_sjyz yz
		left join igams_sjxx sj on sj.sjid=yz.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =yz.yzid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and yz.zt in ('10') and shgc.sqsj>(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and jcxm.jcxmid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		)tmp order by tmp.shxx_sqsj limit 10
	</select>

	<select id="queryFjAndYzAfterNum" parameterType="SjxxDto" resultType="java.lang.Integer">
		select count(sjid) from (
		select sj.sjid from igams_fjsq fj
		left join igams_sjxx sj on sj.sjid=fj.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =fj.fjid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and fj.zt in ('10') and shgc.sqsj>(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and fj.jcxm in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		union all
		select sj.sjid from igams_sjyz yz
		left join igams_sjxx sj on sj.sjid=yz.sjid
		<if test="jcxmids != null and jcxmids != ''">
			left join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		</if>
		left join matridx_shgc shgc on shgc.ywid =yz.yzid
		left join matridx_spgw spgw on spgw.gwid =shgc.shgwid
		where sj.scbj = '0' and sj.sfjs='1' and yz.zt in ('10') and shgc.sqsj>(CURRENT_DATE ::timestamp + INTERVAL '6 hours')
		<if test="dbs !=null and dbs.size>0">
			and sj.db not in
			<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
				#{item}
			</foreach>
		</if>
		<if test="jcxmids !=null and jcxmids.size > 0">
			and jcxm.jcxmid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		)tmp
	</select>





	
	
	<!-- 获取接收日期不为空，报告未发送的记录               显示实验列表信息  -->
	<select id="getAccptNotUpload" parameterType="SjxxDto" resultType="SjxxDto">
		select sjid,ybbh,nbbm,hzxm,jcsj_yblx.csmc yblxmc,jsrq,dsyrq,syrq,qtsyrq,bgrq,djcbj,jcbj,jc_xm.csmc jcxmmc,jc_xm.cskz1 jcxmkzcs, sjdwxx.dwmc AS ksmc,jcsj_jcdw.csmc AS jcdwmc,jcdw,flg_qf, qf,sj.zt,sj.jcxmid,sj.bz
		from (
		select sj.sjid,sj.ybbh,sj.nbbm,sj.hzxm,sj.jsrq,sj.dsyrq,sj.syrq syrq,sj.qtsyrq qtsyrq,sj.bgrq,sj.kyxm,sj.db,sj.sftj,sj.jyjg,sj.fkbj,sj.sfsf,sj.cskz1,sj.sfjs,sj.sfsc,sj.cskz2,sj.cskz3,sj.cskz4,sj.sfzq,sj.kdlx,sj.sjqf,sj.qyrq,sj.ydrq,sj.fkrq,
		sj.djcbj, sj.jcbj jcbj,sj.jcdw,yblx,ks, '0' AS flg_qf, '正常送检' AS qf,sj.zt,jcxm.jcxmid,sj.bz
		from igams_sjxx sj
		left outer join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
		<where>
		sj.sfjs ='1' and sj.scbj ='0'
		and to_char(sj.lrsj,'YYYY-MM-DD') >= to_char(now() - interval '2 week' ,'YYYY-MM-DD')
		<if test="zt != null and zt !='' and zt =='0'.toString">
			and to_char(sj.jsrq,'YYYY-MM-DD') &gt;= #{jsrq} AND sj.qysj is null and GREATEST(sj.dsyrq,sj.syrq,sj.qtsyrq) is null
		</if>
		<if test="zt != null and zt !='' and zt =='1'.toString">
			and to_char(sj.qysj,'YYYY-MM-DD') &gt;= #{jsrq}
			and not EXISTS (
			SELECT 1 FROM igams_tqmx tqmx WHERE tqmx.scbj = '0' AND to_char( tqmx.lrsj, 'YYYY-MM-dd' ) &gt;= #{jsrq} AND tqmx.sjid IS NOT NULL AND sj.sjid = tqmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='2'.toString">
			and EXISTS (
			SELECT 1 FROM igams_tqmx tqmx WHERE tqmx.scbj = '0' AND to_char( tqmx.lrsj, 'YYYY-MM-dd' ) &gt;= #{jsrq} AND tqmx.sjid IS NOT NULL AND sj.sjid = tqmx.sjid
			)
			and not EXISTS (
			SELECT 1 FROM igams_wkmx wkmx WHERE wkmx.scbj = '0' AND to_char( wkmx.lrsj, 'YYYY-MM-dd' ) &gt;= #{jsrq} AND wkmx.sjid IS NOT NULL AND sj.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='3'.toString">
			-- 已建库未上机
			and EXISTS (
			SELECT 1 FROM igams_wkmx wkmx WHERE wkmx.scbj = '0' AND to_char( wkmx.lrsj, 'YYYY-MM-dd' ) &gt;= #{jsrq} AND wkmx.sjid IS NOT NULL AND sj.sjid = wkmx.sjid)
			and not EXISTS (
			select 1 from igams_wksjgl wksj
			left join igams_wkmx wkmx ON wksj.wkid = wkmx.wkid and wkmx.scbj = '0'
			where wksj.scbj = '0' and to_char(wksj.lrsj,'YYYY-MM-dd') &gt;= #{jsrq} and sjid is not null AND sj.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='4'.toString">
			-- 已polling未上机
		</if>
		<if test="zt != null and zt !='' and zt =='5'.toString">
			and sj.bgrq is null
			and EXISTS (
			select 1 from igams_wksjgl wksj
			left join igams_wkmx wkmx ON wksj.wkid = wkmx.wkid and wkmx.scbj = '0'
			where wksj.scbj = '0' and to_char(wksj.lrsj,'YYYY-MM-dd') &gt;= #{jsrq} and sjid is not null AND sj.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='6'.toString">
			and to_char( sj.bgrq, 'yyyy-MM-dd' ) = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' )
		</if>
		<if test="zt != null and zt !='' and zt =='7'.toString">
			and sj.jcsj is null
			and EXISTS (
			SELECT 1 FROM igams_tqmx tqmx WHERE tqmx.scbj = '0' AND to_char( tqmx.lrsj, 'YYYY-MM-dd' ) &gt;= #{jsrq} AND tqmx.sjid IS NOT NULL AND sj.sjid = tqmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='8'.toString">
			and sj.bgrq is null
			and to_char(sj.jcsj,'YYYY-MM-DD') &gt;= #{jsrq}
		</if>
		</where>
		union all
		select fjsq.fjid AS sjid,sjxx.ybbh,sjxx.nbbm,sjxx.hzxm,sjxx.jsrq,fjsq.dsyrq,fjsq.rsyrq syrq,fjsq.qtsyrq qtsyrq,sjxx.bgrq,sjxx.kyxm,sjxx.db,sjxx.sftj,sjxx.jyjg,sjxx.fkbj,sjxx.sfsf,sjxx.cskz1,sjxx.sfjs,sjxx.sfsc,sjxx.cskz2,sjxx.cskz3,sjxx.cskz4,sjxx.sfzq,sjxx.kdlx,sjxx.sjqf,sjxx.qyrq,sjxx.ydrq,sjxx.fkrq,
		fjsq.djcbj, fjsq.rjcbj jcbj,fjsq.jcdw,yblx,ks, '1' AS flg_qf, jcsj_qf.csmc AS qf,fjsq.zt,fjsq.jcxm jcxmid,fjsq.bz
		from igams_fjsq fjsq
		left outer join igams_sjxx sjxx on fjsq.sjid = sjxx.sjid and sjxx.scbj ='0'
		LEFT JOIN matridx_jcsj jcsj_qf ON jcsj_qf.csid = fjsq.lx
		<where>
		fjsq.scbj ='0' and sjxx.sjid is not null
		and to_char(fjsq.lrsj,'YYYY-MM-DD') &gt;= to_char(now() - interval '2 week' ,'YYYY-MM-DD')
		<if test="zt != null and zt !='' and zt =='0'.toString">
			and to_char(fjsq.lrsj,'YYYY-MM-DD') &gt;= #{jsrq} AND fjsq.qysj is null and GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq) is null
		</if>
		<if test="zt != null and zt !='' and zt =='1'.toString">
			and to_char(fjsq.qysj,'YYYY-MM-DD') &gt;= #{jsrq}
			and not EXISTS (
			select 1 from igams_tqmx tqmx
			left join igams_tqgl tqgl on tqgl.tqid = tqmx.tqid
			where tqmx.scbj = '0' and  to_char(tqgl.tqrq,'YYYY-MM-dd') = to_char(GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq),'YYYY-MM-dd') and  to_char(tqgl.tqrq,'YYYY-MM-dd')  &gt;= #{jsrq} and tqmx.sjid is not null AND sjxx.sjid = tqmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='2'.toString">
			and EXISTS (
			select 1 from igams_tqmx tqmx
			left join igams_tqgl tqgl on tqgl.tqid = tqmx.tqid
			where tqmx.scbj = '0' and  to_char(tqgl.tqrq,'YYYY-MM-dd') = to_char(GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq),'YYYY-MM-dd') and  to_char(tqgl.tqrq,'YYYY-MM-dd')  &gt;= #{jsrq} and tqmx.sjid is not null AND sjxx.sjid = tqmx.sjid
			)
			and not EXISTS (
			select 1 from igams_wkmx wkmx
			left join igams_wkgl wkgl on wkgl.wkid = wkmx.wkid
			where  wkmx.scbj = '0' and  to_char(wkgl.wkrq,'YYYY-MM-dd') = to_char(GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq),'YYYY-MM-dd') and  to_char(wkgl.wkrq,'YYYY-MM-dd')  &gt;= #{jsrq} and wkmx.sjid is not null AND sjxx.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='3'.toString">
			-- 已建库未上机
			and EXISTS (
			select 1 from igams_wkmx wkmx
			left join igams_wkgl wkgl on wkgl.wkid = wkmx.wkid
			where  wkmx.scbj = '0' and  to_char(wkgl.wkrq,'YYYY-MM-dd') = to_char(GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq),'YYYY-MM-dd') and  to_char(wkgl.wkrq,'YYYY-MM-dd')  &gt;= #{jsrq} and wkmx.sjid is not null AND sjxx.sjid = wkmx.sjid
			)
			and not EXISTS (
			select 1 from igams_wksjgl wksj
			left join igams_wkmx wkmx ON wksj.wkid = wkmx.wkid and wkmx.scbj = '0'
			where wksj.scbj = '0' and wksj.lrsj &gt;= GREATEST(fjsq.rsyrq,fjsq.dsyrq,fjsq.qtsyrq) and to_char( wksj.lrsj,'YYYY-MM-dd')  &gt;= #{jsrq} and sjid is not null AND sjxx.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='4'.toString">
			-- 已polling未上机
		</if>
		<if test="zt != null and zt !='' and zt =='5'.toString">
			and fjsq.bgbj = '1'
			and( sjxx.bgrq is null or bgrq &lt;= GREATEST(fjsq.rsyrq,fjsq.dsyrq,fjsq.qtsyrq))
			and EXISTS (
			select 1 from igams_wksjgl wksj
			left join igams_wkmx wkmx ON wksj.wkid = wkmx.wkid and wkmx.scbj = '0'
			where wksj.scbj = '0' and wksj.lrsj &gt;= GREATEST(fjsq.rsyrq,fjsq.dsyrq,fjsq.qtsyrq) and to_char( wksj.lrsj,'YYYY-MM-dd')  &gt;= #{jsrq} and sjid is not null AND sjxx.sjid = wkmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='6'.toString">
			and to_char( sjxx.bgrq, 'yyyy-MM-dd' ) = to_char( LOCALTIMESTAMP, 'yyyy-MM-dd' ) and bgrq &gt;= GREATEST(fjsq.rsyrq,fjsq.dsyrq,fjsq.qtsyrq)
		</if>
		<if test="zt != null and zt !='' and zt =='7'.toString">
			and fjsq.jcsj is null
			and EXISTS (
			select 1 from igams_tqmx tqmx
			left join igams_tqgl tqgl on tqgl.tqid = tqmx.tqid
			where tqmx.scbj = '0' and  to_char(tqgl.tqrq,'YYYY-MM-dd') = to_char(GREATEST(fjsq.dsyrq,fjsq.rsyrq,fjsq.qtsyrq),'YYYY-MM-dd') and  to_char(tqgl.tqrq,'YYYY-MM-dd')  &gt;= #{jsrq} and sjid is not null AND sjxx.sjid = tqmx.sjid
			)
		</if>
		<if test="zt != null and zt !='' and zt =='8'.toString">
			and fjsq.bgbj = '1'
			and to_char(fjsq.jcsj,'YYYY-MM-DD') &gt;= #{jsrq}
			and (sjxx.bgrq is null or bgrq &lt;= GREATEST(fjsq.rsyrq,fjsq.dsyrq,fjsq.qtsyrq))
		</if>
		</where>
		) sj
		LEFT OUTER JOIN matridx_jcsj jc_xm ON sj.jcxmid = jc_xm.csid
		LEFT JOIN matridx_jcsj jcsj_yblx ON jcsj_yblx.csid = yblx
		LEFT JOIN igams_sjdwxx sjdwxx ON ks = sjdwxx.dwid
		LEFT JOIN matridx_jcsj jcsj_jcdw ON jcdw = jcsj_jcdw.csid
		left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<if test="jcxmids !=null and jcxmids.size > 0">
				and sj.jcxmid in
				<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
			</if>
			<if test="jcdwxz!=null and jcdwxz.size()>0">
				and jcdw in
				<foreach collection="jcdwxz" open="(" close=")" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="ybbh != null and ybbh !=''">
				and ybbh ILIKE '%'||#{ybbh}||'%'
			</if>
			<if test="hzxm != null and hzxm != ''">
				and hzxm ILIKE '%'||#{hzxm}||'%'
			</if>
			<if test=" nbbm != null and nbbm != ''">
				and nbbm ILIKE '%'||#{nbbm}||'%'
			</if>
		<if test = "dwids != null and dwids.length > 0 "  >
			and sj.ks in
			<foreach collection="dwids" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "yblxs != null and yblxs.length > 0 "  >
			and sj.yblx in
			<foreach collection="yblxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "kylxs != null and kylxs.length > 0 ">
			and jc_kyxm.cskz1 in
			<foreach collection="kylxs" separator="," open="(" close=") " item="item" index="index">
				<if test = "item == '其它' ">
					null,''
				</if>
				<if test = "item != '其它' ">
					#{item}
				</if>
			</foreach>
		</if>
		<if test = "kyxms != null and kyxms.length > 0 "  >
			and sj.kyxm in
			<foreach collection="kyxms" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjhbfls != null and sjhbfls.length > 0"  >
			and hbxx.fl in
			<foreach collection="sjhbfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
			and hbxx.zfl in
			<foreach collection="sjhbzfls" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="sftj!=null and sftj!=''">
			and sj.sftj=#{sftj}
		</if>
		<if test = "jyjgs != null and jyjgs.length > 0 "  >
			and sj.jyjg in
			<foreach collection="jyjgs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<!-- 查询是合作关系的合作伙伴 -->
		<if test="dbm =='0'.toString()">
			and hbxx.hbmc is not null
		</if>
		<!-- 查询是不是合作关系的合作伙伴 -->
		<if test="dbm =='1'.toString()">
			and hbxx.hbmc is  null
		</if>
		<if test="fkbj!=null and fkbj!=''">
			and sj.fkbj=#{fkbj}
		</if>
		<if test = "sfsfs != null and sfsfs.length > 0 "  >
			and sj.sfsf in
			<foreach collection="sfsfs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="sfsc!=null and sfsc!=''">
			and sj.sfsc=#{sfsc}
		</if>
		<if test="sfjs!=null and sfjs!=''">
			and sj.sfjs=#{sfjs}
		</if>
		<if test = "sjkzcs2 != null and sjkzcs2.length > 0 "  >
			and sj.cskz2 in
			<foreach collection="sjkzcs2" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs3 != null and sjkzcs3.length > 0 "  >
			and sj.cskz3 in
			<foreach collection="sjkzcs3" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "sjkzcs4 != null and sjkzcs4.length > 0 "  >
			and sj.cskz4 in
			<foreach collection="sjkzcs4" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="sfzq=='0'.toString() or sfzq =='1'.toString()">
			and sj.sfzq=#{sfzq}
		</if>
		<if test="sfzq=='3'.toString()">
			and sj.sfzq is null
		</if>
		<if test = "jcdws != null and jcdws.length > 0 "  >
			and sj.jcdw in
			<foreach collection="jcdws" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "kdlxs != null and kdlxs.length > 0 "  >
			and sj.kdlx in
			<foreach collection="kdlxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "gzlxs != null and gzlxs.length > 0 "  >
			and hbxx.gzlx in
			<foreach collection="gzlxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="sjqfs != null and sjqfs.length>0">
			and sj.sjqf in
			<foreach collection="sjqfs" separator="," open="(" close=") " item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="qyrqstart != null and qyrqstart != ''">
			and to_char(sj.qyrq,'yyyy-mm-dd hh24:mi:ss') &gt;= #{qyrqstart}
		</if>
		<if test="qyrqend != null and qyrqend != ''">
			and to_char(sj.qyrq,'yyyy-mm-dd hh24:mi:ss') &lt;= #{qyrqend}
		</if>
		<if test="ydrqstart != null and ydrqstart != ''">
			and to_char(sj.ydrq,'yyyy-mm-dd hh24:mi:ss') &gt;= #{ydrqstart}
		</if>
		<if test="ydrqend != null and ydrqend != ''">
			and to_char(sj.ydrq,'yyyy-mm-dd hh24:mi:ss') &lt;= #{ydrqend}
		</if>
		<if test="bgrqstart != null and bgrqstart != ''">
			and to_char(sj.bgrq,'yyyy-mm-dd') &gt;= #{bgrqstart}
		</if>
		<if test="bgrqend != null and bgrqend != ''">
			and to_char(sj.bgrq,'yyyy-mm-dd') &lt;= #{bgrqend}
		</if>
		<if test="fkrqstart != null and fkrqstart != ''">
			and to_char(sj.fkrq,'yyyy-mm-dd') &gt;= #{fkrqstart}
		</if>
		<if test="fkrqend != null and fkrqend != ''">
			and to_char(sj.fkrq,'yyyy-mm-dd') &lt;= #{fkrqend}
		</if>
		</where>
		<choose>
			<when test="sortName != null and sortName != '' and sortOrder != null and sortOrder != '' ">
				ORDER BY ${sortName} ${sortOrder}, dsyrq desc, syrq desc, qtsyrq desc, nbbm asc
			</when>
			<otherwise>
				ORDER BY dsyrq desc, syrq desc, qtsyrq desc, nbbm asc
			</otherwise>
		</choose>
	</select>
	

	<select id="getAccptList" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.ybbh,sj.nbbm,sj.hzxm,
			case when fjsq.fjid is not null AND jcsj_jcxmf.cskz1 = 'F' then fjsq.fjid else sj.sjid end sjid,
			case when fjsq.fjid is not null AND jcsj_jcxmf.cskz1 = 'F' then '1' else '0' end flg_qf,
			case when fjsq.fjid is not null AND jcsj_jcxmf.cskz1 = 'F' then fjsq.lrsj else sj.lrsj end lrsj,
			case when fjsq.fjid is not null AND jcsj_jcxmf.cskz1 = 'F' then jcsj_qf.csmc else '正常送检' end qf,
			case when fjsq.fjid is not null AND jcsj_jcxmf.cskz1 = 'F' then fjsq.jcxm else jcxm.jcxmid end jcxmid
			from igams_sjxx  sj
			left join igams_fjsq fjsq on sj.sjid = fjsq.sjid  and fjsq.scbj = '0'
			left outer join igams_sjjcxm jcxm on sj.sjid = jcxm.sjid and jcxm.scbj='0'
			left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
			LEFT JOIN matridx_jcsj jcsj_qf ON jcsj_qf.csid = fjsq.lx
			LEFT JOIN matridx_jcsj jcsj_jcxmf ON fjsq.jcxm = jcsj_jcxmf.csid
		where sj.scbj = '0'  and sj.sfjs ='1'
		<if test="nbbm != null and nbbm != ''">
			and sj.nbbm = #{nbbm}
		</if>
		and  ((to_char(sj.jsrq,'YYYY-MM-DD') &gt;= to_char(now() - interval '1 week' ,'YYYY-MM-DD') and jc_xm.cskz1 = 'F') or (to_char(fjsq.lrsj,'YYYY-MM-DD') &gt;= to_char(now() - interval '1 week' ,'YYYY-MM-DD') and jcsj_jcxmf.cskz1 = 'F'))
		<if test="nr != null and nr != '' and nr == '0'.toString">
			and (fjsq.zt = '10' or sj.bgrq is null)
		</if>
		order by lrsj desc,flg_qf
	</select>
	
	<!-- 获取接收日期不为空，报告未发送的记录               从送检表中查询单条信息  -->
     <select id="getOneFromSJ" parameterType="SjxxDto" resultType="SjxxDto"> 
		select sj.sjid,sj.ybbh,sj.nbbm,sj.hzxm,sj.nl || sj.nldw AS nl,jcsj_yblx.csmc as yblxmc,sj.jsrq,COALESCE(sj.jcxmmc,jcsj.csmc||(case when jcsj_zxm.csmc is not null then '-'||jcsj_zxm.csmc else '' end)) as jcxmmc,sj.dsyrq,sj.yblx,
		       sj.syrq,sj.qtsyrq,sj.bgrq,sj.djcbj,sj.jcbj,
			   case when sj.djcbj ='1' then '是'  when sj.djcbj='0' then '否'  end djcbjmc,
			   case when sj.jcbj ='1' then '是'  when sj.jcbj='0' then '否'  end jcbjmc,
			   sjdwxx.dwmc as ksmc,
			   jcsj_jcdw.csmc as jcdwmc,
			   '0' flg_qf,
			          '正常送检' qf,
			   sj.sfsc,sj.jcdw,hb.hbid
        from igams_sjxx sj
		left join igams_sjjcxm jcxm on jcxm.sjid = sj.sjid and jcxm.xh = '1' and jcxm.scbj='0'
		left join matridx_jcsj jcsj on jcsj.csid = jcxm.jcxmid
		 left join matridx_jcsj jcsj_zxm on jcsj_zxm.csid = jcxm.jczxmid
        left join matridx_jcsj jcsj_yblx on jcsj_yblx.csid  = sj.yblx
		left join igams_sjdwxx sjdwxx on sj.ks = sjdwxx.dwid
		left join matridx_jcsj jcsj_jcdw on sj.jcdw = jcsj_jcdw.csid
	    left outer join igams_sjhbxx hb on sj.db = hb.hbmc
		 <where>
		    sj.scbj = '0' and sj.sjid=#{sjid}
		</where>
	</select> 
	
	<!-- 获取接收日期不为空，报告未发送的记录               从复检表中查询单条信息  -->
    <select id="getOneFromFJ" parameterType="SjxxDto" resultType="SjxxDto"> 
		select fjsq.fjid sjid,sjxx.ybbh,sjxx.nbbm,sjxx.hzxm,sjxx.nl || sjxx.nldw AS nl,jcsj_yblxf.csmc as yblxmc,sjxx.jsrq,
		       case when jcsj_jcxzmf.csmc is not null then jcsj_jcxmf.csmc||'-'||jcsj_jcxzmf.csmc else jcsj_jcxmf.csmc end jcxmmc,sjxx.yblx,
		       sjxx.dsyrq,sjxx.syrq,sjxx.qtsyrq,sjxx.bgrq,sjxx.djcbj,sjxx.jcbj,
			   case when sjxx.djcbj ='1' then '是' when sjxx.djcbj='0' then '否' end djcbjmc,
			   case when sjxx.jcbj ='1' then '是' when sjxx.jcbj='0' then '否' end jcbjmc,
			   sjdwxxf.dwmc as ksmc,
			   jcsj_jcdw.csmc as jcdwmc,
			   '1' flg_qf,
			   jcsj_qf.csmc qf,
			   sjxx.sfsc,fjsq.jcdw,fjsq.lrry,hb.hbid
		from igams_fjsq fjsq 
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj jcsj_yblxf on jcsj_yblxf.csid = sjxx.yblx
		left join matridx_jcsj jcsj_jcxmf on fjsq.jcxm = jcsj_jcxmf.csid
		left join matridx_jcsj jcsj_jcxzmf on fjsq.jczxm = jcsj_jcxzmf.csid
		left join igams_sjdwxx sjdwxxf on sjxx.ks = sjdwxxf.dwid
		left join matridx_jcsj jcsj_qf on jcsj_qf.csid  = fjsq.lx
		left join matridx_jcsj jcsj_jcdw on fjsq.jcdw = jcsj_jcdw.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc
		<where>
		       sjxx.scbj = '0' and fjsq.fjid=#{sjid}
		</where>
	</select>
	
	 <!-- 从送检表中找出检查项目的类别数量 -->
	<select id="jcxmFromSJ" parameterType="SjxxDto" resultType="SjxxDto">
	     select distinct jc.cskz1 from igams_sjxx sj 
			left join igams_sjjcxm jcxm on sj.sjid=jcxm.sjid  and jcxm.scbj='0'
			left join matridx_jcsj jc on jc.csid=jcxm.jcxmid 
			<where>
			    sj.scbj = '0'
			    and sj.sjid in 
			    <foreach collection="ids" item="item" open="(" close=")" separator=",">
			        #{item}
			    </foreach>
			</where>
	</select>
	
	
	<!-- 从复检表中找出检查项目的类别数量 -->
	<select id="jcxmFromFJ" parameterType="SjxxDto" resultType="SjxxDto">
		 SELECT DISTINCT jc.cskz1
			FROM igams_fjsq fj
				LEFT JOIN matridx_jcsj jc ON jc.csid = fj.jcxm
			<where>
				fj.scbj!='1'
				and fj.fjid in 
				<foreach collection="ids" item="item" open="(" close=")" separator=",">
					#{item}
				</foreach>
			</where>
	</select>
	
	<!-- 根据ids(实际上传入的是fjids)查询送检信息 -->
	<select id="selectSjxxByFjids" parameterType="SjxxDto" resultType="SjxxDto">
		  SELECT case when fjsq.rjcbj is null then '0' else fjsq.rjcbj end jcbj, 
		  case when fjsq.djcbj is null then '0' else fjsq.djcbj end djcbj, 
		  case when fjsq.qtjcbj is null then '0' else fjsq.qtjcbj end qtjcbj, 
		  fjsq.rsyrq as syrq, fjsq.dsyrq as dsyrq, fjsq.qtsyrq as qtsyrq
            FROM igams_fjsq fjsq
			<where>
			   fjsq.scbj!='1'
			   and fjsq.fjid in
			   <foreach collection="ids" open="(" close=")" separator="," item="item">
			      #{item}
			   </foreach>
			</where>
	</select>
	
	<!-- 修改检测标记（复检表） -->
	<update id="updateJcbjByFjid" parameterType="SjxxDto">		
		update igams_fjsq 
		set xgry=#{xgry},
		xgsj=LOCALTIMESTAMP,
		rsyrq=cast(#{syrq} as TIMESTAMP),
		dsyrq=cast(#{dsyrq} as TIMESTAMP),
		qtsyrq=cast(#{qtsyrq} as TIMESTAMP)	 
		<if test="jcbj !=null and  jcbj !=''">
			,rjcbj=#{jcbj}
		</if>
		<if test="djcbj !=null and  djcbj !=''">
			,djcbj=#{djcbj}
		</if>
		<if test="qtjcbj !=null and  qtjcbj !=''">
			,qtjcbj=#{qtjcbj}
		</if> 
		<where>
			<if test="ids!=null and ids.size>0">
				and igams_fjsq.fjid in
				<foreach collection="ids"  open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
		</where>
	</update>
	
	<!-- 同步更新送检支付信息 -->
	<update id="modInspPayinfo" parameterType="SjxxDto">
		update igams_sjxx
		<set>
			<if test="sfje != null and  sfje != ''">
				sfje=cast(#{sfje} as numeric),
			</if>
			<if test="sfje == null or sfje == ''">
				sfje=null,
			</if>
			<if test="fkrq != null and  fkrq != ''">
				fkrq=cast(#{fkrq} as TIMESTAMP),
			</if>
			<if test="fkrq == null or fkrq == ''">
				fkrq=null,
			</if>
			fkbj=#{fkbj},
			ddh=#{ddh},
			xgsj = LOCALTIMESTAMP
		</set>
		<where>
			sjid = #{sjid}
		</where>
	</update>
	
	<!--  查询有word报告的送检信息 -->
	<select id="selectReportInfo"  parameterType="Map" resultType="SjxxDto">
		select sjxx.sjid, sjxx.ybbh
 		from igams_sjxx sjxx
 		left outer join matridx_jkdymx jkdymx on sjxx.ybbh = jkdymx.ywid and jkdymx.dyzfl='INVOKING_CHILD_REPORT'
 		<where>
 			sjxx.scbj = '0'
 			and(1=2
				<if test="ids != null and ids.size()>0">
					or sjxx.sjid in 
					<foreach collection="ids" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>)
			<if test="jclxs != null and jclxs.size()>0">
				and jkdymx.zywid in
				<foreach collection="jclxs" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test="jczlxs != null and jczlxs.size()>0">
				and jkdymx.zxmid in
				<foreach collection="jczlxs" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
			and jkdymx.dyid is not null
			group by sjxx.sjid, sjxx.ybbh	
  		</where>
	</select>  
	
	<!--  根据岗位名称查询用户 -->
	<select id="queryYhByGwmc"  parameterType="UserDto" resultType="UserDto">
		select xtyh.yhid,xtyh.zsxm,xtyh.yhm,xtyh.gwmc
		from matridx_xtyh xtyh
		<where>
			xtyh.sfsd ='0'
			<if test="gwmc != null and gwmc != ''">
				and xtyh.gwmc like '%'||#{gwmc}||'%'
			</if>
		</where>
	</select>

	<!--  根据角色名称查询用户 -->
	<select id="queryYhByJsmc"  parameterType="UserDto" resultType="UserDto">
		select xtyh.yhid,xtyh.zsxm,xtyh.yhm,xtyh.gwmc,xtjs.jsmc,xtjs.jsid
		from matridx_xtyh xtyh
		left join matridx_yhjs yhjs on yhjs.yhid = xtyh.yhid
		left join matridx_xtjs xtjs on xtjs.jsid = yhjs.jsid
		<where>
			xtyh.sfsd ='0'
			<if test="jsmc != null and jsmc != ''">
				and xtjs.jsmc like '%'||#{jsmc}||'%'
			</if>
		</where>
	</select>
	
	<!-- 清空检测子项目 -->
	<update id="emptySubDetect" parameterType="SjxxDto">
		update igams_sjxx set
			jczxmid = null,
			xgsj = LOCALTIMESTAMP,
			xgry = #{xgry}
		where 
			sjid = #{sjid}
	</update>
	
	<!-- 查询快递单号不为null的数据(kdh进行了去重处理) -->
	<select id="getKdhIsNotNullList"  parameterType="SjxxDto" resultType="java.lang.String">
	   select sj.kdh from igams_sjxx sj
	   <where>
	      sj.kdh is not null AND sj.kdh != '--' AND sj.kdh != '-' AND sj.kdh != '无' AND length(sj.kdh) = 15 
	      AND sj.scbj ='0'
	      AND (sj.kdbj is null )
	      AND to_char(sj.lrsj,'yyyy-mm-dd') &gt;= #{lrsj}
	   </where>
	</select>
	
	<!-- 查询快递单号不为null的数据(kdh不去重)（优化，只查询特定快递号的） -->
	<select id="getSjidAndKdhList"  parameterType="SjxxDto" resultType="SjxxDto">
	   select sj.sjid, sj.kdh from igams_sjxx sj
	   <where>
	      <if test="kdhs != null and kdhs !='' ">
	         sj.kdh in
	         <foreach collection="kdhs" item="item" index="index" open="(" close=")" separator=",">
	             #{item}
	         </foreach>
	         and
	      </if>
	      sj.kdh is not null AND sj.kdh != '--' AND sj.kdh != '-' AND sj.kdh != '无' AND length(sj.kdh) = 15 
	      AND sj.scbj ='0'
	      AND (sj.kdbj is null)
	      AND to_char(sj.lrsj,'yyyy-mm-dd') &gt;= #{lrsj}
	   </where>
	</select>
	
	<!-- 快递已签收的更新送检表的顺丰标记updateSfbj(List<String> kdhEndSet) -->
	<update id="updateSfbj">
	    update igams_sjxx set kdbj='1' 
	    <where>
	        kdh in
	    	<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
	           #{item} 
	        </foreach>
	    </where>
	</update>
	
	<!-- 快递信息无法查找到的，更新送检表顺丰标记为2 updateUnfindSfbj -->
	<update id="updateUnfindSfbj">
	    update igams_sjxx set kdbj='2' 
	    <where>
	        kdh in
	    	<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
	           #{item} 
	        </foreach>
	    </where>
	</update>
	
	<!-- 查询合作伙伴 -->
	<select id="getAllSjhb" parameterType="SjxxDto" resultType="SjxxDto">
		select db,sum(bjss) bjss,sum(bsfs) bsfs,sum(sfs) sfs, (sum(bjss)+sum(bsfs) +sum(sfs)) as zs from
			(
			select sjxx.db, coalesce(case when sjxx.sfjs ='0' then count(sjxx.sfjs) end,0) bjss,
			coalesce(case when sjxx.sfjs ='1' and sjxx.sfsf ='0' then count(sjxx.sfsf) end,0) bsfs,
			coalesce(case when sjxx.sfjs ='1' and sjxx.sfsf ='1' then count(sjxx.sfsf) end,0) sfs
			from igams_sjxx sjxx left outer join  igams_sjhbxx sjhbxx on sjxx.db = sjhbxx.hbmc
			where to_char( sjxx.jsrq, 'yyyy-MM-dd' ) = #{jsrq}
					group by sjxx.db,sjxx.sfsf,sjxx.sfjs
			) tmp
			group by db  order by zs
	</select>

	<!-- 送检单位转义 -->
	<select id="escapeSjdw" parameterType="SjxxDto" resultType="String">
		select dwid from igams_yyxx where (dwmc=#{sjdwmc} or dwjc=#{sjdwmc} or dwqtmc=#{sjdwmc}) and scbj='0'
	</select>

	<!-- 科室转义 -->
	<select id="escapeKs" parameterType="SjxxDto" resultType="String">
		select dwid from igams_sjdwxx where dwmc=#{ks} and scbj='0'
	</select>

	<!--查询当日标本编号和复检原因-->
	<select id="getYbbhAndYyToday" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT
			sjxx.ybbh,fjsq.yy
		FROM
			igams_fjsq fjsq
				LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid AND sjxx.scbj = '0'
		WHERE to_char( fjsq.lrsj, 'yyyy-MM-dd' ) = to_char( now( ), 'yyyy-MM-dd' );
	</select>

	<!-- 科室 其它 -->
	<select id="getQt"  resultType="String">
		select dwid from igams_sjdwxx where dwmc='其他' and scbj='0'
	</select>
	<!-- 送检单位 其它 -->
	<select id="getYyxxQt"  resultType="String">
		select dwid from igams_yyxx where dwmc='第三方' and scbj='0'
	</select>
    <!-- sjxx表导入 -->
	<insert id="insertSjxx" parameterType="SjxxDto">
		insert into igams_sjxx(sjid
		<if test="hzxm != null and hzxm != ''">
			,hzxm
		</if>
		<if test="xb != null and xb != ''">
			,xb
		</if>
		<if test="nl != null and nl != ''">
			,nl
		</if>
		<if test="nldw != null and nldw != ''">
			,nldw
		</if>
		<if test="dh != null and dh != ''">
			,dh
		</if>
		<if test="sjdw != null and sjdw != ''">
			,sjdw
		</if>
		<if test="sjdwmc != null and sjdwmc != ''">
			,sjdwmc
		</if>
		<if test="ks != null and ks != ''">
			,ks
		</if>
		<if test="qtks != null and qtks != ''">
			,qtks
		</if>
		<if test="sjys != null and sjys != ''">
			,sjys
		</if>
		<if test="ysdh != null and ysdh != ''">
			,ysdh
		</if>
		<if test="db != null and db != ''">
			,db
		</if>
		<if test="jcdw != null and jcdw != ''">
			,jcdw
		</if>
		<if test="yblx != null and yblx != ''">
			,yblx
		</if>
		<if test="yblxmc != null and yblxmc != ''">
			,yblxmc
		</if>
		<if test="ybtj != null and ybtj != ''">
			,ybtj
		</if>
		<if test="zyh != null and zyh != ''">
			,zyh
		</if>
		<if test="cwh != null and cwh != ''">
			,cwh
		</if>
		<if test="sfjs != null and sfjs != ''">
			,sfjs
		</if>
		<if test="sftj != null and sftj != ''">
			,sftj
		</if>
		<if test="sfsf != null and sfsf != ''">
			,sfsf
		</if>
		<if test="nbbm != null and nbbm != ''">
			,nbbm
		</if>
		<if test="ybbh != null and ybbh != ''">
			,ybbh
		</if>
		<if test="wbbm != null and wbbm != ''">
			,wbbm
		</if>
		<if test="cyrq != null and cyrq != ''">
			,cyrq
		</if>
		<if test="jsrq != null and jsrq != ''">
			,jsrq
		</if>
		<if test="jsry != null and jsry != ''">
			,jsry
		</if>
		<if test="syrq != null and syrq != ''">
			,syrq
		</if>
		<if test="dsyrq != null and dsyrq != ''">
			,dsyrq
		</if>
		<if test="qtsyrq != null and qtsyrq != ''">
			,qtsyrq
		</if>
		<if test="jt != null and jt != ''">
			,jt
		</if>
		<if test="bgrq != null and bgrq != ''">
			,bgrq
		</if>
		<if test="lczz != null and lczz != ''">
			,lczz
		</if>
		<if test="qqzd != null and qqzd != ''">
			,qqzd
		</if>
		<if test="jqyy != null and jqyy != ''">
			,jqyy
		</if>
		<if test="qqjc != null and qqjc != ''">
			,qqjc
		</if>
		<if test="jyjg != null and jyjg != ''">
			,jyjg
		</if>
		<if test="sfsc != null and sfsc != ''">
			,sfsc
		</if>
		<if test="kdlx != null and kdlx != ''">
			,kdlx
		</if>
		<if test="kdh != null and kdh != ''">
			,kdh
		</if>
		<if test="qyrq != null and qyrq != ''">
			,qyrq
		</if>
		<if test="ydrq != null and ydrq != ''">
			,ydrq
		</if>
		<if test="yjydrq != null and yjydrq != ''">
			,yjydrq
		</if>
		<if test="jcbj != null and jcbj != ''">
			,jcbj
		</if>
		<if test="djcbj != null and djcbj != ''">
			,djcbj
		</if>
		<if test="qtjcbj != null and qtjcbj != ''">
			,qtjcbj
		</if>
		<if test="fkbj != null and fkbj != ''">
			,fkbj
		</if>
		<if test="fkje != null and fkje != ''">
			,fkje
		</if>
		<if test="sfje != null and sfje != ''">
			,sfje
		</if>
		<if test="fkrq != null and fkrq != ''">
			,fkrq
		</if>
		<if test="ddh != null and ddh != ''">
			,ddh
		</if>
		<if test="zt != null and zt != ''">
			,zt
		</if>
		<if test="sfzmjc != null and sfzmjc != ''">
			,sfzmjc
		</if>
		<if test="zmxm != null and zmxm != ''">
			,zmxm
		</if>
		<if test="zmmdd != null and zmmdd != ''">
			,zmmdd
		</if>
		<if test="sjqf != null and sjqf != ''">
			,sjqf
		</if>
		<if test="kpsq != null and kpsq != ''">
			,kpsq
		</if>
		<if test="bz != null and bz != ''">
			,bz
		</if>
		<if test="lcfk != null and lcfk != ''">
			,lcfk
		</if>
		<if test="yxbfk != null and yxbfk != ''">
			,yxbfk
		</if>
		<if test="q20 != null and q20 != ''">
			,q20
		</if>
		<if test="q30 != null and q30 != ''">
			,q30
		</if>
		<if test="lrry != null and lrry != ''">
			,lrry
		</if>
			,lrsj
			,scbj
		<if test="kdfy != null and kdfy != ''">
			,kdfy
		</if>
		<if test="jcxmmc != null and jcxmmc != ''">
			,jcxmmc
		</if>
		)values(#{sjid}
		<if test="hzxm != null and hzxm != ''">
			,#{hzxm}
		</if>
		<if test="xb != null and xb != ''">
			,#{xb}
		</if>
		<if test="nl != null and nl != ''">
			,#{nl}
		</if>
		<if test="nldw != null and nldw != ''">
			,#{nldw}
		</if>
		<if test="dh != null and dh != ''">
			,#{dh}
		</if>
		<if test="sjdw != null and sjdw != ''">
			,#{sjdw}
		</if>
		<if test="sjdwmc != null and sjdwmc != ''">
			,#{sjdwmc}
		</if>
		<if test="ks != null and ks != ''">
			,#{ks}
		</if>
		<if test="qtks != null and qtks != ''">
			,#{qtks}
		</if>
		<if test="sjys != null and sjys != ''">
			,#{sjys}
		</if>
		<if test="ysdh != null and ysdh != ''">
			,#{ysdh}
		</if>
		<if test="db != null and db != ''">
			,#{db}
		</if>
		<if test="jcdw != null and jcdw != ''">
			,#{jcdw}
		</if>
		<if test="yblx != null and yblx != ''">
			,#{yblx}
		</if>
		<if test="yblxmc != null and yblxmc != ''">
			,#{yblxmc}
		</if>
		<if test="ybtj != null and ybtj != ''">
			,#{ybtj}
		</if>
		<if test="zyh != null and zyh != ''">
			,#{zyh}
		</if>
		<if test="cwh != null and cwh != ''">
			,#{cwh}
		</if>
		<if test="sfjs != null and sfjs != ''">
			,#{sfjs}
		</if>
		<if test="sftj != null and sftj != ''">
			,#{sftj}
		</if>
		<if test="sfsf != null and sfsf != ''">
			,#{sfsf}
		</if>
		<if test="nbbm != null and nbbm != ''">
			,#{nbbm}
		</if>
		<if test="ybbh != null and ybbh != ''">
			,#{ybbh}
		</if>
		<if test="wbbm != null and wbbm != ''">
			,#{wbbm}
		</if>
		<if test="cyrq != null and cyrq != ''">
			,cast(#{cyrq} as TIMESTAMP)
		</if>
		<if test="jsrq != null and jsrq != ''">
			,cast(#{jsrq} as TIMESTAMP)
		</if>
		<if test="jsry != null and jsry != ''">
			,#{jsry}
		</if>
		<if test="syrq != null and syrq != ''">
			,cast(#{syrq} as TIMESTAMP)
		</if>
		<if test="dsyrq != null and dsyrq != ''">
			,cast(#{dsyrq} as TIMESTAMP)
		</if>
		<if test="qtsyrq != null and qtsyrq != ''">
			,cast(#{qtsyrq} as TIMESTAMP)
		</if>
		<if test="jt != null and jt != ''">
			,#{jt}
		</if>
		<if test="bgrq != null and bgrq != ''">
			,cast(#{bgrq} as TIMESTAMP)
		</if>
		<if test="lczz != null and lczz != ''">
			,#{lczz}
		</if>
		<if test="qqzd != null and qqzd != ''">
			,#{qqzd}
		</if>
		<if test="jqyy != null and jqyy != ''">
			,#{jqyy}
		</if>
		<if test="qqjc != null and qqjc != ''">
			,#{qqjc}
		</if>
		<if test="jyjg != null and jyjg != ''">
			,#{jyjg}
		</if>
		<if test="sfsc != null and sfsc != ''">
			,#{sfsc}
		</if>
		<if test="kdlx != null and kdlx != ''">
			,#{kdlx}
		</if>
		<if test="kdh != null and kdh != ''">
			,#{kdh}
		</if>
		<if test="qyrq != null and qyrq != ''">
			,cast(#{qyrq} as TIMESTAMP)
		</if>
		<if test="ydrq != null and ydrq != ''">
			,cast(#{ydrq} as TIMESTAMP)
		</if>
		<if test="yjydrq != null and yjydrq != ''">
			,cast(#{yjydrq} as TIMESTAMP)
		</if>
		<if test="jcbj != null and jcbj != ''">
			,#{jcbj}
		</if>
		<if test="djcbj != null and djcbj != ''">
			,#{djcbj}
		</if>
		<if test="qtjcbj != null and qtjcbj != ''">
			,#{qtjcbj}
		</if>
		<if test="fkbj != null and fkbj != ''">
			,#{fkbj}
		</if>
		<if test="fkje != null and fkje != ''">
			,${fkje}
		</if>
		<if test="sfje != null and sfje != ''">
			,${sfje}
		</if>
		<if test="fkrq != null and fkrq != ''">
			,cast(#{fkrq} as TIMESTAMP)
		</if>
		<if test="ddh != null and ddh != ''">
			,#{ddh}
		</if>
		<if test="zt != null and zt != ''">
			,#{zt}
		</if>
		<if test="sfzmjc != null and sfzmjc != ''">
			,#{sfzmjc}
		</if>
		<if test="zmxm != null and zmxm != ''">
			,#{zmxm}
		</if>
		<if test="zmmdd != null and zmmdd != ''">
			,#{zmmdd}
		</if>
		<if test="sjqf != null and sjqf != ''">
			,#{sjqf}
		</if>
		<if test="kpsq != null and kpsq != ''">
			,#{kpsq}
		</if>
		<if test="bz != null and bz != ''">
			,#{bz}
		</if>
		<if test="lcfk != null and lcfk != ''">
			,#{lcfk}
		</if>
		<if test="yxbfk != null and yxbfk != ''">
			,#{yxbfk}
		</if>
		<if test="q20 != null and q20 != ''">
			,#{q20}
		</if>
		<if test="q30 != null and q30 != ''">
			,#{q30}
		</if>
		<if test="lrry != null and lrry != ''">
			,#{lrry}
		</if>
		,LOCALTIMESTAMP
			,'0'
		<if test="kdfy != null and kdfy != ''">
			,#{kdfy}
		</if>
		<if test="jcxmmc != null and jcxmmc != ''">
			,#{jcxmmc}
		</if>
		)
	</insert>



	<!-- 根据样本编号查找送检信息数据，若相同样本编号存在多条对应的送检信息数据，则取第一条 -->
	<select id="getDtosByYbbh" parameterType="SjxxDto" resultType="SjxxDto">
         select sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.yblxmc,
				sj.ybtj,sj.zyh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq, sj.bgrq,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,
				sj.bz,sj.lrry, sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,sj.syrq,sj.jt,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,sj.px,sj.sfje,sj.djcbj,sj.dsyrq,
				sj.sfsc,sj.sfzq,sj.lcfk,sj.yxbfk,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,sj.cwh,sj.sfzmjc,sj.zmxm,sj.zmmdd,sj.wbbm,sj.q20,sj.q30,sj.qtsyrq,sj.qtjcbj,sj.sjqf,
				sj.kpsq,sj.sjdwmc,jcxm.jcxmid,jcxm.jczxmid,sj.kdfy,sj.tkje,sj.tksj,sj.tkfs,sj.kdbj,sj.jcjg,sj.ysjg
         from igams_sjxx sj
         LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		<where>
			 sj.scbj= '0' and (sj.ybbh = #{ybbh} or sj.wbbm = #{ybbh})
		 </where>
         limit 1
	</select>
	<!-- 查找所有 是否接收为 是（1），是否收费为1，sfje =0 的数据 -->
	<select id="getDtoBySf" parameterType="String" resultType="SjxxDto">
		select sj.hzxm,sj.db,sj.ybbh,to_char(sj.jsrq,'yyyy-mm-dd') jsrq,sf.csmc sf,ptgs.csmc ptgsmc
		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl and jcsj.cskz1='1'
		left join matridx_jcsj sf on sf.csid=hb.sf
		left join matridx_jcsj ptgs on ptgs.csid=hb.ptgs
		<where>
			sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null)
			and sj.jsrq &lt; current_date and jcsj.csid is not null  and sj.sjqf=#{csid}
		</where>
		order by ptgs.csmc,sj.db,sj.jsrq desc
	</select>

	<select id="getPagedDtoBySf" parameterType="SjxxDto" resultType="SjxxDto">
        select * from(
		select sj.hzxm,sj.db,sj.ybbh,to_char(sj.jsrq,'yyyy-mm-dd') jsrq,sf.csmc sf,ptgs.csmc ptgsmc
		<if test="jcdwxz !=null and jcdwxz.size()>0">
		,sj.jcdw
		</if>

		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl and jcsj.cskz1='1'
		left join matridx_jcsj sf on sf.csid=hb.sf
		left join matridx_jcsj ptgs on ptgs.csid=hb.ptgs
		<where>
			sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null)
			and sj.jsrq &lt; current_date and   COALESCE(jcsj.csid,'') &lt;&gt; ''  and sj.sjqf=#{csid}

		</where>
		) sjx
		<where>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
				and sjx.jcdw in
				<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
					#{item}
				</foreach>
			</if>
			<if test="sjhbs != null and sjhbs.size()>0">
				and sjx.db in
				<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
		</where>
	</select>

	<!-- 根据直销的合作伙伴，查找相应的医学代表，把是否接收为 是（1），是否收费为1，sfje =0 的数据，如果不为0 则发送相应的消息给该用户 -->
	<select id="getCountByYxdb" parameterType="SjxxDto" resultType="SjxxDto">
		select count(xtyh.ddid) rs,xtyh.ddid,xtyh.yhid,xtyh.yhm
		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_xtyh yh on yh.yhid=hb.yhid
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl and jcsj.cskz1='1'
		left join igams_hbqx qx on qx.hbid=hb.hbid
		left join matridx_xtyh xtyh on xtyh.yhid=qx.yhid
		where
			sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null)
			and sj.jsrq &lt; current_date  and jcsj.csid is not null and sj.sjqf=#{csid}
			 and 
		         <foreach collection="dbgws" item="item" index="index" open="(" close=")" separator=" or ">
		             xtyh.gwmc ILIKE '%'||#{item}||'%' 
		         </foreach>
		GROUP BY xtyh.ddid,xtyh.yhid,xtyh.yhm
	</select>
	<!-- 根据直销的合作伙伴，查找相应的医学代表，把是否接收为 是（1），是否收费为1，sfje =0 的数据，如果不为0 则发送相应的消息给该用户 -->
	<select id="getListByYxdb" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.hzxm,sj.db,sj.ybbh,to_char(sj.jsrq,'yyyy-mm-dd') jsrq,sf.csmc sf
		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_jcsj sf on sf.csid=hb.sf
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl and jcsj.cskz1='1'
		left join igams_hbqx qx on qx.hbid=hb.hbid
		left join matridx_xtyh xtyh on xtyh.yhid=qx.yhid
		where sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null)  and xtyh.ddid=#{ddid}
		and sj.jsrq &lt; current_date  and jcsj.csid is not null and sj.sjqf=#{csid}
		order by sj.jsrq desc
	</select>

	<!-- 根据直销的合作伙伴，查找相应的大区经理，地区经理，把是否接收为 是（1），是否收费为1，sfje =0 的数据，如果不为0 则发送相应的消息给该用户 -->
	<select id="getCountByDqjl" parameterType="SjxxDto" resultType="SjxxDto">
		select count(xtyh.ddid) rs,xtyh.ddid,xtyh.yhid,xtyh.yhm
		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_xtyh yh on yh.yhid=hb.yhid
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl and jcsj.cskz1='1'
		left join igams_hbqx qx on qx.hbid=hb.hbid
		left join matridx_xtyh xtyh on xtyh.yhid=qx.yhid
		where
			sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null)
			and sj.jsrq  &lt; (current_timestamp -interval '3 day') and jcsj.csid is not null and sj.sjqf=#{csid} and
	        <foreach collection="dbgws" item="item" index="index" open="(" close=")" separator=" or ">
	             xtyh.gwmc ILIKE '%'||#{item}||'%' 
	         </foreach>
		GROUP BY xtyh.ddid,xtyh.yhid,xtyh.yhm
	</select>

	<select id="getListByDqjl" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.hzxm,sj.db,sj.ybbh,to_char(sj.jsrq,'yyyy-mm-dd') jsrq,sf.csmc sf
		from igams_sjxx sj
		left join igams_sjhbxx hb on hb.hbmc=sj.db
		left join matridx_jcsj sf on sf.csid=hb.sf
		left join matridx_jcsj jcsj on jcsj.csid=hb.fl  and jcsj.cskz1='1'
		left join igams_hbqx qx on qx.hbid=hb.hbid
		left join matridx_xtyh xtyh on xtyh.yhid=qx.yhid
		where sj.scbj= '0' and sj.sfjs='1' and sfsf!='0' and (sfje=0 or sfje is null) and xtyh.ddid=#{ddid}
		and sj.jsrq  &lt; (current_timestamp -interval '3 day')  and jcsj.csid is not null and sj.sjqf=#{csid}
		order by sj.db,sj.jsrq desc
	</select>

	<!--获取样本编号对应检测项目以及合作伙伴的参数扩展3-->
	<select id="getSjxxGlCskz3" parameterType="String" resultType="SjxxDto">
		SELECT sjxx.sjid,sjjcxm.jcxmid,jc_jcxm.cskz3 jc_cskz3,sjhb.cskz3 hbcskz3,dw.dwdm ksdm,dw.dwmc ksmc
		FROM igams_sjxx sjxx
		 LEFT JOIN igams_sjhbxx sjhb on sjhb.hbmc = sjxx.db
		 LEFT JOIN igams_sjjcxm sjjcxm on sjjcxm.sjid = sjxx.sjid and sjjcxm.scbj='0'
		 LEFT JOIN matridx_jcsj jc_jcxm on sjjcxm.jcxmid = jc_jcxm.csid
		 LEFT JOIN igams_sjdwxx dw on sjxx.ks = dw.dwid
		where sjxx.ybbh = #{ybbh}
	</select>
		<select id="getInfo" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,
		sjxx.bz,sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		case when jc.cskz1 ='1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,jcsj.csdm as mbdm,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,
		sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,sjyz.yzid
		from igams_sjxx sjxx
		left outer join igams_sjyz sjyz on sjxx.sjid = sjyz.sjid
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj jcsj on hb.bgmb = jcsj.csid
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
		LEFT JOIN matridx_jsjcdw jsjcdw ON jsjcdw.jcdw = sjxx.jcdw
		WHERE
			sjxx.ybbh =#{ybbh}
			AND jsjcdw.jsid=#{jsid}
	</select>
	<update id="updateTssq" parameterType="SjxxDto">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="sfsf !=null and sfsf !=''">
			,sfsf=#{sfsf}
		</if>
		<if test="sfvip !=null and  sfvip !=''">
			,sfvip=#{sfvip}
		</if>
		<if test="sqlx !=null and sqlx !=''">
			,sqlx=#{sqlx}
		</if>
		<if test="fkje !=null and fkje !=''">
			,fkje=cast(#{fkje} as numeric)
		</if>
		<where>
			sjid=#{sjid}
		</where>
	</update>
	<select id="getSfzjeAndTkzje" parameterType="SjxxDto" resultType="SjxxDto">
		select COALESCE(sum(sj.sfje),0) sfzje,COALESCE(sum(sj.tkje),0) tkzje
		from igams_sjxx sj
		left join matridx_jcsj jcsj on sj.yblx = jcsj.csid
		left join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
		left join igams_yyxx yyxx on yyxx.dwid = sj.sjdw
		left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
		left join matridx_jcsj cskz1 on cskz1.csid=sj.cskz1
		left join matridx_jcsj sqlx on sj.sqlx = sqlx.csid
		<if test = "(kylxs != null and kylxs.length > 0) or (kyxm != null and kyxm !='')">
			left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sj.kyxm
		</if>
		<where>
			<include refid="SelectWhere"></include>
			and sj.scbj = '0'
			<if test="userids != null and userids.size()>0">
				and (sj.lrry in
				<foreach collection="userids" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
				<if test="sjhbs != null and sjhbs.size()>0">
					or sj.db in
					<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
						#{item}
					</foreach>
				</if>
				)
			</if>
			<if test="all_param !=null and all_param !=''">
				and (
				sj.ybbh = #{all_param}
				or sj.hzxm like '%'||#{all_param}||'%'
				or jcsj.csmc like '%'||#{all_param}||'%'
				or yyxx.dwjc like '%'||#{all_param}||'%'
				or to_char(sj.jsrq,'yyyy-mm-dd') like '%'||#{all_param}||'%'
				)
			</if>
			<if test="ybbh !=null and ybbh !=''">
				and sj.ybbh like '%'||#{ybbh}||'%'
			</if>
			<if test="sjys !=null and sjys !=''">
				and sj.sjys like '%'||#{sjys}||'%'
			</if>
			<if test="bgrqbj !=null and bgrqbj !='' and bgrqbj=='1'.toString">
				and sj.bgrq is null
			</if>
			<if test="dwjc !=null and dwjc !=''">
				and yyxx.dwjc like '%'||#{dwjc}||'%'
			</if>
			<if test="jcdwxz !=null and jcdwxz.size()>0">
				and sj.jcdw in
				<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbfls != null and sjhbfls.length > 0"  >
				and hbxx.fl in
				<foreach collection="sjhbfls" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "sjhbzfls != null and sjhbzfls.length > 0"  >
				and hbxx.zfl in
				<foreach collection="sjhbzfls" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
		</where>
	</select>

	<select id="getSjxxInfoByYbbh" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT sjxx.sjid,sjxx.ybbh,sjxx.nbbm,sjxx.hzxm,sjxx.nl,sjxx.jsrq,sjxx.kdh,sjxx.bz,sjxx.jcdw,jc_jcdw.csmc jcdwmc
		from igams_sjxx sjxx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid =sjxx.jcdw
		WHERE sjxx.scbj != '1'
		<if test="ybbh != null and ybbh != ''">
			AND sjxx.ybbh = #{ybbh}
		</if>
		<if test="sjid != null and sjid != ''">
			and sjxx.sjid = #{sjid}
		</if>
	</select>

	<select id="getPagedDtoListDays" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT to_char(xpxx.lrsj,'yyyy-mm-dd hh24:mi:ss') lrsj,xpxx.xpm,xpxx.density,xpxx.intensity,xpxx.q30
		from igams_xpxx xpxx
		WHERE xpxx.scbj != '1'
		and to_char(xpxx.lrsj,'yyyy-mm-dd') > #{lrsj}
		<if test="cxyid != null and cxyid != ''">
			AND xpxx.cxyid = #{cxyid}
		</if>
	</select>

	<select id="getPagedSampleProgressList"  parameterType="SjxxDto"  resultType="SjxxDto" >
		select
		sj.sjid,sj.hzxm,sj.ybbh,sj.nbbm,sj.yblx,case when yblx.cskz1 ='1' then COALESCE(sj.yblxmc,yblx.csmc) else yblx.csmc end AS yblxmc,jc_xm.csmc as jcxmmc,sj.jsrq,sj.dsyrq,
		sj.syrq,sj.qtsyrq,sj.bgrq,sj.db,jc_jcdw.csmc jcdwmc,yyxx.dwmc||case when yyxx.cskz1 ='1' then '--'||sj.sjdwmc else '' end as hospitalname,wksjgl.sjsj,wksjgl.xjsj
		from igams_sjxx  sj
		left join matridx_jcsj yblx on sj.yblx = yblx.csid
		left join igams_sjjcxm jcxm on jcxm.sjid = sj.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sj.jcdw
		left join igams_yyxx yyxx on yyxx.dwid =sj.sjdw
		left join (SELECT wkid,sjid FROM igams_wkmx GROUP BY wkid,sjid) wkmx on wkmx.sjid=sj.sjid
		left join igams_wksjgl wksjgl on wksjgl.wkid=wkmx.wkid and wksjgl.scbj != '1'
		<where>
			sj.scbj!='1' and ((sj.jsrq is not null and sj.bgrq is null) or to_char(sj.bgrq,'yyyy-MM-dd')=''||current_date )
			<if test="entire != null and entire != ''">
				and (sj.ybbh like '%'||#{entire}||'%'
				or sj.hzxm like '%'||#{entire}||'%'
				or sj.nbbm like '%'||#{entire}||'%'
				or (yyxx.dwmc like '%'||#{entire}||'%' or sj.sjdwmc like '%'||#{entire}||'%')
				or sj.db like '%'||#{entire}||'%')
			</if>
			<if test="ybbh != null and ybbh != ''">
				AND sj.ybbh like '%'||#{ybbh}||'%'
			</if>
			<if test="hzxm != null and hzxm != ''">
				and sj.hzxm like '%'||#{hzxm}||'%'
			</if>
			<if test="nbbm != null and nbbm != ''">
				and sj.nbbm like '%'||#{nbbm}||'%'
			</if>
			<if test="sjdwmc != null and sjdwmc != ''">
				and (yyxx.dwmc like '%'||#{sjdwmc}||'%' or sj.sjdwmc like '%'||#{sjdwmc}||'%')
			</if>
			<if test="db != null and db != ''">
				and sj.db like '%'||#{db}||'%'
			</if>
			<if test = "jcdws != null and jcdws.length > 0 "  >
				and sj.jcdw in
				<foreach collection="jcdws" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test = "yblxs != null and yblxs.length > 0 "  >
				and sj.yblx in
				<foreach collection="yblxs" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			<if test="jcxms !=null and jcxms.length > 0">
				and exists
				(select jcxm.sjid from igams_sjjcxm  jcxm where jcxm.scbj='0' and jcxm.jcxmid in
				<foreach separator="," collection="jcxms" open="(" close=")" index="index" item="item">
					#{item}
				</foreach>
				and jcxm.sjid=sj.sjid)
			</if>
			<if test="dwxzbj !=null and dwxzbj != '' and dwxzbj=='1'.toString">
				<if test="jcdwxz !=null and jcdwxz.size()>0">
					and sj.jcdw in
					<foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
						#{item}
					</foreach>
				</if>
				<if test="jcdwxz ==null or jcdwxz.size()==0">
					and 1=2
				</if>
			</if>
			<if test="sjhbs != null and sjhbs.size()>0">
				and sj.db in
				<foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
		</where>
	</select>
	<!--	获取实验员列表头部数据-->
	<select id="querySjSyxxnums" resultType="Map" parameterType="SjxxDto">
		select
		count(case when jsrq = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' ) then sjid end ) as yjs,
		count(case when (jsrq &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' ) or lrsj &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' )) AND qysj is null and GREATEST(rsyrq,dsyrq,qtsyrq) is null then sjid end ) as yjswqy,
		count(case when qysj = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' ) then sjid end) as yqy,
		count(case when  qysj &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' ) AND tqsjid is null then sjid end ) as yqywtq,
		count(case when tqsjid  is not null and tqlrsj = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' ) then sjid end ) as ytq,
		count(case when tqsjid is not null AND wkmxsjid is null and tqlrsj &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' ) then sjid end ) as ytqwjk,
		count(case when wkmxsjid is not null and wkmxlrsj = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' )  then sjid end ) as yjk,
		'0' as yjkwp,'0' as yp,'0' as ypwsj,
		count(case when wksjid is not null and wklrsj = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' ) then sjid end ) as ysj,
		count(case when wksjid is not null and wklrsj &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' ) and( (flg = '送检' and bgrq is null)
		or ( flg = '复检' and  bgbj = '1' and   ( bgrq is null or bgrq &lt;= GREATEST(rsyrq,dsyrq,qtsyrq)))) then sjid end ) as ysjwbg,
		count(case when bgrq is not null and  bgrq &gt;= GREATEST(rsyrq,dsyrq,qtsyrq) and  to_char( bgrq, 'yyyy-MM-dd' )  = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' ) then sjid end ) as ybg,
		count(case when jcsj is null and tqlrsj &gt;= TO_CHAR( (now() - interval '1 week'), 'yyyy-MM-dd' )   then sjid end ) as ytqwjc,
		count(case when jcsj = TO_CHAR( LOCALTIMESTAMP, 'yyyy-MM-dd' )  then sjid end ) as yjc,
		count(case when jcsj &gt;= TO_CHAR((now() - interval '1 week'), 'yyyy-MM-dd' ) and ( (flg = '送检' and bgrq is null)
		or ( flg = '复检' and  bgbj = '1' and   ( bgrq is null or bgrq &lt;=  GREATEST(rsyrq,dsyrq,qtsyrq)
		)))  then sjid end ) as yjcwbg
		from(
		select info.*,tqmx.sjid as tqsjid,tqmx.lrsj as tqlrsj,wkmx.sjid as wkmxsjid,wkmx.lrsj as wkmxlrsj,wksj.wksjid,to_char(wksj.lrsj, 'yyyy-MM-dd' ) as wklrsj from
		(
		select tmp.*,case when tmp.jcxm is not null then tmp.jcxm else sjjcxm.jcxmid end csid ,case when xmjclxf is not null then xmjclxf when xmjclxs is not null then xmjclxs  when jcxm.cskz1 is not null then jcxm.cskz1 else jc_jcxm.cskz1 end cskz1  from
		(
		select sjid,null as fjid,null as jcxm ,to_char( jsrq, 'yyyy-MM-dd' ) jsrq, dsyrq, syrq  as rsyrq , qtsyrq,null as lrsj,'送检' as flg,to_char( qysj, 'yyyy-MM-dd' )  qysj,bgrq,null as bgbj,jcdw,to_char( jcsj, 'yyyy-MM-dd' ) jcsj
		from igams_sjxx where to_char(lrsj, 'yyyy-MM-dd' ) &gt;= TO_CHAR( now() - interval '2 week' , 'yyyy-MM-dd' ) AND scbj = '0' AND sfjs = '1' AND jsrq IS NOT NULL
		UNION ALL
		select fj.sjid,fj.fjid,fj.jcxm,null as jsrq,fj.dsyrq,fj.rsyrq,fj.qtsyrq,to_char( fj.lrsj, 'yyyy-MM-dd' ) lrsj,'复检' as flg,to_char( fj.qysj, 'yyyy-MM-dd' ) qysj,sj.bgrq,fj.bgbj,fj.jcdw,to_char( fj.jcsj, 'yyyy-MM-dd' ) jcsj
		from igams_fjsq fj
		left join igams_sjxx sj  on sj.sjid = fj.sjid
		where to_char( fj.lrsj, 'yyyy-MM-dd' ) &gt;= TO_CHAR( now() - interval '2 week' , 'yyyy-MM-dd' ) AND fj.scbj = '0' and fj.sjid IS NOT NULL
		) tmp
		LEFT JOIN igams_sjjcxm sjjcxm ON sjjcxm.sjid = tmp.sjid and tmp.fjid is null and sjjcxm.scbj='0'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = sjjcxm.jcxmid
		left join matridx_jcsj jcxm on jcxm.csid =tmp.jcxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclxs UNION ALL SELECT 'R' xmjclxs ) tts ON jc_jcxm.cskz1 = 'C'
		LEFT OUTER JOIN ( SELECT 'D' xmjclxf UNION ALL SELECT 'R' xmjclxf ) ttf ON jcxm.cskz1 = 'C'
		) info
		left join (select * from (
		select tq.sjid,tq.jcxmdm,to_char(tqgl.tqrq, 'yyyy-MM-dd' ) lrsj,row_number() over (partition by tq.sjid,tq.jcxmdm,to_char(tqgl.tqrq, 'yyyy-MM-dd' )) as rownum from igams_tqmx tq
		left join igams_tqgl tqgl on tqgl.tqid = tq.tqid and tqgl.scbj = '0'
		where tq.scbj = '0' AND tqgl.tqrq &gt;= (now() - interval '2 week')
		) r
		where r.rownum = '1'
		) tqmx on tqmx.sjid = info.sjid  and tqmx.jcxmdm = cskz1 and case when cskz1 = 'F' then tqmx.lrsj = to_char(qtsyrq, 'yyyy-MM-dd' ) when cskz1 = 'R' then tqmx.lrsj = to_char(rsyrq, 'yyyy-MM-dd' ) else tqmx.lrsj = to_char(dsyrq, 'yyyy-MM-dd' ) end
		left join (select * from (
		select wkmx.wkid,wkmx.jcxmdm,wkmx.sjid,to_char(wkgl.wkrq, 'yyyy-MM-dd' ) lrsj,row_number() over (partition by wkmx.sjid,wkmx.jcxmdm,to_char(wkgl.wkrq, 'yyyy-MM-dd' )) as rownum     from igams_wkmx wkmx
		left join igams_wkgl wkgl on wkgl.wkid = wkmx.wkid and wkgl.scbj = '0'
		where wkmx.scbj = '0' AND wkgl.wkrq &gt;= (now() - interval '2 week')
		) r
		where r.rownum = '1'
		) wkmx on wkmx.sjid = info.sjid  and wkmx.jcxmdm = cskz1 and case when cskz1 = 'F' then wkmx.lrsj = to_char(qtsyrq, 'yyyy-MM-dd' ) when cskz1 = 'R' then wkmx.lrsj = to_char(rsyrq, 'yyyy-MM-dd' ) else wkmx.lrsj = to_char(dsyrq, 'yyyy-MM-dd' ) end
		left join igams_wksjgl wksj ON wksj.wkid = wkmx.wkid and wksj.scbj != '1'
		where info.sjid is not null and cskz1 is not null
		<if test="jcxmids !=null and jcxmids.size > 0">
			and csid in
			<foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
				#{item}
			</foreach>
		</if>
		<if test="jcdwxz!=null and jcdwxz.size()>0">
			and jcdw in
			<foreach collection="jcdwxz" open="(" close=")" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		) tab

	</select>



	<!-- 已接收未实验数据-->
	<select id="getConfirmDtoList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjsygl.syglid,sj.ybbh,sj.nbbm,sj.hzxm,sjsygl.jsrq,sj.bgrq,sj.sfjs,sjsygl.jcdw,yblx,xmsygl.jcxmid,sjsygl.syrq ,
		sjsygl.jcbj,sjsygl.nbzbm,jcxm.csmc jcxmmc,jcxm.cskz1 jcxmkzcs,jcsj_jcdw.csmc AS jcdwmc,
		case when xmsygl.ywlx = 'DETECT_SJ' then sj.sjid else fjsq.fjid end sjid,
		case when xmsygl.ywlx = 'DETECT_SJ' then '0' else '1' end flg_qf,
		case when xmsygl.ywlx = 'DETECT_SJ' then sj.zt else fjsq.zt end zt,
		case when xmsygl.ywlx = 'DETECT_SJ' then fjsq.bz else fjsq.bz end bz,
		case when xmsygl.ywlx = 'DETECT_SJ' then '正常送检' else jcsj_qf.csmc end qf
		from igams_sjsygl sjsygl
		left join igams_sjxx sj on sj.sjid = sjsygl.sjid and sj.scbj='0'
		left join igams_xmsygl xmsygl on sjsygl.syglid = xmsygl.syglid and xmsygl.scbj='0'
		LEFT JOIN igams_fjsq fjsq ON fjsq.fjid = xmsygl.ywid  and fjsq.scbj='0'
		left outer join igams_xxdy xxdy on xxdy.dyid= xmsygl.dyid
		LEFT JOIN matridx_jcsj jcsj_yblx ON jcsj_yblx.csid = sj.yblx
		LEFT JOIN matridx_jcsj jcsj_jcdw ON sjsygl.jcdw = jcsj_jcdw.csid
		left outer join matridx_jcsj jcxm on jcxm.csid= xmsygl.jcxmid
		LEFT JOIN matridx_jcsj jcsj_qf ON jcsj_qf.csid = fjsq.lx
		where sj.scbj = '0'  and sj.sfjs ='1' and fjsq.scbj = '0' and sjsygl.scbj ='0'
		and jcxm.cskz1 != 'F'
		and to_char(sj.jsrq,'YYYY-MM-dd') =  to_char(now(),'YYYY-MM-dd')
		and sjsygl.syrq is null
		<if test="jcdwxz!=null and jcdwxz.size()>0">
			and sjsygl.jcdw in
			<foreach collection="jcdwxz" open="(" close=")" item="item" separator=",">
				#{item}
			</foreach>
		</if>
	</select>
	

	<update id="updateSampleInfo" parameterType="SjxxDto">
		update igams_sjxx set
		qysj = LOCALTIMESTAMP
		,qyry = #{qyry}
		where
		sjid = #{sjid}
	</update>

	<select id="testNumberStatistics" resultType="String" parameterType="SjxxDto">
		select jcdw.csdm
		from igams_sjsygl sjsygl
		left join matridx_jcsj jcdw on jcdw.csid =sjsygl.jcdw and jcdw.scbj='0'
		where sjsygl.scbj='0'
		and jcdw.csdm in
		<foreach collection="ids" open="(" close=")" separator="," item="item">
			#{item}
		</foreach>
		and sjsygl.sfjs='1'
		and to_char(sjsygl.jsrq,'YYYY-MM-DD') &gt;= to_char(CURRENT_DATE-3,'YYYY-MM-DD')
		and sjsygl.syrq is null
	</select>
	
	<select id="testNumberList" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.ybbh,sjxx.hzxm,sjxx.sjdw,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,jcdw.cskz2 jcdwjc,jc_xm.cskz1 jcxmkzcs,
		case when jcsj.cskz1 ='1' then COALESCE(sjxx.yblxmc,jcsj.csmc) else jcsj.csmc end AS yblxmc,sjxx.db,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否' when sjxx.sfsf='2' then '免D' when sjxx.sfsf='3' then '免R' end sfsf ,
		jc_xm.csmc jcxmmc,yyxx.cskz1 sjdwbj,yyxx.dwmc yymc
		,case when sjsygl.sfjs = '1' then '是' else '否' end sfjs
		from igams_sjsygl sjsygl
		left join matridx_jcsj jcdw on jcdw.csid =sjsygl.jcdw and jcdw.scbj='0'
		left join igams_sjxx sjxx on sjxx.sjid =sjsygl.sjid
		left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
		left join igams_xmsygl xmsygl on sjsygl.syglid = xmsygl.syglid and xmsygl.scbj='0'
		left outer join matridx_jcsj jc_xm on jc_xm.csid = xmsygl.jcxmid and jc_xm.scbj='0'
		left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
		left outer join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
		where sjsygl.scbj='0'
		and jcdw.csdm =#{jcdwdm}
		and sjsygl.sfjs='1'
		and to_char(sjsygl.jsrq,'YYYY-MM-DD') &gt;= to_char(CURRENT_DATE-3,'YYYY-MM-DD')
		and sjsygl.syrq is null
	</select>



	<!-- 获取送检信息 (样本编号模糊查询) -->
	<select id="getDtoVague" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,
		sjxx.ybtj,sjxx.zyh,sjxx.cwh,sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,sjxx.lczz,sjxx.qqzd,sjxx.jqyy,sjxx.qqjc,
		sjxx.jyjg,sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,
		dw.dwmc ksmc,dw.dwdm ksdm,case when sjxx.xb ='1' then '男' when sjxx.xb='2' then '女'   when sjxx.xb='3' then'未知' end xbmc,sjxx.bz,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		case when jc.cskz1 = '1' then COALESCE(sjxx.yblxmc,jc.csmc) else jc.csmc end AS yblxmc,case when sjxx.fkbj='1' then '是' when sjxx.fkbj !='1' then '否'  end fkmc,sjxx.fkrq
		,sjxx.qtks,jcsj.csdm as mbdm,case when sjxx.sfjs='1' then '是' when sjxx.sfjs='0' then '否' when sjxx.sfjs='2' then '其他(外送)' end sfjsmc, case when sjxx.sftj='1' then '是' when sjxx.sftj='0' then '否' end sftjmc,case when sjxx.sfvip='1' then '是' when sjxx.sfvip='0' then '否' end sfvipmc,
		case when sjxx.sfsf='1' then '是' when sjxx.sfsf ='0' then '否' when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsfmc,
		case when sjxx.sfzq='1' then '是' when sjxx.sfzq='0' then '否' end sfzqmc,sjxx.sfjs,sjxx.sftj,sjxx.sfsf,sjxx.lcfk,sjxx.sfzq,sjxx.yxbfk,hb.gzlx,hbjcsj.cskz1 gzlxmc,
		sjxx.kdlx,sjxx.kdh,sjxx.kdfy,sjxx.qyrq,sjxx.ydrq,sjxx.yjydrq,jc_kd.csmc kdlxmc,sjxx.jcdw,jc_jcdw.csmc jcdwmc,sjxx.sfzmjc,sjxx.zmxm,sjxx.zmmdd,jc_zmxm.csmc as zmxmmc,jc_zmmdd.csmc as zmmddmc,
		hbbgjcsj.csmc bgfsmc, hbbgjcsj.csdm bgfsdm,jc.cskz2 as jc_cskz2,jc.csdm yblxdm,yyxx.dwjc as dwjc,yyxx.dwmc as hospitalname,yyxx.cskz1 as yyxxCskz1,sjxx.sjdwmc,jc_sjqf.csmc as sjqfmc,sjxx.jcxmmc,
		jc_kpsq.csmc as kpsqmc,case when yyxx.cskz1='1' then sjxx.sjdwmc else yyxx.dwjc end yymc,sjjcxm.jczxmid,jc_jczxm.csmc jczxmmc,case when sjxx.ybbh=#{ybbh} then 1 else 2 end xh
		from igams_sjxx sjxx
		left outer join igams_sjdwxx dw on sjxx.ks = dw.dwid
		left outer join matridx_jcsj jc on sjxx.yblx = jc.csid
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
		left outer join matridx_jcsj jcsj on hb.bgmb = jcsj.csid
		left outer join matridx_jcsj hbjcsj on hb.gzlx = hbjcsj.csid
		left outer join matridx_jcsj hbbgjcsj on hb.bgfs = hbbgjcsj.csid
		left outer join matridx_jcsj jc_kd on jc_kd.csid =sjxx.kdlx
		left outer join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		left outer join igams_sjjcxm sjjcxm on sjjcxm.sjid = sjxx.sjid and sjjcxm.scbj='0'
		left outer join matridx_jcsj jc_jczxm on sjjcxm.jczxmid = jc_jczxm.csid
		left outer join matridx_jcsj jc_zmxm on jc_zmxm.csid=sjxx.zmxm
		left outer join matridx_jcsj jc_zmmdd on jc_zmmdd.csid=sjxx.zmmdd
		left join igams_yyxx yyxx on yyxx.dwid =sjxx.sjdw
		left join matridx_jcsj jc_sjqf on jc_sjqf.csid =sjxx.sjqf
		left join matridx_jcsj jc_kpsq on jc_kpsq.csid = sjxx.kpsq
		<if test="yzid != null and yzid !=''">
			left join igams_sjyz sjyz on sjyz.sjid = sjxx.sjid
		</if>
		<where>
			sjxx.scbj = '0'
			<if test="sjid != null and sjid != ''">
				and sjxx.sjid = #{sjid}
			</if>
			<if test="ybbh != null and ybbh != ''">
				and (sjxx.ybbh like #{ybbh}||'-'||'%' or  sjxx.ybbh = #{ybbh} or sjxx.wbbm like #{ybbh}||'-'||'%' or  sjxx.wbbm = #{ybbh} )
			</if>
			<if test="nbbm != null and nbbm != ''">
				and (sjxx.nbbm = #{nbbm} or sjxx.ybbh = #{nbbm})
			</if>
			<if test="wxid != null and wxid != ''">
				and sjxx.lrry = #{wxid}
			</if>
			<if test="yzid != null and yzid !=''">
				and sjyz.yzid = #{yzid}
			</if>
		</where>
		order by xh
	</select>

	<update id="updateJcdw" parameterType="SjxxDto">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		,jcdw=#{jcdw}
		<where>
			sjid=#{sjid}
		</where>
	</update>
	
	<!-- 获取送检信息 (样本编号模糊查询) -->
	<select id="getSimpleDto" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.hzxm,sjxx.xb,sjxx.nl,sjxx.dh,sjxx.sjdw,sjxx.ks,sjxx.sjys,sjxx.ysdh,sjxx.db,sjxx.yblx,sjxx.nldw,
		sjxx.ybbh,sjxx.cyrq,sjxx.jsrq,to_char(sjxx.jsrq,'yyyy-MM-dd') fjsrq,sjxx.bgrq,
		sjxx.lrry,sjxx.lrsj,sjxx.xgry,sjxx.xgsj,sjxx.scry,sjxx.scsj,sjxx.scbj,sjxx.sfsc,sjxx.fkbj,sjxx.fkje,sjxx.sfje,sjxx.ddh,sjxx.nbbm,
		sjxx.sfjs,sjxx.sfsf
		from igams_sjxx sjxx
		<where>
			sjxx.scbj = '0'
			<if test="sjid != null and sjid != ''">
				and sjxx.sjid = #{sjid}
			</if>
			<if test="ybbh != null and ybbh != ''">
				and (sjxx.ybbh like #{ybbh}||'-'||'%' or  sjxx.ybbh = #{ybbh} or sjxx.wbbm like #{ybbh}||'-'||'%' or  sjxx.wbbm = #{ybbh} )
			</if>
			<if test="nbbm != null and nbbm != ''">
				and sjxx.nbbm = #{nbbm}
			</if>
		</where>
	</select>

	<update id="updateSfjsInfo" parameterType="SjxxDto">
      	<foreach collection="list" item="item" separator=" ; ">
			update igams_sjxx set sfjs=null , jsrq=null , jsry=null, xgry=#{item.xgry}, xgsj=LOCALTIMESTAMP where sjid=#{item.sjid}
		</foreach>
	</update>
	
	<select id="getQdListByYbbh" parameterType="SjxxDto" resultType="SjxxDto">
		select
		sjxx.sjid,
		max(wksjgl.xjsj) as fxwcsj
		from
		igams_wksjgl wksjgl
		left join igams_wksjmx wksjmx on
		wksjmx.wksjid = wksjgl.wksjid
		left join igams_sjxx sjxx on
		sjxx.ybbh = wksjmx.ybbh

		where 1=1
		and sjxx.ybbh in
		<foreach collection="ybbhs" open="(" close=")" separator="," item="item">
			#{item}
		</foreach>
		group by sjxx.sjid
	</select>

	<!--  处理修改 -->
	<update id="updateDealInfo" parameterType="SjxxDto">
		update igams_sjxx set
		xgry=#{xgry},xgsj=LOCALTIMESTAMP
		<if test="nbbm!=null and nbbm !=''">
			,nbbm=#{nbbm}
		</if>
		<if test="yblx!=null and yblx !=''">
			,yblx=#{yblx}
		</if>
		<if test="yblxmc!=null and yblxmc !=''">
			,yblxmc=#{yblxmc}
		</if>
		<if test="jcxmmc!=null and jcxmmc !=''">
			,jcxmmc=#{jcxmmc}
		</if>
		<where>
		sjid = #{sjid}
		</where>
	</update>

	<update id="updateFkje" parameterType="List">
		update igams_sjxx set fkje=tmp.fkje from
		(
			<foreach collection="list" item="item" open="(" close=")" separator="union all">
				select #{item.sjid} sjid,cast(#{item.fkje} as numeric ) fkje
			</foreach>
		)tmp where tmp.sjid=igams_sjxx.sjid
	</update>
	
	<select id="getSimilarList" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.jcxmmc,sj.hzxm,sj.sjid,sj.ybbh,sj.nbbm,yy.dwmc,sj.nl,case when sj.xb ='1' then '男' when sj.xb='2' then '女'  when sj.xb='3' then'未知' end xbmc
		from igams_sjxx sj
		left join igams_yyxx yy on yy.dwid=sj.sjdw
		<where>
			sj.scbj='0'
			and sj.hzxm=#{hzxm}
			and sj.db=#{db}
			and yy.dwmc=#{hospitalname}
			and sj.sjid!=#{sjid}
		</where>
		order by sj.jsrq desc
	</select>

	<select id="getSimilarSjxxJcxmList" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.jcxmmc,sj.hzxm,sj.sjid,sj.ybbh,sj.nbbm,sj.nl,case when sj.xb ='1' then '男' when sj.xb='2' then '女'  when sj.xb='3' then'未知' end xbmc
		from igams_sjxx sj
		left join igams_sjjcxm jcxm on jcxm.sjid= sj.sjid and jcxm.scbj = '0'
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid= jcxm.jcxmid and jc_jcxm.scbj = '0'
		<where>
			sj.scbj='0'
			and sj.hzxm=#{hzxm}
			and sj.yblx=#{yblx}
			and sj.db=#{db}
			and sj.sjdw=#{sjdw}
			and sj.jcdw=#{jcdw}
			and sj.xb=#{xb}
			and sj.nl=#{nl}
			and jc_jcxm.cskz1=#{jcxmcskz}
			and jc_jcxm.cskz3=#{jcxmcskz3}
		</where>
		order by sj.bgrq desc
	</select>

	<select id="getDeadlineSamples" parameterType="SjxxDto" resultType="String">
		select sjid from igams_sjxx
		<where>
			scbj != '1' and (sfjs = '0' or sfjs is null) and jsrq is null and bgrq is null
			and to_char(lrsj,'yyyy-MM-dd') &lt;= #{lrsjEnd}
			<if test="ybbhs !=null and ybbhs.size>0">
				and ybbh not in
				<foreach collection="ybbhs" open="(" close=")" separator="," item="item">
					#{item}
				</foreach>
			</if>
			<if test="jcxmmc_flg !=null and jcxmmc_flg !=''">
				and jcxmmc is null
			</if>
			<if test="dbs !=null and dbs.size>0">
				and db in
				<foreach collection="dbs" open="(" close=")" separator="," index="index" item="item" >
					#{item}
				</foreach>
			</if>
		</where>
	</select>

	<select id="getSyxxByZdhbm" parameterType="Map" resultType="Map">
		select sj.sjid ,fjsq.fjid,xxdy.kzcs2 tqm,xxdy.dydm wkm,xmsygl.xmsyglid ,xmsygl.ywlx,sjsygl.syglid
		from igams_sjxx sj
		left join igams_sjsygl sjsygl on sjsygl.sjid = sj.sjid and sjsygl.scbj='0'
		left join igams_xmsygl xmsygl on xmsygl.syglid=sjsygl.syglid and xmsygl.scbj='0'
		left join igams_xxdy xxdy on xxdy.dyid=xmsygl.dyid
		left join igams_sjxx sjxx on xmsygl.ywlx='DETECT_SJ' and xmsygl.ywid = sjxx.sjid
		left join igams_fjsq fjsq on xmsygl.ywlx='DETECT_FJ' and xmsygl.ywid = fjsq.fjid and fjsq.zt in ('10','80')
		where sj.zdhbm=#{zdhbm} and sj.jcdw=#{jcdw}
		<if test=" dydm != null and dydm!=''">
			and xxdy.dydm=#{dydm}
		</if>
		<if test=" cskz2 != null and cskz2!=''">
			and xxdy.cskz2=#{cskz2}
		</if>
		and sjsygl.sjsj is null
	</select>

	<select id="getWkcxBySjid" parameterType="SjxxDto" resultType="Map">
		select wkbh from igams_wkcx iw where sjid=#{sjid} and zt = '01' group by wkbh
	</select>

	<select id="getWkcxByWkbh" parameterType="Map" resultType="Map">
		select
		wkcxbb.jgid ,
		wkcxbb.wkbh ,
		wkcxbb.rawreads ,
		wkcxbb.totalreads ,
		wkcxbb.homo ,
		wkcxbb.bacteria ,
		wkcxbb.fungi ,
		wkcxbb.viruses ,
		wkcxbb.parasite ,
		wkcxbb.others ,
		wkcxbb.unmapped ,
		wkcxbb.spikein ,
		wkcxbb.spikeinrpm ,
		wkcxbb.bbh ,
		wkcxbb.spike ,
		wkcxbb.ryzs ,
		wkcxbb.rypw ,
		wkcxbb.sfzwqckj,
		wkcxbb.lrsj,
		cast(wkcxbb.spikejson as varchar) spikejson
		from igams_wkcxbb wkcxbb
		<where>
			<if test="wkbh != null and wkbh != ''">
				and wkcxbb.wkbh = #{wkbh}
			</if>
			<if test="bbh != null and bbh != ''">
				and wkcxbb.bbh = #{bbh}
			</if>
			<if test="wkbh != null and wkbh != ''">
				order by wkcxbb.lrsj desc limit 1
			</if>
		</where>
	</select>

	<select id="getNcPcByWkbh" parameterType="Map" resultType="Map">

		select
		wksjmx.wkbm as wkbh,
		wksjgl.xpmc as xpm
		from
		igams_wksjgl wksjgl
		inner join (
		select
		wksjid
		from
		igams_wksjmx
		where
		wkbm = #{wkbh} )tmp on
		tmp.wksjid = wksjgl.wksjid
		left join igams_wksjmx wksjmx on wksjmx.wksjid = wksjgl.wksjid
		where
		wksjmx.wkbm like '%' || #{wkbh1} || '%'



	</select>
	<select id="getAbnormalReportList"  parameterType="Map" resultType="Map">
			select sj.hzxm,sj.nbbm,sj.ybbh,sj.sjid
	        from igams_sjxx sj
	        <where>
			sj.scbj = '0' and (sfsc = '0' or sfsc is null or sfsc = '')
			<if test="rq != null and rq != ''">
				and to_char(sj.bgrq,'yyyy-MM-dd') &gt;= #{rq}
			</if>
			<if test="time != null and time != ''">
				and to_char(sj.bgrq,'yyyy-MM-dd hh24:mi') &lt;= #{time}
			</if>
		</where>
		ORDER BY sj.bgrq
	</select>
	<select id="selectReportBySjid"  parameterType="String" resultType="SjxxDto">
		select tmp.sjid, tmp.ybbh,string_agg(tmp.zywid, ',') AS jclx,string_agg(tmp.zxmid, ',') AS jczlx
		from (
			select sjxx.sjid, sjxx.ybbh,jkdymx.zywid,jkdymx.zxmid
			from igams_sjxx sjxx
			left outer join matridx_jkdymx jkdymx on sjxx.ybbh = jkdymx.ywid and jkdymx.dyzfl='INVOKING_CHILD_REPORT'
			<where>
				sjxx.scbj = '0'
				and(1=2
				<if test="sjid != null and sjid!=''">
					or sjxx.sjid = #{sjid}
				</if>)
				<if test="sjid != null and sjid!=''">
					and jkdymx.zywid in (select jclx from igams_sjbgsm where sjid =#{sjid} group by jclx)
				</if>
				and jkdymx.dyid is not null
				group by sjxx.sjid, sjxx.ybbh,jkdymx.zywid,jkdymx.zxmid
			)tmp
			group by tmp.sjid, tmp.ybbh
		</where>
	</select>

	<update id="updateWbbmByList" parameterType="List">
		update igams_sjxx set wbbm=case when igams_sjxx.wbbm is null then tmp.wbbm else igams_sjxx.wbbm end
		from(
			<foreach collection="list" item="item" open="(" close=")" separator="union all">
				select #{item.ybbh} ybbh, #{item.wbbm} wbbm
			</foreach>
		)tmp where tmp.ybbh=igams_sjxx.ybbh
	</update>

	<select id="getFjByWjm" parameterType="Map" resultType="Map">
		select * from matridx_fjcfb where wjm=#{wjm} and ywid=#{ywid}
	</select>

	<select id="queryByYbbh" parameterType="SjxxDto" resultType="SjxxDto">
		select sj.sjid,sj.hzxm,sj.nl,sj.xb,sj.dh,sj.sjdw,sj.ks,sj.sjys,sj.ysdh,sj.db,sj.yblx,sj.yblxmc,
		sj.ybtj,sj.zyh,sj.ybbh,sj.cyrq,to_char(sj.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq, sj.bgrq,sj.lczz,sj.qqzd,sj.jqyy,sj.qqjc,sj.jyjg,sj.kdlx,sj.kdh,
		sj.bz,sj.lrry, sj.lrsj,sj.xgry,sj.xgsj,sj.scry,sj.scsj,sj.scbj,sj.syrq,sj.jt,sj.cskz1,sj.cskz2,sj.cskz3,sj.cskz4,sj.cskz5,sj.px,sj.sfje,sj.djcbj,sj.dsyrq,
		sj.sfsc,sj.sfzq,sj.lcfk,sj.yxbfk,sj.qyrq,sj.ydrq,sj.yjydrq,sj.jcdw,sj.cwh,sj.sfzmjc,sj.zmxm,sj.zmmdd,sj.wbbm,sj.q20,sj.q30,sj.qtsyrq,sj.qtjcbj,sj.sjqf,
		sj.kpsq,sj.sjdwmc,jcxm.jcxmid,jcxm.jczxmid,sj.kdfy,sj.tkje,sj.tksj,sj.tkfs,sj.kdbj,sj.jcjg,sj.ysjg
		from igams_sjxx sj
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		<where>
			sj.scbj= '0' and (sj.ybbh = #{ybbh} or sj.wbbm = #{ybbh})
		</where>
	</select>
</mapper>
