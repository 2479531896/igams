<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.wechat.dao.post.ISjxxStatisticDao">
	<!-- 微信统计按照标本个数进行统计（日报）-->
	<select id="getYbxxDaily" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(tmp.num, '0') AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) || '' AS num
						, CASE 
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf ='0' then '0' else '1' end
							ELSE '0'
						END AS sfsf, sjxx.sfjs
					FROM igams_sjxx sjxx
					WHERE sjxx.scbj = '0'
						<if test="dbs !=null and dbs.size() >0">
						AND sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						AND (sjxx.dsyrq IS NOT NULL
							OR sjxx.syrq IS NOT NULL
							OR (sjxx.jsrq IS NOT NULL
								AND sfjs = '0'))
						<if test="jsrq != null and jsrq !=''">
							AND (to_char(coalesce(sjxx.dsyrq, sjxx.syrq), 'yyyy-MM-dd') =#{jsrq}
								OR (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
									AND sfjs = '0'))
						</if>
					GROUP BY sfjs, CASE 
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf ='0' then '0' else '1' end
							ELSE '0'
						END
				) tmp
				ON sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs
			ORDER BY sjxx.sfsf, sjxx.sfjs				
	</select>
	<!-- 微信统计按照标本个数进行统计（日报）(接收日期)-->
	<select id="getYbxxDailyByJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(tmp.num, '0') AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT COUNT(sjxx.sjid) || '' AS num
						, CASE
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf ='0' then '0' else '1' end
							ELSE '0'
						END AS sfsf, sjxx.sfjs
					FROM igams_sjxx sjxx
					WHERE sjxx.scbj = '0'
						<if test="dbs !=null and dbs.size() >0">
						AND sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						AND sjxx.jsrq IS NOT NULL
						<if test="jsrq != null and jsrq !=''">
							AND to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
						</if>
					GROUP BY sfjs, CASE
							WHEN sjxx.sfjs = '1' THEN case when sjxx.sfsf ='0' then '0' else '1' end
							ELSE '0'
						END
				) tmp
				ON sjxx.sfsf = tmp.sfsf
					AND sjxx.sfjs = tmp.sfjs
			ORDER BY sjxx.sfsf, sjxx.sfjs
	</select>

	<!--  微信统计按照合作伙伴统计标本标本个数（日报） -->
	<select id="getYbxxBySjhbDaily" parameterType="SjxxDto" resultType="Map">
		with recursive t (sjhb, sfsf,sfjs,num) as (
			select sjhb.sjhb,sjhb.sfsf,sjhb.sfjs,COALESCE(tmp.num, 0) num from (
				<if test = "dbmcs != null and dbmcs.size() > 0 "  >
					<foreach collection="dbmcs" separator=" union all " open="(" close=") " item="item" index="index">
						select #{item} sjhb,'0' sfsf,'1' sfjs
							union all 
						select #{item} sjhb,'0' sfsf,'0' sfjs
							union all 
						select #{item} sjhb,'1' sfsf,'1' sfjs
					</foreach>
				</if>
			) sjhb
			left outer join (
				select db,sfsf,sfjs,sum(num) num from (
					select count(sjxx.sjid) as num,coalesce(hb.tjmc, hb.hbmc) db,
					     CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
					from igams_sjxx sjxx 
					left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		  			left outer join igams_sjjcxm xm on xm.sjid = sjxx.sjid and xm.scbj='0'
		  			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		  			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0'
							and (sjxx.dsyrq is not null
						or sjxx.syrq is not null
						or (sjxx.jsrq is not null
							and sfjs = '0'))
						AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						<if test="dbs !=null and dbs.size() >0">
								AND sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') =#{jsrq}
						or (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
							and sfjs = '0'))
					group by jc_xm.cskz1,coalesce(hb.tjmc, hb.hbmc),sjxx.sfjs,sjxx.sfsf,tt.xmjclx
				) t_p
				group by db,sfsf,sfjs
			)tmp on sjhb.sjhb=tmp.db and sjhb.sfsf=tmp.sfsf and sjhb.sfjs=tmp.sfjs
		)
		select t.sjhb,t.sfsf,t.sfjs,t.num||'' num,sum(t2.num) sa from t left outer join t as t2 on t.sjhb = t2.sjhb
		group by t.sjhb,t.sfsf,t.sfjs,t.num
		order by sa desc,t.sjhb,t.sfsf,t.sfjs
	</select>

	<!--  微信统计按照合作伙伴统计标本标本个数（日报）(接收日期) -->
	<select id="getYbxxBySjhbDailyAndJsrq" parameterType="SjxxDto" resultType="Map">
		with recursive t (sjhb, sfsf,sfjs,num) as (
			select sjhb.sjhb,sjhb.sfsf,sjhb.sfjs,COALESCE(tmp.num, 0) num from (
				<if test = "dbmcs != null and dbmcs.size() > 0 "  >
					<foreach collection="dbmcs" separator=" union all " open="(" close=") " item="item" index="index">
						select #{item} sjhb,'0' sfsf,'1' sfjs
							union all
						select #{item} sjhb,'0' sfsf,'0' sfjs
							union all
						select #{item} sjhb,'1' sfsf,'1' sfjs
					</foreach>
				</if>
			) sjhb
			left outer join (
				select db,sfsf,sfjs,sum(num) num from (
					select count(sjxx.sjid) as num,coalesce(hb.tjmc, hb.hbmc) db,
					     CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
					from igams_sjxx sjxx
					left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
		  			left outer join igams_sjjcxm xm on xm.sjid = sjxx.sjid and xm.scbj='0'
		  			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
		  			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0'
							and sjxx.jsrq is not null
							AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						<if test="dbs !=null and dbs.size() >0">
								AND sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
					and to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
					group by jc_xm.cskz1,coalesce(hb.tjmc, hb.hbmc),sjxx.sfjs,sjxx.sfsf,tt.xmjclx
				) t_p
				group by db,sfsf,sfjs
			)tmp on sjhb.sjhb=tmp.db and sjhb.sfsf=tmp.sfsf and sjhb.sfjs=tmp.sfjs
		)
		select t.sjhb,t.sfsf,t.sfjs,t.num||'' num,sum(t2.num) sa from t left outer join t as t2 on t.sjhb = t2.sjhb
		group by t.sjhb,t.sfsf,t.sfjs,t.num
		order by sa desc,t.sjhb,t.sfsf,t.sfjs
	</select>

	<!--  微信统计统计复检信息（日报）-->
	<select id="getFjsqDaily" parameterType="FjsqDto" resultType="Map">
		select lx,lxmc,fjlxdm,xh,count(sjid) from (
			select sjid,lx,lxmc,fjlxdm,max(xh) xh
			from (
				select fjsq.sjid,fjsq.lrsj,fjsq.lx,fjlx.csmc as lxmc,fjlx.csdm as fjlxdm,row_number() over(partition by fjsq.sjid,fjsq.lx order by fjsq.lrsj asc  ) xh from igams_fjsq fjsq
				left join igams_sjxx sjxx on sjxx.sjid=fjsq.sjid
				left join matridx_jcsj fjlx on fjlx.csid = fjsq.lx
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
					LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
					AND hbqx.yhid =#{yhid}
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
					AND sjhbxx.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
					where fjsq.zt !='00' and fjsq.zt !='15' and fjsq.scbj ='0'
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND sjhbxx.hbid IS NOT NULL
				</if>
				<if test="sjhbs !=null and sjhbs.size() >0">
					AND sjxx.db in
					<foreach collection="sjhbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
			) tmp 
			<where>
			   	<if test="lrsj!=null and lrsj !=''">
			   		and to_char(lrsj,'yyyy-MM-dd')=#{lrsj}
			   	</if>
				<if test="lrsjstart!=null and lrsjstart !=''">
			   		and to_char(lrsj,'yyyy-MM-dd')&gt;=#{lrsjstart}
			   	</if>
			   	<if test="lrsjend!=null and lrsjend !=''">
			   		and to_char(lrsj,'yyyy-MM-dd')&lt;=#{lrsjend}
			   	</if>
			   	<if test="lrsjMstart!=null and lrsjMstart !=''">
			   		and to_char(lrsj,'yyyy-MM')&gt;=#{lrsjMstart}
			   	</if>
			   	<if test="lrsjMend!=null and lrsjMend !=''">
			   		and to_char(lrsj,'yyyy-MM')&lt;=#{lrsjMend}
			   	</if>
			   		<if test="lrsjYstart!=null and lrsjYstart !=''">
			   		and to_char(lrsj,'yyyy')&gt;=#{lrsjYstart}
			   	</if>
			   	<if test="lrsjYend!=null and lrsjYend !=''">
			   		and to_char(lrsj,'yyyy')&lt;=#{lrsjYend}
			   	</if>
			</where> 
			group by sjid,lx,lxmc,fjlxdm
			) tp
			group by lx,xh,lxmc,fjlxdm
	</select>
	
	<!--微信统计废弃标本（日报） -->
	<select id="getFqybByYbztDaily" parameterType="SjxxDto" resultType="Map">
			select case when ybzt.zt is null then '0' when ybzt.zt is not null then ybzt.zt end zt,case when jcsj.csmc is null then '其他'  when jcsj.csmc is not null then jcsj.csmc end ybzt, count(sjxx.sjid) from igams_sjxx sjxx 
				left join igams_sjybzt ybzt on ybzt.sjid = sjxx.sjid
				left join matridx_jcsj jcsj on ybzt.zt=jcsj.csid
			<where>
				sjxx.scbj ='0' and sjxx.sfjs='0'
			<if test="dbs !=null and dbs.size() >0">
				AND sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrq!=null and jsrq!=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')=#{jsrq}
			</if>
			<if test="jsrqstart!=null and jsrqstart !=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')&gt;=#{jsrqstart}
			</if>
			<if test="jsrqend!=null and jsrqend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd')&lt;=#{jsrqend}
			</if>
			<if test="jsrqMstart!=null and jsrqMstart !=''">
				and to_char(sjxx.jsrq,'yyyy-MM')&gt;=#{jsrqMstart}
			</if>
			<if test="jsrqMend!=null and jsrqMend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM')&lt;=#{jsrqMend}
			</if>
			<if test="jsrqYstart!=null and jsrqYstart !=''">
				and to_char(sjxx.jsrq,'yyyy')&gt;=#{jsrqYstart}
			</if>
			<if test="jsrqYend!=null and jsrqYend !=''">
				and to_char(sjxx.jsrq,'yyyy')&lt;=#{jsrqYend}
			</if>
			group by ybzt,ybzt.zt
		</where>
	</select>
	
	<!-- 微信统计报告阳性率（日报） -->
	<select id="getJyjgDaily" parameterType="SjxxDto"  resultType="Map">
		select lx,count(sjid) num ,jyjg from (
			select sjxx.sjid,case when sjxx.jyjg ='1' then '阳性'  when sjxx.jyjg ='2' then '疑似' else '阴性' end lx,
			case when sjxx.jyjg ='1' then '1' when sjxx.jyjg ='2' then '2' else '3' end indd,sjxx.jyjg
			 from igams_sjxx sjxx 
			where sjxx.bgrq is not null and sjxx.scbj='0' and sjxx.sfsc ='1'
			<if test="dbs !=null and dbs.size() >0">
				AND sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(sjxx.bgrq,'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend != null and jsrqYend != ''">
				and to_char(sjxx.bgrq,'yyyy') &lt;= #{jsrqYend}
			</if>
			<if test="jsrq != null and jsrq != ''">
			and to_char(sjxx.bgrq,'yyyy-MM-dd') = #{jsrq}
			</if>
		) tmp 
		group by tmp.lx,indd,jyjg
		order by indd
	</select>
	
	<!--微信统计送检清单(日报) -->
	<select id="getSjxxListDaily" parameterType="SjxxDto" resultType="SjxxDto"> 
		select sjxx.sjdw,yy.dwmc yymc,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,
			case when sjxx.yblxmc is null then jcsj.csmc else sjxx.yblxmc end yblxmc,sjxx.db,
			case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否'  when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsf ,jc_xm.csmc jcxmmc
		from igams_sjxx sjxx
			left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			left join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
			left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
			left outer join igams_yyxx yy on sjxx.sjdw = yy.dwid
		<where>
			sjxx.scbj ='0'
			<if test="dbs !=null and dbs.size() >0">
				and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrq !=null and jsrq !=''">
				and to_char(coalesce(sjxx.dsyrq, sjxx.syrq), 'yyyy-MM-dd') = #{jsrq}
			</if>
			order by hb.tjmc,sjxx.db,sjxx.hzxm
		</where>
	</select>
	<!--微信统计送检清单(日报)(接收日期) -->
	<select id="getSjxxListDailyByJsrq" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjdw,yy.dwmc yymc,sjxx.sjdwmc,sjxx.ks,dwxx.dwmc,sjxx.yblx,
			case when sjxx.yblxmc is null then jcsj.csmc else sjxx.yblxmc end yblxmc,sjxx.db,
			case when sjxx.sfsf='1' then '是' when sjxx.sfsf='0' then '否'  when sjxx.sfsf='2' then '免  D' when  sjxx.sfsf='3' then '免  R' end sfsf ,jc_xm.csmc jcxmmc
		from igams_sjxx sjxx
			left join igams_sjdwxx dwxx on dwxx.dwid = sjxx.ks
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			left join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = jcxm.jcxmid
			left outer join igams_sjhbxx hb on hb.hbmc = sjxx.db and hb.scbj != '1'
			left outer join igams_yyxx yy on sjxx.sjdw = yy.dwid
		<where>
			sjxx.scbj ='0'
			<if test="dbs !=null and dbs.size() >0">
				and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrq !=null and jsrq !=''">
				and to_char(sjxx.jsrq, 'yyyy-MM-dd') = #{jsrq}
			</if>
			order by hb.tjmc,sjxx.db,sjxx.hzxm
		</where>
	</select>
	
	<!-- 微信统计检测项目次数 -->
	<select id="getJcxmSumDaily" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT count(sjxx.sjid) AS num
						, CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
                          else sjxx.sfsf end AS sfsf, sjxx.sfjs,xm.jcxmid,jc_xm.cskz1
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					<where>
						 sjxx.scbj = '0'
						 AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						<if test="dbs !=null and dbs.size() >0">
								and sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
							AND (sjxx.dsyrq IS NOT NULL
								OR sjxx.syrq IS NOT NULL
								OR (sjxx.jsrq IS NOT NULL
									AND sfjs = '0'))
						<if test="jsrq !=null and jsrq !=''">
							AND (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') =#{jsrq}
								OR (to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq} AND sfjs = '0'))
						</if>
						GROUP BY sfjs,sjxx.sfsf,xm.jcxmid,jc_xm.cskz1,tt.xmjclx
					) tmp
						ON sjxx.sfsf = tmp.sfsf
							AND sjxx.sfjs = tmp.sfjs
					group by sjxx.sfsf, sjxx.sfjs
					ORDER BY sjxx.sfsf, sjxx.sfjs
				</where>
	</select>
	<!-- 微信统计检测项目次数(接收日期) -->
	<select id="getJcxmSumDailyByJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT sjxx.sfsf, sjxx.sfjs, COALESCE(sum(tmp.num), 0) AS num
			FROM (
				SELECT '0' AS sfsf, '1' AS sfjs
				UNION ALL
				SELECT '0' AS sfsf, '0' AS sfjs
				UNION ALL
				SELECT '1' AS sfsf, '1' AS sfjs
			) sjxx
				LEFT JOIN (
					SELECT count(sjxx.sjid) AS num
						, CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
                          else sjxx.sfsf end AS sfsf, sjxx.sfjs,xm.jcxmid,jc_xm.cskz1
					FROM igams_sjxx sjxx
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					<where>
						 sjxx.scbj = '0'
						 AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						<if test="dbs !=null and dbs.size() >0">
								and sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
							AND sjxx.jsrq IS NOT NULL
						<if test="jsrq !=null and jsrq !=''">
							AND  to_char(sjxx.jsrq, 'yyyy-MM-dd') =#{jsrq}
						</if>
						GROUP BY sfjs,sjxx.sfsf,xm.jcxmid,jc_xm.cskz1,tt.xmjclx
					) tmp
						ON sjxx.sfsf = tmp.sfsf
							AND sjxx.sfjs = tmp.sfjs
					group by sjxx.sfsf, sjxx.sfjs
					ORDER BY sjxx.sfsf, sjxx.sfjs
				</where>
	</select>
	
	<!-- 微信统计收费项目检测项目条数（日报）-->
	<select id="getJcxmInSfsfDaily" parameterType="SjxxDto" resultType="Map">
		SELECT jcxmmc,sum(num) num from (
            SELECT jc_xm.csmc jcxmmc,COUNT(sjxx.sjid) AS num
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
            left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			<where> 
				sjxx.scbj = '0' and sjxx.sfsf != '0'
				AND (sjxx.dsyrq IS NOT NULL
					OR sjxx.syrq IS NOT NULL
					)
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrq !=null and jsrq !=''">
					AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') = #{jsrq}
				</if>
				GROUP BY jc_xm.csmc,jc_xm.cskz1,sjxx.sfsf
			</where>
		) tmp
        GROUP BY tmp.jcxmmc
	</select>
	<!-- 微信统计收费项目检测项目条数（日报）(接收日期)-->
	<select id="getJcxmInSfsfDailyByJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT jcxmmc,sum(num) num from (
            SELECT jc_xm.csmc jcxmmc,COUNT(sjxx.sjid) AS num
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
            left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			<where>
				sjxx.scbj = '0' and sjxx.sfsf != '0'
				AND sjxx.jsrq IS NOT NULL
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrq !=null and jsrq !=''">
					AND to_char(sjxx.jsrq, 'yyyy-MM-dd') = #{jsrq}
				</if>
				GROUP BY jc_xm.csmc,jc_xm.cskz1,sjxx.sfsf
			</where>
		) tmp
        GROUP BY tmp.jcxmmc
	</select>
	
	<!-- 微信统计标本数信息（周报） -->
	<select id="getSfsfByWeekly" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as cn,jcsj.csmc
			from igams_sjxx sjxx 
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			where sjxx.scbj='0' and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
			<if test="dbs !=null and dbs.size() >0">
					and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq), 'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
			</if>
			group by sjxx.yblx,jcsj.csmc
			order by cn desc
	</select>
	<!-- 微信统计标本数信息（周报）(接收日期) -->
	<select id="getSfsfByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as cn,jcsj.csmc
			from igams_sjxx sjxx
			left join matridx_jcsj jcsj on jcsj.csid=sjxx.yblx
			<if test="yhid != null and yhid != ''">
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
				AND sjhbxx.scbj != '1'
				LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
				AND hbqx.yhid= #{yhid}
			</if>
			<if test = "ptgss != null and ptgss.length > 0"  >
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
				AND sjhbxx.scbj != '1'
				AND sjhbxx.ptgs in
				<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
					#{item}
				</foreach>
			</if>
			where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
			<if test="yhid != null and yhid != ''">
				AND hbqx.hbid IS NOT NULL
			</if>
			<if test = "ptgss != null and ptgss.length > 0"  >
				AND sjhbxx.hbid IS NOT NULL
			</if>
			<if test="dbs !=null and dbs.size() >0">
					and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
			</if>
			group by sjxx.yblx,jcsj.csmc
			order by cn desc
	</select>
	
	<!-- 微信统计标本数信息（周报） -->
	<select id="getYbxxByWeekly" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all 
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq),'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	<!-- 微信统计标本数信息（周报）(接收日期) -->
	<select id="getYbxxByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
				left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
					AND hbqx.yhid =#{yhid}
				</if>
				where sjxx.scbj='0'  and sjxx.jsrq is not null
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.hbid IS NOT NULL
				</if>
				<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
					and jc_xm.cskz1 = #{jcxmdm}
				</if>
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	
	<!-- 微信统计标本数信息————按照周统计（周报） -->
	<select id="getybxx_weekByWeekly" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(tmp.num, '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all 
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs,
				case when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq),'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  #{jsrqstart}
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -7,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -14,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -21,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq,sjxx.jsrq) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx 
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
					and (to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
				</if>
				group by rqz,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	<!-- 微信统计标本数信息————按照周统计（周报）(接收日期) -->
	<select id="getybxx_weekByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq
		<if test="tj != null and tj != '' and tj != 'week'">
			,COALESCE(tmp.num, '0') num
		</if>
		<if test="tj != null and tj != '' and tj == 'week'">
			, cast(COALESCE(SUM(cast(tmp.num as numeric)),'0') as varchar) num
		</if>
		from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid)||'' as num,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs,
				<if test = "rqs != null and rqs.size > 0 ">
					case
					<foreach collection="rqs" item="item" index="index">
						when to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt; to_char(to_date(#{item},'yyyy-MM-dd') - 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') ,'yyyy-MM-dd')
					</foreach>
					else null
					end rqz
				</if>
				from igams_sjxx sjxx
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
                left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj='0'
				left outer join matridx_jcsj jc_xm on jcxm.jcxmid = jc_xm.csid
				where sjxx.scbj='0'  and sjxx.jsrq is not null
				<if test="jcxmdm != null and jcxmdm != '' and jcxmdm == 'F'.toString">
					and jc_xm.cskz1 = #{jcxmdm}
				</if>
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
				</if>
				group by rqz,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
				) tmp on  tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				<if test="tj != null and tj != '' and tj != 'week'">
					and tjrq.rq = tmp.rqz
				</if>
				<if test="tj != null and tj != '' and tj == 'week'">
					and cast(tjrq.rq as TIMESTAMP) &gt;= cast(tmp.rqz as TIMESTAMP) and (cast(tjrq.rq as TIMESTAMP)::timestamp - ('7 day')::interval) &lt;  cast(tmp.rqz as TIMESTAMP)
					GROUP BY tjrq.rq, tjrq.sfjs, tjrq.sfsf
				</if>
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	
	<!-- 微信统计测试数信息————D+R的算两个（周） -->
	<select id="getYbxxDRByWeekly" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(sum(tmp.num), '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all 
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
                          else sjxx.sfsf end sfsf,
			sjxx.sfjs,xm.jcxmid,jc_xm.cskz1
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0' and (sjxx.dsyrq is not null or sjxx.syrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart} and sfjs = '0'))
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend} or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend} and sfjs = '0'))
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart} or (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart} and sfjs = '0'))
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend} or (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend} and sfjs = '0'))
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart} or (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart} and sfjs = '0'))
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend} or (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend} and sfjs = '0'))
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq,sfjs,sjxx.sfsf,tt.xmjclx,jc_xm.cskz1,xm.jcxmid
				) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				group by tjrq.sfjs,tjrq.sfsf,tjrq.rq
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>

	<!-- 微信统计测试数信息————D+R的算两个（周）(接收日期) -->
	<select id="getYbxxDRByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sfjs,sfsf,rq,COALESCE(sum(num), '0') num from (
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test="rqs != null and rqs.size > 0 ">
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(xxdy_xmfl.dyid) as num,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
                          else sjxx.sfsf end sfsf,
				sjxx.sfjs,xm.jcxmid,jc_xm.cskz1
				<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
					,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
				</if>
				<if test="tj != null and tj != '' and tj=='mon'">
					,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
				</if>
				<if test="tj != null and tj != '' and tj=='year'">
					, to_char(sjxx.jsrq, 'yyyy') AS rq
				</if>
				from igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
				<if test = "yxxs != null and yxxs.length > 0"  >
					AND xxdy_xmfl.yxx in
					<foreach collection="yxxs" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
					AND hbqx.yhid= #{yhid}
				</if>
				where sjxx.scbj='0'  and sjxx.jsrq is not null
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.hbid IS NOT NULL
				</if>
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq,sfjs,sjxx.sfsf,tt.xmjclx,jc_xm.cskz1,xm.jcxmid
				) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select count(xxdy_xmfl.dyid) as num, fjsq.sfff sfsf,
		case when fjsq.scbj = '0' then '1' else '0' end sfjs,fjsq.jcxm,jc_xm.cskz1
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		where  fjsq.scbj != '1' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="yblx!=null and yblx!=''">
			and sjxx.yblx=#{yblx}
		</if>
		group by rq,fjsq.scbj,fjsq.sfff,tt.xmjclx,jc_xm.cskz1,fjsq.jcxm
		) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs

		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select SUM(cast(wbtj.css as numeric)) as num, wbtj.sfsf ,
		 '1' sfjs,wbtj.jcxm,jc_xm.cskz1
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(wbtj.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(wbtj.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(wbtj.jsrq, 'yyyy') AS rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		where  wbtj.scbj = '0'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and hb.hbmc in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		group by rq,wbtj.sfsf,jc_xm.cskz1,wbtj.jcxm
		) tmp on tjrq.rq = tmp.rq and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		) tab
		group by sfjs,sfsf,rq
		order by rq,sfjs,sfsf
	</select>

	<!-- 微信周统计测试数信息 -->
	<select id="getYbxxDR_weeek" parameterType="SjxxDto" resultType="Map">
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,COALESCE(sum(tmp.num), '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all 
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
                          else sjxx.sfsf end sfsf,sjxx.sfjs,xm.jcxmid,jc_xm.cskz1,
				case when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}  
				 and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  #{jsrqstart}
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
				 and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -7,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
				 and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -14,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
				 and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -21,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
				 and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx 
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null or (sjxx.jsrq is not null and sfjs = '0'))
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd') and sfjs = '0'))
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') or (to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd') and sfjs = '0'))
				</if>
				group by rqz,sfjs,sjxx.sfsf,tt.xmjclx,xm.jcxmid,jc_xm.cskz1
				) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
				group by tjrq.sfjs,tjrq.sfsf,tjrq.rq
				order by tjrq.rq,tjrq.sfjs,tjrq.sfsf
	</select>
	<!-- 微信周统计测试数信息(接收日期) -->
	<select id="getYbxxDR_weeekByJsrq" parameterType="SjxxDto" resultType="Map">
		select sfjs,sfsf,rq,COALESCE(sum(num), '0') num from (
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
			select count(xxdy_xmfl.dyid) as num,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
                          else sjxx.sfsf end sfsf,sjxx.sfjs,xm.jcxmid,jc_xm.cskz1,
				<if test = "rqs != null and rqs.size > 0 ">
					case
					<foreach collection="rqs" item="item" index="index">
						when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
					</foreach>
					else null
					end rqz
				</if>
				from igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
				left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
				<if test = "yxxs != null and yxxs.length > 0"  >
					AND xxdy_xmfl.yxx in
					<foreach collection="yxxs" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
					AND hbqx.yhid= #{yhid}
				</if>
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0'  and sjxx.jsrq is not null
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hb.hbid IS NOT NULL
				</if>
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
				</if>
				group by rqz,sfjs,sjxx.sfsf,tt.xmjclx,xm.jcxmid,jc_xm.cskz1
				) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select count(xxdy_xmfl.dyid) as num, fjsq.sfff sfsf,
		case when fjsq.scbj = '0' then '1' else '0' end sfjs,fjsq.jcxm,jc_xm.cskz1,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rqz
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where  fjsq.scbj != '1' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
		</if>
		group by rqz,fjsq.scbj,fjsq.sfff,tt.xmjclx,fjsq.jcxm,jc_xm.cskz1
		) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs

		union all
		select tjrq.sfjs,tjrq.sfsf,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
					 item="item" index="index">
				select #{item} rq,'0' sfsf,'1' sfjs
				union all
				select #{item} rq,'0' sfsf,'0' sfjs
				union all
				select #{item} rq,'1' sfsf,'1' sfjs
			</foreach>
		</if> tjrq
		left outer join (
		select SUM(cast(wbtj.css as numeric)) as num, wbtj.sfsf,
		'1' sfjs,wbtj.jcxm,jc_xm.cskz1,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rqz
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		where  wbtj.scbj = '0'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and hb.hbmc in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
		</if>
		group by rqz,wbtj.sfsf,wbtj.jcxm,jc_xm.cskz1
		) tmp on tjrq.rq = tmp.rqz and tmp.sfsf = tjrq.sfsf and tmp.sfjs = tjrq.sfjs
		) tab
		group by sfjs,sfsf,rq
		order by rq,sfjs,sfsf
	</select>
	
	<!-- 微信统计收费标本的测试数信息（周）-->
	<select id="getYbxxTypeByWeekly" parameterType="SjxxDto"  resultType="Map">
		select tjrq.jcxm,tjrq.rq,COALESCE(sum(tmp.num), '0') num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all 
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT case when jc_xm.cskz1='C' then 'D+R' when jc_xm.cskz1='D' then 'DNA' when jc_xm.cskz1='R' then 'RNA' end jcxmdm,
        COUNT(sjxx.sjid)  AS num
			<if test="jsrqstart != null and jsrqstart != ''">
				,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') rq
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') rq
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') rq
			</if>
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
            left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
			left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
            WHERE sjxx.scbj = '0' and sjxx.sfsf != '0' AND sjxx.sfjs ='1'
            AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
			<if test="dbs !=null and dbs.size() >0">
					and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf != null and sf != ''.toString()">
                  and hb.sf=#{sf}
            </if>
				AND (sjxx.dsyrq IS NOT NULL OR sjxx.syrq IS NOT NULL)
			<if test="jsrqstart != null and jsrqstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart})
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend})
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart})
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend})
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart})
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend})
			</if>
			GROUP BY jc_xm.cskz1,rq,sjxx.sfsf
        ) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmdm
			group by tjrq.rq,tjrq.jcxm
			order by tjrq.rq,tjrq.jcxm
	</select>
	<!-- 微信统计收费标本的测试数信息（周）(接收日期)-->
	<select id="getYbxxTypeByWeeklyAndJsrq" parameterType="SjxxDto"  resultType="Map">
		select jcxm,rq,COALESCE(sum(num), '0') num from (
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test="rqs != null and rqs.size > 0 ">
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT
		case WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		when jc_xm.cskz1='C' then 'D+R'
		when jc_xm.cskz1='D' then 'DNA'
		when jc_xm.cskz1='R' then 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,
        COUNT(xxdy_xmfl.dyid)  AS num
			<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
				,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
			</if>
			<if test="tj != null and tj != '' and tj=='mon'">
				,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
			</if>
			<if test="tj != null and tj != '' and tj=='year'">
				, to_char(sjxx.jsrq, 'yyyy') AS rq
			</if>
			FROM igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
			left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
			<if test = "yxxs != null and yxxs.length > 0"  >
				AND xxdy_xmfl.yxx in
				<foreach collection="yxxs" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
            left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
			<if test = "ptgss != null and ptgss.length > 0"  >
				AND hb.ptgs in
				<foreach collection="ptgss" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
			<if test="yhid != null and yhid != ''">
				LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
				AND hbqx.yhid= #{yhid}
			</if>
            WHERE sjxx.scbj = '0' and sjxx.sfsf != '0' AND sjxx.sfjs ='1'
			<if test="yhid != null and yhid != ''">
				AND hbqx.hbid IS NOT NULL
			</if>
			<if test = "ptgss != null and ptgss.length > 0"  >
				AND hb.hbid IS NOT NULL
			</if>
			<if test="dbs !=null and dbs.size() >0">
					and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf != null and sf != ''.toString()">
                  and hb.sf=#{sf}
            </if>
				AND sjxx.jsrq IS NOT NULL
			<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
				and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
				and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart})
			</if>
			<if test="jsrqYend !=null and jsrqYend !=''">
				and (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend})
			</if>
			GROUP BY jc_xm.cskz1,rq,sjxx.sfsf,jc_xm.cskz4
        ) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmdm
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT case
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		when jc_xm.cskz1='C' then 'D+R'
		when jc_xm.cskz1='D' then 'DNA'
		when jc_xm.cskz1='R' then 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,
		COUNT(xxdy_xmfl.dyid)  AS num
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(sjxx.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(sjxx.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(sjxx.jsrq, 'yyyy') AS rq
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		WHERE fjsq.scbj = '0' and fjsq.sfff = '1' AND fjsq.zt ='80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart})
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend})
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmdm

		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT case
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		when jc_xm.cskz1='C' then 'D+R'
		when jc_xm.cskz1='D' then 'DNA'
		when jc_xm.cskz1='R' then 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmdm,
		SUM(cast(wbtj.css as numeric))  AS num
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			,to_char(wbtj.jsrq, 'yyyy-MM-dd') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='mon'">
			,to_char(wbtj.jsrq, 'yyyy-MM') AS rq
		</if>
		<if test="tj != null and tj != '' and tj=='year'">
			, to_char(wbtj.jsrq, 'yyyy') AS rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		where  wbtj.scbj = '0' and wbtj.sfsf = '1'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.hbid IS NOT NULL
		</if>
		<if test="dbs !=null and dbs.size() >0">
			and hb.hbmc in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != '' and (tj == 'day' or tj == 'week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !='' and (tj == 'day' or tj == 'week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and (to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart})
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and (to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend})
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and (to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart})
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and (to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend})
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmdm
		) tab
		group by rq,jcxm
		order by rq,jcxm
	</select>
	
	<!-- 微信按照周统计收费标本的测试数信息 -->
	<select id="getYbxxType_week" parameterType="SjxxDto"  resultType="Map">
		select tjrq.jcxm,tjrq.rq,COALESCE(sum(tmp.num), '0') num from 
			<if test = "rqs != null and rqs.size > 0 "  >
				<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
					select #{item} rq,'D+R' jcxm
					union all 
					select #{item} rq,'RNA' jcxm
					union all
					select #{item} rq,'DNA' jcxm
				</foreach>
			</if> tjrq
			left outer join (
				SELECT case when jc_xm.cskz1='C' then 'D+R' when jc_xm.cskz1='D' then 'DNA' when jc_xm.cskz1='R' then 'RNA' end jcxmmc,
            	COUNT(sjxx.sjid) AS num,
				case when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
					else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}  
				  and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				  	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  #{jsrqstart}
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and
				 		 to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 		 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -7,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and
				 		 to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 		 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -14,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and
				 		 to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 		 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -21,'yyyy-MM-dd')
				 when to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and
				 		 to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
				 		 	else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
				end rq
				FROM igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
                left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
                WHERE sjxx.scbj = '0' and sjxx.sfsf != '0'
                AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
					AND (sjxx.dsyrq IS NOT NULL OR sjxx.syrq IS NOT NULL)
				<if test="jsrqstart != null and jsrqstart != ''">
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd'))
					and (to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq  when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd'))
				</if>
				GROUP BY jc_xm.cskz1,rq,sjxx.sfsf
			) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmmc
				group by tjrq.rq,tjrq.jcxm
				order by tjrq.rq,tjrq.jcxm
	</select>
	<!-- 微信按照周统计收费标本的测试数信息(接收日期) -->
	<select id="getYbxxType_weekByJsrq" parameterType="SjxxDto"  resultType="Map">
		select jcxm,rq,COALESCE(sum(num), '0') num from (
		select tjrq.jcxm,tjrq.rq,tmp.num from
			<if test = "rqs != null and rqs.size > 0 "  >
				<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
					select #{item} rq,'D+R' jcxm
					union all
					select #{item} rq,'RNA' jcxm
					union all
					select #{item} rq,'DNA' jcxm
					union all
					select #{item} rq,'R' jcxm
					union all
					select #{item} rq,'Once' jcxm
					union all
					select #{item} rq,'tNGS' jcxm
				</foreach>
			</if> tjrq
			left outer join (
				SELECT case
				WHEN jc_xm.cskz1 = 'O' THEN 'Once'
				WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
				when jc_xm.cskz1='C' then 'D+R'
				when jc_xm.cskz1='D' then 'DNA'
				when jc_xm.cskz1='R' then 'RNA'
				WHEN jc_xm.cskz1 = 'F' THEN 'R' end jcxmmc,
            	COUNT(xxdy_xmfl.dyid) AS num,
				<if test = "rqs != null and rqs.size > 0 ">
					case
					<foreach collection="rqs" item="item" index="index">
						when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
					</foreach>
					else null
					end rq
				</if>
				FROM igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and (xm.scbj!='1' or xm.scbj is null)
				left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = xm.jcxmid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
				<if test = "yxxs != null and yxxs.length > 0"  >
					AND xxdy_xmfl.yxx in
					<foreach collection="yxxs" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
                left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
				left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
                WHERE sjxx.scbj = '0' and sjxx.sfsf != '0'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="sf != null and sf != ''.toString()">
                    and hb.sf=#{sf}
                </if>
					AND sjxx.jsrq IS NOT NULL
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
				</if>
				GROUP BY jc_xm.cskz1,rq,sjxx.sfsf,jc_xm.cskz4
			) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmmc
		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT case
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		when jc_xm.cskz1='C' then 'D+R'
		when jc_xm.cskz1='D' then 'DNA'
		when jc_xm.cskz1='R' then 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R' end jcxmmc,
		COUNT(xxdy_xmfl.dyid) AS num,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rq
		</if>
		from igams_fjsq fjsq
		left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
		left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
		left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
		left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		left outer join igams_sjhbxx hb on sjxx.db=hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_sf on hb.sf=jc_sf.csid
		WHERE fjsq.scbj = '0' and fjsq.sfff = '1' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmmc

		union all
		select tjrq.jcxm,tjrq.rq,tmp.num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=")" item="item" index="index">
				select #{item} rq,'D+R' jcxm
				union all
				select #{item} rq,'RNA' jcxm
				union all
				select #{item} rq,'DNA' jcxm
				union all
				select #{item} rq,'R' jcxm
				union all
				select #{item} rq,'Once' jcxm
				union all
				select #{item} rq,'tNGS' jcxm
			</foreach>
		</if> tjrq
		left outer join (
		SELECT case
		WHEN jc_xm.cskz1 = 'O' THEN 'Once'
		WHEN jc_xm.cskz4 = 'T' THEN 'tNGS'
		when jc_xm.cskz1='C' then 'D+R'
		when jc_xm.cskz1='D' then 'DNA'
		when jc_xm.cskz1='R' then 'RNA'
		WHEN jc_xm.cskz1 = 'F' THEN 'R'
		end jcxmmc,
		SUM(cast(wbtj.css as numeric)) AS num,
		<if test = "rqs != null and rqs.size > 0 ">
			case
			<foreach collection="rqs" item="item" index="index">
				when to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{item}  and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd') then  to_char(to_date(#{item},'yyyy-MM-dd') + 7,'yyyy-MM-dd')
			</foreach>
			else null
			end rq
		</if>
		from igams_wbtjgl wbtj
		left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
		right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xmfl.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
		where  wbtj.scbj = '0' and wbtj.sfsf = '1'
		<if test="dbs !=null and dbs.size() >0">
			and hb.hbmc in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf != null and sf != ''.toString()">
			and hb.sf=#{sf}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd'),'yyyy-MM-dd')
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd'),'yyyy-MM-dd')
		</if>
		GROUP BY jc_xm.cskz1,rq,jc_xm.cskz4
		) tmp on tjrq.rq=tmp.rq and tjrq.jcxm=tmp.jcxmmc
		) tab
		group by rq,jcxm
		order by rq,jcxm
	</select>
	
	<!-- 微信统计上上周的临床反馈结果 -->
	<select id="getLcfkOfBeforeWeekly" parameterType="SjxxDto" resultType="Map">
			select tjnr.sfzq,COALESCE(sum(tmp.num), '0') as num from
			(select '错误' sfzq
				union all 
   			select '正确' sfzq
				union all
			select '未反馈' sfzq
			) tjnr
		 left join (
		 select count(sjxx.sjid) as num ,case when sjxx.sfzq='0' then '错误' when sjxx.sfzq='1' then '正确' when  sjxx.sfzq is null then '未反馈' end sfzq from igams_sjxx sjxx 
			where sjxx.scbj='0' and sjxx.sfjs='1' and sjxx.db in (
				select sjhb.hbmc from igams_hbqx hbqx
				left join igams_sjhbxx sjhb on sjhb.hbid=hbqx.hbid and sjhb.scbj != '1'
				left join matridx_jcsj jc_hb on jc_hb.csid=sjhb.fl
				where
				hbqx.yhid=#{yhid}
				and jc_hb.cskz1 is not null
			)
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			group by  sjxx.sfzq
			order by sjxx.sfzq
		 )tmp 
		 on tmp.sfzq=tjnr.sfzq
		 group by tjnr.sfzq
	</select>
	
	<!-- 微信统计标本前三的阳性率（周） -->
	<select id="getJyjgWeekly" parameterType="SjxxDto" resultType="Map">
		select tmp_yb.csmc as yblx,tmp_yb.jyjg,case when sum is null then '0' when sum is not null then sum end sum ,case when num is null then '0' when num is not null then num end num from (
  			select jc.csid,jc.csmc,tmp.jyjg from matridx_jcsj jc 
  			left outer join  (select '阴性' jyjg union all select '阳性' jyjg union all select '疑似' jyjg) tmp on 1 =1
  					where jc.jclb ='WECGATSAMPLE_TYPE' and jc.scbj ='0' and cskz1 !='1'
  				) tmp_yb left outer join (
			SELECT  COUNT(sjxx.sjid) AS num, SUM(COUNT(sjxx.sjid)) OVER (PARTITION BY case when jc_yb.cskz1 = '1' then sjxx.yblxmc else jc_yb.csmc end), 
				case when jc_yb.cskz1 = '1' then sjxx.yblxmc else jc_yb.csmc end AS yblxmc,sjxx.yblx,
				CASE WHEN sjxx.jyjg = '0' THEN '阴性' WHEN sjxx.jyjg = '1' THEN '阳性'WHEN sjxx.jyjg = '2' THEN '疑似' END AS jyjg
					FROM  igams_sjxx sjxx 
  				LEFT JOIN matridx_jcsj jc_yb ON jc_yb.csid = sjxx.yblx
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
					LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
					AND hbqx.yhid= #{yhid}
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
					AND sjhbxx.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") "
							 item="item" index="index">
						#{item}
					</foreach>
				</if>
			<where> sjxx.scbj = '0' and jc_yb.cskz1 !='1'
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND sjhbxx.hbid IS NOT NULL
				</if>
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
  				<if test="bgrqstart!=null and bgrqstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&gt;=#{bgrqstart}
				</if>
				<if test="bgrqend!=null and bgrqend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM-dd')&lt;=#{bgrqend}
				</if>
				<if test="bgrqMstart!=null and bgrqMstart!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&gt;=#{bgrqMstart}
				</if>
				<if test="bgrqMend!=null and bgrqMend!=''">
                    and to_char(sjxx.bgrq,'yyyy-MM')&lt;=#{bgrqMend}
				</if>
				<if test="bgrqYstart!=null and bgrqYstart!=''">
                    and to_char(sjxx.bgrq,'yyyy')&gt;=#{bgrqYstart}
				</if>
				<if test="bgrqYend!=null and bgrqYend!=''">
                    and to_char(sjxx.bgrq,'yyyy')&lt;=#{bgrqYend}
				</if>
			GROUP BY case when jc_yb.cskz1 = '1' then sjxx.yblxmc else jc_yb.csmc end, sjxx.jyjg,sjxx.yblx ) sj
      		on tmp_yb.csid = sj.yblx and tmp_yb.jyjg = sj.jyjg
      		ORDER BY yblx desc,jyjg,sum desc
      	</where>
	</select>
	<!-- 微信统计送检科室（周）-->
	<select id="getKsByWeekly" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as num,sjdw.dwmc from igams_sjxx sjxx
			left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
			<where>
				sjxx.scbj='0' and sjxx.sfjs ='1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				group by sjdw.dwmc
				order by sjdw.dwmc
			</where>
	</select>
	<!-- 微信统计送检科室（周）(接收日期)-->
	<select id="getKsByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select count(sjxx.sjid) as num,sjdw.dwmc from igams_sjxx sjxx
			left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
			<where>
				sjxx.scbj='0' and sjxx.sfjs ='1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				group by sjdw.dwmc
				order by sjdw.dwmc
			</where>
	</select>
	
	<!-- 微信统计合作医疗结构（周） -->
	<select id="getCooperativeWeekly" parameterType="SjxxDto" resultType="Map">
			select count(tmp.sjdw) as num from 
				(select sjxx.sjdw  from igams_sjxx sjxx where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				 group by sjxx.sjdw) tmp
					union all
			select count(tmp.sjys) as num from 
				(select sjxx.sjys from igams_sjxx sjxx where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				  group by sjxx.sjys ) tmp
					union all
			select count(tmp.qtks) as num from
			 	(select CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END AS qtks from igams_sjxx sjxx
					left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
					where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
					</if>
			 	group by CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END
				 ) tmp
	</select>
	<!-- 微信统计合作医疗结构（周）(接收日期) -->
	<select id="getCooperativeWeeklyByJSrq" parameterType="SjxxDto" resultType="Map">
			select count(tmp.sjdw) as num from
				(select sjxx.sjdw  from igams_sjxx sjxx where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
				 group by sjxx.sjdw) tmp
					union all
			select count(tmp.sjys) as num from
				(select sjxx.sjys from igams_sjxx sjxx where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
				  group by sjxx.sjys ) tmp
					union all
			select count(tmp.qtks) as num from
			 	(select CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END AS qtks from igams_sjxx sjxx
					left join igams_sjdwxx sjdw on sjdw.dwid=sjxx.ks
					where sjxx.scbj='0'
					<if test="dbs !=null and dbs.size() >0">
							and sjxx.db in
						<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
			 	group by CASE WHEN sjxx.qtks IS NULL THEN sjdw.dwmc ELSE sjxx.qtks END
				 ) tmp
	</select>

	<!-- 微信统计合作伙伴 -->
	<select id="getSjhbByWeekly" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx 
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and hbxx.scbj != '1'
						left outer join igams_hbqx hbqx on hbqx.hbid=hbxx.hbid
						where sjxx.scbj='0' and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
						<if test="dbs !=null and dbs.size() >0">
								and sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="dwxzbj != null and dwxzbj == '1'">
							and hbqx.yhid=#{yhid}
						</if>
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend !=null and jsrqYend !=''">
							and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc)
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	<!-- 微信统计合作伙伴(接收日期) -->
	<select id="getSjhbByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select sum(num) num,case when indx &lt;=8 then mc else 'other' end mc,case when indx &lt;=8 then '1' else '0' end ind from (
			select  count(sjxx.db) as num,coalesce(hbxx.tjmc,hbxx.hbmc) as mc,row_number() over(order by count(sjxx.db) desc) indx
						from igams_sjxx sjxx
						left outer join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and hbxx.scbj != '1'
						left outer join igams_hbqx hbqx on hbqx.hbid=hbxx.hbid
						where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
						<if test="dbs !=null and dbs.size() >0">
								and sjxx.db in
							<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="dwxzbj != null and dwxzbj == '1'">
							and hbqx.yhid=#{yhid}
						</if>
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend !=null and jsrqYend !=''">
							and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
						</if>
						group by coalesce(hbxx.tjmc,hbxx.hbmc)
			) tmp group by case when indx &lt;=8 then mc else 'other' end,case when indx &lt;=8 then '1' else '0' end
		order by ind desc,num desc
	</select>
	
	<!--微信统计标本个数 -->
	<select id="getYblxByJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>
	<!--微信统计标本个数(接收日期) -->
	<select id="getYblxByJsrqAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx
				where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by rq
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>
	
	<!--微信统计报告数量（周） -->
	<select id="getSjbgByBgrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="bgrqstart != null and bgrqstart != ''">
					,to_char(sjxx.bgrq,'yyyy-MM-dd') rq
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					,to_char(sjxx.bgrq,'yyyy-MM') rq
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					,to_char(sjxx.bgrq,'yyyy') rq
				</if>
				from igams_sjxx sjxx 
				where sjxx.scbj='0'  and sjxx.bgrq is not null and sjxx.sfsc ='1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="bgrqstart != null and bgrqstart != ''">
					and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{bgrqstart}
				</if>
				<if test="bgrqend !=null and bgrqend !=''">
					and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{bgrqend}
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{bgrqMstart}
				</if>
				<if test="bgrqMend !=null and bgrqMend !=''">
					and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{bgrqMend}
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					and to_char(sjxx.bgrq,'yyyy') &gt;= #{bgrqYstart}
				</if>
				<if test="bgrqYend !=null and bgrqYend !=''">
					and to_char(sjxx.bgrq,'yyyy') &lt;= #{bgrqYend}
				</if>
				<if test="yblx!=null and yblx!=''">
					and sjxx.yblx=#{yblx}
				</if>
				group by 
				<if test="bgrqstart != null and bgrqstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM-dd')
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM')
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					to_char(sjxx.bgrq,'yyyy')
				</if>
				) tmp on tjrq.rq = tmp.rq
				order by tjrq.rq
	</select>
	
	<!-- 微信统计每天标本的阳性率（周） -->
	<select id="getJyjgBybgrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
			<if test = "rqs != null and rqs.size > 0 "  >
			  <foreach collection="rqs" separator=" union all " open="(" close=") "
			  item="item" index="index">
			    select #{item} rq
			  </foreach>
			</if> tjrq
			left outer join (
			   select 
			   bgrq,
				sum(lx),count(sjid),round(cast (sum(lx) as numeric )/cast (count(sjid) as numeric ),2) num from (
			    select sjxx.sjid,
				<if test="bgrqstart != null and bgrqstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM-dd') bgrq,
				</if>
				<if test="bgrqMstart != null and bgrqMstart != ''">
					to_char(sjxx.bgrq,'yyyy-MM') bgrq,
				</if>
				<if test="bgrqYstart != null and bgrqYstart != ''">
					to_char(sjxx.bgrq,'yyyy') bgrq,
				</if>
				case when wz.sjid is not null then 1 else 0 end lx
			    from igams_sjxx sjxx 
			    left outer join (select sjid from igams_sjwzxx group by sjid ) wz on sjxx.sjid = wz.sjid
			    where sjxx.bgrq is not null and sjxx.scbj='0'
			    <if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
			    <if test="jsrqstart != null and jsrqstart != ''">
			      and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			    </if>
			    <if test="jsrqend !=null and jsrqend !=''">
			      and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			    </if>
			    <if test="jsrqMstart != null and jsrqMstart != ''">
			      and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{jsrqMstart}
			    </if>
			    <if test="jsrqMend !=null and jsrqMend !=''">
			      and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{jsrqMend}
			    </if>
			    <if test="jsrqYstart != null and jsrqYstart != ''">
			      and to_char(sjxx.bgrq,'yyyy') &gt;= #{jsrqYstart}
			    </if>
			    <if test="jsrqYend != null and jsrqYend != ''">
			      and to_char(sjxx.bgrq,'yyyy') &lt;= #{jsrqYend}
			    </if>
			  ) tt 
			  group by tt.bgrq
			)   tmp on tjrq.rq = tmp.bgrq
			        order by tjrq.rq
	</select>
	
	<!--微信按照周统计标本个数（周） -->
	<select id="getYbxxnumByWeekly" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				case when to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(coalesce(sjxx.dsyrq,sjxx.syrq) + '-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  #{jsrqstart}
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -7,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -14,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -21,'yyyy-MM-dd')
				 when to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(coalesce(sjxx.dsyrq,sjxx.syrq) +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx 
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs ='1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and  to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd')
				</if>
				group by rqz
				) tmp on tjrq.rq = tmp.rqz
				order by tjrq.rq
	</select>
	<!--微信按照周统计标本个数（周）(接收日期) -->
	<select id="getYbxxnumByWeeklyAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.rq,COALESCE(tmp.num,0) num from
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				case when to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(sjxx.jsrq + '-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  #{jsrqstart}
				 when to_char(sjxx.jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -7,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -14,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -21,'yyyy-MM-dd')
				 when to_char(sjxx.jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(sjxx.jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
				end rqz
				from igams_sjxx sjxx
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs ='1'
				<if test="dbs !=null and dbs.size() >0">
						and sjxx.db in
					<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and  to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') +6,'yyyy-MM-dd')
				</if>
				group by rqz
				) tmp on tjrq.rq = tmp.rqz
				order by tjrq.rq
	</select>

	<!-- 微信统计检验结果（阴性，阳性，疑似） -->
	<select id="getJyjgLxByWeekly" parameterType="SjxxDto"  resultType="Map">
		select lx,count(sjid) num ,jyjg from (
			select sjxx.sjid,case when sjxx.jyjg ='1' then '阳性'  when sjxx.jyjg ='2' then '疑似' else '阴性' end lx,
			case when sjxx.jyjg ='1' then '1' when sjxx.jyjg ='2' then '2' else '3' end indd,sjxx.jyjg
			 from igams_sjxx sjxx
			<if test="yhid != null and yhid != ''">
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
				LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
				AND hbqx.yhid = #{yhid}
			</if>
			<if test = "ptgss != null and ptgss.length > 0"  >
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
				AND sjhbxx.ptgs in
				<foreach collection="ptgss" separator="," open="(" close=") "
						 item="item" index="index">
					#{item}
				</foreach>
			</if>
			where sjxx.bgrq is not null and sjxx.scbj='0' and sjxx.sfsc ='1'
			<if test="yhid != null and yhid != ''">
				AND hbqx.hbid IS NOT NULL
			</if>
			<if test = "ptgss != null and ptgss.length > 0"  >
				AND sjhbxx.hbid IS NOT NULL
			</if>
			<if test="dbs !=null and dbs.size() >0">
					and sjxx.db in
				<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="jsrqstart != null and jsrqstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			</if>
			<if test="jsrqend !=null and jsrqend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM-dd') &lt;= #{jsrqend}
			</if>
			<if test="jsrqMstart != null and jsrqMstart != ''">
				and to_char(sjxx.bgrq,'yyyy-MM') &gt;= #{jsrqMstart}
			</if>
			<if test="jsrqMend !=null and jsrqMend !=''">
				and to_char(sjxx.bgrq,'yyyy-MM') &lt;= #{jsrqMend}
			</if>
			<if test="jsrqYstart != null and jsrqYstart != ''">
				and to_char(sjxx.bgrq,'yyyy') &gt;= #{jsrqYstart}
			</if>
			<if test="jsrqYend != null and jsrqYend != ''">
				and to_char(sjxx.bgrq,'yyyy') &lt;= #{jsrqYend}
			</if>
			<if test="bgrq != null and bgrq != ''">
			and to_char(sjxx.bgrq,'yyyy-MM-dd') = #{bgrq}
			</if>
		) tmp 
		group by tmp.lx,indd,jyjg
		order by indd
	</select>
	
	<!-- 微信周报按照日期和代表名统计报告数量 -->
	<select id="getSjhbFlByWeekly" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			select hbid,db,rq,hb.fl,sfsf,sfjs from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd')  rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM')  rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy')  rq
				</if>,sjxx.db,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0' and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when sfjs = '0' then sjxx.jsrq when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy')
				</if>,sfjs,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0' 
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1' 
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0' 
	                          else sjxx.sfsf end 
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>
	<!-- 微信周报按照日期和代表名统计报告数量(接收日期) -->
	<select id="getSjhbFlByWeeklyAndJSrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
			select hbqx.hbid,hb.hbmc db,rq,hb.fl,sfsf,sfjs from (
			<if test = "rqs != null and rqs.size > 0 "  >
				<foreach collection="rqs" separator=" union all "
						 item="itemrq" index="indexrq">
					<if test="sfflg == null or sfflg ==''">
						select  '0' sfsf,'1' sfjs, #{itemrq} rq
						union all
						select '1' sfsf,'1' sfjs, #{itemrq} rq
					</if>
					<if test="sfflg == '0'.toString()">
						select  '0' sfsf,'1' sfjs, #{itemrq} rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs, #{itemrq} rq
					</if>
				</foreach>
			</if>
			) te
			left outer join igams_hbqx hbqx on hbqx.yhid = #{yhid}
			LEFT JOIN igams_sjhbxx hb ON hbqx.hbid = hb.hbid and hb.scbj != '1'
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd')  rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM')  rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy')  rq
				</if>,sjxx.db,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
	                          else sjxx.sfsf end sfsf,sjxx.sfjs
				from igams_sjxx sjxx
				left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
				left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				group by sjxx.db
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy')
				</if>,sfjs,CASE WHEN tt.xmjclx = 'D' and sjxx.sfsf = '2' then '0'
	                          when tt.xmjclx = 'D' and sjxx.sfsf = '3' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '2' then '1'
	                          when tt.xmjclx = 'R' and sjxx.sfsf = '3' then '0'
	                          else sjxx.sfsf end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>

	<select id="getHbflTestCountStatistics" parameterType="SjxxDto" resultType="Map">
		SELECT ''||count
		(tmp.sjid) AS num,
		tmp.rq,
		tmp.yxx,
		tmp.sfsf
		FROM(
		(
		SELECT
		sjxx.sjid,
		<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
			to_char(sjxx.jsrq + cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
			to_char( sjxx.jsrq, 'yyyy' ) rq,
		</if>
		xxdy_hb.yxx,
		CASE

		WHEN
		(
		sjxx.sfsf = '1'
		OR ( sjxx.sfsf = '2' AND ( tab.xmjclx != 'D' OR tab.xmjclx IS NULL ) )
		OR ( sjxx.sfsf = '3' AND ( tab.xmjclx != 'R' OR tab.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf
		FROM
		igams_sjxx sjxx
		LEFT JOIN (
		SELECT
		xm.sjid,
		tt.xmjclx,
		xxdy_xm.dyid
		FROM
		igams_sjjcxm xm
		LEFT JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = xm.jcxmid
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( jc_xm.cskz1 = 'C' OR xmjclx = jc_xm.cskz1 )
		AND jc_xm.cskz3 IN ( 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' )
		WHERE
		 xm.scbj = '0' OR xm.scbj IS NULL
		) tab ON sjxx.sjid = tab.sjid
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "hbzfl != null and hbzfl.length > 0"  >
			AND hb.zfl=#{hbzfl}
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl
		AND xxdy_hb.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx
		AND dylx_hb.scbj = '0'
		AND dylx_hb.cskz1 = 'JCSJ'
		AND dylx_hb.cskz2 = 'CLASSIFY'
		WHERE
		sjxx.scbj = '0'
		and COALESCE(tab.dyid ,'0')!='0'
		AND sjxx.jsrq is not null
		AND COALESCE(dylx_hb.csid ,'0')!='0'
		AND sjxx.sfjs = '1'
		AND COALESCE(hb.hbid ,'0')!='0'
		<if test="yhid != null and yhid != ''">
			AND COALESCE(hbqx.hbid ,'0')!='0'
		</if>
		<if test = "hbfl != null and hbfl.length > 0"  >
			AND xxdy_hb.yxx=#{hbfl}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		)union all(
		SELECT
		sjxx.sjid,
		<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
			to_char(sjxx.jsrq + cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
			to_char( sjxx.jsrq, 'yyyy' ) rq,
		</if>
		xxdy_hb.yxx,
		CASE

		WHEN
		(
		fjsq.sfff = '1'
		OR ( fjsq.sfff = '2' AND ( tt.xmjclx != 'D' OR tt.xmjclx IS NULL ) )
		OR ( fjsq.sfff = '3' AND ( tt.xmjclx != 'R' OR tt.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf
		FROM
		igams_fjsq fjsq
		LEFT OUTER JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid and sjxx.scbj='0'
		LEFT JOIN matridx_jcsj fjlx ON fjlx.csid = fjsq.lx
		AND fjlx.csdm = 'ADDDETECT'
		left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test = "hbzfl != null and hbzfl.length > 0"  >
			AND hb.zfl=#{hbzfl}
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl
		AND xxdy_hb.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx
		AND dylx_hb.scbj = '0'
		AND dylx_hb.cskz1 = 'JCSJ'
		AND dylx_hb.cskz2 = 'CLASSIFY'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = fjsq.jcxm
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.scbj = '0'
		AND fjsq.zt = '80'
		and fjsq.sfff='1'
		and fjsq.bgbj='1'
		and COALESCE(fjlx.csid ,'0')!='0'
		and COALESCE(sjxx.sjid ,'0')!='0'
		AND sjxx.jsrq IS NOT NULL
		and COALESCE(xxdy_xm.dyid ,'0')!='0'
		and COALESCE(dylx_hb.csid ,'0')!='0'
		AND sjxx.sfjs = '1'
		and COALESCE(hb.hbid ,'0')!='0'
		<if test="yhid != null and yhid != ''">
			AND COALESCE(hbqx.hbid ,'0')!='0'
		</if>
		<if test = "hbfl != null and hbfl.length > 0"  >
			AND xxdy_hb.yxx=#{hbfl}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		)) tmp
		GROUP BY
		tmp.rq,
		tmp.yxx,
		tmp.sfsf
		ORDER BY
		tmp.rq,
		tmp.sfsf DESC
	</select>
	
	<!-- 按照日期和代表名统计报告数量，可按照周显示 -->
	<select id="getSjhbFl_week" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
		    select hbid,db,rq,hb.fl,sfsf,sfjs from 
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
				item="item1" index="index1">
					<if test="sfflg == null or sfflg == ''">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
						 union all 
						 select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '0'.toString()">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
				</foreach>
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if> 
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				to_char(coalesce(sjxx.dsyrq,sjxx.syrq) + '1 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'D')||' D' as interval),'yyyy-MM-dd') rq
				    ,sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db,to_char(coalesce(sjxx.dsyrq,sjxx.syrq) + '1 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'D')||' D' as interval),'yyyy-MM-dd'),
				sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>
	<!-- 按照日期和代表名统计报告数量，可按照周显示(接收日期) -->
	<select id="getSjhbFl_weekByJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.hbid,tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,fl,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
		    select hbid,db,rq,hb.fl,sfsf,sfjs from
			<foreach collection="dbs" separator=" union all " open="(" close=") "
			item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
				item="item1" index="index1">
					<if test="sfflg == null or sfflg == ''">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
						 union all
						 select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '0'.toString()">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
				</foreach>
			</foreach>
			 te
			LEFT JOIN igams_sjhbxx hb ON te.db = hb.hbmc and hb.scbj != '1'
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num,
				to_char(sjxx.jsrq + '1 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq
				    ,sjxx.db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx
				where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="db !=null and db !=''">
					and sjxx.db = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and sjxx.db in
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by sjxx.db,to_char(sjxx.jsrq + '1 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd'),
				sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			order by db,rq,sfsf desc
	</select>
	
	<!-- 微信按照日期和统计名称统计报告数量， -->
	<select id="getWeeklyByTjFl" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbmcs != null and dbmcs.size() > 0 "  >
			<foreach collection="dbmcs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and  sjxx.db in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc)
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy')
				</if>,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
			order by db,rq,sfsf desc
	</select>
	<!-- 微信按照日期和统计名称统计报告数量，(接收日期) -->
	<select id="getWeeklyByTjFlAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbmcs != null and dbmcs.size() > 0 "  >
			<foreach collection="dbmcs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
				where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and  sjxx.db in
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc)
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy')
				</if>,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
			order by db,rq,sfsf desc
	</select>

	<select id="getStatisticsByTjFlAndJsrq" parameterType="SjxxDto" resultType="Map">
		SELECT  ''||count
		(tmp.sjid) AS num,
		tmp.rq,
		tmp.db,
		tmp.sfsf
		FROM(
		(
		SELECT
		sjxx.sjid,
		<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
			to_char(sjxx.jsrq + cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
			to_char( sjxx.jsrq, 'yyyy' ) rq,
		</if>
		hb.hbmc as db,
		CASE

		WHEN
		(
		sjxx.sfsf = '1'
		OR ( sjxx.sfsf = '2' AND ( tt.xmjclx != 'D' OR tt.xmjclx IS NULL ) )
		OR ( sjxx.sfsf = '3' AND ( tt.xmjclx != 'R' OR tt.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf
		FROM
		igams_sjxx sjxx
		LEFT OUTER JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid
		AND (xm.scbj = '0' or xm.scbj is null)
		left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = xm.jcxmid
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl
		AND xxdy_hb.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx
		AND dylx_hb.scbj = '0'
		AND dylx_hb.cskz1 = 'JCSJ'
		AND dylx_hb.cskz2 = 'CLASSIFY'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		sjxx.scbj = '0'
		AND sjxx.jsrq IS NOT NULL
		AND dylx_hb.csid IS NOT NULL
		AND sjxx.sfjs = '1'
		AND hb.hbid IS NOT NULL
		AND xxdy_xm.dyid IS NOT NULL
		<if test="db !=null and db !=''">
			and hb.hbmc = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and  sjxx.db in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		)union all (
		SELECT
		sjxx.sjid,
		<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
			to_char(sjxx.jsrq + cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
			to_char( sjxx.jsrq, 'yyyy-MM' ) rq,
		</if>
		<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
			to_char( sjxx.jsrq, 'yyyy' ) rq,
		</if>
		hb.hbmc as db,
		CASE

		WHEN
		(
		fjsq.sfff = '1'
		OR ( fjsq.sfff = '2' AND ( tt.xmjclx != 'D' OR tt.xmjclx IS NULL ) )
		OR ( fjsq.sfff = '3' AND ( tt.xmjclx != 'R' OR tt.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf
		FROM
		igams_fjsq fjsq
		LEFT OUTER JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid and sjxx.scbj='0'
		LEFT JOIN matridx_jcsj fjlx ON fjlx.csid = fjsq.lx
		AND fjlx.csdm = 'ADDDETECT'
		left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl
		AND xxdy_hb.scbj = '0'
		LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx
		AND dylx_hb.scbj = '0'
		AND dylx_hb.cskz1 = 'JCSJ'
		AND dylx_hb.cskz2 = 'CLASSIFY'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = fjsq.jcxm
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.scbj = '0'
		AND fjsq.zt = '80'
		and fjsq.sfff='1'
		and fjsq.bgbj='1'
		AND fjlx.csid IS NOT NULL
		and sjxx.sjid is not null
		AND sjxx.jsrq IS NOT NULL
		AND dylx_hb.csid IS NOT NULL
		AND sjxx.sfjs = '1'
		AND hb.hbid IS NOT NULL
		AND xxdy_xm.dyid IS NOT NULL
		<if test="db !=null and db !=''">
			and hb.hbmc = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and  sjxx.db in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		)) tmp
		GROUP BY
		tmp.rq,
		tmp.db,
		tmp.sfsf
		ORDER BY
		tmp.rq,
		tmp.sfsf DESC
	</select>
	<!-- 微信按照日期和统计名称统计报告数量， -->
	<select id="getWeeklyByTjFlTm" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbmcs != null and dbmcs.size() > 0 "  >
			<foreach collection="dbmcs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx 
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and coalesce(hbxx.tjmc, hbxx.hbmc) in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc)
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy')
				</if>,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
			order by db,rq,sfsf desc
	</select>
	<!-- 微信按照日期和统计名称统计报告数量，(接收日期) -->
	<select id="getWeeklyByTjFlTmAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbmcs != null and dbmcs.size() > 0 "  >
			<foreach collection="dbmcs" separator=" union all " open=" " close=" "
			item="item" index="index">
				<if test = "rqs != null and rqs.size > 0 "  >
					<foreach collection="rqs" separator=" union all "
					item="itemrq" index="indexrq">
						<if test="sfflg == null or sfflg ==''">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
							union all
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '0'.toString()">
							select  '0' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
						<if test="sfflg == '1'.toString()">
							select '1' sfsf,'1' sfjs, #{item} db,#{itemrq} rq
						</if>
					</foreach>
				</if>
			</foreach>
		</if>
		) tjrq
		left outer join (
			select count(sjxx.sjid) as num
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
				from igams_sjxx sjxx
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
				where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and coalesce(hbxx.tjmc, hbxx.hbmc) in
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc)
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM-dd')
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(sjxx.jsrq,'yyyy-MM')
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(sjxx.jsrq,'yyyy')
				</if>,sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
			) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
			group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
			order by db,rq,sfsf desc
	</select>
	<!-- 微信按照日期和统计名称统计报告数量按照周 -->
	<select id="getWeeklyByTjFl_week" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
					 item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
						 item="item1" index="index1">
					<if test="sfflg == null or sfflg == ''">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
						union all
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '0'.toString()">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
				</foreach>
			</foreach>
		</if>
		) tjrq
		left outer join (
		select count(sjxx.sjid) as num,
		to_char(coalesce(sjxx.dsyrq,sjxx.syrq) + '1 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'D')||' D' as interval),'yyyy-MM-dd') rq
		,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
		from igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
		where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="db !=null and db !=''">
			and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and coalesce(hbxx.tjmc, hbxx.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hbxx.tjmc, hbxx.hbmc),to_char(coalesce(sjxx.dsyrq,sjxx.syrq) + '1 D'+  cast ('-'||to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'D')||' D' as interval),'yyyy-MM-dd'),
		sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
		) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
		group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
		order by db,rq,sfsf desc
	</select>
	<!-- 微信按照日期和统计名称统计报告数量按照周(接收日期) -->
	<select id="getWeeklyByTjFl_weekAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.db,tjrq.rq,COALESCE(tmp.num,0) num,tjrq.sfsf,tjrq.sfjs from (
		<if test = "dbs != null and dbs.size() > 0 "  >
			<foreach collection="dbs" separator=" union all " open=" " close=" "
					 item="item" index="index">
				<foreach collection="rqs" separator=" union all " open=" " close=" "
						 item="item1" index="index1">
					<if test="sfflg == null or sfflg == ''">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
						union all
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '0'.toString()">
						select '0' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
					<if test="sfflg == '1'.toString()">
						select '1' sfsf,'1' sfjs,#{item} db,to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} -6,'yyyy-MM-dd') rq
					</if>
				</foreach>
			</foreach>
		</if>
		) tjrq
		left outer join (
		select count(sjxx.sjid) as num,
		to_char(sjxx.jsrq + '1 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq
		,coalesce(hbxx.tjmc, hbxx.hbmc) db,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end sfsf,sjxx.sfjs
		from igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
		where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="db !=null and db !=''">
			and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and coalesce(hbxx.tjmc, hbxx.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hbxx.tjmc, hbxx.hbmc),to_char(sjxx.jsrq + '1 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd'),
		sfjs,case when sjxx.sfjs = '1' then case when sjxx.sfsf ='0' then '0' else '1' end else '0' end
		) tmp on tjrq.rq = tmp.rq and tjrq.db = tmp.db and tjrq.sfjs = tmp.sfjs and tjrq.sfsf = tmp.sfsf
		group by tjrq.db, tjrq.rq, tjrq.sfsf,tjrq.sfjs,num
		order by db,rq,sfsf desc
	</select>
	
	<!-- 领导周报，销售各分类的检测量(本sql区别getStatisByFl ，主要是为了减少数据量)-->
	<select id="getStatisByFlLimit" parameterType="SjxxDto" resultType="Map">
		select tjrq.flid flid,tjrq.flmc flmc,tjrq.rq,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum from (
			select rq,jc.csid flid,jc.csmc flmc from (select csid,csmc from matridx_jcsj where jclb='CLASSIFY'
					<if test="hbfl !=null and hbfl !=''">
						and csid = #{hbfl}
					</if>
					<if test="hbfl == null or hbfl ==''.toString()">
				 	union all select 'default' csid,'未知' csmc
				 	</if>
				 ) jc join (
			<if test = "rqs != null and rqs.size > 0 "  >
				<foreach collection="rqs" separator=" union all "
				item="itemrq" index="indexrq">
					select  #{itemrq} rq
				</foreach>
			</if>
			 ) trq  on 1=1
		) tjrq
		left outer join (
			select rq,flid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
				select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						ELSE 0 end AS sfnum,
					case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					ELSE 0 end AS bsfnum 
					<if test="jsrqstart != null and jsrqstart != ''">
						,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-mm-dd') rq
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') rq
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						,to_char(case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') rq
					</if>,case when jc_fl.csid is null then 'default' else jc_fl.csid end flid
					from igams_sjxx sjxx 
					left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
					left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					<if test="hbfl !=null and hbfl !=''">
						and hb.fl = #{hbfl}
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &gt;= #{jsrqstart} 
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy') &lt;= #{jsrqYend}
					</if>
					<if test="db !=null and db !=''">
						and sjxx.db = #{db}
					</if>
					<if test = "dbs != null and dbs.size() > 0 "  >
						and sjxx.db in 
						<foreach collection="dbs" separator="," open="(" close=") "
						item="item" index="index">
							#{item}
						</foreach>
					</if>
					group by sfjs,jc_fl.csid
					<if test="jsrqstart != null and jsrqstart != ''">
						,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd')
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM')
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						,to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy')
					</if>, sjxx.sfsf ,jc_xm.cskz1,tt.xmjclx,case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end
				) static_sj group by rq,flid
			) tmp on tjrq.rq = tmp.rq  and tjrq.flid=tmp.flid
			order by flid,rq
	</select>
	<!-- 领导周报，销售各分类的检测量(本sql区别getStatisByFl ，主要是为了减少数据量)(接收日期)-->
	<select id="getStatisByFlLimitAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.flid flid,tjrq.flmc flmc,tjrq.rq,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum from (
		select rq,jc.csid flid,jc.csmc flmc from (select csid,csmc from matridx_jcsj where jclb='CLASSIFY'
		<if test="hbfl !=null and hbfl !=''">
			<if test="hbfl == 'default'">
				union all select 'default' csid,'未知' csmc
			</if>
			<if test="hbfl != 'default'">
				and csid = #{hbfl}
			</if>
		</if>
		) jc join (
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all "
					 item="itemrq" index="indexrq">
				select  #{itemrq} rq
			</foreach>
		</if>
		) trq  on 1=1
		) tjrq
		left outer join (
		select rq,flid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum,
		case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq, 'yyyy-mm-dd') rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM') rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy') rq
		</if>,case when jc_fl.csid is null then 'default' else jc_fl.csid end flid
		from igams_sjxx sjxx
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
		left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj='0'  and sjxx.jsrq is not null and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		
		<if test="hbfl !=null and hbfl !=''">
			and hb.fl = #{hbfl}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			AND to_char(sjxx.jsrq, 'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			AND to_char(sjxx.jsrq, 'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			AND to_char(sjxx.jsrq, 'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			AND to_char(sjxx.jsrq, 'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="db !=null and db !=''">
			and sjxx.db = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and sjxx.db in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by sfjs,jc_fl.csid,sjxx.jsrq
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM-dd')
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM')
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy')
		</if>, sjxx.sfsf ,jc_xm.cskz1,tt.xmjclx
		) static_sj group by rq,flid
		) tmp on tjrq.rq = tmp.rq  and tjrq.flid=tmp.flid
		order by flid,rq
	</select>
	
	<!-- 领导周报，销售各分类的检测量 按周进行统计 (本sql区别getStatisByWeekFl ，主要是为了减少数据量) -->
	<select id="getStatisByWeekFlLimit" parameterType="SjxxDto" resultType="Map">
		select tjrq.flid flid,tjrq.flmc flmc,tjrq.rq,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum from (
			select rq,jc.csid flid,jc.csmc flmc from 
				(select csid,csmc from matridx_jcsj where jclb='CLASSIFY'
					<if test="hbfl !=null and hbfl !=''">
						and csid = #{hbfl}
					</if>
					<if test="hbfl == null or hbfl ==''.toString()">
				 	union all select 'default' csid,'未知' csmc
				 	</if>
				 ) jc join (
				<foreach collection="rqs" separator=" union all " open=" " close=" "
				item="item1" index="index1">
						select to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
				</foreach>
			) trq  on 1=1
		) tjrq
		left outer join (
			select rq,flid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
				select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						ELSE 0 end AS sfnum,
					case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					ELSE 0 end AS bsfnum,
					to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end + '7 D'+ 
					 cast ('-'||to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'D')||' D' as interval),'yyyy-MM-dd') rq
					,case when jc_fl.csid is null then 'default' else jc_fl.csid end flid
					from igams_sjxx sjxx 
					left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
					left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					<if test="hbfl !=null and hbfl !=''">
						and hb.fl = #{hbfl}
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						AND  to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq 
							else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &gt;= #{jsrqstart} 
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq
							else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="db !=null and db !=''">
						and sjxx.db = #{db}
					</if>
					<if test = "dbs != null and dbs.size() > 0 "  >
						and sjxx.db in 
						<foreach collection="dbs" separator="," open="(" close=") "
						item="item" index="index">
							#{item}
						</foreach>
					</if>
					group by sfjs,jc_fl.csid,
					sjxx.sfsf,jc_xm.cskz1,tt.xmjclx,case when xmjclx ='D' then sjxx.dsyrq when xmjclx ='R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end
				) static_sj group by rq,flid
			) tmp on tjrq.rq = tmp.rq  and tjrq.flid=tmp.flid
			order by flid,rq
	</select>

	<!-- 领导周报，销售各分类的检测量 按周进行统计 (本sql区别getStatisByWeekFl ，主要是为了减少数据量) (接收日期)-->
	<select id="getStatisByWeekFlLimitAndJsrq" parameterType="SjxxDto" resultType="Map">
		select tjrq.flid flid,tjrq.flmc flmc,tjrq.rq,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum from (
		select rq,jc.csid flid,jc.csmc flmc from
		(select csid,csmc from matridx_jcsj where jclb='CLASSIFY'
		<if test="hbfl !=null and hbfl !=''">
			<if test="hbfl == 'default'">
				union all select 'default' csid,'未知' csmc
			</if>
			<if test="hbfl != 'default'">
				and csid = #{hbfl}
			</if>
		</if>
		) jc join (
		<foreach collection="rqs" separator=" union all " open=" " close=" "
				 item="item1" index="index1">
			select to_char(to_date(#{jsrqend},'yyyy-MM-dd') -7* ${index1} ,'yyyy-MM-dd') rq
		</foreach>
		) trq  on 1=1
		) tjrq
		left outer join (
		select rq,flid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum,
		case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum,
		to_char(sjxx.jsrq + '7 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd') rq
		,case when jc_fl.csid is null then 'default' else jc_fl.csid end flid
		from igams_sjxx sjxx
		left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
		left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
		left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
		left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="hbfl !=null and hbfl !=''">
			and hb.fl = #{hbfl}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			AND to_char(sjxx.jsrq, 'yyyy-MM-dd')  &gt;= #{jsrqstart}
			AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="db !=null and db !=''">
			and sjxx.db = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and sjxx.db in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by  sfjs,jc_fl.csid,to_char(sjxx.jsrq + '7 D'+  cast ('-'||to_char(sjxx.jsrq,'D')||' D' as interval),'yyyy-MM-dd'),
		sjxx.sfsf,jc_xm.cskz1,tt.xmjclx,sjxx.jsrq
		) static_sj group by rq,flid
		) tmp on tjrq.rq = tmp.rq  and tjrq.flid=tmp.flid
		order by flid,rq
	</select>


	<!-- 领导周报，各省份的检测量数据统计(统计一周)，用于显示在省份名称的旁边)-->
	<select id="getSfStatisByWeek" parameterType="SjxxDto" resultType="Map">
		select jc.csid sfid,jc.csmc sfmc,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum,COALESCE(tmp.sfnum,0) + COALESCE(tmp.bsfnum,0) num from matridx_jcsj jc
		left outer join (
			select sfid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
				select case WHEN sjxx.sfjs = '1' THEN 
						case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						ELSE 0 end
					END AS sfnum
					,  CASE WHEN sjxx.sfjs = '1' THEN 
						case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
						when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					ELSE 0 end
					END AS bsfnum
					,jc_sf.csid sfid
					from igams_sjxx sjxx 
					left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
					left outer join matridx_jcsj jc_sf on hb.sf = jc_sf.csid
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0' and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					<if test = "dbs != null and dbs.size() > 0 ">
						and sjxx.db in 
						<foreach collection="dbs" separator="," open="(" close=") "
						item="item" index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM') &gt;= #{jsrqMstart} 
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						AND to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy') &lt;= #{jsrqYend}
					</if>
					group by sfjs,jc_sf.csid, sjxx.sfsf ,jc_xm.cskz1,tt.xmjclx
				) static_sj group by sfid
			) tmp on jc.csid = tmp.sfid 
			where jc.jclb ='PROVINCE' and jc.scbj ='0'
			order by num desc,jc.cspx,jc.csid
	</select>

	<!-- 领导周报，各省份的检测量数据统计(统计一周)，用于显示在省份名称的旁边)(接收日期)-->
	<select id="getSfStatisByWeekAndJsrq" parameterType="SjxxDto" resultType="Map">
		select jc.csid sfid,jc.csmc sfmc,COALESCE(tmp.sfnum,0) sfnum,COALESCE(tmp.bsfnum,0) bsfnum,COALESCE(tmp.sfnum,0) + COALESCE(tmp.bsfnum,0) num from matridx_jcsj jc
		left outer join (
			select sfid,sum(sfnum) sfnum,sum(bsfnum) bsfnum from (
				select case WHEN sjxx.sfjs = '1' THEN
						case when sjxx.sfsf = '1' then COUNT(xxdy_xmfl.dyid)
						when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
						when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
						ELSE 0 end
					END AS sfnum
					,  CASE WHEN sjxx.sfjs = '1' THEN
						case when sjxx.sfsf = '0' then COUNT(xxdy_xmfl.dyid)
						when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(xxdy_xmfl.dyid)
						when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(xxdy_xmfl.dyid)
					ELSE 0 end
					END AS bsfnum
					,jc_sf.csid sfid
					from igams_sjxx sjxx
					left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
					left outer join matridx_jcsj jc_sf on hb.sf = jc_sf.csid
					left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
					left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
					left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = jc_xm.csid AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
					<if test = "yxxs != null and yxxs.length > 0"  >
						AND xxdy_xmfl.yxx in
						<foreach collection="yxxs" separator="," open="(" close=") "
								 item="item" index="index">
							#{item}
						</foreach>
					</if>
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
					<if test = "dbs != null and dbs.size() > 0 ">
						and sjxx.db in
						<foreach collection="dbs" separator="," open="(" close=") "
						item="item" index="index">
							#{item}
						</foreach>
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;=  #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqYend}
					</if>
					group by sfjs,jc_sf.csid, sjxx.sfsf ,jc_xm.cskz1,tt.xmjclx
					union all
					select  CASE when fjsq.sfff = '1' then COUNT(xxdy_xmfl.dyid) ELSE 0 end sfnum
					,CASE WHEN  fjsq.sfff = '0' then COUNT(xxdy_xmfl.dyid)ELSE 0 end bsfnum
					,jc_sf.csid sfid
					from igams_fjsq fjsq
					left outer join matridx_jcsj jc_xm on jc_xm.csid = fjsq.jcxm
					left outer join igams_sjxx sjxx on sjxx.sjid = fjsq.sjid
					left join matridx_jcsj fjlx on fjlx.csid=fjsq.lx AND fjlx.csdm = 'ADDDETECT'
					left outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = fjsq.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
					<if test = "yxxs != null and yxxs.length > 0"  >
						AND xxdy_xmfl.yxx in
						<foreach collection="yxxs" separator="," open="(" close=") "
								 item="item" index="index">
							#{item}
						</foreach>
					</if>
					left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj != '1'
					<if test = "dbs != null and dbs.size() > 0 ">
						and sjxx.db in
						<foreach collection="dbs" separator="," open="(" close=") "
								 item="item" index="index">
							#{item}
						</foreach>
					</if>
					left outer join matridx_jcsj jc_sf on hb.sf = jc_sf.csid
					left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					where  fjsq.scbj = '0' and fjsq.zt = '80' and fjlx.csid is not null and fjsq.bgbj = '1'
					<if test="jsrqstart != null and jsrqstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;=  #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						AND to_char(sjxx.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqYend}
					</if>
					group by sfff,jc_sf.csid,jc_xm.cskz1,tt.xmjclx

					union all
					select  CASE when wbtj.sfsf = '1' then SUM(cast(wbtj.css as numeric)) ELSE 0 end sfnum
					,CASE WHEN  wbtj.sfsf = '0' then SUM(cast(wbtj.css as numeric))ELSE 0 end bsfnum
					,jc_sf.csid sfid
					from igams_wbtjgl wbtj
					left outer join matridx_jcsj jc_xm on jc_xm.csid = wbtj.jcxm
					right outer join igams_xxdy xxdy_xmfl on xxdy_xmfl.dyxx = wbtj.jcxm AND xxdy_xmfl.dylx = #{ywlx} AND xxdy_xmfl.scbj = '0'
					<if test = "yxxs != null and yxxs.length > 0"  >
						AND xxdy_xmfl.yxx in
						<foreach collection="yxxs" separator="," open="(" close=") "
								 item="item" index="index">
							#{item}
						</foreach>
					</if>
					left outer join igams_sjhbxx hb on hb.hbid=wbtj.hbid and hb.scbj != '1'
					<if test = "dbs != null and dbs.size() > 0 ">
						and hb.hbmc in
						<foreach collection="dbs" separator="," open="(" close=") "
								 item="item" index="index">
							#{item}
						</foreach>
					</if>
					left outer join matridx_jcsj jc_sf on hb.sf = jc_sf.csid
					where  wbtj.scbj = '0'
					<if test="jsrqstart != null and jsrqstart != ''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &gt;=  #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						AND to_char(wbtj.jsrq, 'yyyy-MM-dd') &lt;= #{jsrqYend}
					</if>
					group by sfsf,jc_sf.csid,jc_xm.cskz1
				) static_sj group by sfid
			) tmp on jc.csid = tmp.sfid
			where jc.jclb ='PROVINCE' and jc.scbj ='0'
			order by num desc,jc.cspx,jc.csid
	</select>

	<!-- 运营统计1 -->
	<select id="getSjxxByJcdw"  parameterType="SjxxDto" resultType="Map">
	SELECT tmp.jcdwmc, COUNT(*) as num,tmp.jcdw
		FROM (
			SELECT sjxx.sjid, jc_jcdw.csmc AS jcdwmc,sjxx.jcdw
			FROM igams_sjxx sjxx
				LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
				LEFT JOIN matridx_jcsj jc_jcdw ON jc_jcdw.csid = sjxx.jcdw
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			<where>
				 sjxx.scbj='0' and sjxx.sfjs ='1'
				 AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					<if test="jsrqstart != null and jsrqstart != ''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend}
					</if>
			</where> 
		) tmp
		GROUP BY tmp.jcdwmc	,tmp.jcdw
	</select>
	
	<!-- 根据检测单位查询统计数据 -->
	<select id="getSjxxInJcdw" parameterType="SjxxDto" resultType="Map">
		SELECT tjrq.rq, COALESCE(tj_tmp.num,0) as num
			FROM 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		LEFT JOIN (
			SELECT COUNT(*) AS num, tmp.rq
				FROM (
					SELECT sjxx.sjid
				 	<if test="jsrqstart != null and jsrqstart != ''">
			 			<if test="week_flag != null and week_flag !=''">
		 			 		,case when to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
		 			 		 and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 			when to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
				 			and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
						 	when to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
						 	and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
						 	when to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
						 	and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
						 	when to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} 
						 	and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
							end rq
				 		</if>
						<if test="week_flag ==null or week_flag ==''">
							,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') rq
						</if>
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') rq
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') rq
					</if>
					FROM igams_sjxx sjxx
						LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
						LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
						LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc =sjxx.db and sjhb.scbj != '1'
						left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					<where>
						sjxx.scbj ='0' and sjxx.sfjs ='1'
						AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						<if test="week_flag != null and week_flag !=''">
							<if test="jsrqstart != null and jsrqstart != ''">
								and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &gt;= to_char(to_date(#{jsrqstart},'yyyy-MM-dd') -28,'yyyy-MM-dd')
							</if>
							<if test="jsrqend !=null and jsrqend !=''">
								and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= to_char(to_date(#{jsrqend},'yyyy-MM-dd') +6,'yyyy-MM-dd')
							</if>
						</if>
						<if test="week_flag ==null or week_flag ==''">
							<if test="jsrqstart != null and jsrqstart != ''">
								and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end, 'yyyy-MM-dd') &gt;= #{jsrqstart}
							</if>
							<if test="jsrqend !=null and jsrqend !=''">
								and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
							</if>
						</if>
						
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend !=null and jsrqYend !=''">
							and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend}
						</if>
						<if test="jcdw != null and jcdw != ''">
							and sjxx.jcdw =#{jcdw}
						</if>
						<if test="sf != null and sf != ''">
							and sjhb.sf =#{sf}
						</if>
						<if test="db != null and db != ''">
							and sjhb.hbmc =#{db}
						</if>
					</where> 
			) tmp
			GROUP BY tmp.rq
		) tj_tmp
		ON tj_tmp.rq = tjrq.rq
		ORDER by tjrq.rq asc
	</select>
	
	<!-- 通过省份查询送检信息 -->
	<select id="getSjxxBySfPie" parameterType="SjxxDto" resultType="Map">
		SELECT COUNT(*) AS num 
		<if test="sf ==null or sf ==''">
			,tmp.sfmc, tmp.sf
		</if>
		<if test="sf !=null and sf !=''">
			,tmp.hbmc
		</if>
			FROM (
				SELECT sjxx.sjid, jc_sf.csmc AS sfmc,hbxx.sf,hbxx.hbmc
				FROM igams_sjxx sjxx
					LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
					LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
					LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
					LEFT JOIN matridx_jcsj jc_sf ON jc_sf.csid = hbxx.sf
				<where>
					jc_xm.cskz1 = 'C'
					AND sjxx.scbj = '0'
					AND sjxx.jcdw =#{jcdw}
					<if test="sf !=null and sf!=''">
						AND hbxx.sf=#{sf}
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				</where> 
				UNION ALL
				SELECT sjxx.sjid, jc_sf.csmc AS sfmc,hbxx.sf,hbxx.hbmc
				FROM igams_sjxx sjxx
					LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
					LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
					LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
					LEFT JOIN matridx_jcsj jc_sf ON jc_sf.csid = hbxx.sf
				<where>
					jc_xm.cskz1 IN ('R', 'D', 'C')
					AND sjxx.scbj = '0'
					AND sjxx.jcdw =#{jcdw}
					<if test="sf !=null and sf!=''">
						AND hbxx.sf=#{sf}
					</if>
					<if test="jsrqstart != null and jsrqstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy') &lt;= #{jsrqYend}
					</if>
				</where> 
			) tmp
		GROUP BY 
		<if test="sf ==null or sf ==''">
			tmp.sfmc,tmp.sf
		</if>
		<if test="sf !=null and sf !=''">
			tmp.hbmc
		</if>
	</select>
	
	
		<!-- 运营统计2 -->
	<select id="getWsjByJcdw"  parameterType="SjxxDto" resultType="Map">
	SELECT tmp.jcdwmc, COUNT(*) as num,tmp.jcdw
		FROM (
			SELECT sjxx.sjid, jc_jcdw.csmc AS jcdwmc,sjxx.jcdw
			FROM igams_sjxx sjxx
				LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
				LEFT JOIN matridx_jcsj jc_jcdw ON jc_jcdw.csid = sjxx.jcdw
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			<where>
				 sjxx.scbj='0' and sjxx.sfjs ='1' AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				 and (to_char(jsrq,'yyyy-mm-dd') != to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') 
				 or to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') is null)
					<if test="jsrqstart != null and jsrqstart != ''">
						and to_char(jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						and to_char(jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						and to_char(jsrq,'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
			</where> 
		) tmp
		GROUP BY tmp.jcdwmc	,tmp.jcdw
	</select>
	
	
		<!-- 根据检测单位查询未上机统计数据 -->
	<select id="getSjxxInJcdwByWsj" parameterType="SjxxDto" resultType="Map">
		SELECT tjrq.rq, COALESCE(tj_tmp.num,0) as num
			FROM 
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all " open="(" close=") "
			item="item" index="index">
				select #{item} rq
			</foreach>
		</if> tjrq
		LEFT JOIN (
			SELECT COUNT(*) AS num, tmp.rq
				FROM (
					SELECT sjxx.sjid
				 	<if test="jsrqstart != null and jsrqstart != ''">
			 			<if test="week_flag != null and week_flag !=''">
		 			 		,case when to_char(jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}  and to_char(jsrq +'-6 D','yyyy-MM-dd') &lt;= #{jsrqstart} then  to_char(to_date(#{jsrqstart},'yyyy-MM-dd') + 6,'yyyy-MM-dd')
				 			when to_char(jsrq +'7 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(jsrq +'1 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 1,'yyyy-MM-dd')
						 	when to_char(jsrq +'14 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(jsrq +'8 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 8,'yyyy-MM-dd')
						 	when to_char(jsrq +'21 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(jsrq +'15 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 15,'yyyy-MM-dd')
						 	when to_char(jsrq +'28 D','yyyy-MM-dd') &gt;= #{jsrqstart} and to_char(jsrq +'22 D','yyyy-MM-dd') &lt;= #{jsrqstart} then to_char(to_date(#{jsrqstart},'yyyy-MM-dd') - 22,'yyyy-MM-dd')
							end rq
				 		</if>
						<if test="week_flag ==null or week_flag ==''">
							,to_char(jsrq,'yyyy-MM-dd') rq
						</if>
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						,to_char(jsrq,'yyyy-MM') rq
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						,to_char(jsrq,'yyyy') rq
					</if>
					FROM igams_sjxx sjxx
						LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
						LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
						LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc =sjxx.db and sjhb.scbj = '0'
						left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
					<where>
						sjxx.scbj ='0' and sjxx.sfjs ='1'
						AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
						and (to_char(jsrq,'yyyy-mm-dd') != to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') 
						or to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') is null)
						<if test="jsrqstart != null and jsrqstart != ''">
							and to_char(jsrq, 'yyyy-MM-dd') &gt;= #{jsrqstart}
						</if>
						<if test="jsrqend !=null and jsrqend !=''">
							and to_char(jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
						</if>
						<if test="jsrqMstart != null and jsrqMstart != ''">
							and to_char(jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
						</if>
						<if test="jsrqMend !=null and jsrqMend !=''">
							and to_char(jsrq,'yyyy-MM') &lt;= #{jsrqMend}
						</if>
						<if test="jsrqYstart != null and jsrqYstart != ''">
							and to_char(jsrq,'yyyy') &gt;= #{jsrqYstart}
						</if>
						<if test="jsrqYend !=null and jsrqYend !=''">
							and to_char(jsrq,'yyyy') &lt;= #{jsrqYend}
						</if>
						<if test="jcdw != null and jcdw != ''">
							and sjxx.jcdw =#{jcdw}
						</if>
						<if test="sf != null and sf != ''">
							and sjhb.sf =#{sf}
						</if>
						<if test="db != null and db != ''">
							and sjhb.hbmc =#{db}
						</if>
					</where> 
			) tmp
			GROUP BY tmp.rq
		) tj_tmp
		ON tj_tmp.rq = tjrq.rq
		ORDER by tjrq.rq asc
	</select>
	
	<!-- 根据检测单位查询未上机列表数据 -->
	<select id="getSjxxInJcdwByWsjList" parameterType="SjxxDto" resultType="SjxxDto">
		SELECT tmp.sjid,tmp.ybbh,tmp.jsrq,tmp.jcxmmc
			FROM (
				SELECT sjxx.sjid,sjxx.ybbh,sjxx.jsrq,jc_xm.csmc jcxmmc
				FROM igams_sjxx sjxx
						LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
						LEFT JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
						LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc =sjxx.db and sjhb.scbj = '0'
						left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				<where>
					sjxx.scbj = '0'
					AND sjxx.sfjs='1'
					AND sjxx.jcdw =#{jcdw}
					AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
					and (to_char(jsrq,'yyyy-mm-dd') != to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') 
						or to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-mm-dd') is null)
					<if test="jsrqstart != null and jsrqstart != ''">
						and to_char(jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
					</if>
					<if test="jsrqend !=null and jsrqend !=''">
						and to_char(jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
					</if>
					<if test="jsrqMstart != null and jsrqMstart != ''">
						and to_char(jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
					</if>
					<if test="jsrqMend !=null and jsrqMend !=''">
						and to_char(jsrq,'yyyy-MM') &lt;= #{jsrqMend}
					</if>
					<if test="jsrqYstart != null and jsrqYstart != ''">
						and to_char(jsrq,'yyyy') &gt;= #{jsrqYstart}
					</if>
					<if test="jsrqYend !=null and jsrqYend !=''">
						and to_char(jsrq,'yyyy') &lt;= #{jsrqYend}
					</if>
				</where> 
			) tmp
		GROUP BY tmp.sjid,tmp.ybbh,tmp.jsrq,tmp.jcxmmc
	</select>
	
	<!--统计日报： 查询接收后但未实验的标本信息列表 -->
	<select id="getNotSyListDaily" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.yblx,sjxx.db,to_char(sjxx.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq ,jc_jcxm.csmc jcxmmc,jc_yblx.csmc yblxmc
		,sjxx.lrsj,sjxx.hzxm,sjxx.nbbm,jc_jcxm.cskz1 jcxmkzcs,jc_jcdw.cskz2 jcdwjc
		from igams_sjxx sjxx
		left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid=jcxm.jcxmid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		where sjxx.jsrq is not null and sjxx.sfjs ='1' and ((sjxx.dsyrq is  null and sjxx.syrq is null) or to_char(coalesce(sjxx.dsyrq,sjxx.syrq),'yyyy-MM-dd')!=#{jsrq})
		and to_char(sjxx.jsrq,'yyyy-mm-dd')=#{jsrq}
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		order by sjxx.jsrq asc
	</select>
	<!--统计日报： 查询接收后但未实验的标本信息列表(接收日期) -->
	<select id="getNotSyListDailyByJsrq" parameterType="SjxxDto" resultType="SjxxDto">
		select sjxx.sjid,sjxx.yblx,sjxx.db,to_char(sjxx.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq ,jc_jcxm.csmc jcxmmc,jc_yblx.csmc yblxmc
		,sjxx.lrsj,sjxx.hzxm,sjxx.nbbm,jc_jcxm.cskz1 jcxmkzcs,jc_jcdw.cskz2 jcdwjc
		from igams_sjxx sjxx
		left join igams_sjjcxm jcxm on jcxm.sjid= sjxx.sjid and jcxm.scbj='0'
		left join matridx_jcsj jc_jcxm on jc_jcxm.csid=jcxm.jcxmid
		left join matridx_jcsj jc_yblx on jc_yblx.csid=sjxx.yblx
		left join matridx_jcsj jc_jcdw on jc_jcdw.csid=sjxx.jcdw
		where sjxx.jsrq is not null and sjxx.sfjs ='1'
		and to_char(sjxx.jsrq,'yyyy-mm-dd')=#{jsrq}
		<if test="dbs !=null and dbs.size() >0">
			and sjxx.db in
			<foreach collection="dbs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		order by sjxx.jsrq asc
	</select>

	<!-- 查询销售达成率 -->
	<select id="getSalesAttainmentRate" parameterType="XszbDto" resultType="XszbDto">
		select qyid,qymc,zsxm,yhid,kszq,jszq,sum(wczsl) wczsl,sum(sfnum) sfsl,CASE WHEN sz != '0' THEN round( sum(sfnum) :: NUMERIC * 100 / sz :: NUMERIC, 0 ) ELSE '0' END xswcl,
			sum(bsfnum) bsfsl ,CASE WHEN sum(wczsl) != '0' THEN round( sum(bsfnum) :: NUMERIC * 100 / sum(wczsl) :: NUMERIC, 0 ) ELSE '0' END bsfl,sz from (
		SELECT
			jc_yhzqf.csid qyid,
			jc_yhzqf.csmc qymc,
			yh.zsxm,
			yh.yhid,
			tmp.kszq,
			tmp.jszq,
			COUNT ( sj.sjid ) wczsl,
			xszb.sz,
			sj.sfsf,
			tt.xmjclx,
		CASE WHEN sj.sfsf = '1' THEN COUNT ( sj.sjid )
			 WHEN sj.sfsf = '2' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid )
			 WHEN sj.sfsf = '3' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid ) ELSE 0
		END AS sfnum,
		CASE WHEN sj.sfsf = '0' THEN COUNT ( sj.sjid )
			 WHEN sj.sfsf = '2' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid )
			 WHEN sj.sfsf = '3' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid ) ELSE 0
		END AS bsfnum
		FROM
		(
			<if test = "rqs != null and rqs.size > 0 "  >
				<foreach collection="rqs" separator=" union all "
						 item="itemrq" index="indexrq">
					select  #{itemrq.kszq} kszq,#{itemrq.jszq} jszq
				</foreach>
			</if>
		) tmp
		<if test="jsmc !=null and jsmc !=''" >
			LEFT OUTER JOIN matridx_jcsj jc_yhqf on jc_yhqf.csmc = #{jsmc}
			left outer join matridx_yhqtxx yhqtxx on jc_yhqf.csid = yhqtxx.yhqf
		</if>
		<if test="yhid !=null and yhid !=''">
			left outer join matridx_yhqtxx yhqtxx on yhqtxx.yhid = #{yhid}
		</if>
		LEFT OUTER JOIN matridx_xtyh yh ON yh.yhid = yhqtxx.yhid  AND yh.scbj = '0'  AND yh.sfsd = '0'
		LEFT OUTER JOIN matridx_jcsj jc_yhzqf on jc_yhzqf.csid = yhqtxx.yhzqf
		LEFT OUTER JOIN igams_xszb xszb ON xszb.yhid = yh.yhid  and xszb.kszq &lt;= tmp.jszq AND xszb.jszq &gt;= tmp.kszq and xszb.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx and jc_zblx.csdm = #{zblxcsmc}
		LEFT OUTER JOIN igams_hbqx hbqx ON xszb.yhid = hbqx.yhid and jc_zblx.csid is not null
		LEFT OUTER JOIN igams_sjhbxx hbxx ON hbqx.hbid = hbxx.hbid
		LEFT OUTER JOIN igams_sjxx sj ON sj.db = hbxx.hbmc
		AND sj.scbj = '0'
		AND sj.sfjs = '1'
		<if test='zblxcsmc == "Y"'>
			AND ( (to_char(COALESCE (syrq,qtsyrq) , 'YYYY-MM' ) &gt;= tmp.kszq  AND  (to_char( COALESCE (syrq,qtsyrq), 'YYYY' ) &lt;= tmp.jszq))
			OR (to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq AND to_char(  COALESCE (dsyrq,qtsyrq), 'YYYY' ) &lt;= tmp.jszq))
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND ( (to_char( COALESCE (syrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq  AND  (to_char( COALESCE (syrq,qtsyrq), 'YYYY-MM' ) &lt;= tmp.jszq))
			OR (to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq AND to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &lt;= tmp.jszq))
		</if>
		LEFT OUTER JOIN igams_sjjcxm xm ON xm.sjid = sj.sjid and xm.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 = 'C'  OR xmjclx = jc_xm.cskz1 ) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test='zblxcsmc == "Y"'>
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY') &gt;= tmp.kszq )
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY') &lt;= tmp.jszq )
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY-MM') &gt;= tmp.kszq )
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY-MM') &lt;= tmp.jszq )
		</if>
		AND ((jc_xm.cskz1 ='C' and tt.xmjclx is not null) or jc_xm.cskz1 !='C')
		WHERE
		jc_zblx.csid is not null and yh.yhid is not null
		<if test="qyid !=null and qyid !=''">
			and jc_yhzqf.csid = #{qyid}
		</if>
		<if test="cskz3 !=null and cskz3 !=''">
			and  jc_xm.cskz3 = #{cskz3}
		</if>
		GROUP BY
		jc_yhzqf.csid,
		jc_yhzqf.csmc,
		yh.zsxm,
		yh.yhid,
		tmp.kszq,
		tmp.jszq,
		xszb.sz,
		sj.sfsf,
		tt.xmjclx
		)res
		GROUP BY
		qyid,qymc,zsxm,yhid,kszq,jszq,sz
		ORDER BY kszq DESC

	</select>
	<!-- 查询销售达成率(接收日期) -->
	<select id="getSalesAttainmentRateByJsrq" parameterType="XszbDto" resultType="XszbDto">
		select qyid,qymc,zsxm,yhid,kszq,jszq,sum(wczsl) wczsl,sum(sfnum) sfsl,CASE WHEN sz != '0' THEN round( sum(sfnum) :: NUMERIC * 100 / sz :: NUMERIC, 0 ) ELSE '0' END xswcl,
		sum(bsfnum) bsfsl ,CASE WHEN sum(wczsl) != '0' THEN round( sum(bsfnum) :: NUMERIC * 100 / sum(wczsl) :: NUMERIC, 0 ) ELSE '0' END bsfl,sz from (
		SELECT
		jc_yhzqf.csid qyid,
		jc_yhzqf.csmc qymc,
		yh.zsxm,
		yh.yhid,
		tmp.kszq,
		tmp.jszq,
		COUNT ( sj.sjid ) wczsl,
		xszb.sz,
		sj.sfsf,
		tt.xmjclx,
		CASE WHEN sj.sfsf = '1' THEN COUNT ( sj.sjid )
		WHEN sj.sfsf = '2' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid )
		WHEN sj.sfsf = '3' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid ) ELSE 0
		END AS sfnum,
		CASE WHEN sj.sfsf = '0' THEN COUNT ( sj.sjid )
		WHEN sj.sfsf = '2' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid )
		WHEN sj.sfsf = '3' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid ) ELSE 0
		END AS bsfnum
		FROM
		(
		<if test = "rqs != null and rqs.size > 0 "  >
			<foreach collection="rqs" separator=" union all "
					 item="itemrq" index="indexrq">
				select  #{itemrq.kszq} kszq,#{itemrq.jszq} jszq
			</foreach>
		</if>
		) tmp
		<if test="jsmc !=null and jsmc !=''" >
			LEFT OUTER JOIN matridx_jcsj jc_yhqf on jc_yhqf.csmc = #{jsmc}
			left outer join matridx_yhqtxx yhqtxx on jc_yhqf.csid = yhqtxx.yhqf
		</if>
		<if test="yhid !=null and yhid !=''">
			left outer join matridx_yhqtxx yhqtxx on yhqtxx.yhid = #{yhid}
		</if>
		LEFT OUTER JOIN matridx_xtyh yh ON yh.yhid = yhqtxx.yhid  AND yh.scbj = '0'  AND yh.sfsd = '0'
		LEFT OUTER JOIN matridx_jcsj jc_yhzqf on jc_yhzqf.csid = yhqtxx.yhzqf
		LEFT OUTER JOIN igams_xszb xszb ON xszb.yhid = yh.yhid  and xszb.kszq &lt;= tmp.jszq AND xszb.jszq &gt;= tmp.kszq and xszb.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx and jc_zblx.csdm = #{zblxcsmc}
		LEFT OUTER JOIN igams_hbqx hbqx ON xszb.yhid = hbqx.yhid and jc_zblx.csid is not null
		LEFT OUTER JOIN igams_sjhbxx hbxx ON hbqx.hbid = hbxx.hbid
		LEFT OUTER JOIN igams_sjxx sj ON sj.db = hbxx.hbmc
		AND sj.scbj = '0'
		AND sj.sfjs = '1'
		<if test='zblxcsmc == "Y"'>
			AND ( to_char( jsrq, 'YYYY-MM' ) &gt;= tmp.kszq  AND  to_char( jsrq, 'YYYY' ) &lt;= tmp.jszq)
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND ( to_char( jsrq, 'YYYY-MM' ) &gt;= tmp.kszq  AND  to_char( jsrq, 'YYYY-MM' ) &lt;= tmp.jszq)
		</if>
		LEFT OUTER JOIN igams_sjjcxm xm ON xm.sjid = sj.sjid and xm.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 = 'C'  OR xmjclx = jc_xm.cskz1 ) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test='zblxcsmc == "Y"'>
			AND (to_char(sj.jsrq ,'YYYY') &gt;= tmp.kszq )
			AND (to_char(sj.jsrq,'YYYY') &lt;= tmp.jszq )
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND (to_char(sj.jsrq,'YYYY-MM') &gt;= tmp.kszq )
			AND (to_char(sj.jsrq,'YYYY-MM') &lt;= tmp.jszq )
		</if>
		AND ((jc_xm.cskz1 ='C' and tt.xmjclx is not null) or jc_xm.cskz1 !='C')
		WHERE
		jc_zblx.csid is not null and yh.yhid is not null
		<if test="qyid !=null and qyid !=''">
			and jc_yhzqf.csid = #{qyid}
		</if>
		GROUP BY
		jc_yhzqf.csid,
		jc_yhzqf.csmc,
		yh.zsxm,
		yh.yhid,
		tmp.kszq,
		tmp.jszq,
		xszb.sz,
		sj.sfsf,
		tt.xmjclx
		)res
		GROUP BY
		qyid,qymc,zsxm,yhid,kszq,jszq,sz
		ORDER BY kszq DESC
	</select>

	<!-- 查询区域经理下的销售达成率 -->
	<select id="getSalesAttainmentRateByArea" parameterType="XszbDto" resultType="Map">
		select qyid,qymc,zsxm,yhid,kszq,jszq,sum(wczsl) wczsl,sum(sfnum) sfsl,CASE WHEN sz != '0' THEN round( sum(sfnum) :: NUMERIC * 100 / sz :: NUMERIC, 0 ) ELSE '0' END xswcl,
			sum(bsfnum) bsfsl ,CASE WHEN sum(wczsl) != '0' THEN round( sum(bsfnum) :: NUMERIC * 100 / sum(wczsl) :: NUMERIC, 0 ) ELSE '0' END bsfl,sz from (
		SELECT
			jc_yhzqf.csid qyid,
			jc_yhzqf.csmc qymc,
			yh.zsxm,
			yh.yhid,
			tmp.kszq,
			tmp.jszq,
			COUNT ( sj.sjid ) wczsl,
			xszb.sz,
			sj.sfsf,
			tt.xmjclx,
			CASE WHEN sj.sfsf = '1' THEN COUNT ( sj.sjid ) 
			 	 WHEN sj.sfsf = '2' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid ) 
			 	 WHEN sj.sfsf = '3' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid ) ELSE 0 
			END AS sfnum,
			CASE WHEN sj.sfsf = '0' THEN COUNT ( sj.sjid ) 
			 	WHEN sj.sfsf = '2' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid ) 
				WHEN sj.sfsf = '3' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid ) ELSE 0 
			END AS bsfnum
		FROM
		(
			select  #{kszq} kszq,#{jszq} jszq
		) tmp
		left outer join matridx_yhqtxx yhqtxx on yhqtxx.sjid = #{yhid}
		LEFT OUTER JOIN matridx_xtyh yh ON yh.yhid = yhqtxx.yhid  AND yh.scbj = '0'  AND yh.sfsd = '0'
		LEFT OUTER JOIN matridx_jcsj jc_yhzqf on jc_yhzqf.csid = yhqtxx.yhzqf
		LEFT OUTER JOIN igams_xszb xszb ON xszb.yhid = yh.yhid  and xszb.kszq &lt;= tmp.jszq AND xszb.jszq &gt;= tmp.kszq and xszb.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx and jc_zblx.csdm = #{zblxcsmc}
		LEFT OUTER JOIN igams_hbqx hbqx ON xszb.yhid = hbqx.yhid and jc_zblx.csid is not null
		LEFT OUTER JOIN igams_sjhbxx hbxx ON hbqx.hbid = hbxx.hbid
		LEFT OUTER JOIN igams_sjxx sj ON sj.db = hbxx.hbmc
		AND sj.scbj = '0'
		AND sj.sfjs = '1'
		<if test='zblxcsmc == "Y"'>
			AND ( (to_char(COALESCE (syrq,qtsyrq) , 'YYYY-MM' ) &gt;= tmp.kszq  AND  (to_char( COALESCE (syrq,qtsyrq), 'YYYY' ) &lt;= tmp.jszq))
			OR (to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq AND to_char(  COALESCE (dsyrq,qtsyrq), 'YYYY' ) &lt;= tmp.jszq))
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND ( (to_char( COALESCE (syrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq  AND  (to_char( COALESCE (syrq,qtsyrq), 'YYYY-MM' ) &lt;= tmp.jszq))
			OR (to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &gt;= tmp.kszq AND to_char( COALESCE (dsyrq,qtsyrq), 'YYYY-MM' ) &lt;= tmp.jszq))
		</if>
		LEFT OUTER JOIN igams_sjjcxm xm ON xm.sjid = sj.sjid and xm.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 = 'C'  OR xmjclx = jc_xm.cskz1 ) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test='zblxcsmc == "Y"'>
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY') &gt;= tmp.kszq )
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY') &lt;= tmp.jszq )
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY-MM') &gt;= tmp.kszq )
			AND (to_char((CASE WHEN tt.xmjclx = 'D' THEN sj.dsyrq WHEN tt.xmjclx = 'R' THEN sj.syrq else sj.qtsyrq END),'YYYY-MM') &lt;= tmp.jszq )
		</if>
		AND ((jc_xm.cskz1 ='C' and tt.xmjclx is not null) or jc_xm.cskz1 !='C')
		WHERE
			jc_zblx.csid is not null and yh.yhid is not null
		<if test="cskz3 !=null and cskz3 !=''">
			and  jc_xm.cskz3 = #{cskz3}
		</if>
		GROUP BY
		jc_yhzqf.csid,
		jc_yhzqf.csmc,
		yh.zsxm,
		yh.yhid,
		tmp.kszq,
		tmp.jszq,
		xszb.sz,
		sj.sfsf,
		tt.xmjclx
		)res
		GROUP BY 
		qyid,qymc,zsxm,yhid,kszq,jszq,sz
		ORDER BY kszq DESC
	</select>
	<!-- 查询区域经理下的销售达成率(接收日期) -->
	<select id="getSalesAttainmentRateByAreaAndJsrq" parameterType="XszbDto" resultType="Map">
		select qyid,qymc,zsxm,yhid,kszq,jszq,sum(wczsl) wczsl,sum(sfnum) sfsl,CASE WHEN sz != '0' THEN round( sum(sfnum) :: NUMERIC * 100 / sz :: NUMERIC, 0 ) ELSE '0' END xswcl,
			sum(bsfnum) bsfsl ,CASE WHEN sum(wczsl) != '0' THEN round( sum(bsfnum) :: NUMERIC * 100 / sum(wczsl) :: NUMERIC, 0 ) ELSE '0' END bsfl,sz from (
		SELECT
			jc_yhzqf.csid qyid,
			jc_yhzqf.csmc qymc,
			yh.zsxm,
			yh.yhid,
			tmp.kszq,
			tmp.jszq,
			COUNT ( sj.sjid ) wczsl,
			xszb.sz,
			sj.sfsf,
			tt.xmjclx,
			CASE WHEN sj.sfsf = '1' THEN COUNT ( sj.sjid )
			 	 WHEN sj.sfsf = '2' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid )
			 	 WHEN sj.sfsf = '3' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid ) ELSE 0
			END AS sfnum,
			CASE WHEN sj.sfsf = '0' THEN COUNT ( sj.sjid )
			 	WHEN sj.sfsf = '2' AND tt.xmjclx = 'D' THEN COUNT ( sj.sjid )
				WHEN sj.sfsf = '3' AND tt.xmjclx = 'R' THEN COUNT ( sj.sjid ) ELSE 0
			END AS bsfnum
		FROM
		(
			select  #{kszq} kszq,#{jszq} jszq
		) tmp
		left outer join matridx_yhqtxx yhqtxx on yhqtxx.sjid = #{yhid}
		LEFT OUTER JOIN matridx_xtyh yh ON yh.yhid = yhqtxx.yhid  AND yh.scbj = '0'  AND yh.sfsd = '0'
		LEFT OUTER JOIN matridx_jcsj jc_yhzqf on jc_yhzqf.csid = yhqtxx.yhzqf
		LEFT OUTER JOIN igams_xszb xszb ON xszb.yhid = yh.yhid  and xszb.kszq &lt;= tmp.jszq AND xszb.jszq &gt;= tmp.kszq and xszb.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx and jc_zblx.csdm = #{zblxcsmc}
		LEFT OUTER JOIN igams_hbqx hbqx ON xszb.yhid = hbqx.yhid and jc_zblx.csid is not null
		LEFT OUTER JOIN igams_sjhbxx hbxx ON hbqx.hbid = hbxx.hbid
		LEFT OUTER JOIN igams_sjxx sj ON sj.db = hbxx.hbmc
		AND sj.scbj = '0'
		AND sj.sfjs = '1'
		<if test='zblxcsmc == "Y"'>
			AND (to_char( sj.jsrq, 'YYYY-MM' ) &gt;= tmp.kszq)  AND  (to_char( sj.jsrq, 'YYYY' ) &lt;= tmp.jszq)
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND (to_char( sj.jsrq, 'YYYY-MM' ) &gt;= tmp.kszq)  AND  (to_char( j.jsrq, 'YYYY' ) &lt;= tmp.jszq)
		</if>
		LEFT OUTER JOIN igams_sjjcxm xm ON xm.sjid = sj.sjid and xm.scbj='0'
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 = 'C'  OR xmjclx = jc_xm.cskz1 ) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test='zblxcsmc == "Y"'>
			AND (to_char(sj.jsrq,'YYYY') &gt;= tmp.kszq ) AND (to_char(sj.jsrq,'YYYY') &lt;= tmp.jszq )
		</if>
		<if test='zblxcsmc == "M"|| zblxcsmc == "Q"'>
			AND (to_char(sj.jsrq,'YYYY-MM') &gt;= tmp.kszq )
			AND (to_char(sj.jsrq,'YYYY-MM') &lt;= tmp.jszq )
		</if>
		AND ((jc_xm.cskz1 ='C' and tt.xmjclx is not null) or jc_xm.cskz1 !='C')
		WHERE
			jc_zblx.csid is not null and yh.yhid is not null
		GROUP BY
		jc_yhzqf.csid,
		jc_yhzqf.csmc,
		yh.zsxm,
		yh.yhid,
		tmp.kszq,
		tmp.jszq,
		xszb.sz,
		sj.sfsf,
		tt.xmjclx
		)res
		GROUP BY
		qyid,qymc,zsxm,yhid,kszq,jszq,sz
		ORDER BY kszq DESC
	</select>
	
	<!-- 按照日期和统计名称统计报告数量，可按照日，月，年，显示指定前几个 -->
	<select id="getStatisBySomeTimeDB" parameterType="SjxxDto" resultType="Map">
		select db, sum(COALESCE(tmp.sfnum, 0))||'' AS sfnum, sum(COALESCE(tmp.bsfnum, 0))||'' AS bsfnum,
		(sum(COALESCE(tmp.sfnum, 0)) +  sum(COALESCE(tmp.bsfnum, 0)))||'' as totalnum from (
			select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					ELSE 0 end AS sfnum
				, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
					when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
				ELSE 0 end AS bsfnum
				<if test="jsrqstart != null and jsrqstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') rq
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') rq
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					,to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') rq
				</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db
				from igams_sjxx sjxx 
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
				LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
				LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
				left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				where sjxx.scbj='0'  and (sjxx.dsyrq is not null or sjxx.syrq is not null) and sjxx.sfjs = '1'
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				<if test="hbfl !=null and hbfl !='' and hbfl !='default'">
					and hbxx.fl = #{hbfl}
				</if>
				<if test="hbfl !=null and hbfl == 'default'">
					and (hbxx.fl is null or hb.fl = '')
				</if>
				<if test="hbzfl !=null and hbzfl !=''">
					and hbxx.zfl = #{hbzfl}
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM-dd') &lt;= #{jsrqend}
				</if>
				<if test="jsrqMstart != null and jsrqMstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &gt;= #{jsrqMstart}
				</if>
				<if test="jsrqMend !=null and jsrqMend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy-MM') &lt;= #{jsrqMend}
				</if>
				<if test="jsrqYstart != null and jsrqYstart != ''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &gt;= #{jsrqYstart}
				</if>
				<if test="jsrqYend !=null and jsrqYend !=''">
					and to_char(case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,'yyyy') &lt;= #{jsrqYend}
				</if>
				<if test="db !=null and db !=''">
					and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
				</if>
				<if test = "dbs != null and dbs.size() > 0 "  >
					and coalesce(hbxx.tjmc, hbxx.hbmc) in 
					<foreach collection="dbs" separator="," open="(" close=") "
					item="item" index="index">
						#{item}
					</foreach>
				</if>
				group by coalesce(hbxx.tjmc, hbxx.hbmc),case when tt.xmjclx = 'D' then sjxx.dsyrq when tt.xmjclx = 'R' then sjxx.syrq else case when sjxx.dsyrq is not null then sjxx.dsyrq else sjxx.syrq end end,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
			) tmp 
			group by db
			order by totalnum desc,db
	</select>
	<!-- 按照日期和统计名称统计报告数量，可按照日，月，年，显示指定前几个(接收日期) -->
	<select id="getStatisBySomeTimeDBAndJsrq" parameterType="SjxxDto" resultType="Map">
		select db, sum(COALESCE(tmp.sfnum, 0))||'' AS sfnum, sum(COALESCE(tmp.bsfnum, 0))||'' AS bsfnum,
		(sum(COALESCE(tmp.sfnum, 0)) +  sum(COALESCE(tmp.bsfnum, 0)))||'' as totalnum from (
		select case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum
		, case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum
		<if test="jsrqstart != null and jsrqstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM-dd') rq
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			,to_char(sjxx.jsrq,'yyyy-MM') rq
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			,to_char(sjxx.jsrq,'yyyy') rq
		</if>,coalesce(hbxx.tjmc, hbxx.hbmc) db
		from igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db and (hbxx.scbj = '0' or hbxx.scbj = '2')
		LEFT JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid and xm.scbj='0'
		LEFT JOIN matridx_jcsj jc_xm ON xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		where sjxx.scbj='0' and sjxx.jsrq is not null and sjxx.sfjs = '1'
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="hbfl !=null and hbfl !='' and hbfl !='default'">
			and hbxx.fl = #{hbfl}
		</if>
		<if test="hbfl !=null and hbfl == 'default'">
			and (hbxx.fl is null or hb.fl = '')
		</if>
		<if test="hbzfl !=null and hbzfl !=''">
			and hbxx.zfl = #{hbzfl}
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		<if test="db !=null and db !=''">
			and coalesce(hbxx.tjmc, hbxx.hbmc) = #{db}
		</if>
		<if test = "dbs != null and dbs.size() > 0 "  >
			and coalesce(hbxx.tjmc, hbxx.hbmc) in
			<foreach collection="dbs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		group by coalesce(hbxx.tjmc, hbxx.hbmc),sjxx.jsrq,sfjs,jc_xm.cskz1,sjxx.sfsf,tt.xmjclx
		) tmp
		group by db
		order by cast(((sum(COALESCE(tmp.sfnum, 0)) +  sum(COALESCE(tmp.bsfnum, 0)))||'') as numeric) desc,db
	</select>
	<!--统计标本质量合格率-->
	<select id="getQualifiedRateByRq" parameterType="map" resultType="map">
		SELECT  tmpp.num num,
		tmpp.bad sampleBad,
		(tmpp.num-tmpp.bad) sampleGood,
		case when tmpp.num=0 then '0%' else round( (tmpp.bad/tmpp.num::numeric)*100 , 2 )|| '%' end sampleNopass,
		case when tmpp.num=0 then '0%' else round( ( (tmpp.num-tmpp.bad)/tmpp.num::numeric)*100 , 2 )|| '%' end samplePass
		from (
		SELECT
		(
		select count(sjid)
		from igams_sjxx sjxx
		<where>
			sjxx.scbj='0'
			<if test = "rq != null and rq !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') = #{rq}
			</if>
			<if test = "rqStart != null and rqStart !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &gt;= #{rqStart}
			</if>
			<if test = "rqEnd != null and rqEnd !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &lt;= #{rqEnd}
			</if>
		</where>
		) as num,
		(
		select count(tmp.sjid)
		from
		(
		select ybzt.sjid sjid
		from igams_sjybzt ybzt
		join igams_sjxx sjxx on ybzt.sjid = sjxx.sjid
		<where>
			sjxx.scbj='0'
			<if test = "rq != null and rq !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') = #{rq}
			</if>
			<if test = "rqStart != null and rqStart !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &gt;= #{rqStart}
			</if>
			<if test = "rqEnd != null and rqEnd !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &lt;= #{rqEnd}
			</if>
		</where>
		group by ybzt.sjid
		)tmp
		)as bad
		)tmpp
	</select>
	<!--统计各标本类型的不合格率-->
	<select id="getDisqualificationRateWithTypeByRq" parameterType="map" resultType="map">
		SELECT
		tmp.csmc AS typename,
		tmp.num AS num,
		CASE WHEN SUM (tmp.num) OVER ()=0 THEN '0.00%' ELSE
		round(          CAST (           (  100.0*tmp.num/SUM(tmp.num) OVER () ) AS NUMERIC        ), 2			) || '%' END AS percentage
		from (
		select ybzt.zt as type, jc.csmc as csmc, count(ybzt.zt) as num
		from igams_sjybzt ybzt
		left join matridx_jcsj jc on jc.csid = ybzt.zt
		join igams_sjxx sjxx on ybzt.sjid = sjxx.sjid
		<where>
			sjxx.scbj='0'
			<if test = "rq != null and rq !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') = #{rq}
			</if>
			<if test = "rqStart != null and rqStart !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &gt;= #{rqStart}
			</if>
			<if test = "rqEnd != null and rqEnd !=''">
				and to_char(sjxx.jsrq,'yyyy-mm-dd') &lt;= #{rqEnd}
			</if>
		</where>
		group by ybzt.zt,jc.csmc
		)tmp

	</select>
	<!--收费测试数 样本分类(直销+代理)-->
	<select id="getNumberOfChargesDivideByYblx" resultType="Map">
		SELECT tmp.yblxmc,COUNT(tmp.sjid) AS cnum, concat(round(COUNT(tmp.yblxmc) * 100 / SUM(COUNT(tmp.cnt)) OVER (), 2), '%') AS percentage
		FROM (
		SELECT sj.sjid,jc_yblx.csmc yblxmc,case when sj.sfsf ='2' and tt.xmjclx = 'D' then 0 when sj.sfsf ='3' and tt.xmjclx = 'R' then 0 else COUNT(sj.sjid) end cnt
		FROM igams_sjxx sj
		LEFT JOIN matridx_jcsj jc_yblx ON jc_yblx.csid = sj.yblx
		LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE CASE WHEN sj.sfsf = '3' THEN  xmjclx ='D' when sj.sfsf = '2' then xmjclx ='R' else 1=1 end and sj.sfsf !='0'
		AND jc_jcxm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		AND sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and jcxm.jcxmid is not null
		and sjhbxx.fl in ('23AB3322BF8941458DE96397C10D53C5','989C055F5ACB4142AD14F7DB046C2BF5','0954A23558524DA0BD22321EB35D3D57')
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY sj.sjid,jc_yblx.csmc,tt.xmjclx,sj.sfsf
		UNION ALL
		SELECT
		fjsq.fjid sjid,
		jc_yblx.csmc yblxmc,
		COUNT ( fjsq.fjid ) cnt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj on fjsq.sjid = sj.sjid
		LEFT JOIN matridx_jcsj jc_yblx ON jc_yblx.csid = sj.yblx
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		left join matridx_jcsj jc_fjlx on jc_fjlx.csid = fjsq.lx
		LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.zt = '80' and jc_fjlx.csdm = 'ADDDETECT'  and sj.scbj='0' AND fjsq.scbj = '0' AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.jcxm  IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN ( '23AB3322BF8941458DE96397C10D53C5', '989C055F5ACB4142AD14F7DB046C2BF5', '0954A23558524DA0BD22321EB35D3D57' )
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		fjsq.fjid,
		jc_yblx.csmc
		) tmp
		GROUP BY tmp.yblxmc
		ORDER BY COUNT(tmp.sjid) DESC;
	</select>
	<!--收费测试数 科室分类(直销+代理)-->
	<select id="getNumberOfChargesDivideByKs" resultType="Map">
		SELECT tmp.ksmc,COUNT(tmp.sjid) AS cnum, concat(round(COUNT(tmp.ksmc) * 100 / SUM(COUNT(tmp.cnt)) OVER (), 2), '%') AS percentage
		FROM (
		SELECT sj.sjid,ksxx.dwmc ksmc,case when sj.sfsf ='2' and tt.xmjclx = 'D' then 0 when sj.sfsf ='3' and tt.xmjclx = 'R' then 0 else COUNT(sj.sjid) end cnt
		FROM igams_sjxx sj
		LEFT JOIN igams_sjdwxx ksxx ON ksxx.dwid = sj.ks
		LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE CASE WHEN sj.sfsf = '3' THEN  xmjclx ='D' when sj.sfsf = '2' then xmjclx ='R' else 1=1 end and sj.sfsf !='0'
		AND jc_jcxm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		AND sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and jcxm.jcxmid is not null
		and sjhbxx.fl in ('23AB3322BF8941458DE96397C10D53C5','989C055F5ACB4142AD14F7DB046C2BF5','0954A23558524DA0BD22321EB35D3D57')
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY sj.sjid,ksxx.dwmc,tt.xmjclx,sj.sfsf
		UNION ALL
		SELECT
		fjsq.fjid sjid,
		ksxx.dwmc ksmc,
		COUNT ( fjsq.fjid ) cnt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj on fjsq.sjid = sj.sjid
		LEFT JOIN igams_sjdwxx ksxx ON ksxx.dwid = sj.ks
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		left join matridx_jcsj jc_fjlx on jc_fjlx.csid = fjsq.lx
		LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.zt = '80' and jc_fjlx.csdm = 'ADDDETECT'  and sj.scbj='0' AND fjsq.scbj = '0' AND fjsq.lrsj IS NOT NULL
		AND jc_jcxm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		AND fjsq.sfff = '1'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.jcxm  IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN ( '23AB3322BF8941458DE96397C10D53C5', '989C055F5ACB4142AD14F7DB046C2BF5', '0954A23558524DA0BD22321EB35D3D57' )
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		fjsq.fjid,
		ksxx.dwmc
		) tmp
		GROUP BY tmp.ksmc
		ORDER BY COUNT(tmp.sjid) DESC
	</select>

	<!-- 入院医院的收费检测数(先展示测试数前10的）-->
	<select id="getRyyySfcssTopList" resultType="Map" parameterType="Map">
		select dwmc, yyzddj, sum(dlssfnum+zxsfnum) cnum,SUM ( tmp.dlssfnum ) dlssfnum,
		SUM ( tmp.zxsfnum ) zxsfnum,tmp.dqxx
		from(
		select
		yyxx.cskz2 yyzddj,
		case when (yyxx.tjmc is not null and yyxx.tjmc != '') then yyxx.tjmc
		else yyxx.dwmc end dwmc,
		CASE
		WHEN sjxx.sfsf = '1' and hbfl.cskz4 = '直销' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '2' and hbfl.cskz4 = '直销'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '3' and hbfl.cskz4 = '直销'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sjxx.sjid ) ELSE 0
		END AS zxsfnum,
		CASE
		WHEN sjxx.sfsf = '1' and hbfl.cskz4 = '代理商' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '2' and hbfl.cskz4 = '代理商'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '3' and hbfl.cskz4 = '代理商'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sjxx.sjid ) ELSE 0
		END AS dlssfnum,
		sf.csmc dqxx
		FROM igams_yyxx yyxx
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjdw = yyxx.dwid AND sjxx.scbj ='0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sjxx.sfsf !='0'
		LEFT JOIN igams_sjjcxm sjjcxm on sjjcxm.sjid = sjxx.sjid and sjjcxm.scbj='0'
		AND sjjcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_xm on sjjcxm.jcxmid = jc_xm.csid
		LEFT JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		left join matridx_jcsj sjqf on sjxx.sjqf = sjqf.csid
		left join matridx_jcsj sf on sf.csid=yyxx.sf
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		left join matridx_jcsj hbfl on hbfl.csid=sjhbxx.fl
		<where>
			sjqf.csmc='入院' and sjxx.sfsf !='0'
			and sjjcxm.jcxmid is not null
			AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
			<if test="hbfls!=null and hbfls.size()>0">
				and sjhbxx.fl IN
				<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="qys != null and qys.size() >0">
				and sjhbxx.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND sjhbxx.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(sjxx.jsrq,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(sjxx.jsrq,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		yyxx.dwmc, sjxx.sfsf,tt.xmjclx, yyxx.cskz2, yyxx.tjmc,hbfl.cskz4,sjxx.sfsf,sf.csmc
		UNION ALL
		SELECT
		yyxx.cskz2 yyzddj,
		CASE
		WHEN ( yyxx.tjmc IS NOT NULL AND yyxx.tjmc != '' ) THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN hbfl.cskz4 = '直销' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS zxsfnum,
		CASE
		WHEN hbfl.cskz4 = '代理商' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS dlssfnum,
		sf.csmc dqxx
		FROM
		igams_yyxx yyxx
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjdw = yyxx.dwid
		AND sjxx.scbj = '0'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		LEFT JOIN igams_fjsq fjsq ON fjsq.sjid = sjxx.sjid
		AND fjsq.scbj = '0'
		AND fjsq.zt = '80'
		LEFT JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
		LEFT JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN matridx_jcsj sjqf ON sjxx.sjqf = sjqf.csid
		LEFT JOIN matridx_jcsj sf ON sf.csid = yyxx.sf
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		left join matridx_jcsj jc_fjlx on jc_fjlx.csid = fjsq.lx
		WHERE
		sjqf.csmc = '入院'
		and jc_fjlx.cskz1 = '1'
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhbxx.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.dwmc,
		yyxx.cskz2,
		yyxx.tjmc,
		hbfl.cskz4,
		sf.csmc)tmp
		group by tmp.dwmc, tmp.yyzddj,tmp.dqxx
		order by cnum desc
	</select>
<!--	<select id="getRyyySfcssTopList" resultType="Map">-->
<!--		select '浙江省人民医院' dwmc, null yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, null yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--		union all-->
<!--		select '浙江省人民医院' dwmc, 'B' yyzddj, '493'cnum, '2022Q3' rq-->
<!--	</select>-->
<!--    	区域收费测试数（各大区展示[直销+代理商]）饼状图（数字+比例）-->
	<select id="getQySfcssList" resultType="Map" parameterType="Map">
		select dq,sum(cn) cn
		from
		(
			SELECT  CASE WHEN dq.gwmc IS NOT NULL THEN dq.gwmc
						 ELSE dq.zsxm END AS dq,
				CASE  WHEN sjxx.sfsf = '1' THEN COUNT(sjxx.sjid)
					  WHEN sjxx.sfsf = '2' AND tt.xmjclx = 'R' THEN COUNT(sjxx.sjid)
				      WHEN sjxx.sfsf = '3' AND tt.xmjclx = 'D' THEN COUNT(sjxx.sjid)
					  ELSE 0 END AS cn
			from igams_sjxx sjxx
			left outer join igams_sjjcxm xm on sjxx.sjid = xm.sjid and xm.scbj='0'
			AND xm.jcxmid in
			<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
			left outer join matridx_jcsj jc_xm on jc_xm.csid = xm.jcxmid
			left outer join igams_sjhbxx hbxx on hbxx.hbmc = sjxx.db and hbxx.scbj != '1'
			left outer join matridx_jcsj jc_fl on hbxx.fl = jc_fl.csid
			left outer join ( select 'D' xmjclx union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			left outer join matridx_xtyh dq on dq.yhid=hbxx.dqxx
			<where>
				sjxx.scbj ='0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sjxx.sfsf !='0'
				and (hbxx.fl =  '0954A23558524DA0BD22321EB35D3D57' or hbxx.fl =  '989C055F5ACB4142AD14F7DB046C2BF5')
				AND jc_xm.cskz3 in ('IMP_REPORT_SEQ_INDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE','IMP_REPORT_ONCO_QINDEX_TEMEPLATE_REM')
				and jc_fl.csid is not null and dq.yhid is not null
				and xm.jcxmid is not null
				<if test="sf !=null and sf.size()>0">
					AND hbxx.sf IN
					<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
						#{item}
					</foreach>
				</if>

				<if test="nf !=null and nf.size() >0">
					AND to_char(sjxx.jsrq,'yyyy') in
					<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
				<if test="yf !=null and yf.size() >0">
					AND to_char(sjxx.jsrq,'MM') in
					<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
				</if>
			</where>
			group by dq.zsxm, dq.gwmc, sjxx.sfsf, tt.xmjclx
			UNION ALL
			SELECT
			CASE
			WHEN
			dq.gwmc IS NOT NULL THEN
			dq.gwmc ELSE dq.zsxm
			END AS dq,
			COUNT ( fjsq.fjid ) cn
			FROM
			igams_fjsq fjsq
			LEFT JOIN igams_sjxx sjxx ON fjsq.sjid = sjxx.sjid
			LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = fjsq.jcxm
			LEFT OUTER JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db
			AND hbxx.scbj != '1'
			LEFT OUTER JOIN matridx_jcsj jc_fl ON hbxx.fl = jc_fl.csid
			LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
			LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
			LEFT OUTER JOIN matridx_xtyh dq ON dq.yhid = hbxx.dqxx
			WHERE
			fjsq.zt = '80'
			AND jc_fjlx.cskz1 = '1'
			AND fjsq.sfff = '1'
			AND sjxx.scbj = '0'
			AND fjsq.scbj = '0'
			AND fjsq.lrsj IS NOT NULL
			AND fjsq.jcxm IN
			<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
			AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
			AND ( hbxx.fl = '0954A23558524DA0BD22321EB35D3D57' OR hbxx.fl = '989C055F5ACB4142AD14F7DB046C2BF5' )
			AND jc_fl.csid IS NOT NULL
			AND dq.yhid IS NOT NULL
			<if test="sf !=null and sf.size()>0">
				AND hbxx.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(fjsq.lrsj,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(fjsq.lrsj,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			GROUP BY
			dq.zsxm,
			dq.gwmc
		)ttt
		group by ttt.dq
		order by ttt.dq
	</select>
	<!-- 月度人均收费测试数（直销（特检+入院+科技）） 可能某些月或者年的人数未导入，则, round(sum(cnt)/sz,3)除以null了，该情况值设置为0 -->
	<select id="getNdyrjSfcssList" parameterType="Map" resultType="Map">
		select  rq, sz, sum(cnt) sumn ,
				CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(cnt)/sz,0) END roundn
		from
		(
				select tmp.cnt,  tmp.rq, xszb.sz
				from
				(
						select
							case when sj.sfsf = '2' and tt.xmjclx = 'D' then 0
							when sj.sfsf = '3' and tt.xmjclx = 'R' then 0
							else COUNT(sj.sjid) end as cnt
							<if test="type !=null and type=='year'">
								,to_char( sj.jsrq, 'yyyy' ) rq
							</if>
							<if test="type !=null and type=='month'">
								,to_char( sj.jsrq, 'yyyy-MM' ) rq
							</if>
							<if test="type !=null and type == 'quarter'">
								,to_char( sj.jsrq, 'yyyy-MM' ) rq
							</if>
						from  igams_sjxx sj
						left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
						left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
						left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj='0'
						AND xm.jcxmid in
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
						left outer join ( select 'D' xmjclx  union all select 'R' xmjclx ) tt on (jc_xm.cskz1 = 'C' and jc_xm.cskz3!='IMP_REPORT_SEQ_INDEX_TEMEPLATE' and jc_xm.cskz3!='IMP_REPORT_SEQ_XINDEX_TEMEPLATE') or xmjclx = jc_xm.cskz1
						<where>
							sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sj.sfsf != '0'
							and jc_fl.csmc='直销'
							and xm.jcxmid is not null
							<if test="qys != null and qys.size() >0">
								and hb.dqxx in
								<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
							<if test="sf !=null and sf.size()>0">
								AND hb.sf IN
								<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
									#{item}
								</foreach>
							</if>
							<if test="nf !=null and nf.size() >0">
								AND to_char(sj.jsrq,'yyyy') in
								<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
							<if test="yf !=null and yf.size() >0">
								AND to_char(sj.jsrq,'MM') in
								<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
						</where>
						group by
							sj.sfsf,tt.xmjclx
							<if test="type !=null and type=='year'">
								,to_char( sj.jsrq, 'yyyy' )
							</if>
							<if test="type !=null and type=='month'">
								,to_char( sj.jsrq, 'yyyy-MM' )
							</if>
							<if test="type !=null and type == 'quarter'">
								,to_char( sj.jsrq, 'yyyy-MM' )
							</if>
						UNION ALL
						SELECT COUNT
						( fjsq.fjid ) cnt
							<if test="type !=null and type=='year'">
								,to_char( fjsq.lrsj, 'yyyy' ) rq
							</if>
							<if test="type !=null and type=='month'">
								,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
							</if>
							<if test="type !=null and type == 'quarter'">
								,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
							</if>
						FROM
						igams_fjsq fjsq
						LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
						LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc
						AND hb.scbj != '1'
						LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
						LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
						LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
						WHERE
						fjsq.zt = '80'
						AND jc_fjlx.cskz1 = '1'
						AND sj.scbj = '0'
						AND fjsq.scbj = '0'
						AND fjsq.lrsj IS NOT NULL
						AND fjsq.sfff = '1'
						AND fjsq.jcxm IN
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
						AND jc_fl.csmc = '直销'
						<if test="qys != null and qys.size() >0">
							and hb.dqxx in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="sf !=null and sf.size()>0">
							AND hb.sf IN
							<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND to_char(fjsq.lrsj,'yyyy') in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND to_char(fjsq.lrsj,'MM') in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						GROUP BY
						rq
				)tmp
					left outer join(
						SELECT sum(cast(xs.sz as numeric)) sz
							<if test="type !=null and type=='year'">
								, substring(xs.kszq,1,4) kszq
							</if>
							<if test="type !=null and type=='month'">
								, xs.kszq kszq
							</if>
							<if test="type !=null and type == 'quarter'">
								, xs.kszq kszq
							</if>
							<if test="qys != null and qys.size() >0">
								, xs.yhid
							</if>
						from igams_xszb xs
						left join matridx_jcsj zblx on zblx.csid = xs.zblx
						left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
						<where>
							jc_fl.csmc = '人数' and zblx.csmc='月度' and xs.zbzfl is null
							<if test="qys != null and qys.size() >0">
								and xs.yhid in
								<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
							<if test="nf !=null and nf.size() >0">
								AND substring(xs.kszq,1,4) in
								<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
							<if test="yf !=null and yf.size() >0">
								AND substring(xs.kszq,6,7) in
								<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
									#{item}
								</foreach>
							</if>
						</where>
						group by
						    <choose>
								<when test="qys != null and qys.size() >0">
									xs.yhid
									<if test="type !=null and type=='year'">
										, substring(xs.kszq,1,4)
									</if>
									<if test="type !=null and type=='month'">
										, xs.kszq
									</if>
									<if test="type !=null and type == 'quarter'">
										, xs.kszq
									</if>
								</when>
								<otherwise>
									<if test="type !=null and type=='year'">
										substring(xs.kszq,1,4)
									</if>
									<if test="type !=null and type=='month'">
										substring(xs.kszq,1,4) , xs.kszq
									</if>
									<if test="type !=null and type == 'quarter'">
										substring(xs.kszq,1,4) , xs.kszq
									</if>
								</otherwise>
							</choose>
					)xszb on xszb.kszq = tmp.rq
		)ttt
		group by rq, sz
		order by rq
	</select>
	<!-- 月度人均收费测试数（特检+科研）-->
	<select id="getTjNdyrjSfcssList" parameterType="Map" resultType="Map">
		select
		rq,sz,sum(cnt) sumn,
		CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(cnt)/sz,0) END roundn
		from
		(
		        select tmp.cnt,tmp.rq,xszb.sz from
				(
					   select
						case
						when sj.sfsf = '2'
						and tt.xmjclx = 'D' then 0
						when sj.sfsf = '3'
						and tt.xmjclx = 'R' then 0
						else COUNT(sj.sjid)
						end as cnt
						<if test="type !=null and type=='year'">
							,to_char( sj.jsrq, 'yyyy' ) rq
						</if>
						<if test="type !=null and type=='month'">
							,to_char( sj.jsrq, 'yyyy-MM' ) rq
						</if>
						<if test="type !=null and type == 'quarter'">
							,to_char( sj.jsrq, 'yyyy-MM' ) rq
						</if>
						from
						igams_sjxx sj
						left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
						left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
						left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj ='0'
						AND xm.jcxmid in
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
						left outer join
						(select 'D' xmjclx union all select'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')

						WHERE
						sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
						and sj.sfsf != '0'
						and jc_fl.csmc='直销'
						and xm.jcxmid is not null
						<if test="qys != null and qys.size() >0">
							and hb.dqxx in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="sf !=null and sf.size()>0">
							AND hb.sf IN
							<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND to_char(sj.jsrq,'yyyy') in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND to_char(sj.jsrq,'MM') in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						and (sj.sjqf ='195770A431A3445C9055D396F29783BA' or sj.sjqf ='15E778C6EB55468CAAA3783B7AD16657')
						group by
						sj.sfsf,
						tt.xmjclx,
						rq
						UNION ALL
						SELECT COUNT ( fjsq.fjid ) cnt
						<if test="type !=null and type=='year'">
							,to_char( fjsq.lrsj, 'yyyy' ) rq
						</if>
						<if test="type !=null and type=='month'">
							,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
						</if>
						<if test="type !=null and type == 'quarter'">
							,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
						</if>
						FROM
						igams_fjsq fjsq
						LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
						LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc
						AND hb.scbj != '1'
						LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
						LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
						LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
						WHERE
						fjsq.zt = '80'
						AND jc_fjlx.cskz1 = '1'
						AND sj.scbj = '0'
						AND fjsq.scbj = '0'
						AND fjsq.lrsj IS NOT NULL
						AND fjsq.sfff = '1'
						AND fjsq.jcxm IN
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
						AND jc_fl.csmc = '直销'
						<if test="qys != null and qys.size() >0">
							and hb.dqxx in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="sf !=null and sf.size()>0">
							AND hb.sf IN
							<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND to_char(fjsq.lrsj,'yyyy') in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND to_char(fjsq.lrsj,'MM') in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						and (sj.sjqf ='195770A431A3445C9055D396F29783BA' or sj.sjqf ='15E778C6EB55468CAAA3783B7AD16657')
						GROUP BY
						rq
				)tmp
				left outer join
				(
						SELECT
						sum(cast(xs.sz as numeric)) sz
						<if test="type !=null and type=='year'">
							, substring(xs.kszq,1,4) kszq
						</if>
						<if test="type !=null and type=='month'">
							, xs.kszq kszq
						</if>
						<if test="type !=null and type == 'quarter'">
							, xs.kszq kszq
						</if>
						<if test="qys != null and qys.size() >0">
							, xs.yhid
						</if>
						from
						igams_xszb xs
						left join matridx_jcsj zblx on zblx.csid = xs.zblx
						left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
						WHERE
						jc_fl.csmc = '人数'
						and zblx.csmc='月度'
						and (xs.zbzfl='DC89A0E2D4B04739A8B2A20BB919727E')
						<if test="qys != null and qys.size() >0">
							and xs.yhid in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND substring(xs.kszq,1,4) in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND substring(xs.kszq,6,7) in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						group by
						<choose>
							<when test="qys != null and qys.size() >0">
								xs.yhid
								<if test="type !=null and type=='year'">
									, substring(xs.kszq,1,4)
								</if>
								<if test="type !=null and type=='month'">
									, xs.kszq
								</if>
								<if test="type !=null and type == 'quarter'">
									, xs.kszq
								</if>
							</when>
							<otherwise>
								<if test="type !=null and type=='year'">
									substring(xs.kszq,1,4)
								</if>
								<if test="type !=null and type=='month'">
									substring(xs.kszq,1,4) , xs.kszq
								</if>
								<if test="type !=null and type == 'quarter'">
									substring(xs.kszq,1,4) , xs.kszq
								</if>
							</otherwise>
						</choose>
				)xszb on xszb.kszq = tmp.rq
		)ttt
		group by
		rq,sz
		order by
		rq
	</select>
	<!-- 月度人均收费测试数（入院）-->
	<select id="getRyNdyrjSfcssList" parameterType="Map" resultType="Map">
		select
		rq,sz,sum(cnt) sumn,
		CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(cnt)/sz,0) END roundn
		from
		(
				select tmp.cnt,tmp.rq,xszb.sz from
				(
						select
						case
						when sj.sfsf = '2'
						and tt.xmjclx = 'D' then 0
						when sj.sfsf = '3'
						and tt.xmjclx = 'R' then 0
						else COUNT(sj.sjid)
						end as cnt
						<if test="type !=null and type=='year'">
							,to_char( sj.jsrq, 'yyyy' ) rq
						</if>
						<if test="type !=null and type=='month'">
							,to_char( sj.jsrq, 'yyyy-MM' ) rq
						</if>
						<if test="type !=null and type == 'quarter'">
							,to_char( sj.jsrq, 'yyyy-MM' ) rq
						</if>
						from
						igams_sjxx sj
						left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
						left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
						left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj ='0'
						AND xm.jcxmid in
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
						left outer join
						(select 'D' xmjclx union all select'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')

						WHERE
						    sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
						and sj.sfsf != '0'
						and jc_fl.csmc='直销'
						and xm.jcxmid is not null
						<if test="qys != null and qys.size() >0">
							and hb.dqxx in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="sf !=null and sf.size()>0">
							AND hb.sf IN
							<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND to_char(sj.jsrq,'yyyy') in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND to_char(sj.jsrq,'MM') in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						and sj.sjqf ='A90A6D3654FE48F8AA42F15951907ED5'
						group by
						sj.sfsf,
						tt.xmjclx,
						rq
						UNION ALL
						SELECT COUNT
						( fjsq.fjid ) cnt
						<if test="type !=null and type=='year'">
							,to_char( fjsq.lrsj, 'yyyy' ) rq
						</if>
						<if test="type !=null and type=='month'">
							,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
						</if>
						<if test="type !=null and type == 'quarter'">
							,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
						</if>
						FROM
						igams_fjsq fjsq
						LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
						LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc
						AND hb.scbj != '1'
						LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
						LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
						LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
						WHERE
						fjsq.zt = '80'
						AND jc_fjlx.cskz1 = '1'
						AND sj.scbj = '0'
						AND fjsq.scbj = '0'
						AND fjsq.lrsj IS NOT NULL
						AND fjsq.sfff = '1'
						AND fjsq.jcxm IN
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
						AND jc_fl.csmc = '直销'
						<if test="qys != null and qys.size() >0">
							and hb.dqxx in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="sf !=null and sf.size()>0">
							AND hb.sf IN
							<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND to_char(fjsq.lrsj,'yyyy') in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND to_char(fjsq.lrsj,'MM') in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						and sj.sjqf ='A90A6D3654FE48F8AA42F15951907ED5'
						GROUP BY
						rq
				)tmp
				left outer join
				(
						SELECT
						sum(cast(xs.sz as numeric)) sz
						<if test="type !=null and type=='year'">
							, substring(xs.kszq,1,4) kszq
						</if>
						<if test="type !=null and type=='month'">
							, xs.kszq kszq
						</if>
						<if test="type !=null and type == 'quarter'">
							, xs.kszq kszq
						</if>
						<if test="qys != null and qys.size() >0">
							, xs.yhid
						</if>
						from
						igams_xszb xs
						left join matridx_jcsj zblx on zblx.csid = xs.zblx
						left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
						WHERE
						jc_fl.csmc = '人数'
						and zblx.csmc='月度'
						and xs.zbzfl='1756AC2018FF4EAC8A03C6CFC09ECA3F'
						<if test="qys != null and qys.size() >0">
							and xs.yhid in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="nf !=null and nf.size() >0">
							AND substring(xs.kszq,1,4) in
							<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						<if test="yf !=null and yf.size() >0">
							AND substring(xs.kszq,6,7) in
							<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
						group by
						<choose>
							<when test="qys != null and qys.size() >0">
								xs.yhid
								<if test="type !=null and type=='year'">
									, substring(xs.kszq,1,4)
								</if>
								<if test="type !=null and type=='month'">
									, xs.kszq
								</if>
								<if test="type !=null and type == 'quarter'">
									, xs.kszq
								</if>
							</when>
							<otherwise>
								<if test="type !=null and type=='year'">
									substring(xs.kszq,1,4)
								</if>
								<if test="type !=null and type=='month'">
									substring(xs.kszq,1,4) , xs.kszq
								</if>
								<if test="type !=null and type == 'quarter'">
									substring(xs.kszq,1,4) , xs.kszq
								</if>
							</otherwise>
						</choose>
				)xszb on xszb.kszq = tmp.rq
		)ttt
		group by
		rq,sz
		order by
		rq
	</select>
	<!-- 月度人均销售额（直销（特检+入院+科技）） 公式为付款金额总数/人数 -->
	<select id="getNdyrjSfxseList" parameterType="Map" resultType="Map">
		select  rq, sz, sum(money) sumn ,
		CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(money)/sz,0) END roundn
		from
		(
		select tmp.money, tmp.rq, xszb.sz
		from
		(
		select case when sum(sj.fkje) is not null then sum(sj.fkje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( sj.jsrq, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		from  igams_sjxx sj
		left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
		left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
		left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj='0'
		AND xm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
		left outer join ( select 'D' xmjclx  union all select 'R' xmjclx ) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<where>
			sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sj.sfsf != '0'
			and jc_fl.csmc='直销'
			and xm.jcxmid is not null
			<if test="qys != null and qys.size() >0">
				and hb.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND hb.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(sj.jsrq,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(sj.jsrq,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		<if test="type !=null and type=='year'">
			to_char( sj.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sj.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char( sj.jsrq, 'yyyy-MM' )
		</if>
		UNION ALL
		SELECT case when sum(fjsq.yfje) is not null then sum(fjsq.yfje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( fjsq.lrsj, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
		LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc AND hb.scbj != '1'
		LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<where>
			fjsq.zt = '80'
			AND jc_fjlx.cskz1 = '1'
			AND sj.scbj = '0'
			AND fjsq.scbj = '0'
			AND fjsq.lrsj IS NOT NULL
			AND fjsq.sfff = '1'
			AND fjsq.jcxm IN
			<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
			AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
			AND jc_fl.csmc = '直销'
			<if test="qys != null and qys.size() >0">
				and hb.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND hb.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(fjsq.lrsj,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(fjsq.lrsj,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		GROUP BY
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		)tmp
		left outer join(
		SELECT sum(cast(xs.sz as numeric)) sz
		<if test="type !=null and type=='year'">
			, substring(xs.kszq,1,4) kszq
		</if>
		<if test="type !=null and type=='month'">
			, xs.kszq kszq
		</if>
		<if test="type !=null and type == 'quarter'">
			, xs.kszq kszq
		</if>
		<if test="qys != null and qys.size() >0">
			, xs.yhid
		</if>
		from igams_xszb xs
		left join matridx_jcsj zblx on zblx.csid = xs.zblx
		left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
		<where>
			jc_fl.csmc = '人数' and zblx.csmc='月度' and xs.zbzfl is null
			<if test="qys != null and qys.size() >0">
				and xs.yhid in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND substring(xs.kszq,1,4) in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND substring(xs.kszq,6,7) in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		<choose>
			<when test="qys != null and qys.size() >0">
				xs.yhid
				<if test="type !=null and type=='year'">
					, substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					, xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					, xs.kszq
				</if>
			</when>
			<otherwise>
				<if test="type !=null and type=='year'">
					substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
			</otherwise>
		</choose>
		)xszb on xszb.kszq = tmp.rq
		)ttt
		group by rq, sz
		order by rq
	</select>
	<!-- 月度人均销售额（特检+科研）-->
	<select id="getTjNdyrjSfxseList" parameterType="Map" resultType="Map">
		select rq, sz, sum(money) sumn ,
		CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(money)/sz,0) END roundn
		from
		(
		select tmp.money,  tmp.rq, xszb.sz
		from
		(
		select case when sum(sj.fkje) is not null then sum(sj.fkje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( sj.jsrq, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		from igams_sjxx sj
		left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
		left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
		left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj='0'
		AND xm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
		left outer join (select 'D' xmjclx union all select'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<where>
			sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
			and sj.sfsf != '0'
			and jc_fl.csmc='直销'
			and xm.jcxmid is not null
			<if test="qys != null and qys.size() >0">
				and hb.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND hb.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(sj.jsrq,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(sj.jsrq,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			and (sj.sjqf ='195770A431A3445C9055D396F29783BA' or sj.sjqf ='15E778C6EB55468CAAA3783B7AD16657')
		</where>
		group by
		<if test="type !=null and type=='year'">
			to_char( sj.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sj.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char( sj.jsrq, 'yyyy-MM' )
		</if>
		UNION ALL
		SELECT case when sum(fjsq.yfje) is not null then sum(fjsq.yfje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( fjsq.lrsj, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
		LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc AND hb.scbj != '1'
		LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<where>
			fjsq.zt = '80'
			AND jc_fjlx.cskz1 = '1'
			AND sj.scbj = '0'
			AND fjsq.scbj = '0'
			AND fjsq.lrsj IS NOT NULL
			AND fjsq.sfff = '1'
			AND fjsq.jcxm IN
			<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
			AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
			AND jc_fl.csmc = '直销'
			<if test="qys != null and qys.size() >0">
				and hb.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND hb.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(fjsq.lrsj,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(fjsq.lrsj,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			and (sj.sjqf ='195770A431A3445C9055D396F29783BA' or sj.sjqf ='15E778C6EB55468CAAA3783B7AD16657')
		</where>
		GROUP BY
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		)tmp
		left outer join
		(
		SELECT sum(cast(xs.sz as numeric)) sz
		<if test="type !=null and type=='year'">
			, substring(xs.kszq,1,4) kszq
		</if>
		<if test="type !=null and type=='month'">
			, xs.kszq kszq
		</if>
		<if test="type !=null and type == 'quarter'">
			, xs.kszq kszq
		</if>
		<if test="qys != null and qys.size() >0">
			, xs.yhid
		</if>
		from igams_xszb xs
		left join matridx_jcsj zblx on zblx.csid = xs.zblx
		left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
		<where>
			jc_fl.csmc = '人数'
			and zblx.csmc='月度'
			and (xs.zbzfl='DC89A0E2D4B04739A8B2A20BB919727E')
			<if test="qys != null and qys.size() >0">
				and xs.yhid in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND substring(xs.kszq,1,4) in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND substring(xs.kszq,6,7) in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		<choose>
			<when test="qys != null and qys.size() >0">
				xs.yhid
				<if test="type !=null and type=='year'">
					, substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					, xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					, xs.kszq
				</if>
			</when>
			<otherwise>
				<if test="type !=null and type=='year'">
					substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
			</otherwise>
		</choose>
		)xszb on xszb.kszq = tmp.rq
		)ttt
		group by rq,sz
		order by rq
	</select>
	<!-- 月度人均销售额（入院）-->
	<select id="getRyNdyrjSfxseList" parameterType="Map" resultType="Map">
		select rq, sz, sum(money) sumn ,
				CASE WHEN sz IS null or sz='0' THEN 0 ELSE round(sum(money)/sz,0) END roundn
		from
		( select tmp.money, tmp.rq, xszb.sz from
		( select
		case when sum(sj.fkje) is not null then sum(sj.fkje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( sj.jsrq, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( sj.jsrq, 'yyyy-MM' ) rq
		</if>
		from
		igams_sjxx sj
		left outer join igams_sjhbxx hb on sj.db = hb.hbmc and hb.scbj !='1'
		left outer join matridx_jcsj jc_fl on hb.fl = jc_fl.csid
		left outer join igams_sjjcxm xm on xm.sjid = sj.sjid and xm.scbj='0'
		AND xm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		left outer join matridx_jcsj jc_xm on xm.jcxmid = jc_xm.csid
		left outer join
		(select 'D' xmjclx union all select'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE sj.scbj = '0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and sj.sfsf != '0'
		and jc_fl.csmc='直销'
		and xm.jcxmid is not null
		<if test="qys != null and qys.size() >0">
			and hb.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND hb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		and sj.sjqf ='A90A6D3654FE48F8AA42F15951907ED5'
		group by rq
		UNION ALL
		SELECT case when sum(fjsq.yfje) is not null then sum(fjsq.yfje) else 0 end money
		<if test="type !=null and type=='year'">
			,to_char( fjsq.lrsj, 'yyyy' ) rq
		</if>
		<if test="type !=null and type=='month'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		<if test="type !=null and type == 'quarter'">
			,to_char( fjsq.lrsj, 'yyyy-MM' ) rq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON fjsq.sjid = sj.sjid
		LEFT OUTER JOIN igams_sjhbxx hb ON sj.db = hb.hbmc
		AND hb.scbj != '1'
		LEFT OUTER JOIN matridx_jcsj jc_fl ON hb.fl = jc_fl.csid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND jc_fl.csmc = '直销'
		<if test="qys != null and qys.size() >0">
			and hb.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND hb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		and sj.sjqf ='A90A6D3654FE48F8AA42F15951907ED5'
		GROUP BY rq
		)tmp
		left outer join
		(
		SELECT
		sum(cast(xs.sz as numeric)) sz
		<if test="type !=null and type=='year'">
			, substring(xs.kszq,1,4) kszq
		</if>
		<if test="type !=null and type=='month'">
			, xs.kszq kszq
		</if>
		<if test="type !=null and type == 'quarter'">
			, xs.kszq kszq
		</if>
		<if test="qys != null and qys.size() >0">
			, xs.yhid
		</if>
		from
		igams_xszb xs
		left join matridx_jcsj zblx on zblx.csid = xs.zblx
		left join matridx_jcsj jc_fl on xs.zbfl = jc_fl.csid
		WHERE
		jc_fl.csmc = '人数'
		and zblx.csmc='月度'
		and xs.zbzfl='1756AC2018FF4EAC8A03C6CFC09ECA3F'
		<if test="qys != null and qys.size() >0">
			and xs.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND substring(xs.kszq,1,4) in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND substring(xs.kszq,6,7) in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		group by
		<choose>
			<when test="qys != null and qys.size() >0">
				xs.yhid
				<if test="type !=null and type=='year'">
					, substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					, xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					, xs.kszq
				</if>
			</when>
			<otherwise>
				<if test="type !=null and type=='year'">
					substring(xs.kszq,1,4)
				</if>
				<if test="type !=null and type=='month'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
				<if test="type !=null and type == 'quarter'">
					substring(xs.kszq,1,4) , xs.kszq
				</if>
			</otherwise>
		</choose>
		)xszb on xszb.kszq = tmp.rq)ttt
		group by
		rq,sz
		order by
		rq
	</select>
	<!--渠道收费测试数-->
	<select id="getSfChannelChargeData" resultType="Map">
		SELECT tmp.cskz4 qdmc,SUM ( tmp.sfnum ) sfnum,tmp.jsrq rq
		FROM
		(
		SELECT
		hb_jcsj.cskz4,
		CASE
		WHEN sjxx.sfsf = '1' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '2'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '3'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sjxx.sjid ) ELSE 0
		END AS sfnum,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid
		AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid is not null and sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND sjxx.jsrq IS NOT NULL
		AND sjxx.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		AND sjxx.sfsf != '0'
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		hb_jcsj.cskz4,
		sjxx.sfsf,
		tt.xmjclx,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		hb_jcsj.cskz4,
		COUNT ( fjsq.fjid )sfnum,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		left join matridx_jcsj jc_fjlx on jc_fjlx.csid = fjsq.lx
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80' and jc_fjlx.csdm = 'ADDDETECT'  and sjxx.scbj='0' AND fjsq.scbj = '0' AND fjsq.lrsj IS NOT NULL
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.sfff = '1'
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		tmp.cskz4,
		rq
		ORDER BY rq
	</select>
	<!--业务类型收费测试数-->
	<select id="getSfBusinessTypeChargeData" parameterType="Map" resultType="Map">
		SELECT
		tmp.jsrq rq,
		tmp.qfmc,
		SUM ( tmp.sfnum ) sfnum
		FROM
		(
		SELECT
		qf_jcsj.csmc qfmc,
		CASE
		WHEN sjxx.sfsf = '1' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '2'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sjxx.sjid )
		WHEN sjxx.sfsf = '3'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sjxx.sjid ) ELSE 0
		END AS sfnum,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0' AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj!='1'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid is not null and
		sjhbxx.fl in
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		and sjxx.jsrq IS NOT NULL
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND sjxx.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		AND sjxx.sfsf != '0'
		AND qf_jcsj.csmc IS NOT NULL
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		qf_jcsj.csmc,
		sjxx.sfsf,
		tt.xmjclx,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		qf_jcsj.csmc qfmc,
		COUNT ( fjsq.fjid ) sfnum,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND jc_fjlx.cskz1 = '1'
		AND sjxx.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND qf_jcsj.csmc IS NOT NULL
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		tmp.qfmc,
		rq
		ORDER BY
			rq
	</select>
	<!--渠道收费免费测试数-->
	<select id="getSfMfChannelChargeData" parameterType="Map" resultType="Map">
		SELECT
		SUM ( tmp.sfnum ) sfnum,SUM ( tmp.bsfnum ) bsfnum,
		tmp.jsrq rq,tmp.cskz4 qdmc
		FROM
		(
		SELECT
		case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum,
		case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum,hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid
		AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid is not null
		<if test="hbflid != null and hbflid.size() >0">
			and sjhbxx.fl IN
			<foreach collection="hbflid" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		AND sjxx.jsrq IS NOT NULL
		AND sjxx.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjxx.sfsf,
		tt.xmjclx,
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		CASE
		WHEN
		fjsq.sfff = '1' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS sfnum,
		CASE
		WHEN fjsq.sfff != '1' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS bsfnum,
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid
		AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sjxx.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="hbflid != null and hbflid.size() >0">
			and sjhbxx.fl IN
			<foreach collection="hbflid" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		fjsq.sfff,
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		rq,qdmc
		ORDER BY rq
	</select>
	<!--业务类型收费免费测试数-->
	<select id="getSfMfBusinessTypeChargeData" parameterType="Map" resultType="Map">
		SELECT
		tmp.jsrq rq,
		SUM ( tmp.sfnum ) sfnum, 	SUM ( tmp.bsfnum ) bsfnum,tmp.csmc qfmc
		FROM
		(
		SELECT
		case when sjxx.sfsf = '1' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		ELSE 0 end AS sfnum,
		case when sjxx.sfsf = '0' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='2' and tt.xmjclx ='D' then COUNT(sjxx.sjid)
		when sjxx.sfsf ='3' and tt.xmjclx ='R' then COUNT(sjxx.sjid)
		ELSE 0 end AS bsfnum,qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN matridx_jcsj lx_jcsj ON lx_jcsj.csid = sjxx.kyxm
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid is not null and
		sjxx.jsrq IS NOT NULL
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0 and qys != null and qys.size() >0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND qf_jcsj.csid = #{sjqf}
		AND sjxx.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		AND ( lx_jcsj.cskz1 != '免费科研' OR lx_jcsj.cskz1 IS NULL )
		AND qf_jcsj.csmc IS NOT NULL
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjxx.sfsf,
		tt.xmjclx,
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		CASE
		WHEN
		fjsq.sfff = '1' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS sfnum,
		CASE
		WHEN fjsq.sfff != '1' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS bsfnum,
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
		to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN matridx_jcsj lx_jcsj ON lx_jcsj.csid = sjxx.kyxm
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db and sjhbxx.scbj != '1'
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sjxx.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND qf_jcsj.csid = #{sjqf}
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND ( lx_jcsj.cskz1 != '免费科研' OR lx_jcsj.cskz1 IS NULL )
		AND qf_jcsj.csmc IS NOT NULL
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0 and qys != null and qys.size() >0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		fjsq.sfff,
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		rq,qfmc
		ORDER BY rq
	</select>
	<!--获取销售测达成率-->
	<select id="getKpiList" parameterType="Map" resultType="Map">
		SELECT endtmp.jd ,endtmp.hbflmc,sum(cast(endtmp.cnum as numeric)) endnum,sum(cast(endtmp.sz as numeric)) endsz,concat(round(sum(cast(endtmp.cnum as numeric)) * 100 / sum(cast(endtmp.sz as numeric)),0),'%')  FROM (
		SELECT jd, case when dq.gwmc is not null then dq.gwmc else dq.zsxm end dq, tmp.hbflmc, COUNT(tmp.sjid) AS cnum, xszb.sz
		FROM
			( SELECT to_char( sj.jsrq, 'yyyy' ) || 'Q' || EXTRACT ( quarter FROM sj.jsrq ) jd , sjhbxx.dqxx, tt.xmjclx, jc_hbfl.csmc, case when jc_hbfl.cskz4 is not null then jc_hbfl.cskz4 else jc_hbfl.csmc end hbflmc,
		sj.sjid, case when sj.sfsf ='2' and tt.xmjclx = 'D' then 0 when sj.sfsf ='3' and tt.xmjclx = 'R' then 0 else COUNT(sj.sjid) end cnt
				FROM igams_sjxx sj
				LEFT JOIN igams_sjjcxm jcxm ON sj.sjid = jcxm.sjid and jcxm.scbj='0' AND jcxm.jcxmid in
				<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
				LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
				LEFT JOIN matridx_jcsj jc_hbfl on jc_hbfl.csid = sjhbxx.fl
				LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				WHERE CASE WHEN sj.sfsf = '3' THEN xmjclx ='D' when sj.sfsf = '2' then xmjclx ='R' else 1=1 end
				AND sj.scbj = '0' and sjhbxx.dqxx is not null and sj.sfsf !='0'
				AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
				GROUP BY sj.sjid, tt.xmjclx, jc_hbfl.csmc, jc_hbfl.cskz4, sjhbxx.dqxx, sj.sfsf, to_char( sj.jsrq, 'yyyy' ) || 'Q' || EXTRACT ( quarter FROM sj.jsrq )
				UNION ALL
				SELECT
				to_char( fjsq.lrsj, 'yyyy' ) || 'Q' || EXTRACT ( quarter FROM fjsq.lrsj ) jd,
				sjhbxx.dqxx,
				tt.xmjclx,
				jc_hbfl.csmc,
				CASE
				WHEN jc_hbfl.cskz4 IS NOT NULL THEN
				jc_hbfl.cskz4 ELSE jc_hbfl.csmc
				END hbflmc,
				fjsq.fjid sjid,
				COUNT ( fjsq.fjid ) cnt
				FROM
				igams_fjsq fjsq
				LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
				LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
				LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
				LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
				AND sjhbxx.scbj != '1'
				LEFT JOIN matridx_jcsj jc_hbfl ON jc_hbfl.csid = sjhbxx.fl
				LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
				WHERE
				fjsq.zt = '80'
				AND jc_fjlx.cskz1 = '1'
				AND sj.scbj = '0'
				AND fjsq.scbj = '0'
				AND fjsq.lrsj IS NOT NULL
				AND fjsq.sfff = '1'
				AND fjsq.jcxm IN
				<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
				AND sjhbxx.dqxx IS NOT NULL
				AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
				GROUP BY
				fjsq.fjid,
				tt.xmjclx,
				jc_hbfl.csmc,
				jc_hbfl.cskz4,
				sjhbxx.dqxx,
				to_char( fjsq.lrsj, 'yyyy' ) || 'Q' || EXTRACT ( quarter FROM fjsq.lrsj )
			) tmp
		left join matridx_xtyh dq on dq.yhid = tmp.dqxx
		left join igams_xszb xszb on xszb.yhid = tmp.dqxx and to_char( to_date(xszb.kszq, 'yyyy-MM'), 'yyyy' ) || 'Q' || EXTRACT ( quarter FROM to_date(xszb.kszq, 'yyyy-MM') ) = jd
		left join matridx_jcsj jc_zbzfl on xszb.zbzfl = jc_zbzfl.csid
		left join matridx_jcsj jc_zblx on xszb.zblx = jc_zblx.csid
		where jc_zbzfl.csmc = tmp.hbflmc and jc_zblx.csdm = #{zblx}
		<if test="qys != null and qys.size() >0">
			and dq.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="Mzbrqs !=null and Mzbrqs.size() >0">
			AND xszb.kszq in
			<foreach collection="Mzbrqs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="Yzbrqs !=null and Yzbrqs.size() >0">
			AND to_char( to_date(xszb.kszq, 'yyyy'), 'yyyy' ) in
			<foreach collection="Yzbrqs" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		tmp.hbflmc,xszb.yhid,tmp.dqxx,dq.gwmc,dq.zsxm,xszb.sz,xszb.zbfl,xszb.zbzfl,tmp.jd
		ORDER BY case when dq.gwmc is not null then dq.gwmc else dq.zsxm end, tmp.hbflmc
		) endtmp
		GROUP BY endtmp.jd,endtmp.hbflmc
	</select>

	<select id="getCentralHospitalData" parameterType="Map" resultType="Map">
		SELECT
			tmp.yyzddj,tmp.rq,
			COUNT(tmp.sjid) AS cnum
		FROM
			( SELECT
				  sj.sjid,to_char(sj.jsrq, 'yyyy-MM') rq,
				  yyxx.dwmc sjdwmc,case when yyxx.cskz2 is not null and yyxx.cskz2 != '' then yyxx.cskz2 ELSE 'others' end yyzddj,
				  case
					  when sj.sfsf ='2'
						  and tt.xmjclx = 'D' then 0
					  when sj.sfsf ='3'
						  and tt.xmjclx = 'R' then 0
					  else COUNT(sj.sjid)
					  end cnt
			  FROM
				  igams_sjxx sj
					  LEFT JOIN
				  igams_yyxx yyxx
				  ON yyxx.dwid = sj.sjdw
					  LEFT JOIN
				  igams_sjjcxm jcxm
				  ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
					AND jcxm.jcxmid in
					<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
						#{item}
					</foreach>
					  LEFT JOIN
				  matridx_jcsj jc_jcxm
				  ON jc_jcxm.csid = jcxm.jcxmid
					  LEFT JOIN
				  igams_sjhbxx sjhbxx
				  ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
					  LEFT JOIN
				  (
					  SELECT
						  'D' AS xmjclx
					  UNION
						  ALL SELECT
						  'R' AS xmjclx
				  ) tt
				  ON (jc_jcxm.cskz1 = 'C' and jc_jcxm.cskz3!='IMP_REPORT_SEQ_INDEX_TEMEPLATE' and jc_jcxm.cskz3!='IMP_REPORT_SEQ_XINDEX_TEMEPLATE')
					  OR xmjclx = jc_jcxm.cskz1
			  WHERE
				  CASE
					  WHEN sj.sfsf = '3' THEN xmjclx ='D'
					  when sj.sfsf = '2' then xmjclx ='R'
					  else 1=1
					  end
				and sj.sfsf !='0'
				AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
				and jcxm.jcxmid is not null
        AND sj.scbj = '0'
        and sjhbxx.fl in (
            '0954A23558524DA0BD22321EB35D3D57'
        )
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
			  GROUP BY
			      sj.jsrq,
				  sj.sjid,
				  yyxx.dwmc,yyxx.cskz2,
				  tt.xmjclx,
				  sj.sfsf
		UNION ALL
		SELECT
		fjsq.fjid sjid,
		to_char( fjsq.lrsj, 'yyyy-MM' ) rq,
		yyxx.dwmc sjdwmc,
		CASE
		WHEN yyxx.cskz2 IS NOT NULL
		AND yyxx.cskz2 != '' THEN
		yyxx.cskz2 ELSE'others'
		END yyzddj,
		COUNT(fjsq.fjid) cnt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN ( SELECT 'D' AS xmjclx UNION ALL SELECT 'R' AS xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sjhbxx.fl IN ( '0954A23558524DA0BD22321EB35D3D57' )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		to_char( fjsq.lrsj, 'yyyy-MM' ),
		fjsq.fjid,
		yyxx.dwmc,
		yyxx.cskz2,
		tt.xmjclx
			) tmp
		GROUP BY
			tmp.yyzddj,tmp.rq
		ORDER BY rq,yyzddj,
				 COUNT(tmp.sjid) DESC
	</select>
<select id="getHospitalSales"  parameterType="Map"  resultType="Map">
		SELECT
		tmp.dwmc,
		SUM ( tmp.dlssfnum ) dlssfnum,
		SUM ( tmp.zxsfnum ) zxsfnum,
		SUM ( tmp.dlssfnum )+SUM ( tmp.zxsfnum ) zh,
		tmp.yyzddj,
		tmp.dqxx
		FROM
		(
		SELECT
		CASE
		WHEN
		yyxx.tjmc IS NOT NULL THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN sj.sfsf = '1' and hbfl.cskz4 = '直销' THEN
		COUNT ( sj.sjid )
		WHEN sj.sfsf = '2' and hbfl.cskz4 = '直销'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sj.sjid )
		WHEN sj.sfsf = '3' and hbfl.cskz4 = '直销'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sj.sjid ) ELSE 0
		END AS zxsfnum,
		CASE

		WHEN sj.sfsf = '1' and hbfl.cskz4 = '代理商' THEN
		COUNT ( sj.sjid )
		WHEN sj.sfsf = '2' and hbfl.cskz4 = '代理商'
		AND tt.xmjclx = 'R' THEN
		COUNT ( sj.sjid )
		WHEN sj.sfsf = '3' and hbfl.cskz4 = '代理商'
		AND tt.xmjclx = 'D' THEN
		COUNT ( sj.sjid ) ELSE 0
		END AS dlssfnum,
		yyxx.cskz2 yyzddj,
		sf.csmc dqxx
		FROM
		igams_sjxx sj
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc = sj.db and sjhb.scbj != '1'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		left join matridx_jcsj hbfl on hbfl.csid=sjhb.fl
		left join matridx_jcsj sf on sf.csid=yyxx.sf
	LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhb.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		 sj.jsrq IS NOT NULL
		AND sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sj.sfsf!='0'
		and jcxm.jcxmid is not null
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhb.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="yyzddjs!=null and yyzddjs.length>0">
			and yyxx.cskz2 IN
			<foreach collection="yyzddjs" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.tjmc,
		yyxx.dwmc,
		sj.sfsf,
		tt.xmjclx,
		yyxx.cskz2,
		hbfl.cskz4,
		sf.csmc
		UNION ALL
		SELECT
		CASE
		WHEN
		yyxx.tjmc IS NOT NULL THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN hbfl.cskz4 = '直销' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS zxsfnum,
		CASE
		WHEN hbfl.cskz4 = '代理商' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END AS dlssfnum,
		yyxx.cskz2 yyzddj,
		sf.csmc dqxx
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc = sj.db
		AND sjhb.scbj != '1'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhb.fl
		LEFT JOIN matridx_jcsj sf ON sf.csid = yyxx.sf
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhb.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.tjmc,
		yyxx.dwmc,
		yyxx.cskz2,
		hbfl.cskz4,
		sf.csmc
		) tmp
		group by
		tmp.dwmc,
		tmp.yyzddj,
		tmp.dqxx
		order by
		SUM ( tmp.dlssfnum )+SUM ( tmp.zxsfnum ) desc
	</select>
	<select id="getZx" parameterType="Map" resultType="Map">
		SELECT SUM ( tmp.zj ) total,
			   tmp.swmc,tmp.dqxx,tmp.zt,
			   SUM ( tmp.kj ) kj,
			   SUM ( tmp.ry ) ry,
			   SUM ( tmp.tj ) tj
		FROM
			(
				SELECT
					COALESCE(sjhbxx.swmc,sjhbxx.hbmc) swmc,
					case when yh.gwmc is not null then yh.gwmc else yh.zsxm end dqxx,
					CASE

						WHEN qf.csmc = '科研'
							AND lxbh.cskz1 = '科技服务' THEN
							COUNT ( sj.sjid ) ELSE 0
						END kj,
					CASE

						WHEN qf.csmc = '特检' THEN
							COUNT ( sj.sjid ) ELSE 0
						END tj,
					CASE

						WHEN qf.csmc = '入院' THEN
							COUNT ( sj.sjid ) ELSE 0
						END ry,
					CASE

						WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
							COUNT ( sj.sjid ) ELSE 0
						END zj,
						case when sjhbxx.scbj='0' then '正常' when sjhbxx.scbj ='1' then '已删除' else '已停用' end zt
				FROM
					igams_sjxx sj
						LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
						LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
						AND jcxm.jcxmid in
						<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
							#{item}
						</foreach>
						LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
						LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
						LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
						LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
						LEFT JOIN matridx_xtyh yh on yh.yhid=sjhbxx.dqxx
						<if test="qys != null and qys.size() >0">
							LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
							AND hbqx.yhid in
							<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
								#{item}
							</foreach>
						</if>
				WHERE
					sj.scbj = '0'
				  AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
				  and hbfl.csmc ='直销'
				  and jcxm.jcxmid is not null
					<if test="qys != null and qys.size() >0">
						AND hbqx.hbid IS NOT NULL
					</if>
					<if test="sf !=null and sf.size()>0">
						AND sjhbxx.sf IN
						<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
							#{item}
						</foreach>
					</if>
				  AND (
							sj.sfsf = '1'
						OR ( sj.sfsf = '2' AND tt.xmjclx != 'D' )
						OR ( sj.sfsf = '3' AND tt.xmjclx != 'R' )
					)
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test=" yhid !=null and yhid !=''">
			AND qx.yhid IS NOT NULL
		</if>
				GROUP BY
					sjhbxx.swmc,
					qf.csmc,
					sjhbxx.dqxx,
					sj.sjqf,
					lxbh.cskz1,
					yh.gwmc,yh.zsxm,sjhbxx.hbmc,sjhbxx.scbj
		UNION ALL
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE
		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE
		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END kj,
		CASE
		WHEN qf.csmc = '特检' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END tj,
		CASE
		WHEN qf.csmc = '入院' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END ry,
		CASE
		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END zj,
		CASE
		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND hbfl.csmc = '直销'
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj
			) tmp
		GROUP BY
			tmp.swmc,tmp.dqxx,tmp.zt
		ORDER BY
			SUM ( tmp.zj ) DESC
	</select>

	<select id="getNewPartner" parameterType="Map" resultType="map">
		SELECT
		db,
		jsrq,
		px
		FROM
		(
		SELECT
		sj.db
		,to_char( sj.jsrq, 'yyyy-MM-dd' ) jsrq
		,ROW_NUMBER ( ) OVER ( PARTITION BY sj.db ORDER BY sj.jsrq ASC ) px
		FROM
		igams_sjxx sj
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN igams_sjhbxx hb ON hb.hbmc = sj.db and hb.scbj != '1'
		WHERE
		sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		<if test="sf !=null and sf.size()>0">
			AND hb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		ORDER BY
		sj.db,
		sj.jsrq
		) tmp
		WHERE
		tmp.px = 1
	</select>


	<select id="getNewPartnertotal" parameterType="Map" resultType="Map">
		select
		tmp.db,to_char(tmp.jsrq,'yyyy-mm-dd') jsrq,case when tmp.dqxx is not null then tmp.dqxx else '' end dqxx,tmp.zt
		FROM
		( SELECT sj.db,jsrq ,case when yh.gwmc is not null then yh.gwmc else yh.zsxm end dqxx,case when hb.scbj='0' then '正常' when hb.scbj='1' then '已删除' else '已停用' end zt,
		ROW_NUMBER ( ) OVER ( PARTITION BY sj.db ORDER BY sj.jsrq ASC ) px
		FROM igams_sjxx sj
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN igams_sjhbxx hb ON hb.hbmc = sj.db and hb.scbj!='1'
		left join matridx_xtyh yh on yh.yhid=hb.dqxx
		WHERE
		sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and hb.hbid is not null
		<if test="qys != null and qys.size() >0">
			and hb.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND hb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="hbfls_totalpal!=null and hbfls_totalpal.size()>0">
			and hb.fl IN
			<foreach collection="hbfls_totalpal" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			and hb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		ORDER BY sj.jsrq ) tmp
		WHERE
		tmp.px = 1
		<if test="nf !=null and nf.size() >0">
			AND to_char(tmp.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(tmp.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
	</select>

	<select id="getLosePartners" parameterType="map" resultType="map">
		select db,yellow,red,black,to_char(jsrq,'yyyy-mm-dd') jsrq,dqxx,zt from
		(
		SELECT
		sjxx.db,
		sjxx.jsrq,
		case when yh.gwmc IS NOT NULL THEN yh.gwmc ELSE yh.zsxm END dqxx,
		case when (date_part( 'day', LOCALTIMESTAMP :: TIMESTAMP - sjxx.jsrq :: TIMESTAMP )&gt;='30' AND date_part( 'day', LOCALTIMESTAMP :: TIMESTAMP - sjxx.jsrq :: TIMESTAMP ) &lt;='60') then '1' else '0' end yellow,
		case when (date_part( 'day', LOCALTIMESTAMP :: TIMESTAMP - sjxx.jsrq :: TIMESTAMP )&gt;='60' AND date_part( 'day', LOCALTIMESTAMP :: TIMESTAMP - sjxx.jsrq :: TIMESTAMP ) &lt;='90') then '1' else '0' end red,
		case when (date_part( 'day', LOCALTIMESTAMP :: TIMESTAMP - sjxx.jsrq :: TIMESTAMP )&gt;='90' ) then '1' else '0' end black,
		case when sjhb.scbj='0' then '正常' when sjhb.scbj='1' then '已删除' else '已停用' end zt,
		row_number() over(partition by sjxx.db order by sjxx.jsrq desc) imp
		FROM
		igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc = sjxx.db and sjhb.scbj != '1'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		left join matridx_xtyh yh on yh.yhid=sjhb.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhb.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sjxx.scbj = '0'
		and jcxm.jcxmid is  not null
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and sjxx.jsrq is not null
		and sjhb.hbid is not null
		and sjhb.scbj='0'
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhb.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		group by sjxx.db,sjxx.jsrq,yh.gwmc,yh.zsxm,sjhb.scbj
		order by sjxx.jsrq asc
		) tmp where tmp.imp=1
	</select>
	<!--第三方实验室TOP10排行-->
	<select id="getTopDsf" parameterType="Map" resultType="Map">
		SELECT SUM ( tmp.zj ) total,
		tmp.swmc,tmp.dqxx,
		SUM ( tmp.kj ) kj,
		SUM ( tmp.ry ) ry,
		SUM ( tmp.tj ) tj,
		tmp.zt
		FROM
		(
		SELECT
		COALESCE(sjhbxx.swmc,sjhbxx.hbmc) swmc,
		case when yh.gwmc is not null then yh.gwmc else yh.zsxm end dqxx,
		CASE
		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		COUNT ( sj.sjid ) ELSE 0
		END kj,
		CASE
		WHEN qf.csmc = '特检' THEN
		COUNT ( sj.sjid ) ELSE 0
		END tj,
		CASE
		WHEN qf.csmc = '入院' THEN
		COUNT ( sj.sjid ) ELSE 0
		END ry,
		CASE
		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		COUNT ( sj.sjid ) ELSE 0
		END zj,case when sjhbxx.scbj='0' then '正常' when sjhbxx.scbj='1' then '已删除' else '已停用' end zt
		FROM
		igams_sjxx sj
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh on yh.yhid=sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.scbj = '0' and hbfl.csmc ='第三方实验室'
		and jcxm.jcxmid is not null
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		AND (
		sj.sfsf = '1'
		OR ( sj.sfsf = '2' AND tt.xmjclx != 'D' )
		OR ( sj.sfsf = '3' AND tt.xmjclx != 'R' )
		)
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,yh.zsxm,sjhbxx.hbmc,sjhbxx.scbj
		UNION ALL
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE
		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE
		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END kj,
		CASE
		WHEN qf.csmc = '特检' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END tj,
		CASE
		WHEN qf.csmc = '入院' THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END ry,
		CASE
		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END zj,
		CASE
		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND hbfl.csmc = '第三方实验室'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj
		) tmp
		GROUP BY
		tmp.swmc,tmp.dqxx,tmp.zt
		ORDER BY
		SUM ( tmp.zj ) DESC
	</select>
	<!--代理商(代理+CSO)top10-->
	<select id="getTopDls" parameterType="Map" resultType="Map">
		SELECT coalesce(SUM ( tmp.zj ),0) total,
		tmp.swmc,tmp.dqxx,
		tmp.zt,jsrq
		FROM
		(
		SELECT
		COALESCE(sjhbxx.swmc,sjhbxx.hbmc) swmc,
		case when yh.gwmc is not null then yh.gwmc else yh.zsxm end dqxx,
		CASE
		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		COUNT ( sj.sjid ) ELSE 0
		END zj,
		case when sjhbxx.scbj='0' then '正常' when sjhbxx.scbj='1' then '已删除' else '已停用' end zt,
		<if test="type !=null and type=='year'">
			to_char(sj.jsrq,'yyyy') jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char(sj.jsrq,'MM') jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sj.jsrq,'MM') jsrq
		</if>
		FROM
		igams_sjxx sj
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh on yh.yhid=sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.scbj = '0' and (hbfl.csmc ='CSO' or hbfl.csmc ='代理商')
		and jcxm.jcxmid is not null
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		AND (
		sj.sfsf = '1'
		OR ( sj.sfsf = '2' AND tt.xmjclx != 'D' )
		OR ( sj.sfsf = '3' AND tt.xmjclx != 'R' )
		)
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,yh.zsxm,sjhbxx.hbmc,sjhbxx.scbj,jsrq
		UNION ALL
		SELECT
		COALESCE(sjhbxx.swmc,sjhbxx.hbmc) swmc,
		case when yh.gwmc is not null then yh.gwmc else yh.zsxm end dqxx,
		CASE
		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		COUNT ( fjsq.fjid ) ELSE 0
		END zj,
		case when sjhbxx.scbj='0' then '正常' when sjhbxx.scbj='1' then '已删除' else '已停用' end zt,
		<if test="type !=null and type=='year'">
			to_char(fjsq.lrsj,'yyyy') jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char(fjsq.lrsj,'MM') jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj,'MM') jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON (jc_jcxm.cskz1 ='C' or xmjclx = jc_jcxm.cskz1) and jc_jcxm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		and (hbfl.csmc ='CSO' or hbfl.csmc ='代理商')
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj,
		<if test="type !=null and type=='year'">
			to_char(fjsq.lrsj,'yyyy')
		</if>
		<if test="type !=null and type=='month'">
			to_char(fjsq.lrsj,'MM')
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj,'MM')
		</if>
		) tmp
		GROUP BY
		tmp.swmc,tmp.dqxx,tmp.zt,jsrq
		ORDER BY
		jsrq
	</select>
	<!--渠道收费销售金额-->
	<select id="getSfChannelChargeDataWithAmount" parameterType="Map" resultType="Map">
		SELECT
		tmp.cskz4 qdmc,
		COALESCE(SUM ( tmp.yfje ),0) sfnum,
		tmp.jsrq rq
		FROM
		(
		SELECT
		hb_jcsj.cskz4,
		SUM(sjxx.fkje) yfje,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid
		AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid IS NOT NULL
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>		AND sjxx.jsrq IS NOT NULL
		AND sjxx.scbj = '0'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sjxx.sfsf != '0'
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		hb_jcsj.cskz4,
		SUM(fjsq.yfje) yfje,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hb_jcsj ON sjhbxx.fl = hb_jcsj.csid
		AND hb_jcsj.jclb = 'CLASSIFY'
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sjxx.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.sfff = '1'
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		hb_jcsj.cskz4,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		tmp.cskz4,
		rq
		ORDER BY
		rq
	</select>
	<!--业务类型收费销售金额-->
	<select id="getSfBusinessTypeChargeDataWithAmount" parameterType="Map" resultType="Map">
		SELECT
		tmp.jsrq rq,
		tmp.qfmc,
		COALESCE(SUM ( tmp.yfje ),0) sfnum
		FROM
		(
		SELECT
		qf_jcsj.csmc qfmc,
		SUM(sjxx.fkje) yfje,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq) jsrq
		</if>
		FROM
		igams_sjxx sjxx
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sjxx.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		jcxm.jcxmid IS NOT NULL
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		AND sjxx.jsrq IS NOT NULL
		AND sjxx.scbj = '0'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sjxx.sfsf != '0'
		AND qf_jcsj.csmc IS NOT NULL
		<if test="nf !=null and nf.size() >0">
			AND to_char(sjxx.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sjxx.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( sjxx.jsrq, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( sjxx.jsrq, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sjxx.jsrq, 'yyyy')||'Q'||EXTRACT (quarter FROM sjxx.jsrq)
		</if>
		UNION ALL
		SELECT
		qf_jcsj.csmc qfmc,
		SUM ( fjsq.yfje ) yfje,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' ) jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' ) jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj) jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj qf_jcsj ON sjxx.sjqf = qf_jcsj.csid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		AND sjhbxx.scbj != '1'
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND sjxx.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND sjhbxx.fl IN
		<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND qf_jcsj.csmc IS NOT NULL
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		qf_jcsj.csmc,
		<if test="type !=null and type=='year'">
			to_char( fjsq.lrsj, 'yyyy' )
		</if>
		<if test="type !=null and type=='month'">
			to_char( fjsq.lrsj, 'yyyy-MM' )
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj, 'yyyy')||'Q'||EXTRACT (quarter FROM fjsq.lrsj)
		</if>
		) tmp
		GROUP BY
		tmp.qfmc,
		rq
		ORDER BY
		rq
	</select>
	<select id="getZxWithAmount" parameterType="Map" resultType="Map">
		SELECT COALESCE
		( SUM ( tmp.zj ), 0 ) total,
		tmp.swmc,
		tmp.dqxx,
		tmp.zt,
		COALESCE ( SUM ( tmp.kj ), 0 ) kj,
		COALESCE ( SUM ( tmp.ry ), 0 ) ry,
		COALESCE ( SUM ( tmp.tj ), 0 ) tj
		FROM
		(
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		SUM ( sj.fkje ) ELSE 0
		END kj,
		CASE

		WHEN qf.csmc = '特检' THEN
		SUM ( sj.fkje ) ELSE 0
		END tj,
		CASE

		WHEN qf.csmc = '入院' THEN
		SUM ( sj.fkje ) ELSE 0
		END ry,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( sj.fkje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_sjxx sj
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.scbj = '0'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND hbfl.csmc = '直销'
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test=" yhid !=null and yhid !=''">
			AND qx.yhid IS NOT NULL
		</if>
		AND jcxm.jcxmid IS NOT NULL
		AND sj.sfsf != '0'
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj UNION ALL
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END kj,
		CASE

		WHEN qf.csmc = '特检' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END tj,
		CASE

		WHEN qf.csmc = '入院' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END ry,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( fjsq.yfje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND hbfl.csmc = '直销'
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj
		) tmp
		GROUP BY
		tmp.swmc,
		tmp.dqxx,
		tmp.zt
		ORDER BY
		SUM ( tmp.zj ) DESC
	</select>
	<!--代理商(代理+CSO)销售金额top10-->
	<select id="getTopDlsWithAmount" parameterType="Map" resultType="Map">
		SELECT COALESCE
		( SUM ( tmp.zj ), 0 ) total,
		tmp.swmc,
		tmp.dqxx,
		tmp.zt,
		jsrq
		FROM
		(
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( sj.fkje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt,
		<if test="type !=null and type=='year'">
			to_char(sj.jsrq,'yyyy') jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char(sj.jsrq,'MM') jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(sj.jsrq,'MM') jsrq
		</if>
		FROM
		igams_sjxx sj
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.scbj = '0'
		AND ( hbfl.csmc = 'CSO' OR hbfl.csmc = '代理商' )
		AND jcxm.jcxmid IS NOT NULL
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sj.sfsf != '0'
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj,
		jsrq UNION ALL
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( fjsq.yfje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt,
		<if test="type !=null and type=='year'">
			to_char(fjsq.lrsj,'yyyy') jsrq
		</if>
		<if test="type !=null and type=='month'">
			to_char(fjsq.lrsj,'MM') jsrq
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj,'MM') jsrq
		</if>
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( hbfl.csmc = 'CSO' OR hbfl.csmc = '代理商' )
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj,
		<if test="type !=null and type=='year'">
			to_char(fjsq.lrsj,'yyyy')
		</if>
		<if test="type !=null and type=='month'">
			to_char(fjsq.lrsj,'MM')
		</if>
		<if test="type !=null and type == 'quarter'">
			to_char(fjsq.lrsj,'MM')
		</if>
		) tmp
		GROUP BY
		tmp.swmc,
		tmp.dqxx,
		tmp.zt,
		jsrq
		ORDER BY
		jsrq
	</select>
	<!--第三方实验室销售金额TOP10排行-->
	<select id="getTopDsfWithAmount" parameterType="Map" resultType="Map">
		SELECT COALESCE(SUM
		( tmp.zj ),0) total,
		tmp.swmc,
		tmp.dqxx,
		COALESCE(SUM ( tmp.kj ),0) kj,
		COALESCE(SUM ( tmp.ry ),0) ry,
		COALESCE(SUM ( tmp.tj ),0) tj,
		tmp.zt
		FROM
		(
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		SUM ( sj.fkje ) ELSE 0
		END kj,
		CASE

		WHEN qf.csmc = '特检' THEN
		SUM ( sj.fkje ) ELSE 0
		END tj,
		CASE

		WHEN qf.csmc = '入院' THEN
		SUM ( sj.fkje ) ELSE 0
		END ry,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( sj.fkje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_sjxx sj
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.scbj = '0'
		AND hbfl.csmc = '第三方实验室'
		AND jcxm.jcxmid IS NOT NULL
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sj.sfsf!='0'
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj UNION ALL
		SELECT COALESCE
		( sjhbxx.swmc, sjhbxx.hbmc ) swmc,
		CASE

		WHEN yh.gwmc IS NOT NULL THEN
		yh.gwmc ELSE yh.zsxm
		END dqxx,
		CASE

		WHEN qf.csmc = '科研'
		AND lxbh.cskz1 = '科技服务' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END kj,
		CASE

		WHEN qf.csmc = '特检' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END tj,
		CASE

		WHEN qf.csmc = '入院' THEN
		SUM ( fjsq.yfje ) ELSE 0
		END ry,
		CASE

		WHEN ( ( qf.csmc = '科研' AND lxbh.cskz1 = '科技服务' ) OR qf.csmc = '特检' OR qf.csmc = '入院' ) THEN
		SUM ( fjsq.yfje ) ELSE 0
		END zj,
		CASE

		WHEN sjhbxx.scbj = '0' THEN
		'正常'
		WHEN sjhbxx.scbj = '1' THEN
		'已删除' ELSE'已停用'
		END zt
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN matridx_jcsj qf ON qf.csid = sj.sjqf
		LEFT JOIN matridx_jcsj lxbh ON lxbh.csid = sj.kyxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		LEFT JOIN matridx_xtyh yh ON yh.yhid = sjhbxx.dqxx
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhbxx.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND hbfl.csmc = '第三方实验室'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sjhbxx.swmc,
		qf.csmc,
		sjhbxx.dqxx,
		sj.sjqf,
		lxbh.cskz1,
		yh.gwmc,
		yh.zsxm,
		sjhbxx.hbmc,
		sjhbxx.scbj
		) tmp
		GROUP BY
		tmp.swmc,
		tmp.dqxx,
		tmp.zt
		ORDER BY
		SUM ( tmp.zj ) DESC
	</select>
	<!--直销核心医院送检排行-->
	<select id="getCentralHospitalSaleData" parameterType="Map" resultType="Map">
		SELECT
		tmp.yyzddj,tmp.rq,
		sum(tmp.cnum) AS cnum
		FROM
		( SELECT
		sj.sjid,to_char(sj.jsrq, 'yyyy-MM') rq,
		yyxx.dwmc sjdwmc,case when yyxx.cskz2 is not null and yyxx.cskz2 != '' then yyxx.cskz2 ELSE 'others' end yyzddj,
		COALESCE (sj.fkje,0) cnum
		FROM
		igams_sjxx sj
		LEFT JOIN
		igams_yyxx yyxx
		ON yyxx.dwid = sj.sjdw
		LEFT JOIN
		igams_sjjcxm jcxm
		ON sj.sjid = jcxm.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN
		matridx_jcsj jc_jcxm
		ON jc_jcxm.csid = jcxm.jcxmid
		LEFT JOIN
		igams_sjhbxx sjhbxx
		ON sjhbxx.hbmc = sj.db and sjhbxx.scbj != '1'
		WHERE
		sj.sfsf !='0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null))
		and jcxm.jcxmid is not null
		AND sj.scbj = '0'
		and sjhbxx.fl in (
		'0954A23558524DA0BD22321EB35D3D57'
		)
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		sj.jsrq,
		sj.sjid,
		yyxx.dwmc,yyxx.cskz2,
		sj.sfsf,
		sj.fkje
		UNION ALL
		SELECT
		fjsq.fjid sjid,
		to_char( fjsq.lrsj, 'yyyy-MM' ) rq,
		yyxx.dwmc sjdwmc,
		CASE
		WHEN yyxx.cskz2 IS NOT NULL
		AND yyxx.cskz2 != '' THEN
		yyxx.cskz2 ELSE'others'
		END yyzddj,
		COALESCE (fjsq.yfje,0)  cnum
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sj.db
		AND sjhbxx.scbj != '1'
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND sjhbxx.fl IN ( '0954A23558524DA0BD22321EB35D3D57' )
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		to_char( fjsq.lrsj, 'yyyy-MM' ),
		fjsq.fjid,
		yyxx.dwmc,
		yyxx.cskz2,
		fjsq.yfje
		) tmp
		GROUP BY
		tmp.yyzddj,tmp.rq
		ORDER BY rq,yyzddj,
		sum(tmp.cnum) DESC
	</select>
	<!--医院送检排行-->
	<select id="getHospitalSalesNum" parameterType="Map" resultType="Map">
		SELECT
		tmp.dwmc,
		SUM ( tmp.dlssfnum ) dlssfnum,
		SUM ( tmp.zxsfnum ) zxsfnum,
		SUM ( tmp.dlssfnum )+SUM ( tmp.zxsfnum ) zh,
		tmp.yyzddj,
		tmp.dqxx
		FROM
		(
		SELECT
		CASE
		WHEN
		yyxx.tjmc IS NOT NULL THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN hbfl.cskz4 = '直销' THEN
		COALESCE( sj.fkje,0) else 0
		END AS zxsfnum,
		CASE
		WHEN  hbfl.cskz4 = '代理商' THEN
		COALESCE( sj.fkje,0) else 0
		END AS dlssfnum,
		yyxx.cskz2 yyzddj,
		sf.csmc dqxx
		FROM
		igams_sjxx sj
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc = sj.db and sjhb.scbj != '1'
		LEFT JOIN igams_sjjcxm jcxm ON jcxm.sjid = sj.sjid and jcxm.scbj='0'
		AND jcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
		left join matridx_jcsj hbfl on hbfl.csid=sjhb.fl
		left join matridx_jcsj sf on sf.csid=yyxx.sf
		<if test="qys != null and qys.size() >0">
			LEFT JOIN igams_hbqx hbqx ON sjhb.hbid = hbqx.hbid
			AND hbqx.yhid in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		sj.jsrq IS NOT NULL
		AND sj.scbj = '0'
		AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sj.sfsf!='0'
		and jcxm.jcxmid is not null
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhb.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="yyzddjs!=null and yyzddjs.length>0">
			and yyxx.cskz2 IN
			<foreach collection="yyzddjs" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(sj.jsrq,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(sj.jsrq,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.tjmc,
		yyxx.dwmc,
		sj.sfsf,
		yyxx.cskz2,
		hbfl.cskz4,
		sf.csmc,
		sj.fkje
		UNION ALL
		SELECT
		CASE
		WHEN
		yyxx.tjmc IS NOT NULL THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN hbfl.cskz4 = '直销' THEN
		COALESCE(	fjsq.yfje,0 ) else 0 END AS zxsfnum,
		CASE
		WHEN hbfl.cskz4 = '代理商' THEN
		COALESCE(	fjsq.yfje,0 ) else 0 END AS dlssfnum,
		yyxx.cskz2 yyzddj,
		sf.csmc dqxx
		FROM
		igams_fjsq fjsq
		LEFT JOIN igams_sjxx sj ON sj.sjid = fjsq.sjid
		LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
		LEFT JOIN igams_yyxx yyxx ON yyxx.dwid = sj.sjdw
		LEFT JOIN igams_sjhbxx sjhb ON sjhb.hbmc = sj.db
		AND sjhb.scbj != '1'
		LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = fjsq.jcxm
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhb.fl
		LEFT JOIN matridx_jcsj sf ON sf.csid = yyxx.sf
		WHERE
		fjsq.zt = '80'
		AND jc_fjlx.cskz1 = '1'
		AND sj.scbj = '0'
		AND fjsq.scbj = '0'
		AND fjsq.lrsj IS NOT NULL
		AND fjsq.sfff = '1'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhb.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhb.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.tjmc,
		yyxx.dwmc,
		yyxx.cskz2,
		hbfl.cskz4,
		sf.csmc,
		fjsq.yfje
		) tmp
		group by
		tmp.dwmc,
		tmp.yyzddj,
		tmp.dqxx
		order by
		SUM ( tmp.dlssfnum )+SUM ( tmp.zxsfnum ) desc
	</select>
	<!--入院医院送检销售额排行-->
	<select id="getRyyySfcssSaleTopList" parameterType="Map" resultType="Map">
		select dwmc, yyzddj, sum(dlssfnum+zxsfnum) cnum,SUM ( tmp.dlssfnum ) dlssfnum,
		SUM ( tmp.zxsfnum ) zxsfnum,tmp.dqxx
		from(
		select
		yyxx.cskz2 yyzddj,
		case when (yyxx.tjmc is not null and yyxx.tjmc != '') then yyxx.tjmc
		else yyxx.dwmc end dwmc,
		CASE
		WHEN  hbfl.cskz4 = '直销' THEN
		COALESCE(sjxx.fkje,0) else 0 end zxsfnum,
		CASE
		WHEN  hbfl.cskz4 = '代理商' THEN
		COALESCE(sjxx.fkje,0) else 0 end dlssfnum,
		sf.csmc dqxx
		FROM igams_yyxx yyxx
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjdw = yyxx.dwid AND sjxx.scbj ='0' AND (sfjs='1' or (sfjs in ('0','2') and bgrq is not null)) and sjxx.sfsf !='0'
		LEFT JOIN igams_sjjcxm sjjcxm on sjjcxm.sjid = sjxx.sjid and sjjcxm.scbj='0'
		AND sjjcxm.jcxmid in
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		LEFT JOIN matridx_jcsj jc_xm on sjjcxm.jcxmid = jc_xm.csid
		left join matridx_jcsj sjqf on sjxx.sjqf = sjqf.csid
		left join matridx_jcsj sf on sf.csid=yyxx.sf
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		left join matridx_jcsj hbfl on hbfl.csid=sjhbxx.fl
		<where>
			sjqf.csmc='入院' and sjxx.sfsf !='0'
			and sjjcxm.jcxmid is not null
			<if test="hbfls!=null and hbfls.size()>0">
				and sjhbxx.fl IN
				<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="qys != null and qys.size() >0">
				and sjhbxx.dqxx in
				<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="sf !=null and sf.size()>0">
				AND sjhbxx.sf IN
				<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
					#{item}
				</foreach>
			</if>
			<if test="nf !=null and nf.size() >0">
				AND to_char(sjxx.jsrq,'yyyy') in
				<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
			<if test="yf !=null and yf.size() >0">
				AND to_char(sjxx.jsrq,'MM') in
				<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
					#{item}
				</foreach>
			</if>
		</where>
		group by
		yyxx.dwmc, sjxx.sfsf, yyxx.cskz2, yyxx.tjmc,hbfl.cskz4,sjxx.sfsf,sf.csmc,sjxx.fkje
		UNION ALL
		SELECT
		yyxx.cskz2 yyzddj,
		CASE
		WHEN ( yyxx.tjmc IS NOT NULL AND yyxx.tjmc != '' ) THEN
		yyxx.tjmc ELSE yyxx.dwmc
		END dwmc,
		CASE
		WHEN hbfl.cskz4 = '直销' THEN
		COALESCE(fjsq.yfje,0) else 0 end zxsfnum,
		CASE
		WHEN hbfl.cskz4 = '代理商' THEN
		COALESCE(fjsq.yfje,0) else 0 end dlssfnum,
		sf.csmc dqxx
		FROM
		igams_yyxx yyxx
		LEFT JOIN igams_sjxx sjxx ON sjxx.sjdw = yyxx.dwid
		AND sjxx.scbj = '0'
		AND ( sfjs = '1' OR ( sfjs IN ( '0', '2' ) AND bgrq IS NOT NULL ) )
		LEFT JOIN igams_fjsq fjsq ON fjsq.sjid = sjxx.sjid
		AND fjsq.scbj = '0'
		AND fjsq.zt = '80'
		LEFT JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
		LEFT JOIN matridx_jcsj sjqf ON sjxx.sjqf = sjqf.csid
		LEFT JOIN matridx_jcsj sf ON sf.csid = yyxx.sf
		LEFT JOIN igams_sjhbxx sjhbxx ON sjhbxx.hbmc = sjxx.db
		LEFT JOIN matridx_jcsj hbfl ON hbfl.csid = sjhbxx.fl
		left join matridx_jcsj jc_fjlx on jc_fjlx.csid = fjsq.lx
		WHERE
		sjqf.csmc = '入院'
		and jc_fjlx.cskz1 = '1'
		AND fjsq.sfff = '1'
		AND fjsq.jcxm IN
		<foreach collection="jcxm" open="(" close=")" item="item" separator="," index="index">
			#{item}
		</foreach>
		<if test="hbfls!=null and hbfls.size()>0">
			and sjhbxx.fl IN
			<foreach collection="hbfls" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="qys != null and qys.size() >0">
			and sjhbxx.dqxx in
			<foreach collection="qys" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="sf !=null and sf.size()>0">
			AND sjhbxx.sf IN
			<foreach collection="sf" open="(" close=")" index="index" item="item" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="nf !=null and nf.size() >0">
			AND to_char(fjsq.lrsj,'yyyy') in
			<foreach collection="nf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		<if test="yf !=null and yf.size() >0">
			AND to_char(fjsq.lrsj,'MM') in
			<foreach collection="yf" open="(" close=")" item="item" separator="," index="index">
				#{item}
			</foreach>
		</if>
		GROUP BY
		yyxx.dwmc,
		yyxx.cskz2,
		yyxx.tjmc,
		hbfl.cskz4,
		sf.csmc,
		fjsq.yfje)tmp
		group by tmp.dwmc, tmp.yyzddj,tmp.dqxx
		order by cnum desc
	</select>

	<select id="getPtzbdcl" parameterType="XszbDto" resultType="Map">
		select ptmc, cspx,
		       cast(sz as numeric) sz,
		       sum(sumnum) sumnum,
		       round( sum(rsumnum)::numeric/3,0) rnum,
				CASE WHEN cast(sz as numeric) != '0' THEN round( sum(sumnum) * 100 / cast(sz as numeric) , 0 ) || '%' ELSE'0%' END dcl,
				CASE WHEN cast(sz as numeric) != '0' THEN ( sum(sumnum) - cast(sz as numeric) ) ELSE'0'  END gap
		from
		(
			(
				SELECT
					xxx.ptmc,
					xxx.sz,
					xxx.cspx,
					case when yyy.yxx!='Resfirst' then COUNT ( yyy.dyid ) else 0 end sumnum,
					case when yyy.yxx='Resfirst' then COUNT ( yyy.dyid ) else 0 end rsumnum
				FROM
				 (
					SELECT
						sjxx.sjid,
						sjxx.jsrq,
						hbxx.ptgs,
						xxdy_xm.yxx,
						xxdy_xm.dyid
					FROM igams_sjxx sjxx
					LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db AND hbxx.scbj != '1'
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
					LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid AND jcxm.scbj = '0'
					LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
					left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = jcxm.jcxmid
							AND xxdy_xm.scbj = '0'
							AND xxdy_xm.dylx = #{ywlx}
							<if test = "xms != null and xms.size() > 0"  >
								AND xxdy_xm.yxx in
								<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
					LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( ( jc_jcxm.cskz1 = 'C' AND jc_jcxm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE' ) OR xmjclx = jc_jcxm.cskz1 )
					WHERE
						sjxx.scbj = '0'
						AND sjxx.sfjs = '1'
						AND (
							sjxx.sfsf = '1'
							OR ( sjxx.sfsf = '2' AND (tt.xmjclx != 'D' or tt.xmjclx is null) )
							OR ( sjxx.sfsf = '3' AND (tt.xmjclx != 'R' or tt.xmjclx is null) )
						)
						AND to_char( sjxx.jsrq, 'YYYY-MM' ) &gt;= #{kszq}
						AND to_char( sjxx.jsrq, 'YYYY-MM' ) &lt;= #{jszq}
						<if test = "ptgss != null and ptgss.length > 0"  >
							AND hbxx.hbid IS NOT NULL
						</if>

					UNION ALL

					SELECT
						fjsq.fjid sjid,
						sjxx.jsrq jsrq,
						hbxx.ptgs,
						xxdy_xm.yxx ,
						xxdy_xm.dyid
					FROM igams_fjsq fjsq
					LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
					LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db AND hbxx.scbj != '1'
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
					LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
					LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
					left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
							AND xxdy_xm.scbj = '0'
							AND xxdy_xm.dylx = #{ywlx}
							<if test = "xms != null and xms.size() > 0"  >
								AND xxdy_xm.yxx in
								<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
					LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( (jc_xm.cskz1 = 'C' AND jc_xm.cskz3 ='IMP_REPORT_ONCO_QINDEX_TEMEPLATE') OR xmjclx = jc_xm.cskz1 )
					WHERE
						fjsq.zt = '80'
						AND jc_fjlx.cskz1 = '1'
						AND fjsq.scbj = '0'
						AND fjsq.lrsj IS NOT NULL
						AND fjsq.sfff = '1' AND fjsq.bgbj = '1'
						AND to_char( sjxx.jsrq, 'YYYY-MM' ) &gt;= #{kszq}
						AND to_char( sjxx.jsrq, 'YYYY-MM' ) &lt;= #{jszq}
						<if test = "ptgss != null and ptgss.length > 0"  >
							AND hbxx.hbid IS NOT NULL
						</if>
				) yyy
				LEFT JOIN (
					SELECT
						jc_pt.csid ptgs,
						jc_pt.csmc ptmc,
						xszb.kszq AS kszq,
						xszb.jszq AS jszq,
						jc_zblx.csmc,
						jc_zblx.csdm,
						jc_zbfl.csmc,
						jc_zbfl.csdm,
						xszb.sz,
						jc_pt.cspx
				from igams_xszb xszb
					LEFT JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx
					LEFT JOIN matridx_jcsj jc_zbfl ON jc_zbfl.csid = xszb.zbfl
					left join matridx_jcsj jc_pt on jc_pt.csid = xszb.yhid and jc_zbfl.csdm ='PT'
					WHERE
						jc_pt.jclb = 'PLATFORM_OWNERSHIP'
						AND jc_zblx.csdm = #{zblxcsmc}
						AND jc_zbfl.csdm = 'PT'
						AND xszb.kszq = #{kszq}
						AND xszb.jszq = #{jszq}
						<if test = "ptgss != null and ptgss.length > 0"  >
							AND jc_pt.csid in
							<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
								#{item}
							</foreach>
						</if>
				) xxx
				ON (xxx.ptgs = yyy.ptgs or xxx.ptgs='52E5192AB70E477DADBB6696297A4B53')
					AND to_char( yyy.jsrq, 'YYYY-MM' ) &gt;= xxx.kszq
					AND to_char( yyy.jsrq, 'YYYY-MM' ) &lt;= xxx.jszq
				GROUP BY
					xxx.cspx,
					xxx.ptmc,
					xxx.kszq,
					xxx.jszq,
					xxx.sz,
					yyy.yxx
			)
			union all
			(
				SELECT
				xxx.ptmc,
				xxx.sz,
				xxx.cspx,
				sum(ppp.sumnum) sumnum,
				sum(ppp.rsumnum) rsumnum
				from
				(select
					pt.csid ptgs,
					wbtj.jsrq,
					pt.csmc ptmc,
					'0' sz,
					case when xxdy_xm.yxx!='Resfirst' then CAST ( wbtj.css AS NUMERIC ) else 0 end sumnum,
					case when xxdy_xm.yxx='Resfirst' then CAST ( wbtj.css AS NUMERIC ) else 0 end rsumnum,
					pt.cspx,
					xxdy_xm.yxx,
					xxdy_xm.dyid
				from igams_wbtjgl wbtj
				left join igams_sjhbxx hbxx on hbxx.hbid = wbtj.hbid AND hbxx.scbj != '1'
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
				left join matridx_jcsj pt on hbxx.ptgs = pt.csid
				left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = wbtj.jcxm
							AND xxdy_xm.scbj = '0'
							AND xxdy_xm.dylx = #{ywlx}
							<if test="xms != null and xms.size() > 0">
								AND xxdy_xm.yxx in
								<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
							<if test="yhid != null and yhid != ''">
								LEFT JOIN igams_hbqx hbqx ON wbtj.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
							</if>
				where
					wbtj.scbj='0' and wbtj.sfsf = '1' and xxdy_xm.dyid is not null
					AND to_char( wbtj.jsrq, 'YYYY-MM' ) &gt;= #{kszq}
					AND to_char( wbtj.jsrq, 'YYYY-MM' ) &lt;= #{jszq}
					<if test="yhid != null and yhid != ''">
						and hbqx.hbid is not null
					</if>
					<if test = "ptgss != null and ptgss.length > 0"  >
						AND hbxx.hbid IS NOT NULL
					</if>
				)ppp
				left join (
					SELECT
					jc_pt.csid ptgs,
					jc_pt.csmc ptmc,
					xszb.kszq AS kszq,
					xszb.jszq AS jszq,
					jc_zblx.csmc,
					jc_zblx.csdm,
					jc_zbfl.csmc,
					jc_zbfl.csdm,
					xszb.sz,
					jc_pt.cspx
					from igams_xszb xszb
					LEFT JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx
					LEFT JOIN matridx_jcsj jc_zbfl ON jc_zbfl.csid = xszb.zbfl
					left join matridx_jcsj jc_pt on jc_pt.csid = xszb.yhid and jc_zbfl.csdm ='PT'
					WHERE
					jc_pt.jclb = 'PLATFORM_OWNERSHIP'
					AND jc_zblx.csdm = #{zblxcsmc}
					AND jc_zbfl.csdm = 'PT'
					AND xszb.kszq = #{kszq}
					AND xszb.jszq = #{jszq}
					<if test = "ptgss != null and ptgss.length > 0"  >
						AND jc_pt.csid in
						<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
							#{item}
						</foreach>
					</if>
				)xxx ON ( xxx.ptgs = ppp.ptgs OR xxx.ptgs = '52E5192AB70E477DADBB6696297A4B53' )
				AND to_char( ppp.jsrq, 'YYYY-MM' ) &gt;= xxx.kszq
				AND to_char( ppp.jsrq, 'YYYY-MM' ) &lt;= xxx.jszq
				group by xxx.ptmc,xxx.sz,xxx.cspx
			)
        ) ttt
        group by ptmc, cspx,sz
        order by cspx
	</select>
	<select id="getYwfzbZbdcl" parameterType="XszbDto" resultType="Map">
		select
			zsxm,
			sz,
			zbflcsdm,
			sum(sumnum) sumnum,
			round(sum(rsumnum)::numeric/3,0) rsumnum,
			CASE WHEN sz != '0' THEN round( sum(sumnum):: NUMERIC * 100 / sz :: NUMERIC, 0 ) || '%' ELSE'0%'  END dcl,
			CASE WHEN sz != '0' THEN ( sum(sumnum) :: NUMERIC - sz :: NUMERIC ) ELSE'0'  END gap
		from
		(
				SELECT
				xxx.zsxm,
				xxx.kszq,
				xxx.jszq,
				xxx.sz,
				xxx.zbflcsdm,
				case when yyy.yxx!='Resfirst' then COUNT ( yyy.dyid ) else 0 end sumnum,
				case when yyy.yxx='Resfirst' then COUNT ( yyy.dyid ) else 0 end rsumnum
				FROM
				(
				select
				xtyh.yhid, xtyh.zsxm, hbqx.hbid,
				xszb.kszq AS kszq,
				xszb.jszq AS jszq,
				jc_zblx.csmc,
				jc_zblx.csdm,
				jc_zbfl.csmc,
				jc_zbfl.csdm zbflcsdm,
				xszb.sz
				FROM
				matridx_xtyh xtyh
				LEFT JOIN igams_xszb xszb ON xszb.yhid = xtyh.yhid
				LEFT JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx
				LEFT JOIN matridx_jcsj jc_zbfl ON jc_zbfl.csid = xszb.zbfl
				left join igams_hbqx hbqx on hbqx.yhid = xtyh.yhid
				WHERE
				xtyh.scbj ='0' and xtyh.sfsd ='0'
				and jc_zblx.csdm = #{zblxcsmc}
				AND jc_zbfl.csdm IN ( 'YWZRTJ' ,'YWZRTJ2' )
				AND xszb.kszq = #{kszq}
				AND xszb.jszq = #{jszq}
				) xxx
				LEFT JOIN (
				SELECT
				hbxx.hbid,
				sjxx.sjid,
				sjxx.jsrq,
				hbxx.ptgs,
				hbxx.hbmc,
				jcxm.jcxmid,
				jc_jcxm.csmc,
				xxdy_xm.yxx,
				xxdy_xm.dyid
				FROM
				igams_sjxx sjxx
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db
				AND hbxx.scbj != '1'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hbxx.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>
				LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid AND jcxm.scbj = '0'
				LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
				left join matridx_jcsj sspt on sspt.csid=hbxx.ptgs and sspt.scbj='0'
				left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = jcxm.jcxmid
				AND xxdy_xm.scbj = '0'
				AND xxdy_xm.dylx = #{ywlx}
				<if test = "xms != null and xms.size() > 0"  >
					AND xxdy_xm.yxx in
					<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>
				LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( ( jc_jcxm.cskz1 = 'C' AND jc_jcxm.cskz3 = 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' ) OR xmjclx = jc_jcxm.cskz1 )
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_hbqx hbqx ON hbxx.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
				</if>
				WHERE
				sjxx.scbj = '0'
				AND sjxx.sfjs = '1'
				and sspt.csid IN ( '86AE08649C124DCBBE6C482E9FE17391' )
				AND (
				sjxx.sfsf = '1'
				OR ( sjxx.sfsf = '2' AND (tt.xmjclx != 'D' or tt.xmjclx is null) )
				OR ( sjxx.sfsf = '3' AND (tt.xmjclx != 'R' or tt.xmjclx is null) )
				)
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hbxx.hbid IS NOT NULL
				</if>
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				UNION ALL
				SELECT
				hbxx.hbid,
				fjsq.fjid sjid,
				sjxx.jsrq jsrq,
				hbxx.ptgs,
				hbxx.hbmc,
				fjsq.jcxm,
				jc_xm.csmc,
				xxdy_xm.yxx,
				xxdy_xm.dyid
				FROM
				igams_fjsq fjsq
				LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
				LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db
				AND hbxx.scbj != '1'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hbxx.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>
				left join matridx_jcsj sspt on sspt.csid=hbxx.ptgs and sspt.scbj='0'
				LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
				LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
				left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
				AND xxdy_xm.scbj = '0'
				AND xxdy_xm.dylx = #{ywlx}
				<if test = "xms != null and xms.size() > 0"  >
					AND xxdy_xm.yxx in
					<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>
				LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( ( jc_xm.cskz1 = 'C' AND jc_xm.cskz3 = 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' ) OR xmjclx = jc_xm.cskz1 )
				<if test="yhid != null and yhid != ''">
					LEFT JOIN igams_hbqx hbqx ON hbxx.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
				</if>
				WHERE
				fjsq.zt = '80'
				AND jc_fjlx.cskz1 = '1'
				AND fjsq.scbj = '0'
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND hbxx.hbid IS NOT NULL
				</if>
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				AND fjsq.lrsj IS NOT NULL
				AND fjsq.sfff = '1'
				and sspt.csid IN ( '86AE08649C124DCBBE6C482E9FE17391' )
				) yyy ON xxx.hbid = yyy.hbid
				AND to_char( yyy.jsrq, 'YYYY-MM' ) &gt;= xxx.kszq
				AND to_char( yyy.jsrq, 'YYYY-MM' ) &lt;= xxx.jszq
				where
				yyy.hbid is not null
				<if test = "ptgss != null and ptgss.length > 0"  >
					AND yyy.ptgs in
					<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
						#{item}
					</foreach>
				</if>
				GROUP BY
				xxx.zsxm,
				xxx.kszq,
				xxx.jszq,
				xxx.sz,
				xxx.zbflcsdm,
				yyy.yxx
		)tt
		group by zsxm, sz, zbflcsdm
		order by zbflcsdm ASC, sz::NUMERIC  ASC
	</select>

	<select id="getTjsxdcl" parameterType="XszbDto" resultType="Map">
		select
			case when tp.ind ='0' then tmp.swmc else tmp.cskz1 end mc,
			SUM ( sumnum :: NUMERIC ) sumnum,
			round(  SUM(rsumnum :: NUMERIC)/3,0) rsumnum,
			sum(tmp.sz :: NUMERIC) zb,
			CASE WHEN sum(tmp.sz :: NUMERIC) != 0 THEN round( sum(sumnum) * 100 / sum(tmp.sz :: NUMERIC), 0 ) || '%' ELSE '0%' END dcl,
			CASE WHEN sum(tmp.sz :: NUMERIC) != 0 THEN (sum(sumnum :: NUMERIC ) - sum(tmp.sz :: NUMERIC) ) ELSE'0' END gap
		from (
				select SWMC,
					SZ,
					CSKZ1,
					SUM(SUMNUM) SUMNUM,
					sum(rsumnum) rsumnum from (
                (
					SELECT
					xxx.swmc,
					xxx.sz,
					xxx.cskz1,
					case when yyy.yxx!='Resfirst' then COUNT ( yyy.dyid ) else 0 end sumnum,
					case when yyy.yxx='Resfirst' then COUNT ( yyy.dyid ) else 0 end rsumnum
					FROM
					(
						select
							sjhb.hbid,swmc,
							xszb.kszq AS kszq,
							xszb.jszq AS jszq,
							jc_zblx.csmc,
							jc_zblx.csdm,
							jc_zbfl.csmc,
							jc_zbfl.csdm,
							jc_zbzfl.cskz1,
							xszb.sz
						FROM igams_xszb xszb
						LEFT JOIN igams_sjhbxx sjhb ON xszb.yhid = sjhb.hbid
						LEFT JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx
						LEFT JOIN matridx_jcsj jc_zbfl ON jc_zbfl.csid = xszb.zbfl
						LEFT JOIN matridx_jcsj jc_zbzfl ON jc_zbzfl.csid = xszb.zbzfl
						WHERE
							sjhb.scbj ='0'
							and jc_zblx.csdm = #{zblxcsmc}
							AND jc_zbfl.csdm = 'TJXSTJ'
							and jc_zbzfl.csid = #{qyid}
							AND xszb.kszq = #{kszq}
							AND xszb.jszq = #{jszq}
					) xxx LEFT JOIN
					 (
						SELECT
							hbxx.hbid,
							hbxx.swmc,
							sjxx.sjid,
							sjxx.jsrq,
							hbxx.ptgs,
							xxdy_xm.yxx,
							xxdy_xm.dyid
						FROM igams_sjxx sjxx
						LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db AND hbxx.scbj != '1'
								<if test = "ptgss != null and ptgss.length > 0"  >
									AND hbxx.ptgs in
									<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
										#{item}
									</foreach>
								</if>
						LEFT JOIN igams_sjjcxm jcxm ON sjxx.sjid = jcxm.sjid AND jcxm.scbj = '0'
						LEFT JOIN matridx_jcsj jc_jcxm ON jc_jcxm.csid = jcxm.jcxmid
						left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = jcxm.jcxmid
								AND xxdy_xm.scbj = '0'
								AND xxdy_xm.dylx = #{ywlx}
								<if test = "xms != null and xms.size() > 0"  >
									AND xxdy_xm.yxx in
									<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
										#{item}
									</foreach>
								</if>
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON  jc_jcxm.cskz1 = 'C' AND jc_jcxm.cskz3 = 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE'
						<if test="yhid != null and yhid != ''">
							LEFT JOIN igams_hbqx hbqx ON hbxx.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
						</if>
						WHERE
							sjxx.scbj = '0'
							AND sjxx.sfjs = '1'
							AND (
								sjxx.sfsf = '1'
								OR ( sjxx.sfsf = '2' AND (tt.xmjclx != 'D' or tt.xmjclx is null) )
								OR ( sjxx.sfsf = '3' AND (tt.xmjclx != 'R' or tt.xmjclx is null) )
							)
							and to_char(sjxx.jsrq,'YYYY-MM') &gt;= #{kszq}
							and to_char(sjxx.jsrq,'YYYY-MM') &lt;= #{jszq}
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
							<if test="yhid != null and yhid != ''">
								AND hbqx.hbid IS NOT NULL
							</if>
							and hbxx.hbid is not null
							and hbxx.ptgs=#{cskz2}

						UNION ALL

						SELECT
							hbxx.hbid,
							hbxx.swmc,
							fjsq.fjid sjid,
							sjxx.jsrq jsrq,
							hbxx.ptgs,
							xxdy_xm.yxx,
							xxdy_xm.dyid
						FROM igams_fjsq fjsq
						LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid
						LEFT JOIN igams_sjhbxx hbxx ON hbxx.hbmc = sjxx.db AND hbxx.scbj != '1'
								<if test = "ptgss != null and ptgss.length > 0"  >
									AND hbxx.ptgs in
									<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
										#{item}
									</foreach>
								</if>
						LEFT JOIN matridx_jcsj jc_fjlx ON jc_fjlx.csid = fjsq.lx
						LEFT OUTER JOIN matridx_jcsj jc_xm ON fjsq.jcxm = jc_xm.csid
						left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
								AND xxdy_xm.scbj = '0'
								AND xxdy_xm.dylx = #{ywlx}
								<if test = "xms != null and xms.size() > 0"  >
									AND xxdy_xm.yxx in
									<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
										#{item}
									</foreach>
								</if>
						LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON jc_xm.cskz1 = 'C' AND jc_xm.cskz3 = 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE'
						<if test="yhid != null and yhid != ''">
							LEFT JOIN igams_hbqx hbqx ON hbxx.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
						</if>
						WHERE
							fjsq.zt = '80'
							AND jc_fjlx.cskz1 = '1'
							AND fjsq.scbj = '0'
							AND fjsq.lrsj IS NOT NULL
							AND fjsq.sfff = '1'
							AND bgbj='1'
							and to_char(sjxx.jsrq,'YYYY-MM') &gt;= #{kszq}
							and to_char(sjxx.jsrq,'YYYY-MM') &lt;= #{jszq} and jc_fjlx.csdm='ADDDETECT'
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
							<if test="yhid != null and yhid != ''">
								AND hbqx.hbid IS NOT NULL
							</if>
							and hbxx.hbid is not null
							and hbxx.ptgs=#{cskz2}

					) yyy
					ON xxx.swmc = yyy.swmc
						AND to_char( yyy.jsrq, 'YYYY-MM' ) &gt;= xxx.kszq
						AND to_char( yyy.jsrq, 'YYYY-MM' ) &lt;= xxx.jszq
					GROUP BY
						xxx.swmc,
						xxx.kszq,
						xxx.jszq,
						xxx.sz,
						xxx.cskz1,
						yyy.yxx
		        )
		        union all
		        (
		            select xxx.swmc, xxx.sz, xxx.cskz1, SUM ( yyy.sumnum ) sumnum, SUM ( yyy.rsumnum ) rsumnum
		            from
					(
							select
							sjhb.hbid,swmc,
							xszb.kszq AS kszq,
							xszb.jszq AS jszq,
							jc_zblx.csmc,
							jc_zblx.csdm,
							jc_zbfl.csmc,
							jc_zbfl.csdm,
							jc_zbzfl.cskz1,
							xszb.sz
							FROM igams_xszb xszb
							LEFT JOIN igams_sjhbxx sjhb ON xszb.yhid = sjhb.hbid
							LEFT JOIN matridx_jcsj jc_zblx ON jc_zblx.csid = xszb.zblx
							LEFT JOIN matridx_jcsj jc_zbfl ON jc_zbfl.csid = xszb.zbfl
							LEFT JOIN matridx_jcsj jc_zbzfl ON jc_zbzfl.csid = xszb.zbzfl
							WHERE
							sjhb.scbj ='0'
							and jc_zblx.csdm = #{zblxcsmc}
							AND jc_zbfl.csdm = 'TJXSTJ'
							and jc_zbzfl.csid = #{qyid}
							AND xszb.kszq = #{kszq}
							AND xszb.jszq = #{jszq}
					)xxx left join(
							select
							hbxx.swmc,
							'0' sz,
							#{cskz3} cskz1,
							xxdy_xm.yxx,
							xxdy_xm.dyid,
							case when xxdy_xm.yxx!='Resfirst' then CAST ( wbtj.css AS NUMERIC ) else 0 end sumnum,
							case when xxdy_xm.yxx='Resfirst' then CAST ( wbtj.css AS NUMERIC ) else 0 end rsumnum
							from igams_wbtjgl wbtj
							left join igams_sjhbxx hbxx on hbxx.hbid = wbtj.hbid  AND hbxx.scbj != '1'
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.ptgs in
								<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
							left join matridx_jcsj pt_jc on hbxx.ptgs = pt_jc.csid
							left join igams_xxdy xxdy_xm ON xxdy_xm.dyxx = wbtj.jcxm
							AND xxdy_xm.scbj = '0'
							AND xxdy_xm.dylx = #{ywlx}
							<if test="xms != null and xms.size() > 0">
								AND xxdy_xm.yxx in
								<foreach collection="xms" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
							<if test="yhid != null and yhid != ''">
								LEFT JOIN igams_hbqx hbqx ON wbtj.hbid = hbqx.hbid AND hbqx.yhid= #{yhid}
							</if>
							where
							wbtj.scbj='0' and wbtj.sfsf = '1' and xxdy_xm.dyid is not null
							AND to_char( wbtj.jsrq, 'YYYY-MM' ) &gt;= #{kszq}
							AND to_char( wbtj.jsrq, 'YYYY-MM' ) &lt;= #{jszq}
							<if test="yhid != null and yhid != ''">
								and hbqx.hbid is not null
							</if>
							<if test = "ptgss != null and ptgss.length > 0"  >
								AND hbxx.hbid IS NOT NULL
							</if>
							<if test = "hbids != null and hbids.size() > 0"  >
								AND hbxx.hbid in
								<foreach collection="hbids" separator="," open="(" close=") " item="item" index="index">
									#{item}
								</foreach>
							</if>
					) yyy on yyy.swmc = xxx.swmc
					group by xxx.swmc, xxx.sz, xxx.cskz1, yyy.yxx

		        ) ) t_t group by SWMC,
					SZ,
					CSKZ1
		      ) tmp
		left join (select '1' ind union select '0' ind) tp on 1=1
		group by
		    case when tp.ind ='0' then tmp.swmc else tmp.cskz1 end ,tp.ind
		order by tp.ind,sum(tmp.sz :: NUMERIC) desc
	</select>

<!--	<select id="getHbflcsszb" parameterType="SjxxDto" resultType="Map">-->
<!--		SELECT ''||SUM ( CAST ( tmp.dyxx AS NUMERIC ) ) AS num, tmp.yxx-->
<!--		FROM(-->
<!--				(-->
<!--					SELECT xxdy.dyxx, xxdy_hb.yxx-->
<!--					FROM-->
<!--					igams_sjxx sjxx-->
<!--					LEFT OUTER JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid AND (xm.scbj = '0' or xm.scbj is null)-->
<!--					left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = xm.jcxmid-->
<!--								AND xxdy_xm.scbj = '0'-->
<!--								AND xxdy_xm.dylx = #{ywlx}-->
<!--								<if test = "yxxs != null and yxxs.length > 0"  >-->
<!--									AND xxdy_xm.yxx in-->
<!--									<foreach collection="yxxs" separator="," open="(" close=") "-->
<!--											 item="item" index="index">-->
<!--										#{item}-->
<!--									</foreach>-->
<!--								</if>-->
<!--					LEFT OUTER JOIN igams_xxdy xxdy ON xxdy.yxxid = xm.jcxmid AND xxdy.scbj = '0' AND ( xxdy.zid = xm.jczxmid OR xm.jczxmid IS NULL )-->
<!--					LEFT OUTER JOIN matridx_jcsj dylx ON dylx.csid = xxdy.dylx AND dylx.scbj = '0' AND dylx.cskz1 = 'XMCSS'-->
<!--					LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc AND hb.scbj != '1'-->
<!--								<if test = "ptgss != null and ptgss.length > 0"  >-->
<!--									AND hb.ptgs in-->
<!--									<foreach collection="ptgss" separator="," open="(" close=") "-->
<!--											 item="item" index="index">-->
<!--										#{item}-->
<!--									</foreach>-->
<!--								</if>-->
<!--								<if test="yhid != null and yhid != ''">-->
<!--									LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid-->
<!--									AND hbqx.yhid= #{yhid}-->
<!--								</if>-->
<!--					LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl AND xxdy_hb.scbj = '0'-->
<!--					LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx AND dylx_hb.scbj = '0' AND dylx_hb.cskz1 = 'JCSJ' AND dylx_hb.cskz2 = 'CLASSIFY'-->
<!--					WHERE-->
<!--						sjxx.scbj = '0'-->
<!--						AND sjxx.jsrq IS NOT NULL-->
<!--						AND xxdy_xm.dyid IS NOT NULL-->
<!--						AND dylx.csid IS NOT NULL-->
<!--						AND dylx_hb.csid IS NOT NULL-->
<!--						AND sjxx.sfjs = '1'-->
<!--						AND hb.hbid IS NOT NULL-->
<!--						<if test="yhid != null and yhid != ''">-->
<!--							AND hbqx.hbid IS NOT NULL-->
<!--						</if>-->
<!--						<if test="jsrqstart != null and jsrqstart != ''">-->
<!--							and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}-->
<!--						</if>-->
<!--						<if test="jsrqend !=null and jsrqend !=''">-->
<!--							and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}-->
<!--						</if>-->
<!--				)-->
<!--				union all-->
<!--				(-->
<!--					SELECT xxdy.dyxx, xxdy_hb.yxx-->
<!--					FROM igams_fjsq fjsq-->
<!--					LEFT OUTER JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid and sjxx.scbj='0'-->
<!--					LEFT JOIN matridx_jcsj fjlx ON fjlx.csid = fjsq.lx AND fjlx.csdm = 'ADDDETECT'-->
<!--					left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm-->
<!--							AND xxdy_xm.scbj = '0'-->
<!--							AND xxdy_xm.dylx = #{ywlx}-->
<!--							<if test="yxxs != null and yxxs.length > 0">-->
<!--								AND xxdy_xm.yxx in-->
<!--								<foreach collection="yxxs" separator="," open="(" close=") "-->
<!--										 item="item" index="index">-->
<!--									#{item}-->
<!--								</foreach>-->
<!--							</if>-->
<!--					LEFT OUTER JOIN igams_xxdy xxdy ON xxdy.yxxid = fjsq.jcxm AND xxdy.scbj = '0'-->
<!--					LEFT OUTER JOIN matridx_jcsj dylx ON dylx.csid = xxdy.dylx AND dylx.scbj = '0' AND dylx.cskz1 = 'XMCSS'-->
<!--					LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc-->
<!--							AND hb.scbj != '1'-->
<!--							<if test="ptgss != null and ptgss.length > 0">-->
<!--								AND hb.ptgs in-->
<!--								<foreach collection="ptgss" separator="," open="(" close=") "-->
<!--										 item="item" index="index">-->
<!--									#{item}-->
<!--								</foreach>-->
<!--							</if>-->
<!--							<if test="yhid != null and yhid != ''">-->
<!--								LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid-->
<!--								AND hbqx.yhid= #{yhid}-->
<!--							</if>-->
<!--					LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl AND xxdy_hb.scbj = '0'-->
<!--					LEFT OUTER JOIN matridx_jcsj dylx_hb ON dylx_hb.csid = xxdy_hb.dylx AND dylx_hb.scbj = '0' AND dylx_hb.cskz1 = 'JCSJ' AND dylx_hb.cskz2 = 'CLASSIFY'-->
<!--					WHERE-->
<!--						fjsq.scbj = '0'-->
<!--						AND fjsq.zt = '80'-->
<!--						and fjsq.sfff='1'-->
<!--						and fjsq.bgbj='1'-->
<!--						AND fjlx.csid IS NOT NULL-->
<!--						and sjxx.sjid is not null-->
<!--						AND sjxx.jsrq IS NOT NULL-->
<!--						AND xxdy_xm.dyid IS NOT NULL-->
<!--						AND fjlx.csid is not null-->
<!--						AND dylx.csid IS NOT NULL-->
<!--						AND dylx_hb.csid IS NOT NULL-->
<!--						AND sjxx.sfjs = '1'-->
<!--						AND hb.hbid IS NOT NULL-->
<!--						<if test="yhid != null and yhid != ''">-->
<!--							AND hbqx.hbid IS NOT NULL-->
<!--						</if>-->
<!--						<if test="jsrqstart != null and jsrqstart != ''">-->
<!--							and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}-->
<!--						</if>-->
<!--						<if test="jsrqend !=null and jsrqend !=''">-->
<!--							and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}-->
<!--						</if>-->
<!--					)-->
<!--		         ) tmp-->
<!--		GROUP BY tmp.yxx-->
<!--		ORDER BY tmp.yxx DESC-->
<!--	</select>-->

	<select id="getHbflcsszb" parameterType="SjxxDto" resultType="Map">
		SELECT ''||SUM ( tmp.cnt ) AS num, tmp.yxx
		FROM
		(
			(
				SELECT COUNT (xxdy_xm.dyid) cnt
				<if test = "xg_flg == '1'.toString()"  >
					,case WHEN ptgs.csdm !='LEAD' THEN
					'CSO' ELSE xxdy_hb.yxx end yxx
				</if>
				<if test = "xg_flg != '1'.toString()"  >
					,xxdy_hb.yxx
				</if>
				FROM
				igams_sjxx sjxx
				LEFT OUTER JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid AND (xm.scbj = '0' or xm.scbj is null)
				left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = xm.jcxmid
						AND xxdy_xm.scbj = '0'
						AND xxdy_xm.dylx = #{ywlx}
						<if test = "yxxs != null and yxxs.length > 0"  >
							AND xxdy_xm.yxx in
							<foreach collection="yxxs" separator="," open="(" close=") " item="item" index="index">
								#{item}
							</foreach>
						</if>
				LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid  AND jc_xm.scbj = '0'
				LEFT OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( jc_xm.cskz1 = 'C' OR xmjclx = jc_xm.cskz1 )  AND jc_xm.cskz3 IN ( 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' )
				LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc AND hb.scbj != '1'
						<if test = "ptgss != null and ptgss.length > 0"  >
							AND hb.ptgs in
							<foreach collection="ptgss" separator="," open="(" close=") " item="item" index="index">
								#{item}
							</foreach>
						</if>
						<if test="yhid != null and yhid != ''">
							LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
							AND hbqx.yhid= #{yhid}
						</if>
				LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs  AND ptgs.scbj = '0'
				LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl AND xxdy_hb.scbj = '0' AND xxdy_hb.dylx = #{ywlx_q}
				WHERE
				sjxx.scbj = '0'
				AND sjxx.sfjs = '1'
				AND (
				sjxx.sfsf = '1'
				OR ( sjxx.sfsf = '2' AND (tt.xmjclx != 'D' or tt.xmjclx is null) )
				OR ( sjxx.sfsf = '3' AND (tt.xmjclx != 'R' or tt.xmjclx is null) )
				)
				AND sjxx.jsrq IS NOT NULL
				AND xxdy_hb.dyid IS NOT NULL
				AND hb.hbid IS NOT NULL
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}
				</if>
				group by xxdy_hb.yxx
				<if test = "xg_flg == '1'.toString()"  >
					,hb.ptgs,ptgs.csdm
				</if>
			)
			union all
			(
				SELECT COUNT (xxdy_xm.dyid) cnt
				<if test = "xg_flg == '1'.toString()"  >
					,case WHEN ptgs.csdm !='LEAD' THEN
					'CSO' ELSE xxdy_hb.yxx end yxx
				</if>
				<if test = "xg_flg != '1'.toString()"  >
					,xxdy_hb.yxx
				</if>
				FROM igams_fjsq fjsq
				LEFT OUTER JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid and sjxx.scbj='0'
				LEFT JOIN matridx_jcsj fjlx ON fjlx.csid = fjsq.lx and fjlx.scbj='0'
				left OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = fjsq.jcxm  AND jc_xm.scbj = '0'
				left OUTER JOIN ( SELECT 'D' xmjclx UNION ALL SELECT 'R' xmjclx ) tt ON ( jc_xm.cskz1 = 'C' OR xmjclx = jc_xm.cskz1 )  AND jc_xm.cskz3 IN ( 'IMP_REPORT_ONCO_QINDEX_TEMEPLATE' )
				left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
						AND xxdy_xm.scbj = '0'
						AND xxdy_xm.dylx = #{ywlx}
						<if test="yxxs != null and yxxs.length > 0">
							AND xxdy_xm.yxx in
							<foreach collection="yxxs" separator="," open="(" close=") " item="item" index="index">
								#{item}
							</foreach>
						</if>
				LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc AND hb.scbj != '1'
						<if test="ptgss != null and ptgss.length > 0">
							AND hb.ptgs in
							<foreach collection="ptgss" separator="," open="(" close=") "
									 item="item" index="index">
								#{item}
							</foreach>
						</if>
						<if test="yhid != null and yhid != ''">
							LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
							AND hbqx.yhid= #{yhid}
						</if>
				LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs  AND ptgs.scbj = '0'
				LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl AND xxdy_hb.scbj = '0' AND xxdy_hb.dylx = #{ywlx_q}
				WHERE
				fjsq.scbj = '0'
				AND fjsq.zt = '80'
				and fjsq.sfff='1'
				and fjsq.bgbj='1'
				AND sjxx.sfjs = '1'
				AND fjlx.csdm = 'ADDDETECT'
				and fjsq.lrsj IS NOT NULL
				and xxdy_hb.dyid is not null
				AND hb.hbid IS NOT NULL
				<if test="yhid != null and yhid != ''">
					AND hbqx.hbid IS NOT NULL
				</if>
				<if test="jsrqstart != null and jsrqstart != ''">
					and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
				</if>
				<if test="jsrqend !=null and jsrqend !=''">
					and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}
				</if>
				group by xxdy_hb.yxx
				<if test = "xg_flg == '1'.toString()"  >
					,hb.ptgs,ptgs.csdm
				</if>
			)
		union all
		(select sum(cast(wbtj.css as numeric)) cnt
		<if test = "xg_flg == '1'.toString()"  >
			,case WHEN ptgs.csdm !='LEAD' THEN
			'CSO' ELSE xxdy_hb.yxx end yxx
		</if>
		<if test = "xg_flg != '1'.toString()"  >
			,xxdy_hb.yxx
		</if>
		from igams_wbtjgl wbtj
		LEFT OUTER JOIN igams_sjhbxx hb ON wbtj.hbid = hb.hbid AND hb.scbj != '1'
		<if test="ptgss != null and ptgss.length > 0">
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs  AND ptgs.scbj = '0'
		LEFT OUTER JOIN igams_xxdy xxdy_hb ON xxdy_hb.dyxx = hb.fl AND xxdy_hb.scbj = '0' AND xxdy_hb.dylx = #{ywlx_q}
		LEFT JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = wbtj.jcxm
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		WHERE
		wbtj.scbj = '0'
		and wbtj.sfsf='1'
		and xxdy_hb.dyid is not null
		and xxdy_xm.dyid is not null
		AND hb.hbid IS NOT NULL
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
		</if>
		<if test="jsrqend !=null and jsrqend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqend}
		</if>
		group by xxdy_hb.yxx
		<if test = "xg_flg == '1'.toString()"  >
			,hb.ptgs,ptgs.csdm
		</if>
		)
		) tmp
		GROUP BY tmp.yxx
		ORDER BY tmp.yxx DESC
	</select>

	<select id="getSjqfcsszb" parameterType="SjxxDto" resultType="Map">
		SELECT ''||SUM
		( CAST ( tmp.sfsf AS NUMERIC ) ) AS num,
		tmp.sjqf
		<if test="newflg=='qs'.toString">
			,tmp.rq
		</if>
		FROM(
		(
		SELECT
		CASE

		WHEN
		(
		sjxx.sfsf = '1'
		OR ( sjxx.sfsf = '2' AND ( tt.xmjclx != 'D' OR tt.xmjclx IS NULL ) )
		OR ( sjxx.sfsf = '3' AND ( tt.xmjclx != 'R' OR tt.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf,
		case when sjxx.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='271BA9692B744795A056816F7414FBF8' then '第三方实验室'
		WHEN sjxx.sjqf = '195770A431A3445C9055D396F29783BA'
		AND ( hb.fl IN ( '23AB3322BF8941458DE96397C10D53C5', '989C055F5ACB4142AD14F7DB046C2BF5' ) OR ptgs.csdm !='LEAD' ) THEN
		'CSO'
		when sjxx.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='0954A23558524DA0BD22321EB35D3D57' then '直销' else sjxx.sjqf end sjqf
		<if test="newflg=='qs'.toString">
			<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
				,to_char(sjxx.jsrq + '6 D'+  cast ('-'||case when to_char(sjxx.jsrq,'D') = '7' then '0' else to_char(sjxx.jsrq,'D') end ||' D' as interval),'yyyy-MM-dd') rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy-MM' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy' ) rq
			</if>
		</if>
		FROM
		igams_sjxx sjxx
		LEFT OUTER JOIN igams_sjjcxm xm ON sjxx.sjid = xm.sjid
		AND (xm.scbj = '0' or xm.scbj is null)
		left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = xm.jcxmid
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = xm.jcxmid
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs and ptgs.scbj ='0'
		WHERE
		sjxx.scbj = '0' and sjxx.sjqf is not null  and sjxx.sjqf !=''
		AND sjxx.jsrq IS NOT NULL
		AND xxdy_xm.dyid IS NOT NULL
		AND sjxx.sfjs = '1'
		AND hb.hbid IS NOT NULL
		AND hb.fl IS NOT NULL
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="newflg=='zb'.toString and jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='zb'.toString and jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqstart != null and jsrqstart != '' and (tj=='day' or tj=='week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqend !=null and jsrqend !='' and (tj=='day' or tj=='week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="newflg=='qs'.toString and jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		)union all(
		SELECT
		CASE

		WHEN
		(
		fjsq.sfff = '1'
		OR ( fjsq.sfff = '2' AND ( tt.xmjclx != 'D' OR tt.xmjclx IS NULL ) )
		OR ( fjsq.sfff = '3' AND ( tt.xmjclx != 'R' OR tt.xmjclx IS NULL ) )
		) THEN
		'1' ELSE'0'
		END sfsf,
		case when sjxx.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='271BA9692B744795A056816F7414FBF8' then '第三方实验室'
		WHEN sjxx.sjqf = '195770A431A3445C9055D396F29783BA'
		AND ( hb.fl IN ( '23AB3322BF8941458DE96397C10D53C5', '989C055F5ACB4142AD14F7DB046C2BF5' ) OR ptgs.csdm !='LEAD' ) THEN
		'CSO'
		when sjxx.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='0954A23558524DA0BD22321EB35D3D57' then '直销' else sjxx.sjqf end sjqf
		<if test="newflg=='qs'.toString">
			<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy-MM-dd' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
				,to_char(sjxx.jsrq + '6 D'+  cast ('-'||case when to_char(sjxx.jsrq,'D') = '7' then '0' else to_char(sjxx.jsrq,'D') end||' D' as interval),'yyyy-MM-dd') rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy-MM' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
				,to_char( sjxx.jsrq, 'yyyy' ) rq
			</if>
		</if>
		FROM
		igams_fjsq fjsq
		LEFT OUTER JOIN igams_sjxx sjxx ON sjxx.sjid = fjsq.sjid and sjxx.scbj = '0' and sjxx.sjqf is not null  and sjxx.sjqf !=''
		LEFT JOIN matridx_jcsj fjlx ON fjlx.csid = fjsq.lx
		AND fjlx.csdm = 'ADDDETECT'
		left JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = fjsq.jcxm
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT OUTER JOIN matridx_jcsj jc_xm ON jc_xm.csid = fjsq.jcxm
		left outer join (select 'D' xmjclx union all select 'R' xmjclx) tt on (jc_xm.cskz1 ='C' or xmjclx = jc_xm.cskz1) and jc_xm.cskz3 in ('IMP_REPORT_ONCO_QINDEX_TEMEPLATE')
		LEFT OUTER JOIN igams_sjhbxx hb ON sjxx.db = hb.hbmc
		AND hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs and ptgs.scbj ='0'
		WHERE
		fjsq.scbj = '0'
		AND fjsq.zt = '80'
		and fjsq.sfff='1'
		and fjsq.bgbj='1'
		AND fjlx.csid is not null
		and sjxx.sjid is not null
		AND sjxx.jsrq IS NOT NULL
		AND xxdy_xm.dyid IS NOT NULL
		AND sjxx.sfjs = '1'
		AND hb.hbid IS NOT NULL
		AND hb.fl IS NOT NULL
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="newflg=='zb'.toString and jsrqstart != null and jsrqstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='zb'.toString and jsrqend !=null and jsrqend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqstart != null and jsrqstart != '' and (tj=='day' or tj=='week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqend !=null and jsrqend !='' and (tj=='day' or tj=='week')">
			and to_char(sjxx.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqMstart != null and jsrqMstart != ''">
			and to_char(sjxx.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqMend !=null and jsrqMend !=''">
			and to_char(sjxx.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="newflg=='qs'.toString and jsrqYstart != null and jsrqYstart != ''">
			and to_char(sjxx.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqYend !=null and jsrqYend !=''">
			and to_char(sjxx.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		)union all(
		SELECT
		wbtj.css as sfsf,
		case when wbtj.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='271BA9692B744795A056816F7414FBF8' then '第三方实验室'
		WHEN wbtj.sjqf = '195770A431A3445C9055D396F29783BA' AND ( hb.fl IN ( '23AB3322BF8941458DE96397C10D53C5', '989C055F5ACB4142AD14F7DB046C2BF5' ) OR ptgs.csdm !='LEAD' ) THEN 'CSO'
		when wbtj.sjqf ='195770A431A3445C9055D396F29783BA' AND hb.fl ='0954A23558524DA0BD22321EB35D3D57' then '直销' else wbtj.sjqf end sjqf
		<if test="newflg=='qs'.toString">
			<if test = "tj != null and tj.length > 0 and tj=='day'.toString"  >
				,to_char( wbtj.jsrq, 'yyyy-MM-dd' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='week'.toString"  >
				,to_char(wbtj.jsrq + '6 D'+  cast ('-'||case when to_char(wbtj.jsrq,'D') = '7' then '0' else to_char(wbtj.jsrq,'D') end||' D' as interval),'yyyy-MM-dd') rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='mon'.toString"  >
				,to_char( wbtj.jsrq, 'yyyy-MM' ) rq
			</if>
			<if test = "tj != null and tj.length > 0 and tj=='year'.toString"  >
				,to_char( wbtj.jsrq, 'yyyy' ) rq
			</if>
		</if>
		FROM
		igams_wbtjgl wbtj
		LEFT JOIN igams_xxdy xxdy_xm ON xxdy_xm.dyxx = wbtj.jcxm
		AND xxdy_xm.scbj = '0'
		AND xxdy_xm.dylx = #{ywlx}
		<if test = "yxxs != null and yxxs.length > 0"  >
			AND xxdy_xm.yxx in
			<foreach collection="yxxs" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		LEFT JOIN igams_sjhbxx hb ON hb.hbid = wbtj.hbid
		AND hb.scbj != '1'
		<if test = "ptgss != null and ptgss.length > 0"  >
			AND hb.ptgs in
			<foreach collection="ptgss" separator="," open="(" close=") "
					 item="item" index="index">
				#{item}
			</foreach>
		</if>
		<if test="yhid != null and yhid != ''">
			LEFT JOIN igams_hbqx hbqx ON hb.hbid = hbqx.hbid
			AND hbqx.yhid= #{yhid}
		</if>
		LEFT OUTER JOIN matridx_jcsj ptgs ON ptgs.csid = hb.ptgs and ptgs.scbj ='0'
		WHERE
		xxdy_xm.dyid IS NOT NULL
		AND hb.hbid IS NOT NULL
		AND hb.fl IS NOT NULL
		AND wbtj.sfsf = '1'
		AND wbtj.scbj = '0'
		<if test="yhid != null and yhid != ''">
			AND hbqx.hbid IS NOT NULL
		</if>
		<if test="newflg=='zb'.toString and jsrqstart != null and jsrqstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='zb'.toString and jsrqend !=null and jsrqend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqstart != null and jsrqstart != '' and (tj=='day' or tj=='week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &gt;= #{jsrqstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqend !=null and jsrqend !='' and (tj=='day' or tj=='week')">
			and to_char(wbtj.jsrq,'yyyy-MM-dd') &lt;= #{jsrqend}
		</if>
		<if test="newflg=='qs'.toString and jsrqMstart != null and jsrqMstart != ''">
			and to_char(wbtj.jsrq,'yyyy-MM') &gt;= #{jsrqMstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqMend !=null and jsrqMend !=''">
			and to_char(wbtj.jsrq,'yyyy-MM') &lt;= #{jsrqMend}
		</if>
		<if test="newflg=='qs'.toString and jsrqYstart != null and jsrqYstart != ''">
			and to_char(wbtj.jsrq,'yyyy') &gt;= #{jsrqYstart}
		</if>
		<if test="newflg=='qs'.toString and jsrqYend !=null and jsrqYend !=''">
			and to_char(wbtj.jsrq,'yyyy') &lt;= #{jsrqYend}
		</if>
		)) tmp
		GROUP BY
		<if test="newflg=='qs'.toString">
		    tmp.rq,
		</if>
		tmp.sjqf
		ORDER BY
		tmp.sjqf DESC
	</select>
</mapper>