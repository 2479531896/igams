<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.wechat.dao.post.ICkwxglDao" >
	<!-- 根据标本类型和物种ID获取参考文献信息 -->
	<select id="getDtoByYblxAndWzid" parameterType="CkwxglDto" resultType="CkwxglDto">
		select wxid,wzid,yblx,wzbt,wzzz,qkxx,mrxz
		from igams_ckwxgl
		<where>
			scbj!='1' and yblx=#{yblx}
			and wzid=#{wzid}
		</where>
	</select>

	<select id="getDtoList" parameterType="CkwxglDto" resultType="CkwxglDto">
		select wxid,wzid,yblx,wzbt,wzzz,qkxx,mrxz
		from igams_ckwxgl
		<where>
			scbj!='1' and wzid=#{wzid}
		</where>
	</select>
	
	<select id="getDtoById" parameterType="String" resultType="CkwxglDto">
		select wxid,wzid,yblx,wzbt,wzzz,qkxx,mrxz
		from igams_ckwxgl
		<where>
			scbj!='1' and wxid=#{wxid}
		</where>
	</select>
	
	<insert id="insert" parameterType="CkwxglDto">
		insert into igams_ckwxgl(wxid,wzid,
		<if test="yblx !=null and yblx != ''">
			,yblx
		</if>
		<if test="wzbt !=null and wzbt != ''">
			,wzbt
		</if>
		<if test="wzzz !=null and wzzz != ''">
			,wzzz
		</if>
		<if test="qkxx !=null and qkxx != ''">
			,qkxx
		</if>
		<if test="mrxz !=null and mrxz != ''">
			,mrxz
		</if>
		lrry,lrsj,scbj)
		values(#{wxid},#{wzid}
		<if test="yblx !=null and yblx != ''">
			,#{yblx}
		</if>
		<if test="wzbt !=null and wzbt != ''">
			,#{wzbt}
		</if>
		<if test="wzzz !=null and wzzz != ''">
			,#{wzzz}
		</if>
		<if test="qkxx !=null and qkxx != ''">
			,#{qkxx}
		</if>
		<if test="mrxz !=null and mrxz != ''">
			,#{mrxz}
		</if>
		#{lrry},LOCALTIMESTAMP,'0')
	</insert>
	
	<update id="update">
		update igams_ckwxgl
		<set>
			xgry=#{xgry},xgsj=LOCALTIMESTAMP
			<if test="yblx !=null and yblx != ''">
				,yblx=#{yblx}
			</if>
			<if test="wzbt !=null and wzbt != ''">
				,wzbt=#{wzbt}
			</if>
			<if test="wzzz !=null and wzzz != ''">
				,wzzz=#{wzzz}
			</if>
			<if test="qkxx !=null and qkxx != ''">
				,qkxx=#{qkxx}
			</if>
			<if test="mrxz !=null and mrxz != ''">
				,mrxz=#{mrxz}
			</if>
		</set>
		<where>
			wxid=#{wxid}
		</where>
	</update>
	
	<update id="delete" parameterType="CkwxglDto">
		update igams_ckwxgl set
			scsj=LOCALTIMESTAMP,scbj='1'
		<where>
			scbj!='1'
				and wxid in 
				<foreach collection="ids" separator="," open="(" close=")" item="item" index="index">
					#{item}
				</foreach>
		</where>
	</update>
	
	<insert id="insertByListDto" parameterType="List">
		insert into igams_ckwxgl(wxid,wzid,yblx,wzbt,wzzz,qkxx,lrry,lrsj,scbj)
		values
		<foreach collection="list" item="item" index="index" separator="," open="" close="">
			(#{item.wxid},#{item.wzid},#{item.yblx},#{item.wzbt},#{item.wzzz},#{item.qkxx},#{item.lrry},LOCALTIMESTAMP,'0')
		</foreach>
	</insert>
	
	<select id="getRefsForWord" parameterType="list" resultType="CkwxglDto">
		select ckwxgl.wzzz,ckwxgl.wzbt,ckwxgl.qkxx 
			from igams_ckwxgl ckwxgl
			left outer join 
			(
				<if test="list !=null and list.size()>0">
					<foreach collection="list" index="index" item="item" separator=" union all ">
						select #{item.id,jdbcType=VARCHAR} wxid,#{index} ordernum
					</foreach>
				</if>
			) tmp on ckwxgl.wxid = tmp.wxid
			
			<where>
				ckwxgl.scbj!='1'
				<if test="list !=null and list.size()>0">
				and ckwxgl.wxid in
					<foreach collection="list" open="(" close=")" index="index" item="item" separator=",">
						#{item.id}
					</foreach>
				</if>
			</where>
			order by tmp.ordernum
	</select>
	
	<!-- 获取需要新增的参考文献list(发送报告接口用) -->
	<select id="getAddCkwxList" parameterType="list" resultType="CkwxglDto">
		select t.wxid,t.wzid,t.yblx,t.wzbt,t.wzzz,t.qkxx,t.lrry from
		(
			<foreach collection="list" separator="union all" item="item">
				select #{item.wxid} wxid,#{item.wzid} wzid,#{item.yblx} yblx,#{item.wzbt} wzbt,
				#{item.wzzz} wzzz,#{item.qkxx} qkxx,#{item.lrry} lrry
			</foreach>
		)t
		left join igams_ckwxgl ckwxgl on ckwxgl.wxid=t.wxid
		<where>
			ckwxgl.wxid is null
		</where>
	</select>
	
	<!-- 根据list中的物种id和标本类型删除参考文献信息 -->
	<update id="delByWzidAndYblxInList" parameterType="list" >
		update igams_ckwxgl set
			scsj=LOCALTIMESTAMP,scbj='1'
			<where>
				(wzid,yblx) in
				<foreach collection="list" item="item" separator="," open="(" close=")">
					(#{item.wzid},#{item.yblx})
				</foreach>
			</where>
	</update>

	<select id="getListDtoByYblxAndWzid" parameterType="list" resultType="CkwxglDto">
		select ckwxgl.wxid,ckwxgl.wzid,ckwxgl.yblx,ckwxgl.wzbt,ckwxgl.wzzz,ckwxgl.qkxx,ckwxgl.mrxz
		from (
			<foreach collection="list" item="item" index="index" separator=" union all ">
				select #{item.wzid} wzid,#{item.yblx} yblx
			</foreach>
		)tmp
		left join igams_ckwxgl ckwxgl on ckwxgl.wzid=tmp.wzid and ckwxgl.yblx=tmp.yblx
		where ckwxgl.scbj!='1'
	</select>
</mapper>
