<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.matridx.igams.wechat.dao.post.ISjsyglDao" >
    <!-- 用include方法 把需要查询都字段取出来 -->
    <sql id="SelectWhere">
        <if test="jcxms !=null and jcxms.length > 0">
            and xmsygl.jcxmid in
            <foreach collection="jcxms" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test="jcxmids !=null and jcxmids.size > 0">
            and xmsygl.jcxmid in
            <foreach separator="," collection="jcxmids" open="(" close=")" index="index" item="item">
                #{item}
            </foreach>
        </if>
        <if test="hzxm != null and hzxm != ''">
            and sjxx.hzxm ILIKE '%'||#{hzxm}||'%'
        </if>
        <if test="nl != null and nl != ''">
            and sjxx.nl ILIKE '%'||#{nl}||'%'
        </if>
        <if test="xb != null and xb != ''">
            and sjxx.xb ILIKE '%'||#{xb}||'%'
        </if>
        <if test="hospitalname != null and hospitalname != ''">
            and (yyxx.dwmc ILIKE '%'||#{hospitalname}||'%' or yyxx.dwjc ILIKE '%'||#{hospitalname}||'%' or yyxx.dwqtmc ILIKE '%'||#{hospitalname}||'%')
        </if>
        <if test="db!=null and db !=''">
            and sjxx.db ILIKE '%'||#{db}||'%'
        </if>
        <if test="zyh != null and zyh != ''">
            and sjxx.zyh like '%'||#{zyh}||'%'
        </if>
        <if test="ybbh != null and ybbh != ''">
            and sjxx.ybbh ILIKE '%'||#{ybbh}||'%'
        </if>
        <if test="kdh != null and kdh != ''">
            and sjxx.kdh ILIKE '%'||#{kdh}||'%'
        </if>

        <if test="nbbm != null and nbbm != ''">
            and sjxx.nbbm ILIKE '%'||#{nbbm}||'%'
        </if>
        <if test="cskz5 != null and cskz5 != ''">
            and sjxx.cskz5 ILIKE '%'||#{cskz5}||'%'
        </if>
        <if test="wksxbm != null and wksxbm != ''">
            and sjsygl.wksxbm ILIKE '%'||#{wksxbm}||'%'
        </if>
        <if test="qyrqstart != null and qyrqstart != ''">
            and to_char(sjxx.qyrq,'yyyy-mm-dd hh24:mi:ss') &gt;= #{qyrqstart}
        </if>
        <if test="qyrqend != null and qyrqend != ''">
            and to_char(sjxx.qyrq,'yyyy-mm-dd hh24:mi:ss') &lt;= #{qyrqend}
        </if>
        <if test="ydrqstart != null and ydrqstart != ''">
            and to_char(sjxx.ydrq,'yyyy-mm-dd hh24:mi:ss') &gt;= #{ydrqstart}
        </if>
        <if test="ydrqend != null and ydrqend != ''">
            and to_char(sjxx.ydrq,'yyyy-mm-dd hh24:mi:ss') &lt;= #{ydrqend}
        </if>
        <if test="jsrqstart != null and jsrqstart != ''">
            and to_char(sjsygl.jsrq,'yyyy-mm-dd') &gt;= #{jsrqstart}
        </if>
        <if test="jsrqend != null and jsrqend != ''">
            and to_char(sjsygl.jsrq,'yyyy-mm-dd') &lt;= #{jsrqend}
        </if>
        <if test="bgrqstart != null and bgrqstart != ''">
            and to_char(sjxx.bgrq,'yyyy-mm-dd') &gt;= #{bgrqstart}
        </if>
        <if test="bgrqend != null and bgrqend != ''">
            and to_char(sjxx.bgrq,'yyyy-mm-dd') &lt;= #{bgrqend}
        </if>
        <if test="fkrqstart != null and fkrqstart != ''">
            and to_char(sjxx.fkrq,'yyyy-mm-dd') &gt;= #{fkrqstart}
        </if>
        <if test="fkrqend != null and fkrqend != ''">
            and to_char(sjxx.fkrq,'yyyy-mm-dd') &lt;= #{fkrqend}
        </if>
        <if test="xsrymc !=null and xsrymc !=''">
            and xtyh.zsxm ILIKE '%'||#{xsrymc}||'%'
        </if>
        <if test="lcfk !=null and lcfk !=''">
            and sjxx.lcfk ILIKE '%'||#{lcfk}||'%'
        </if>
        <if test="sfzq=='0'.toString() or sfzq =='1'.toString()">
            and sjxx.sfzq=#{sfzq}
        </if>
        <if test="sfzq=='3'.toString()">
            and sjxx.sfzq is null
        </if>
        <if test = "dwids != null and dwids.length > 0 "  >
            and sjxx.ks in
            <foreach collection="dwids" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "kdlxs != null and kdlxs.length > 0 "  >
            and sjxx.kdlx in
            <foreach collection="kdlxs" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "gzlxs != null and gzlxs.length > 0 "  >
            and hbxx.gzlx in
            <foreach collection="gzlxs" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "sjkzcs1 != null and sjkzcs1.length > 0 "  >
            and sjxx.cskz1 in
            <foreach collection="sjkzcs1" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "sjkzcs2 != null and sjkzcs2.length > 0 "  >
            and sjxx.cskz2 in
            <foreach collection="sjkzcs2" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "sjkzcs3 != null and sjkzcs3.length > 0 "  >
            and sjxx.cskz3 in
            <foreach collection="sjkzcs3" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "sjkzcs4 != null and sjkzcs4.length > 0 "  >
            and sjxx.cskz4 in
            <foreach collection="sjkzcs4" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "jyjgs != null and jyjgs.length > 0 "  >
            and sjxx.jyjg in
            <foreach collection="jyjgs" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test="fkbj!=null and fkbj!=''">
            and sjxx.fkbj=#{fkbj}
        </if>
        <if test="sfjs!=null and sfjs!=''">
            and sjsygl.sfjs=#{sfjs}
        </if>
        <if test="sftj!=null and sftj!=''">
            and sjxx.sftj=#{sftj}
        </if>
        <if test = "sfsfs != null and sfsfs.length > 0 "  >
            and sjxx.sfsf in
            <foreach collection="sfsfs" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "yblxs != null and yblxs.length > 0 "  >
            and sjxx.yblx in
            <foreach collection="yblxs" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "jcdws != null and jcdws.length > 0 "  >
            and sjsygl.jcdw in
            <foreach collection="jcdws" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "kyxms != null and kyxms.length > 0 "  >
            and sjxx.kyxm in
            <foreach collection="kyxms" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test = "kyxm != null and kyxm.length > 0 "  >
            and jc_kyxm.csmc ILIKE '%'||#{kyxm}||'%'
        </if>
        <if test = "kylxs != null and kylxs.length > 0 ">
            and jc_kyxm.cskz1 in
            <foreach collection="kylxs" separator="," open="(" close=") " item="item" index="index">
                <if test = "item == '其它' ">
                    null,''
                </if>
                <if test = "item != '其它' ">
                    #{item}
                </if>
            </foreach>
        </if>
        <if test="sjqfs != null and sjqfs.length>0">
            and sjxx.sjqf in
            <foreach collection="sjqfs" separator="," open="(" close=") " item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test="yyzddjs != null and yyzddjs.length>0">
            and yyxx.cskz2 in
            <foreach collection="yyzddjs" separator="," open="(" close=") " item="item" index="index">
                #{item}
            </foreach>
        </if>
        <!-- 查询是合作关系的合作伙伴 -->
        <if test="dbm =='0'.toString()">
            and hbxx.hbmc is not null
        </if>
        <!-- 查询是不是合作关系的合作伙伴 -->
        <if test="dbm =='1'.toString()">
            and hbxx.hbmc is  null
        </if>
        <if test="sfsc!=null and sfsc!=''">
            and sjxx.sfsc=#{sfsc}
        </if>
        <if test="sfzmjc!=null and sfzmjc!=''">
            and sjxx.sfzmjc=#{sfzmjc}
        </if>
        <if test="syrqstart !=null and syrqstart !=''">
            and (to_char(sjsygl.syrq,'yyyy-mm-dd') &gt;= #{syrqstart})
        </if>
        <if test="syrqend !=null and syrqend !=''">
            and (to_char(sjsygl.syrq,'yyyy-mm-dd') &lt;= #{syrqend})
        </if>
        <if test="jcbj != null and jcbj!=''">
            and sjsygl.jcbj=#{jcbj}
        </if>
    </sql>
    <select id="getPagedDtoList" parameterType="SjsyglDto" resultType="SjsyglDto">
        SELECT
            sjsygl.syglid,sjxx.sjid,sjxx.ybbh,sjxx.hzxm,yblx.csmc yblxmc,sjxx.nbbm,sjsygl.nbzbm,jcxm.csmc jcxmmc,jczxm.csmc jczxmmc,jclx.csmc jclxmc,jcdw.csmc jcdwmc,
            to_char(sjsygl.jsrq,'yyyy-mm-dd hh24:mi:ss') jsrq,to_char(sjsygl.syrq,'yyyy-mm-dd hh24:mi:ss') syrq,sjsygl.sfjs,jsry.zsxm jsrymc,sjsygl.jcbj,
            sjsygl.jt,sjsygl.zt,sjsygl.bz,lrry.zsxm lrrymc,to_char(sjsygl.lrsj,'yyyy-mm-dd hh24:mi:ss') lrsj,sjxx.ks,xmsygl.jcxmid, xmsygl.jczxmid,
            to_char(sjsygl.qysj,'yyyy-mm-dd hh24:mi:ss') qysj,qyry.zsxm qyrymc,xmmc,wkdm,xmsyglid
        FROM
            igams_sjsygl sjsygl
        LEFT JOIN igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj ='0'
        LEFT JOIN igams_sjxx sjxx ON sjxx.sjid = sjsygl.sjid
        left join igams_sjhbxx hbxx on sjxx.db = hbxx.hbmc and (hbxx.scbj = '0' or hbxx.scbj = '2')
        left join matridx_xtyh xtyh on hbxx.yhid=xtyh.yhid
        left join igams_yyxx yyxx on yyxx.dwid = sjxx.sjdw
        left join matridx_jcsj jc_kyxm on jc_kyxm.csid = sjxx.kyxm
        LEFT JOIN matridx_jcsj yblx ON yblx.csid = sjxx.yblx
        LEFT JOIN matridx_jcsj jcxm ON jcxm.csid = xmsygl.jcxmid
        LEFT JOIN matridx_jcsj jczxm ON jczxm.csid = xmsygl.jczxmid
        LEFT JOIN matridx_jcsj jclx ON jclx.csid = sjsygl.jclxid
        LEFT JOIN matridx_jcsj jcdw ON jcdw.csid = sjsygl.jcdw
        LEFT JOIN matridx_xtyh jsry ON jsry.yhid = sjsygl.jsry
        LEFT JOIN matridx_xtyh lrry ON lrry.yhid = sjsygl.lrry
        LEFT JOIN matridx_xtyh qyry ON qyry.yhid = sjsygl.qyry
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        WHERE
            sjsygl.scbj = '0' AND sjxx.scbj = '0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
        <if test="jcdwxz !=null and jcdwxz.size()>0">
            and sjsygl.jcdw in
            <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                #{item}
            </foreach>
        </if>
        <if test="userids != null and userids.size()>0">
            and (sjxx.lrry in
            <foreach collection="userids" open="(" close=")" index="index" item="item" separator=",">
                #{item}
            </foreach>
            <if test="sjhbs != null and sjhbs.size()>0">
                or sjxx.db in
                <foreach collection="sjhbs" open="(" close=")" index="index" item="item" separator=",">
                    #{item}
                </foreach>
            </if>
            )
        </if>
        <include refid="SelectWhere"></include>
    </select>
	
    <select id="getHbDto" parameterType="SjsyglDto" resultType="SjsyglDto">
        select hbxxz.hbid,hbxxz.jcxmcskz3,hbxxz.xzlx
        <if test="ywlx != null and ywlx != '' and ywlx=='DETECT_SJ'.toString">
            from igams_sjxx sj
            left outer join igams_sjjcxm jcxm on sj.sjid=jcxm.sjid and jcxm.scbj ='0'
            left outer join matridx_jcsj jc_jcxm on jc_jcxm.csid=jcxm.jcxmid
            left outer join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and hbxx.scbj = '0'
            left outer join igams_hbxxz hbxxz on hbxxz.hbid = hbxx.hbid and hbxxz.sysid = sj.jcdw and jc_jcxm.cskz3=hbxxz.jcxmcskz3
            where sj.sjid=#{sjid}
        </if>
        <if test="ywlx != null and ywlx != '' and ywlx=='DETECT_FJ'.toString">
            from igams_fjsq fjsq
            left outer join matridx_jcsj jc_jcxm on jc_jcxm.csid=fjsq.jcxm
            left join igams_sjxx sj on sj.sjid =fjsq.sjid and sj.scbj='0'
            left outer join igams_sjhbxx hbxx on sj.db = hbxx.hbmc and hbxx.scbj = '0'
            left outer join igams_hbxxz hbxxz on hbxxz.hbid = hbxx.hbid and hbxxz.sysid = fjsq.jcdw and jc_jcxm.cskz3=hbxxz.jcxmcskz3
            where fjsq.fjid=#{fjid}
        </if>
    </select>

	<select id="getInsertInfo" parameterType="SjsyglDto" resultType="SjsyglDto">
        select tmp.ywid as ywid,tmp.sjid,xmsygl.xmsyglid,sjsygl.syglid,tmp.jcdw,JCXM.CSMC ||case when jczxm.csmc is not null then '-'||jczxm.csmc else '' end jcxmmc,
			tmp.jcxmid as jcxmid,tmp.jczxmid as jczxmid,xxdy.dyxx as jclxid,tmp.lrry,xxdy.dydm as nbzbm,xxdy.dyid,xxdy.kzcs4,
			tmp.nbbm,xxdy.kzcs5,xxdy.kzcs6,xxdy.px,xxdy.kzcs7 as wksxbm,
			sjsygl.sfjs,sjsygl.jsrq,sjsygl.jsry,sjsygl.jcbj,sjsygl.syrq,sjsygl.jt,sjsygl.zt,sjsygl.qysj,sjsygl.qyry,sjsygl.bz,
			case when sjsygl.xmmc is not null then sjsygl.xmmc else jcxm.csmc ||case when jczxm.csmc is not null then '-'||jczxm.csmc end end xmmc,jcxm.cskz3 jcxmcskz3
		from (
			select fjsq.fjid as ywid,fjsq.sjid,fjsq.jcdw,fjsq.jcxm as jcxmid,fjsq.jczxm as jczxmid,fjsq.lrry,sjxx.nbbm,'DETECT_FJ' ywlx
			from igams_sjxx sjxx
			left join igams_fjsq fjsq on sjxx.sjid = fjsq.sjid and sjxx.scbj = '0'
			where sjxx.sjid = #{sjid} and fjsq.fjid is not null
			and fjsq.scbj ='0' and (fjsq.zt in ('10','80','00'))
			<if test="ids !=null and ids.size>0">
                and fjsq.fjid not in
                <foreach collection="ids" open="(" close=")" separator="," item="item">
                    #{item}
                </foreach>
            </if>
			union all
			select sjxx.sjid as ywid,sjxx.sjid,sjxx.jcdw,jcxm.jcxmid as jcxmid,jcxm.jczxmid as jczxmid,sjxx.lrry,sjxx.nbbm,'DETECT_SJ' ywlx
			from igams_sjxx sjxx
			left outer join igams_sjjcxm jcxm on sjxx.sjid = jcxm.sjid and jcxm.scbj ='0' 
			left outer join igams_wkmx wkmx on wkmx.sjid = sjxx.sjid and wkmx.scbj ='0'
            left outer join igams_tqmx tqmx on tqmx.sjid = sjxx.sjid and tqmx.scbj='0'
			where sjxx.sjid = #{sjid} and sjxx.scbj ='0' and wkmx.sjid is null and tqmx.sjid is null
		) tmp
		left join igams_xxdy xxdy on xxdy.yxxid = tmp.jcxmid and xxdy.scbj = '0'
		and (xxdy.kzcs5 = #{jcdwmc} or xxdy.kzcs5 is null or xxdy.kzcs5 = '')
		and (xxdy.kzcs4 = #{yblxdm} or xxdy.kzcs4 is null or xxdy.kzcs4 = '')
        and case when tmp.jczxmid is not null and tmp.jczxmid != '' then xxdy.zid = tmp.jczxmid else 1=1 end
		left join igams_xmsygl xmsygl on xmsygl.ywid = tmp.ywid and xmsygl.scbj = '0' and xmsygl.ywlx = tmp.ywlx
		and xmsygl.dyid = xxdy.dyid and xxdy.yxxid = xmsygl.jcxmid
		and (xxdy.zid = xmsygl.jczxmid or xmsygl.jczxmid is null or xmsygl.jczxmid = '')
		left join igams_sjsygl sjsygl on sjsygl.syglid = xmsygl.syglid and sjsygl.jclxid = xxdy.dyxx and sjsygl.scbj = '0'
		left join matridx_jcsj jcxm on tmp.jcxmid = jcxm.csid
        left join matridx_jcsj jczxm on tmp.jczxmid = jczxm.csid
		left join matridx_jcsj jc_dy on xxdy.dylx = jc_dy.csid	and jc_dy.csdm = 'XM'
		where jc_dy.csid is not null
		order by tmp.jcxmid,
			xxdy.kzcs5,
			xxdy.kzcs4
	</select>

    <select id="getDealInsertInfo" parameterType="SjsyglDto" resultType="SjsyglDto">
        select sjxx.sjid,
        case when xmsygl.xmsyglid is not null then xmsygl.xmsyglid else '' end xmsyglid,
        case when sjsygl.syglid is not null then sjsygl.syglid else '' end syglid,
        case when sjsygl.syglid is not null then coalesce(sjsygl.jcdw,sjxx.jcdw) else sjxx.jcdw end jcdw,jcxm.csmc jcxmmc,
        case when sjsygl.syglid is not null then coalesce(xmsygl.ywlx,'') else '' end lx,
        sjjcxm.jcxmid,sjjcxm.jczxmid,xxdy.dyxx as jclxid,sjxx.lrry,xxdy.dydm as nbzbm,xxdy.dyid,xxdy.kzcs4,sjxx.nbbm,xxdy.kzcs5,xxdy.kzcs6,xxdy.px,xxdy.kzcs7 as wksxbm,
        case when sjsygl.syglid is not null then coalesce(sjsygl.sfjs,'') else '' end sfjs,
        case when sjsygl.syglid is not null then coalesce(sjsygl.jsry,'') else '' end jsry,yh_js.yhm jsryyhm,yh_js.zsxm jsrymc,
        case when sjsygl.syglid is not null then coalesce(sjsygl.jcbj,'') else '' end jcbj,
        case when sjsygl.syglid is not null then coalesce(sjsygl.jt,'') else '' end jt,
        case when sjsygl.syglid is not null then coalesce(sjsygl.zt,'') else '' end zt,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.jsrq,'yyyy-mm-dd hh24:mi:ss'),'') else '' end jsrq,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.syrq,'yyyy-mm-dd hh24:mi:ss'),'') else '' end syrq,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.qysj,'yyyy-mm-dd hh24:mi:ss'),'') else '' end qysj,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.sjsj,'yyyy-mm-dd hh24:mi:ss'),'') else '' end sjsj,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.xjsj,'yyyy-mm-dd hh24:mi:ss'),'') else '' end xjsj,
        case when sjsygl.syglid is not null then coalesce(to_char(sjsygl.jcsj,'yyyy-mm-dd hh24:mi:ss'),'') else '' end jcsj,
        case when sjsygl.syglid is not null then sjsygl.qyry else '' end qyry,yh_qy.yhm qyryyhm,yh_qy.zsxm qyrymc,
        case when sjsygl.syglid is not null then coalesce(sjsygl.bz,'') else '' end bz,
        case when sjsygl.xmmc is not null then sjsygl.xmmc else jcxm.csmc end xmmc
        from igams_sjxx sjxx
        left join (
        <foreach collection="sjjcxmDtos" separator="union all" open="" close="" item="item" index="index">
            select #{sjid} as sjid,#{item.jcxmid} as jcxmid,#{item.jczxmid} as jczxmid
        </foreach>
        )sjjcxm on sjjcxm.sjid = sjxx.sjid
        left join igams_xxdy xxdy on xxdy.yxxid= sjjcxm.jcxmid
            and  xxdy.scbj = '0' and (xxdy.zid = sjjcxm.jczxmid or sjjcxm.jczxmid is null)
            and (xxdy.kzcs5=#{jcdwmc} or xxdy.kzcs5 is null or xxdy.kzcs5='')
            and (xxdy.kzcs4=#{yblxdm} or xxdy.kzcs4 is null  or xxdy.kzcs4='')
        left join igams_xmsygl xmsygl on xmsygl.ywid = sjxx.sjid
            and xmsygl.scbj = '0' and xmsygl.ywlx = #{lx} and xmsygl.dyid = XXDY.dyid
            and xxdy.yxxid = xmsygl.jcxmid AND ( xxdy.zid = xmsygl.jczxmid OR xmsygl.jczxmid is null or xmsygl.jczxmid = '' )
        left join igams_sjsygl sjsygl on sjsygl.syglid = xmsygl.syglid and sjsygl.jclxid = xxdy.dyxx  and sjsygl.scbj = '0'
        left join matridx_jcsj jcxm on sjjcxm.jcxmid = jcxm.csid
        left join matridx_jcsj jc_dy on xxdy.dylx = jc_dy.csid and jc_dy.csdm ='XM'
        left join matridx_xtyh yh_qy on yh_qy.yhid = sjsygl.qyry and yh_qy.scbj = '0'
        left join matridx_xtyh yh_js on yh_js.yhid = sjsygl.jsry and yh_js.scbj = '0'
        where sjxx.sjid = #{sjid} and jc_dy.csid is not null
        order by  sjjcxm.jcxmid ,sjjcxm.jczxmid,xxdy.kzcs5,xxdy.kzcs4
    </select>

	<insert id="insertList" parameterType="list">
        insert into igams_sjsygl(syglid,xmmc,sjid,jclxid,jcdw,sfjs,jsry,jcbj,jt,zt,bz,lrry,qyry,jsrq,syrq,lrsj,qysj,scbj,nbzbm,wksxbm)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.syglid},#{item.xmmc},#{item.sjid},#{item.jclxid},#{item.jcdw},#{item.sfjs},
            #{item.jsry},#{item.jcbj},#{item.jt},#{item.zt},#{item.bz},#{item.lrry},#{item.qyry}
            <if test="item.jsrq != null and item.jsrq !=''">
                ,cast(#{item.jsrq} as TIMESTAMP)
            </if>
            <if test="item.jsrq == null or item.jsrq ==''">
                ,null
            </if>
            <if test="item.syrq != null and item.syrq !=''">
                ,cast(#{item.syrq} as TIMESTAMP)
            </if>
            <if test="item.syrq == null or item.syrq ==''">
                ,null
            </if>
            ,coalesce(cast(#{item.lrsj} as TIMESTAMP),LOCALTIMESTAMP)
            <if test="item.qysj != null and item.qysj !=''">
                ,cast(#{item.qysj} as TIMESTAMP)
            </if>
            <if test="item.qysj == null or item.qysj ==''">
                ,null
            </if>
            ,coalesce(#{item.scbj},'0'),#{item.nbzbm},#{item.wksxbm}
            )
        </foreach>
	</insert>

	<update id="updateList" parameterType="list">
		<foreach collection="list" item="item" separator=";">
			update igams_sjsygl set xgry=#{item.xgry},xgsj=LOCALTIMESTAMP
			<if test="item.jcdw != null and item.jcdw != ''">
				,jcdw=#{item.jcdw}
			</if>
			<if test="item.sfjs != null and item.sfjs != ''">
				,sfjs=#{item.sfjs},jsrq=LOCALTIMESTAMP
			</if>
			<if test="item.nbzbm != null and item.nbzbm != ''">
				,nbzbm=#{item.nbzbm}
			</if>
			<if test="item.jsry != null and item.jsry != ''">
				,jsry=#{item.jsry}
			</if>
			<if test="item.jcbj != null and item.jcbj != ''">
				,jcbj=#{item.jcbj},syrq=LOCALTIMESTAMP
			</if>
            <if test="item.qyry != null and item.qyry != ''">
                ,qyry=#{item.qyry},qysj=LOCALTIMESTAMP
            </if>
			<if test="item.jt != null and item.jt != ''">
				,jt=#{item.jt}
			</if>
			<if test="item.zt != null and item.zt != ''">
				,zt=#{item.zt}
			</if>
			<if test="item.bz != null and item.bz != ''">
				,bz=#{item.bz}
			</if>
            <if test="item.xmmc != null and item.xmmc != ''">
                ,xmmc=#{item.xmmc}
            </if>
			<where>
				syglid=#{item.syglid}
			</where>
		</foreach>
	</update>
    <update id="updateConfirmList" parameterType="list">
        <foreach collection="list" item="item" separator=";">
            update igams_sjsygl set xgry=#{item.xgry},xgsj=LOCALTIMESTAMP,
            sfjs=#{item.sfjs},jsrq=LOCALTIMESTAMP,jsry=#{item.jsry}
            <where>
                sjid=#{item.sjid} and jclxid=#{item.jclxid}
            </where>
        </foreach>
    </update>


    <update id="modAllList" parameterType="list">
        <foreach collection="list" item="item" separator=";">
            update igams_sjsygl set xgry=#{item.xgry},xgsj=LOCALTIMESTAMP,scry=null,scsj=null
            <if test="item.jclxid != null and item.jclxid != ''">
                ,jclxid=#{item.jclxid}
            </if>
            <if test="item.jcdw != null and item.jcdw != ''">
                ,jcdw=#{item.jcdw}
            </if>
            <if test="item.sfjs != null and item.sfjs != ''">
                ,sfjs=#{item.sfjs}
            </if>
            <if test="item.xmmc != null and item.xmmc != ''">
                ,xmmc=#{item.xmmc}
            </if>
            <if test="item.jsrq != null and item.jsrq != ''">
                ,jsrq=cast (#{item.jsrq} as timestamp)
            </if>
            <if test="item.jsry != null and item.jsry != ''">
                ,jsry=#{item.jsry}
            </if>
            <if test="item.jcbj != null and item.jcbj != ''">
                ,jcbj=#{item.jcbj}
            </if>
            <if test="item.syrq != null and item.syrq != ''">
                ,syrq=cast (#{item.syrq} as timestamp)
            </if>
            <if test="item.jt != null and item.jt != ''">
                ,jt=#{item.jt}
            </if>
            <if test="item.zt != null and item.zt != ''">
                ,zt=#{item.zt}
            </if>
            <if test="item.bz != null and item.bz != ''">
                ,bz=#{item.bz}
            </if>
            <if test="item.qyry != null and item.qyry != ''">
                ,qyry=#{item.qyry}
            </if>
            <if test="item.qysj != null and item.qysj != ''">
                ,qysj=cast (#{item.qysj} as timestamp)
            </if>
            <if test="item.scbj != null and item.scbj != ''">
                ,scbj=#{item.scbj}
            </if>
            <if test="item.nbzbm != null and item.nbzbm != ''">
                ,nbzbm=#{item.nbzbm}
            </if>
            <if test="item.wksxbm != null and item.wksxbm != ''">
                ,wksxbm=#{item.wksxbm}
            </if>
            <where>
                syglid=#{item.syglid}
            </where>
        </foreach>
    </update>

    <update id="adjustUpdateList" parameterType="list">
        <foreach collection="list" item="item" separator=";">
            update igams_sjsygl set xgry=#{item.xgry},xgsj=LOCALTIMESTAMP
            <if test="item.jcdw != null and item.jcdw != ''">
                ,jcdw=#{item.jcdw}
            </if>
            <if test="item.sfjs != null and item.sfjs != ''">
                ,sfjs=#{item.sfjs}
            </if>
            <if test="item.jsrq != null and item.jsrq != ''">
                ,jsrq=cast( #{item.jsrq} as timestamp )
            </if>
            <if test="item.jsrq == null or item.jsrq == ''">
                ,jsrq = null
            </if>
            <if test="item.jcbj != null and item.jcbj != ''">
                ,jcbj=#{item.jcbj}
            </if>
            <if test="item.syrq != null and item.syrq != ''">
                ,syrq=cast( #{item.syrq} as timestamp )
            </if>
            <if test="item.syrq == null or item.syrq == ''">
                ,syrq = null
            </if>
            <if test="item.qysj != null and item.qysj != ''">
                ,qysj=cast( #{item.qysj} as timestamp )
            </if>
            <if test="item.qysj == null or item.qysj == ''">
                ,qysj = null
            </if>
            <where>
                syglid=#{item.syglid}
            </where>
        </foreach>
    </update>

	<delete id="delInfo" parameterType="SjsyglDto">
        update igams_sjsygl set scbj='1'
        <if test="scry != null and scry != '' ">
            , scry = #{scry},scsj=LOCALTIMESTAMP
        </if>
        where scbj='0' 
            and syglid in
            <foreach collection="ids" open="(" close=")" separator="," item="item">
                #{item}
            </foreach>
	</delete>
	
	<delete id="delInfoBySjid" parameterType="SjsyglDto">
        update igams_sjsygl set scbj='1'
        <if test="scry != null and scry != '' ">
            , scry = #{scry},scsj=LOCALTIMESTAMP
        </if>
        where scbj='0' and sjid=#{sjid} 
	</delete>

    <delete id="deleteInfo" parameterType="SjsyglDto">
        delete from igams_sjsygl where scbj='1' and sjid = #{sjid}
    </delete>

    <select id="getDtoById" parameterType="String" resultType="SjsyglDto">
        select sjsygl.syglid,sjsygl.sjid,xmsygl.jcxmid,xmsygl.jczxmid,sjsygl.jclxid,sjsygl.nbzbm,
        sjsygl.jcdw,sjsygl.nbzbm,sjsygl.jt,sjsygl.zt,sjsygl.bz,sjxx.nbbm,jclx.csdm, sjsygl.sfjs,sjsygl.jcbj,sjxx.ybbh,
        to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi' ) jsrq,to_char( sjsygl.syrq, 'YYYY-MM-DD HH24:mi' ) syrq, hb.hbid,
        to_char( sjsygl.qysj, 'YYYY-MM-DD HH24:mi' ) qysj,qyry.zsxm qyrymc,sjxx.hzxm,yblx.csmc as yblxmc,xmsygl.ywid,
        sjsygl.jsry,jsry.zsxm as jsrymc,xmmc,
        jcxm.csmc as jcxmmc,jczxm.csmc as jczxmmc,jclx.csmc as jclxmc,jclx.csdm jclxdm,jcdw.csmc as jcdwmc
        from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on sjsygl.syglid = xmsygl.syglid and xmsygl.scbj ='0'
        left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid
        left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
        left join matridx_jcsj jcxm on xmsygl.jcxmid = jcxm.csid
        left join matridx_jcsj jczxm on xmsygl.jczxmid = jczxm.csid
        left join matridx_jcsj jclx on sjsygl.jclxid = jclx.csid
        left join matridx_jcsj jcdw on sjsygl.jcdw = jcdw.csid
        LEFT JOIN matridx_jcsj yblx ON yblx.csid = sjxx.yblx
        left join matridx_xtyh jsry on jsry.yhid = sjsygl.jsry
        left join matridx_xtyh qyry on qyry.yhid=sjsygl.qyry
        where sjsygl.scbj='0' and sjsygl.syglid=#{syglid}
        order by jcxm.cspx,jczxm.cspx limit 1
    </select>


    <delete id="deleteInfoAjust" parameterType="SjsyglDto">
        delete from igams_sjsygl where qysj is null
        and sjid = #{sjid} and jcdw=#{jcdw} 
        and syglid in (select syglid from igams_xmsygl xmsygl where jcxmid = #{jcxmid} and ywid = #{sjid}
        <if test="jczxmid != null and jczxmid != '' and jczxmid=='null'.toString">
            and ( jczxmid = '' or jczxmid is null )
        </if>
        <if test="jczxmid != null and jczxmid != '' and jczxmid !='null'.toString">
            and jczxmid = #{jczxmid}
        </if>
        )
    </delete>

	<select id="getDtoList" parameterType="SjsyglDto" resultType="SjsyglDto">
		select sjsygl.syglid,sjsygl.sjid,xmsygl.jcxmid,xmsygl.jczxmid,sjsygl.jclxid,xxdy.kzcs1,xmsygl.xmsyglid,xmsygl.ywid,
		sjsygl.jcdw,sjsygl.nbzbm,sjsygl.jt,sjsygl.zt,sjsygl.bz,sjxx.nbbm,jclx.csdm, sjsygl.sfjs,sjsygl.jcbj,sjxx.ybbh,
		to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi' ) jsrq,to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi:ss' ) jqjsrq,
        to_char( sjsygl.syrq, 'YYYY-MM-DD HH24:mi' ) syrq,to_char( sjsygl.syrq, 'YYYY-MM-DD HH24:mi:ss' ) jqsyrq, hb.hbid,
        to_char( sjsygl.qysj, 'YYYY-MM-DD HH24:mi' ) qysj,to_char( sjsygl.qysj, 'YYYY-MM-DD HH24:mi:ss' ) jqqysj,sjsygl.qyry,qyry.zsxm qyrymc,qyry.yhm qyryyhm,xmmc,
        to_char( sjsygl.jcsj, 'YYYY-MM-DD HH24:mi' ) jcsj,to_char( sjsygl.jcsj, 'YYYY-MM-DD HH24:mi:ss' ) jqjcsj,
        to_char( sjsygl.sjsj, 'YYYY-MM-DD HH24:mi' ) sjsj,to_char( sjsygl.sjsj, 'YYYY-MM-DD HH24:mi:ss' ) jqsjsj,
        to_char( sjsygl.xjsj, 'YYYY-MM-DD HH24:mi' ) xjsj,to_char( sjsygl.xjsj, 'YYYY-MM-DD HH24:mi:ss' ) jqxjsj,
		sjsygl.jsry,jsry.zsxm as jsrymc,jsry.yhm jsryyhm,
        <if test="lxmc != null and lxmc!= ''">
            case when xmsygl.ywlx = #{lxmc} then '特检' else '复检' end lxmc,
        </if>
		jcxm.csmc as jcxmmc,jczxm.csmc as jczxmmc,jclx.csmc as jclxmc,jclx.csdm jclxdm,jcdw.csmc as jcdwmc,xxdy.yxx,xxdy.kzcs2,xxdy.kzcs3,xxdy.kzcs4,xxdy.kzcs5,fjsq.zt as fjzt,xmsygl.ywlx
		from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj = '0'
		left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid
        left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
        left join matridx_jcsj jcxm on xmsygl.jcxmid = jcxm.csid
        left join matridx_jcsj jczxm on xmsygl.jczxmid = jczxm.csid
		left join matridx_jcsj jclx on sjsygl.jclxid = jclx.csid
		left join matridx_jcsj jcdw on sjsygl.jcdw = jcdw.csid
        LEFT JOIN matridx_jcsj yblx ON yblx.csid = sjxx.yblx
		left join matridx_xtyh jsry on jsry.yhid = sjsygl.jsry
        left join igams_xxdy xxdy on xxdy.dyid = xmsygl.dyid
		left join matridx_xtyh qyry on qyry.yhid=sjsygl.qyry
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
		<where>
		sjsygl.scbj='0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
		    <choose>
	                <when test="ids !=null and ids.size>0">
	                    and sjsygl.syglid in
	                    <foreach collection="ids" open="(" close=")" separator="," item="item">
	                        #{item}
	                    </foreach>
	                </when>
	                <otherwise>
                        <if test="sjid != null and sjid!= ''">
                            and sjsygl.sjid = #{sjid}
                        </if>
	                </otherwise>
	            </choose>
		    <if test="suffixs !=null and suffixs.size()>0">
		         and sjsygl.nbzbm in
		         <foreach collection="suffixs" open="(" close=")" index="index" item="item"  separator=",">
		             #{item}
		         </foreach>
		    </if>
		    <if test="jcdwxz !=null and jcdwxz.size()>0">
                and sjsygl.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="sfjs != null and sfjs != '' and sfjs == 'null'.toString">
                and (sjsygl.sfjs != '1' or sjsygl.sfjs is null)
            </if>
            <if test="sfjs != null and sfjs != '' and sfjs != 'null'.toString">
                and sjsygl.sfjs = #{sfjs}
            </if>
            <if test="ywlx != null and ywlx!= ''">
                and xmsygl.ywlx=#{ywlx} 
            </if>
            <if test="ywid != null and ywid!= ''">
                and xmsygl.ywid=#{ywid}
            </if>
            <if test="ywids != null and ywid.size>0">
                and xmsygl.ywid in
                <foreach collection="ywids" separator="," open="(" close=") " item="item" index="index">
                    #{item}
                </foreach>
            </if>
	        </where>
        order by xmsygl.ywlx,jcxm.cspx,xmsygl.jcxmid
	</select>

    <select id="getDtoListByTempSyglids" parameterType="SjsyglDto" resultType="SjsyglDto">
        select xmsygl.xmsyglid,sjsygl.syglid,sjsygl.sjid,sjsygl.jclxid,sjsygl.qysj,
        sjsygl.jcdw,sjsygl.nbzbm,sjsygl.jt,sjsygl.zt,sjsygl.bz,sjxx.nbbm,jclx.csdm, sjsygl.sfjs,sjsygl.jcbj,sjxx.ybbh,
        to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi:ss' ) jsrq,to_char( sjsygl.syrq, 'YYYY-MM-DD HH24:mi:ss' ) syrq, hb.hbid,
        sjsygl.jsry,jsry.zsxm as jsrymc, jcxm.csmc as jcxmmc,jczxm.csmc as jczxmmc,jclx.csmc as jclxmc,jcdw.csmc as jcdwmc
        ,sjxx.ybbh,sjxx.hzxm,yblx.csmc yblxmc,xmsygl.ywlx
        from
        <if test="ids !=null and ids.size>0">
            <foreach collection="ids" open="(" close=")" index="index" item="item"  separator=" union all ">
                select #{item} xmsyglid, #{index} px
            </foreach>
        </if> tt
        left join igams_xmsygl xmsygl on tt.xmsyglid = xmsygl.xmsyglid and xmsygl.scbj = '0'
        left join igams_sjsygl sjsygl on xmsygl.syglid = sjsygl.syglid and sjsygl.scbj = '0'
        left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid
        left outer join igams_sjhbxx hb on sjxx.db = hb.hbmc and hb.scbj = '0'
        left join matridx_jcsj jcxm on xmsygl.jcxmid = jcxm.csid
        left join matridx_jcsj jczxm on xmsygl.jczxmid = jczxm.csid
        left join matridx_jcsj jclx on sjsygl.jclxid = jclx.csid
        left join matridx_jcsj jcdw on sjsygl.jcdw = jcdw.csid
        LEFT JOIN matridx_jcsj yblx ON yblx.csid = sjxx.yblx
        left join matridx_xtyh jsry on jsry.yhid = sjsygl.jsry
        <where>
            <if test="jcdwxz !=null and jcdwxz.size()>0">
                and sjsygl.jcdw in
                <foreach collection="jcdwxz" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="suffixs !=null and suffixs.size()>0">
                and sjsygl.nbzbm in
                <foreach collection="suffixs" open="(" close=")" index="index" item="item"  separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="sfjs != null and sfjs != '' and sfjs == 'null'.toString">
                and (sjsygl.sfjs != '1' or sjsygl.sfjs is null)
            </if>
            <if test="sfjs != null and sfjs != '' ">
                and sjsygl.sfjs = #{sfjs}
            </if>
            <if test="ywlx != null and ywlx!= ''">
                and xmsygl.ywlx=#{ywlx}
            </if>
        </where>
        order by tt.px
    </select>

    <select id="getDtosBySjxxFromSyglid" parameterType="SjsyglDto" resultType="Map">
        select sygl.sjid, sygl.syglid, sygl.sfjs from
        (
           <foreach collection="ids" item="item" separator=" union all ">
               select sjid from igams_sjsygl where syglid=#{item}
           </foreach>
        )tt
        left join igams_sjsygl sygl on sygl.sjid = tt.sjid and sygl.scbj = '0'
        <if test="jcxmids !=null and jcxmids.size > 0">
        left join igams_xmsygl xmsygl on xmsygl.syglid = sygl.syglid and xmsygl.scbj = '0'
        </if>
        <where>
            sygl.scbj='0'
            <if test="jcxmids !=null and jcxmids.size > 0">
                AND xmsygl.jcxmid in
                <foreach collection="jcxmids" separator="," item="item" open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getModelList" parameterType="SjsyglModel" resultType="SjsyglModel">
		select sjsygl.* from igams_sjsygl sjsygl
		left join igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj='0'
		left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
		where 
		sjsygl.scbj = '0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','00','80') else 1=1 end
		<if test="sjid != null and sjid!= ''">
            and sjsygl.sjid = #{sjid}
        </if>
        <if test="ywid != null and ywid!= ''">
            and xmsygl.ywid = #{ywid}
        </if>
        <if test="ids !=null and ids.size > 0">
            and sjsygl.syglid in
	        <foreach collection="ids" separator="," item="item" open="(" close=")">
	           #{item}
	         </foreach>
	     </if>
	</select>

    <select id="getDtosBySjids" parameterType="SjsyglDto" resultType="SjsyglDto">
        select sjsygl.syglid,sjsygl.sjid
        from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on sjsygl.syglid = xmsygl.syglid and xmsygl.scbj ='0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        <where>
            sjsygl.scbj = '0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end and sjsygl.sjid in
            <foreach collection="ids" separator="," item="item" open="(" close=")">
                #{item}
            </foreach>
            <if test="jcxmids!=null and jcxmids.size > 0">
                AND xmsygl.jcxmid in
                <foreach collection="jcxmids" separator="," item="item" open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

	<update id="updateDto" parameterType="SjsyglDto">
		update igams_sjsygl set xgry=#{xgry},xgsj=LOCALTIMESTAMP,jcdw=#{jcdw}
		where sjid=#{sjid} and jcdw=#{yjcdw}
	</update>
	
    <update id="updateJcsj" parameterType="SjsyglDto">
        update igams_sjsygl set xgry=#{xgry},xgsj=LOCALTIMESTAMP,jcsj=LOCALTIMESTAMP
        where syglid in (select syglid from igams_xmsygl where jcxmid=#{jcxmid} and ywid=#{ywid} and ywlx=#{ywlx})
    </update>
    
    <delete id="delete" parameterType="SjsyglDto">
		delete from igams_sjsygl  where sjid = #{sjid}
	</delete>

    <select id="getTqInfoList" parameterType="SjsyglDto" resultType="SjsyglDto">
        select COALESCE(xxdy.kzcs2,'') kzcs2, COALESCE(xxdy.kzcs3,'') kzcs3,sjsygl.nbzbm 
        from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj = '0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        left join igams_xxdy xxdy on xxdy.dyid = xmsygl.dyid
        where xxdy.kzcs2 is not null and sjsygl.scbj = '0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
        <if test="sjid != null and sjid!= ''">
            and sjsygl.sjid = #{sjid}
        </if>
        <if test="ywid != null and ywid!= ''">
            and xmsygl.ywid = #{ywid}
        </if>
        <if test="suffixs !=null and suffixs.size()>0">
            and sjsygl.nbzbm in
            <foreach collection="suffixs" open="(" close=")" index="index" item="item" separator=",">
                #{item}
            </foreach>
        </if>
	</select>

	<!--  (ngsgl.nbbm = sjxx.nbbm or ngsgl.nbbm=#{nbbm}) 执行速度非常慢，故改成两个sql -->
    <select id="getWkInfoList" parameterType="SjsyglDto" resultType="SjsyglDto">
        select * from (select tap.kzcs1,tap.kzcs2,tap.kzcs3,tap.px,tap.nbzbm,tap.syglid,tap.wkid,tap.dydm,row_number() over(partition by tap.syglid
        order by case when tap.sfcg = '3' then '9' else tap.sfcg end desc,tap.lrsj desc,tap.cjsj desc) cn,tap.jth from
        (select xxdy.kzcs1,xxdy.kzcs2,xxdy.kzcs3,xxdy.px,sjsygl.nbzbm,sjsygl.syglid,wkmx.wkid, xxdy.dydm,ngsgl.jth,
        ngsgl.sfcg,ngsgl.cjsj,wkmx.lrsj
        from igams_sjsygl  sjsygl
        left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid and sjxx.scbj='0'
        left join igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj = '0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        left join igams_xxdy xxdy on xxdy.dyid = xmsygl.dyid and xxdy.scbj = '0'
        left join matridx_jcsj jcxm on jcxm.csid=xmsygl.jcxmid and jcxm.scbj='0'
        left join igams_wkmx wkmx on wkmx.syglid = sjsygl.syglid and wkmx.scbj='0'
        <if test="wkid != null and wkid!= ''">
            and wkmx.wkid = #{wkid}
        </if>
         <if test="wkrq != null and wkrq != ''">
            and to_char(wkmx.wkrq,'YYYY-MM-DD') = #{wkrq}
        </if>
        left join igams_ngsgl ngsgl on ngsgl.zbbm = jcxm.cskz1 and ngsgl.nbbm=#{nbbm} and ngsgl.scbj = '0'and ngsgl.jcdw = #{jcdw}
        <if test="wkrq != null and wkrq != ''">
            and to_char(ngsgl.cjsj,'YYYY-MM-DD') = #{wkrq}
        </if>
        where sjsygl.scbj='0' and xmsygl.xmsyglid is not null and sjsygl.sjid = #{sjid}  and sjsygl.sfjs='1' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
        <if test = "jcdws != null and jcdws.length > 0 "  >
            and sjsygl.jcdw in
            <foreach collection="jcdws" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test="kzcs2 != null and kzcs2!= ''">
            and xxdy.kzcs2 = #{kzcs2}
        </if>
        <if test="kzcs3 != null and kzcs3!= ''">
            and xxdy.kzcs3 = #{kzcs3}
        </if>
        <if test="xmlimit != null and xmlimit!= ''">
            and jcxm.cskz1 = #{xmlimit}
        </if>
        union all
        select xxdy.kzcs1,xxdy.kzcs2,xxdy.kzcs3,xxdy.px,sjsygl.nbzbm,sjsygl.syglid,wkmx.wkid,xxdy.dydm,ngsgl.jth,ngsgl.sfcg,ngsgl.cjsj,wkmx.lrsj
        from igams_sjsygl  sjsygl
        left join igams_sjxx sjxx on sjsygl.sjid = sjxx.sjid and sjxx.scbj='0'
        left join igams_xmsygl xmsygl on xmsygl.syglid = sjsygl.syglid and xmsygl.scbj = '0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        left join igams_xxdy xxdy on xxdy.dyid = xmsygl.dyid and xxdy.scbj = '0'
        left join matridx_jcsj jcxm on jcxm.csid=xmsygl.jcxmid and jcxm.scbj='0'
        left join igams_wkmx wkmx on wkmx.syglid = sjsygl.syglid and wkmx.scbj='0'
        <if test="wkid != null and wkid!= ''">
            and wkmx.wkid = #{wkid}
        </if>
         <if test="wkrq != null and wkrq != ''">
            and to_char(wkmx.wkrq,'YYYY-MM-DD') = #{wkrq}
        </if>
        left join igams_ngsgl ngsgl on ngsgl.zbbm = jcxm.cskz1 and ngsgl.nbbm = sjxx.nbbm  and ngsgl.scbj = '0'and ngsgl.jcdw = #{jcdw}
        <if test="wkrq != null and wkrq != ''">
            and to_char(ngsgl.cjsj,'YYYY-MM-DD') = #{wkrq}
        </if>
        where sjsygl.scbj='0' and xmsygl.xmsyglid is not null and sjsygl.sjid = #{sjid}  and sjsygl.sfjs='1' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
        <if test = "jcdws != null and jcdws.length > 0 "  >
            and sjsygl.jcdw in
            <foreach collection="jcdws" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
        </if>
        <if test="kzcs2 != null and kzcs2!= ''">
            and xxdy.kzcs2 = #{kzcs2}
        </if>
        <if test="kzcs3 != null and kzcs3!= ''">
            and xxdy.kzcs3 = #{kzcs3}
        </if>
        <if test="xmlimit != null and xmlimit!= ''">
            and jcxm.cskz1 = #{xmlimit}
        </if>
        )tap) tab where tab.cn=1 order by tab.px
    </select>

    <update id="updateQyrq" parameterType="SjsyglDto">
		update igams_sjsygl sjsygl set xgry=#{xgry},xgsj=LOCALTIMESTAMP
		,qysj=LOCALTIMESTAMP,qyry=#{qyry}
		where  sjsygl.syglid in
        <foreach collection="ids" open="(" close=")" separator="," item="item">
            #{item}
        </foreach>
	</update>

    <update  id="deleteBySyglids" parameterType="SjsyglDto">
        update igams_sjsygl set scry = #{scry},scsj = LOCALTIMESTAMP,scbj='1'
        <where>
        	scbj='0'
            and syglid in
            <foreach collection="ids" open="(" close=")" separator="," item="item" index="index">
                #{item}
            </foreach>
        </where>
    </update>

    <update  id="deleteByYwids" parameterType="SjsyglDto">
        update igams_sjsygl set scry = #{scry},scsj = LOCALTIMESTAMP,scbj='1'
        <where>
            ywid in
            <foreach collection="ywids" open="(" close=")" separator="," item="item" index="index">
                #{item}
            </foreach>
        </where>
    </update>

    <select id="getRfs" parameterType="SjsyglDto" resultType="SjsyglDto">
		select to_char(sjsygl.syrq,'yyyy-mm-dd hh24:mi:ss')syrq,to_char(sjsygl.kzsj,'yyyy-mm-dd hh24:mi:ss')kzsj,to_char(sjsygl.qysj,'yyyy-mm-dd hh24:mi:ss')qysj 
		from igams_sjsygl sjsygl
		left join igams_xmsygl xmsygl on sjsygl.syglid = xmsygl.syglid and xmsygl.scbj ='0'
		LEFT JOIN matridx_jcsj jcxm ON jcxm.csid = xmsygl.jcxmid
		where sjsygl.scbj='0' and sjsygl.sjid = #{sjid}
		and jcxm.csdm=#{jcxm} limit 1
	</select>



    <select id="getInfoByNbbm" parameterType="SjsyglDto" resultType="SjsyglDto">
        select sjsy.syglid,case when sjsy.ywid is null then sjsy.sjid else sjsy.ywid end ywid,sj.sjid,sj.nbbm ,xxdy.kzcs2,xxdy.kzcs3,sjsy.syglid,sjsy.syrq,sj.syrq rsyrq,sj.dsyrq,sj.qtsyrq,jclx.cskz1 jclxcskz1,xmsygl.ywlx,jcxm.cskz1 jcxmcskz1
        from igams_sjxx sj
        left join igams_sjsygl sjsy on sjsy.sjid=sj.sjid and sjsy.scbj = '0'
        left join igams_xmsygl xmsygl on sjsy.syglid = xmsygl.syglid and xmsygl.scbj ='0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        left join igams_xxdy xxdy on xxdy.dyid=xmsygl.dyid and xxdy.scbj = '0'
        left join matridx_jcsj jclx on jclx.csid=sjsy.jclxid and xxdy.scbj = '0'
        left join matridx_jcsj jcdw on jcdw.csid=sjsy.jcdw and xxdy.scbj = '0'
        left join matridx_jcsj jcxm on jcxm.csid=xmsygl.jcxmid and xxdy.scbj = '0'
        <where>
            sj.scbj='0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
            <if test="nbbm != null and nbbm != ''">
                and sj.nbbm =#{nbbm}
            </if>
            <if test="kzcs3 != null and kzcs3 != ''">
                and xxdy.kzcs3 =#{kzcs3}
            </if>
            <if test="kzcs2 != null and kzcs2 != ''">
                and xxdy.kzcs2 =#{kzcs2}
            </if>
            <if test="jcdwmc != null and jcdwmc != ''">
                and jcdw.csmc =#{jcdwmc}
            </if>
        </where>
    </select>


    <update id="updateSyList" parameterType="list">
        <foreach collection="list" item="item" separator=";">
            <choose>
                <when test="item.syrq !=null and item.syrq != ''">
                    update igams_sjsygl set jcbj='1',syrq = cast (#{item.syrq} as timestamp) where syglid=#{item.syglid}
                </when>
                <otherwise>
                    <if test="item.ywlx != null and item.ywlx != '' and item.ywlx=='DETECT_SJ'.toString">
                        update igams_sjxx set
                        <trim prefixOverrides=",">
                        <if test="item.rsyrq !=null and item.rsyrq !=''">
                            ,jcbj='1', syrq = cast (#{item.rsyrq} as timestamp)
                        </if>
                        <if test="item.dsyrq !=null and item.dsyrq !=''">
                            ,djcbj='1', dsyrq = cast (#{item.dsyrq} as timestamp)
                        </if>
                        <if test="item.qtsyrq !=null and item.qtsyrq !=''">
                            ,qtjcbj='1', qtsyrq = cast (#{item.qtsyrq} as timestamp)
                        </if>
                        </trim>
                        where sjid=#{item.ywid}
                    </if>
                    <if test="item.ywlx != null and item.ywlx != '' and item.ywlx=='DETECT_FJ'.toString">
                        update igams_fjsq set
                        <trim prefixOverrides=",">
                        <if test="item.rsyrq !=null and item.rsyrq !=''">
                            ,rjcbj='1', rsyrq = cast (#{item.rsyrq} as timestamp)
                        </if>
                        <if test="item.dsyrq !=null and item.dsyrq !=''">
                            ,djcbj='1', dsyrq = cast (#{item.dsyrq} as timestamp)
                        </if>
                        <if test="item.qtsyrq !=null and item.qtsyrq !=''">
                            ,qtjcbj='1', qtsyrq = cast (#{item.qtsyrq} as timestamp)
                        </if>
                        </trim>
                        where fjid=#{item.ywid}
                    </if>
                </otherwise>
            </choose>
        </foreach>
    </update>

    <select id="getViewDetectData" parameterType="String" resultType="SjsyglDto">
        SELECT
            jcxm.csmc AS jcxmmc,
            jczxm.csmc AS jczxmmc,
            to_char(sjsygl.jsrq,'yyyy-mm-dd hh24:MI:ss') as jsrq,
            to_char(sjsygl.qysj,'yyyy-mm-dd hh24:MI:ss') as qysj,
            to_char(sjsygl.syrq,'yyyy-mm-dd hh24:MI:ss') as syrq,
            to_char(sjsygl.sjsj,'yyyy-mm-dd hh24:MI:ss') as sjsj
       FROM
           igams_xmsygl xmsygl
        left outer join igams_sjsygl sjsygl on xmsygl.syglid = sjsygl.syglid and sjsygl.scbj ='0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        LEFT JOIN matridx_jcsj jcxm ON jcxm.csid = xmsygl.jcxmid
        AND jcxm.scbj = '0'
        LEFT JOIN matridx_jcsj jczxm ON jczxm.csid = xmsygl.jczxmid
        AND jczxm.scbj = '0'
       WHERE
           sjsygl.sjid = #{sjid}
         AND xmsygl.scbj = '0' and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
       order BY
        xmsygl.jcxmid,
        xmsygl.jczxmid
    </select>

    <update id="updateXmmc" parameterType="SjsyglDto">
        update igams_sjsygl sjsygl
        set xgsj=LOCALTIMESTAMP,xgry=#{xgry},xmmc=tmp.xmmc
        from(
        select xmsygl.syglid,string_agg (distinct jcxm.csmc,',' ) xmmc from igams_xmsygl xmsygl
        left join matridx_jcsj jcxm on jcxm.csid=xmsygl.jcxmid and jcxm.scbj = '0'
        where xmsygl.scbj='0' and xmsygl.ywid=#{sjid} group by xmsygl.syglid
        )
        tmp
        where
        sjsygl.syglid=tmp.syglid
    </update>

    <update id="updateScbj" parameterType="SjsyglDto">
        update igams_sjsygl
        set scsj=LOCALTIMESTAMP,scry=#{scry},scbj='1'
        where
        syglid in (
        select sjsygl.syglid from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on xmsygl.syglid=sjsygl.syglid and xmsygl.scbj = '0'
        where sjsygl.scbj='0' and sjsygl.sjid=#{sjid} and xmsygl.xmsyglid is null
        )
    </update>
    <update id="updateSfjs" parameterType="SjsyglDto">
        update igams_sjsygl set xgry=#{xgry},xgsj=LOCALTIMESTAMP
        <if test="sfjs=='1'.toString()">
            ,sfjs = '1'
            ,jsrq=case when jsrq is null then cast(#{jsrq} as timestamp) else jsrq end
            ,jsry=case when jsry is null then #{jsry} else jsry end
        </if>
        <if test=" sfjs=='0'.toString()">
            ,sfjs = '0'
            ,jsrq = null
            ,jsry = null
        </if>
        where
        scbj='0' 
            and syglid in (select syglid from igams_xmsygl where ywid = #{ywid} and scbj ='0') 
    </update>

    <!--送检查看页面检测项目TAB页用-->
    <select id="getSyxxViewByYwid" resultType="SjsyglDto" parameterType="SjsyglDto">
        select sjsygl.xmmc,jclx.csmc jclxmc,sjsygl.nbzbm,to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi' ) jsrq,to_char( sjsygl.syrq, 'YYYY-MM-DD HH24:mi' ) syrq,
        to_char( sjsygl.qysj, 'YYYY-MM-DD HH24:mi' ) qysj,qyry.zsxm qyrymc,sjsygl.jcbj,sjsygl.sfjs,
        sjsygl.jsry,jsry.zsxm as jsrymc,jcdw.csmc jcdwmc,sjsygl.wksxbm,sjsygl.jclxid,
        sjsygl.syglid
        from igams_sjsygl sjsygl
        left join igams_xmsygl xmsygl on xmsygl.syglid=sjsygl.syglid and xmsygl.scbj = '0'
        left join igams_fjsq fjsq on xmsygl.ywid = fjsq.fjid and xmsygl.ywlx ='DETECT_FJ'
        left join matridx_jcsj jclx on jclx.csid=sjsygl.jclxid
        left join matridx_jcsj jcdw on jcdw.csid=sjsygl.jcdw
        left join matridx_xtyh jsry on jsry.yhid = sjsygl.jsry
        left join matridx_xtyh qyry on qyry.yhid=sjsygl.qyry
        where sjsygl.scbj='0' and sjsygl.sjid=#{ywid} and case when xmsygl.ywlx='DETECT_FJ' then fjsq.scbj ='0' and fjsq.zt in ('10','80') else 1=1 end
        group by sjsygl.syglid,jclx.csmc,sjsygl.nbzbm,qyry.zsxm,jsry.zsxm,jcdw.csmc
    </select>

    <select id="getExtractInfo" parameterType="Map" resultType="Map">
    select * from (
        select tqmx.tqmxid,tqmx.syglid,tqmx.tqid,tqmx.xh,tqmx.nbbh,''||tqmx.hsnd as hsnd,tqmx.sjid,tqmx.cdna,tqmx.jkyl,
        tqmx.hcyyl,tqmx.xsnd,tqmx.tqdm,to_char(tqmx.lrsj,'YYYY-MM-DD') lrsj,tqmx.tqrq,
        case when WKMX.TQMXID is not null then '1' else '0' end BJ,
		row_number() over(partition by tqmx.tqmxid order by wkgl.wkid) cn
        from igams_tqmx tqmx
        left join igams_tqgl tqgl on tqmx.tqid = tqgl.tqid
        left join igams_wkmx wkmx ON wkmx.tqmxid = tqmx.tqmxid and wkmx.scbj ='0' 
        left join igams_wkgl wkgl on wkmx.wkid = wkgl.wkid
        <where>
            tqmx.scbj!='1'
            and tqmx.sjid=#{sjid}
            <if test = "jcdws != null and jcdws.length > 0 "  >
            and tqgl.jcdw in
            <foreach collection="jcdws" separator="," open="(" close=") "
                     item="item" index="index">
                #{item}
            </foreach>
            and tqgl.tqrq &gt;= to_date( #{rq},'YYYY-MM-DD') - interval '1 day'
            and tqgl.tqrq &lt;= to_date( #{rq},'YYYY-MM-DD') 
        </if>
        </where>
        ) tmp where cn =1
        order by lrsj desc,bj asc,xh desc
    </select>
    
     <delete id="delBySjid" parameterType="SjsyglDto">
        update igams_sjsygl set scbj='1'
        <if test="scry != null and scry != '' ">
            , scry = #{scry},scsj=LOCALTIMESTAMP
        </if>
        where scbj='0'
        and sjid =#{sjid}
    </delete>
    <update id="updateJsInfo" parameterType="SjsyglDto">
        update igams_sjsygl set xgry=#{xgry},xgsj=LOCALTIMESTAMP,
        sfjs=#{sfjs}
        <if test="sfjs != null and sfjs !='' and  sfjs== '0'.toString() ">
            ,jsry = null
        </if>
        <if test="jsrq != null and jsrq !=''">
            ,jsrq = cast(#{jsrq} as TIMESTAMP)
        </if>
        <if test="jsrq == null or jsrq ==''">
            ,jsrq = null
        </if>
        <where>
            sjid=#{sjid} and syrq is null and scbj ='0'
        </where>
    </update>

    <select id="getOrderSyrqDto" parameterType="SjsyglDto" resultType="SjsyglDto">
        select sjsygl.syglid,sjsygl.sjid,sjsygl.jclxid,
        sjsygl.jcdw,sjsygl.nbzbm,sjsygl.jt,sjsygl.zt,sjsygl.bz, sjsygl.sfjs,sjsygl.jcbj,
        to_char( sjsygl.jsrq, 'YYYY-MM-DD HH24:mi' ) jsrq,
        to_char( sjsygl.syrq, 'YYYY-MM-DD' ) syrq,
        to_char( sjsygl.qysj, 'YYYY-MM-DD HH24:mi' ) qysj,
        to_char( sjsygl.jcsj, 'YYYY-MM-DD HH24:mi' ) jcsj,
        to_char( sjsygl.sjsj, 'YYYY-MM-DD HH24:mi' ) sjsj,
        to_char( sjsygl.xjsj, 'YYYY-MM-DD HH24:mi' ) xjsj
        from igams_sjsygl sjsygl
        <where>
            scbj='0' and sjid=#{sjid} order by sjsygl.syrq desc NULLS LAST
        </where>
    </select>

    <update id="updateFjJsrq" parameterType="list">
        update igams_sjsygl sjsygl set sfjs ='1',jsrq = LOCALTIMESTAMP
        from igams_xmsygl xmsygl where sjsygl.syglid = xmsygl.syglid
        and  sfjs is null and xmsygl.ywlx not like '%DETECT_SJ%' and sjsygl.syglid in (
        <foreach collection="list" item="item" separator=",">
            #{item.syglid}
        </foreach>
        )
    </update>
</mapper>

