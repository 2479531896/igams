<!DOCTYPE html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	    <title th:text="${title}"></title>
	    <link rel="stylesheet" href="/css/element-ui.css">
	    <link rel="stylesheet" href="/css/loginbase.css">
	    <link rel="stylesheet" href="/css/home.css?v=20250123v1">
	    <link rel="stylesheet" href="/css/animate.css">
	    <link rel="stylesheet" href="/css/bootstrap.min.css">
		<script src="/js/jquery-3.6.1.min.js"></script>
	    <link rel="icon" th:href="${icourl}" type="image/x-icon" />
	    <script src="/js/globalweb/login.js"></script>
	    <!--jQuery常用工具扩展库：基础工具,资源加载工具,元素尺寸相关工具 -->
		<script type="text/javascript" src="/js/jquery.utils.contact-min.js" charset="utf-8"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js" charset="utf-8"></script>
		<!-- 表单验证 -->
		<!--Bootbox弹窗插件-->
		<link rel="stylesheet" type="text/css" href="/js/plugins/bootbox/css/bootbox-min.css" />
		<script src="/js/plugins/bootbox/bootbox.concat-min.js?v=20220905v1" type="text/javascript" charset="utf-8"></script>
		<script src="/js/plugins/bootbox/lang/zh_CN-min.js" type="text/javascript" charset="utf-8"></script>
<!--		<script src="https://g.alicdn.com/dingding/dinglogin/0.0.5/ddLogin.js"></script>-->
		<style type="text/css">
	    	.popover {
				max-width:500px;
			}
	    	.gm-version {
				height: 40px;
				line-height: 40px;
				width: 40px;
			}
				/*版本信息 */
			.gm-version-panel{
		        width:100%;
			}
			/* 行间距 */
			.gm-version-panel .item{
		    	line-height: 30px;
			}
			/* 段落设置*/
			.gm-version-panel .item p{
				padding-left: 10px;
		    	padding-right: 10px;
				color:#666;
				display:block;
			}
			/* 选中时段落设置 */
			.gm-version-panel .item p:hover {
		    	color: #fff;
		    	background-color: #3E9EE1 !important;
			}

			body, dd, div, dl, dt, form, h1, h2, h3, h4, h5, h6, input, li, ol, p, pre, td, textarea, th, ul { margin: 0; padding: 0 }

			h1, h2, h3, h4, h5, h6 { font-size: 100%; font-weight: 400 }

			body { font-family: PingFang SC,Helvetica,Arial,Verdana,Microsoft YaHei !important; font: 12px/1.6 Tahoma,Arial,Hiragino Sans GB,\5b8b\4f53; color: #373D41; -webkit-text-size-adjust: none }

			a:link { color: #9B9EA0; text-decoration: none }

			a:visited { color: #9B9EA0; text-decoration: none }

			a:active, a:hover { color: #08c; text-decoration: underline }

			input { outline: 0 }

			a img { vertical-align: text-bottom; }

			:-moz-placeholder, :-ms-input-placeholder, ::-moz-placeholder, ::-webkit-input-placeholder { font-size: 14px; color: #9B9EA0 }

			#login-wrap .hd h2 { display: block; cursor: pointer; width: 48px; height: 48px; position: absolute; top: 0; right: 0 }

			#login-wrap #InputLogin { display: none; }

			.poptip-arrow em, .poptip-arrow span { position: absolute; *zoom: 1; width: 0; height: 0; border-color: rgba(255,255,255,0); border-color: transparent \0; *border-color: transparent; _border-color: tomato; _filter: chroma(color=tomato); border-style: solid; overflow: hidden; top: 0; left: 0 }

			.poptip-arrow em { top: 0; left: 1px; border-left-color: #478bde; border-width: 6px 0 6px 6px }

			.poptip-arrow span { border-left-color: #E6F9FC; border-width: 6px 0 6px 6px }

			.quick-description a, a:active, a:hover { color: #478bde; text-decoration: none }

			.quick-msg h6 { font-size: 18px; color: #5F6367; margin-top: 10px; font-weight: 400; text-align: center; line-height: 24px; }

			.quick-msg p { margin-top: 10px; text-align: center; font-size: 14px; color: #5F6367; }

			#quick-other .register a:link, #quick-other .register a:visited { color: #9B9EA0 }

			#quick-other .register a:hover { color: #478bde }

			.msg-err i, .msg-ok i { display: inline-block; _display: inline; font-size: 32px; line-height: 32px; margin: 0 auto; text-align: center }

			.msg-ok i { color: #b5e163 }

			.msg-err i { color: #f37c75 }


			/*用户登录*/

			.clr:after { content: "."; display: block; height: 0; clear: both; overflow: hidden }

			.clr { *zoom: 1 }

			.form { width: 100% }

			#login-form { position: static; margin-top: 70px; }

			#login-form a, #login-form a:hover, #login-form a:visited { text-decoration: none }

			#login-form .notice-descript a, #login-form .notice-descript a:hover, #login-form .notice-descript a:visited { text-decoration: underline }

			#InputLogin { margin: 0 auto }
			#input-content .input-field-wrap:after { content: "\0020"; display: block; height: 0; clear: both; overflow: hidden }

			#input-content .input-field-wrap { *zoom: 1 }

			#input-content .input-field { padding: 0; margin-bottom: 20px }

			#input-content .fm-text { float: left; padding: 0 10px; height: 40px; border: 1px solid #D7D8D9; line-height: 40px; font-size: 12px; color: #595959; background: #fff; vertical-align: middle; -webkit-box-shadow: 0 1px 0 #ececec inset; -moz-box-shadow: 0 1px 0 #ececec inset; -ms-box-shadow: 0 1px 0 #ececec inset; -o-box-shadow: 0 1px 0 #ececec inset; box-shadow: 0 1px 0 #ececec inset; _padding: 5px 6px; box-sizing: border-box; outline: 0; box-shadow: none; }

			/*#input-content .fm-text:hover { border: 1px solid #478bde }*/

			#input-content .fm-text:focus { border-color: #478bde; -webkit-box-shadow: 0 0 2px #a6cfff; -moz-box-shadow: 0 0 2px #a6cfff; -ms-box-shadow: 0 0 2px #a6cfff; -o-box-shadow: 0 0 2px #a6cfff; box-shadow: 0 0 2px #a6cfff }

			#input-content label { font-weight: 700 }

			#input-content .fm-text { width: 100% }

			#input-content .fm-text::selection { background: #1996e6; color: #fff }

			#input-content .fm-text::-moz-selection { background: #1996e6; color: #fff }

			#input-content .fm-text::-webkit-input-placeholder { color: #aaa }

			#input-content .fm-text:-moz-placeholder { color: #aaa }

			#input-content .fm-text:-ms-input-placeholder { color: #aaa }

			a.input-login-submit-button { display: inline-block !important; height: 28px; line-height: 28px; text-align: center; text-decoration: none !important; color: #fff !important }

			input.input-login-submit-button { _border: 1px solid #fff; _line-height: 28px; _overflow-y: hidden; _background-color: #e87b0e }

			input.input-login-submit-button:active, input.input-login-submit-button:hover { _background-color: #e87b0e }

			#InputLogin #input-login-other { overflow: hidden; zoom: 1; margin-top: 10px }

			#InputLogin #input-login-other .register a { color: #9B9EA0 }

			#InputLogin #input-login-other .register a:hover { color: #478bde }

			#InputLogin #input-login-other .forgetpassword { float: right; }

			.intit {
				font-size: 32px;
				color: #1c2228;
				text-align: center;
				letter-spacing: 12px;
				margin-bottom: 20px;
			}

			.input-field-wrap #username{
				display: block;
				height: 52px;
				font-size: 16px;
				color: #1c2228;
				border: none;
				outline: none;
				border-bottom: 1px solid #ccc;
				box-sizing: border-box;
			}

			.input-field-wrap #password {
				display: block;
				height: 52px;
				font-size: 16px;
				color: #1c2228;
				border: none;
				outline: none;
				border-bottom: 1px solid #ccc;
				box-sizing: border-box;
			}


			#input-login-submit #logindl {
				width: 100%;
				height: 36px;
				background-color: #478bde;
				font-size: 20px;
				color: #fff;
				border-radius: 26px;
				border: none;
				outline: none;
				cursor: pointer;
				margin: auto;
				display: block;
				letter-spacing: 4px;
				transition: all 0.3s;
			}
			iframe{
				margin: 0 auto;
			}
	        .el-input {
	        }
	    </style>
	</head>
	<body>
		<div id="app" class="wrapper">
			<div class="loginWrap row" style="height: 900px;">
				<div class="boxL1 fadeInDown wow animated hidden-sm hidden-xs col-md-8" style="visibility: visible; animation-name: fadeInDown;">

				</div>
				<div data-wow-delay="0.2s" class="boxR fadeInDown wow animated col-md-4 col-sm-12 col-xs-12" style="visibility: visible; animation-delay: 0.2s; animation-name: fadeInDown;">
					<!-- 版本信息 -->
					<div class="dropdown"  style="float: right;height: 40px;line-height: 40px;width: 40px;text-align: center">
						<ul class="glyphicon glyphicon-exclamation-sign" id="dropdownMenu" data-toggle="dropdown"></ul>
						<ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu" style="width:500px">
						<h5 style="text-align: center;font-weight:bold">版本信息</h5>
							<div class="gm-version-module">
								<div class="gm-version-panel">
									<div th:each="list:${bbxxlist}" th:if="${listStat.index<3}">
										<div class="item">
											<p><B>版本标签：</B><span id="VersionTag" th:text="${list.bbbq}"/>
											<br>
											<B>上线时间：</B><span id="UpdateTime" th:text="${list.sxsj}"/>
											<br>
											<B>更新内容：</B><span>[(${list.gxnr})]</span></p>
											<hr>
										</div>
									</div>
								</div>
							</div>
						</ul>
					</div>

					<div  id="wholeDiv" class="col-md-11 col-lg-11 col-sm-11 col-xs-12"  style="margin-top: 20%;">
						<div id="loginTab" class="col-md-12 col-lg-12 col-sm-12" style="height:500px;background-color:#fff;border-radius: 10px;border: 1px solid rgba(126, 134, 142, 0.16);box-shadow: 0 4px 14px 0 rgba(126, 134, 142, 0.16);">

<!--							<div class="col-md-5 col-lg-6 col-sm-5 col-xs-12" style="background-color:#fff;float: left;" id="loginDiv">-->

<!--&lt;!&ndash;								<div class="intit col-md-12" style="padding-top: 60px;font-size: 22px">扫码登录</div>&ndash;&gt;-->
<!--								<ul id="companyTab" class="nav nav-tabs col-md-12" style="padding-top: 60px;border-bottom: 0;margin: 0 10px;">-->
<!--									<li role="presentation" th:each="list:${wbcxDtos}" th:class="${'companyChange '+(listStat.index==0?'active':'')}" th:id="${list.wbcxid}" th:secret="${list.secret}" th:appid="${list.appid}"><a href="#" th:text="${list.wbcxmc}"></a></li>-->
<!--								</ul>-->
<!--								<div id="login_container" style="text-align: center;border: 1px solid #ddd;border-radius: 10px;padding: 10px 0px 30px 0px;" class="col-md-12"></div>-->
<!--							</div>-->

							<div class="col-md-11 col-lg-11 col-sm-11 col-xs-12" style="background-color:#fff;float: left;margin:auto" id="userlogin">
								<div class="intit col-md-12 " style="padding-top: 60px;font-size: 22px;">账号登录</div>
								<form id="login-form" name="login-form" method="post" action="/index" class="form clr">
									<input type="hidden" name="access_token" id ="access_token" th:value="${access_token}"/>
									<input type="hidden" name="mm_flg" id="mm_flg"/>
									<input type="hidden" name="ref" id ="ref" th:value="${ref}"/>
									<input type="hidden" name="key" th:value="${key}" />
									<input type="hidden" name="applicationurl" id="applicationurl" th:value="${applicationurl}" />
									<input type="hidden" name="domain" id="domain" th:value="${domain}"/>
									<input type="hidden" name="cookiekey" id="cookiekey" th:value="${cookiekey}"/>
									<input type="hidden" id="redirectUrl" name="redirectUrl" th:value="${redirectUrl}"/>
									<div id="InputLogin" class="input_login">
										<p class="bg-warning sl_warning" style="display:none;" id="tips"><span class="glyphicon glyphicon-minus-sign"></span></p>
										<div id="input-content" class="form clr">
											<dl>
												<dd class="input-field">
													<div class="input-field-wrap">
														<!--<span id="span1"></span>-->
														<input id="username"  class="fm-text" name="username" tabindex="1" placeholder="请输入用户名" value="" autocorrect="off" autocapitalize="off"/>
													</div>
												</dd>
											</dl>
											<dl>
												<dd class="input-field">
													<div class="input-field-wrap ">
														<input id="password" class="fm-text" type="password" name="password"  tabindex="2"
															   placeholder="请输入密码"
															   autocorrect="off" autocapitalize="off" />
													</div>
													<div id="input-login-other">
														<div class="forgetpassword">
															<a id="forgot-password-link" th:href="@{/client/toForgetPwd}" target="_blank" data-spm-protocol="i">忘记密码</a>
														</div>
													</div>
												</dd>
											</dl>
										</div>
										<div id="input-login-submit">
											<input value="登录" id="logindl" class="input-login-submit-button" type="submit" tabindex="4" name="submit-btn" />
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			var loginTypeFlag = "username"
			window.addEventListener('resize', function() {
				loginTypeChange()
			})
			function loginChange(flag){
				//若传入登陆标记，则将全局标记赋值
				//若未传入登陆标记，则去全局标记
				if (flag){
					loginTypeFlag = flag
				}
				//若标记为username，则只显示账号密码登陆
				if ( loginTypeFlag == "username"){
					//隐藏公司选择
					// $("#companyTab").hide()
					$("#loginWithPassword").hide();
					$("#loginWithDingtalk").show();
					$("#loginDiv").removeClass("col-md-5 col-lg-6 col-sm-5 col-xs-12");
					$("#userlogin").removeClass("col-md-11 col-lg-11 col-sm-11 col-xs-12");
					$("#loginDiv").addClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
					$("#userlogin").addClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
					$("#loginDiv").hide();//隐藏扫码登陆
					$("#userlogin").show();//显示账号登陆
				}
				//若标记为dingtalk，则只显示钉钉扫码登陆
				if ( loginTypeFlag == "dingtalk"){
					//显示公司选择
					// $("#companyTab").show()
					$("#loginWithDingtalk").hide();
					$("#loginWithPassword").show();
					$("#userlogin").removeClass("col-md-11 col-lg-11 col-sm-11 col-xs-12");
					$("#loginDiv").removeClass("col-md-5 col-lg-6 col-sm-5 col-xs-12");
					$("#userlogin").addClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
					$("#loginDiv").addClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
					$("#userlogin").hide();//隐藏账号登陆
					$("#loginDiv").show();//显示扫码登陆
				}
			}
			//显示账号密码登陆和钉钉扫码登陆
			function loginAll(){
				//显示公司选择
				// $("#companyTab").show()
				$("#loginWithPassword").hide();
				$("#loginWithDingtalk").hide();
				$("#loginDiv").removeClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
				$("#userlogin").removeClass("col-md-12 col-lg-12 col-sm-12 col-xs-12");
				$("#loginDiv").addClass("col-md-5 col-lg-6 col-sm-5 col-xs-12")
				$("#userlogin").addClass("col-md-11 col-lg-11 col-sm-11 col-xs-12");
				$("#loginDiv").show();//显示扫码登陆
				$("#userlogin").show();//显示账号登陆
			}

			$("#companyTab li").click(function (e) {
				$("#companyTab li").removeClass("active");
				$(this).addClass("active")
				DingLogin();
				e.preventDefault()
			})
			function DingLogin() {
				var APPID = $("#companyTab").find(".active").attr('appid');
				var REDIRECT_URI = encodeURIComponent($("#applicationurl").val()+"/ws/dingdingLogin");
				var state=APPID+','+$("#companyTab").find(".active").attr('secret')+','+$('#redirectUrl').val();
				var goto = 'https://oapi.dingtalk.com/connect/oauth2/sns_authorize?appid='+APPID+'&response_type=code&scope=snsapi_login&state='+state+'&redirect_uri='+REDIRECT_URI;
				console.log('goto',goto);
				var obj = DDLogin({
					id: "login_container",
					goto: encodeURIComponent(goto),     //这里是咱们扫码以后点击确定扫码登录的一个回调地址钉钉那边会调转到这个地址并且待上用户的唯一标识code码
					style: "border:none;background-color:#FFFFFF;",
					width: "220",
					height: "290"
				});
				var hanndleMessage = function(event) {
					var origin = event.origin;
					// console.log("origin", event.origin);
					if (origin == "https://login.dingtalk.com") {
						//判断是否来自ddLogin扫码事件。
						var loginTmpCode = event.data; //拿到loginTmpCode后就可以在这里构造跳转链接进行跳转了
						// console.log("loginTmpCode", loginTmpCode);
						if (loginTmpCode) {
							var url =goto+"&loginTmpCode=" +
									loginTmpCode;
							console.log("获取到redirect_uri_check", url);
							window.location.href = url;  //拿到用户唯一标示然后在进行当前页面的调转，注意这里跳转以后还是会在当前页面只不过Url上带了参数了这时候咱们去看上面的条件
						}
					}
				};
				if (typeof window.addEventListener != "undefined") {
					window.addEventListener("message", hanndleMessage, false);
				} else if (typeof window.attachEvent != "undefined") {
					window.attachEvent("onmessage", hanndleMessage);
				}
			}

			function loginTypeChange(){
				//设置页面高度
				var screenH = $(window).height();
				$(".loginWrap").height(screenH);

				var windowWidth = $(window).width();
				if(windowWidth<768) {
					$("#wholeDiv").css("border","0px");
					$("#wholeDiv").css("box-shadow","0px 0px 0px 0px")
				}else if(windowWidth>=992){
					$("#username").css("margin-top","15%");
				}
				var loginTabWith = $("#loginTab").width();
				if (loginTabWith<605) {
					loginChange()
				}else {
					loginAll()
				}
			}
			$(function () {
				loginAll()
				//判断是否是扫码登录后回调到的登录页面
				var ddLogin = checkDingDingLogin();
				if(ddLogin){
					return
				}
				//判断cookie里是否存在token,并校验token是否过期
				checkToken();
				loginTypeChange()
		        function Base64() {

		            // private property
		            _keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

		            // public method for encoding
		            this.encode = function (input) {
		                var output = "";
		                var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
		                var i = 0;
		                input = _utf8_encode(input);
		                while (i < input.length) {
		                    chr1 = input.charCodeAt(i++);
		                    chr2 = input.charCodeAt(i++);
		                    chr3 = input.charCodeAt(i++);
		                    enc1 = chr1 >> 2;
		                    enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
		                    enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
		                    enc4 = chr3 & 63;
		                    if (isNaN(chr2)) {
		                        enc3 = enc4 = 64;
		                    } else if (isNaN(chr3)) {
		                        enc4 = 64;
		                    }
		                    output = output +
		                    _keyStr.charAt(enc1) + _keyStr.charAt(enc2) +
		                    _keyStr.charAt(enc3) + _keyStr.charAt(enc4);
		                }
		                return output;
		            }

		            // public method for decoding
		            this.decode = function (input) {
		                var output = "";
		                var chr1, chr2, chr3;
		                var enc1, enc2, enc3, enc4;
		                var i = 0;
		                input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
		                while (i < input.length) {
		                    enc1 = _keyStr.indexOf(input.charAt(i++));
		                    enc2 = _keyStr.indexOf(input.charAt(i++));
		                    enc3 = _keyStr.indexOf(input.charAt(i++));
		                    enc4 = _keyStr.indexOf(input.charAt(i++));
		                    chr1 = (enc1 << 2) | (enc2 >> 4);
		                    chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
		                    chr3 = ((enc3 & 3) << 6) | enc4;
		                    output = output + String.fromCharCode(chr1);
		                    if (enc3 != 64) {
		                        output = output + String.fromCharCode(chr2);
		                    }
		                    if (enc4 != 64) {
		                        output = output + String.fromCharCode(chr3);
		                    }
		                }
		                output = _utf8_decode(output);
		                return output;
		            }

		            // private method for UTF-8 encoding
		            _utf8_encode = function (string) {
		                string = string.replace(/\r\n/g,"\n");
		                var utftext = "";
		                for (var n = 0; n < string.length; n++) {
		                    var c = string.charCodeAt(n);
		                    if (c < 128) {
		                        utftext += String.fromCharCode(c);
		                    } else if((c > 127) && (c < 2048)) {
		                        utftext += String.fromCharCode((c >> 6) | 192);
		                        utftext += String.fromCharCode((c & 63) | 128);
		                    } else {
		                        utftext += String.fromCharCode((c >> 12) | 224);
		                        utftext += String.fromCharCode(((c >> 6) & 63) | 128);
		                        utftext += String.fromCharCode((c & 63) | 128);
		                    }

		                }
		                return utftext;
		            }

		            // private method for UTF-8 decoding
		            _utf8_decode = function (utftext) {
		                var string = "";
		                var i = 0;
		                var c = c1 = c2 = 0;
		                while ( i < utftext.length ) {
		                    c = utftext.charCodeAt(i);
		                    if (c < 128) {
		                        string += String.fromCharCode(c);
		                        i++;
		                    } else if((c > 191) && (c < 224)) {
		                        c2 = utftext.charCodeAt(i+1);
		                        string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
		                        i += 2;
		                    } else {
		                        c2 = utftext.charCodeAt(i+1);
		                        c3 = utftext.charCodeAt(i+2);
		                        string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
		                        i += 3;
		                    }
		                }
		                return string;
		            }
		        }

		        function make_base_auth(user, password) {
		            var tok = user + ':' + password;
		            var base = new Base64();
		            var hash = base.encode(tok);
		            return "Basic " + hash;
		        }

		        $("#logindl").unbind("click").click(function(){
		    		var ts = '<span class="glyphicon glyphicon-minus-sign"></span>';
		    		if(!$("#username").val() || $("#username").val()==""){
		    			$("#tips").empty().append(ts + "用户名不能为空！");
		    			$("#tiplogin").empty();
		    			$("#tips").show();
		    			return false;
		    		}
		    		if(!$("#password").val() || $("#password").val()==""){
		    			$("#tips").empty().append(ts + "密码不能为空！");
		    			$("#tiplogin").empty();
		    			$("#tips").show();
		    			return false;
		    		}
		    		/*if($("#yzmDiv") && $("#yzmDiv:visible").length>0){
		    			if(!$("#yzm").val()|| $("#yzm").val()==""){
		    				$("#tips").empty().append(ts + "验证码不能为空！");
		    				$("#tiplogin").empty();
		    				$("#tips").show();
		    				return false;
		    			}
		    		}*/
		    		var base = new Base64();
		    	    var hash = base.encode($("#password").val());
		    		$.ajax({
		    		    type:"post",
		    		    url:"/oauth/token",
		    		    cache: false,
		    		    data: {"grant_type":"matridx","client_id":$("#username").val(),"client_secret":hash,"systemcode":"medlab-springboot"},
		    		    dataType:"json",
		    		    success:function(data){
		    		    	$("#access_token").val(data.access_token);
		    		    	//过期时间设置为12个小时 ，如果为天数，则直接设置为 expires:天数
		    		    	var expires = new Date();
		    		        expires.setTime(expires.getTime() + 60 * 1000 * 60 * 12);
		    		    	//token存到cookie中
							var cookieStr = 'TOKEN.' + $('#cookiekey').val() +'='+data.access_token+';domain='+$('#domain').val()+';path=/'+';expires:'+expires.toGMTString();
							document.cookie = cookieStr;

		    		    	$("#ref").val(data.refresh_token);
		    		    	//alert("access_token:"+data.access_token + "  token_type:" +  data.token_type + "  refresh_token:" +  data.refresh_token + "  expires_in:" +  data.expires_in + "  scope:" +  data.scope);
		    		    	if(/^[0-9]*$/.test($("#password").val())|| /^[A-Z]+$ /.test($("#password").val())||/^[a-z]+$/.test($("#password").val())){
		                        $("#mm_flg").val("1");
		    		    	}
		    		    	//document.forms[0].submit();
		    		    	submitForm();
		    		    },
		    		    error:function(event, XMLHttpRequest, ajaxOptions, thrownError){
		    		    	if(event.responseJSON.status == 452){
		    		    		$.alert("用户已经被锁定，请先联系管理员进行解锁！");
		    		    	}else if(event.responseJSON.error_description!=null){
			    		    	$.alert(event.responseJSON.error_description);
		    		    	}else{
		    		    		$.alert("用户名或者密码不正确！");
		    		    	}
		    		    }
		    		});
		    		return false;
		    	});
		    })
		    
		    //根据参数决定是直接提交菜单还是 重定向到登录验证传入的地址
			function submitForm(){

				var redirectUrl = $('#redirectUrl').val();
				if(!redirectUrl || redirectUrl ==""){
					document.forms[0].submit();
					return
				}
				redirectUrl = decodeURIComponent(redirectUrl);//token存到cookie中
				//重定向

				window.location.href=redirectUrl+"?access_token="+$("#access_token").val()+"&ref="+$("#ref").val()+"&mm_flg="+$("#mm_flg").val()+"&cookiekey="+$("#cookiekey").val();
			}
			//钉钉登录
			function checkDingDingLogin(){

				var access_token = $('#access_token').val();
				var ref = $('#ref').val();
				if(access_token&&ref){
    		    	//过期时间设置为12个小时 ，如果为天数，则直接设置为 expires:天数
    		    	var expires = new Date();
    		        expires.setTime(expires.getTime() + 60 * 1000 * 60 * 12);
    		    	//token存到cookie中

					var cookieStr = 'TOKEN.' + $('#cookiekey').val() +'='+access_token+';domain='+$('#domain').val()+';path=/'+';expires:'+expires.toGMTString();
					document.cookie = cookieStr;
					
					//document.forms[0].submit();
					submitForm()
					return true;
				}else{
					return false;
				}
			}
			//校验token是否有效
			function checkToken(){
				var token = getCookie('TOKEN.'+ $('#cookiekey').val());
				if(!token){
					return;
				}else{
					//校验token是否有效
					$.ajax({
						type:"post",
						url:"/ws/checkToken",
						data: {
							access_token:token
						},
						dataType:"json",
						success:function(data){
							if(data.status == 'true'){ //验证通过
								$("#access_token").val(token);
								$("#ref").val(token);
								//document.forms[0].submit();
								submitForm();
							}else{
								//不做处理
							}
						},
						error:function(event){

						}
					});
				}
			}
			//获取cookie
			function getCookie(name){
				var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
				if(arr=document.cookie.match(reg))
					return unescape(arr[2]);
				else
					return null;
			}
		</script>
	</body>
</html>